14:24:20 SQL> @/dbbackups/ECPR/migrations/core_owner/58.1-release-1.16.0-141-change.sql/upgrade.sql
14:24:20 SQL> WHENEVER SQLERROR EXIT ROLLBACK;
14:24:20 SQL> 
14:24:20 SQL> /*
14:24:20 SQL> variable is_current_version_fine NUMBER;
14:24:20 SQL> variable change_version NUMBER;
14:24:20 SQL> variable bad_current_version VARCHAR2(1024);
14:24:20 SQL> 
14:24:20 SQL> exec :change_version := 141;
14:24:20 SQL> exec PROCS_SYSTEM_V20.CHECK_VERSION(:change_version - 1, :is_current_version_fine);
14:24:20 SQL> exec :bad_current_version := 'Current version is bad, please update your version to '||(:change_version-1);
14:24:20 SQL> 
14:24:20 SQL> BEGIN
14:24:20 SQL> 	IF (:is_current_version_fine != 0) THEN
14:24:20 SQL> 	  RAISE_APPLICATION_ERROR(-20001, :bad_current_version);
14:24:20 SQL> 	END IF;
14:24:20 SQL> END;
14:24:20 SQL> /
14:24:20 SQL> 
14:24:20 SQL> DROP TABLE "CORE_OWNER"."AMAZON_APPSTORE_ITEM_TYPE" CASCADE CONSTRAINTS PURGE;
14:24:20 SQL> DROP SEQUENCE "CORE_OWNER"."AAS_ID_SEQ";
14:24:20 SQL> --DROP TABLE "CORE_OWNER"."AMAZON_APPSTORE" CASCADE CONSTRAINTS PURGE;
14:24:20 SQL> 
14:24:20 SQL> CREATE TABLE AMAZON_APPSTORE_RECEIPT_TYPE (
14:24:20 SQL> 	ID	    VARCHAR2(30)   NOT NULL,
14:24:20 SQL> 	DESCRIPTION VARCHAR2(1000) NOT NULL,
14:24:20 SQL> 	CREATE_DATE DATE	   NOT NULL,
14:24:20 SQL> 	CREATED_BY  VARCHAR2(255)  NOT NULL,
14:24:20 SQL> 	CONSTRAINT AAS_RECEIPT_TYPE_ID_PK PRIMARY KEY (ID)
14:24:20 SQL> 	  USING INDEX TABLESPACE CORE_IDX
14:24:20 SQL> ) TABLESPACE CORE;
14:24:20 SQL> 
14:24:20 SQL> INSERT INTO AMAZON_APPSTORE_RECEIPT_TYPE VALUES ('ENTITLED', 'Amazon App Store entitlement receipt type', SYSDATE, 'JIRA-SAR-269');
14:24:20 SQL> INSERT INTO AMAZON_APPSTORE_RECEIPT_TYPE VALUES ('CONSUMABLE', 'Amazon App Store consumable receipt type', SYSDATE, 'JIRA-SAR-269');
14:24:20 SQL> INSERT INTO AMAZON_APPSTORE_RECEIPT_TYPE VALUES ('SUBSCRIPTION', 'Amazon App Store subscription receipt type', SYSDATE, 'JIRA-SAR-269');
14:24:20 SQL> COMMIT;
14:24:20 SQL> 
14:24:20 SQL> CREATE TABLE AMAZON_APPSTORE_RECEIPT (
14:24:20 SQL> 	ID		NUMBER	       NOT NULL,
14:24:20 SQL> 	SUBSCRIPTION_ID NUMBER	       NOT NULL,
14:24:20 SQL> 	USER_ID 	VARCHAR2(4000) NOT NULL,
14:24:20 SQL> 	ITEM_TYPE	VARCHAR2(30)   NOT NULL,
14:24:20 SQL> 	START_DATE	DATE	       NOT NULL,
14:24:20 SQL> 	END_DATE	DATE,
14:24:20 SQL> 	SKU		VARCHAR2(4000) NOT NULL,
14:24:20 SQL> 	PURCHASE_TOKEN	VARCHAR2(4000) NOT NULL,
14:24:20 SQL> 	CREATE_DATE	DATE	       NOT NULL,
14:24:20 SQL> 	CREATED_BY	VARCHAR2(255)  NOT NULL,
14:24:20 SQL> 	UPDATE_DATE	DATE	       NOT NULL,
14:24:20 SQL> 	UPDATED_BY	VARCHAR2(255)  NOT NULL,
14:24:20 SQL> 	LAST_CHECK_DATE DATE,
14:24:20 SQL> 	CONSTRAINT AAS_RECEIPT_ID_PK PRIMARY KEY (ID)
14:24:20 SQL> 	  USING INDEX TABLESPACE CORE_IDX,
14:24:20 SQL> 	CONSTRAINT AAS_RECEIPT_SUB_ID_FK FOREIGN KEY (SUBSCRIPTION_ID) REFERENCES SUBSCRIPTION (ID),
14:24:20 SQL> 	CONSTRAINT AAS_RECEIPT_TYPE_FK FOREIGN KEY (ITEM_TYPE) REFERENCES AMAZON_APPSTORE_RECEIPT_TYPE (ID)
14:24:20 SQL> ) TABLESPACE CORE;
14:24:20 SQL> 
14:24:20 SQL> CREATE INDEX AAS_RECEIPT_USER_ID_IDX ON AMAZON_APPSTORE_RECEIPT (USER_ID) TABLESPACE CORE_IDX;
14:24:20 SQL> CREATE INDEX AAS_RECEIPT_SKU_IDX ON AMAZON_APPSTORE_RECEIPT (SKU) TABLESPACE CORE_IDX;
14:24:20 SQL> CREATE UNIQUE INDEX AAS_RECEIPT_PURCHASE_TOKEN_IDX ON AMAZON_APPSTORE_RECEIPT (PURCHASE_TOKEN) TABLESPACE CORE_IDX;
14:24:20 SQL> */
14:24:20 SQL> CREATE UNIQUE INDEX AAS_RECEIPT_SUB_ID_IDX ON AMAZON_APPSTORE_RECEIPT (SUBSCRIPTION_ID) TABLESPACE CORE_IDX;

Index created.

Elapsed: 00:00:00.02
14:24:20 SQL> CREATE INDEX AASR_LAST_CHECK_DATE_IDX ON AMAZON_APPSTORE_RECEIPT (LAST_CHECK_DATE) TABLESPACE CORE_IDX;

Index created.

Elapsed: 00:00:00.02
14:24:20 SQL> CREATE SEQUENCE AAS_RECEIPT_ID_SEQ;

Sequence created.

Elapsed: 00:00:00.01
14:24:20 SQL> 
14:24:20 SQL> COMMENT ON COLUMN AMAZON_APPSTORE_RECEIPT.ID IS 'Use sequence AAS_RECEIPT_ID_SEQ';

Comment created.

Elapsed: 00:00:00.01
14:24:20 SQL> COMMENT ON COLUMN AMAZON_APPSTORE_RECEIPT.END_DATE IS 'This column is allow to be null b/c that is how the amazon verification service indicates that the subscription is still active';

Comment created.

Elapsed: 00:00:00.01
14:24:21 SQL> COMMENT ON COLUMN AMAZON_APPSTORE_RECEIPT.LAST_CHECK_DATE IS 'This column is hold the last date that the receipt was check against the Amazon Receipt Verification Service';

Comment created.

Elapsed: 00:00:00.00
14:24:21 SQL> 
14:24:21 SQL> CREATE UNIQUE INDEX IDX_DUP_ACT_EMAIL_DOMAIN ON GROUP_ACCOUNT_EMAIL_DOMAIN ( CASE WHEN is_active = 1 THEN EMAIL_DOMAIN ELSE NULL END ) TABLESPACE CORE_IDX;

Index created.

Elapsed: 00:00:00.30
14:24:21 SQL> 
14:24:21 SQL> EXEC PROCS_SYSTEM_V20.INCREMENT_VERSION();

PL/SQL procedure successfully completed.

Elapsed: 00:00:00.00
14:24:21 SQL> 
14:24:21 SQL> commit;

Commit complete.

Elapsed: 00:00:00.00
14:24:21 SQL> spool off;


Subject: Nomad upgrade completed successfully: ECPR@rac01.prd.ewr1.nytimes.com
From: Nomad for Oracle <nytd_oracledba@nytimes.com>
To: nytd_ecommerce@nytimes.com
Cc: nytd_oracledba@nytimes.com

Nomad upgrade operation completed successfully without errors. 
        
        Details
        -------
        DB Hostname: rac01.prd.ewr1.nytimes.com
        DB Role: PRIMARY
        SID: ECPR
        Schema: core_owner
        Migration: 58.1-release-1.16.0-141-change.sql
        SVN Revision: 13075
        Duration: 0 sec.
        DBA: sbao
        Service Request: https://jira.em.nytimes.com/browse/ORA-899