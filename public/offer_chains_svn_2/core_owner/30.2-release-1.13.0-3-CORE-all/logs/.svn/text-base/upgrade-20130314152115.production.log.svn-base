15:21:27 SQL> @/dbbackups/ECPR/migrations/core_owner/30.2-release-1.13.0-3-CORE-all/upgrade.sql
15:21:27 SQL> 
15:21:27 SQL> .
15:21:27 SQL> /
SP2-0103: Nothing in SQL buffer to run.
15:21:27 SQL> 
15:21:27 SQL> --------------------------------------------------------------------------------
15:21:27 SQL> -- DDL for package PROCS_ACCOUNT
15:21:27 SQL> --------------------------------------------------------------------------------
15:21:27 SQL> 
15:21:27 SQL> CREATE OR REPLACE PACKAGE "PROCS_ACCOUNT_V18" AS
15:21:27   2  
15:21:27   3  FUNCTION GET_GRACE_START_DATE(
15:21:27   4  	in_subscription_id IN NUMBER
15:21:27   5  ) RETURN DATE;
15:21:27   6  
15:21:27   7  FUNCTION GET_GRACE_END_DATE(
15:21:27   8  	in_subscription_id IN NUMBER
15:21:27   9  ) RETURN DATE;
15:21:27  10  
15:21:27  11  PROCEDURE INVOICE_IDS_BY_GROUP_ID (
15:21:27  12  	in_group_id    IN  NUMBER,
15:21:27  13  	out_result_set OUT SYS_REFCURSOR
15:21:27  14  );
15:21:27  15  
15:21:27  16  PROCEDURE ANNOTATE_ACCOUNT (
15:21:27  17  /*
15:21:27  18  Throws exceptions:
15:21:27  19  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:27  20  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27  21  */
15:21:27  22  	in_group_id   IN  NUMBER,
15:21:27  23  	in_agent_id   IN  NUMBER,
15:21:27  24  	in_note       IN  VARCHAR2,
15:21:27  25  	in_created_by IN  VARCHAR2
15:21:27  26  );
15:21:27  27  
15:21:27  28  PROCEDURE ASSERT_ACCOUNT_EXISTS (
15:21:27  29  /*
15:21:27  30  Throws exceptions:
15:21:27  31  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:27  32  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27  33  */
15:21:27  34  	in_group_id IN	NUMBER,
15:21:27  35  	out_exists  OUT NUMBER
15:21:27  36  );
15:21:27  37  
15:21:27  38  PROCEDURE DISABLE_ACCOUNT (
15:21:27  39  /*
15:21:27  40  Throws exceptions:
15:21:27  41  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:27  42  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:27  43  */
15:21:27  44  	in_group_id   IN NUMBER,
15:21:27  45  	in_updated_by IN VARCHAR2,
15:21:27  46  	in_note       IN VARCHAR2,
15:21:27  47  	in_agent_id   IN NUMBER
15:21:27  48  );
15:21:27  49  
15:21:27  50  PROCEDURE CREATE_ACTIVE_ACCOUNT(
15:21:27  51  /*
15:21:27  52  Throws exceptions:
15:21:27  53  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:27  54  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27  55  */
15:21:27  56  	in_created_by	       IN VARCHAR2,
15:21:27  57  	in_group_id	       IN NUMBER
15:21:27  58  );
15:21:27  59  
15:21:27  60  PROCEDURE REACTIVATE_ACCOUNT (
15:21:27  61  /*
15:21:27  62  Throws exceptions:
15:21:27  63  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:27  64  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:27  65  */
15:21:27  66  	in_group_id	  IN NUMBER,
15:21:27  67  	in_updated_by	  IN VARCHAR2,
15:21:27  68  	in_note 	  IN VARCHAR2,
15:21:27  69  	in_agent_id	  IN NUMBER
15:21:27  70  );
15:21:27  71  
15:21:27  72  /*
15:21:27  73  
15:21:27  74  THERE ARE NO ACCOUNT STATUS "SUSPENDED"
15:21:27  75  Waiting for new instructions.
15:21:27  76  
15:21:27  77  PROCEDURE SUSPEND_ACCOUNT (
15:21:27  78  /*
15:21:27  79  Throws exceptions:
15:21:27  80  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:27  81  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:27  82  
15:21:27  83  	  in_group_id	 IN  NUMBER,
15:21:27  84  	  in_updated_by  IN  VARCHAR2
15:21:27  85  )
15:21:27  86  */
15:21:27  87  
15:21:27  88  PROCEDURE GET_ACCOUNT_CREDIT_CARDS (
15:21:27  89  	in_group_id    IN ACCOUNT.GROUP_ID%TYPE,
15:21:27  90  	in_status_id   IN CREDIT_CARD.CREDIT_CARD_STATUS_ID%TYPE DEFAULT GLOBAL_STATUSES_V18.CREDIT_CARD_ACTIVE,
15:21:27  91  	out_result_set OUT SYS_REFCURSOR
15:21:27  92  );
15:21:27  93  
15:21:27  94  PROCEDURE GET_ACCOUNT_GIFT_CERTIFICATES (
15:21:27  95  /*
15:21:27  96  IN:
15:21:27  97  instr_status:
15:21:27  98  GLOBAL_CONSTANTS_V18.TRUE - get active instruments only (default)
15:21:27  99  GLOBAL_CONSTANTS_V18.FALSE - get inactive instruments only
15:21:27 100  
15:21:27 101  Throws exceptions:
15:21:27 102  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:27 103  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27 104  */
15:21:27 105  	in_group_id	  IN NUMBER,
15:21:27 106  	out_result_gc_set OUT SYS_REFCURSOR,
15:21:27 107  	in_instr_status   IN NUMBER DEFAULT GLOBAL_CONSTANTS_V18.TRUE
15:21:27 108  );
15:21:27 109  
15:21:27 110  PROCEDURE GET_ACCOUNT_INFO  (
15:21:27 111  /*
15:21:27 112  Throws exceptions:
15:21:27 113  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:27 114  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27 115  */
15:21:27 116  	  in_group_id	    IN	NUMBER,
15:21:27 117  	  out_account_info  OUT SYS_REFCURSOR
15:21:27 118  );
15:21:27 119  
15:21:27 120  PROCEDURE GET_ACCOUNT_NOTES (
15:21:27 121  /*
15:21:27 122  Throws exceptions:
15:21:27 123  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27 124  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:27 125  */
15:21:27 126  	  in_group_id	 IN  NUMBER,
15:21:27 127  	  out_result_set OUT SYS_REFCURSOR
15:21:27 128  );
15:21:27 129  
15:21:27 130  PROCEDURE GET_ACCOUNT_PAYPALS(
15:21:27 131  	in_group_id    IN  ACCOUNT.GROUP_ID%TYPE,
15:21:27 132  	in_status_id   IN  PAYPAL.PAYPAL_STATUS_ID%TYPE DEFAULT GLOBAL_STATUSES_V18.PAYPAL_ACTIVE,
15:21:27 133  	out_result_set OUT SYS_REFCURSOR
15:21:27 134  );
15:21:27 135  
15:21:27 136  PROCEDURE GET_ACCOUNT_SUBSCRIPTIONS (
15:21:27 137  /*
15:21:27 138  Throws exceptions:
15:21:27 139  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:27 140  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:27 141  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27 142  */
15:21:27 143  	  in_group_id	 IN  NUMBER,
15:21:27 144  	  in_start_date  IN DATE,
15:21:27 145  	  in_end_date	 IN DATE,
15:21:27 146  	  in_status	 IN NUMBER,
15:21:27 147  	  in_group_account_type IN VARCHAR2,
15:21:27 148  	  out_result_set  OUT SYS_REFCURSOR
15:21:27 149  );
15:21:27 150  
15:21:27 151  PROCEDURE FREEZE_ACCOUNT (
15:21:27 152  /*
15:21:27 153  Throws exceptions:
15:21:27 154  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:27 155  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27 156  */
15:21:27 157  	in_group_id   IN NUMBER,
15:21:27 158  	in_updated_by IN VARCHAR2,
15:21:27 159  	in_note       IN VARCHAR2,
15:21:27 160  	in_agent_id   IN NUMBER
15:21:27 161  );
15:21:27 162  
15:21:27 163  PROCEDURE GET_ACCOUNT_SUBSCR_INVOICES (
15:21:27 164  /*
15:21:27 165  Throws exceptions:
15:21:27 166  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:27 167  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27 168  */
15:21:27 169  	in_group_id	   IN  NUMBER,
15:21:27 170  	in_subscription_id IN NUMBER,
15:21:27 171  	out_result_set	   OUT SYS_REFCURSOR
15:21:27 172  );
15:21:27 173  
15:21:27 174  PROCEDURE GET_ACCOUNT_GC_INVOICES (
15:21:27 175  /*
15:21:27 176  Throws exceptions:
15:21:27 177  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:27 178  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27 179  */
15:21:27 180  	in_group_id    IN  NUMBER,
15:21:27 181  	out_result_set OUT SYS_REFCURSOR
15:21:27 182  );
15:21:27 183  
15:21:27 184  PROCEDURE GET_GC_INVOICE (
15:21:27 185  /*
15:21:27 186  Throws exceptions:
15:21:27 187  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:27 188  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27 189  */
15:21:27 190  	in_group_id    IN  NUMBER,
15:21:27 191  	in_gc_code     IN  VARCHAR2,
15:21:27 192  	out_result_set OUT SYS_REFCURSOR
15:21:27 193  );
15:21:27 194  
15:21:27 195  PROCEDURE GET_ACCOUNT_PRODUCTS (
15:21:27 196  /*
15:21:27 197  Throws exceptions:
15:21:27 198  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:27 199  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27 200  */
15:21:27 201  	in_group_id    IN  NUMBER,
15:21:27 202  	out_result_set OUT SYS_REFCURSOR
15:21:27 203  );
15:21:27 204  
15:21:27 205  PROCEDURE GET_ACCOUNT_PROD_OFFERRINGS (
15:21:27 206  /*
15:21:27 207  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:27 208  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27 209  */
15:21:27 210  	in_group_id IN NUMBER,
15:21:27 211  	out_result_set	   OUT SYS_REFCURSOR
15:21:27 212  );
15:21:27 213  
15:21:27 214  PROCEDURE UPDATE_ACCOUNT_STATUS (
15:21:27 215  /*
15:21:27 216  Throws exceptions:
15:21:27 217  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:27 218  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27 219  */
15:21:27 220  	in_account_id	     IN ACCOUNT.ID%TYPE,
15:21:27 221  	in_account_status_id IN ACCOUNT.ACCOUNT_STATUS_ID%TYPE,
15:21:27 222  	in_updated_by	     IN ACCOUNT.UPDATED_BY%TYPE
15:21:27 223  );
15:21:27 224  
15:21:27 225  PROCEDURE GET_NEEDS_ENTTL_LICENSES_NUM (
15:21:27 226  /*
15:21:27 227  Throws exceptions:
15:21:27 228  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:27 229  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27 230  */
15:21:27 231  	in_group_id	 IN ACCOUNT.GROUP_ID%TYPE,
15:21:27 232  	out_licenses_num OUT NUMBER
15:21:27 233  );
15:21:27 234  
15:21:27 235  PROCEDURE SET_TAX_EXEMPT (
15:21:27 236  /*
15:21:27 237  Throws exceptions:
15:21:27 238  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:27 239  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27 240  */
15:21:27 241  	in_group_id  IN NUMBER,
15:21:27 242  	in_exempt_id IN VARCHAR2
15:21:27 243  );
15:21:27 244  
15:21:27 245  PROCEDURE IS_TAX_EXEMPT (
15:21:27 246  /*
15:21:27 247  Throws exceptions:
15:21:27 248  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:27 249  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27 250  Return:
15:21:27 251  	GLOBAL_CONSTANTS_V18.TRUE if ACCOUNT.EXEMPT_ID is not null
15:21:27 252  	GLOBAL_CONSTANTS_V18.FALSE else
15:21:27 253  */
15:21:27 254  	in_group_id	  IN NUMBER,
15:21:27 255  	out_is_tax_exempt OUT NUMBER
15:21:27 256  );
15:21:27 257  
15:21:27 258  PROCEDURE GET_GROUP_ID_BY_ACCOUNT_ID (
15:21:27 259  /*
15:21:27 260  Throws exceptions:
15:21:27 261  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:27 262  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27 263  */
15:21:27 264  	in_account_id IN NUMBER,
15:21:27 265  	out_group_id  OUT NUMBER
15:21:27 266  );
15:21:27 267  
15:21:27 268  PROCEDURE GET_ACCOUNT_ID_BY_GROUP_ID (
15:21:27 269  /*
15:21:27 270  Throws exceptions:
15:21:27 271  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:27 272  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27 273  */
15:21:27 274  	in_group_id IN NUMBER,
15:21:27 275  	out_account_id	OUT NUMBER
15:21:27 276  );
15:21:27 277  
15:21:27 278  PROCEDURE GET_GROUPS_ID_BY_INVOICE_ID (
15:21:27 279  /*
15:21:27 280  Throws exceptions:
15:21:27 281  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:27 282  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27 283  */
15:21:27 284  	in_invoice_id IN NUMBER,
15:21:27 285  	out_group_ids OUT SYS_REFCURSOR
15:21:27 286  );
15:21:27 287  
15:21:27 288  PROCEDURE GET_ACCOUNT_TAX_EXEMPT_ID (
15:21:27 289  /*
15:21:27 290  Throws exceptions:
15:21:27 291  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:27 292  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27 293  */
15:21:27 294  	in_group_id	  IN NUMBER,
15:21:27 295  	out_tax_exempt_id OUT VARCHAR2
15:21:27 296  );
15:21:27 297  
15:21:27 298  PROCEDURE GET_UPGRADABLE_SUBSCRIPTIONS (
15:21:27 299  /*
15:21:27 300  Throws exceptions:
15:21:27 301  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:27 302  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27 303  
15:21:27 304  Result has two columns:
15:21:27 305  subscription_id and offer_chain_id
15:21:27 306  */
15:21:27 307  	in_group_id    IN NUMBER,
15:21:27 308  	out_result_set OUT SYS_REFCURSOR
15:21:27 309  );
15:21:27 310  
15:21:27 311  PROCEDURE GET_USR_ALL_SBSCR_IDS (
15:21:27 312  /*
15:21:27 313  Throws exceptions:
15:21:27 314  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:27 315  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27 316  
15:21:27 317  Result has two columns:
15:21:27 318  subscription_id and offer_chain_id
15:21:27 319  */
15:21:27 320  	in_group_id	   IN NUMBER,
15:21:27 321  	out_result_set	   OUT SYS_REFCURSOR
15:21:27 322  );
15:21:27 323  
15:21:27 324  PROCEDURE GET_USR_SBSCR_IDS_BY_OFFCH_IDS (
15:21:27 325  /*
15:21:27 326  Throws exceptions:
15:21:27 327  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:27 328  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:27 329  APP_EXCEPTION_CODES_V18.INVALID_PARAMETER
15:21:27 330  
15:21:27 331  Result has two columns:
15:21:27 332  subscription_id and offer_chain_id
15:21:27 333  */
15:21:27 334  	in_group_id	   IN NUMBER,
15:21:27 335  	in_offer_chain_ids IN core_owner.NUMBER_TABLE,
15:21:27 336  	out_result_set	   OUT SYS_REFCURSOR
15:21:27 337  );
15:21:27 338  
15:21:27 339  PROCEDURE GET_GROUP_IDS_BY_CC_INFO (
15:21:27 340  	in_last_four_cc IN CREDIT_CARD.LAST_FOUR_CC%TYPE,
15:21:27 341  	in_expiration_date IN DATE,
15:21:27 342  	in_country IN CREDIT_CARD.COUNTRY%TYPE DEFAULT NULL,
15:21:27 343  	in_postal_code IN CREDIT_CARD.POSTAL_CODE%TYPE DEFAULT NULL,
15:21:27 344  	in_city IN CREDIT_CARD.CITY%TYPE DEFAULT NULL,
15:21:27 345  	in_state IN CREDIT_CARD.STATE%TYPE DEFAULT NULL,
15:21:27 346  	in_credit_card_type_id IN CREDIT_CARD.CREDIT_CARD_TYPE_ID%TYPE DEFAULT NULL,
15:21:27 347  	in_credit_card_status_id IN CREDIT_CARD.CREDIT_CARD_STATUS_ID%TYPE DEFAULT NULL,
15:21:27 348  	in_lower_bound IN NUMBER DEFAULT 1,
15:21:27 349  	in_upper_bound IN NUMBER DEFAULT 11,
15:21:27 350  	out_result_set OUT SYS_REFCURSOR
15:21:27 351  );
15:21:27 352  
15:21:27 353  END PROCS_ACCOUNT_V18;
15:21:27 354  .
15:21:27 SQL> /

Package created.

Elapsed: 00:00:00.11
15:21:27 SQL> 
15:21:27 SQL> --------------------------------------------------------------------------------
15:21:27 SQL> -- DDL for package PROCS_ACCOUNT_CRU
15:21:27 SQL> --------------------------------------------------------------------------------
15:21:27 SQL> 
15:21:27 SQL> CREATE OR REPLACE PACKAGE "PROCS_ACCOUNT_CRU_V18" AS
15:21:27   2  
15:21:27   3  PROCEDURE CREATE_ACCOUNT (
15:21:27   4  	out_account_id	      OUT ACCOUNT.ID%TYPE,
15:21:27   5  	in_account_status_id  IN ACCOUNT.ACCOUNT_STATUS_ID%TYPE,
15:21:27   6  	in_suspend_date       IN ACCOUNT.SUSPEND_DATE%TYPE DEFAULT NULL,
15:21:27   7  	in_group_id	      IN ACCOUNT.GROUP_ID%TYPE,
15:21:27   8  	in_created_by	      IN ACCOUNT.CREATED_BY%TYPE,
15:21:27   9  	in_system_category_id IN ACCOUNT.SYSTEM_CATEGORY_ID%TYPE,
15:21:27  10  	in_instrument_type_id IN ACCOUNT.INSTRUMENT_TYPE_ID%TYPE DEFAULT NULL,
15:21:27  11  	in_instrument_id      IN ACCOUNT.INSTRUMENT_ID%TYPE DEFAULT NULL
15:21:27  12  );
15:21:27  13  
15:21:27  14  PROCEDURE UPDATE_ACCOUNT (
15:21:27  15  	in_account_id	      IN ACCOUNT.ID%TYPE,
15:21:27  16  	in_account_status_id  IN ACCOUNT.ACCOUNT_STATUS_ID%TYPE DEFAULT NULL,
15:21:27  17  	in_suspend_date       IN ACCOUNT.SUSPEND_DATE%TYPE DEFAULT NULL,
15:21:27  18  	in_updated_by	      IN ACCOUNT.UPDATED_BY%TYPE,
15:21:27  19  	in_system_category_id IN ACCOUNT.SYSTEM_CATEGORY_ID%TYPE DEFAULT NULL,
15:21:27  20  	in_instrument_type_id IN ACCOUNT.INSTRUMENT_TYPE_ID%TYPE DEFAULT NULL,
15:21:27  21  	in_instrument_id      IN ACCOUNT.INSTRUMENT_ID%TYPE DEFAULT NULL
15:21:27  22  );
15:21:27  23  
15:21:27  24  PROCEDURE UPDATE_DEF_FIN_INSTRUMENT(
15:21:27  25  	in_account_id	      IN ACCOUNT.ID%TYPE,
15:21:27  26  	in_instrument_type_id IN ACCOUNT.INSTRUMENT_TYPE_ID%TYPE,
15:21:27  27  	in_instrument_id      IN ACCOUNT.INSTRUMENT_ID%TYPE,
15:21:27  28  	in_updated_by	      IN ACCOUNT.UPDATED_BY%TYPE
15:21:27  29  );
15:21:27  30  
15:21:27  31  PROCEDURE READ_ACCOUNT (
15:21:27  32  	in_account_id  IN ACCOUNT.ID%TYPE,
15:21:27  33  	out_result_set OUT SYS_REFCURSOR
15:21:27  34  );
15:21:27  35  
15:21:27  36  PROCEDURE CREATE_ACCOUNT_NOTE (
15:21:27  37  	inout_account_note_id IN OUT ACCOUNT_NOTE.ID%TYPE,
15:21:27  38  	in_agent_id	      IN ACCOUNT_NOTE.AGENT_ID%TYPE,
15:21:27  39  	in_account_id	      IN ACCOUNT_NOTE.ACCOUNT_ID%TYPE,
15:21:27  40  	in_note 	      IN ACCOUNT_NOTE.NOTE%TYPE,
15:21:27  41  	in_created_by	      IN ACCOUNT_NOTE.CREATED_BY%TYPE
15:21:27  42  );
15:21:27  43  
15:21:27  44  END PROCS_ACCOUNT_CRU_V18;
15:21:27  45  .
15:21:27 SQL> /

Package created.

Elapsed: 00:00:00.02
15:21:27 SQL> 
15:21:27 SQL> CREATE OR REPLACE PACKAGE "PROCS_ADDRESS_V18" AS
15:21:27   2  
15:21:27   3  PROCEDURE CREATE_ADDRESS(
15:21:27   4  /*
15:21:27   5  Throws exceptions:
15:21:27   6  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27   7  */
15:21:27   8  	  out_address_id	OUT NUMBER,
15:21:27   9  	  in_address1		IN ADDRESS.ADDRESS1%TYPE DEFAULT NULL,
15:21:27  10  	  in_address2		IN ADDRESS.ADDRESS2%TYPE DEFAULT NULL,
15:21:27  11  	  in_city		IN ADDRESS.CITY%TYPE DEFAULT NULL,
15:21:27  12  	  in_state		IN ADDRESS.STATE%TYPE DEFAULT NULL,
15:21:27  13  	  in_postal_code	IN ADDRESS.POSTAL_CODE%TYPE DEFAULT NULL,
15:21:27  14  	  in_country		IN ADDRESS.COUNTRY%TYPE DEFAULT NULL,
15:21:27  15  	  in_created_by 	IN ADDRESS.CREATED_BY%TYPE
15:21:27  16  );
15:21:27  17  
15:21:27  18  PROCEDURE UPDATE_ADDRESS(
15:21:27  19  /*
15:21:27  20  Throws exceptions:
15:21:27  21  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27  22  */
15:21:27  23  	  in_address_id 	IN ADDRESS.ID%TYPE,
15:21:27  24  	  in_address1		IN ADDRESS.ADDRESS1%TYPE DEFAULT NULL,
15:21:27  25  	  in_address2		IN ADDRESS.ADDRESS2%TYPE DEFAULT NULL,
15:21:27  26  	  in_city		IN ADDRESS.CITY%TYPE DEFAULT NULL,
15:21:27  27  	  in_state		IN ADDRESS.STATE%TYPE DEFAULT NULL,
15:21:27  28  	  in_postal_code	IN ADDRESS.POSTAL_CODE%TYPE DEFAULT NULL,
15:21:27  29  	  in_country		IN ADDRESS.COUNTRY%TYPE DEFAULT NULL,
15:21:27  30  	  in_updated_by 	IN ADDRESS.UPDATED_BY%TYPE
15:21:27  31  );
15:21:27  32  
15:21:27  33  PROCEDURE GET_ADDRESS (
15:21:27  34  /*
15:21:27  35  Throws exceptions:
15:21:27  36  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27  37  */
15:21:27  38  	  in_id 		IN ADDRESS.ID%TYPE,
15:21:27  39  	  out_result_set	OUT SYS_REFCURSOR
15:21:27  40  );
15:21:27  41  
15:21:27  42  END PROCS_ADDRESS_V18;
15:21:27  43  .
15:21:27 SQL> /

Package created.

Elapsed: 00:00:00.02
15:21:27 SQL> 
15:21:27 SQL> --------------------------------------------------------------------------------
15:21:27 SQL> -- DDL for package PROCS_ADDRESS_CRU
15:21:27 SQL> --------------------------------------------------------------------------------
15:21:27 SQL> 
15:21:27 SQL> CREATE OR REPLACE PACKAGE "PROCS_ADDRESS_CRU_V18" AS
15:21:27   2  
15:21:27   3  PROCEDURE CREATE_ADDRESS(
15:21:27   4  	out_address_id	      OUT ADDRESS.ID%TYPE,
15:21:27   5  	in_address_id	      IN ADDRESS.ID%TYPE DEFAULT NULL,
15:21:27   6  	in_address1	      IN ADDRESS.ADDRESS1%TYPE DEFAULT NULL,
15:21:27   7  	in_address2	      IN ADDRESS.ADDRESS2%TYPE DEFAULT NULL,
15:21:27   8  	in_city 	      IN ADDRESS.CITY%TYPE DEFAULT NULL,
15:21:27   9  	in_state	      IN ADDRESS.STATE%TYPE DEFAULT NULL,
15:21:27  10  	in_postal_code	      IN ADDRESS.POSTAL_CODE%TYPE DEFAULT NULL,
15:21:27  11  	in_country	      IN ADDRESS.COUNTRY%TYPE DEFAULT NULL,
15:21:27  12  	in_created_by	      IN ADDRESS.CREATED_BY%TYPE
15:21:27  13  );
15:21:27  14  
15:21:27  15  PROCEDURE UPDATE_ADDRESS(
15:21:27  16  	in_address_id	      IN ADDRESS.ID%TYPE,
15:21:27  17  	in_address1	      IN ADDRESS.ADDRESS1%TYPE DEFAULT NULL,
15:21:27  18  	in_address2	      IN ADDRESS.ADDRESS2%TYPE DEFAULT NULL,
15:21:27  19  	in_city 	      IN ADDRESS.CITY%TYPE DEFAULT NULL,
15:21:27  20  	in_state	      IN ADDRESS.STATE%TYPE DEFAULT NULL,
15:21:27  21  	in_postal_code	      IN ADDRESS.POSTAL_CODE%TYPE DEFAULT NULL,
15:21:27  22  	in_country	      IN ADDRESS.COUNTRY%TYPE DEFAULT NULL,
15:21:27  23  	in_updated_by	      IN ADDRESS.UPDATED_BY%TYPE
15:21:27  24  );
15:21:27  25  
15:21:27  26  END PROCS_ADDRESS_CRU_V18;
15:21:27  27  .
15:21:27 SQL> /

Package created.

Elapsed: 00:00:00.02
15:21:27 SQL> 
15:21:27 SQL> --------------------------------------------------------------------------------
15:21:27 SQL> -- DDL for package PROCS_ADJUSTMENTS
15:21:27 SQL> --------------------------------------------------------------------------------
15:21:27 SQL> 
15:21:27 SQL> CREATE OR REPLACE PACKAGE "PROCS_ADJUSTMENTS_V18" AS
15:21:27   2  
15:21:27   3  PROCEDURE CREATE_INVOICE_ADJUSTMENT (
15:21:27   4  	in_invoice_id		  IN NUMBER,
15:21:27   5  	in_adjustment_reason	  IN VARCHAR2,
15:21:27   6  	in_is_credit		  IN NUMBER,
15:21:27   7  	in_charge_id		  IN NUMBER,
15:21:27   8  	in_business_date	  IN DATE,
15:21:27   9  	in_created_by		  IN VARCHAR2,
15:21:27  10  	out_invoice_adjustment_id OUT NUMBER
15:21:27  11  );
15:21:27  12  
15:21:27  13  PROCEDURE UPDATE_INVOICE_ADJUSTMENT (
15:21:27  14  	in_invoice_id		  IN NUMBER,
15:21:27  15  	in_original_charge_id	  IN NUMBER,
15:21:27  16  	in_charge_id		  IN NUMBER,
15:21:27  17  	in_updated_by		  IN VARCHAR2
15:21:27  18  );
15:21:27  19  
15:21:27  20  PROCEDURE CREATE_LINE_ITEM_ADJUSTMENT (
15:21:27  21  	in_line_item_id 	    IN NUMBER,
15:21:27  22  	in_invoice_adjustment_id    IN NUMBER,
15:21:27  23  	in_amount		    IN NUMBER,
15:21:27  24  	in_tax			    IN NUMBER,
15:21:27  25  	in_discount		    IN NUMBER,
15:21:27  26  	in_created_by		    IN VARCHAR2,
15:21:27  27  	out_line_item_adjustment_id OUT NUMBER
15:21:27  28  );
15:21:27  29  
15:21:27  30  PROCEDURE CREATE_TAX_ADJUSTMENT (
15:21:27  31  	in_tax_id		   IN NUMBER,
15:21:27  32  	in_line_item_adjustment_id IN NUMBER,
15:21:27  33  	in_amount		   IN NUMBER,
15:21:27  34  	in_created_by		   IN VARCHAR2,
15:21:27  35  	out_tax_adjustment_id	   OUT NUMBER
15:21:27  36  );
15:21:27  37  
15:21:27  38  PROCEDURE CREATE_DISCOUNT_LI_ADJUSTMENT (
15:21:27  39  	in_discount_id		   NUMBER,
15:21:27  40  	in_line_item_id 	   NUMBER,
15:21:27  41  	in_line_item_adjustment_id IN NUMBER,
15:21:27  42  	in_amount		   IN NUMBER,
15:21:27  43  	in_created_by		   IN VARCHAR2,
15:21:27  44  	out_discount_li_id	   OUT NUMBER
15:21:27  45  );
15:21:27  46  
15:21:27  47  END PROCS_ADJUSTMENTS_V18;
15:21:27  48  .
15:21:27 SQL> /

Package created.

Elapsed: 00:00:00.02
15:21:27 SQL> 
15:21:27 SQL> CREATE OR REPLACE PACKAGE "PROCS_ADX_V18" AS
15:21:27   2  
15:21:27   3  PROCEDURE GET_SUB_ADX_INFO (
15:21:27   4  /*
15:21:27   5  Throws exceptions:
15:21:27   6  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27   7  */
15:21:27   8  	out_result_set	    OUT SYS_REFCURSOR,
15:21:27   9  	in_group_id    IN ACCOUNT.GROUP_ID%TYPE
15:21:27  10  );
15:21:27  11  
15:21:27  12  END PROCS_ADX_V18;
15:21:27  13  .
15:21:27 SQL> /

Package created.

Elapsed: 00:00:00.02
15:21:27 SQL> 
15:21:27 SQL> CREATE OR REPLACE PACKAGE "PROCS_AMAZON_V18" AS
15:21:27   2  
15:21:27   3  PROCEDURE CREATE_AMAZON_SUB(
15:21:27   4  /*
15:21:27   5  Throws exceptions:
15:21:27   6  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27   7  */
15:21:27   8  	  out_id	      OUT NUMBER,
15:21:27   9  	  in_subscription_id  IN AMAZON_SUB.SUBSCRIPTION_ID%TYPE,
15:21:27  10  	  in_amazon_id	      IN AMAZON_SUB.AMAZON_ID%TYPE,
15:21:27  11  	  in_created_by       IN AMAZON_SUB.CREATED_BY%TYPE
15:21:27  12  );
15:21:27  13  
15:21:27  14  PROCEDURE GET_ACTIVE_SUB_IDS (
15:21:27  15  /*
15:21:27  16  Throws exceptions:
15:21:27  17  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27  18  */
15:21:27  19  	out_result_set	    OUT SYS_REFCURSOR,
15:21:27  20  	in_amazon_id	IN AMAZON_SUB.AMAZON_ID%TYPE
15:21:27  21  );
15:21:27  22  
15:21:27  23  PROCEDURE GET_ACTIVE_GROUP_IDS (
15:21:27  24  /*
15:21:27  25  Throws exceptions:
15:21:27  26  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27  27  */
15:21:27  28  	out_result_set	    OUT SYS_REFCURSOR,
15:21:27  29  	in_amazon_id	IN AMAZON_SUB.AMAZON_ID%TYPE
15:21:27  30  );
15:21:27  31  
15:21:27  32  END PROCS_AMAZON_V18;
15:21:27  33  .
15:21:27 SQL> /

Package created.

Elapsed: 00:00:00.02
15:21:27 SQL> 
15:21:27 SQL> CREATE OR REPLACE PACKAGE "PROCS_AMAZON_CRU_V18" AS
15:21:27   2  
15:21:27   3  PROCEDURE CREATE_AMAZON_SUB(
15:21:27   4  /*
15:21:27   5  Throws exceptions:
15:21:27   6  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:27   7  */
15:21:27   8  	  out_id	      OUT NUMBER,
15:21:27   9  	  in_subscription_id  IN AMAZON_SUB.SUBSCRIPTION_ID%TYPE,
15:21:27  10  	  in_amazon_id	      IN AMAZON_SUB.AMAZON_ID%TYPE,
15:21:27  11  	  in_created_by       IN AMAZON_SUB.CREATED_BY%TYPE
15:21:27  12  );
15:21:27  13  
15:21:27  14  END PROCS_AMAZON_CRU_V18;
15:21:27  15  .
15:21:27 SQL> /

Package created.

Elapsed: 00:00:00.02
15:21:28 SQL> 
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> -- DDL for package PROCS_CHARGE
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE "PROCS_CHARGE_V18" AS
15:21:28   2  
15:21:28   3  PROCEDURE CREATE_CHARGE(
15:21:28   4  /*
15:21:28   5  Throws exceptions:
15:21:28   6  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28   7  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28   8  */
15:21:28   9  	in_invoice_id	      IN NUMBER,
15:21:28  10  	in_transaction_id     IN NUMBER,
15:21:28  11  	in_instrument_type_id IN NUMBER,
15:21:28  12  	in_instrument_id      IN NUMBER,
15:21:28  13  	in_charge_amount      IN NUMBER,
15:21:28  14  	in_created_by	      IN VARCHAR2,
15:21:28  15  	in_charge_status_id   IN NUMBER,
15:21:28  16  	out_charge_id	      OUT NUMBER
15:21:28  17  );
15:21:28  18  
15:21:28  19  PROCEDURE GET_PENDING_REFUND_CHARGES (
15:21:28  20  /*
15:21:28  21  Throws exceptions:
15:21:28  22  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  23  */
15:21:28  24  	out_result_set	    OUT SYS_REFCURSOR,
15:21:28  25  	in_row_number	    IN NUMBER DEFAULT NULL
15:21:28  26  );
15:21:28  27  
15:21:28  28  PROCEDURE GET_UNPROCESSED_CHARGES (
15:21:28  29  /*
15:21:28  30  Throws exceptions:
15:21:28  31  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  32  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  33  */
15:21:28  34  	in_invoice_id  IN NUMBER,
15:21:28  35  	out_result_set OUT SYS_REFCURSOR
15:21:28  36  );
15:21:28  37  
15:21:28  38  PROCEDURE GET_PROCESSED_CHARGES (
15:21:28  39  /*
15:21:28  40  Throws exceptions:
15:21:28  41  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  42  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  43  */
15:21:28  44  	in_invoice_id  IN NUMBER,
15:21:28  45  	out_result_set OUT SYS_REFCURSOR
15:21:28  46  );
15:21:28  47  
15:21:28  48  PROCEDURE GET_SUBSCR_ID_BY_CHARGE_ID (
15:21:28  49  /*
15:21:28  50  Throws exceptions:
15:21:28  51  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  52  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  53  */
15:21:28  54  	in_charge_id	    IN NUMBER,
15:21:28  55  	out_subscription_id OUT NUMBER
15:21:28  56  );
15:21:28  57  
15:21:28  58  PROCEDURE UPDATE_CHARGE_STATUS (
15:21:28  59  /*
15:21:28  60  Throws exceptions:
15:21:28  61  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  62  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  63  */
15:21:28  64  	in_charge_id	    IN CHARGE.ID%TYPE,
15:21:28  65  	in_charge_status_id IN CHARGE.CHARGE_STATUS_ID%TYPE,
15:21:28  66  	in_updated_by	    IN CHARGE.UPDATED_BY%TYPE
15:21:28  67  );
15:21:28  68  
15:21:28  69  FUNCTION IS_CHARGE_COLLECTED (
15:21:28  70  /*
15:21:28  71  Throws:
15:21:28  72  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  73  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  74  Returns:
15:21:28  75  GLOBAL_CONST.TRUE if transaction collected,
15:21:28  76  GLOBAL_CONST.FALSE else
15:21:28  77  */
15:21:28  78  	in_charge_id IN NUMBER
15:21:28  79  ) RETURN NUMBER;
15:21:28  80  
15:21:28  81  PROCEDURE GET_COLLECTED_CHARGES (
15:21:28  82  /*
15:21:28  83  Throws exceptions:
15:21:28  84  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  85  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  86  */
15:21:28  87  	in_invoice_id  IN NUMBER,
15:21:28  88  	out_result_set OUT SYS_REFCURSOR
15:21:28  89  );
15:21:28  90  
15:21:28  91  END PROCS_CHARGE_V18;
15:21:28  92  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.03
15:21:28 SQL> 
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> -- DDL for package PROCS_CHARGE_CRU
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE "PROCS_CHARGE_CRU_V18" AS
15:21:28   2  
15:21:28   3  PROCEDURE CREATE_CHARGE(
15:21:28   4  	out_charge_id	      OUT CHARGE.ID%TYPE,
15:21:28   5  	in_charge_id	      IN CHARGE.ID%TYPE DEFAULT NULL,
15:21:28   6  	in_invoice_id	      IN CHARGE.INVOICE_ID%TYPE,
15:21:28   7  	in_transaction_id     IN CHARGE.TRANSACTION_ID%TYPE DEFAULT NULL,
15:21:28   8  	in_instrument_type_id IN CHARGE.INSTRUMENT_TYPE_ID%TYPE,
15:21:28   9  	in_instrument_id      IN CHARGE.INSTRUMENT_ID%TYPE,
15:21:28  10  	in_charge_amount      IN CHARGE.CHARGE_AMOUNT%TYPE,
15:21:28  11  	in_charge_status_id   IN CHARGE.CHARGE_STATUS_ID%TYPE,
15:21:28  12  	in_created_by	      IN CHARGE.CREATED_BY%TYPE
15:21:28  13  );
15:21:28  14  
15:21:28  15  PROCEDURE UPDATE_CHARGE(
15:21:28  16  	in_charge_id	      IN CHARGE.ID%TYPE,
15:21:28  17  	in_instrument_type_id IN CHARGE.INSTRUMENT_TYPE_ID%TYPE DEFAULT NULL,
15:21:28  18  	in_instrument_id      IN CHARGE.INSTRUMENT_ID%TYPE DEFAULT NULL,
15:21:28  19  	in_charge_amount      IN CHARGE.CHARGE_AMOUNT%TYPE DEFAULT NULL,
15:21:28  20  	in_charge_status_id   IN CHARGE.CHARGE_STATUS_ID%TYPE DEFAULT NULL,
15:21:28  21  	in_updated_by	      IN CHARGE.UPDATED_BY%TYPE
15:21:28  22  );
15:21:28  23  
15:21:28  24  END PROCS_CHARGE_CRU_V18;
15:21:28  25  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.02
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE "PROCS_CUPY" AS
15:21:28   2  
15:21:28   3  	PROCEDURE POPULATE_REQUEST_INFO(
15:21:28   4  	  in_hours_prior    IN	NUMBER,
15:21:28   5  	  in_filename	    IN	CC_REQUEST_FILE.FILE_NAME%TYPE,
15:21:28   6  	  in_creator	    IN	CC_REQUEST_FILE.UPDATED_BY%TYPE
15:21:28   7  	);
15:21:28   8  
15:21:28   9  	PROCEDURE CHASE_PROFILE_BY_REQ_FILE_ID(
15:21:28  10  	  in_request_file_id IN CC_UPDATE.CC_REQUEST_FILE_ID%TYPE,
15:21:28  11  	  in_start	     IN NUMBER,
15:21:28  12  	  in_end	     IN NUMBER,
15:21:28  13  	  out_result_set     OUT SYS_REFCURSOR
15:21:28  14  	);
15:21:28  15  
15:21:28  16  	PROCEDURE UPDATE_REQUEST_FILE_STATUS(
15:21:28  17  	  in_request_file_id IN CC_REQUEST_FILE.ID%TYPE,
15:21:28  18  	  in_status	     IN CC_REQUEST_FILE.CC_REQUEST_FILE_STATUS%TYPE,
15:21:28  19  	  in_updated_by      IN CC_REQUEST_FILE.UPDATED_BY%TYPE
15:21:28  20  	);
15:21:28  21  
15:21:28  22  	PROCEDURE UPDATE_CC_REQUEST_STATUS(
15:21:28  23  	  in_request_file_id IN CC_UPDATE.CC_REQUEST_FILE_ID%TYPE,
15:21:28  24  	  in_status	     IN CC_UPDATE.CC_UPDATE_STATUS%TYPE,
15:21:28  25  	  in_updated_by      IN CC_UPDATE.UPDATED_BY%TYPE
15:21:28  26  	);
15:21:28  27  
15:21:28  28  	PROCEDURE REQUEST_FILES_BY_STATUS (
15:21:28  29  	  in_status	      IN  CC_REQUEST_FILE.CC_REQUEST_FILE_STATUS%TYPE,
15:21:28  30  	  in_older_than_hours IN  NUMBER DEFAULT -288,
15:21:28  31  	  out_request_files   OUT SYS_REFCURSOR
15:21:28  32  	);
15:21:28  33  
15:21:28  34  	PROCEDURE COUNT_BY_REQUEST_FILE_ID (
15:21:28  35  	  in_id     IN	CC_UPDATE.CC_REQUEST_FILE_ID%TYPE,
15:21:28  36  	  out_count OUT NUMBER
15:21:28  37  	);
15:21:28  38  
15:21:28  39  	PROCEDURE GET_CREDIT_CARD_LICENSE (
15:21:28  40  	  in_chase_profile_id  IN  CREDIT_CARD.CHASE_PROFILE_ID%TYPE,
15:21:28  41  	  in_request_filename  IN  CC_REQUEST_FILE.FILE_NAME%TYPE DEFAULT NULL,
15:21:28  42  	  out_card_license     OUT SYS_REFCURSOR
15:21:28  43  	);
15:21:28  44  
15:21:28  45  	PROCEDURE UPDATE_CC_UPDATE(
15:21:28  46  	  in_id 	     IN CC_UPDATE.ID%TYPE,
15:21:28  47  	  in_status	     IN CC_UPDATE.CC_UPDATE_STATUS%TYPE,
15:21:28  48  	  in_action	     IN CC_UPDATE.CC_UPDATE_ACTION%TYPE DEFAULT NULL,
15:21:28  49  	  in_reason	     IN CC_UPDATE.CC_UPDATE_REASON%TYPE DEFAULT NULL,
15:21:28  50  	  in_response_proc_status_code IN CC_UPDATE.RESPONSE_PROC_STATUS_CODE%TYPE DEFAULT NULL,
15:21:28  51  	  in_response_proc_status_msg  IN CC_UPDATE.RESPONSE_PROC_STATUS_MESSAGE%TYPE DEFAULT NULL,
15:21:28  52  	  in_updated_by      IN CC_UPDATE.UPDATED_BY%TYPE
15:21:28  53  	);
15:21:28  54  
15:21:28  55  	PROCEDURE UPDATE_CC_UPDATE_STATUS(
15:21:28  56  	  in_id 	IN CC_UPDATE.ID%TYPE,
15:21:28  57  	  in_status	IN CC_UPDATE.CC_UPDATE_STATUS%TYPE,
15:21:28  58  	  in_updated_by IN CC_UPDATE.UPDATED_BY%TYPE
15:21:28  59  	);
15:21:28  60  
15:21:28  61  	PROCEDURE GET_REQUEST_FILE_BY_FILENAME (
15:21:28  62  	  in_request_filename  IN  CC_REQUEST_FILE.FILE_NAME%TYPE,
15:21:28  63  	  out_request_file     OUT SYS_REFCURSOR
15:21:28  64  	);
15:21:28  65  
15:21:28  66  	PROCEDURE SUSPEND_CREDIT_CARD (
15:21:28  67  	  in_credit_card_id  IN CREDIT_CARD.ID%TYPE,
15:21:28  68  	  in_updated_by      IN CREDIT_CARD.UPDATED_BY%TYPE
15:21:28  69  	);
15:21:28  70  
15:21:28  71  	PROCEDURE UPDATE_CREDIT_CARD (
15:21:28  72  	  in_credit_card_id   IN CREDIT_CARD.ID%TYPE,
15:21:28  73  	  in_last_four_cc     IN CREDIT_CARD.LAST_FOUR_CC%TYPE,
15:21:28  74  	  in_expiration_date  IN CREDIT_CARD.EXPIRATION_DATE%TYPE,
15:21:28  75  	  in_updated_by       IN CREDIT_CARD.UPDATED_BY%TYPE
15:21:28  76  	);
15:21:28  77  
15:21:28  78  	PROCEDURE COMPLETABLE_REQUESTS (
15:21:28  79  	  out_request_files OUT SYS_REFCURSOR
15:21:28  80  	);
15:21:28  81  
15:21:28  82  	PROCEDURE COMPLETABLE_REQUESTS_W_FAILS (
15:21:28  83  	  in_max_hours_before_report IN  NUMBER,
15:21:28  84  	  out_request_files	     OUT SYS_REFCURSOR
15:21:28  85  	);
15:21:28  86  
15:21:28  87  END PROCS_CUPY;
15:21:28  88  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.11
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE
15:21:28   2  PACKAGE PROCS_ENTITLEMENT_V18 AS
15:21:28   3  
15:21:28   4  PROCEDURE GET_ALL_ENTITLEMENTS(
15:21:28   5  	in_group_id IN NUMBER,
15:21:28   6  	out_result_set OUT SYS_REFCURSOR);
15:21:28   7  
15:21:28   8  PROCEDURE GET_ITUNES_ENTITLEMENTS(
15:21:28   9  	in_product_id IN CORE_OWNER.ITUNES_RECEIPT.PRODUCT_ID%TYPE,
15:21:28  10  	out_result_set OUT SYS_REFCURSOR);
15:21:28  11  
15:21:28  12  PROCEDURE GET_ARCHIVE_ENTITLEMENT_URI(
15:21:28  13  	in_subscription_id IN NUMBER,
15:21:28  14  	out_uri OUT VARCHAR2);
15:21:28  15  
15:21:28  16  END PROCS_ENTITLEMENT_V18;
15:21:28  17  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.02
15:21:28 SQL> 
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> -- DDL for package PROCS_FIN_INSTRUMENTS
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE "PROCS_FIN_INSTRUMENTS_V18" AS
15:21:28   2  
15:21:28   3  PROCEDURE UPDATE_GC_STATUS_BY_INVOICE (
15:21:28   4  	  in_invoice_id IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
15:21:28   5  	  in_status_id	IN GIFT_CERTIFICATE_STATUS.ID%TYPE,
15:21:28   6  	  in_updater	IN GIFT_CERTIFICATE.UPDATED_BY%TYPE
15:21:28   7  );
15:21:28   8  
15:21:28   9  PROCEDURE IS_INVOICE_FOR_REDEEMED_GC (
15:21:28  10  	in_invoice_id		     IN NUMBER,
15:21:28  11  	out_is_invoice_for_redeem_gc OUT NUMBER
15:21:28  12  );
15:21:28  13  
15:21:28  14  PROCEDURE GET_UNREDEEMED_GCS (
15:21:28  15  	out_result_set		OUT SYS_REFCURSOR,
15:21:28  16  	in_hours_number 	IN NUMBER DEFAULT 14*24,
15:21:28  17  	in_num_rows		IN NUMBER DEFAULT 10000,
15:21:28  18  	in_process_name 	IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE
15:21:28  19  );
15:21:28  20  
15:21:28  21  PROCEDURE GET_GC_ID_BY_PURCH_INVOICE_ID (
15:21:28  22  in_invoice_id IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
15:21:28  23  out_gift_certificate_id OUT GIFT_CERTIFICATE.ID%TYPE
15:21:28  24  );
15:21:28  25  
15:21:28  26  PROCEDURE ADD_CREDIT_CARD (
15:21:28  27  /*
15:21:28  28  Throws exceptions:
15:21:28  29  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  30  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  31  */
15:21:28  32  	in_group_id		  IN NUMBER,
15:21:28  33  	in_updated_by		  IN VARCHAR2,
15:21:28  34  	in_instrument_name	  IN VARCHAR2,
15:21:28  35  	in_card_holder_name	  IN VARCHAR2,
15:21:28  36  	in_street_address	  IN VARCHAR2,
15:21:28  37  	in_street_address2	  IN VARCHAR2,
15:21:28  38  	in_state		  IN VARCHAR2,
15:21:28  39  	in_city 		  IN VARCHAR2,
15:21:28  40  	in_postal_code		  IN VARCHAR2,
15:21:28  41  	in_country		  IN CHAR,
15:21:28  42  	in_last_four_cc 	  IN VARCHAR2,
15:21:28  43  	in_expiration_date	  IN DATE,
15:21:28  44  	in_credit_card_type_id	  IN NUMBER,
15:21:28  45  	in_token		  IN VARCHAR2,
15:21:28  46  	in_chase_profile_id	  IN VARCHAR2,
15:21:28  47  	in_credit_card_status_id  IN NUMBER,
15:21:28  48  	in_private_first_name	  IN VARCHAR2,
15:21:28  49  	in_private_last_name	  IN VARCHAR2,
15:21:28  50  	out_credit_card_id	  OUT NUMBER
15:21:28  51  );
15:21:28  52  
15:21:28  53  /******************************************************************************/
15:21:28  54  
15:21:28  55  PROCEDURE ADD_PAYPAL (
15:21:28  56  /*
15:21:28  57  Throws exceptions:
15:21:28  58  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  59  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  60  */
15:21:28  61  	in_group_id			IN NUMBER,
15:21:28  62  	in_instrument_name		IN VARCHAR2,
15:21:28  63  	in_private_email_address	IN VARCHAR2,
15:21:28  64  	in_created_by			IN VARCHAR2,
15:21:28  65  	in_paypal_status_id		IN NUMBER,
15:21:28  66  	in_paypal_prvt_street_address	IN VARCHAR2,
15:21:28  67  	in_paypal_prvt_street_address2	IN VARCHAR2,
15:21:28  68  	in_state			IN VARCHAR2,
15:21:28  69  	in_city 			IN VARCHAR2,
15:21:28  70  	in_postal_code			IN VARCHAR2,
15:21:28  71  	in_country			IN CHAR,
15:21:28  72  	in_expiration_date		IN DATE,
15:21:28  73  	in_secret_token 		IN VARCHAR2,
15:21:28  74  	out_paypal_id			OUT NUMBER
15:21:28  75  );
15:21:28  76  
15:21:28  77  /********************************************/
15:21:28  78  
15:21:28  79  PROCEDURE GET_GIFT_CERTIFICATE_BY_CODE (
15:21:28  80  /*
15:21:28  81  Throws exceptions:
15:21:28  82  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:28  83  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  84  */
15:21:28  85  	in_code       IN VARCHAR,
15:21:28  86  	out_result_set OUT SYS_REFCURSOR
15:21:28  87  );
15:21:28  88  
15:21:28  89  /********************************************/
15:21:28  90  
15:21:28  91  PROCEDURE GET_GIFT_CERTIFICATE_BY_ID (
15:21:28  92  /*
15:21:28  93  Throws exceptions:
15:21:28  94  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:28  95  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  96  */
15:21:28  97  	in_gift_certificate_id IN NUMBER,
15:21:28  98  	out_result_set	       OUT SYS_REFCURSOR
15:21:28  99  );
15:21:28 100  
15:21:28 101  /********************************************/
15:21:28 102  
15:21:28 103  PROCEDURE DISABLE_CREDIT_CARD (
15:21:28 104  /*
15:21:28 105  Throws exceptions:
15:21:28 106  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28 107  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28 108  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:28 109  */
15:21:28 110  	in_credit_card_id IN NUMBER,
15:21:28 111  	in_updated_by	  IN VARCHAR2
15:21:28 112  );
15:21:28 113  
15:21:28 114  /********************************************/
15:21:28 115  
15:21:28 116  PROCEDURE DISABLE_PAYPAL (
15:21:28 117  /*
15:21:28 118  Throws exceptions:
15:21:28 119  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28 120  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28 121  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:28 122  */
15:21:28 123  	in_paypal_id  IN NUMBER,
15:21:28 124  	in_updated_by IN VARCHAR2
15:21:28 125  );
15:21:28 126  
15:21:28 127  /********************************************/
15:21:28 128  
15:21:28 129  PROCEDURE UPDATE_CREDIT_CARD (
15:21:28 130  /*
15:21:28 131  Throws exceptions:
15:21:28 132  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28 133  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28 134  */
15:21:28 135  	in_credit_card_id	  IN NUMBER,
15:21:28 136  	in_updated_by		  IN VARCHAR2,
15:21:28 137  	in_instrument_name	  IN VARCHAR2,
15:21:28 138  	in_is_default		  IN NUMBER
15:21:28 139  );
15:21:28 140  
15:21:28 141  /********************************************/
15:21:28 142  
15:21:28 143  PROCEDURE START_GC_PURCHASING (
15:21:28 144  	in_group_id		  IN NUMBER,
15:21:28 145  	in_offer_chain_id	  IN VARCHAR2,
15:21:28 146  	in_gift_certificate_code  IN  VARCHAR2,
15:21:28 147  	in_created_by		  IN  VARCHAR2,
15:21:28 148  	in_recipient_name	  IN  VARCHAR2,
15:21:28 149  	in_recipient_email	  IN  VARCHAR2,
15:21:28 150  	in_recipient_address_id   IN NUMBER,
15:21:28 151  	in_recipient_notify_date  IN DATE,
15:21:28 152  	in_sender_name		  IN VARCHAR2,
15:21:28 153  	in_sender_email 	  IN VARCHAR2,
15:21:28 154  	in_gift_message 	  IN  VARCHAR2,
15:21:28 155  	in_expiration_date	  IN DATE,
15:21:28 156  	out_gift_certificate_id   OUT NUMBER,
15:21:28 157  	out_invoice_id		  OUT NUMBER
15:21:28 158  );
15:21:28 159  
15:21:28 160  PROCEDURE FINALIZE_GC_PURCHASING (
15:21:28 161  	in_invoice_id	      IN NUMBER,
15:21:28 162  	in_created_by	      IN VARCHAR2,
15:21:28 163  	in_instrument_id      IN NUMBER,
15:21:28 164  	in_instrument_type_id IN NUMBER,
15:21:28 165  	in_order_id	      IN VARCHAR2,
15:21:28 166  	in_transaction_id     IN NUMBER,
15:21:28 167  	out_charge_amount     OUT NUMBER
15:21:28 168  );
15:21:28 169  
15:21:28 170  PROCEDURE PURCHASE_GIFT_CERTIFICATE (
15:21:28 171  	in_group_id	  IN NUMBER,
15:21:28 172  	in_offer_chain_id IN VARCHAR2,
15:21:28 173  	in_gift_certificate_code  IN  VARCHAR2,
15:21:28 174  	in_created_by IN  VARCHAR2,
15:21:28 175  	in_recipient_name IN  VARCHAR2,
15:21:28 176  	in_recipient_email IN  VARCHAR2,
15:21:28 177  	in_sender_name IN VARCHAR2,
15:21:28 178  	in_sender_email IN VARCHAR2,
15:21:28 179  	in_gift_message IN  VARCHAR2,
15:21:28 180  	in_instrument_id  IN  NUMBER,
15:21:28 181  	in_instrument_type_id IN NUMBER,
15:21:28 182  	in_expiration_date IN DATE,
15:21:28 183  	in_order_id IN VARCHAR2,
15:21:28 184  	in_transaction_id IN NUMBER
15:21:28 185  );
15:21:28 186  
15:21:28 187  /*********************************************/
15:21:28 188  
15:21:28 189  PROCEDURE REDEEM_GIFT_CERTIFICATE (
15:21:28 190  	in_group_id			IN NUMBER,
15:21:28 191  	in_gift_certificate_code	IN VARCHAR2,
15:21:28 192  	in_created_by			IN VARCHAR2,
15:21:28 193  	in_redeemer_address_id		IN NUMBER,
15:21:28 194  	in_fin_instrument_id		IN NUMBER,
15:21:28 195  	in_fin_instrument_type_id	IN NUMBER,
15:21:28 196  	in_redemption_offer_chain_id	IN NUMBER,
15:21:28 197  	out_subscription_id		OUT NUMBER,
15:21:28 198  	out_license_id			OUT NUMBER
15:21:28 199  );
15:21:28 200  
15:21:28 201  /********************************************/
15:21:28 202  
15:21:28 203  PROCEDURE GET_DEF_FINANCIAL_INSTRUMENT (
15:21:28 204  	in_group_id	       IN  NUMBER,
15:21:28 205  	out_instrument_type_id OUT NUMBER,
15:21:28 206  	out_instrument_id      OUT NUMBER
15:21:28 207  );
15:21:28 208  
15:21:28 209  /************************************************/
15:21:28 210  
15:21:28 211  PROCEDURE SET_DEF_FINANCIAL_INSTRUMENT (
15:21:28 212  	in_group_id	      IN NUMBER,
15:21:28 213  	in_instrument_type_id IN NUMBER,
15:21:28 214  	in_instrument_id      IN NUMBER,
15:21:28 215  	in_updated_by	      IN VARCHAR2
15:21:28 216  );
15:21:28 217  
15:21:28 218  /***************************************************/
15:21:28 219  
15:21:28 220  PROCEDURE DEL_DEF_FINANCIAL_INSTRUMENT (
15:21:28 221  	in_group_id	      IN NUMBER
15:21:28 222  );
15:21:28 223  
15:21:28 224  /****************************************************/
15:21:28 225  
15:21:28 226  PROCEDURE GET_CREDIT_CARD_BY_ID (
15:21:28 227  	in_credit_card_id IN  NUMBER,
15:21:28 228  	out_result_set	  OUT SYS_REFCURSOR
15:21:28 229  );
15:21:28 230  
15:21:28 231  /****************************************************/
15:21:28 232  
15:21:28 233  PROCEDURE GET_PAYPAL_BY_ID (
15:21:28 234  	in_paypal_id   IN  NUMBER,
15:21:28 235  	out_result_set OUT SYS_REFCURSOR
15:21:28 236  );
15:21:28 237  
15:21:28 238  /***********************************************/
15:21:28 239  
15:21:28 240  FUNCTION F_CAN_DISABLE_CREDIT_CARD (
15:21:28 241  	in_credit_card_id NUMBER
15:21:28 242  ) RETURN NUMBER;
15:21:28 243  
15:21:28 244  /*************************************************/
15:21:28 245  
15:21:28 246  PROCEDURE GET_PURCHASED_GCERTIFICATES (
15:21:28 247  	in_group_id    IN NUMBER,
15:21:28 248  	out_result_set OUT SYS_REFCURSOR
15:21:28 249  );
15:21:28 250  
15:21:28 251  /*************************************************/
15:21:28 252  
15:21:28 253  -- isGiftCertificateForProperOffer
15:21:28 254  
15:21:28 255  PROCEDURE IS_GCERT_FOR_PROPER_OFFER (
15:21:28 256  	in_gift_certificate_id IN NUMBER,
15:21:28 257  	in_charge_id	       IN NUMBER,
15:21:28 258  	out_result	       OUT NUMBER
15:21:28 259  );
15:21:28 260  
15:21:28 261  FUNCTION IS_CREDIT_CARD_EXISTS (
15:21:28 262  /*
15:21:28 263  1 - if instrument exists
15:21:28 264  0 - else
15:21:28 265  */
15:21:28 266  	in_credit_card_id IN NUMBER
15:21:28 267  ) RETURN NUMBER;
15:21:28 268  
15:21:28 269  FUNCTION IS_PAYPAL_EXISTS (
15:21:28 270  /*
15:21:28 271  1 - if instrument exists
15:21:28 272  0 - else
15:21:28 273  */
15:21:28 274  	in_paypal_id IN NUMBER
15:21:28 275  ) RETURN NUMBER;
15:21:28 276  
15:21:28 277  FUNCTION IS_GIFT_CERTIFICATE_EXISTS (
15:21:28 278  /*
15:21:28 279  1 - if instrument exists
15:21:28 280  0 - else
15:21:28 281  */
15:21:28 282  	in_gift_certificate_id IN NUMBER
15:21:28 283  ) RETURN NUMBER;
15:21:28 284  
15:21:28 285  PROCEDURE GET_GROUP_ID_BY_CREDIT_CARD_ID (
15:21:28 286  	in_credit_card_id IN NUMBER,
15:21:28 287  	out_group_id	  OUT NUMBER
15:21:28 288  );
15:21:28 289  
15:21:28 290  PROCEDURE GET_GROUP_ID_BY_PAYPAL_ID (
15:21:28 291  	in_paypal_id IN NUMBER,
15:21:28 292  	out_group_id	  OUT NUMBER
15:21:28 293  );
15:21:28 294  
15:21:28 295  PROCEDURE UPDATE_CREDIT_CARD_STATUS (
15:21:28 296  	in_credit_card_id	 IN CREDIT_CARD.ID%TYPE,
15:21:28 297  	in_credit_card_status_id IN CREDIT_CARD.CREDIT_CARD_STATUS_ID%TYPE,
15:21:28 298  	in_updated_by		 IN CREDIT_CARD.UPDATED_BY%TYPE
15:21:28 299  );
15:21:28 300  
15:21:28 301  PROCEDURE UPDATE_PAYPAL_STATUS (
15:21:28 302  	in_paypal_id	    IN PAYPAL.ID%TYPE,
15:21:28 303  	in_paypal_status_id IN PAYPAL.PAYPAL_STATUS_ID%TYPE,
15:21:28 304  	in_updated_by	    IN PAYPAL.UPDATED_BY%TYPE
15:21:28 305  );
15:21:28 306  
15:21:28 307  PROCEDURE UPDATE_GIFT_CERTIFICATE_STATUS (
15:21:28 308  	in_gift_certificate_id	      IN GIFT_CERTIFICATE.ID%TYPE,
15:21:28 309  	in_gift_certificate_status_id IN GIFT_CERTIFICATE.GIFT_CERTIFICATE_STATUS_ID%TYPE,
15:21:28 310  	in_updated_by		      IN GIFT_CERTIFICATE.UPDATED_BY%TYPE
15:21:28 311  );
15:21:28 312  
15:21:28 313  PROCEDURE GET_GC_BY_PURCH_INVOICE_ID (
15:21:28 314  	in_invoice_id		IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
15:21:28 315  	out_result_set OUT SYS_REFCURSOR
15:21:28 316  );
15:21:28 317  
15:21:28 318  PROCEDURE SWITCH_FINANCIAL_INSTRUMENT (
15:21:28 319  	/*in_group_id		     IN NUMBER	-- TODO: should we pass group_id here?*/
15:21:28 320  	in_old_fin_instrument_id   IN NUMBER,
15:21:28 321  	in_old_fin_instrument_type IN NUMBER,
15:21:28 322  	in_new_fin_instrument_id   IN NUMBER,
15:21:28 323  	in_new_fin_instrument_type IN NUMBER,
15:21:28 324  	in_updated_by		   IN VARCHAR2
15:21:28 325  );
15:21:28 326  
15:21:28 327  END PROCS_FIN_INSTRUMENTS_V18;
15:21:28 328  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.06
15:21:28 SQL> 
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> -- DDL for package PROCS_FIN_INSTRUMENTS_CRU
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE "PROCS_FIN_INSTRUMENTS_CRU_V18" AS
15:21:28   2  
15:21:28   3  PROCEDURE CREATE_CREDIT_CARD(
15:21:28   4  	out_credit_card_id	    OUT CREDIT_CARD.ID%TYPE,
15:21:28   5  	in_credit_card_id	    IN CREDIT_CARD.ID%TYPE DEFAULT NULL,
15:21:28   6  	in_account_id		    IN CREDIT_CARD.ACCOUNT_ID%TYPE,
15:21:28   7  	in_instrument_name	    IN CREDIT_CARD.INSTRUMENT_NAME%TYPE,
15:21:28   8  	in_private_card_holder_name IN CREDIT_CARD.PRIVATE_CARD_HOLDER_NAME%TYPE,
15:21:28   9  	in_private_street_address   IN CREDIT_CARD.PRIVATE_STREET_ADDRESS%TYPE,
15:21:28  10  	in_private_street_address2  IN CREDIT_CARD.PRIVATE_STREET_ADDRESS2%TYPE DEFAULT NULL,
15:21:28  11  	in_state		    IN CREDIT_CARD.STATE%TYPE,
15:21:28  12  	in_city 		    IN CREDIT_CARD.CITY%TYPE,
15:21:28  13  	in_postal_code		    IN CREDIT_CARD.POSTAL_CODE%TYPE,
15:21:28  14  	in_country		    IN CREDIT_CARD.COUNTRY%TYPE,
15:21:28  15  	in_last_four_cc 	    IN CREDIT_CARD.LAST_FOUR_CC%TYPE,
15:21:28  16  	in_expiration_date	    IN CREDIT_CARD.EXPIRATION_DATE%TYPE,
15:21:28  17  	in_credit_card_type_id	    IN CREDIT_CARD.CREDIT_CARD_TYPE_ID%TYPE,
15:21:28  18  	in_secret_token 	    IN CREDIT_CARD.SECRET_TOKEN%TYPE,
15:21:28  19  	in_chase_profile_id	    IN CREDIT_CARD.CHASE_PROFILE_ID%TYPE,
15:21:28  20  	in_created_by		    IN CREDIT_CARD.CREATED_BY%TYPE,
15:21:28  21  	in_credit_card_status_id    IN CREDIT_CARD.CREDIT_CARD_STATUS_ID%TYPE,
15:21:28  22  	in_private_first_name	    IN CREDIT_CARD.PRIVATE_FIRST_NAME%TYPE,
15:21:28  23  	in_private_last_name	    IN CREDIT_CARD.PRIVATE_LAST_NAME%TYPE
15:21:28  24  );
15:21:28  25  
15:21:28  26  PROCEDURE UPDATE_CREDIT_CARD(
15:21:28  27  	in_credit_card_id	    IN CREDIT_CARD.ID%TYPE,
15:21:28  28  	in_instrument_name	    IN CREDIT_CARD.INSTRUMENT_NAME%TYPE DEFAULT NULL,
15:21:28  29  	in_private_card_holder_name IN CREDIT_CARD.PRIVATE_CARD_HOLDER_NAME%TYPE DEFAULT NULL,
15:21:28  30  	in_private_street_address   IN CREDIT_CARD.PRIVATE_STREET_ADDRESS%TYPE DEFAULT NULL,
15:21:28  31  	in_private_street_address2  IN CREDIT_CARD.PRIVATE_STREET_ADDRESS2%TYPE DEFAULT NULL,
15:21:28  32  	in_state		    IN CREDIT_CARD.STATE%TYPE DEFAULT NULL,
15:21:28  33  	in_city 		    IN CREDIT_CARD.CITY%TYPE DEFAULT NULL,
15:21:28  34  	in_postal_code		    IN CREDIT_CARD.POSTAL_CODE%TYPE DEFAULT NULL,
15:21:28  35  	in_country		    IN CREDIT_CARD.COUNTRY%TYPE DEFAULT NULL,
15:21:28  36  	in_last_four_cc 	    IN CREDIT_CARD.LAST_FOUR_CC%TYPE DEFAULT NULL,
15:21:28  37  	in_expiration_date	    IN CREDIT_CARD.EXPIRATION_DATE%TYPE DEFAULT NULL,
15:21:28  38  	in_credit_card_type_id	    IN CREDIT_CARD.CREDIT_CARD_TYPE_ID%TYPE DEFAULT NULL,
15:21:28  39  	in_secret_token 	    IN CREDIT_CARD.SECRET_TOKEN%TYPE DEFAULT NULL,
15:21:28  40  	in_chase_profile_id	    IN CREDIT_CARD.CHASE_PROFILE_ID%TYPE DEFAULT NULL,
15:21:28  41  	in_updated_by		    IN CREDIT_CARD.UPDATED_BY%TYPE,
15:21:28  42  	in_credit_card_status_id    IN CREDIT_CARD.CREDIT_CARD_STATUS_ID%TYPE DEFAULT NULL,
15:21:28  43  	in_private_first_name	    IN CREDIT_CARD.PRIVATE_FIRST_NAME%TYPE DEFAULT NULL,
15:21:28  44  	in_private_last_name	    IN CREDIT_CARD.PRIVATE_LAST_NAME%TYPE DEFAULT NULL
15:21:28  45  );
15:21:28  46  
15:21:28  47  PROCEDURE CREATE_PAYPAL(
15:21:28  48  	out_paypal_id			OUT PAYPAL.ID%TYPE,
15:21:28  49  	in_paypal_id			IN PAYPAL.ID%TYPE DEFAULT NULL,
15:21:28  50  	in_account_id			IN PAYPAL.ACCOUNT_ID%TYPE,
15:21:28  51  	in_instrument_name		IN PAYPAL.INSTRUMENT_NAME%TYPE DEFAULT NULL,
15:21:28  52  	in_private_email_address	IN PAYPAL.PRIVATE_EMAIL_ADDRESS%TYPE DEFAULT NULL,
15:21:28  53  	in_created_by			IN PAYPAL.CREATED_BY%TYPE,
15:21:28  54  	in_paypal_status_id		IN PAYPAL.PAYPAL_STATUS_ID%TYPE,
15:21:28  55  	in_paypal_prvt_street_address	IN PAYPAL.PRIVATE_STREET_ADDRESS%TYPE,
15:21:28  56  	in_paypal_prvt_street_address2	IN PAYPAL.PRIVATE_STREET_ADDRESS%TYPE,
15:21:28  57  	in_state			IN PAYPAL.STATE%TYPE,
15:21:28  58  	in_city 			IN PAYPAL.CITY%TYPE,
15:21:28  59  	in_postal_code			IN PAYPAL.POSTAL_CODE%TYPE,
15:21:28  60  	in_country			IN PAYPAL.COUNTRY%TYPE,
15:21:28  61  	in_expiration_date		IN PAYPAL.EXPIRATION_DATE%TYPE,
15:21:28  62  	in_secret_token 		IN PAYPAL.SECRET_TOKEN%TYPE
15:21:28  63  );
15:21:28  64  
15:21:28  65  PROCEDURE UPDATE_PAYPAL(
15:21:28  66  	in_paypal_id			IN PAYPAL.ID%TYPE,
15:21:28  67  	in_instrument_name		IN PAYPAL.INSTRUMENT_NAME%TYPE DEFAULT NULL,
15:21:28  68  	in_private_email_address	IN PAYPAL.PRIVATE_EMAIL_ADDRESS%TYPE DEFAULT NULL,
15:21:28  69  	in_updated_by			IN PAYPAL.UPDATED_BY%TYPE,
15:21:28  70  	in_paypal_status_id		IN PAYPAL.PAYPAL_STATUS_ID%TYPE DEFAULT NULL,
15:21:28  71  	in_paypal_prvt_street_address	IN PAYPAL.PRIVATE_STREET_ADDRESS%TYPE DEFAULT NULL,
15:21:28  72  	in_paypal_prvt_street_address2	IN PAYPAL.PRIVATE_STREET_ADDRESS%TYPE DEFAULT NULL,
15:21:28  73  	in_state			IN PAYPAL.STATE%TYPE DEFAULT NULL,
15:21:28  74  	in_city 			IN PAYPAL.CITY%TYPE DEFAULT NULL,
15:21:28  75  	in_postal_code			IN PAYPAL.POSTAL_CODE%TYPE DEFAULT NULL,
15:21:28  76  	in_country			IN PAYPAL.COUNTRY%TYPE DEFAULT NULL,
15:21:28  77  	in_expiration_date		IN PAYPAL.EXPIRATION_DATE%TYPE DEFAULT NULL,
15:21:28  78  	in_secret_token 		IN PAYPAL.SECRET_TOKEN%TYPE DEFAULT NULL
15:21:28  79  );
15:21:28  80  
15:21:28  81  PROCEDURE CREATE_GIFT_CERTIFICATE(
15:21:28  82  	out_gift_certificate_id       OUT GIFT_CERTIFICATE.ID%TYPE,
15:21:28  83  	in_gift_certificate_id	      IN GIFT_CERTIFICATE.ID%TYPE DEFAULT NULL,
15:21:28  84  	in_purchaser_group_id	      IN GIFT_CERTIFICATE.PURCHASER_GROUP_ID%TYPE,
15:21:28  85  	in_purchaser_invoice_id       IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
15:21:28  86  	in_offer_chain_id	      IN GIFT_CERTIFICATE.OFFER_CHAIN_ID%TYPE,
15:21:28  87  	in_expiration_date	      IN GIFT_CERTIFICATE.EXPIRATION_DATE%TYPE DEFAULT NULL,
15:21:28  88  	in_purchase_date	      IN GIFT_CERTIFICATE.PURCHASE_DATE%TYPE,
15:21:28  89  	in_gift_certificate_status_id IN GIFT_CERTIFICATE.GIFT_CERTIFICATE_STATUS_ID%TYPE,
15:21:28  90  	in_code 		      IN GIFT_CERTIFICATE.CODE%TYPE,
15:21:28  91  	in_created_by		      IN GIFT_CERTIFICATE.CREATED_BY%TYPE,
15:21:28  92  	in_recipient_name	      IN GIFT_CERTIFICATE.RECIPIENT_NAME%TYPE DEFAULT NULL,
15:21:28  93  	in_gift_message 	      IN GIFT_CERTIFICATE.GIFT_MESSAGE%TYPE DEFAULT NULL,
15:21:28  94  	in_recipient_email	      IN GIFT_CERTIFICATE.RECIPIENT_EMAIL%TYPE DEFAULT NULL,
15:21:28  95  	in_finalized_invoice_id       IN GIFT_CERTIFICATE.FINALIZED_INVOICE_ID%TYPE DEFAULT NULL,
15:21:28  96  	in_sender_email 	      IN GIFT_CERTIFICATE.SENDER_EMAIL%TYPE,
15:21:28  97  	in_sender_name		      IN GIFT_CERTIFICATE.SENDER_NAME%TYPE,
15:21:28  98  	in_redemption_date	      IN GIFT_CERTIFICATE.REDEMPTION_DATE%TYPE DEFAULT NULL,
15:21:28  99  	in_cancelation_date	      IN GIFT_CERTIFICATE.CANCELATION_DATE%TYPE DEFAULT NULL,
15:21:28 100  	in_redeemer_group_id	      IN GIFT_CERTIFICATE.REDEEMER_GROUP_ID%TYPE DEFAULT NULL,
15:21:28 101  	in_recipient_address_id       IN GIFT_CERTIFICATE.RECIPIENT_ADDRESS_ID%TYPE DEFAULT NULL,
15:21:28 102  	in_recipient_notify_date      IN GIFT_CERTIFICATE.RECIPIENT_NOTIFY_DATE%TYPE DEFAULT NULL
15:21:28 103  );
15:21:28 104  
15:21:28 105  PROCEDURE UPDATE_GIFT_CERTIFICATE(
15:21:28 106  	in_gift_certificate_id	      IN GIFT_CERTIFICATE.ID%TYPE,
15:21:28 107  	in_expiration_date	      IN GIFT_CERTIFICATE.EXPIRATION_DATE%TYPE DEFAULT NULL,
15:21:28 108  	in_gift_certificate_status_id IN GIFT_CERTIFICATE.GIFT_CERTIFICATE_STATUS_ID%TYPE DEFAULT NULL,
15:21:28 109  	in_code 		      IN GIFT_CERTIFICATE.CODE%TYPE DEFAULT NULL,
15:21:28 110  	in_updated_by		      IN GIFT_CERTIFICATE.UPDATED_BY%TYPE,
15:21:28 111  	in_recipient_name	      IN GIFT_CERTIFICATE.RECIPIENT_NAME%TYPE DEFAULT NULL,
15:21:28 112  	in_gift_message 	      IN GIFT_CERTIFICATE.GIFT_MESSAGE%TYPE DEFAULT NULL,
15:21:28 113  	in_recipient_email	      IN GIFT_CERTIFICATE.RECIPIENT_EMAIL%TYPE DEFAULT NULL,
15:21:28 114  	in_finalized_invoice_id       IN GIFT_CERTIFICATE.FINALIZED_INVOICE_ID%TYPE DEFAULT NULL,
15:21:28 115  	in_sender_email 	      IN GIFT_CERTIFICATE.SENDER_EMAIL%TYPE DEFAULT NULL,
15:21:28 116  	in_sender_name		      IN GIFT_CERTIFICATE.SENDER_NAME%TYPE DEFAULT NULL,
15:21:28 117  	in_redemption_date	      IN GIFT_CERTIFICATE.REDEMPTION_DATE%TYPE DEFAULT NULL,
15:21:28 118  	in_cancelation_date	      IN GIFT_CERTIFICATE.CANCELATION_DATE%TYPE DEFAULT NULL,
15:21:28 119  	in_redeemer_group_id	      IN GIFT_CERTIFICATE.REDEEMER_GROUP_ID%TYPE DEFAULT NULL,
15:21:28 120  	in_recipient_address_id       IN GIFT_CERTIFICATE.RECIPIENT_ADDRESS_ID%TYPE DEFAULT NULL,
15:21:28 121  	in_redeemer_address_id	      IN GIFT_CERTIFICATE.REDEEMER_ADDRESS_ID%TYPE DEFAULT NULL,
15:21:28 122  	in_recipient_notify_date      IN GIFT_CERTIFICATE.RECIPIENT_NOTIFY_DATE%TYPE DEFAULT NULL
15:21:28 123  );
15:21:28 124  
15:21:28 125  END PROCS_FIN_INSTRUMENTS_CRU_V18;
15:21:28 126  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.04
15:21:28 SQL> 
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> -- DDL for package PROCS_GROUP_ACCOUNT
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE "PROCS_GROUP_ACCOUNT_V18" As
15:21:28   2  
15:21:28   3  PROCEDURE UPDATE_SS_NEED_ENTITLEMENTS (
15:21:28   4  	in_sub_share_id      IN SUBSCRIPTION_SHARE.ID%TYPE,
15:21:28   5  	in_need_entitlements IN SUBSCRIPTION_SHARE.NEEDS_ENTITLEMENTS%TYPE,
15:21:28   6  	in_updater	     IN SUBSCRIPTION_SHARE.UPDATED_BY%TYPE
15:21:28   7  );
15:21:28   8  
15:21:28   9  PROCEDURE SUB_EXPIRES_NEED_ENTITLEMENTS (
15:21:28  10  	out_result_set OUT SYS_REFCURSOR
15:21:28  11  );
15:21:28  12  
15:21:28  13  PROCEDURE EXPIRE_SUB_SHARE (
15:21:28  14  	in_sub_share_id IN SUBSCRIPTION_SHARE.ID%TYPE,
15:21:28  15  	in_updater	IN SUBSCRIPTION_SHARE.UPDATED_BY%TYPE
15:21:28  16  );
15:21:28  17  
15:21:28  18  PROCEDURE EXPIRE_ALL_SHARES (
15:21:28  19  	in_group_account_id IN SUBSCRIPTION_SHARE.GROUP_ACCOUNT_ID%TYPE,
15:21:28  20  	in_updated_by	    IN SUBSCRIPTION_SHARE.UPDATED_BY%TYPE
15:21:28  21  );
15:21:28  22  
15:21:28  23  PROCEDURE SUB_SHARE_BY_GROUP_ID (
15:21:28  24  	in_group_id	 IN  ACCOUNT.GROUP_ID%TYPE,
15:21:28  25  	in_start	 IN  NUMBER,
15:21:28  26  	in_end		 IN  NUMBER,
15:21:28  27  	in_expired	 IN  NUMBER,
15:21:28  28  	out_result_set	 OUT SYS_REFCURSOR,
15:21:28  29  	out_shares_count OUT NUMBER
15:21:28  30  );
15:21:28  31  
15:21:28  32  PROCEDURE IS_VALID_IP_ADDRESS (
15:21:28  33  	in_group_account_id IN GROUP_ACCOUNT_IP_RANGE.GROUP_ACCOUNT_ID%TYPE,
15:21:28  34  	in_ip_low	    IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_LOW%TYPE,
15:21:28  35  	in_ip_high	    IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_HIGH%TYPE,
15:21:28  36  	out_is_valid	    OUT NUMBER
15:21:28  37  );
15:21:28  38  
15:21:28  39  PROCEDURE IS_VALID_EMAIL_DOMAIN (
15:21:28  40  	in_group_account_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
15:21:28  41  	in_email_domain     IN GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE,
15:21:28  42  	out_is_valid	    OUT NUMBER
15:21:28  43  );
15:21:28  44  
15:21:28  45  PROCEDURE GET_SUBSCRIPTION_SHARE (
15:21:28  46  	in_group_account_id    IN SUBSCRIPTION_SHARE.GROUP_ACCOUNT_ID%TYPE,
15:21:28  47  	in_borrower_account_id IN SUBSCRIPTION_SHARE.BORROWER_ACCOUNT_ID%TYPE,
15:21:28  48  	Out_Result_Set	       Out Sys_Refcursor
15:21:28  49  );
15:21:28  50  
15:21:28  51  PROCEDURE GET_SUBSCRIPTION_SHARES (
15:21:28  52  	in_group_account_id IN NUMBER,
15:21:28  53  	in_start	    IN NUMBER,
15:21:28  54  	in_end		    IN NUMBER,
15:21:28  55  	Out_Result_Set	    OUT Sys_Refcursor
15:21:28  56  );
15:21:28  57  
15:21:28  58  PROCEDURE GET_GROUP_ACCOUNT_BY_SUB_ID (
15:21:28  59  	in_subscription_id IN Group_Account.SUBSCRIPTION_ID%TYPE,
15:21:28  60  	Out_Result_Set	   Out Sys_Refcursor
15:21:28  61  );
15:21:28  62  
15:21:28  63  PROCEDURE CREATE_GROUP_ACCOUNT (
15:21:28  64  	in_subscription_id	 IN NUMBER,
15:21:28  65  	in_group_name		 IN VARCHAR2,
15:21:28  66  	in_first_name		 IN VARCHAR2,
15:21:28  67  	in_last_name		 IN VARCHAR2,
15:21:28  68  	in_email		 IN VARCHAR2,
15:21:28  69  	in_phone		 IN VARCHAR2,
15:21:28  70  	in_organization_type	 IN VARCHAR2,
15:21:28  71  	in_seats		 IN NUMBER,
15:21:28  72  	in_seat_ttl_in_hours	 IN NUMBER,
15:21:28  73  	in_ip			 IN NUMBER,
15:21:28  74  	in_created_by		 IN VARCHAR2
15:21:28  75  );
15:21:28  76  
15:21:28  77  PROCEDURE GET_GROUP_ACCOUNT_BY_EMAIL (
15:21:28  78  	in_email_domain     IN GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE,
15:21:28  79  	out_result_set	    OUT SYS_REFCURSOR
15:21:28  80  );
15:21:28  81  
15:21:28  82  PROCEDURE GET_GROUP_ACCOUNT_BY_IP (
15:21:28  83  	in_ip_low	    IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_LOW%TYPE,
15:21:28  84  	in_ip_high	    IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_HIGH%TYPE,
15:21:28  85  	out_result_set	    OUT SYS_REFCURSOR
15:21:28  86  );
15:21:28  87  
15:21:28  88  PROCEDURE GET_GROUP_ACCOUNT_IP_RANGES (
15:21:28  89  	in_group_account_id   IN NUMBER,
15:21:28  90  	in_start	      IN NUMBER,
15:21:28  91  	in_end		      IN NUMBER,
15:21:28  92  	in_status	      IN NUMBER,
15:21:28  93  	out_record_count      OUT NUMBER,
15:21:28  94  	out_result_set	      OUT SYS_REFCURSOR
15:21:28  95  );
15:21:28  96  
15:21:28  97  PROCEDURE GET_GRP_ACCNT_EMAIL_DOMAINS (
15:21:28  98  	in_group_account_id   IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
15:21:28  99  	in_start	      IN NUMBER,
15:21:28 100  	in_end		      IN NUMBER,
15:21:28 101  	in_status	      IN GROUP_ACCOUNT_EMAIL_DOMAIN.IS_ACTIVE%TYPE,
15:21:28 102  	out_record_count      OUT NUMBER,
15:21:28 103  	out_result_set	      OUT SYS_REFCURSOR
15:21:28 104  );
15:21:28 105  
15:21:28 106  PROCEDURE ADD_EMAIL_DOMAIN (
15:21:28 107  	in_group_account_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
15:21:28 108  	in_email_domain IN GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE,
15:21:28 109  	in_created_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.CREATED_BY%TYPE
15:21:28 110  );
15:21:28 111  
15:21:28 112  PROCEDURE DISABLE_EMAIL_DOMAIN_BY_GA_ID(
15:21:28 113  	in_group_account_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
15:21:28 114  	in_updated_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.UPDATED_BY%TYPE
15:21:28 115  );
15:21:28 116  
15:21:28 117  PROCEDURE DISABLE_EMAIL_DOMAIN_BY_ID(
15:21:28 118  	in_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.ID%TYPE,
15:21:28 119  	in_updated_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.UPDATED_BY%TYPE
15:21:28 120  );
15:21:28 121  
15:21:28 122  PROCEDURE CREATE_SUBSCRIPTION_SHARE (
15:21:28 123  	in_group_account_id    IN NUMBER,
15:21:28 124  	in_borrower_account_id IN NUMBER,
15:21:28 125  	in_ip_address	       IN VARCHAR2,
15:21:28 126  	in_email_domain        IN VARCHAR2,
15:21:28 127  	in_created_by	       IN VARCHAR2
15:21:28 128  );
15:21:28 129  
15:21:28 130  PROCEDURE GET_NUM_OCCUPIED_GROUP_SEATS (
15:21:28 131  	in_group_account_id   IN NUMBER,
15:21:28 132  	out_occupied_seats   OUT NUMBER
15:21:28 133  );
15:21:28 134  
15:21:28 135  FUNCTION F_GET_NUM_OCCUPIED_GROUP_SEATS (
15:21:28 136  	in_group_account_id   IN NUMBER
15:21:28 137  ) RETURN NUMBER;
15:21:28 138  
15:21:28 139  PROCEDURE DISABLE_IP_RANGES_BY_GA_ID(
15:21:28 140  	in_group_account_id IN GROUP_ACCOUNT_IP_RANGE.GROUP_ACCOUNT_ID%TYPE,
15:21:28 141  	in_updated_by IN GROUP_ACCOUNT_IP_RANGE.UPDATED_BY%TYPE
15:21:28 142  );
15:21:28 143  
15:21:28 144  PROCEDURE DISABLE_IP_RANGE_BY_ID(
15:21:28 145  	in_id IN GROUP_ACCOUNT_IP_RANGE.ID%TYPE,
15:21:28 146  	in_updated_by IN GROUP_ACCOUNT_IP_RANGE.UPDATED_BY%TYPE
15:21:28 147  );
15:21:28 148  
15:21:28 149  PROCEDURE ADD_IP_RANGE (
15:21:28 150  	in_group_account_id IN GROUP_ACCOUNT_IP_RANGE.GROUP_ACCOUNT_ID%TYPE,
15:21:28 151  	in_minimum_ip_string IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_STRING%TYPE,
15:21:28 152  	in_minimum_ip_low IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_LOW%TYPE,
15:21:28 153  	in_minimum_ip_high IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_HIGH%TYPE,
15:21:28 154  	in_maximum_ip_string IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_STRING%TYPE,
15:21:28 155  	in_maximum_ip_low IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_LOW%TYPE,
15:21:28 156  	in_maximum_ip_high IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_HIGH%TYPE,
15:21:28 157  	in_created_by IN GROUP_ACCOUNT_IP_RANGE.CREATED_BY%TYPE
15:21:28 158  );
15:21:28 159  
15:21:28 160  PROCEDURE GET_GRP_ID_BY_GRP_ACCOUNT_ID (
15:21:28 161  	in_group_account_id IN NUMBER,
15:21:28 162  	out_group_id OUT NUMBER
15:21:28 163  );
15:21:28 164  
15:21:28 165  PROCEDURE GET_GRP_ID_BY_GRPACCIPRNG_ID (
15:21:28 166  	in_group_account_ip_range_id IN NUMBER,
15:21:28 167  	out_group_id OUT NUMBER
15:21:28 168  );
15:21:28 169  
15:21:28 170  PROCEDURE GET_GRP_ID_BY_EMAIL_DOM_ID (
15:21:28 171  	in_group_account_email_dom_id IN NUMBER,
15:21:28 172  	out_group_id OUT NUMBER
15:21:28 173  );
15:21:28 174  
15:21:28 175  PROCEDURE UPDATE_GROUP_ACCOUNT (
15:21:28 176  	in_group_account_id	 IN GROUP_ACCOUNT.ID%TYPE,
15:21:28 177  	in_group_name		 IN GROUP_ACCOUNT.GROUP_NAME%TYPE,
15:21:28 178  	in_first_name		 IN GROUP_ACCOUNT.FIRST_NAME%TYPE,
15:21:28 179  	in_last_name		 IN GROUP_ACCOUNT.LAST_NAME%TYPE,
15:21:28 180  	in_email		 IN GROUP_ACCOUNT.EMAIL%TYPE,
15:21:28 181  	in_phone		 IN GROUP_ACCOUNT.PHONE%TYPE,
15:21:28 182  	in_updated_by		 IN GROUP_ACCOUNT.UPDATED_BY%TYPE
15:21:28 183  );
15:21:28 184  
15:21:28 185  PROCEDURE UPDATE_GROUP_ACCOUNT_SEATS (
15:21:28 186  	in_group_account_id	 IN GROUP_ACCOUNT.ID%TYPE,
15:21:28 187  	in_seats		 IN GROUP_ACCOUNT.SEATS%TYPE,
15:21:28 188  	in_updated_by		 IN GROUP_ACCOUNT.UPDATED_BY%TYPE
15:21:28 189  );
15:21:28 190  
15:21:28 191  END PROCS_GROUP_ACCOUNT_V18;
15:21:28 192  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.05
15:21:28 SQL> 
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> -- DDL for package PROCS_GROUP_ACCOUNT
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE "PROCS_GROUP_ACCOUNT_CRU_V18" AS
15:21:28   2  
15:21:28   3  PROCEDURE UPDATE_SUBSCRIPTION_SHARE (
15:21:28   4  	in_id		       IN SUBSCRIPTION_SHARE.ID%TYPE,
15:21:28   5  	in_group_account_id    IN SUBSCRIPTION_SHARE.GROUP_ACCOUNT_ID%TYPE DEFAULT NULL,
15:21:28   6  	in_borrower_account_id IN SUBSCRIPTION_SHARE.BORROWER_ACCOUNT_ID%TYPE DEFAULT NULL,
15:21:28   7  	in_ip_address	       IN SUBSCRIPTION_SHARE.IP_ADDRESS%TYPE DEFAULT NULL,
15:21:28   8  	in_start_date	       IN SUBSCRIPTION_SHARE.START_DATE%TYPE DEFAULT NULL,
15:21:28   9  	in_end_date	       IN SUBSCRIPTION_SHARE.END_DATE%TYPE DEFAULT NULL,
15:21:28  10  	in_needs_entitlements  IN SUBSCRIPTION_SHARE.NEEDS_ENTITLEMENTS%TYPE DEFAULT NULL,
15:21:28  11  	in_updated_by	       IN SUBSCRIPTION_SHARE.UPDATED_BY%TYPE
15:21:28  12  );
15:21:28  13  
15:21:28  14  PROCEDURE CREATE_GROUP_ACCOUNT (
15:21:28  15  	in_subscription_id	 IN NUMBER,
15:21:28  16  	in_group_name		 IN VARCHAR2,
15:21:28  17  	in_first_name		 IN VARCHAR2,
15:21:28  18  	in_last_name		 IN VARCHAR2,
15:21:28  19  	in_email		 IN VARCHAR2,
15:21:28  20  	in_phone		 IN VARCHAR2,
15:21:28  21  	in_organization_type	 IN VARCHAR2,
15:21:28  22  	in_seats		 IN NUMBER,
15:21:28  23  	in_seat_ttl_in_hours	 IN NUMBER,
15:21:28  24  	in_ip			 IN NUMBER,
15:21:28  25  	in_created_by		 IN VARCHAR2
15:21:28  26  );
15:21:28  27  
15:21:28  28  PROCEDURE CREATE_SUBSCRIPTION_SHARE (
15:21:28  29  	in_group_account_id    IN NUMBER,
15:21:28  30  	in_borrower_account_id IN NUMBER,
15:21:28  31  	in_ip_address	       IN VARCHAR2,
15:21:28  32  	in_email_domain        IN VARCHAR2,
15:21:28  33  	in_start_date	       IN DATE,
15:21:28  34  	in_end_date	       IN DATE,
15:21:28  35  	in_created_by	       IN VARCHAR2
15:21:28  36  );
15:21:28  37  
15:21:28  38  PROCEDURE DISABLE_IP_RANGES_BY_GA_ID(
15:21:28  39  	in_group_account_id IN GROUP_ACCOUNT_IP_RANGE.GROUP_ACCOUNT_ID%TYPE,
15:21:28  40  	in_updated_by IN GROUP_ACCOUNT_IP_RANGE.UPDATED_BY%TYPE
15:21:28  41  );
15:21:28  42  
15:21:28  43  PROCEDURE DISABLE_IP_RANGE_BY_ID(
15:21:28  44  	in_id IN GROUP_ACCOUNT_IP_RANGE.ID%TYPE,
15:21:28  45  	in_updated_by IN GROUP_ACCOUNT_IP_RANGE.UPDATED_BY%TYPE
15:21:28  46  );
15:21:28  47  
15:21:28  48  PROCEDURE ADD_IP_RANGE (
15:21:28  49  	in_group_account_id IN GROUP_ACCOUNT_IP_RANGE.GROUP_ACCOUNT_ID%TYPE,
15:21:28  50  	in_minimum_ip_string IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_STRING%TYPE,
15:21:28  51  	in_minimum_ip_low IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_LOW%TYPE,
15:21:28  52  	in_minimum_ip_high IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_HIGH%TYPE,
15:21:28  53  	in_maximum_ip_string IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_STRING%TYPE,
15:21:28  54  	in_maximum_ip_low IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_LOW%TYPE,
15:21:28  55  	in_maximum_ip_high IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_HIGH%TYPE,
15:21:28  56  	in_created_by IN GROUP_ACCOUNT_IP_RANGE.CREATED_BY%TYPE
15:21:28  57  );
15:21:28  58  
15:21:28  59  PROCEDURE DISABLE_EMAIL_DOMAIN_BY_GA_ID(
15:21:28  60  	in_group_account_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
15:21:28  61  	in_updated_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.UPDATED_BY%TYPE
15:21:28  62  );
15:21:28  63  
15:21:28  64  PROCEDURE DISABLE_EMAIL_DOMAIN_BY_ID(
15:21:28  65  	in_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.ID%TYPE,
15:21:28  66  	in_updated_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.UPDATED_BY%TYPE
15:21:28  67  );
15:21:28  68  
15:21:28  69  PROCEDURE ENABLE_EMAIL_DOMAIN_BY_ID(
15:21:28  70  	in_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.ID%TYPE,
15:21:28  71  	in_updated_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.UPDATED_BY%TYPE
15:21:28  72  );
15:21:28  73  
15:21:28  74  PROCEDURE ADD_EMAIL_DOMAIN (
15:21:28  75  	in_group_account_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
15:21:28  76  	in_email_domain IN GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE,
15:21:28  77  	in_is_active IN  GROUP_ACCOUNT_EMAIL_DOMAIN.IS_ACTIVE%TYPE,
15:21:28  78  	in_created_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.CREATED_BY%TYPE
15:21:28  79  );
15:21:28  80  
15:21:28  81  PROCEDURE UPDATE_GROUP_ACCOUNT (
15:21:28  82  	in_group_account_id	 IN GROUP_ACCOUNT.ID%TYPE,
15:21:28  83  	in_group_name		 IN GROUP_ACCOUNT.GROUP_NAME%TYPE,
15:21:28  84  	in_first_name		 IN GROUP_ACCOUNT.FIRST_NAME%TYPE,
15:21:28  85  	in_last_name		 IN GROUP_ACCOUNT.LAST_NAME%TYPE,
15:21:28  86  	in_email		 IN GROUP_ACCOUNT.EMAIL%TYPE,
15:21:28  87  	in_phone		 IN GROUP_ACCOUNT.PHONE%TYPE,
15:21:28  88  	in_updated_by		 IN GROUP_ACCOUNT.UPDATED_BY%TYPE
15:21:28  89  );
15:21:28  90  
15:21:28  91  PROCEDURE UPDATE_GROUP_ACCOUNT_SEATS (
15:21:28  92  	in_group_account_id	 IN GROUP_ACCOUNT.ID%TYPE,
15:21:28  93  	in_seats		 IN GROUP_ACCOUNT.SEATS%TYPE,
15:21:28  94  	in_updated_by		 IN GROUP_ACCOUNT.UPDATED_BY%TYPE
15:21:28  95  );
15:21:28  96  END PROCS_GROUP_ACCOUNT_CRU_V18;
15:21:28  97  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.03
15:21:28 SQL> 
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> -- DDL for package PROCS_HISTORY
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE "PROCS_HISTORY_V18" AS
15:21:28   2  
15:21:28   3  PROCEDURE CREATE_ADDRESS_HISTORY(
15:21:28   4  /*
15:21:28   5  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28   6  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28   7  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:28   8  */
15:21:28   9  	in_address_id		     IN NUMBER,
15:21:28  10  	in_system_activity_reason_id IN NUMBER
15:21:28  11  );
15:21:28  12  
15:21:28  13  PROCEDURE CREATE_ACCOUNT_HISTORY(
15:21:28  14  /*
15:21:28  15  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  16  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  17  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:28  18  */
15:21:28  19  	in_account_id		     IN NUMBER,
15:21:28  20  	in_system_activity_reason_id IN NUMBER
15:21:28  21  );
15:21:28  22  
15:21:28  23  PROCEDURE CREATE_SUBSCRIPTION_HISTORY (
15:21:28  24  /*
15:21:28  25  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  26  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  27  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:28  28  */
15:21:28  29  	in_subscription_id	     IN NUMBER,
15:21:28  30  	in_system_activity_reason_id IN NUMBER
15:21:28  31  );
15:21:28  32  
15:21:28  33  PROCEDURE CREATE_CREDIT_CARD_HISTORY(
15:21:28  34  /*
15:21:28  35  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  36  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  37  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:28  38  */
15:21:28  39  	in_credit_card_id	      IN NUMBER,
15:21:28  40  	in_system_activity_reason_id  IN  NUMBER
15:21:28  41  );
15:21:28  42  
15:21:28  43  PROCEDURE CREATE_PAYPAL_HISTORY(
15:21:28  44  /*
15:21:28  45  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  46  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  47  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:28  48  */
15:21:28  49  	in_paypal_id		      IN NUMBER,
15:21:28  50  	in_system_activity_reason_id  IN NUMBER
15:21:28  51  );
15:21:28  52  
15:21:28  53  PROCEDURE CREATE_GIFT_CERT_HISTORY(
15:21:28  54  /*
15:21:28  55  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  56  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  57  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:28  58  */
15:21:28  59  	in_gift_certificate_id	      IN NUMBER,
15:21:28  60  	in_system_activity_reason_id  IN  NUMBER
15:21:28  61  );
15:21:28  62  
15:21:28  63  PROCEDURE CREATE_TRANSACTION_HISTORY (
15:21:28  64  /*
15:21:28  65  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  66  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  67  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:28  68  */
15:21:28  69  	in_transaction_id	     IN NUMBER,
15:21:28  70  	in_system_activity_reason_id IN NUMBER
15:21:28  71  );
15:21:28  72  
15:21:28  73  PROCEDURE CREATE_INVOICE_HISTORY (
15:21:28  74  /*
15:21:28  75  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  76  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  77  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:28  78  */
15:21:28  79  	in_invoice_id		     IN NUMBER,
15:21:28  80  	in_system_activity_reason_id IN NUMBER
15:21:28  81  );
15:21:28  82  
15:21:28  83  PROCEDURE CREATE_LICENSE_HISTORY (
15:21:28  84  /*
15:21:28  85  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  86  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  87  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:28  88  */
15:21:28  89  	in_license_id		     IN NUMBER,
15:21:28  90  	in_system_activity_reason_id IN NUMBER
15:21:28  91  );
15:21:28  92  
15:21:28  93  PROCEDURE CREATE_CHARGE_HISTORY (
15:21:28  94  /*
15:21:28  95  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  96  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  97  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:28  98  */
15:21:28  99  	in_charge_id		    IN NUMBER,
15:21:28 100  	in_system_activity_reason_id IN NUMBER
15:21:28 101  );
15:21:28 102  
15:21:28 103  PROCEDURE CREATE_INVOICE_ADJ_HISTORY (
15:21:28 104  /*
15:21:28 105  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28 106  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28 107  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:28 108  */
15:21:28 109  	in_invoice_adjustment_id     IN NUMBER,
15:21:28 110  	in_system_activity_reason_id IN NUMBER
15:21:28 111  );
15:21:28 112  
15:21:28 113  
15:21:28 114  END PROCS_HISTORY_V18;
15:21:28 115  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.03
15:21:28 SQL> 
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> -- DDL for package PROCS_INVOICE
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE "PROCS_INVOICE_V18" AS
15:21:28   2  
15:21:28   3  PROCEDURE GET_INVOICE_IDS(
15:21:28   4  	in_group_id    IN ACCOUNT.GROUP_ID%TYPE,
15:21:28   5  	in_fin_id      IN SUBSCRIPTION.INSTRUMENT_ID%TYPE,
15:21:28   6  	out_result_set OUT SYS_REFCURSOR
15:21:28   7  );
15:21:28   8  
15:21:28   9  PROCEDURE IS_INVOICE_FOR_GC (
15:21:28  10  	in_invoice_id  IN NUMBER,
15:21:28  11  	out_result     OUT NUMBER
15:21:28  12  );
15:21:28  13  
15:21:28  14  PROCEDURE CREATE_INVOICE(
15:21:28  15  /*
15:21:28  16  Throws exceptions:
15:21:28  17  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  18  */
15:21:28  19  	  in_invoice_status IN NUMBER,
15:21:28  20  	  in_created_by     IN VARCHAR2,
15:21:28  21  	  in_tax_exempt_id  IN VARCHAR2,
15:21:28  22  	  out_invoice_id    OUT NUMBER
15:21:28  23  );
15:21:28  24  
15:21:28  25  PROCEDURE GET_PENDING_INVOICES (
15:21:28  26  /*
15:21:28  27  Throws exceptions:
15:21:28  28  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  29  */
15:21:28  30  	out_result_set1      OUT SYS_REFCURSOR,
15:21:28  31  	out_result_set2      OUT SYS_REFCURSOR,
15:21:28  32  	out_result_set3      OUT SYS_REFCURSOR,
15:21:28  33  	in_row_number	     IN NUMBER DEFAULT NULL
15:21:28  34  );
15:21:28  35  
15:21:28  36  PROCEDURE CALCULATE_INVOICE_AMOUNT (
15:21:28  37  /*
15:21:28  38  Throws exceptions:
15:21:28  39  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  40  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  41  */
15:21:28  42  	in_invoice_id IN  NUMBER,
15:21:28  43  	out_amount    OUT NUMBER
15:21:28  44  );
15:21:28  45  
15:21:28  46  FUNCTION F_CALCULATE_INVOICE_AMOUNT(
15:21:28  47  	in_invoice_id IN  NUMBER
15:21:28  48  ) RETURN NUMBER;
15:21:28  49  
15:21:28  50  PROCEDURE GET_ACCOUNT_BY_INVOICE_ID (
15:21:28  51  /*
15:21:28  52  Throws exceptions:
15:21:28  53  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  54  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  55  */
15:21:28  56  	in_invoice_id  IN  NUMBER,
15:21:28  57  	out_account_id OUT NUMBER
15:21:28  58  );
15:21:28  59  
15:21:28  60  PROCEDURE GET_INVOICE_DETAILS (
15:21:28  61  /*
15:21:28  62  Throws exceptions:
15:21:28  63  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  64  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  65  */
15:21:28  66  	in_invoice_id	   IN  NUMBER,
15:21:28  67  	out_group_id	   OUT NUMBER,
15:21:28  68  	out_status_id	   OUT NUMBER,
15:21:28  69  	out_line_items_set OUT SYS_REFCURSOR,
15:21:28  70  	out_pp_charges_set OUT SYS_REFCURSOR,
15:21:28  71  	out_cc_charges_set OUT SYS_REFCURSOR,
15:21:28  72  	out_gc_charges_set OUT SYS_REFCURSOR
15:21:28  73  );
15:21:28  74  -- norlov: #38796
15:21:28  75  PROCEDURE GET_TRANSACTION_INVOICE (
15:21:28  76  /*
15:21:28  77  Throws exceptions:
15:21:28  78  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  79  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  80  */
15:21:28  81  	in_transaction_id  IN  NUMBER,
15:21:28  82  	out_result_set	      OUT SYS_REFCURSOR
15:21:28  83  );
15:21:28  84  
15:21:28  85  PROCEDURE UPDATE_INVOICE_STATUS (
15:21:28  86  /*
15:21:28  87  Throws exceptions:
15:21:28  88  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  89  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  90  */
15:21:28  91  	in_invoice_id		       IN NUMBER,
15:21:28  92  	in_invoice_status_id	       IN NUMBER,
15:21:28  93  	in_updated_by		       IN VARCHAR2
15:21:28  94  );
15:21:28  95  
15:21:28  96  FUNCTION IS_INVOICE_PAYING_STARTED (
15:21:28  97  /*
15:21:28  98  Throws exceptions:
15:21:28  99  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28 100  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28 101  */
15:21:28 102  	in_invoice_id IN NUMBER
15:21:28 103  ) RETURN NUMBER;
15:21:28 104  
15:21:28 105  PROCEDURE P_IS_INVOICE_PAYING_STARTED (
15:21:28 106  	in_invoice_id  IN NUMBER,
15:21:28 107  	out_is_started OUT NUMBER
15:21:28 108  );
15:21:28 109  
15:21:28 110  PROCEDURE CALCULATE_INVOICE_CHARGEBACK (
15:21:28 111  	in_invoice_id	      IN NUMBER,
15:21:28 112  	in_chargeback_date    IN DATE,
15:21:28 113  	out_chargeback_amount OUT NUMBER
15:21:28 114  );
15:21:28 115  
15:21:28 116  PROCEDURE APPLY_REFUND (
15:21:28 117  	in_invoice_id	     IN NUMBER,
15:21:28 118  	in_chargeback_amount IN NUMBER,
15:21:28 119  	in_created_by	     IN VARCHAR2,
15:21:28 120  	out_charge_id	     OUT NUMBER
15:21:28 121  );
15:21:28 122  
15:21:28 123  PROCEDURE GET_MAX_REFUND (
15:21:28 124  	in_invoice_id IN NUMBER,
15:21:28 125  	out_amount    OUT NUMBER
15:21:28 126  );
15:21:28 127  
15:21:28 128  PROCEDURE GET_INVOICE_DAYS_USED_NUMBER (
15:21:28 129  	in_invoice_id	    IN NUMBER,
15:21:28 130  	in_chargeback_date  IN DATE DEFAULT SYSDATE,
15:21:28 131  	out_days_num	    OUT NUMBER
15:21:28 132  );
15:21:28 133  
15:21:28 134  PROCEDURE GET_INVOICE_LINE_ITEMS (
15:21:28 135  	in_invoice_id  IN NUMBER,
15:21:28 136  	out_result_set OUT SYS_REFCURSOR
15:21:28 137  );
15:21:28 138  
15:21:28 139  PROCEDURE GET_INVOICE_LICENSES (
15:21:28 140  	in_invoice_id  IN NUMBER,
15:21:28 141  	out_result_set OUT SYS_REFCURSOR
15:21:28 142  );
15:21:28 143  
15:21:28 144  PROCEDURE GET_OFFER_CH_ID_BY_INVOICE_ID (
15:21:28 145  	in_invoice_id	   IN NUMBER,
15:21:28 146  	out_offer_chain_id OUT NUMBER
15:21:28 147  );
15:21:28 148  
15:21:28 149  PROCEDURE CLOSE_INVOICE_AS_NOT_COLLECTED (
15:21:28 150  -- Closing invoice without refund
15:21:28 151  	in_invoice_id IN NUMBER,
15:21:28 152  	in_updated_by IN VARCHAR2
15:21:28 153  );
15:21:28 154  
15:21:28 155  PROCEDURE GET_SUBSCR_ID_BY_INVOICE_ID (
15:21:28 156  	in_invoice_id	    IN NUMBER,
15:21:28 157  	out_subscription_id OUT NUMBER
15:21:28 158  );
15:21:28 159  
15:21:28 160  PROCEDURE IS_INVOICE_TAX_EXEMPT (
15:21:28 161  /*
15:21:28 162  Throws exceptions:
15:21:28 163  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:28 164  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28 165  Return:
15:21:28 166  	GLOBAL_CONSTANTS_V18.TRUE if ACCOUNT.EXEMPT_ID is not null
15:21:28 167  	GLOBAL_CONSTANTS_V18.FALSE else
15:21:28 168  */
15:21:28 169  	in_invoice_id	  IN NUMBER,
15:21:28 170  	out_is_tax_exempt OUT NUMBER
15:21:28 171  );
15:21:28 172  
15:21:28 173  PROCEDURE GET_INVOICE_BY_ID (
15:21:28 174  	in_invoice_id  IN NUMBER,
15:21:28 175  	out_result_set OUT SYS_REFCURSOR
15:21:28 176  );
15:21:28 177  
15:21:28 178  PROCEDURE GET_IS_TAX_CALCULATION_NEEDED (
15:21:28 179  	in_invoice_id		      IN NUMBER,
15:21:28 180  	out_is_tax_calculation_needed OUT NUMBER
15:21:28 181  );
15:21:28 182  
15:21:28 183  PROCEDURE SET_IS_TAX_CALCULATION_NEEDED (
15:21:28 184  	in_invoice_id		     IN NUMBER,
15:21:28 185  	in_updated_by		     IN VARCHAR2,
15:21:28 186  	in_is_tax_calculation_needed IN NUMBER
15:21:28 187  );
15:21:28 188  
15:21:28 189  PROCEDURE REFUND_INVOICE (
15:21:28 190  	in_invoice_id	   IN NUMBER,
15:21:28 191  	in_refund_amount   IN NUMBER,
15:21:28 192  	in_note 	   IN VARCHAR2,
15:21:28 193  	in_created_by	   IN VARCHAR2,
15:21:28 194  	out_charge_id	   OUT NUMBER
15:21:28 195  );
15:21:28 196  
15:21:28 197  PROCEDURE GET_PAYMENT_INFO_BY_INVOICE_ID (
15:21:28 198  	in_invoice_id		    IN NUMBER,
15:21:28 199  	out_order_id		    OUT VARCHAR2,
15:21:28 200  	out_external_transaction_id OUT VARCHAR2
15:21:28 201  );
15:21:28 202  
15:21:28 203  PROCEDURE GET_INVOICE_BY_TRNS_ORDER_ID (
15:21:28 204  	in_order_id  IN TRANSACTION.ORDER_ID%TYPE,
15:21:28 205  	out_result_set OUT SYS_REFCURSOR
15:21:28 206  );
15:21:28 207  
15:21:28 208  PROCEDURE IS_REVOKE_ENTITLEMENTS(
15:21:28 209  	in_invoice_id IN NUMBER,
15:21:28 210  	out_is_revoke OUT NUMBER
15:21:28 211  );
15:21:28 212  
15:21:28 213  END PROCS_INVOICE_V18;
15:21:28 214  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.04
15:21:28 SQL> 
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> -- DDL for package PROCS_INVOICE_CRU
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE "PROCS_INVOICE_CRU_V18" AS
15:21:28   2  
15:21:28   3  PROCEDURE CREATE_INVOICE (
15:21:28   4  	out_invoice_id		       OUT INVOICE.ID%TYPE,
15:21:28   5  	in_invoice_id		       IN INVOICE.ID%TYPE DEFAULT NULL,
15:21:28   6  	in_invoice_status_id	       IN INVOICE.INVOICE_STATUS_ID%TYPE,
15:21:28   7  	in_tax_exempt_id	       IN INVOICE.TAX_EXEMPT_ID%TYPE,
15:21:28   8  	in_created_by		       IN INVOICE.CREATED_BY%TYPE
15:21:28   9  );
15:21:28  10  
15:21:28  11  PROCEDURE UPDATE_INVOICE (
15:21:28  12  	in_invoice_id		       IN INVOICE.ID%TYPE,
15:21:28  13  	in_updated_by		       IN INVOICE.UPDATED_BY%TYPE,
15:21:28  14  	in_invoice_status_id	       IN INVOICE.INVOICE_STATUS_ID%TYPE DEFAULT NULL,
15:21:28  15  	in_is_tax_calculation_needed   IN INVOICE.IS_TAX_CALCULATION_NEEDED%TYPE DEFAULT NULL
15:21:28  16  );
15:21:28  17  
15:21:28  18  END PROCS_INVOICE_CRU_V18;
15:21:28  19  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.02
15:21:28 SQL> 
15:21:28 SQL> /*
15:21:28 SQL> CREATE TABLE ITUNES_RECEIPT (
15:21:28 SQL> 	id NUMBER NOT NULL ENABLE,
15:21:28 SQL> 	subscription_id NUMBER NOT NULL ENABLE,
15:21:28 SQL> 	receipt VARCHAR(1024) NOT NULL ENABLE,
15:21:28 SQL> 	status NUMBER,
15:21:28 SQL> 	quantity NUMBER,
15:21:28 SQL> 	product_id VARCHAR(1024),
15:21:28 SQL> 	transaction_id VARCHAR(1024),
15:21:28 SQL> 	purchase_date TIMESTAMP,
15:21:28 SQL> 	original_transaction_id VARCHAR(1024),
15:21:28 SQL> 	original_purchase_date TIMESTAMP,
15:21:28 SQL> 	app_item_id VARCHAR(1024),
15:21:28 SQL> 	version_external_id NUMBER,
15:21:28 SQL> 	bid VARCHAR(1024),
15:21:28 SQL> 	bvrs VARCHAR(255),
15:21:28 SQL> 	expires_date TIMESTAMP,
15:21:28 SQL> 	create_date DATE NOT NULL,
15:21:28 SQL> 	created_by VARCHAR(255) NOT NULL,
15:21:28 SQL> 	update_date DATE NOT NULL,
15:21:28 SQL> 	updated_by VARCHAR(255) NOT NULL,
15:21:28 SQL> 	last_check_date DATE NOT NULL,
15:21:28 SQL> 	CONSTRAINT "ITUNESRECEIPT_PK" PRIMARY KEY ("ID") USING INDEX TABLESPACE "CORE_IDX" ENABLE,
15:21:28 SQL> 	CONSTRAINT "ITUNESRECEIPT_SUBID_FK" FOREIGN KEY ("SUBSCRIPTION_ID") REFERENCES SUBSCRIPTION(ID) USING INDEX TABLESPACE "CORE_IDX" ENABLE,
15:21:28 SQL> 	CONSTRAINT "ITUNESRECEIPT_RECEIPT_UK" UNIQUE(receipt) USING INDEX TABLESPACE "CORE_IDX" ENABLE,
15:21:28 SQL> 	CONSTRAINT "ITUNESRECEIPT_SUBID_UK" UNIQUE(subscription_id) USING INDEX TABLESPACE "CORE_IDX" ENABLE
15:21:28 SQL> )
15:21:28 SQL> TABLESPACE CORE;
15:21:28 SQL> */
15:21:28 SQL> 
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE "PROCS_ITUNES_RECEIPT_V18" AS
15:21:28   2  
15:21:28   3  PROCEDURE ITUNES_RECEIPT_SUBSCRIPTION(
15:21:28   4  	      /*
15:21:28   5  	      Throws exceptions:
15:21:28   6  	      APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28   7  	      */
15:21:28   8  	      in_original_transaction_id IN ITUNES_RECEIPT.ORIGINAL_TRANSACTION_ID%TYPE,
15:21:28   9  	      out_result_set	  OUT SYS_REFCURSOR
15:21:28  10  );
15:21:28  11  
15:21:28  12  PROCEDURE CREATE_RECEIPT(
15:21:28  13  /*
15:21:28  14  Throws exceptions:
15:21:28  15  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  16  */
15:21:28  17  	  out_id	      OUT NUMBER,
15:21:28  18  	  in_subscription_id  IN ITUNES_RECEIPT.SUBSCRIPTION_ID%TYPE,
15:21:28  19  	  in_receipt	      IN ITUNES_RECEIPT.RECEIPT%TYPE,
15:21:28  20  	  in_status	      IN ITUNES_RECEIPT.STATUS%TYPE,
15:21:28  21  	  in_quantity	      IN ITUNES_RECEIPT.QUANTITY%TYPE,
15:21:28  22  	  in_product_id       IN ITUNES_RECEIPT.PRODUCT_ID%TYPE,
15:21:28  23  	  in_transaction_id   IN ITUNES_RECEIPT.TRANSACTION_ID%TYPE,
15:21:28  24  	  in_purchase_date    IN ITUNES_RECEIPT.PURCHASE_DATE%TYPE,
15:21:28  25  	  in_original_transaction_id IN ITUNES_RECEIPT.ORIGINAL_TRANSACTION_ID%TYPE,
15:21:28  26  	  in_original_purchase_date IN ITUNES_RECEIPT.ORIGINAL_PURCHASE_DATE%TYPE,
15:21:28  27  	  in_app_item_id      IN ITUNES_RECEIPT.APP_ITEM_ID%TYPE,
15:21:28  28  	  in_version_external_id IN ITUNES_RECEIPT.VERSION_EXTERNAL_ID%TYPE,
15:21:28  29  	  in_bid	      IN ITUNES_RECEIPT.BID%TYPE,
15:21:28  30  	  in_bvrs	      IN ITUNES_RECEIPT.BVRS%TYPE,
15:21:28  31  	  in_expires_date     IN ITUNES_RECEIPT.EXPIRES_DATE%TYPE,
15:21:28  32  	  in_created_by       IN ITUNES_RECEIPT.CREATED_BY%TYPE
15:21:28  33  );
15:21:28  34  
15:21:28  35  PROCEDURE UPDATE_RECEIPT(
15:21:28  36  /*
15:21:28  37  Throws exceptions:
15:21:28  38  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  39  */
15:21:28  40  	  in_id 	      IN ITUNES_RECEIPT.ID%TYPE,
15:21:28  41  	  in_receipt	      IN ITUNES_RECEIPT.RECEIPT%TYPE,
15:21:28  42  	  in_status	      IN ITUNES_RECEIPT.STATUS%TYPE,
15:21:28  43  	  in_quantity	      IN ITUNES_RECEIPT.QUANTITY%TYPE,
15:21:28  44  	  in_product_id       IN ITUNES_RECEIPT.PRODUCT_ID%TYPE,
15:21:28  45  	  in_transaction_id   IN ITUNES_RECEIPT.TRANSACTION_ID%TYPE,
15:21:28  46  	  in_purchase_date    IN ITUNES_RECEIPT.PURCHASE_DATE%TYPE,
15:21:28  47  	  in_original_transaction_id IN ITUNES_RECEIPT.ORIGINAL_TRANSACTION_ID%TYPE,
15:21:28  48  	  in_original_purchase_date IN ITUNES_RECEIPT.ORIGINAL_PURCHASE_DATE%TYPE,
15:21:28  49  	  in_app_item_id      IN ITUNES_RECEIPT.APP_ITEM_ID%TYPE,
15:21:28  50  	  in_version_external_id IN ITUNES_RECEIPT.VERSION_EXTERNAL_ID%TYPE,
15:21:28  51  	  in_bid	      IN ITUNES_RECEIPT.BID%TYPE,
15:21:28  52  	  in_bvrs	      IN ITUNES_RECEIPT.BVRS%TYPE,
15:21:28  53  	  in_expires_date     IN ITUNES_RECEIPT.EXPIRES_DATE%TYPE,
15:21:28  54  	  in_updated_by       IN ITUNES_RECEIPT.UPDATED_BY%TYPE,
15:21:28  55  	  in_is_expired       IN NUMBER
15:21:28  56  );
15:21:28  57  
15:21:28  58  PROCEDURE LINK_ITUNES_RECEIPT(
15:21:28  59  /*
15:21:28  60  Throws exceptions:
15:21:28  61  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  62  */
15:21:28  63  	  in_id 	      IN ITUNES_RECEIPT.ID%TYPE,
15:21:28  64  	  in_subscription_id  IN ITUNES_RECEIPT.SUBSCRIPTION_ID%TYPE,
15:21:28  65  	  in_updated_by       IN ITUNES_RECEIPT.UPDATED_BY%TYPE
15:21:28  66  );
15:21:28  67  
15:21:28  68  PROCEDURE MARK_RECEIPT_CHECKED(
15:21:28  69  /*
15:21:28  70  Throws exceptions:
15:21:28  71  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  72  */
15:21:28  73  	  in_id       IN ITUNES_RECEIPT.ID%TYPE
15:21:28  74  );
15:21:28  75  
15:21:28  76  PROCEDURE GET_ITUNES_RECEIPTS (
15:21:28  77  /*
15:21:28  78  Throws exceptions:
15:21:28  79  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  80  */
15:21:28  81  	out_result_set	    OUT SYS_REFCURSOR,
15:21:28  82  	in_row_number	    IN NUMBER DEFAULT 500
15:21:28  83  );
15:21:28  84  
15:21:28  85  PROCEDURE GET_VENDOR_FROM_ITUNES_PID(
15:21:28  86  /*
15:21:28  87  Throws exceptions:
15:21:28  88  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  89  */
15:21:28  90  	  out_vendor_source_id OUT OFFER_CHAIN.VENDOR_SOURCE_ID%TYPE,
15:21:28  91  	  in_itunes_pid        IN ITUNES_RECEIPT.PRODUCT_ID%TYPE
15:21:28  92  );
15:21:28  93  
15:21:28  94  END PROCS_ITUNES_RECEIPT_V18;
15:21:28  95  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.03
15:21:28 SQL> 
15:21:28 SQL> /*
15:21:28 SQL> CREATE TABLE ITUNES_RECEIPT (
15:21:28 SQL> 	id NUMBER NOT NULL ENABLE,
15:21:28 SQL> 	subscription_id NUMBER NOT NULL ENABLE,
15:21:28 SQL> 	receipt VARCHAR(1024) NOT NULL ENABLE,
15:21:28 SQL> 	status NUMBER,
15:21:28 SQL> 	quantity NUMBER,
15:21:28 SQL> 	product_id VARCHAR(1024),
15:21:28 SQL> 	transaction_id VARCHAR(1024),
15:21:28 SQL> 	purchase_date TIMESTAMP,
15:21:28 SQL> 	original_transaction_id VARCHAR(1024),
15:21:28 SQL> 	original_purchase_date TIMESTAMP,
15:21:28 SQL> 	app_item_id VARCHAR(1024),
15:21:28 SQL> 	version_external_id NUMBER,
15:21:28 SQL> 	bid VARCHAR(1024),
15:21:28 SQL> 	bvrs VARCHAR(255),
15:21:28 SQL> 	expires_date TIMESTAMP,
15:21:28 SQL> 	create_date DATE NOT NULL,
15:21:28 SQL> 	created_by VARCHAR(255) NOT NULL,
15:21:28 SQL> 	update_date DATE NOT NULL,
15:21:28 SQL> 	updated_by VARCHAR(255) NOT NULL,
15:21:28 SQL> 	last_check_date DATE NOT NULL,
15:21:28 SQL> 	CONSTRAINT "ITUNESRECEIPT_PK" PRIMARY KEY ("ID") USING INDEX TABLESPACE "CORE_IDX" ENABLE,
15:21:28 SQL> 	CONSTRAINT "ITUNESRECEIPT_SUBID_FK" FOREIGN KEY ("SUBSCRIPTION_ID") REFERENCES SUBSCRIPTION(ID) USING INDEX TABLESPACE "CORE_IDX" ENABLE,
15:21:28 SQL> 	CONSTRAINT "ITUNESRECEIPT_RECEIPT_UK" UNIQUE(receipt) USING INDEX TABLESPACE "CORE_IDX" ENABLE,
15:21:28 SQL> 	CONSTRAINT "ITUNESRECEIPT_SUBID_UK" UNIQUE(subscription_id) USING INDEX TABLESPACE "CORE_IDX" ENABLE
15:21:28 SQL> )
15:21:28 SQL> TABLESPACE CORE;
15:21:28 SQL> */
15:21:28 SQL> 
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE "PROCS_ITUNES_RECEIPT_CRU_V18" AS
15:21:28   2  
15:21:28   3  PROCEDURE CREATE_RECEIPT(
15:21:28   4  /*
15:21:28   5  Throws exceptions:
15:21:28   6  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28   7  */
15:21:28   8  	  out_id	      OUT NUMBER,
15:21:28   9  	  in_subscription_id  IN CORE_OWNER.ITUNES_RECEIPT.SUBSCRIPTION_ID%TYPE,
15:21:28  10  	  in_receipt	      IN CORE_OWNER.ITUNES_RECEIPT.RECEIPT%TYPE,
15:21:28  11  	  in_status	      IN CORE_OWNER.ITUNES_RECEIPT.STATUS%TYPE,
15:21:28  12  	  in_quantity	      IN CORE_OWNER.ITUNES_RECEIPT.QUANTITY%TYPE,
15:21:28  13  	  in_product_id       IN CORE_OWNER.ITUNES_RECEIPT.PRODUCT_ID%TYPE,
15:21:28  14  	  in_transaction_id   IN CORE_OWNER.ITUNES_RECEIPT.TRANSACTION_ID%TYPE,
15:21:28  15  	  in_purchase_date    IN CORE_OWNER.ITUNES_RECEIPT.PURCHASE_DATE%TYPE,
15:21:28  16  	  in_original_transaction_id IN CORE_OWNER.ITUNES_RECEIPT.ORIGINAL_TRANSACTION_ID%TYPE,
15:21:28  17  	  in_original_purchase_date IN CORE_OWNER.ITUNES_RECEIPT.ORIGINAL_PURCHASE_DATE%TYPE,
15:21:28  18  	  in_app_item_id      IN CORE_OWNER.ITUNES_RECEIPT.APP_ITEM_ID%TYPE,
15:21:28  19  	  in_version_external_id IN CORE_OWNER.ITUNES_RECEIPT.VERSION_EXTERNAL_ID%TYPE,
15:21:28  20  	  in_bid	      IN CORE_OWNER.ITUNES_RECEIPT.BID%TYPE,
15:21:28  21  	  in_bvrs	      IN CORE_OWNER.ITUNES_RECEIPT.BVRS%TYPE,
15:21:28  22  	  in_expires_date     IN CORE_OWNER.ITUNES_RECEIPT.EXPIRES_DATE%TYPE,
15:21:28  23  	  in_created_by       IN CORE_OWNER.ITUNES_RECEIPT.CREATED_BY%TYPE
15:21:28  24  );
15:21:28  25  
15:21:28  26  PROCEDURE UPDATE_RECEIPT(
15:21:28  27  /*
15:21:28  28  Throws exceptions:
15:21:28  29  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  30  */
15:21:28  31  	  in_id 	      IN CORE_OWNER.ITUNES_RECEIPT.ID%TYPE,
15:21:28  32  	  in_receipt	      IN CORE_OWNER.ITUNES_RECEIPT.RECEIPT%TYPE,
15:21:28  33  	  in_status	      IN CORE_OWNER.ITUNES_RECEIPT.STATUS%TYPE,
15:21:28  34  	  in_quantity	      IN CORE_OWNER.ITUNES_RECEIPT.QUANTITY%TYPE,
15:21:28  35  	  in_product_id       IN CORE_OWNER.ITUNES_RECEIPT.PRODUCT_ID%TYPE,
15:21:28  36  	  in_transaction_id   IN CORE_OWNER.ITUNES_RECEIPT.TRANSACTION_ID%TYPE,
15:21:28  37  	  in_purchase_date    IN CORE_OWNER.ITUNES_RECEIPT.PURCHASE_DATE%TYPE,
15:21:28  38  	  in_original_transaction_id IN CORE_OWNER.ITUNES_RECEIPT.ORIGINAL_TRANSACTION_ID%TYPE,
15:21:28  39  	  in_original_purchase_date IN CORE_OWNER.ITUNES_RECEIPT.ORIGINAL_PURCHASE_DATE%TYPE,
15:21:28  40  	  in_app_item_id      IN CORE_OWNER.ITUNES_RECEIPT.APP_ITEM_ID%TYPE,
15:21:28  41  	  in_version_external_id IN CORE_OWNER.ITUNES_RECEIPT.VERSION_EXTERNAL_ID%TYPE,
15:21:28  42  	  in_bid	      IN CORE_OWNER.ITUNES_RECEIPT.BID%TYPE,
15:21:28  43  	  in_bvrs	      IN CORE_OWNER.ITUNES_RECEIPT.BVRS%TYPE,
15:21:28  44  	  in_expires_date     IN CORE_OWNER.ITUNES_RECEIPT.EXPIRES_DATE%TYPE,
15:21:28  45  	  in_updated_by       IN CORE_OWNER.ITUNES_RECEIPT.UPDATED_BY%TYPE,
15:21:28  46  	  in_cancel_date      IN CORE_OWNER.ITUNES_RECEIPT.CANCEL_DATE%TYPE
15:21:28  47  );
15:21:28  48  
15:21:28  49  PROCEDURE LINK_ITUNES_RECEIPT(
15:21:28  50  /*
15:21:28  51  Throws exceptions:
15:21:28  52  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  53  */
15:21:28  54  	  in_id 	      IN CORE_OWNER.ITUNES_RECEIPT.ID%TYPE,
15:21:28  55  	  in_subscription_id  IN CORE_OWNER.ITUNES_RECEIPT.SUBSCRIPTION_ID%TYPE,
15:21:28  56  	  in_updated_by       IN CORE_OWNER.ITUNES_RECEIPT.UPDATED_BY%TYPE
15:21:28  57  );
15:21:28  58  
15:21:28  59  PROCEDURE MARK_RECEIPT_CHECKED(
15:21:28  60  /*
15:21:28  61  Throws exceptions:
15:21:28  62  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  63  */
15:21:28  64  	  in_id 	      IN CORE_OWNER.ITUNES_RECEIPT.ID%TYPE
15:21:28  65  );
15:21:28  66  
15:21:28  67  END PROCS_ITUNES_RECEIPT_CRU_V18;
15:21:28  68  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.02
15:21:28 SQL> 
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> -- DDL for package PROCS_LICENSE
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE "PROCS_LICENSE_V18" AS
15:21:28   2  
15:21:28   3  PROCEDURE CREATE_LICENSE(
15:21:28   4  /*
15:21:28   5  Throws exceptions:
15:21:28   6  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28   7  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28   8  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:28   9  */
15:21:28  10  	in_status_id		    IN NUMBER,
15:21:28  11  	in_needs_entitlements	    IN NUMBER,
15:21:28  12  	in_start_date		    IN DATE,
15:21:28  13  	in_end_date		    IN DATE,
15:21:28  14  	in_offer_id		    IN NUMBER,
15:21:28  15  	in_subscription_id	    IN NUMBER,
15:21:28  16  	in_invoice_id		    IN NUMBER,
15:21:28  17  	in_created_by		    IN VARCHAR2,
15:21:28  18  	in_is_extension 	    IN NUMBER,
15:21:28  19  	in_current_offer_index	    IN NUMBER,
15:21:28  20  	in_current_offer_recurr_num IN NUMBER,
15:21:28  21  	out_license_id		    OUT NUMBER
15:21:28  22  );
15:21:28  23  
15:21:28  24  /*********************************************/
15:21:28  25  
15:21:28  26  PROCEDURE UPDATE_LICENSE_STATUS(
15:21:28  27  /*
15:21:28  28  Throws exceptions:
15:21:28  29  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  30  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  31  */
15:21:28  32  	  in_license_id     IN NUMBER,
15:21:28  33  	  in_license_status IN NUMBER,
15:21:28  34  	  in_updated_by     IN VARCHAR2,
15:21:28  35  	  in_ent_end	    IN NUMBER DEFAULT GLOBAL_CONSTANTS_V18.FALSE
15:21:28  36  );
15:21:28  37  
15:21:28  38  /*********************************************/
15:21:28  39  
15:21:28  40  PROCEDURE GET_ENDING_LICENSES (
15:21:28  41  	in_hours_number IN NUMBER,
15:21:28  42  	out_result_set OUT SYS_REFCURSOR
15:21:28  43  );
15:21:28  44  
15:21:28  45  /*********************************************/
15:21:28  46  
15:21:28  47  PROCEDURE GET_ENDING_LICENSES_CC (
15:21:28  48  	in_hours_number IN NUMBER,
15:21:28  49  	out_result_set OUT SYS_REFCURSOR,
15:21:28  50  	in_process_name IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE
15:21:28  51  );
15:21:28  52  
15:21:28  53  /**********************************************/
15:21:28  54  
15:21:28  55  PROCEDURE GET_RECURRING_OFFER (
15:21:28  56  	in_license_id  IN NUMBER,
15:21:28  57  	out_result_set OUT SYS_REFCURSOR
15:21:28  58  );
15:21:28  59  
15:21:28  60  /**********************************************/
15:21:28  61  
15:21:28  62  PROCEDURE GET_NEXT_OFFER (
15:21:28  63  	in_license_id  IN NUMBER,
15:21:28  64  	out_result_set OUT SYS_REFCURSOR
15:21:28  65  );
15:21:28  66  
15:21:28  67  /**********************************************/
15:21:28  68  
15:21:28  69  PROCEDURE GET_GROUP_ID_BY_LICENSE_ID (
15:21:28  70  	in_license_id IN NUMBER,
15:21:28  71  	out_group_id  OUT NUMBER
15:21:28  72  );
15:21:28  73  
15:21:28  74  /**************************************************/
15:21:28  75  
15:21:28  76  PROCEDURE GET_NEED_ENTITLEMENTS_LICENSES (
15:21:28  77  	out_result_set OUT SYS_REFCURSOR
15:21:28  78  );
15:21:28  79  
15:21:28  80  /**************************************************/
15:21:28  81  
15:21:28  82  PROCEDURE UPDATE_NEED_ENTITLEMENTS_FLAG (
15:21:28  83  	in_license_id	      IN NUMBER,
15:21:28  84  	in_needs_entitlements IN NUMBER,
15:21:28  85  	in_updated_by	      IN VARCHAR2
15:21:28  86  );
15:21:28  87  
15:21:28  88  PROCEDURE GET_ENDED_GC_LICENSES (
15:21:28  89  	out_result_set		OUT SYS_REFCURSOR,
15:21:28  90  	in_hours_number 	IN NUMBER DEFAULT 14*24,
15:21:28  91  	in_num_rows		IN NUMBER DEFAULT 10000,
15:21:28  92  	in_process_name 	IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE
15:21:28  93  );
15:21:28  94  
15:21:28  95  PROCEDURE GET_LICENSE_BY_ID (
15:21:28  96  
15:21:28  97  	in_license_id  IN NUMBER,
15:21:28  98  
15:21:28  99  	out_result_set OUT SYS_REFCURSOR
15:21:28 100  
15:21:28 101  );
15:21:28 102  PROCEDURE UP_LATEST_LICE_END_BY_SUBID (
15:21:28 103  	in_subscription_id IN NUMBER,
15:21:28 104  	in_end_date IN DATE,
15:21:28 105  	in_updated_by IN VARCHAR2
15:21:28 106  );
15:21:28 107  
15:21:28 108  PROCEDURE GET_GRACE_LICE_FOR_FINAL_TRANS (
15:21:28 109  	in_days_before_close	 IN NUMBER,
15:21:28 110  	in_num_licenses_to_fetch IN NUMBER,
15:21:28 111  	out_result_set		 OUT SYS_REFCURSOR
15:21:28 112  );
15:21:28 113  
15:21:28 114  END PROCS_LICENSE_V18;
15:21:28 115  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.03
15:21:28 SQL> 
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> -- DDL for package PROCS_LICENSE_CRU
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE "PROCS_LICENSE_CRU_V18" AS
15:21:28   2  
15:21:28   3  PROCEDURE CREATE_LICENSE(
15:21:28   4  	out_license_id		    OUT LICENSE.ID%TYPE,
15:21:28   5  	in_license_id		    IN LICENSE.ID%TYPE DEFAULT NULL,
15:21:28   6  	in_license_status_id	    IN LICENSE.LICENSE_STATUS_ID%TYPE,
15:21:28   7  	in_needs_entitlements	    IN LICENSE.NEEDS_ENTITLEMENTS%TYPE,
15:21:28   8  	in_start_date		    IN LICENSE.START_DATE%TYPE,
15:21:28   9  	in_offer_id		    IN LICENSE.OFFER_ID%TYPE,
15:21:28  10  	in_subscription_id	    IN LICENSE.SUBSCRIPTION_ID%TYPE,
15:21:28  11  	in_invoice_id		    IN LICENSE.INVOICE_ID%TYPE,
15:21:28  12  	in_end_date		    IN LICENSE.END_DATE%TYPE,
15:21:28  13  	in_created_by		    IN LICENSE.CREATED_BY%TYPE,
15:21:28  14  	in_is_extension 	    IN LICENSE.IS_EXTENSION%TYPE,
15:21:28  15  	in_current_offer_index	    IN LICENSE.CURRENT_OFFER_INDEX%TYPE,
15:21:28  16  	in_current_offer_recurr_num IN LICENSE.CURRENT_OFFER_RECURR_NUM%TYPE
15:21:28  17  );
15:21:28  18  
15:21:28  19  PROCEDURE UPDATE_LICENSE (
15:21:28  20  	in_license_id		    IN LICENSE.ID%TYPE,
15:21:28  21  	in_license_status_id	    IN LICENSE.LICENSE_STATUS_ID%TYPE DEFAULT NULL,
15:21:28  22  	in_needs_entitlements	    IN LICENSE.NEEDS_ENTITLEMENTS%TYPE DEFAULT NULL,
15:21:28  23  	in_start_date		    IN LICENSE.START_DATE%TYPE DEFAULT NULL,
15:21:28  24  	in_end_date		    IN LICENSE.END_DATE%TYPE DEFAULT NULL,
15:21:28  25  	in_updated_by		    IN LICENSE.CREATED_BY%TYPE,
15:21:28  26  	in_is_extension 	    IN LICENSE.IS_EXTENSION%TYPE DEFAULT NULL,
15:21:28  27  	in_current_offer_index	    IN LICENSE.CURRENT_OFFER_INDEX%TYPE DEFAULT NULL,
15:21:28  28  	in_current_offer_recurr_num IN LICENSE.CURRENT_OFFER_RECURR_NUM%TYPE DEFAULT NULL,
15:21:28  29  	in_entitlement_end_date     IN LICENSE.ENTITLEMENT_END_DATE%TYPE DEFAULT NULL,
15:21:28  30  	in_grace_start_date	    IN LICENSE.GRACE_START_DATE%TYPE DEFAULT NULL,
15:21:28  31  	in_grace_end_date	    IN LICENSE.GRACE_END_DATE%TYPE DEFAULT NULL
15:21:28  32  );
15:21:28  33  
15:21:28  34  END PROCS_LICENSE_CRU_V18;
15:21:28  35  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.02
15:21:28 SQL> 
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> -- DDL for package PROCS_LINE_ITEMS
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE "PROCS_LINE_ITEMS_V18" AS
15:21:28   2  
15:21:28   3  PROCEDURE ADD_LINE_ITEMS(
15:21:28   4  /*
15:21:28   5  Throws exceptions:
15:21:28   6  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28   7  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28   8  */
15:21:28   9  	in_invoice_id IN NUMBER,
15:21:28  10  	in_offer_id   IN NUMBER,
15:21:28  11  	in_created_by IN VARCHAR2
15:21:28  12  );
15:21:28  13  
15:21:28  14  /****************************************************/
15:21:28  15  
15:21:28  16  PROCEDURE UPDATE_LINE_ITEM_AMOUNT (
15:21:28  17  	in_line_item_id    IN NUMBER,
15:21:28  18  	in_amount	   IN NUMBER,
15:21:28  19  	in_discount_amount IN NUMBER,
15:21:28  20  	in_taxes_amount    IN NUMBER
15:21:28  21  );
15:21:28  22  
15:21:28  23  /****************************************************/
15:21:28  24  
15:21:28  25  PROCEDURE GET_INVOICE_LINE_ITEMS (
15:21:28  26  /*
15:21:28  27  Throws exceptions:
15:21:28  28  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  29  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  30  */
15:21:28  31  	in_invoice_id  IN NUMBER,
15:21:28  32  	out_result_set OUT SYS_REFCURSOR
15:21:28  33  );
15:21:28  34  
15:21:28  35  /****************************************************/
15:21:28  36  
15:21:28  37  PROCEDURE GET_LINE_ITEM_TAXES (
15:21:28  38  /*
15:21:28  39  Throws exceptions:
15:21:28  40  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  41  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  42  */
15:21:28  43  	in_line_item_id IN  NUMBER,
15:21:28  44  	out_result_set	OUT SYS_REFCURSOR
15:21:28  45  );
15:21:28  46  /****************************************************/
15:21:28  47  
15:21:28  48  PROCEDURE GET_LINE_ITEM_DISCOUNTS (
15:21:28  49  /*
15:21:28  50  Throws exceptions:
15:21:28  51  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  52  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  53  */
15:21:28  54  	in_line_item_id IN  NUMBER,
15:21:28  55  	out_result_set	OUT SYS_REFCURSOR
15:21:28  56  );
15:21:28  57  
15:21:28  58  /****************************************************/
15:21:28  59  
15:21:28  60  PROCEDURE CALCULATE_LINE_ITEM_AMOUNT (
15:21:28  61  /*
15:21:28  62  Throws exceptions:
15:21:28  63  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  64  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  65  */
15:21:28  66  	in_line_item_id     IN	NUMBER,
15:21:28  67  	out_amount	    OUT NUMBER
15:21:28  68  );
15:21:28  69  
15:21:28  70  /****************************************************/
15:21:28  71  
15:21:28  72  FUNCTION F_CALCULATE_LINE_ITEM_AMOUNT (
15:21:28  73  /*
15:21:28  74  Throws exceptions:
15:21:28  75  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  76  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  77  */
15:21:28  78  	in_line_item_id     IN	NUMBER
15:21:28  79  ) RETURN NUMBER;
15:21:28  80  
15:21:28  81  END PROCS_LINE_ITEMS_V18;
15:21:28  82  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.04
15:21:28 SQL> 
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> -- DDL for package PROCS_LINE_ITEMS_CRU
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE "PROCS_LINE_ITEMS_CRU_V18" AS
15:21:28   2  
15:21:28   3  PROCEDURE CREATE_LINE_ITEM (
15:21:28   4  	inout_line_item_id  IN OUT LINE_ITEM.ID%TYPE,
15:21:28   5  	in_product_offer_id IN LINE_ITEM.PRODUCT_OFFER_ID%TYPE,
15:21:28   6  	in_invoice_id	    IN LINE_ITEM.INVOICE_ID%TYPE,
15:21:28   7  	in_amount	    IN LINE_ITEM.AMOUNT%TYPE,
15:21:28   8  	in_created_by	    IN LINE_ITEM.CREATED_BY%TYPE,
15:21:28   9  	in_discount_amount  IN LINE_ITEM.DISCOUNT_AMOUNT%TYPE,
15:21:28  10  	in_taxes_amount     IN LINE_ITEM.TAXES_AMOUNT%TYPE
15:21:28  11  );
15:21:28  12  
15:21:28  13  PROCEDURE UPDATE_LINE_ITEM (
15:21:28  14  	in_line_item_id     IN LINE_ITEM.ID%TYPE,
15:21:28  15  	in_amount	    IN LINE_ITEM.AMOUNT%TYPE DEFAULT NULL,
15:21:28  16  	in_discount_amount  IN LINE_ITEM.DISCOUNT_AMOUNT%TYPE  DEFAULT NULL,
15:21:28  17  	in_taxes_amount     IN LINE_ITEM.TAXES_AMOUNT%TYPE DEFAULT NULL
15:21:28  18  );
15:21:28  19  
15:21:28  20  PROCEDURE CREATE_DISCOUNT_LINE_ITEM (
15:21:28  21  	in_discount_id	IN DISCOUNT.ID%TYPE,
15:21:28  22  	in_line_item_id IN LINE_ITEM.ID%TYPE
15:21:28  23  );
15:21:28  24  
15:21:28  25  END PROCS_LINE_ITEMS_CRU_V18;
15:21:28  26  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.02
15:21:28 SQL> 
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> -- DDL for package PROCS_LOCKING
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE "PROCS_LOCKING_V18" AS
15:21:28   2  
15:21:28   3  /*
15:21:28   4  Removed by Sergey
15:21:28   5  10.12.2010
15:21:28   6  PROCEDURE INITIALIZE_SYSTEM;
15:21:28   7  
15:21:28   8  PROCEDURE INITIALIZE_ACCOUNT (
15:21:28   9  	in_account_id IN NUMBER
15:21:28  10  );
15:21:28  11  
15:21:28  12  PROCEDURE INITIALIZE_GROUP (
15:21:28  13  	in_group_id IN NUMBER
15:21:28  14  );
15:21:28  15  */
15:21:28  16  
15:21:28  17  PROCEDURE LOCK_ACCOUNT (
15:21:28  18  	in_group_id    IN NUMBER,
15:21:28  19  	in_lock_key    IN VARCHAR2,
15:21:28  20  	in_seconds_num IN NUMBER,
15:21:28  21  	in_created_by  IN VARCHAR2,
15:21:28  22  	in_reason      IN VARCHAR2
15:21:28  23  );
15:21:28  24  
15:21:28  25  PROCEDURE RELEASE_LOCK (
15:21:28  26  	in_group_id IN NUMBER,
15:21:28  27  	in_lock_key IN VARCHAR2
15:21:28  28  );
15:21:28  29  
15:21:28  30  END PROCS_LOCKING_V18;
15:21:28  31  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.03
15:21:28 SQL> 
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> -- DDL for package PROCS_NOTIFICATION
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE "PROCS_NOTIFICATION_V18" AS
15:21:28   2  
15:21:28   3  PROCEDURE GET_NOTIFICATION_TYPE_BY_NAME (
15:21:28   4  /*
15:21:28   5  Throws exceptions:
15:21:28   6  CORE_OWNER.APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28   7  CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28   8  */
15:21:28   9  	in_notification_type_name IN VARCHAR2,
15:21:28  10  	out_notification_type_id  OUT NUMBER
15:21:28  11  );
15:21:28  12  
15:21:28  13  PROCEDURE ADD_NOTIFICATION (
15:21:28  14  /*
15:21:28  15  Throws exceptions:
15:21:28  16  CORE_OWNER.APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  17  CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  18  */
15:21:28  19  	in_sender_account_id	 IN NUMBER DEFAULT 0,
15:21:28  20  	in_recipient_group_id	 IN NUMBER,
15:21:28  21  	in_notification_type_id  IN NUMBER,
15:21:28  22  	in_date_to_notify	 IN DATE,
15:21:28  23  	in_email_template_params IN CLOB
15:21:28  24  );
15:21:28  25  
15:21:28  26  PROCEDURE GET_PENDING_NOTIFICATIONS (
15:21:28  27  /*
15:21:28  28  Throws exceptions:
15:21:28  29  CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  30  */
15:21:28  31  	out_result_set OUT SYS_REFCURSOR
15:21:28  32  );
15:21:28  33  
15:21:28  34  PROCEDURE UPDATE_NOTIFICATION_TIMESTAMP (
15:21:28  35  /*
15:21:28  36  Throws exceptions:
15:21:28  37  CORE_OWNER.APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  38  CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  39  */
15:21:28  40  	in_notification_id IN NUMBER
15:21:28  41  );
15:21:28  42  
15:21:28  43  PROCEDURE SET_NOTIFICATION_STATUS (
15:21:28  44  /*
15:21:28  45  Throws exceptions:
15:21:28  46  CORE_OWNER.APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  47  CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  48  */
15:21:28  49  	in_notification_id	  IN NUMBER,
15:21:28  50  	in_notification_status_id IN NUMBER,
15:21:28  51  	in_error_message	  IN VARCHAR2
15:21:28  52  );
15:21:28  53  
15:21:28  54  PROCEDURE ADD_NOTIFICATION_FAILURE (
15:21:28  55  /*
15:21:28  56  Throws exceptions:
15:21:28  57  CORE_OWNER.APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  58  CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  59  */
15:21:28  60  	in_notification_id IN NUMBER,
15:21:28  61  	in_error_message   IN VARCHAR2
15:21:28  62  );
15:21:28  63  
15:21:28  64  PROCEDURE LOCK_PENDING_NOTIFICATION (
15:21:28  65  /*
15:21:28  66  Result: 1 if notification locked
15:21:28  67  2 - else
15:21:28  68  */
15:21:28  69  	in_notification_id IN NUMBER,
15:21:28  70  	out_lock_status    OUT NUMBER
15:21:28  71  );
15:21:28  72  
15:21:28  73  PROCEDURE GET_NOTIFICATION_DATA (
15:21:28  74  	in_notification_id IN NUMBER,
15:21:28  75  	out_result_set	   OUT SYS_REFCURSOR
15:21:28  76  );
15:21:28  77  
15:21:28  78  END PROCS_NOTIFICATION_V18;
15:21:28  79  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.01
15:21:28 SQL> 
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> -- DDL for package PROCS_OFFER_CHAIN
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE "PROCS_OFFER_CHAIN_V18" AS
15:21:28   2  
15:21:28   3  PROCEDURE GET_OFFER_CHAIN_BY_ID (
15:21:28   4  /*
15:21:28   5  Throws exceptions:
15:21:28   6  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28   7  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28   8  */
15:21:28   9  	  in_offer_chain_id IN	 NUMBER,
15:21:28  10  	  out_result_set    OUT  SYS_REFCURSOR
15:21:28  11  );
15:21:28  12  
15:21:28  13  PROCEDURE GET_OFFER_CHAINS_BY_IDS (
15:21:28  14  /*
15:21:28  15  Throws exceptions:
15:21:28  16  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:28  17  APP_EXCEPTION_CODES_V18.INVALID_PARAMETER
15:21:28  18  */
15:21:28  19  	in_offer_chain_ids IN core_owner.NUMBER_TABLE,
15:21:28  20  	out_result_set	   OUT SYS_REFCURSOR
15:21:28  21  );
15:21:28  22  
15:21:28  23  PROCEDURE GET_OFFER_CHAINS_PRODUCTS (
15:21:28  24  /*
15:21:28  25  Throws exceptions:
15:21:28  26  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:28  27  APP_EXCEPTION_CODES_V18.INVALID_PARAMETER
15:21:28  28  */
15:21:28  29  	in_offer_chain_ids IN core_owner.NUMBER_TABLE,
15:21:28  30  	out_result_set	   OUT SYS_REFCURSOR
15:21:28  31  );
15:21:28  32  
15:21:28  33  PROCEDURE GET_OFFER_CHAINS_OFFERS (
15:21:28  34  /*
15:21:28  35  Throws exceptions:
15:21:28  36  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:28  37  APP_EXCEPTION_CODES_V18.INVALID_PARAMETER
15:21:28  38  */
15:21:28  39  	in_offer_chain_ids IN core_owner.NUMBER_TABLE,
15:21:28  40  	out_result_set	   OUT SYS_REFCURSOR
15:21:28  41  );
15:21:28  42  
15:21:28  43  PROCEDURE GET_OFFER_CHAINS_BY_PRODUCT (
15:21:28  44  /*
15:21:28  45  Throws exceptions (codes):
15:21:28  46  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  47  */
15:21:28  48  	in_product_id  IN  NUMBER,
15:21:28  49  	out_result_set OUT SYS_REFCURSOR
15:21:28  50  );
15:21:28  51  
15:21:28  52  PROCEDURE GET_OFFER_CHAIN_PRICE (
15:21:28  53  /*
15:21:28  54  Throws exceptions (codes):
15:21:28  55  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  56  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  57  */
15:21:28  58  	in_offer_chain_id IN NUMBER,
15:21:28  59  	out_price	  OUT NUMBER
15:21:28  60  );
15:21:28  61  
15:21:28  62  PROCEDURE GET_FIRST_OFFER(
15:21:28  63  /*
15:21:28  64  Throws exceptions (codes):
15:21:28  65  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  66  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  67  */
15:21:28  68  	in_offer_chain_id IN  NUMBER,
15:21:28  69  	out_offer_id	  OUT NUMBER
15:21:28  70  );
15:21:28  71  
15:21:28  72  PROCEDURE GET_ACTIVE_OFFER_CHAINS (
15:21:28  73  /*
15:21:28  74  Throws exceptions (codes):
15:21:28  75  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  76  */
15:21:28  77  	out_result_set OUT SYS_REFCURSOR
15:21:28  78  );
15:21:28  79  
15:21:28  80  PROCEDURE GET_OFFER_CHAIN_PRODUCTS (
15:21:28  81  /*
15:21:28  82  Throws exceptions (codes):
15:21:28  83  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  84  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  85  */
15:21:28  86  	in_offer_chain_id IN NUMBER,
15:21:28  87  	out_result_set	  OUT SYS_REFCURSOR
15:21:28  88  );
15:21:28  89  
15:21:28  90  FUNCTION CALCULATE_OFFER_CHAIN_END_DATE (
15:21:28  91  /*
15:21:28  92  Throws exceptions (codes):
15:21:28  93  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  94  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  95  */
15:21:28  96  	in_offer_chain_id	  IN NUMBER,
15:21:28  97  	in_offer_chain_start_date IN DATE
15:21:28  98  ) RETURN DATE;
15:21:28  99  
15:21:28 100  FUNCTION CALCULATE_OFFER_AMOUNT (
15:21:28 101  	in_offer_id IN NUMBER
15:21:28 102  ) RETURN NUMBER;
15:21:28 103  
15:21:28 104  FUNCTION CALCULATE_OFFER_CHAIN_AMOUNT (
15:21:28 105  	in_offer_chain_id IN NUMBER
15:21:28 106  ) RETURN NUMBER;
15:21:28 107  
15:21:28 108  FUNCTION GET_FIRST_OFFER_INDEX (
15:21:28 109  	in_offer_chain_id IN NUMBER
15:21:28 110  ) RETURN NUMBER;
15:21:28 111  
15:21:28 112  FUNCTION GET_NEXT_OFFER_INDEX (
15:21:28 113  /*
15:21:28 114  NULL, if not exists
15:21:28 115  */
15:21:28 116  	in_offer_chain_id	     IN NUMBER,
15:21:28 117  	in_offer_chain_current_index IN NUMBER
15:21:28 118  ) RETURN NUMBER;
15:21:28 119  
15:21:28 120  PROCEDURE P_GET_NEXT_OFFER_INDEX (
15:21:28 121  	in_offer_chain_id	     IN NUMBER,
15:21:28 122  	in_offer_chain_current_index IN NUMBER,
15:21:28 123  	out_next_offer_index	     OUT NUMBER
15:21:28 124  );
15:21:28 125  
15:21:28 126  PROCEDURE GET_NEXT_OFFER_INDEX_BY_LCNS (
15:21:28 127  	in_license_id		     IN NUMBER,
15:21:28 128  	in_offer_chain_current_index IN NUMBER,
15:21:28 129  	out_next_offer_index	     OUT NUMBER
15:21:28 130  );
15:21:28 131  
15:21:28 132  FUNCTION IS_OFFER_INDEX_EXISTS (
15:21:28 133  /*
15:21:28 134  1 - exists
15:21:28 135  0 - not exists
15:21:28 136  */
15:21:28 137  	in_offer_chain_id	   IN NUMBER,
15:21:28 138  	in_offer_chain_offer_index IN NUMBER
15:21:28 139  ) RETURN NUMBER;
15:21:28 140  
15:21:28 141  PROCEDURE GET_OFFER_LENGTH (
15:21:28 142  	in_offer_id IN NUMBER,
15:21:28 143  	out_years   OUT NUMBER,
15:21:28 144  	out_months  OUT NUMBER,
15:21:28 145  	out_days    OUT NUMBER
15:21:28 146  );
15:21:28 147  
15:21:28 148  PROCEDURE GET_OFFER_LENGTH_IN_DAYS (
15:21:28 149  	in_offer_id   IN NUMBER,
15:21:28 150  	in_start_date IN DATE DEFAULT SYSDATE,
15:21:28 151  	out_days      OUT NUMBER
15:21:28 152  );
15:21:28 153  
15:21:28 154  PROCEDURE GET_OFFER_PRODUCTS (
15:21:28 155  /*
15:21:28 156  Throws exceptions (codes):
15:21:28 157  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28 158  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28 159  */
15:21:28 160  	in_offer_id    IN NUMBER,
15:21:28 161  	out_result_set OUT SYS_REFCURSOR
15:21:28 162  );
15:21:28 163  
15:21:28 164  PROCEDURE GET_OFFER_CHAIN_PROD_OFFERINGS (
15:21:28 165  /*
15:21:28 166  Throws exceptions (codes):
15:21:28 167  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28 168  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28 169  */
15:21:28 170  	in_offer_chain_id IN NUMBER,
15:21:28 171  	out_result_set	  OUT SYS_REFCURSOR
15:21:28 172  );
15:21:28 173  
15:21:28 174  FUNCTION CHECK_FOR_SAME_PRODUCTS (
15:21:28 175  /*
15:21:28 176  Throws exceptions (codes):
15:21:28 177  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28 178  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28 179  Returns:
15:21:28 180  GLOBAL_CONSTANTS_V18.TRUE if there are at least one same product
15:21:28 181  GLOBAL_CONSTANTS_V18.FALSE else
15:21:28 182  */
15:21:28 183  	in_offer_chain_1	 IN OFFER_CHAIN.ID%TYPE,
15:21:28 184  	in_offer_chain_2	 IN OFFER_CHAIN.ID%TYPE,
15:21:28 185  	in_use_eligibility_rules IN NUMBER DEFAULT GLOBAL_CONSTANTS_V18.FALSE
15:21:28 186  ) RETURN NUMBER;
15:21:28 187  
15:21:28 188  FUNCTION IS_OFFER_CHAIN_CANCELABLE (
15:21:28 189  /*
15:21:28 190  Throws exceptions (codes):
15:21:28 191  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28 192  Returns:
15:21:28 193  GLOBAL_CONSTANTS_V18.TRUE cancelation key is 1 (in OFFER_CHAIN_META_DATA)
15:21:28 194  GLOBAL_CONSTANTS_V18.FALSE else
15:21:28 195  */
15:21:28 196  	in_offer_chain_id IN NUMBER
15:21:28 197  ) RETURN NUMBER;
15:21:28 198  
15:21:28 199  FUNCTION GET_OFFER_CHAIN_MAX_CONC_SUBSC (
15:21:28 200  /*
15:21:28 201  Throws exceptions (codes):
15:21:28 202  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28 203  */
15:21:28 204  	in_offer_chain_id IN NUMBER
15:21:28 205  ) RETURN NUMBER;
15:21:28 206  
15:21:28 207  PROCEDURE GET_OFFER_CHAIN_ELIGIBILITY (
15:21:28 208  /*
15:21:28 209  Throws exceptions (codes):
15:21:28 210  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28 211  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28 212  */
15:21:28 213  	in_offer_chain_id   IN NUMBER,
15:21:28 214  	in_eligibility_name IN VARCHAR2,
15:21:28 215  	out_result_set	    OUT SYS_REFCURSOR
15:21:28 216  );
15:21:28 217  
15:21:28 218  PROCEDURE GET_OFFER_CHAINS_ELIGIBILITY (
15:21:28 219  /*
15:21:28 220  Throws exceptions (codes):
15:21:28 221  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28 222  */
15:21:28 223  	in_offer_chain_ids  IN VARCHAR2,
15:21:28 224  	in_eligibility_name IN VARCHAR2,
15:21:28 225  	out_result_set	    OUT SYS_REFCURSOR
15:21:28 226  );
15:21:28 227  
15:21:28 228  PROCEDURE GET_OFFER_CHAIN_META_DATA (
15:21:28 229  /*
15:21:28 230  Throws exceptions (codes):
15:21:28 231  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28 232  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28 233  */
15:21:28 234  	in_offer_chain_id IN NUMBER,
15:21:28 235  	in_meta_data_name IN VARCHAR2,
15:21:28 236  	out_result_set	  OUT SYS_REFCURSOR
15:21:28 237  );
15:21:28 238  
15:21:28 239  PROCEDURE GET_OFFER_CHAINS_META_DATA (
15:21:28 240  /*
15:21:28 241  Throws exceptions (codes):
15:21:28 242  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28 243  */
15:21:28 244  	in_offer_chain_ids IN VARCHAR2,
15:21:28 245  	in_meta_data_name  IN VARCHAR2,
15:21:28 246  	out_result_set	   OUT SYS_REFCURSOR
15:21:28 247  );
15:21:28 248  
15:21:28 249  PROCEDURE GET_PROD_OFFERINGS_BY_OFFER_ID (
15:21:28 250  /*
15:21:28 251  Throws exceptions (codes):
15:21:28 252  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28 253  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28 254  */
15:21:28 255  	in_offer_id    IN NUMBER,
15:21:28 256  	out_result_set OUT SYS_REFCURSOR
15:21:28 257  );
15:21:28 258  
15:21:28 259  PROCEDURE GET_PRODUCT_OFFERING_META_DATA (
15:21:28 260  /*
15:21:28 261  Throws exceptions (codes):
15:21:28 262  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28 263  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28 264  */
15:21:28 265  	in_product_offering_id IN NUMBER,
15:21:28 266  	in_meta_data_name      IN VARCHAR2 DEFAULT NULL,
15:21:28 267  	out_result_set	       OUT SYS_REFCURSOR
15:21:28 268  );
15:21:28 269  
15:21:28 270  PROCEDURE GET_OFF_CHAINS_SAME_PRODUCTS (
15:21:28 271  /*
15:21:28 272  Throws exceptions (codes):
15:21:28 273  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28 274  */
15:21:28 275  	in_offer_chain_1 IN NUMBER,
15:21:28 276  	in_offer_chain_2 IN NUMBER,
15:21:28 277  	out_result_set	OUT SYS_REFCURSOR
15:21:28 278  );
15:21:28 279  
15:21:28 280  PROCEDURE GET_OFFER_CHAIN_MD_VALUE (
15:21:28 281  	in_offer_chain_id IN NUMBER,
15:21:28 282  	in_meta_data_name IN VARCHAR2,
15:21:28 283  	out_value	  OUT VARCHAR2
15:21:28 284  );
15:21:28 285  
15:21:28 286  PROCEDURE GET_OFFER_CHAIN_EL_VALUE (
15:21:28 287  	in_offer_chain_id   IN NUMBER,
15:21:28 288  	in_eligibility_name IN VARCHAR2,
15:21:28 289  	out_value	    OUT VARCHAR2
15:21:28 290  );
15:21:28 291  
15:21:28 292  PROCEDURE GET_OFFER_PRODUCT_OFFERINGS (
15:21:28 293  	in_offer_id    IN NUMBER,
15:21:28 294  	out_result_set OUT SYS_REFCURSOR
15:21:28 295  );
15:21:28 296  
15:21:28 297  PROCEDURE GET_OFFER_CHAINS_BY_META_DATA (
15:21:28 298  	in_meta_data_name  IN VARCHAR2,
15:21:28 299  	in_meta_data_value IN VARCHAR2,
15:21:28 300  	out_result_set	   OUT SYS_REFCURSOR
15:21:28 301  );
15:21:28 302  
15:21:28 303  PROCEDURE GET_ALL_META_DATA (
15:21:28 304  	in_offer_chain_id IN NUMBER,
15:21:28 305  	out_result_set	  OUT SYS_REFCURSOR
15:21:28 306  );
15:21:28 307  
15:21:28 308  PROCEDURE CHECK_PRODUCT_ELIGIBILITY (
15:21:28 309  	in_group_id	  IN NUMBER,
15:21:28 310  	in_offer_chain_id IN NUMBER,
15:21:28 311  	out_is_eligible   OUT NUMBER,
15:21:28 312  	out_concurrent_subscription_id OUT NUMBER
15:21:28 313  );
15:21:28 314  
15:21:28 315  PROCEDURE GET_NOTIFICATION_TYPE_ID (
15:21:28 316  	in_offer_chain_id	 IN NUMBER,
15:21:28 317  	in_action_name		 IN VARCHAR2,
15:21:28 318  	out_notification_type_id OUT NUMBER
15:21:28 319  );
15:21:28 320  
15:21:28 321  END PROCS_OFFER_CHAIN_V18;
15:21:28 322  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.04
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE 		  "PROCS_POLLING_SYNC"
15:21:28   2  AS
15:21:28   3  
15:21:28   4  ----
15:21:28   5  --------------------------------------------------------------------------------
15:21:28   6  ----
15:21:28   7  	  /* Call the Gather Events on a timer. Pass in the timestamp
15:21:28   8  	      returned from the previous call and store the result for the
15:21:28   9  	      next call.
15:21:28  10  	     This method will identify and create new Sync Events from trigger activity data */
15:21:28  11  	  procedure GATHER_SYNC_EVENTS(in_last_timestamp timestamp, out_new_timestamp out timestamp);
15:21:28  12  ----
15:21:28  13  --------------------------------------------------------------------------------
15:21:28  14  ----
15:21:28  15  	  /* Internal logic call may need to be used to fix poller data */
15:21:28  16  	  procedure GATHER_SYNC_EVENTS_RANGE(in_start_ts timestamp, in_end_ts timestamp, in_offset number);
15:21:28  17  ----
15:21:28  18  --------------------------------------------------------------------------------
15:21:28  19  ----
15:21:28  20  	  /* User request for sync events. Params should be hard-coded in the application
15:21:28  21  	      layer. Unconfirmed transfer sets will be resent up to maximum before being
15:21:28  22  	      skipped. Last read time is logged.
15:21:28  23  	     Params:
15:21:28  24  		  set_maximum: Size of each transfer set
15:21:28  25  		  max_retries: Number of times to resend unconfirmed sets before skipping
15:21:28  26  	     Returns:
15:21:28  27  		  set_id: Transfer set id, duplicated for all entries
15:21:28  28  		  group_id: regi_id value
15:21:28  29  		  event_type: Financial (I)nstrument, (S)ubscription, (G)ift Cert
15:21:28  30  	  */
15:21:28  31  	  procedure GET_TRANSFER_SET(in_set_maximum number, in_max_retries number, out_refcursor out sys_refcursor);
15:21:28  32  ----
15:21:28  33  --------------------------------------------------------------------------------
15:21:28  34  ----
15:21:28  35  	  /* Confirmation from user of receipt of sync transfer set. Will only allow a
15:21:28  36  	      single confirmation per transfer set.
15:21:28  37  	  */
15:21:28  38  	  procedure CONFIRM_TRANSFER_SET(in_set_id core_owner.polling_sync.set_id%type);
15:21:28  39  ----
15:21:28  40  --------------------------------------------------------------------------------
15:21:28  41  ----
15:21:28  42  	  procedure SET_LAST_RUN(ts in timestamp);
15:21:28  43  	  procedure GET_LAST_RUN(ts out timestamp);
15:21:28  44  END PROCS_POLLING_SYNC;
15:21:28  45  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.08
15:21:28 SQL> 
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> -- DDL for package PROCS_PROCESS_RETRY_THROTTLE
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE "PROCS_PROCESS_RETRY_V18" AS
15:21:28   2  
15:21:28   3  PROCEDURE LOG_RETRY(
15:21:28   4  	  in_process_name IN VARCHAR2,
15:21:28   5  	  in_generic_id   IN NUMBER,
15:21:28   6  	  in_date	  IN VARCHAR2,
15:21:28   7  	  out_success	   OUT NUMBER
15:21:28   8  );
15:21:28   9  
15:21:28  10  PROCEDURE LOG_RETRY_DATE(
15:21:28  11  	  in_process_name IN VARCHAR2,
15:21:28  12  	  in_generic_id   IN NUMBER,
15:21:28  13  	  in_date	  IN DATE,
15:21:28  14  	  out_success	   OUT NUMBER
15:21:28  15  );
15:21:28  16  
15:21:28  17  PROCEDURE DELETE_RETRY(
15:21:28  18  	  in_process_name IN VARCHAR2,
15:21:28  19  	  in_remove_minutes  IN NUMBER
15:21:28  20  );
15:21:28  21  
15:21:28  22  PROCEDURE GET_SYSDATE (
15:21:28  23  	  out_date OUT VARCHAR2
15:21:28  24  );
15:21:28  25  
15:21:28  26  END PROCS_PROCESS_RETRY_V18;
15:21:28  27  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.02
15:21:28 SQL> 
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> -- DDL for package PROCS_PRODUCT
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE "PROCS_PRODUCT_V18" AS
15:21:28   2  
15:21:28   3  PROCEDURE GET_PRODUCTS (
15:21:28   4  /*
15:21:28   5  Throws exceptions:
15:21:28   6  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28   7  */
15:21:28   8  	in_status_id   IN  NUMBER,
15:21:28   9  	out_result_set OUT SYS_REFCURSOR
15:21:28  10  );
15:21:28  11  
15:21:28  12  PROCEDURE GET_PRODUCT_OFFERING_META_DATA (
15:21:28  13  /*
15:21:28  14  Throws exceptions:
15:21:28  15  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  16  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  17  */
15:21:28  18  	in_product_offering_id	IN NUMBER,
15:21:28  19  	out_result_set OUT SYS_REFCURSOR
15:21:28  20  );
15:21:28  21  
15:21:28  22  PROCEDURE GET_PRODUCT_ELIGIBIL_BY_NAME (
15:21:28  23  /*
15:21:28  24  Throws exceptions:
15:21:28  25  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:28  26  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:28  27  */
15:21:28  28  	in_product_id	    IN NUMBER,
15:21:28  29  	in_eligibility_name IN VARCHAR2 DEFAULT NULL,
15:21:28  30  	out_result_set	    OUT SYS_REFCURSOR
15:21:28  31  );
15:21:28  32  
15:21:28  33  PROCEDURE GET_PRODUCT_BY_ID (
15:21:28  34  	in_product_id  IN NUMBER,
15:21:28  35  	out_result_set OUT SYS_REFCURSOR
15:21:28  36  );
15:21:28  37  
15:21:28  38  PROCEDURE GET_PRD_OFFERING_BY_LINE_IT_ID (
15:21:28  39  	in_line_item_id IN NUMBER,
15:21:28  40  	out_result_set	OUT SYS_REFCURSOR
15:21:28  41  );
15:21:28  42  
15:21:28  43  PROCEDURE GET_PRD_OFFERING_BY_ID (
15:21:28  44  	in_product_offering_id IN NUMBER,
15:21:28  45  	out_result_set	OUT SYS_REFCURSOR
15:21:28  46  );
15:21:28  47  
15:21:28  48  PROCEDURE GET_PRODUCT_OFFERING_DISCOUNTS(
15:21:28  49  	in_product_offering_id IN NUMBER,
15:21:28  50  	out_result_set	       OUT SYS_REFCURSOR
15:21:28  51  );
15:21:28  52  
15:21:28  53  END PROCS_PRODUCT_V18;
15:21:28  54  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.03
15:21:28 SQL> 
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> -- DDL for package PROCS_RECONCILIATION_CRU
15:21:28 SQL> --------------------------------------------------------------------------------
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE "PROCS_RECONCILIATION_CRU_V18" AS
15:21:28   2  
15:21:28   3  PROCEDURE CREATE_CPT_CHARGEBACK_ACT (
15:21:28   4  	out_cpt_chargeback_act_id   OUT RCN_CPT_CHARGEBACK_ACT_DETAIL.ID%TYPE,
15:21:28   5  	in_cpt_chargeback_act_id    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.ID%TYPE DEFAULT NULL,
15:21:28   6  	in_ext_source_log_id	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.RCN_EXT_SOURCE_LOG_ID%TYPE,
15:21:28   7  	in_record_type		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.RECORD_TYPE%TYPE,
15:21:28   8  	in_entity_type		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.ENTITY_TYPE%TYPE,
15:21:28   9  	in_entity_number	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.ENTITY_NUMBER%TYPE,
15:21:28  10  	in_chargeback_amount_issuer IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CHARGEBACK_AMOUNT_ISSUER%TYPE,
15:21:28  11  	in_prev_partial_repres	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.PREV_PARTIAL_REPRESENTMENT%TYPE,
15:21:28  12  	in_presentment_currency     IN RCN_CPT_CHARGEBACK_ACT_DETAIL.PRESENTMENT_CURRENCY%TYPE,
15:21:28  13  	in_chargeback_category	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CHARGEBACK_CATEGORY%TYPE,
15:21:28  14  	in_status_flag		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.STATUS_FLAG%TYPE,
15:21:28  15  	in_sequence_number	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.SEQUENCE_NUMBER%TYPE,
15:21:28  16  	in_merchant_order_number    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.MERCHANT_ORDER_NUMBER%TYPE,
15:21:28  17  	in_account_number	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.ACCOUNT_NUMBER%TYPE,
15:21:28  18  	in_reason_code		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.REASON_CODE%TYPE,
15:21:28  19  	in_transaction_date	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.TRANSACTION_DATE%TYPE,
15:21:28  20  	in_chargeback_date	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CHARGEBACK_DATE%TYPE,
15:21:28  21  	in_activity_date	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.ACTIVITY_DATE%TYPE,
15:21:28  22  	in_chargeback_amount_action IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CHARGEBACK_AMOUNT_ACTION%TYPE,
15:21:28  23  	in_fee_amount		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.FEE_AMOUNT%TYPE,
15:21:28  24  	in_usage_code		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.USAGE_CODE%TYPE,
15:21:28  25  	in_mop_code		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.MOP_CODE%TYPE,
15:21:28  26  	in_authorization_date	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.AUTHORIZATION_DATE%TYPE,
15:21:28  27  	in_chargeback_due_date	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CHARGEBACK_DUE_DATE%TYPE,
15:21:28  28  	in_created_by		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CREATED_BY%TYPE
15:21:28  29  );
15:21:28  30  
15:21:28  31  PROCEDURE CREATE_EXT_SOURCE_LOG (
15:21:28  32  	out_ext_source_log_id	    OUT RCN_EXT_SOURCE_LOG.ID%TYPE,
15:21:28  33  	in_ext_source_log_id	    IN RCN_EXT_SOURCE_LOG.ID%TYPE DEFAULT NULL,
15:21:28  34  	in_extraction_timestamp     IN RCN_EXT_SOURCE_LOG.EXTRACTION_TIMESTAMP%TYPE,
15:21:28  35  	in_report_date		    IN RCN_EXT_SOURCE_LOG.REPORT_DATE%TYPE,
15:21:28  36  	in_report_gen_datetime	    IN RCN_EXT_SOURCE_LOG.REPORT_GENERATION_DATETIME%TYPE,
15:21:28  37  	in_record_type		    IN RCN_EXT_SOURCE_LOG.RECORD_TYPE%TYPE,
15:21:28  38  	in_report_file_name	    IN RCN_EXT_SOURCE_LOG.REPORT_FILE_NAME%TYPE,
15:21:28  39  	in_created_by		    IN RCN_EXT_SOURCE_LOG.CREATED_BY%TYPE
15:21:28  40  );
15:21:28  41  
15:21:28  42  PROCEDURE CREATE_CPT_SERVICE_CHARGE (
15:21:28  43  	out_cpt_service_charge_id   OUT RCN_CPT_SERVICE_CHARGE_DETAIL.ID%TYPE,
15:21:28  44  	in_cpt_service_charge_id    IN RCN_CPT_SERVICE_CHARGE_DETAIL.ID%TYPE DEFAULT NULL,
15:21:28  45  	in_ext_source_log_id	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.RCN_EXT_SOURCE_LOG_ID%TYPE,
15:21:28  46  	in_record_type		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.RECORD_TYPE%TYPE,
15:21:28  47  	in_category		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.CATEGORY%TYPE,
15:21:28  48  	in_sub_category 	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.SUB_CATEGORY%TYPE,
15:21:28  49  	in_entity_type		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.ENTITY_TYPE%TYPE,
15:21:28  50  	in_entity_number	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.ENTITY_NUMBER%TYPE,
15:21:28  51  	in_funds_trans_inst_number  IN RCN_CPT_SERVICE_CHARGE_DETAIL.FUNDS_TRANSFER_INST_NUMBER%TYPE,
15:21:28  52  	in_secure_ba_number	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.SECURE_BA_NUMBER%TYPE,
15:21:28  53  	in_settlement_currency	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.SETTLEMENT_CURRENCY%TYPE,
15:21:28  54  	in_fee_schedule 	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.FEE_SCHEDULE%TYPE,
15:21:28  55  	in_mop			    IN RCN_CPT_SERVICE_CHARGE_DETAIL.MOP%TYPE,
15:21:28  56  	in_interchange_qual	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.INTERCHANGE_QUALIFICATION%TYPE,
15:21:28  57  	in_fee_type_description     IN RCN_CPT_SERVICE_CHARGE_DETAIL.FEE_TYPE_DESCRIPTION%TYPE,
15:21:28  58  	in_action_type		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.ACTION_TYPE%TYPE,
15:21:28  59  	in_unit_quantity	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.UNIT_QUANTITY%TYPE,
15:21:28  60  	in_unit_fee		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.UNIT_FEE%TYPE,
15:21:28  61  	in_amount		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.AMOUNT%TYPE,
15:21:28  62  	in_percentage_rate	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.PERCENTAGE_RATE%TYPE,
15:21:28  63  	in_total_charge 	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.TOTAL_CHARGE%TYPE,
15:21:28  64  	in_created_by		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.CREATED_BY%TYPE
15:21:28  65  );
15:21:28  66  
15:21:28  67  PROCEDURE CREATE_CPT_EXCEPTION (
15:21:28  68  	out_cpt_exception_id	 OUT RCN_CPT_EXCEPTION_DETAIL.ID%TYPE,
15:21:28  69  	in_cpt_exception_id	 IN RCN_CPT_EXCEPTION_DETAIL.ID%TYPE DEFAULT NULL,
15:21:28  70  	in_ext_source_log_id	 IN RCN_CPT_EXCEPTION_DETAIL.RCN_EXT_SOURCE_LOG_ID%TYPE,
15:21:28  71  	in_record_type		 IN RCN_CPT_EXCEPTION_DETAIL.RECORD_TYPE%TYPE,
15:21:28  72  	in_submission_date	 IN RCN_CPT_EXCEPTION_DETAIL.SUBMISSION_DATE%TYPE,
15:21:28  73  	in_pid_number		 IN RCN_CPT_EXCEPTION_DETAIL.PID_NUMBER%TYPE,
15:21:28  74  	in_pid_short_name	 IN RCN_CPT_EXCEPTION_DETAIL.PID_SHORT_NAME%TYPE,
15:21:28  75  	in_submission_number	 IN RCN_CPT_EXCEPTION_DETAIL.SUBMISSION_NUMBER%TYPE,
15:21:28  76  	in_record_number	 IN RCN_CPT_EXCEPTION_DETAIL.RECORD_NUMBER%TYPE,
15:21:28  77  	in_entity_type		 IN RCN_CPT_EXCEPTION_DETAIL.ENTITY_TYPE%TYPE,
15:21:28  78  	in_entity_number	 IN RCN_CPT_EXCEPTION_DETAIL.ENTITY_NUMBER%TYPE,
15:21:28  79  	in_presentment_currency  IN RCN_CPT_EXCEPTION_DETAIL.PRESENTMENT_CURRENCY%TYPE,
15:21:28  80  	in_merchant_order_number IN RCN_CPT_EXCEPTION_DETAIL.MERCHANT_ORDER_NUMBER%TYPE,
15:21:28  81  	in_rdfi_number		 IN RCN_CPT_EXCEPTION_DETAIL.RDFI_NUMBER%TYPE,
15:21:28  82  	in_account_number	 IN RCN_CPT_EXCEPTION_DETAIL.ACCOUNT_NUMBER%TYPE,
15:21:28  83  	in_expiration_date	 IN RCN_CPT_EXCEPTION_DETAIL.EXPIRATION_DATE%TYPE,
15:21:28  84  	in_amount		 IN RCN_CPT_EXCEPTION_DETAIL.AMOUNT%TYPE,
15:21:28  85  	in_mop			 IN RCN_CPT_EXCEPTION_DETAIL.MOP%TYPE,
15:21:28  86  	in_action_code		 IN RCN_CPT_EXCEPTION_DETAIL.ACTION_CODE%TYPE,
15:21:28  87  	in_auth_date		 IN RCN_CPT_EXCEPTION_DETAIL.AUTH_DATE%TYPE,
15:21:28  88  	in_auth_code		 IN RCN_CPT_EXCEPTION_DETAIL.AUTH_CODE%TYPE,
15:21:28  89  	in_auth_response_code	 IN RCN_CPT_EXCEPTION_DETAIL.AUTH_RESPONSE_CODE%TYPE,
15:21:28  90  	in_trace_number 	 IN RCN_CPT_EXCEPTION_DETAIL.TRACE_NUMBER%TYPE,
15:21:28  91  	in_consumer_country_code IN RCN_CPT_EXCEPTION_DETAIL.CONSUMER_COUNTRY_CODE%TYPE,
15:21:28  92  	in_category		 IN RCN_CPT_EXCEPTION_DETAIL.CATEGORY%TYPE,
15:21:28  93  	in_mcc			 IN RCN_CPT_EXCEPTION_DETAIL.MCC%TYPE,
15:21:28  94  	in_reject_code		 IN RCN_CPT_EXCEPTION_DETAIL.REJECT_CODE%TYPE,
15:21:28  95  	in_submission_status	 IN RCN_CPT_EXCEPTION_DETAIL.SUBMISSION_STATUS%TYPE,
15:21:28  96  	in_created_by		 IN RCN_CPT_EXCEPTION_DETAIL.CREATED_BY%TYPE
15:21:28  97  );
15:21:28  98  
15:21:28  99  PROCEDURE CREATE_CPT_DEPOSIT (
15:21:28 100  	out_cpt_deposit_id	  OUT RCN_CPT_DEPOSIT_DETAIL.ID%TYPE,
15:21:28 101  	in_cpt_deposit_id	  IN RCN_CPT_DEPOSIT_DETAIL.ID%TYPE DEFAULT NULL,
15:21:28 102  	in_ext_source_log_id	  IN RCN_CPT_DEPOSIT_DETAIL.RCN_EXT_SOURCE_LOG_ID%TYPE,
15:21:28 103  	in_record_type		  IN RCN_CPT_DEPOSIT_DETAIL.RECORD_TYPE%TYPE,
15:21:28 104  	in_submission_date	  IN RCN_CPT_DEPOSIT_DETAIL.SUBMISSION_DATE%TYPE,
15:21:28 105  	in_pid_number		  IN RCN_CPT_DEPOSIT_DETAIL.PID_NUMBER%TYPE,
15:21:28 106  	in_pid_short_name	  IN RCN_CPT_DEPOSIT_DETAIL.PID_SHORT_NAME%TYPE,
15:21:28 107  	in_submission_number	  IN RCN_CPT_DEPOSIT_DETAIL.SUBMISSION_NUMBER%TYPE,
15:21:28 108  	in_record_number	  IN RCN_CPT_DEPOSIT_DETAIL.RECORD_NUMBER%TYPE,
15:21:28 109  	in_entity_type		  IN RCN_CPT_DEPOSIT_DETAIL.ENTITY_TYPE%TYPE,
15:21:28 110  	in_entity_number	  IN RCN_CPT_DEPOSIT_DETAIL.ENTITY_NUMBER%TYPE,
15:21:28 111  	in_presentment_currency   IN RCN_CPT_DEPOSIT_DETAIL.PRESENTMENT_CURRENCY%TYPE,
15:21:28 112  	in_merchant_order_number  IN RCN_CPT_DEPOSIT_DETAIL.MERCHANT_ORDER_NUMBER%TYPE,
15:21:28 113  	in_rdfi_number		  IN RCN_CPT_DEPOSIT_DETAIL.RDFI_NUMBER%TYPE,
15:21:28 114  	in_account_number	  IN RCN_CPT_DEPOSIT_DETAIL.ACCOUNT_NUMBER%TYPE,
15:21:28 115  	in_expiration_date	  IN RCN_CPT_DEPOSIT_DETAIL.EXPIRATION_DATE%TYPE,
15:21:28 116  	in_amount		  IN RCN_CPT_DEPOSIT_DETAIL.AMOUNT%TYPE,
15:21:28 117  	in_mop			  IN RCN_CPT_DEPOSIT_DETAIL.MOP%TYPE,
15:21:28 118  	in_action_code		  IN RCN_CPT_DEPOSIT_DETAIL.ACTION_CODE%TYPE,
15:21:28 119  	in_auth_date		  IN RCN_CPT_DEPOSIT_DETAIL.AUTH_DATE%TYPE,
15:21:28 120  	in_auth_code		  IN RCN_CPT_DEPOSIT_DETAIL.AUTH_CODE%TYPE,
15:21:28 121  	in_auth_response_code	  IN RCN_CPT_DEPOSIT_DETAIL.AUTH_RESPONSE_CODE%TYPE,
15:21:28 122  	in_trace_number 	  IN RCN_CPT_DEPOSIT_DETAIL.TRACE_NUMBER%TYPE,
15:21:28 123  	in_consumer_country_code  IN RCN_CPT_DEPOSIT_DETAIL.CONSUMER_COUNTRY_CODE%TYPE,
15:21:28 124  	in_mcc			  IN RCN_CPT_DEPOSIT_DETAIL.MCC%TYPE,
15:21:28 125  	in_fee_code		  IN RCN_CPT_DEPOSIT_DETAIL.FEE_CODE%TYPE,
15:21:28 126  	in_unit_fee		  IN RCN_CPT_DEPOSIT_DETAIL.UNIT_FEE%TYPE,
15:21:28 127  	in_percent_fee		  IN RCN_CPT_DEPOSIT_DETAIL.PERCENT_FEE%TYPE,
15:21:28 128  	in_total_interchange_fee  IN RCN_CPT_DEPOSIT_DETAIL.TOTAL_INTERCHANGE_FEE%TYPE,
15:21:28 129  	in_total_assessment_fee   IN RCN_CPT_DEPOSIT_DETAIL.TOTAL_ASSESSMENT_FEE%TYPE,
15:21:28 130  	in_other_fee		  IN RCN_CPT_DEPOSIT_DETAIL.OTHER_FEE%TYPE,
15:21:28 131  	in_created_by		  IN RCN_CPT_DEPOSIT_DETAIL.CREATED_BY%TYPE
15:21:28 132  );
15:21:28 133  
15:21:28 134  PROCEDURE CREATE_PP_SETTLEMENT (
15:21:28 135  	out_pp_settlement_id	   OUT RCN_PP_SETTLEMENT.ID%TYPE,
15:21:28 136  	in_pp_settlement_id	   IN RCN_PP_SETTLEMENT.ID%TYPE DEFAULT NULL,
15:21:28 137  	in_ext_source_log_id	   IN RCN_PP_SETTLEMENT.RCN_EXT_SOURCE_LOG_ID%TYPE,
15:21:28 138  	in_transaction_id	   IN RCN_PP_SETTLEMENT.TRANSACTION_ID%TYPE,
15:21:28 139  	in_invoice_id		   IN RCN_PP_SETTLEMENT.INVOICE_ID%TYPE,
15:21:28 140  	in_pp_ref_id		   IN RCN_PP_SETTLEMENT.PP_REF_ID%TYPE,
15:21:28 141  	in_pp_ref_id_type	   IN RCN_PP_SETTLEMENT.PP_REF_ID_TYPE%TYPE,
15:21:28 142  	in_trans_event_code	   IN RCN_PP_SETTLEMENT.TRANS_EVENT_CODE%TYPE,
15:21:28 143  	in_trans_init_date	   IN RCN_PP_SETTLEMENT.TRANS_INIT_DATE%TYPE,
15:21:28 144  	in_trans_comp_date	   IN RCN_PP_SETTLEMENT.TRANS_COMP_DATE%TYPE,
15:21:28 145  	in_trans_deb_or_cred	   IN RCN_PP_SETTLEMENT.TRANS_DEB_OR_CRED%TYPE,
15:21:28 146  	in_gross_trans_amount	   IN RCN_PP_SETTLEMENT.GROSS_TRANS_AMOUNT%TYPE,
15:21:28 147  	in_gross_trans_currency    IN RCN_PP_SETTLEMENT.GROSS_TRANS_CURRENCY%TYPE,
15:21:28 148  	in_fee_deb_or_cred	   IN RCN_PP_SETTLEMENT.FEE_DEB_OR_CRED%TYPE,
15:21:28 149  	in_fee_amount		   IN RCN_PP_SETTLEMENT.FEE_AMOUNT%TYPE,
15:21:28 150  	in_fee_currency 	   IN RCN_PP_SETTLEMENT.FEE_CURRENCY%TYPE,
15:21:28 151  	in_custom_field 	   IN RCN_PP_SETTLEMENT.CUSTOM_FIELD%TYPE,
15:21:28 152  	in_created_by		   IN RCN_PP_SETTLEMENT.CREATED_BY%TYPE
15:21:28 153  );
15:21:28 154  
15:21:28 155  PROCEDURE CREATE_PP_DISPUTE (
15:21:28 156  	out_pp_dispute_id	     OUT RCN_PP_DISPUTE.ID%TYPE,
15:21:28 157  	in_pp_dispute_id	     IN RCN_PP_DISPUTE.ID%TYPE DEFAULT NULL,
15:21:28 158  	in_ext_source_log_id	     IN RCN_PP_DISPUTE.RCN_EXT_SOURCE_LOG_ID%TYPE,
15:21:28 159  	in_dispute_type 	     IN RCN_PP_DISPUTE.DISPUTE_TYPE%TYPE,
15:21:28 160  	in_claimant_name	     IN RCN_PP_DISPUTE.CLAIMANT_NAME%TYPE,
15:21:28 161  	in_claimant_email	     IN RCN_PP_DISPUTE.CLAIMANT_EMAIL%TYPE,
15:21:28 162  	in_transaction_id	     IN RCN_PP_DISPUTE.TRANSACTION_ID%TYPE,
15:21:28 163  	in_trans_date		     IN RCN_PP_DISPUTE.TRANS_DATE%TYPE,
15:21:28 164  	in_disputed_amount	     IN RCN_PP_DISPUTE.DISPUTED_AMOUNT%TYPE,
15:21:28 165  	in_disputed_amount_currency  IN RCN_PP_DISPUTE.DISPUTED_AMOUNT_CURRENCY%TYPE,
15:21:28 166  	in_dispute_reason	     IN RCN_PP_DISPUTE.DISPUTE_REASON%TYPE,
15:21:28 167  	in_dispute_filing_date	     IN RCN_PP_DISPUTE.DISPUTE_FILING_DATE%TYPE,
15:21:28 168  	in_dispute_status	     IN RCN_PP_DISPUTE.DISPUTE_STATUS%TYPE,
15:21:28 169  	in_dispute_case_id	     IN RCN_PP_DISPUTE.DISPUTE_CASE_ID%TYPE,
15:21:28 170  	in_invoice_id		     IN RCN_PP_DISPUTE.INVOICE_ID%TYPE,
15:21:28 171  	in_created_by		     IN RCN_PP_DISPUTE.CREATED_BY%TYPE
15:21:28 172  );
15:21:28 173  
15:21:28 174  PROCEDURE CREATE_PP_TRANS_DETAIL (
15:21:28 175  	out_pp_trans_detail_id	     OUT RCN_PP_TRANS_DETAIL.ID%TYPE,
15:21:28 176  	in_pp_trans_detail_id	     IN RCN_PP_TRANS_DETAIL.ID%TYPE DEFAULT NULL,
15:21:28 177  	in_ext_source_log_id	     IN RCN_PP_TRANS_DETAIL.RCN_EXT_SOURCE_LOG_ID%TYPE,
15:21:28 178  	in_invoice_id		     IN RCN_PP_TRANS_DETAIL.INVOICE_ID%TYPE,
15:21:28 179  	in_transaction_id	     IN RCN_PP_TRANS_DETAIL.TRANSACTION_ID%TYPE,
15:21:28 180  	in_pp_ref_id		     IN RCN_PP_TRANS_DETAIL.PP_REF_ID%TYPE,
15:21:28 181  	in_trans_deb_or_cred	     IN RCN_PP_TRANS_DETAIL.TRANS_DEB_OR_CRED%TYPE,
15:21:28 182  	in_trans_init_date	     IN RCN_PP_TRANS_DETAIL.TRANS_INIT_DATE%TYPE,
15:21:28 183  	in_trans_comp_date	     IN RCN_PP_TRANS_DETAIL.TRANS_COMP_DATE%TYPE,
15:21:28 184  	in_gross_trans_amount	     IN RCN_PP_TRANS_DETAIL.GROSS_TRANS_AMOUNT%TYPE,
15:21:28 185  	in_gross_trans_currency      IN RCN_PP_TRANS_DETAIL.GROSS_TRANS_CURRENCY%TYPE,
15:21:28 186  	in_fee_amount		     IN RCN_PP_TRANS_DETAIL.FEE_AMOUNT%TYPE,
15:21:28 187  	in_fee_currency 	     IN RCN_PP_TRANS_DETAIL.FEE_CURRENCY%TYPE,
15:21:28 188  	in_fee_deb_or_cred	     IN RCN_PP_TRANS_DETAIL.FEE_DEB_OR_CRED%TYPE,
15:21:28 189  	in_trans_event_code	     IN RCN_PP_TRANS_DETAIL.TRANS_EVENT_CODE%TYPE,
15:21:28 190  	in_trans_status 	     IN RCN_PP_TRANS_DETAIL.TRANS_STATUS%TYPE,
15:21:28 191  	in_insurance_amount	     IN RCN_PP_TRANS_DETAIL.INSURANCE_AMOUNT%TYPE,
15:21:28 192  	in_sales_tax_amount	     IN RCN_PP_TRANS_DETAIL.SALES_TAX_AMOUNT%TYPE,
15:21:28 193  	in_shipping_amount	     IN RCN_PP_TRANS_DETAIL.SHIPPING_AMOUNT%TYPE,
15:21:28 194  	in_trans_subject	     IN RCN_PP_TRANS_DETAIL.TRANS_SUBJECT%TYPE,
15:21:28 195  	in_trans_note		     IN RCN_PP_TRANS_DETAIL.TRANS_NOTE%TYPE,
15:21:28 196  	in_payer_acct_id	     IN RCN_PP_TRANS_DETAIL.PAYER_ACCT_ID%TYPE,
15:21:28 197  	in_payer_addr_status	     IN RCN_PP_TRANS_DETAIL.PAYER_ADDR_STATUS%TYPE,
15:21:28 198  	in_item_name		     IN RCN_PP_TRANS_DETAIL.ITEM_NAME%TYPE,
15:21:28 199  	in_item_id		     IN RCN_PP_TRANS_DETAIL.ITEM_ID%TYPE,
15:21:28 200  	in_option_1_name	     IN RCN_PP_TRANS_DETAIL.OPTION_1_NAME%TYPE,
15:21:28 201  	in_option_1_value	     IN RCN_PP_TRANS_DETAIL.OPTION_1_VALUE%TYPE,
15:21:28 202  	in_option_2_name	     IN RCN_PP_TRANS_DETAIL.OPTION_2_NAME%TYPE,
15:21:28 203  	in_option_2_value	     IN RCN_PP_TRANS_DETAIL.OPTION_2_VALUE%TYPE,
15:21:28 204  	in_auction_site 	     IN RCN_PP_TRANS_DETAIL.AUCTION_SITE%TYPE,
15:21:28 205  	in_auction_buyer_id	     IN RCN_PP_TRANS_DETAIL.AUCTION_BUYER_ID%TYPE,
15:21:28 206  	in_auction_closing_date      IN RCN_PP_TRANS_DETAIL.AUCTION_CLOSING_DATE%TYPE,
15:21:28 207  	in_shipping_addr_line_1      IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_LINE_1%TYPE,
15:21:28 208  	in_shipping_addr_line_2      IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_LINE_2%TYPE,
15:21:28 209  	in_shipping_addr_city	     IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_CITY%TYPE,
15:21:28 210  	in_shipping_addr_state	     IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_STATE%TYPE,
15:21:28 211  	in_shipping_addr_zip	     IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_ZIP%TYPE,
15:21:28 212  	in_shipping_addr_country     IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_COUNTRY%TYPE,
15:21:28 213  	in_custom_field 	     IN RCN_PP_TRANS_DETAIL.CUSTOM_FIELD%TYPE,
15:21:28 214  	in_created_by		     IN RCN_PP_TRANS_DETAIL.CREATED_BY%TYPE
15:21:28 215  );
15:21:28 216  
15:21:28 217  PROCEDURE GET_EXT_SOURCE_LOG (
15:21:28 218  	in_record_type		 IN RCN_EXT_SOURCE_LOG.RECORD_TYPE%TYPE,
15:21:28 219  	in_report_file_name	 IN RCN_EXT_SOURCE_LOG.REPORT_FILE_NAME%TYPE,
15:21:28 220  	out_result_set		 OUT SYS_REFCURSOR
15:21:28 221  );
15:21:28 222  
15:21:28 223  FUNCTION CHECK_EXT_SOURCE_LOG (
15:21:28 224  	in_record_type		 IN RCN_EXT_SOURCE_LOG.RECORD_TYPE%TYPE,
15:21:28 225  	in_report_file_name	 IN RCN_EXT_SOURCE_LOG.REPORT_FILE_NAME%TYPE
15:21:28 226  ) RETURN NUMBER;
15:21:28 227  
15:21:28 228  PROCEDURE CREATE_AMEX_CHARGEBACK (
15:21:28 229  	  in_rcn_ext_source_log_id IN RCN_EXT_SOURCE_LOG.ID%TYPE,
15:21:28 230  	  in_resolution IN RCN_AMEX_CHARGEBACK.RESOLUTION%TYPE,
15:21:28 231  	  in_from_system IN RCN_AMEX_CHARGEBACK.FROM_SYSTEM%TYPE,
15:21:28 232  	  in_rejects_to_system IN RCN_AMEX_CHARGEBACK.REJECTS_TO_SYSTEM%TYPE,
15:21:28 233  	  in_disputes_to_system IN RCN_AMEX_CHARGEBACK.DISPUTES_TO_SYSTEM%TYPE,
15:21:28 234  	  in_date_of_adjustment IN RCN_AMEX_CHARGEBACK.DATE_OF_ADJUSTMENT%TYPE,
15:21:28 235  	  in_date_of_charge IN RCN_AMEX_CHARGEBACK.DATE_OF_CHARGE%TYPE,
15:21:28 236  	  in_case_type IN RCN_AMEX_CHARGEBACK.CASE_TYPE%TYPE,
15:21:28 237  	  in_cb_reas_code IN RCN_AMEX_CHARGEBACK.CB_REAS_CODE%TYPE,
15:21:28 238  	  in_cb_amount IN RCN_AMEX_CHARGEBACK.CB_AMOUNT%TYPE,
15:21:28 239  	  in_cb_adjustment_number IN RCN_AMEX_CHARGEBACK.CB_ADJUSTMENT_NUMBER%TYPE,
15:21:28 240  	  in_billed_amount IN RCN_AMEX_CHARGEBACK.BILLED_AMOUNT%TYPE,
15:21:28 241  	  in_soc_amount IN RCN_AMEX_CHARGEBACK.SOC_AMOUNT%TYPE,
15:21:28 242  	  in_foreign_amount IN RCN_AMEX_CHARGEBACK.FOREIGN_AMOUNT%TYPE,
15:21:28 243  	  in_currency IN RCN_AMEX_CHARGEBACK.CURRENCY%TYPE,
15:21:28 244  	  in_note1 IN RCN_AMEX_CHARGEBACK.NOTE1%TYPE,
15:21:28 245  	  in_note2 IN RCN_AMEX_CHARGEBACK.NOTE2%TYPE,
15:21:28 246  	  in_note3 IN RCN_AMEX_CHARGEBACK.NOTE3%TYPE,
15:21:28 247  	  in_note4 IN RCN_AMEX_CHARGEBACK.NOTE4%TYPE,
15:21:28 248  	  in_note5 IN RCN_AMEX_CHARGEBACK.NOTE5%TYPE,
15:21:28 249  	  in_note6 IN RCN_AMEX_CHARGEBACK.NOTE6%TYPE,
15:21:28 250  	  in_note7 IN RCN_AMEX_CHARGEBACK.NOTE7%TYPE,
15:21:28 251  	  in_ind_ref_number IN RCN_AMEX_CHARGEBACK.IND_REF_NUMBER%TYPE,
15:21:28 252  	  in_created_by IN RCN_AMEX_CHARGEBACK.CREATED_BY%TYPE
15:21:28 253  );
15:21:28 254  
15:21:28 255  END PROCS_RECONCILIATION_CRU_V18;
15:21:28 256  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.07
15:21:28 SQL> 
15:21:28 SQL> CREATE OR REPLACE PACKAGE "CORE_OWNER"."PROCS_REPORTING" AS
15:21:28   2  
15:21:28   3  ----
15:21:28   4  --------------------------------------------------------------------------------
15:21:28   5  ----
15:21:28   6  	  procedure ext_charge(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28   7  ----
15:21:28   8  --------------------------------------------------------------------------------
15:21:28   9  ----
15:21:28  10  	  procedure ext_license(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28  11  ----
15:21:28  12  --------------------------------------------------------------------------------
15:21:28  13  ----
15:21:28  14  	  procedure ext_invoice(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28  15  ----
15:21:28  16  --------------------------------------------------------------------------------
15:21:28  17  ----
15:21:28  18  	  procedure ext_line_item(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28  19  ----
15:21:28  20  --------------------------------------------------------------------------------
15:21:28  21  ----
15:21:28  22  	  procedure ext_account(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28  23  ----
15:21:28  24  --------------------------------------------------------------------------------
15:21:28  25  ----
15:21:28  26  	  procedure ext_subscription(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28  27  ----
15:21:28  28  --------------------------------------------------------------------------------
15:21:28  29  ----
15:21:28  30  	  procedure ext_transaction(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28  31  ----
15:21:28  32  --------------------------------------------------------------------------------
15:21:28  33  ----
15:21:28  34  	  procedure ext_offer_chain(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28  35  ----
15:21:28  36  --------------------------------------------------------------------------------
15:21:28  37  ----
15:21:28  38  	  procedure ext_offer_offer_chain(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28  39  ----
15:21:28  40  --------------------------------------------------------------------------------
15:21:28  41  ----
15:21:28  42  	  procedure ext_offer(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28  43  ----
15:21:28  44  --------------------------------------------------------------------------------
15:21:28  45  ----
15:21:28  46  	  procedure ext_gift_certificate(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28  47  ----
15:21:28  48  --------------------------------------------------------------------------------
15:21:28  49  ----
15:21:28  50  	  procedure ext_product_offering(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28  51  ----
15:21:28  52  --------------------------------------------------------------------------------
15:21:28  53  ----
15:21:28  54  	  procedure ext_product(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28  55  ----
15:21:28  56  --------------------------------------------------------------------------------
15:21:28  57  ----
15:21:28  58  	  procedure ext_offer_product_offering(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28  59  ----
15:21:28  60  --------------------------------------------------------------------------------
15:21:28  61  ----
15:21:28  62  	  procedure ext_discount_product_offering(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28  63  ----
15:21:28  64  --------------------------------------------------------------------------------
15:21:28  65  ----
15:21:28  66  	  procedure ext_discount(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28  67  ----
15:21:28  68  --------------------------------------------------------------------------------
15:21:28  69  ----
15:21:28  70  	  procedure ext_offer_chain_metadata(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28  71  ----
15:21:28  72  --------------------------------------------------------------------------------
15:21:28  73  ----
15:21:28  74  	  procedure ext_product_offering_metadata(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28  75  ----
15:21:28  76  --------------------------------------------------------------------------------
15:21:28  77  ----
15:21:28  78  	  procedure ext_subscription_metadata(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28  79  ----
15:21:28  80  --------------------------------------------------------------------------------
15:21:28  81  ----
15:21:28  82  	  procedure ext_credit_card(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28  83  ----
15:21:28  84  --------------------------------------------------------------------------------
15:21:28  85  ----
15:21:28  86  	  procedure ext_transaction_attempt(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28  87  ----
15:21:28  88  --------------------------------------------------------------------------------
15:21:28  89  ----
15:21:28  90  	  procedure ext_invoice_adjustment(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28  91  ----
15:21:28  92  --------------------------------------------------------------------------------
15:21:28  93  ----
15:21:28  94  	  procedure ext_line_item_adjustment(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28  95  ----
15:21:28  96  --------------------------------------------------------------------------------
15:21:28  97  ----
15:21:28  98  	  procedure ext_product_eligibility(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28  99  ----
15:21:28 100  --------------------------------------------------------------------------------
15:21:28 101  ----
15:21:28 102  	  procedure ext_offer_chain_eligibility(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28 103  ----
15:21:28 104  --------------------------------------------------------------------------------
15:21:28 105  ----
15:21:28 106  	  procedure ext_tax(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28 107  ----
15:21:28 108  --------------------------------------------------------------------------------
15:21:28 109  ----
15:21:28 110  	  procedure ext_tax_adjustment(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28 111  ----
15:21:28 112  --------------------------------------------------------------------------------
15:21:28 113  ----
15:21:28 114  /**/
15:21:28 115  	  procedure ext_rcn_ext_source_log(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28 116  ----
15:21:28 117  --------------------------------------------------------------------------------
15:21:28 118  ----
15:21:28 119  	  procedure ext_rcn_cpt_svc_chg_dtl(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28 120  ----
15:21:28 121  --------------------------------------------------------------------------------
15:21:28 122  ----
15:21:28 123  	  procedure ext_rcn_cpt_excpt_dtl(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28 124  ----
15:21:28 125  --------------------------------------------------------------------------------
15:21:28 126  ----
15:21:28 127  	  procedure ext_rcn_cpt_dpst_dtl(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28 128  ----
15:21:28 129  --------------------------------------------------------------------------------
15:21:28 130  ----
15:21:28 131  	  procedure ext_rcn_cpt_chgbk_act_dtl(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28 132  ----
15:21:28 133  --------------------------------------------------------------------------------
15:21:28 134  ----
15:21:28 135  	  procedure ext_rcn_pp_sttlmnt(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28 136  ----
15:21:28 137  --------------------------------------------------------------------------------
15:21:28 138  ----
15:21:28 139  	  procedure ext_rcn_pp_dispute(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28 140  ----
15:21:28 141  --------------------------------------------------------------------------------
15:21:28 142  ----
15:21:28 143  	  procedure ext_rcn_pp_trns_dtl(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28 144  ----
15:21:28 145  --------------------------------------------------------------------------------
15:21:28 146  ----
15:21:28 147  	  procedure ext_rcn_amex_chargeback(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28 148  ----
15:21:28 149  --------------------------------------------------------------------------------
15:21:28 150  ----
15:21:28 151  	  procedure ext_paypal(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28 152  ----
15:21:28 153  --------------------------------------------------------------------------------
15:21:28 154  ----
15:21:28 155  	  procedure ext_address(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
15:21:28 156  ----
15:21:28 157  --------------------------------------------------------------------------------
15:21:28 158  ----
15:21:28 159  /**/
15:21:28 160  END PROCS_REPORTING;
15:21:28 161  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.06
15:21:28 SQL> 
15:21:28 SQL> prompt Compiling Package PROCS_REPORTING_1A
Compiling Package PROCS_REPORTING_1A
15:21:28 SQL> 
15:21:28 SQL> whenever sqlerror exit failure
15:21:28 SQL> 
15:21:28 SQL> create or replace PACKAGE 	     "PROCS_REPORTING_1A" AS
15:21:28   2  
15:21:28   3  ----
15:21:28   4  --------------------------------------------------------------------------------
15:21:28   5  ----
15:21:28   6  	  function getDiscountAmount(in_line_item_id line_item.id%type)
15:21:28   7  	      return line_item.amount%type;
15:21:28   8  ----
15:21:28   9  --------------------------------------------------------------------------------
15:21:28  10  ----
15:21:28  11  	  function getRefundAmount(in_line_item_id line_item.id%type)
15:21:28  12  	      return line_item.amount%type;
15:21:28  13  ----
15:21:28  14  --------------------------------------------------------------------------------
15:21:28  15  ----
15:21:28  16  	  PROCEDURE EXTRACT_LINE_ITEMS(
15:21:28  17  	      in_lower_date_bound DATE,
15:21:28  18  	      in_upper_date_bound DATE,
15:21:28  19  	      out_lic_cur OUT sys_refcursor
15:21:28  20  	  );
15:21:28  21  ----
15:21:28  22  --------------------------------------------------------------------------------
15:21:28  23  ----
15:21:28  24  END PROCS_REPORTING_1A;
15:21:28  25  .
15:21:28 SQL> /

Package created.

Elapsed: 00:00:00.04
15:21:29 SQL> 
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> -- DDL for package PROCS_REPORTS
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE "PROCS_REPORTS_V5" AS
15:21:29   2  
15:21:29   3  FUNCTION GET_PRODUCT_NAMES(
15:21:29   4  	in_offer_id IN NUMBER
15:21:29   5  ) RETURN VARCHAR2;
15:21:29   6  
15:21:29   7  PROCEDURE GET_FULL_FLASH_REPORT_PURCH (
15:21:29   8  	in_start_date  IN DATE,
15:21:29   9  	in_end_date    IN DATE,
15:21:29  10  	out_result_set OUT SYS_REFCURSOR
15:21:29  11  );
15:21:29  12  
15:21:29  13  PROCEDURE GET_FLASH_REPORT_PURCHASES (
15:21:29  14  	in_offer_id	       IN NUMBER,
15:21:29  15  	in_start_date	       IN DATE,
15:21:29  16  	in_end_date	       IN DATE,
15:21:29  17  	out_new_purchasers_num OUT NUMBER,
15:21:29  18  	out_renewals_num       OUT NUMBER,
15:21:29  19  	out_product_names      OUT VARCHAR2,
15:21:29  20  	out_total_dollar_value OUT NUMBER,
15:21:29  21  	out_unique_purchasers  OUT NUMBER
15:21:29  22  );
15:21:29  23  
15:21:29  24  /*
15:21:29  25  FUNCTIONS FOR THE FLASH REPORT
15:21:29  26  */
15:21:29  27  
15:21:29  28  FUNCTION FLR_NEW_PURCHASERS_NUM (
15:21:29  29  	in_offer_id	       IN NUMBER,
15:21:29  30  	in_start_date	       IN DATE,
15:21:29  31  	in_end_date	       IN DATE
15:21:29  32  ) RETURN NUMBER;
15:21:29  33  
15:21:29  34  FUNCTION FLR_RENEWALS_NUM (
15:21:29  35  	in_offer_id	       IN NUMBER,
15:21:29  36  	in_start_date	       IN DATE,
15:21:29  37  	in_end_date	       IN DATE
15:21:29  38  ) RETURN NUMBER;
15:21:29  39  
15:21:29  40  FUNCTION FLR_TOTAL_DOLLAR_VALUE (
15:21:29  41  	in_offer_id	       IN NUMBER,
15:21:29  42  	in_start_date	       IN DATE,
15:21:29  43  	in_end_date	       IN DATE
15:21:29  44  ) RETURN NUMBER;
15:21:29  45  
15:21:29  46  FUNCTION FLR_UNIQUE_PURCHASERS (
15:21:29  47  	in_offer_id	       IN NUMBER,
15:21:29  48  	in_start_date	       IN DATE,
15:21:29  49  	in_end_date	       IN DATE
15:21:29  50  ) RETURN NUMBER;
15:21:29  51  
15:21:29  52  END PROCS_REPORTS_V5;
15:21:29  53  .
15:21:29 SQL> /

Package created.

Elapsed: 00:00:00.06
15:21:29 SQL> 
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> -- DDL for package PROCS_SUBSCRIPTION
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE "PROCS_SUBSCRIPTION_V18" AS
15:21:29   2  
15:21:29   3  PROCEDURE START_GRACE_BY_INVOICE_ID(
15:21:29   4  	in_invoice_id	     IN LICENSE.INVOICE_ID%TYPE,
15:21:29   5  	in_updater	     IN VARCHAR2,
15:21:29   6  	in_duration_in_hours IN NUMBER
15:21:29   7  );
15:21:29   8  
15:21:29   9  PROCEDURE STOP_GRACE_BY_INVOICE_ID(
15:21:29  10  	in_invoice_id IN LICENSE.INVOICE_ID%TYPE,
15:21:29  11  	in_updater    IN VARCHAR2
15:21:29  12  );
15:21:29  13  
15:21:29  14  PROCEDURE START_SUBSCRIPTION_CREATION (
15:21:29  15  	in_group_id	      IN NUMBER,
15:21:29  16  	in_created_by	      IN VARCHAR2,
15:21:29  17  	in_offer_chain_id     IN NUMBER,
15:21:29  18  	in_instrument_type_id IN NUMBER,
15:21:29  19  	in_instrument_id      IN NUMBER,
15:21:29  20  	in_agent_id	      IN NUMBER,
15:21:29  21  	in_note 	      IN VARCHAR2,
15:21:29  22  	out_subscription_id   OUT NUMBER,
15:21:29  23  	out_invoice_id	      OUT NUMBER,
15:21:29  24  	out_new_license_id    OUT NUMBER,
15:21:29  25  	in_check_dupe_products	 IN NUMBER DEFAULT GLOBAL_CONSTANTS_V18.TRUE
15:21:29  26  );
15:21:29  27  
15:21:29  28  PROCEDURE FINALIZE_SUBSCRIPTION_CREATION (
15:21:29  29  	in_subscription_id    IN NUMBER,
15:21:29  30  	in_invoice_id	      IN NUMBER,
15:21:29  31  	in_instrument_type_id IN NUMBER,
15:21:29  32  	in_instrument_id      IN NUMBER,
15:21:29  33  	in_created_by	      IN VARCHAR2
15:21:29  34  );
15:21:29  35  
15:21:29  36  PROCEDURE SUSPEND_SUBSCRIPTION(
15:21:29  37  /*
15:21:29  38  Throws exceptions:
15:21:29  39  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29  40  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:29  41  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  42  */
15:21:29  43  	  in_subs_id	IN NUMBER ,
15:21:29  44  	  in_updated_by IN VARCHAR2
15:21:29  45  );
15:21:29  46  
15:21:29  47  PROCEDURE REACTIVATE_SUBSCRIPTION (
15:21:29  48  	in_subscription_id IN  NUMBER,
15:21:29  49  	in_updated_by	   IN  VARCHAR2
15:21:29  50  );
15:21:29  51  
15:21:29  52  PROCEDURE GET_SUBSCRIPTION_INFO (
15:21:29  53  /*
15:21:29  54  Throws exceptions:
15:21:29  55  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  56  */
15:21:29  57  	  in_subscription_id IN  NUMBER,
15:21:29  58  	  out_result_set      OUT SYS_REFCURSOR
15:21:29  59  );
15:21:29  60  
15:21:29  61  PROCEDURE GET_SUBSCRIPTION_INVOICES (
15:21:29  62  /*
15:21:29  63  Throws exceptions:
15:21:29  64  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:29  65  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  66  */
15:21:29  67  	in_subscription_id  IN	NUMBER,
15:21:29  68  	out_result_set	    OUT SYS_REFCURSOR
15:21:29  69  );
15:21:29  70  
15:21:29  71  PROCEDURE GET_SUBSCRIPTION_NOTES (
15:21:29  72  /*
15:21:29  73  Throws exceptions:
15:21:29  74  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  75  */
15:21:29  76  	in_subscription_id  IN	NUMBER,
15:21:29  77  	out_result_set	    OUT SYS_REFCURSOR
15:21:29  78  );
15:21:29  79  
15:21:29  80  PROCEDURE ANNOTATE_SUBSCRIPTION (
15:21:29  81  /*
15:21:29  82  Throws exceptions:
15:21:29  83  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:29  84  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  85  */
15:21:29  86  	in_subscription_id IN  NUMBER,
15:21:29  87  	in_agent_id	   IN  NUMBER,
15:21:29  88  	in_note 	   IN  VARCHAR2,
15:21:29  89  	in_created_by	   IN  VARCHAR2
15:21:29  90  );
15:21:29  91  
15:21:29  92  PROCEDURE GET_CANCEL_REASONS (
15:21:29  93  	out_result_set OUT    SYS_REFCURSOR
15:21:29  94  );
15:21:29  95  
15:21:29  96  FUNCTION GET_RENEWAL_DATE (
15:21:29  97  /*
15:21:29  98  Throws exceptions:
15:21:29  99  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 100  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 101  */
15:21:29 102  	in_subscription_id in NUMBER
15:21:29 103  ) RETURN DATE;
15:21:29 104  
15:21:29 105  FUNCTION GET_RECENT_CHARGE (
15:21:29 106  /*
15:21:29 107  Throws exceptions:
15:21:29 108  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 109  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 110  */
15:21:29 111  	in_subscription_id IN NUMBER
15:21:29 112  ) RETURN NUMBER;
15:21:29 113  
15:21:29 114  FUNCTION GET_BILLING_CYCLE (
15:21:29 115  /*
15:21:29 116  Throws exceptions:
15:21:29 117  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 118  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 119  */
15:21:29 120  	in_subscription_id IN NUMBER
15:21:29 121  ) RETURN VARCHAR2;
15:21:29 122  
15:21:29 123  PROCEDURE REFUND_SUBSCRIPTION (
15:21:29 124  /*
15:21:29 125  Throws exceptions:
15:21:29 126  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 127  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 128  */
15:21:29 129  	in_subscription_id IN NUMBER,
15:21:29 130  	in_invoice_id	   IN NUMBER,
15:21:29 131  	in_refund_amount   IN NUMBER,
15:21:29 132  	in_note 	   IN VARCHAR2,
15:21:29 133  	in_created_by	   IN VARCHAR2,
15:21:29 134  	out_charge_id	   OUT NUMBER
15:21:29 135  );
15:21:29 136  
15:21:29 137  PROCEDURE ADD_SUBSCRIPTION_EXTENSION (
15:21:29 138  /*
15:21:29 139  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 140  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:29 141  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 142  */
15:21:29 143  	in_subscription_id	IN NUMBER,
15:21:29 144  	in_effective_start_date IN DATE,
15:21:29 145  	in_effective_end_date	IN DATE,
15:21:29 146  	in_note 		IN VARCHAR2,
15:21:29 147  	in_updated_by		IN VARCHAR2
15:21:29 148  );
15:21:29 149  
15:21:29 150  FUNCTION CALC_SUBSCRIPTION_END_DATE (
15:21:29 151  /*
15:21:29 152  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 153  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:29 154  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 155  Returns:
15:21:29 156  NULL if it is impossible to calculate end date (for example,
15:21:29 157  	offer chain includes offer with infinity recurrences number)
15:21:29 158  DATE else
15:21:29 159  */
15:21:29 160  	in_subscription_id IN NUMBER
15:21:29 161  ) RETURN DATE;
15:21:29 162  
15:21:29 163  PROCEDURE HAS_FUTURE_LICENSE (
15:21:29 164  /*
15:21:29 165  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 166  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 167  */
15:21:29 168  	in_license_id IN  NUMBER,
15:21:29 169  	out_result    OUT NUMBER
15:21:29 170  );
15:21:29 171  
15:21:29 172  PROCEDURE CLOSE_SUBSCRIPTION (
15:21:29 173  	in_subscription_id IN NUMBER,
15:21:29 174  	in_updated_by	   IN VARCHAR2
15:21:29 175  );
15:21:29 176  
15:21:29 177  PROCEDURE GET_GROUP_ID_BY_SBSCRPTN_ID (
15:21:29 178  	in_subscription_id IN NUMBER,
15:21:29 179  	out_group_id	   OUT NUMBER
15:21:29 180  );
15:21:29 181  
15:21:29 182  PROCEDURE GET_SUBSCRIPTION_PRODUCTS (
15:21:29 183  /*
15:21:29 184  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 185  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 186  */
15:21:29 187  	in_subscription_id IN NUMBER,
15:21:29 188  	out_result_set	   OUT SYS_REFCURSOR
15:21:29 189  );
15:21:29 190  
15:21:29 191  PROCEDURE UPDATE_SUBSCRIPTION_STATUS (
15:21:29 192  /*
15:21:29 193  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 194  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 195  */
15:21:29 196  	in_subscription_id	  IN SUBSCRIPTION.ID%TYPE,
15:21:29 197  	in_subscription_status_id IN SUBSCRIPTION.SUBSCRIPTION_STATUS_ID%TYPE,
15:21:29 198  	in_updated_by		  IN SUBSCRIPTION.UPDATED_BY%TYPE
15:21:29 199  );
15:21:29 200  
15:21:29 201  PROCEDURE GET_ACTIVE_INVOICES_IDS (
15:21:29 202  /*
15:21:29 203  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 204  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 205  */
15:21:29 206  --  in_subscription_id IN SUBSCRIPTION.ID%TYPE,
15:21:29 207  	in_subscription_id IN NUMBER,
15:21:29 208  	out_result_set	   OUT SYS_REFCURSOR
15:21:29 209  );
15:21:29 210  
15:21:29 211  PROCEDURE CANCEL_SUBSCRIPTION_INVOICE (
15:21:29 212  /*
15:21:29 213  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 214  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 215  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:29 216  */
15:21:29 217  	in_invoice_id	     IN NUMBER,
15:21:29 218  	in_updated_by	     IN VARCHAR2,
15:21:29 219  	in_refundable	     IN NUMBER DEFAULT GLOBAL_CONSTANTS_V18.FALSE
15:21:29 220  );
15:21:29 221  
15:21:29 222  PROCEDURE FINALIZE_CANCELATION (
15:21:29 223  /*
15:21:29 224  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 225  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 226  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:29 227  */
15:21:29 228  --  in_subscription_id	IN SUBSCRIPTION.ID%TYPE,
15:21:29 229  --  in_cancelation_reason IN SUBSCRIPTION_CANCEL_REASON.VALUE%TYPE,
15:21:29 230  --  in_cancelation_date	IN SUBSCRIPTION.CANCELLATION_DATE%TYPE,
15:21:29 231  --  in_note		IN SUBSCRIPTION_NOTE.NOTE%TYPE,
15:21:29 232  --  in_agent_id		IN SUBSCRIPTION_NOTE.AGENT_ID%TYPE,
15:21:29 233  --  in_updated_by 	IN SUBSCRIPTION.UPDATED_BY%TYPE
15:21:29 234  	in_subscription_id    IN NUMBER,
15:21:29 235  	in_cancelation_reason IN VARCHAR2,
15:21:29 236  	in_cancelation_date   IN DATE,
15:21:29 237  	in_note 	      IN VARCHAR2,
15:21:29 238  	in_agent_id	      IN NUMBER,
15:21:29 239  	in_updated_by	      IN VARCHAR2
15:21:29 240  );
15:21:29 241  
15:21:29 242  PROCEDURE FINALIZE_FALSE_START (
15:21:29 243  /*
15:21:29 244  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 245  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 246  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:29 247  */
15:21:29 248  --  in_subscription_id	IN SUBSCRIPTION.ID%TYPE,
15:21:29 249  --  in_cancelation_date	IN SUBSCRIPTION.CANCELLATION_DATE%TYPE,
15:21:29 250  --  in_note		IN SUBSCRIPTION_NOTE.NOTE%TYPE,
15:21:29 251  --  in_agent_id		IN SUBSCRIPTION_NOTE.AGENT_ID%TYPE,
15:21:29 252  --  in_updated_by 	IN SUBSCRIPTION.UPDATED_BY%TYPE
15:21:29 253  	in_subscription_id    IN NUMBER,
15:21:29 254  	in_cancelation_date   IN DATE,
15:21:29 255  	in_note 	      IN VARCHAR2,
15:21:29 256  	in_agent_id	      IN NUMBER,
15:21:29 257  	in_updated_by	      IN VARCHAR2
15:21:29 258  );
15:21:29 259  
15:21:29 260  FUNCTION IS_SUBSCRIPTION_CANCELABLE (
15:21:29 261  	in_subscription_id IN NUMBER
15:21:29 262  ) RETURN NUMBER;
15:21:29 263  
15:21:29 264  PROCEDURE GET_SUBSCR_PROD_OFFERRINGS (
15:21:29 265  /*
15:21:29 266  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 267  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 268  */
15:21:29 269  	in_subscription_id IN NUMBER,
15:21:29 270  	out_result_set	   OUT SYS_REFCURSOR
15:21:29 271  );
15:21:29 272  
15:21:29 273  PROCEDURE RETRIEVE_SUB_PROD_OFFER (
15:21:29 274  /*
15:21:29 275  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 276  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 277  */
15:21:29 278  	in_subscription_id IN NUMBER,
15:21:29 279  	out_result_set	   OUT SYS_REFCURSOR
15:21:29 280  );
15:21:29 281  
15:21:29 282  PROCEDURE GET_SUBSCR_LIC_OFFER (
15:21:29 283  /*
15:21:29 284  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 285  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 286  */
15:21:29 287  	in_subscription_id IN NUMBER,
15:21:29 288  	out_result_set	   OUT SYS_REFCURSOR
15:21:29 289  );
15:21:29 290  
15:21:29 291  PROCEDURE ARE_REFUNDS_PENDING_FOR_SUBSCR (
15:21:29 292  /*
15:21:29 293  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 294  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 295  */
15:21:29 296  	in_subscription_id IN NUMBER,
15:21:29 297  	out_result	   OUT NUMBER
15:21:29 298  );
15:21:29 299  
15:21:29 300  PROCEDURE GET_EXISTING_SUBSCR_NUMBER (
15:21:29 301  /*
15:21:29 302  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 303  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 304  */
15:21:29 305  	in_group_id	   IN NUMBER,
15:21:29 306  	in_offer_chain_id  IN NUMBER,
15:21:29 307  	out_result	   out number
15:21:29 308  );
15:21:29 309  
15:21:29 310  PROCEDURE GET_EXISTING_SUBSCR_IDS (
15:21:29 311  /*
15:21:29 312  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 313  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 314  */
15:21:29 315  	in_group_id	   IN NUMBER,
15:21:29 316  	in_offer_chain_id  IN NUMBER,
15:21:29 317  	out_result_set	   OUT SYS_REFCURSOR
15:21:29 318  );
15:21:29 319  
15:21:29 320  PROCEDURE ADD_META_DATA (
15:21:29 321  /*
15:21:29 322  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 323  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 324  */
15:21:29 325  	in_subscription_id IN NUMBER,
15:21:29 326  	in_name 	   IN VARCHAR2,
15:21:29 327  	in_value	   IN VARCHAR2,
15:21:29 328  	in_created_by	   IN VARCHAR2
15:21:29 329  );
15:21:29 330  
15:21:29 331  PROCEDURE GET_SUBSCRIPTIONS_META_DATA (
15:21:29 332  /*
15:21:29 333  APP_EXCEPTION_CODES_V18.INVALID_PARAMETER
15:21:29 334  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 335  */
15:21:29 336  	in_subscriptions_ids IN core_owner.NUMBER_TABLE,
15:21:29 337  	out_result_set	     OUT SYS_REFCURSOR
15:21:29 338  );
15:21:29 339  
15:21:29 340  PROCEDURE GET_SUBS_BY_TRNS_ORDER_ID (
15:21:29 341  /*
15:21:29 342  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 343  */
15:21:29 344  	in_order_id	   IN TRANSACTION.ORDER_ID%TYPE,
15:21:29 345  	out_result_set	   OUT SYS_REFCURSOR
15:21:29 346  );
15:21:29 347  
15:21:29 348  PROCEDURE GET_OPEN_CHARGES_BY_SUBID
15:21:29 349   (
15:21:29 350  /*
15:21:29 351  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 352  */
15:21:29 353  	in_subscription_id  IN SUBSCRIPTION.ID%TYPE,
15:21:29 354  	out_result_set	    OUT SYS_REFCURSOR
15:21:29 355  );
15:21:29 356  
15:21:29 357  FUNCTION GET_GIFT_CERT_ID_BY_SUB_ID (
15:21:29 358  	in_subscription_id IN SUBSCRIPTION.ID%TYPE
15:21:29 359  ) RETURN NUMBER;
15:21:29 360  
15:21:29 361  FUNCTION GET_GIFT_CERT_CODE_BY_SUB_ID (
15:21:29 362  	in_subscription_id IN SUBSCRIPTION.ID%TYPE
15:21:29 363  ) RETURN VARCHAR2;
15:21:29 364  
15:21:29 365  
15:21:29 366  
15:21:29 367  PROCEDURE GET_ACTIVE_MEU_SUBS (
15:21:29 368  	out_result_set	    OUT SYS_REFCURSOR
15:21:29 369  );
15:21:29 370  
15:21:29 371  PROCEDURE GET_EARLIEST_ACTIVE_OFFER_ID (
15:21:29 372  	in_subscription_id  IN SUBSCRIPTION.ID%TYPE,
15:21:29 373  	out_offer_id	    OUT LICENSE.ID%TYPE
15:21:29 374  );
15:21:29 375  
15:21:29 376  PROCEDURE GET_EARLIEST_ACTIVE_LICENSE_ID (
15:21:29 377  	in_subscription_id  IN SUBSCRIPTION.ID%TYPE,
15:21:29 378  	out_license_id	    OUT LICENSE.ID%TYPE
15:21:29 379  );
15:21:29 380  
15:21:29 381  PROCEDURE GET_ACT_SUBS_W_CPT_CHARGEBACKS (
15:21:29 382  	out_result_set	    OUT SYS_REFCURSOR
15:21:29 383  );
15:21:29 384  
15:21:29 385  PROCEDURE GET_ACT_SUBS_W_PP_CHARGEBACKS (
15:21:29 386  	out_result_set	    OUT SYS_REFCURSOR
15:21:29 387  );
15:21:29 388  
15:21:29 389  PROCEDURE GET_ACT_SUBS_W_AMEX_CB (
15:21:29 390  	out_result_set	    OUT SYS_REFCURSOR
15:21:29 391  );
15:21:29 392  
15:21:29 393  PROCEDURE GET_GRACE_PERIOD_SUB_REGIS (
15:21:29 394  	in_max_days_until_close IN NUMBER,
15:21:29 395  	in_num_subs_to_fetch	IN NUMBER,
15:21:29 396  	out_result_set		OUT SYS_REFCURSOR
15:21:29 397  );
15:21:29 398  
15:21:29 399  
15:21:29 400  END PROCS_SUBSCRIPTION_V18;
15:21:29 401  .
15:21:29 SQL> /

Package created.

Elapsed: 00:00:00.06
15:21:29 SQL> 
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> -- DDL for package PROCS_SUBSCRIPTION_CRU
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE "PROCS_SUBSCRIPTION_CRU_V18" AS
15:21:29   2  
15:21:29   3  PROCEDURE CREATE_SUBSCRIPTION(
15:21:29   4  	out_subscription_id	     OUT SUBSCRIPTION.ID%TYPE,
15:21:29   5  	in_subscription_id	     IN SUBSCRIPTION.ID%TYPE DEFAULT NULL,
15:21:29   6  	in_suspend_date 	     IN SUBSCRIPTION.SUSPEND_DATE%TYPE DEFAULT NULL,
15:21:29   7  	in_account_id		     IN SUBSCRIPTION.ACCOUNT_ID%TYPE,
15:21:29   8  	in_purchase_date	     IN SUBSCRIPTION.PURCHASE_DATE%TYPE,
15:21:29   9  	in_offer_chain_id	     IN SUBSCRIPTION.OFFER_CHAIN_ID%TYPE,
15:21:29  10  	in_termination_date	     IN SUBSCRIPTION.TERMINATION_DATE%TYPE DEFAULT NULL,
15:21:29  11  	in_days_remainning_ajustment IN SUBSCRIPTION.DAYS_REMAINING_ADJUSTMENT%TYPE DEFAULT NULL,
15:21:29  12  	in_sct_id		     IN SUBSCRIPTION.SCT_ID%TYPE DEFAULT NULL,
15:21:29  13  	in_created_by		     IN SUBSCRIPTION.CREATED_BY%TYPE,
15:21:29  14  	in_instrument_type_id	     IN SUBSCRIPTION.INSTRUMENT_TYPE_ID%TYPE,
15:21:29  15  	in_instrument_id	     IN SUBSCRIPTION.INSTRUMENT_ID%TYPE,
15:21:29  16  	in_subscription_status_id    IN SUBSCRIPTION.SUBSCRIPTION_STATUS_ID%TYPE,
15:21:29  17  	in_cancelation_date	     IN SUBSCRIPTION.CANCELLATION_DATE%TYPE DEFAULT NULL,
15:21:29  18  	in_reactivation_date	     IN SUBSCRIPTION.REACTIVATION_DATE%TYPE DEFAULT NULL
15:21:29  19  );
15:21:29  20  
15:21:29  21  PROCEDURE UPDATE_SUBSCRIPTION(
15:21:29  22  	in_subscription_id	     IN SUBSCRIPTION.ID%TYPE,
15:21:29  23  	in_suspend_date 	     IN SUBSCRIPTION.SUSPEND_DATE%TYPE DEFAULT NULL,
15:21:29  24  	in_purchase_date	     IN SUBSCRIPTION.PURCHASE_DATE%TYPE DEFAULT NULL,
15:21:29  25  	in_termination_date	     IN SUBSCRIPTION.TERMINATION_DATE%TYPE DEFAULT NULL,
15:21:29  26  	in_days_remainning_ajustment IN SUBSCRIPTION.DAYS_REMAINING_ADJUSTMENT%TYPE DEFAULT NULL,
15:21:29  27  	in_sct_id		     IN SUBSCRIPTION.SCT_ID%TYPE DEFAULT NULL,
15:21:29  28  	in_updated_by		     IN SUBSCRIPTION.CREATED_BY%TYPE DEFAULT NULL,
15:21:29  29  	in_instrument_type_id	     IN SUBSCRIPTION.INSTRUMENT_TYPE_ID%TYPE DEFAULT NULL,
15:21:29  30  	in_instrument_id	     IN SUBSCRIPTION.INSTRUMENT_ID%TYPE DEFAULT NULL,
15:21:29  31  	in_subscription_status_id    IN SUBSCRIPTION.SUBSCRIPTION_STATUS_ID%TYPE DEFAULT NULL,
15:21:29  32  	in_cancelation_date	     IN SUBSCRIPTION.CANCELLATION_DATE%TYPE DEFAULT NULL,
15:21:29  33  	in_reactivation_date	     IN SUBSCRIPTION.REACTIVATION_DATE%TYPE DEFAULT NULL
15:21:29  34  );
15:21:29  35  
15:21:29  36  PROCEDURE CREATE_SUBSCRIPTION_NOTE (
15:21:29  37  	inout_subscription_note_id IN OUT SUBSCRIPTION_NOTE.ID%TYPE,
15:21:29  38  	in_agent_id		   IN SUBSCRIPTION_NOTE.AGENT_ID%TYPE,
15:21:29  39  	in_subscription_id	   IN SUBSCRIPTION_NOTE.ID%TYPE,
15:21:29  40  	in_note 		   IN SUBSCRIPTION_NOTE.NOTE%TYPE,
15:21:29  41  	in_created_by		   IN SUBSCRIPTION_NOTE.CREATED_BY%TYPE
15:21:29  42  );
15:21:29  43  
15:21:29  44  END PROCS_SUBSCRIPTION_CRU_V18;
15:21:29  45  .
15:21:29 SQL> /

Package created.

Elapsed: 00:00:00.02
15:21:29 SQL> 
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> -- DDL for package PROCS_SYSTEM
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE "PROCS_SYSTEM_V18" AS
15:21:29   2  
15:21:29   3  PROCEDURE INCREMENT_VERSION;
15:21:29   4  
15:21:29   5  PROCEDURE CHECK_VERSION(
15:21:29   6  	  in_vers    IN NUMBER,
15:21:29   7  	  out_result OUT NUMBER
15:21:29   8  );
15:21:29   9  
15:21:29  10  END PROCS_SYSTEM_V18;
15:21:29  11  .
15:21:29 SQL> /

Package created.

Elapsed: 00:00:00.03
15:21:29 SQL> 
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> -- DDL for package PROCS_TAXES
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE "PROCS_TAXES_V18" AS
15:21:29   2  
15:21:29   3  PROCEDURE ADD_TAX (
15:21:29   4  	in_tax_type_id		 IN NUMBER,
15:21:29   5  	in_calculated_amount	 IN NUMBER,
15:21:29   6  	in_created_by		 IN VARCHAR2,
15:21:29   7  	in_line_item_id 	 IN NUMBER,
15:21:29   8  	in_effective_rate	 IN VARCHAR2,
15:21:29   9  	in_taxable_amount	 IN NUMBER,
15:21:29  10  	in_tax_rule_id		 IN NUMBER,
15:21:29  11  	in_jurisdiction_level_id IN NUMBER,
15:21:29  12  	in_jurisdiction_name	 IN VARCHAR2,
15:21:29  13  	in_jurisdiction_id	 IN VARCHAR2,
15:21:29  14  	in_ext_tax_type 	 IN VARCHAR2,
15:21:29  15  	in_ext_result		 IN VARCHAR2,
15:21:29  16  	in_imposition_type	 IN VARCHAR2,
15:21:29  17  	in_imposition		 IN VARCHAR2
15:21:29  18  );
15:21:29  19  
15:21:29  20  PROCEDURE CHECK_COUNTRY_FOR_EXCLUSION (
15:21:29  21  	in_country_code IN CHAR,
15:21:29  22  	in_check_date IN DATE,
15:21:29  23  	out_is_founded	OUT NUMBER -- GLOBAL_CONSTANT.TRUE of GLOBAL_CONSTANTS_V18.FALSE
15:21:29  24  );
15:21:29  25  
15:21:29  26  PROCEDURE GET_TAX_CATEGORY (
15:21:29  27  	in_tax_category_id IN NUMBER,
15:21:29  28  	out_result_set	   OUT SYS_REFCURSOR
15:21:29  29  );
15:21:29  30  
15:21:29  31  END PROCS_TAXES_V18;
15:21:29  32  .
15:21:29 SQL> /

Package created.

Elapsed: 00:00:00.03
15:21:29 SQL> 
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> -- DDL for package PROCS_TAXES_CRU
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE "PROCS_TAXES_CRU_V18" AS
15:21:29   2  
15:21:29   3  PROCEDURE CREATE_TAX (
15:21:29   4  	inout_tax_id		 IN OUT NUMBER,
15:21:29   5  	in_tax_type_id		 IN NUMBER,
15:21:29   6  	in_calculated_amount	 IN NUMBER,
15:21:29   7  	in_created_by		 IN VARCHAR2,
15:21:29   8  	in_line_item_id 	 IN NUMBER,
15:21:29   9  	in_effective_rate	 IN VARCHAR2,
15:21:29  10  	in_taxable_amount	 IN NUMBER,
15:21:29  11  	in_tax_rule_id		 IN NUMBER,
15:21:29  12  	in_jurisdiction_level_id IN NUMBER,
15:21:29  13  	in_jurisdiction_name	 IN VARCHAR2,
15:21:29  14  	in_jurisdiction_id	 IN VARCHAR2,
15:21:29  15  	in_ext_tax_type 	 IN VARCHAR2,
15:21:29  16  	in_ext_result		 IN VARCHAR2,
15:21:29  17  	in_imposition_type	 IN VARCHAR2,
15:21:29  18  	in_imposition		 IN VARCHAR2
15:21:29  19  );
15:21:29  20  
15:21:29  21  END PROCS_TAXES_CRU_V18;
15:21:29  22  .
15:21:29 SQL> /

Package created.

Elapsed: 00:00:00.03
15:21:29 SQL> 
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> -- DDL for package PROCS_TEST
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE "PROCS_TEST_V18" AS
15:21:29   2  
15:21:29   3  PROCEDURE TEST_CLEAR_ALL;
15:21:29   4  PROCEDURE TEST_CLEAR_PRODUCTS;
15:21:29   5  
15:21:29   6  /********************************************/
15:21:29   7  
15:21:29   8  PROCEDURE TEST_GET_ACCOUNT (
15:21:29   9  	in_group_id	IN NUMBER,
15:21:29  10  	out_result_set	OUT SYS_REFCURSOR
15:21:29  11  );
15:21:29  12  
15:21:29  13  /********************************************/
15:21:29  14  
15:21:29  15  PROCEDURE TEST_GET_SUBSCRIPTION (
15:21:29  16  	in_subscription_id IN NUMBER,
15:21:29  17  	out_result_set	   OUT SYS_REFCURSOR
15:21:29  18  );
15:21:29  19  
15:21:29  20  /*********************************************/
15:21:29  21  
15:21:29  22  PROCEDURE TEST_DELETE_INVOICE (
15:21:29  23  	in_invoice_id IN NUMBER
15:21:29  24  );
15:21:29  25  
15:21:29  26  PROCEDURE TEST_DELETE_USER_ACCOUNT (
15:21:29  27  	in_group_id IN NUMBER
15:21:29  28  );
15:21:29  29  
15:21:29  30  PROCEDURE TEST_DELETE_USER_ACCOUNTS  (
15:21:29  31  	in_start_group_id IN NUMBER,
15:21:29  32  	in_end_group_id   IN NUMBER
15:21:29  33  );
15:21:29  34  
15:21:29  35  /**********************************************/
15:21:29  36  
15:21:29  37  FUNCTION TEST_IS_INVOICE_EXISTS(
15:21:29  38  /*
15:21:29  39  1 - exists
15:21:29  40  0 - not exists
15:21:29  41  */
15:21:29  42  	in_invoice_id IN NUMBER
15:21:29  43  ) RETURN NUMBER;
15:21:29  44  
15:21:29  45  PROCEDURE TEST_GET_INVOICE_INFO (
15:21:29  46  	in_invoice_id  IN NUMBER,
15:21:29  47  	out_result_set OUT SYS_REFCURSOR
15:21:29  48  );
15:21:29  49  
15:21:29  50  /******************************************************************************/
15:21:29  51  
15:21:29  52  PROCEDURE TEST_DELETE_OFFER_CHAIN(
15:21:29  53  	in_offer_chain_id in number
15:21:29  54  );
15:21:29  55  
15:21:29  56  END PROCS_TEST_V18;
15:21:29  57  .
15:21:29 SQL> /

Package created.

Elapsed: 00:00:00.04
15:21:29 SQL> 
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> -- DDL for package PROCS_TRANSACTION
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE "PROCS_TRANSACTION_V18" AS
15:21:29   2  
15:21:29   3  PROCEDURE CREATE_TRANSACTION (
15:21:29   4  /*
15:21:29   5  Throws exceptions:
15:21:29   6  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29   7  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29   8  */
15:21:29   9  	in_transaction_id	  IN NUMBER,
15:21:29  10  	in_status_id		  IN NUMBER,
15:21:29  11  	in_amount		  IN NUMBER,
15:21:29  12  	in_created_by		  IN VARCHAR2,
15:21:29  13  	in_order_id		  IN VARCHAR2,
15:21:29  14  	in_is_refund		  IN NUMBER DEFAULT GLOBAL_CONSTANTS_V18.FALSE,
15:21:29  15  	in_transaction_type_code  IN VARCHAR2 DEFAULT NULL,
15:21:29  16  	out_transaction_id	  OUT NUMBER
15:21:29  17  );
15:21:29  18  
15:21:29  19  PROCEDURE CREATE_TRANSACTION_ATTEMPT (
15:21:29  20  /*
15:21:29  21  Throws exceptions:
15:21:29  22  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29  23  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  24  */
15:21:29  25  	in_transaction_id	   IN NUMBER,
15:21:29  26  	in_trans_attempt_status    IN NUMBER,
15:21:29  27  	in_external_status_code    IN VARCHAR2,
15:21:29  28  	in_external_status_message IN VARCHAR2,
15:21:29  29  	in_created_by		   IN VARCHAR2,
15:21:29  30  	in_ext_transaction_id	   IN VARCHAR2,
15:21:29  31  	out_transaction_attempt_id OUT NUMBER
15:21:29  32  );
15:21:29  33  
15:21:29  34  PROCEDURE UPDATE_TRANSACTION_STATUS (
15:21:29  35  /*
15:21:29  36  Throws exceptions:
15:21:29  37  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29  38  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  39  */
15:21:29  40  	in_transaction_id	 IN NUMBER,
15:21:29  41  	in_updated_by		 IN VARCHAR2,
15:21:29  42  	in_transaction_status_id IN NUMBER
15:21:29  43  );
15:21:29  44  
15:21:29  45  PROCEDURE UPDATE_TRANSACTION_SETTLED (
15:21:29  46  /*
15:21:29  47  Throws exceptions:
15:21:29  48  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29  49  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  50  */
15:21:29  51  	in_transaction_id	 IN NUMBER,
15:21:29  52  	in_updated_by		 IN VARCHAR2,
15:21:29  53  	in_is_settled		 IN NUMBER
15:21:29  54  );
15:21:29  55  
15:21:29  56  PROCEDURE UPDATE_TRNSCTN_ATTEMPT_TIME (
15:21:29  57  /*
15:21:29  58  Throws exceptions:
15:21:29  59  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29  60  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  61  */
15:21:29  62  	in_transaction_attempt_id IN NUMBER,
15:21:29  63  	in_updated_by		  IN VARCHAR2
15:21:29  64  );
15:21:29  65  
15:21:29  66  PROCEDURE UPDATE_TRNSCTN_ATTEMPT_STATUS (
15:21:29  67  /*
15:21:29  68  Throws exceptions:
15:21:29  69  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29  70  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  71  */
15:21:29  72  	in_transaction_attempt_id     IN NUMBER,
15:21:29  73  	in_transaction_attempt_status IN NUMBER
15:21:29  74  );
15:21:29  75  
15:21:29  76  PROCEDURE GET_TRNSCTN_ATTEMPTS_BY_STATUS (
15:21:29  77  /*
15:21:29  78  Throws exceptions:
15:21:29  79  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  80  */
15:21:29  81  	in_transaction_id	      IN NUMBER,
15:21:29  82  	in_transaction_attempt_status IN NUMBER,
15:21:29  83  	out_result_set		      OUT SYS_REFCURSOR
15:21:29  84  );
15:21:29  85  
15:21:29  86  PROCEDURE UPDATE_TRANSACTION_ATTEMPT_INF (
15:21:29  87  /*
15:21:29  88  Throws exceptions:
15:21:29  89  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29  90  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  91  */
15:21:29  92  	in_transaction_attempt_id IN NUMBER,
15:21:29  93  	in_ext_status_code	  IN VARCHAR2,
15:21:29  94  	in_ext_status_message	  IN VARCHAR2,
15:21:29  95  	in_ext_transaction_id	  IN VARCHAR2
15:21:29  96  );
15:21:29  97  
15:21:29  98  PROCEDURE GET_FAILED_ATTEMPTS_NUMBER (
15:21:29  99  /*
15:21:29 100  Throws exceptions:
15:21:29 101  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 102  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 103  */
15:21:29 104  	in_transaction_id IN  NUMBER,
15:21:29 105  	out_attempts_num  OUT NUMBER
15:21:29 106  );
15:21:29 107  
15:21:29 108  PROCEDURE GET_TRANSACTION_AMOUNT (
15:21:29 109  /*
15:21:29 110  Throws exceptions:
15:21:29 111  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 112  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 113  */
15:21:29 114  	in_transaction_id      IN  NUMBER,
15:21:29 115  	out_transaction_amount OUT NUMBER
15:21:29 116  );
15:21:29 117  
15:21:29 118  PROCEDURE GET_TRANSACTIONS_BY_CHARGE_ID (
15:21:29 119  /*
15:21:29 120  Throws exceptions:
15:21:29 121  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 122  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 123  */
15:21:29 124  	in_charge_id   IN  NUMBER,
15:21:29 125  	out_result_set OUT SYS_REFCURSOR
15:21:29 126  );
15:21:29 127  
15:21:29 128  PROCEDURE GET_TRANSACTION_BY_ORDER_ID (
15:21:29 129  /*
15:21:29 130  Throws exceptions:
15:21:29 131  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 132  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 133  */
15:21:29 134  	in_order_id   IN  TRANSACTION.ORDER_ID%TYPE,
15:21:29 135  	out_result_set OUT SYS_REFCURSOR
15:21:29 136  );
15:21:29 137  
15:21:29 138  PROCEDURE GET_TRANSACTIONS_BY_ORDER_ID (
15:21:29 139  /*
15:21:29 140  Throws exceptions:
15:21:29 141  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 142  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 143  */
15:21:29 144  	in_order_id   IN  TRANSACTION.ORDER_ID%TYPE,
15:21:29 145  	out_result_set OUT SYS_REFCURSOR
15:21:29 146  );
15:21:29 147  
15:21:29 148  PROCEDURE GET_TRANSACTION_ATTEMPTS (
15:21:29 149  /*
15:21:29 150  Throws exceptions:
15:21:29 151  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 152  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 153  */
15:21:29 154  	in_transaction_id IN  NUMBER,
15:21:29 155  	out_result_set	  OUT SYS_REFCURSOR
15:21:29 156  );
15:21:29 157  
15:21:29 158  PROCEDURE RESERVE_TRANSACTION_ID (
15:21:29 159  /*
15:21:29 160  Throws exceptions:
15:21:29 161  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 162  */
15:21:29 163  	out_transaction_id OUT NUMBER
15:21:29 164  );
15:21:29 165  
15:21:29 166  PROCEDURE GET_TRANSACTION_BY_ID (
15:21:29 167  /*
15:21:29 168  Throws exceptions:
15:21:29 169  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 170  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 171  */
15:21:29 172  	in_transaction_id IN NUMBER,
15:21:29 173  	out_result_set	  OUT SYS_REFCURSOR
15:21:29 174  );
15:21:29 175  
15:21:29 176  PROCEDURE UPDATE_TRANSACTION_ORDER_ID (
15:21:29 177  /*
15:21:29 178  Throws exceptions:
15:21:29 179  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 180  APP_EXCEPTION_CODES_V18.INTRNAL_ERROR
15:21:29 181  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 182  */
15:21:29 183  	in_transaction_id IN TRANSACTION.ID%TYPE,
15:21:29 184  	in_order_id	  IN TRANSACTION.ORDER_ID%TYPE,
15:21:29 185  	in_updated_by	  IN TRANSACTION.UPDATED_BY%TYPE
15:21:29 186  );
15:21:29 187  
15:21:29 188  PROCEDURE GET_CLOSED_REFUNDS_BY_INVOICE (
15:21:29 189  /*
15:21:29 190  Throws exceptions:
15:21:29 191  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 192  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 193  */
15:21:29 194  	in_invoice_id	IN  NUMBER,
15:21:29 195  	out_result_set OUT SYS_REFCURSOR
15:21:29 196  );
15:21:29 197  PROCEDURE IS_TRANSACTION_SUCCESSFULL (
15:21:29 198  /*
15:21:29 199  Throws exceptions:
15:21:29 200  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 201  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 202  */
15:21:29 203  	in_transaction_id IN  NUMBER,
15:21:29 204  	out_is_successfull  OUT NUMBER
15:21:29 205  );
15:21:29 206  
15:21:29 207  FUNCTION GET_TRANSACTION_TAX_AMOUNT (
15:21:29 208  	in_transaction_id IN NUMBER
15:21:29 209  ) RETURN NUMBER;
15:21:29 210  
15:21:29 211  FUNCTION GET_TRANSACTION_INTRL_TAXES (
15:21:29 212  	in_transaction_id IN NUMBER
15:21:29 213  ) RETURN NUMBER;
15:21:29 214  
15:21:29 215  -- norlov: #38796
15:21:29 216  PROCEDURE GET_TRANSACTIONS (
15:21:29 217  /*
15:21:29 218  Throws exceptions:
15:21:29 219  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 220  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 221  */
15:21:29 222  	in_group_id	      IN  NUMBER,
15:21:29 223  	in_invoice_id	      IN NUMBER DEFAULT NULL,
15:21:29 224  	in_subscription_id    IN NUMBER DEFAULT NULL,
15:21:29 225  	in_start_date	      IN TRANSACTION.CREATE_DATE%TYPE DEFAULT NULL,
15:21:29 226  	in_end_date	      IN TRANSACTION.CREATE_DATE%TYPE DEFAULT NULL,
15:21:29 227  	in_transaction_status IN NUMBER DEFAULT NULL,
15:21:29 228  	out_result_set	      OUT SYS_REFCURSOR
15:21:29 229  );
15:21:29 230  
15:21:29 231  FUNCTION IS_TRANSACTION_COLLECTED (
15:21:29 232  /*
15:21:29 233  Throws:
15:21:29 234  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 235  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 236  Returns:
15:21:29 237  GLOBAL_CONST.TRUE if transaction collected,
15:21:29 238  GLOBAL_CONST.FALSE else
15:21:29 239  */
15:21:29 240  	in_transaction_id IN NUMBER
15:21:29 241  ) RETURN NUMBER;
15:21:29 242  
15:21:29 243  PROCEDURE GET_NEXT_ATTEMPT_NUMBER (
15:21:29 244  /*
15:21:29 245  Throws exceptions:
15:21:29 246  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 247  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 248  */
15:21:29 249  	in_charge_id   in  number,
15:21:29 250  	out_attempt_count out number
15:21:29 251  );
15:21:29 252  
15:21:29 253  END PROCS_TRANSACTION_V18;
15:21:29 254  .
15:21:29 SQL> /

Package created.

Elapsed: 00:00:00.03
15:21:29 SQL> 
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> -- DDL for package PROCS_TRANSACTION_CRU
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE "PROCS_TRANSACTION_CRU_V18" AS
15:21:29   2  
15:21:29   3  PROCEDURE CREATE_TRANSACTION (
15:21:29   4  	out_transaction_id	 OUT TRANSACTION.ID%TYPE,
15:21:29   5  	in_transaction_id	 IN TRANSACTION.ID%TYPE DEFAULT NULL,
15:21:29   6  	in_transaction_status_id IN TRANSACTION.TRANSACTION_STATUS_ID%TYPE,
15:21:29   7  	in_transaction_amount	 IN TRANSACTION.TRANSACTION_AMOUNT%TYPE,
15:21:29   8  	in_created_by		 IN TRANSACTION.CREATED_BY%TYPE,
15:21:29   9  	in_order_id		 IN TRANSACTION.ORDER_ID%TYPE,
15:21:29  10  	in_is_refund		 IN TRANSACTION.IS_REFUND%TYPE DEFAULT GLOBAL_CONSTANTS_V18.FALSE,
15:21:29  11  	in_transaction_type_code IN TRANSACTION.TRANSACTION_TYPE_CODE%TYPE DEFAULT NULL
15:21:29  12  );
15:21:29  13  
15:21:29  14  PROCEDURE UPDATE_TRANSACTION (
15:21:29  15  	in_transaction_id	 IN TRANSACTION.ID%TYPE,
15:21:29  16  	in_transaction_status_id IN TRANSACTION.TRANSACTION_STATUS_ID%TYPE DEFAULT NULL,
15:21:29  17  	in_transaction_amount	 IN TRANSACTION.TRANSACTION_AMOUNT%TYPE DEFAULT NULL,
15:21:29  18  	in_updated_by		 IN TRANSACTION.CREATED_BY%TYPE,
15:21:29  19  	in_order_id		 IN TRANSACTION.ORDER_ID%TYPE DEFAULT NULL,
15:21:29  20  	in_is_settled		 IN TRANSACTION.IS_SETTLED%TYPE DEFAULT NULL
15:21:29  21  );
15:21:29  22  
15:21:29  23  PROCEDURE READ_TRANSACTION (
15:21:29  24  	in_transaction_id IN TRANSACTION.ID%TYPE,
15:21:29  25  	out_result_set	  OUT SYS_REFCURSOR
15:21:29  26  );
15:21:29  27  
15:21:29  28  PROCEDURE CREATE_TRANSACTION_ATTEMPT(
15:21:29  29  	inout_transaction_attempt_id IN OUT TRANSACTION_ATTEMPT.ID%TYPE,
15:21:29  30  	in_transaction_id	     IN TRANSACTION_ATTEMPT.TRANSACTION_ID%TYPE,
15:21:29  31  	in_external_status_code      IN TRANSACTION_ATTEMPT.EXTERNAL_STATUS_CODE%TYPE DEFAULT NULL,
15:21:29  32  	in_external_status_message   IN TRANSACTION_ATTEMPT.EXTERNAL_STATUS_MESSAGE%TYPE DEFAULT NULL,
15:21:29  33  	in_created_by		     IN TRANSACTION_ATTEMPT.CREATED_BY%TYPE,
15:21:29  34  	in_external_transaction_id   IN TRANSACTION_ATTEMPT.EXTERNAL_TRANSACTION_ID%TYPE DEFAULT NULL,
15:21:29  35  	in_transaction_start_time    IN TRANSACTION_ATTEMPT.TRANSACTION_START_TIME%TYPE DEFAULT NULL,
15:21:29  36  	in_status_id		     IN TRANSACTION_ATTEMPT.TRANSACTION_ATTEMPT_STATUS_ID%TYPE
15:21:29  37  );
15:21:29  38  
15:21:29  39  PROCEDURE UPDATE_TRANSACTION_ORDER_ID (
15:21:29  40  /*
15:21:29  41  Throws exceptions:
15:21:29  42  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29  43  APP_EXCEPTION_CODES_V18.INTRNAL_ERROR
15:21:29  44  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  45  */
15:21:29  46  	in_transaction_id IN TRANSACTION.ID%TYPE,
15:21:29  47  	in_order_id	  IN TRANSACTION.ORDER_ID%TYPE,
15:21:29  48  	in_updated_by	  IN TRANSACTION.UPDATED_BY%TYPE
15:21:29  49  );
15:21:29  50  
15:21:29  51  PROCEDURE UPDATE_TRANSACTION_ATTEMPT (
15:21:29  52  	in_transaction_attempt_id  IN TRANSACTION_ATTEMPT.ID%TYPE,
15:21:29  53  	in_external_status_code    IN TRANSACTION_ATTEMPT.EXTERNAL_STATUS_CODE%TYPE DEFAULT NULL,
15:21:29  54  	in_external_status_message IN TRANSACTION_ATTEMPT.EXTERNAL_STATUS_MESSAGE%TYPE DEFAULT NULL,
15:21:29  55  	in_external_transaction_id IN TRANSACTION_ATTEMPT.EXTERNAL_TRANSACTION_ID%TYPE DEFAULT NULL,
15:21:29  56  	in_transaction_start_time  IN TRANSACTION_ATTEMPT.TRANSACTION_START_TIME%TYPE DEFAULT NULL,
15:21:29  57  	in_status_id		   IN TRANSACTION_ATTEMPT.TRANSACTION_ATTEMPT_STATUS_ID%TYPE DEFAULT NULL
15:21:29  58  );
15:21:29  59  
15:21:29  60  END PROCS_TRANSACTION_CRU_V18;
15:21:29  61  .
15:21:29 SQL> /

Package created.

Elapsed: 00:00:00.03
15:21:29 SQL> 
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> -- DDL for package PUBLIC_PROCS_BILLING
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE "PUBLIC_PROCS_BILLING_V18" AS
15:21:29   2  
15:21:29   3  PROCEDURE GET_OFFER_CHAIN_BY_ID (
15:21:29   4  /*
15:21:29   5  Throws exceptions:
15:21:29   6  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29   7  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29   8  */
15:21:29   9  	  in_offer_chain_id IN	 NUMBER,
15:21:29  10  	  out_result_set    OUT  SYS_REFCURSOR
15:21:29  11  );
15:21:29  12  
15:21:29  13  PROCEDURE GET_GC_ID_BY_PURCH_INVOICE_ID (
15:21:29  14  /*
15:21:29  15  Throws exceptions:
15:21:29  16  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29  17  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  18  */
15:21:29  19  in_invoice_id IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
15:21:29  20  out_gift_certificate_id OUT GIFT_CERTIFICATE.ID%TYPE
15:21:29  21  );
15:21:29  22  
15:21:29  23  PROCEDURE GET_PENDING_INVOICES (
15:21:29  24  /*
15:21:29  25  Throws exceptions:
15:21:29  26  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  27  */
15:21:29  28  	out_result_set1      OUT SYS_REFCURSOR,
15:21:29  29  	out_result_set2      OUT SYS_REFCURSOR,
15:21:29  30  	out_result_set3      OUT SYS_REFCURSOR,
15:21:29  31  	in_row_number	     IN NUMBER DEFAULT NULL
15:21:29  32  );
15:21:29  33  
15:21:29  34  PROCEDURE GET_PENDING_REFUND_CHARGES (
15:21:29  35  /*
15:21:29  36  Throws exceptions:
15:21:29  37  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  38  */
15:21:29  39  	out_result_set	    OUT SYS_REFCURSOR,
15:21:29  40  	in_row_number	    IN NUMBER DEFAULT NULL
15:21:29  41  );
15:21:29  42  
15:21:29  43  PROCEDURE GET_UNPROCESSED_CHARGES (
15:21:29  44  /*
15:21:29  45  Throws exceptions:
15:21:29  46  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29  47  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  48  */
15:21:29  49  	in_invoice_id  IN NUMBER,
15:21:29  50  	out_result_set OUT SYS_REFCURSOR
15:21:29  51  );
15:21:29  52  
15:21:29  53  PROCEDURE GET_PROCESSED_CHARGES (
15:21:29  54  /*
15:21:29  55  Throws exceptions:
15:21:29  56  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29  57  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  58  */
15:21:29  59  	in_invoice_id  IN NUMBER,
15:21:29  60  	out_result_set OUT SYS_REFCURSOR
15:21:29  61  );
15:21:29  62  
15:21:29  63  PROCEDURE GET_TRNSCTN_ATTEMPTS_BY_STATUS (
15:21:29  64  /*
15:21:29  65  Throws exceptions:
15:21:29  66  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  67  */
15:21:29  68  	in_transaction_id	      IN NUMBER,
15:21:29  69  	in_transaction_attempt_status IN NUMBER,
15:21:29  70  	out_result_set		      OUT SYS_REFCURSOR
15:21:29  71  );
15:21:29  72  
15:21:29  73  PROCEDURE UPDATE_TRNSCTN_ATTEMPT_STATUS (
15:21:29  74  /*
15:21:29  75  Throws exceptions:
15:21:29  76  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29  77  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  78  */
15:21:29  79  	in_transaction_attempt_id     IN NUMBER,
15:21:29  80  	in_transaction_attempt_status IN NUMBER
15:21:29  81  );
15:21:29  82  
15:21:29  83  PROCEDURE UPDATE_TRNSCTN_ATTEMPT_TIME (
15:21:29  84  /*
15:21:29  85  Throws exceptions:
15:21:29  86  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29  87  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  88  */
15:21:29  89  	in_transaction_attempt_id IN NUMBER,
15:21:29  90  	in_updated_by		  IN VARCHAR2
15:21:29  91  );
15:21:29  92  
15:21:29  93  PROCEDURE CREATE_TRANSACTION_ATTEMPT (
15:21:29  94  /*
15:21:29  95  Throws exceptions:
15:21:29  96  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29  97  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  98  */
15:21:29  99  	in_transaction_id	   IN NUMBER,
15:21:29 100  	in_trans_attempt_status    IN NUMBER,
15:21:29 101  	in_external_status_code    IN VARCHAR2,
15:21:29 102  	in_external_status_message IN VARCHAR2,
15:21:29 103  	in_created_by		   IN VARCHAR2,
15:21:29 104  	in_ext_transaction_id	   IN VARCHAR2,
15:21:29 105  	out_transaction_attempt_id OUT NUMBER
15:21:29 106  );
15:21:29 107  
15:21:29 108  PROCEDURE UPDATE_TRANSACTION_ATTEMPT_INF (
15:21:29 109  /*
15:21:29 110  Throws exceptions:
15:21:29 111  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 112  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 113  */
15:21:29 114  	in_transaction_attempt_id IN NUMBER,
15:21:29 115  	in_ext_status_code	  IN VARCHAR2,
15:21:29 116  	in_ext_status_message	  IN VARCHAR2,
15:21:29 117  	in_ext_transaction_id	  IN VARCHAR2
15:21:29 118  );
15:21:29 119  
15:21:29 120  PROCEDURE UPDATE_TRANSACTION_STATUS (
15:21:29 121  /*
15:21:29 122  Throws exceptions:
15:21:29 123  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 124  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 125  */
15:21:29 126  	in_transaction_id	 IN NUMBER,
15:21:29 127  	in_updated_by		 IN VARCHAR2,
15:21:29 128  	in_transaction_status_id IN NUMBER
15:21:29 129  );
15:21:29 130  
15:21:29 131  PROCEDURE GET_FAILED_ATTEMPTS_NUMBER (
15:21:29 132  /*
15:21:29 133  Throws exceptions:
15:21:29 134  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 135  */
15:21:29 136  	in_transaction_id IN  NUMBER,
15:21:29 137  	out_attempts_num  OUT NUMBER
15:21:29 138  );
15:21:29 139  
15:21:29 140  PROCEDURE IS_TRANSACTION_SUCCESSFULL (
15:21:29 141  /*
15:21:29 142  Throws exceptions:
15:21:29 143  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 144  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 145  */
15:21:29 146  	in_transaction_id IN  NUMBER,
15:21:29 147  	out_is_successfull  OUT NUMBER
15:21:29 148  );
15:21:29 149  
15:21:29 150  PROCEDURE UPDATE_INVOICE_STATUS (
15:21:29 151  /*
15:21:29 152  Throws exceptions:
15:21:29 153  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 154  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 155  */
15:21:29 156  	in_invoice_id		       IN NUMBER,
15:21:29 157  	in_invoice_status_id	       IN NUMBER,
15:21:29 158  	in_updated_by		       IN VARCHAR2
15:21:29 159  );
15:21:29 160  
15:21:29 161  PROCEDURE SUSPEND_SUBSCRIPTION(
15:21:29 162  /*
15:21:29 163  Throws exceptions:
15:21:29 164  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 165  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:29 166  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 167  */
15:21:29 168  	  in_subs_id	IN NUMBER ,
15:21:29 169  	  in_updated_by IN VARCHAR2
15:21:29 170  );
15:21:29 171  
15:21:29 172  PROCEDURE GET_CREDIT_CARD_BY_ID (
15:21:29 173  /*
15:21:29 174  Throws exceptions:
15:21:29 175  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 176  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 177  */
15:21:29 178  	in_credit_card_id IN  NUMBER,
15:21:29 179  	out_result_set	  OUT SYS_REFCURSOR
15:21:29 180  );
15:21:29 181  
15:21:29 182  PROCEDURE GET_TRANSACTION_AMOUNT (
15:21:29 183  /*
15:21:29 184  Throws exceptions:
15:21:29 185  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 186  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 187  */
15:21:29 188  	in_transaction_id      IN  NUMBER,
15:21:29 189  	out_transaction_amount OUT NUMBER
15:21:29 190  );
15:21:29 191  
15:21:29 192  PROCEDURE GET_ACCOUNT_BY_INVOICE_ID (
15:21:29 193  /*
15:21:29 194  Throws exceptions:
15:21:29 195  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 196  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 197  */
15:21:29 198  	in_invoice_id  IN  NUMBER,
15:21:29 199  	out_account_id OUT NUMBER
15:21:29 200  );
15:21:29 201  
15:21:29 202  PROCEDURE GET_GIFT_CERTIFICATE_BY_ID (
15:21:29 203  /*
15:21:29 204  Throws exceptions:
15:21:29 205  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:29 206  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 207  */
15:21:29 208  	in_gift_certificate_id IN NUMBER,
15:21:29 209  	out_result_set	       OUT SYS_REFCURSOR
15:21:29 210  );
15:21:29 211  
15:21:29 212  PROCEDURE GET_SUBSCR_ID_BY_CHARGE_ID (
15:21:29 213  /*
15:21:29 214  Throws exceptions:
15:21:29 215  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 216  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 217  */
15:21:29 218  	in_charge_id	    IN NUMBER,
15:21:29 219  	out_subscription_id OUT NUMBER
15:21:29 220  );
15:21:29 221  
15:21:29 222  PROCEDURE IS_GCERT_FOR_PROPER_OFFER (
15:21:29 223  /*
15:21:29 224  Throws exceptions:
15:21:29 225  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 226  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 227  */
15:21:29 228  	in_gift_certificate_id IN NUMBER,
15:21:29 229  	in_charge_id	       IN NUMBER,
15:21:29 230  	out_result	       OUT NUMBER
15:21:29 231  );
15:21:29 232  
15:21:29 233  PROCEDURE GET_SUBSCRIPTION_INFO (
15:21:29 234  /*
15:21:29 235  Throws exceptions:
15:21:29 236  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 237  */
15:21:29 238  	  in_subscription_id IN  NUMBER,
15:21:29 239  	  out_result_set      OUT SYS_REFCURSOR
15:21:29 240  );
15:21:29 241  
15:21:29 242  PROCEDURE CALCULATE_INVOICE_AMOUNT (
15:21:29 243  /*
15:21:29 244  Throws exceptions:
15:21:29 245  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 246  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 247  */
15:21:29 248  	in_invoice_id IN  NUMBER,
15:21:29 249  	out_amount    OUT NUMBER
15:21:29 250  );
15:21:29 251  
15:21:29 252  PROCEDURE GET_TRANSACTION_BY_ID (
15:21:29 253  /*
15:21:29 254  Throws exceptions:
15:21:29 255  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 256  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 257  */
15:21:29 258  	in_transaction_id IN NUMBER,
15:21:29 259  	out_result_set	  OUT SYS_REFCURSOR
15:21:29 260  );
15:21:29 261  
15:21:29 262  PROCEDURE UPDATE_CHARGE_STATUS (
15:21:29 263  /*
15:21:29 264  Throws exceptions:
15:21:29 265  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 266  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 267  */
15:21:29 268  	in_charge_id	    IN CHARGE.ID%TYPE,
15:21:29 269  	in_charge_status_id IN CHARGE.CHARGE_STATUS_ID%TYPE,
15:21:29 270  	in_updated_by	    IN CHARGE.UPDATED_BY%TYPE
15:21:29 271  );
15:21:29 272  
15:21:29 273  PROCEDURE GET_GC_BY_PURCH_INVOICE_ID (
15:21:29 274  	in_invoice_id		IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
15:21:29 275  	out_result_set OUT SYS_REFCURSOR
15:21:29 276  );
15:21:29 277  
15:21:29 278  PROCEDURE UPDATE_TRANSACTION_ORDER_ID (
15:21:29 279  /*
15:21:29 280  Throws exceptions:
15:21:29 281  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 282  APP_EXCEPTION_CODES_V18.INTRNAL_ERROR
15:21:29 283  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 284  */
15:21:29 285  	in_transaction_id IN TRANSACTION.ID%TYPE,
15:21:29 286  	in_order_id	  IN TRANSACTION.ORDER_ID%TYPE,
15:21:29 287  	in_updated_by	  IN TRANSACTION.UPDATED_BY%TYPE
15:21:29 288  );
15:21:29 289  PROCEDURE GET_CLOSED_REFUNDS_BY_INVOICE (
15:21:29 290  /*
15:21:29 291  Throws exceptions:
15:21:29 292  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 293  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 294  */
15:21:29 295  	in_invoice_id	IN  NUMBER,
15:21:29 296  	out_result_set OUT SYS_REFCURSOR
15:21:29 297  );
15:21:29 298  PROCEDURE GET_ACTIVE_INVOICES_IDS (
15:21:29 299  /*
15:21:29 300  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 301  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 302  */
15:21:29 303  --  in_subscription_id IN SUBSCRIPTION.ID%TYPE,
15:21:29 304  	in_subscription_id IN NUMBER,
15:21:29 305  	out_result_set	   OUT SYS_REFCURSOR
15:21:29 306  );
15:21:29 307  PROCEDURE CANCEL_SUBSCRIPTION_INVOICE (
15:21:29 308  /*
15:21:29 309  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 310  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 311  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:29 312  */
15:21:29 313  --  in_invoice_id        IN INVOICE.ID%TYPE,
15:21:29 314  --  in_updated_by        IN INVOICE.UPDATED_BY%TYPE,
15:21:29 315  -- norlov: in_refundable	      IN refund enabled
15:21:29 316  	in_invoice_id	     IN NUMBER,
15:21:29 317  	in_updated_by	     IN VARCHAR2,
15:21:29 318  	in_refundable	     IN NUMBER DEFAULT GLOBAL_CONSTANTS_V18.FALSE
15:21:29 319  --  in_cancellation_date IN DATE DEFAULT current_timestamp
15:21:29 320  );
15:21:29 321  
15:21:29 322  PROCEDURE FINALIZE_CANCELATION (
15:21:29 323  /*
15:21:29 324  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 325  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 326  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:29 327  */
15:21:29 328  --  in_subscription_id	IN SUBSCRIPTION.ID%TYPE,
15:21:29 329  --  in_cancelation_reason IN SUBSCRIPTION_CANCEL_REASON.VALUE%TYPE,
15:21:29 330  --  in_cancelation_date	IN SUBSCRIPTION.CANCELLATION_DATE%TYPE,
15:21:29 331  --  in_note		IN SUBSCRIPTION_NOTE.NOTE%TYPE,
15:21:29 332  --  in_agent_id		IN SUBSCRIPTION_NOTE.AGENT_ID%TYPE,
15:21:29 333  --  in_updated_by 	IN SUBSCRIPTION.UPDATED_BY%TYPE
15:21:29 334  	in_subscription_id    IN NUMBER,
15:21:29 335  	in_cancelation_reason IN VARCHAR2,
15:21:29 336  	in_cancelation_date   IN DATE,
15:21:29 337  	in_note 	      IN VARCHAR2,
15:21:29 338  	in_agent_id	      IN NUMBER,
15:21:29 339  	in_updated_by	      IN VARCHAR2
15:21:29 340  );
15:21:29 341  PROCEDURE GET_SUBSCR_PROD_OFFERRINGS (
15:21:29 342  /*
15:21:29 343  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 344  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 345  */
15:21:29 346  	in_subscription_id IN NUMBER,
15:21:29 347  	out_result_set	   OUT SYS_REFCURSOR
15:21:29 348  );
15:21:29 349  PROCEDURE GET_OFFER_CHAIN_META_DATA (
15:21:29 350  /*
15:21:29 351  Throws exceptions (codes):
15:21:29 352  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 353  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 354  */
15:21:29 355  	in_offer_chain_id IN NUMBER,
15:21:29 356  	in_meta_data_name IN VARCHAR2,
15:21:29 357  	out_result_set	  OUT SYS_REFCURSOR
15:21:29 358  );
15:21:29 359  PROCEDURE GET_PRODUCT_OFFERING_META_DATA (
15:21:29 360  /*
15:21:29 361  Throws exceptions (codes):
15:21:29 362  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 363  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 364  */
15:21:29 365  	in_product_offering_id IN NUMBER,
15:21:29 366  	in_meta_data_name      IN VARCHAR2 DEFAULT NULL,
15:21:29 367  	out_result_set	       OUT SYS_REFCURSOR
15:21:29 368  );
15:21:29 369  PROCEDURE READ_ACCOUNT (
15:21:29 370  	in_account_id  IN ACCOUNT.ID%TYPE,
15:21:29 371  	out_result_set OUT SYS_REFCURSOR
15:21:29 372  );
15:21:29 373  
15:21:29 374  PROCEDURE GET_COLLECTED_CHARGES (
15:21:29 375  /*
15:21:29 376  Throws exceptions:
15:21:29 377  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 378  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 379  */
15:21:29 380  	in_invoice_id  IN NUMBER,
15:21:29 381  	out_result_set OUT SYS_REFCURSOR
15:21:29 382  );
15:21:29 383  
15:21:29 384  PROCEDURE GET_GROUPS_ID_BY_INVOICE_ID (
15:21:29 385  /*
15:21:29 386  Throws exceptions:
15:21:29 387  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:29 388  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 389  */
15:21:29 390  	in_invoice_id IN NUMBER,
15:21:29 391  	out_group_ids OUT SYS_REFCURSOR
15:21:29 392  );
15:21:29 393  
15:21:29 394  PROCEDURE GET_ACCOUNT_ID_BY_GROUP_ID (
15:21:29 395  /*
15:21:29 396  Throws exceptions:
15:21:29 397  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:29 398  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 399  */
15:21:29 400  	in_group_id IN NUMBER,
15:21:29 401  	out_account_id	OUT NUMBER
15:21:29 402  );
15:21:29 403  
15:21:29 404  PROCEDURE LOCK_ACCOUNT (
15:21:29 405  	in_group_id    IN NUMBER,
15:21:29 406  	in_lock_key    IN VARCHAR2,
15:21:29 407  	in_seconds_num IN NUMBER,
15:21:29 408  	in_created_by  IN VARCHAR2,
15:21:29 409  	in_reason      IN VARCHAR2
15:21:29 410  );
15:21:29 411  
15:21:29 412  PROCEDURE RELEASE_LOCK (
15:21:29 413  	in_group_id IN NUMBER,
15:21:29 414  	in_lock_key IN VARCHAR2
15:21:29 415  );
15:21:29 416  
15:21:29 417  PROCEDURE GET_PAYMENT_INFO_BY_INVOICE_ID (
15:21:29 418  	in_invoice_id		    IN NUMBER,
15:21:29 419  	out_order_id		    OUT VARCHAR2,
15:21:29 420  	out_external_transaction_id OUT VARCHAR2
15:21:29 421  );
15:21:29 422  
15:21:29 423  PROCEDURE GET_PAYPAL_BY_ID (
15:21:29 424  	in_paypal_id   IN  NUMBER,
15:21:29 425  	out_result_set OUT SYS_REFCURSOR
15:21:29 426  );
15:21:29 427  
15:21:29 428  PROCEDURE GET_NEXT_ATTEMPT_NUMBER (
15:21:29 429  /*
15:21:29 430  Throws exceptions:
15:21:29 431  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 432  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 433  */
15:21:29 434  	in_charge_id   in  number,
15:21:29 435  	out_attempt_count out number
15:21:29 436  );
15:21:29 437  
15:21:29 438  PROCEDURE GET_NOTIFICATION_TYPE_ID (
15:21:29 439  	in_offer_chain_id	 IN NUMBER,
15:21:29 440  	in_action_name		 IN VARCHAR2,
15:21:29 441  	out_notification_type_id out number
15:21:29 442  );
15:21:29 443  
15:21:29 444  PROCEDURE SHOULD_MOVE_TO_GRACE(
15:21:29 445  	in_invoice_id  IN INVOICE.ID%TYPE,
15:21:29 446  	out_result     OUT NUMBER
15:21:29 447  );
15:21:29 448  
15:21:29 449  PROCEDURE MOVE_TO_GRACE(
15:21:29 450  	in_invoice_id		      IN INVOICE.ID%TYPE,
15:21:29 451  	in_updated_by		      IN LICENSE.UPDATED_BY%TYPE,
15:21:29 452  	in_grace_period_length_hours  IN NUMBER
15:21:29 453  );
15:21:29 454  
15:21:29 455  PROCEDURE MOVE_OUT_OF_GRACE(
15:21:29 456  	in_invoice_id	IN INVOICE.ID%TYPE,
15:21:29 457  	in_updated_by	IN LICENSE.UPDATED_BY%TYPE
15:21:29 458  );
15:21:29 459  
15:21:29 460  END PUBLIC_PROCS_BILLING_V18;
15:21:29 461  .
15:21:29 SQL> /

Package created.

Elapsed: 00:00:00.06
15:21:29 SQL> 
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> -- DDL for package PUBLIC_PROCS_CLIENT
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE "PUBLIC_PROCS_CLIENT_V18" AS
15:21:29   2  
15:21:29   3  PROCEDURE GET_NOTIFICATION_TYPE_BY_NAME (
15:21:29   4  /*
15:21:29   5  Throws exceptions:
15:21:29   6  CORE_OWNER.APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29   7  CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29   8  */
15:21:29   9  	in_notification_type_name IN VARCHAR2,
15:21:29  10  	out_notification_type_id  OUT NUMBER
15:21:29  11  );
15:21:29  12  
15:21:29  13  PROCEDURE ADD_NOTIFICATION (
15:21:29  14  /*
15:21:29  15  Throws exceptions:
15:21:29  16  CORE_OWNER.APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29  17  CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  18  */
15:21:29  19  	in_sender_account_id	 IN NUMBER DEFAULT 0,
15:21:29  20  	in_recipient_group_id	 IN NUMBER,
15:21:29  21  	in_notification_type_id  IN NUMBER,
15:21:29  22  	in_date_to_notify	 IN DATE,
15:21:29  23  	in_email_template_params IN CLOB
15:21:29  24  );
15:21:29  25  
15:21:29  26  END PUBLIC_PROCS_CLIENT_V18;
15:21:29  27  .
15:21:29 SQL> /

Package created.

Elapsed: 00:00:00.02
15:21:29 SQL> 
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> -- DDL for package PUBLIC_PROCS_NOTIFICATION
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE "PUBLIC_PROCS_NOTIFICATION_V18" AS
15:21:29   2  
15:21:29   3  PROCEDURE LOCK_ACCOUNT (
15:21:29   4  	in_group_id    IN NUMBER,
15:21:29   5  	in_lock_key    IN VARCHAR2,
15:21:29   6  	in_seconds_num IN NUMBER,
15:21:29   7  	in_created_by  IN VARCHAR2,
15:21:29   8  	in_reason      IN VARCHAR2
15:21:29   9  );
15:21:29  10  
15:21:29  11  PROCEDURE RELEASE_LOCK (
15:21:29  12  	in_group_id IN NUMBER,
15:21:29  13  	in_lock_key IN VARCHAR2
15:21:29  14  );
15:21:29  15  
15:21:29  16  END PUBLIC_PROCS_NOTIFICATION_V18;
15:21:29  17  .
15:21:29 SQL> /

Package created.

Elapsed: 00:00:00.03
15:21:29 SQL> 
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> -- DDL for package PUBLIC_PROCS_RENEWAL
15:21:29 SQL> --------------------------------------------------------------------------------
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE "PUBLIC_PROCS_RENEWAL_V18" AS
15:21:29   2  
15:21:29   3  PROCEDURE SUB_EXPIRES_NEED_ENTITLEMENTS (
15:21:29   4  	out_result_set OUT SYS_REFCURSOR
15:21:29   5  );
15:21:29   6  
15:21:29   7  PROCEDURE UPDATE_SS_NEED_ENTITLEMENTS (
15:21:29   8  	in_sub_share_id      IN SUBSCRIPTION_SHARE.ID%TYPE,
15:21:29   9  	in_need_entitlements IN SUBSCRIPTION_SHARE.NEEDS_ENTITLEMENTS%TYPE,
15:21:29  10  	in_updater	     IN SUBSCRIPTION_SHARE.UPDATED_BY%TYPE
15:21:29  11  );
15:21:29  12  
15:21:29  13  PROCEDURE GET_OFFER_CHAIN_BY_ID (
15:21:29  14  /*
15:21:29  15  Throws exceptions:
15:21:29  16  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29  17  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  18  */
15:21:29  19  	  in_offer_chain_id IN	 NUMBER,
15:21:29  20  	  out_result_set    OUT  SYS_REFCURSOR
15:21:29  21  );
15:21:29  22  
15:21:29  23  PROCEDURE GET_UNREDEEMED_GCS (
15:21:29  24  	out_result_set		OUT SYS_REFCURSOR,
15:21:29  25  	in_hours_number 	IN NUMBER DEFAULT 14*24,
15:21:29  26  	in_num_rows		IN NUMBER DEFAULT 10000,
15:21:29  27  	in_process_name 	IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE
15:21:29  28  );
15:21:29  29  
15:21:29  30  PROCEDURE GET_SUBSCRIPTIONS_META_DATA (
15:21:29  31  /*
15:21:29  32  APP_EXCEPTION_CODES_V18.INVALID_PARAMETER
15:21:29  33  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  34  */
15:21:29  35  	in_subscriptions_ids IN core_owner.NUMBER_TABLE,
15:21:29  36  	out_result_set	     OUT SYS_REFCURSOR
15:21:29  37  );
15:21:29  38  
15:21:29  39  PROCEDURE GET_ALL_OCH_META_DATA (
15:21:29  40  	in_offer_chain_id IN NUMBER,
15:21:29  41  	out_result_set	  OUT SYS_REFCURSOR
15:21:29  42  );
15:21:29  43  
15:21:29  44  PROCEDURE GET_OFFER_CHAIN_META_DATA (
15:21:29  45  /*
15:21:29  46  Throws exceptions (codes):
15:21:29  47  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29  48  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  49  */
15:21:29  50  	in_offer_chain_id IN NUMBER,
15:21:29  51  	in_meta_data_name IN VARCHAR2,
15:21:29  52  	out_result_set	  OUT SYS_REFCURSOR
15:21:29  53  );
15:21:29  54  
15:21:29  55  PROCEDURE GET_ENDING_LICENSES (
15:21:29  56  /*
15:21:29  57  Throws exceptions:
15:21:29  58  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  59  */
15:21:29  60  	in_hours_number IN NUMBER,
15:21:29  61  	out_result_set OUT SYS_REFCURSOR
15:21:29  62  );
15:21:29  63  
15:21:29  64  PROCEDURE GET_ENDING_LICENSES_CC (
15:21:29  65  /*
15:21:29  66  Throws exceptions:
15:21:29  67  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  68  */
15:21:29  69  	in_hours_number IN NUMBER,
15:21:29  70  	out_result_set OUT SYS_REFCURSOR,
15:21:29  71  	in_process_name 	IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE
15:21:29  72  );
15:21:29  73  
15:21:29  74  /************************************************/
15:21:29  75  
15:21:29  76  PROCEDURE GET_RECURRING_OFFER (
15:21:29  77  /*
15:21:29  78  Throws exceptions:
15:21:29  79  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  80  */
15:21:29  81  	in_license_id  IN NUMBER,
15:21:29  82  	out_result_set OUT SYS_REFCURSOR
15:21:29  83  );
15:21:29  84  
15:21:29  85  /*************************************************/
15:21:29  86  
15:21:29  87  PROCEDURE GET_NEXT_OFFER (
15:21:29  88  /*
15:21:29  89  Throws exceptions:
15:21:29  90  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29  91  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:29  92  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29  93  */
15:21:29  94  	in_license_id  IN NUMBER,
15:21:29  95  	out_result_set OUT SYS_REFCURSOR
15:21:29  96  );
15:21:29  97  
15:21:29  98  /**************************************************/
15:21:29  99  
15:21:29 100  PROCEDURE UPDATE_LICENSE_STATUS(
15:21:29 101  /*
15:21:29 102  Throws exceptions:
15:21:29 103  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 104  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 105  */
15:21:29 106  	  in_license_id     IN NUMBER,
15:21:29 107  	  in_license_status IN NUMBER,
15:21:29 108  	  in_updated_by     IN VARCHAR2
15:21:29 109  );
15:21:29 110  
15:21:29 111  /***************************************************/
15:21:29 112  
15:21:29 113  PROCEDURE UPDATE_INVOICE_STATUS (
15:21:29 114  /*
15:21:29 115  Throws exceptions:
15:21:29 116  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 117  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 118  */
15:21:29 119  	in_invoice_id		       IN NUMBER,
15:21:29 120  	in_invoice_status_id	       IN NUMBER,
15:21:29 121  	in_updated_by		       IN VARCHAR2
15:21:29 122  );
15:21:29 123  
15:21:29 124  /***************************************************/
15:21:29 125  
15:21:29 126  PROCEDURE CREATE_LICENSE(
15:21:29 127  /*
15:21:29 128  Throws exceptions:
15:21:29 129  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 130  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 131  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:29 132  */
15:21:29 133  	in_status_id		    IN NUMBER,
15:21:29 134  	in_needs_entitlements	    IN NUMBER,
15:21:29 135  	in_start_date		    IN DATE,
15:21:29 136  	in_end_date		    IN DATE,
15:21:29 137  	in_offer_id		    IN NUMBER,
15:21:29 138  	in_subscription_id	    IN NUMBER,
15:21:29 139  	in_invoice_id		    IN NUMBER,
15:21:29 140  	in_created_by		    IN VARCHAR2,
15:21:29 141  	in_is_extension 	    IN NUMBER,
15:21:29 142  	in_current_offer_index	    IN NUMBER,
15:21:29 143  	in_current_offer_recurr_num IN NUMBER,
15:21:29 144  	out_license_id		    OUT NUMBER
15:21:29 145  );
15:21:29 146  
15:21:29 147  /**************************************************/
15:21:29 148  
15:21:29 149  PROCEDURE CREATE_INVOICE(
15:21:29 150  /*
15:21:29 151  Throws exceptions:
15:21:29 152  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 153  */
15:21:29 154  	  in_invoice_status IN NUMBER,
15:21:29 155  	  in_created_by     IN VARCHAR2,
15:21:29 156  	  in_tax_exempt_id  IN VARCHAR2,
15:21:29 157  	  out_invoice_id    OUT NUMBER
15:21:29 158  );
15:21:29 159  
15:21:29 160  /*****************************************************/
15:21:29 161  
15:21:29 162  PROCEDURE CREATE_CHARGE(
15:21:29 163  /*
15:21:29 164  Throws exceptions:
15:21:29 165  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 166  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 167  */
15:21:29 168  	in_invoice_id	      IN NUMBER,
15:21:29 169  	in_transaction_id     IN NUMBER,
15:21:29 170  	in_instrument_type_id IN NUMBER,
15:21:29 171  	in_instrument_id      IN NUMBER,
15:21:29 172  	in_charge_amount      IN NUMBER,
15:21:29 173  	in_created_by	      IN VARCHAR2,
15:21:29 174  	in_charge_status_id   IN NUMBER,
15:21:29 175  	out_charge_id	      OUT NUMBER
15:21:29 176  );
15:21:29 177  
15:21:29 178  /*****************************************************/
15:21:29 179  
15:21:29 180  PROCEDURE HAS_FUTURE_LICENSE (
15:21:29 181  /*
15:21:29 182  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 183  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 184  --
15:21:29 185  RETURNS:
15:21:29 186  1 - if has,
15:21:29 187  0 - else
15:21:29 188  */
15:21:29 189  	in_license_id IN NUMBER,
15:21:29 190  	out_result	   OUT NUMBER
15:21:29 191  );
15:21:29 192  
15:21:29 193  /*****************************************************/
15:21:29 194  
15:21:29 195  PROCEDURE GET_GROUP_ID_BY_LICENSE_ID (
15:21:29 196  /*
15:21:29 197  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 198  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 199  */
15:21:29 200  	in_license_id IN NUMBER,
15:21:29 201  	out_group_id  OUT NUMBER
15:21:29 202  );
15:21:29 203  
15:21:29 204  /*****************************************************/
15:21:29 205  
15:21:29 206  PROCEDURE GET_OFFER_PRODUCTS (
15:21:29 207  /*
15:21:29 208  Throws exceptions (codes):
15:21:29 209  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 210  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 211  */
15:21:29 212  	in_offer_id    IN NUMBER,
15:21:29 213  	out_result_set OUT SYS_REFCURSOR
15:21:29 214  );
15:21:29 215  
15:21:29 216  /*******************************************************/
15:21:29 217  
15:21:29 218  PROCEDURE CREATE_TRANSACTION (
15:21:29 219  /*
15:21:29 220  Throws exceptions:
15:21:29 221  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 222  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 223  */
15:21:29 224  	in_transaction_id	  IN NUMBER,
15:21:29 225  	in_status_id		  IN NUMBER,
15:21:29 226  	in_amount		  IN NUMBER,
15:21:29 227  	in_created_by		  IN VARCHAR2,
15:21:29 228  	in_order_id		  IN VARCHAR2,
15:21:29 229  	in_transaction_type_code  IN VARCHAR2 DEFAULT NULL,
15:21:29 230  	out_transaction_id	  OUT NUMBER
15:21:29 231  );
15:21:29 232  
15:21:29 233  /*********************************************************/
15:21:29 234  
15:21:29 235  PROCEDURE ADD_LINE_ITEMS(
15:21:29 236  /*
15:21:29 237  Throws exceptions:
15:21:29 238  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 239  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 240  */
15:21:29 241  	in_invoice_id IN NUMBER,
15:21:29 242  	in_offer_id   IN NUMBER,
15:21:29 243  	in_created_by IN VARCHAR2
15:21:29 244  );
15:21:29 245  
15:21:29 246  /**********************************************************/
15:21:29 247  
15:21:29 248  PROCEDURE CALCULATE_INVOICE_AMOUNT (
15:21:29 249  /*
15:21:29 250  Throws exceptions:
15:21:29 251  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 252  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 253  */
15:21:29 254  	in_invoice_id IN  NUMBER,
15:21:29 255  	out_amount    OUT NUMBER
15:21:29 256  );
15:21:29 257  
15:21:29 258  /*********************************************************/
15:21:29 259  
15:21:29 260  PROCEDURE RESERVE_TRANSACTION_ID (
15:21:29 261  /*
15:21:29 262  Throws exceptions:
15:21:29 263  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 264  */
15:21:29 265  	out_transaction_id OUT NUMBER
15:21:29 266  );
15:21:29 267  
15:21:29 268  /**********************************************************/
15:21:29 269  
15:21:29 270  PROCEDURE P_GET_NEXT_OFFER_INDEX (
15:21:29 271  	in_offer_chain_id	     IN NUMBER,
15:21:29 272  	in_offer_chain_current_index IN NUMBER,
15:21:29 273  	out_next_offer_index	     OUT NUMBER
15:21:29 274  );
15:21:29 275  
15:21:29 276  /***********************************************************/
15:21:29 277  
15:21:29 278  PROCEDURE GET_NEXT_OFFER_INDEX_BY_LCNS (
15:21:29 279  	in_license_id		     IN NUMBER,
15:21:29 280  	in_offer_chain_current_index IN NUMBER,
15:21:29 281  	out_next_offer_index	     OUT NUMBER
15:21:29 282  );
15:21:29 283  
15:21:29 284  /**********************************************************/
15:21:29 285  
15:21:29 286  PROCEDURE GET_SUBSCRIPTION_INFO (
15:21:29 287  /*
15:21:29 288  Throws exceptions:
15:21:29 289  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 290  */
15:21:29 291  	  in_subscription_id IN  NUMBER,
15:21:29 292  	  out_result_set      OUT SYS_REFCURSOR
15:21:29 293  );
15:21:29 294  
15:21:29 295  /***********************************************************/
15:21:29 296  
15:21:29 297  PROCEDURE CLOSE_SUBSCRIPTION (
15:21:29 298  	in_subscription_id IN NUMBER,
15:21:29 299  	in_updated_by	   IN VARCHAR2
15:21:29 300  );
15:21:29 301  
15:21:29 302  /***********************************************************/
15:21:29 303  
15:21:29 304  PROCEDURE GET_NEED_ENTITLEMENTS_LICENSES (
15:21:29 305  	out_result_set OUT SYS_REFCURSOR
15:21:29 306  );
15:21:29 307  
15:21:29 308  /***********************************************************/
15:21:29 309  
15:21:29 310  PROCEDURE UPDATE_NEED_ENTITLEMENTS_FLAG (
15:21:29 311  	in_license_id	      IN NUMBER,
15:21:29 312  	in_needs_entitlements IN NUMBER,
15:21:29 313  	in_updated_by	      IN VARCHAR2
15:21:29 314  );
15:21:29 315  /***********************************************************/
15:21:29 316  PROCEDURE GET_PROD_OFFERINGS_BY_OFFER_ID (
15:21:29 317  	in_offer_id    IN NUMBER,
15:21:29 318  	out_result_set OUT SYS_REFCURSOR
15:21:29 319  );
15:21:29 320  /***********************************************************/
15:21:29 321  PROCEDURE GET_PRODUCT_OFFERING_META_DATA (
15:21:29 322  	in_product_offering_id IN NUMBER,
15:21:29 323  	in_meta_data_name      IN VARCHAR2 DEFAULT NULL,
15:21:29 324  	out_result_set	       OUT SYS_REFCURSOR
15:21:29 325  );
15:21:29 326  
15:21:29 327  PROCEDURE LOCK_ACCOUNT (
15:21:29 328  	in_group_id    IN NUMBER,
15:21:29 329  	in_lock_key    IN VARCHAR2,
15:21:29 330  	in_seconds_num IN NUMBER,
15:21:29 331  	in_created_by  IN VARCHAR2,
15:21:29 332  	in_reason      IN VARCHAR2
15:21:29 333  );
15:21:29 334  
15:21:29 335  PROCEDURE RELEASE_LOCK (
15:21:29 336  	in_group_id IN NUMBER,
15:21:29 337  	in_lock_key IN VARCHAR2
15:21:29 338  );
15:21:29 339  
15:21:29 340  PROCEDURE GET_INVOICE_LINE_ITEMS (
15:21:29 341  	in_invoice_id  IN NUMBER,
15:21:29 342  	out_result_set OUT SYS_REFCURSOR
15:21:29 343  );
15:21:29 344  
15:21:29 345  PROCEDURE ADD_TAX (
15:21:29 346  	in_tax_type_id		 IN NUMBER,
15:21:29 347  	in_calculated_amount	 IN NUMBER,
15:21:29 348  	in_created_by		 IN VARCHAR2,
15:21:29 349  	in_line_item_id 	 IN NUMBER,
15:21:29 350  	in_effective_rate	 IN VARCHAR2,
15:21:29 351  	in_taxable_amount	 IN NUMBER,
15:21:29 352  	in_tax_rule_id		 IN NUMBER,
15:21:29 353  	in_jurisdiction_level_id IN NUMBER,
15:21:29 354  	in_jurisdiction_name	 IN VARCHAR2,
15:21:29 355  	in_jurisdiction_id	 IN VARCHAR2,
15:21:29 356  	in_ext_tax_type 	 IN VARCHAR2,
15:21:29 357  	in_ext_result		 IN VARCHAR2,
15:21:29 358  	in_imposition_type	 IN VARCHAR2,
15:21:29 359  	in_imposition		 IN VARCHAR2
15:21:29 360  );
15:21:29 361  
15:21:29 362  PROCEDURE GET_CREDIT_CARD_BY_ID (
15:21:29 363  	in_credit_card_id IN  NUMBER,
15:21:29 364  	out_result_set	  OUT SYS_REFCURSOR
15:21:29 365  );
15:21:29 366  
15:21:29 367  PROCEDURE GET_PRD_OFFERING_BY_LINE_IT_ID (
15:21:29 368  	in_line_item_id IN NUMBER,
15:21:29 369  	out_result_set	OUT SYS_REFCURSOR
15:21:29 370  );
15:21:29 371  
15:21:29 372  PROCEDURE GET_ACCOUNT_ID_BY_GROUP_ID (
15:21:29 373  /*
15:21:29 374  Throws exceptions:
15:21:29 375  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:29 376  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 377  */
15:21:29 378  	in_group_id IN NUMBER,
15:21:29 379  	out_account_id	OUT NUMBER
15:21:29 380  );
15:21:29 381  
15:21:29 382  PROCEDURE GET_LINE_ITEM_DISCOUNTS (
15:21:29 383  /*
15:21:29 384  Throws exceptions:
15:21:29 385  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:29 386  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 387  */
15:21:29 388  	in_line_item_id IN  NUMBER,
15:21:29 389  	out_result_set	OUT SYS_REFCURSOR
15:21:29 390  );
15:21:29 391  
15:21:29 392  PROCEDURE UPDATE_LINE_ITEM_AMOUNT (
15:21:29 393  	in_line_item_id    IN NUMBER,
15:21:29 394  	in_amount	   IN NUMBER,
15:21:29 395  	in_discount_amount IN NUMBER,
15:21:29 396  	in_taxes_amount    IN NUMBER
15:21:29 397  );
15:21:29 398  
15:21:29 399  PROCEDURE GET_PAYPAL_BY_ID (
15:21:29 400  	in_paypal_id   IN  NUMBER,
15:21:29 401  	out_result_set OUT SYS_REFCURSOR
15:21:29 402  );
15:21:29 403  
15:21:29 404  PROCEDURE GET_GC_BY_PURCH_INVOICE_ID (
15:21:29 405  	in_invoice_id		IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
15:21:29 406  	out_result_set OUT SYS_REFCURSOR
15:21:29 407  );
15:21:29 408  
15:21:29 409  PROCEDURE GET_LICENSE_BY_ID (
15:21:29 410  	in_license_id  IN NUMBER,
15:21:29 411  	out_result_set OUT SYS_REFCURSOR
15:21:29 412  );
15:21:29 413  
15:21:29 414  PROCEDURE GET_NOTIFICATION_TYPE_ID (
15:21:29 415  	in_offer_chain_id	 IN NUMBER,
15:21:29 416  	in_action_name		 IN VARCHAR2,
15:21:29 417  	out_notification_type_id OUT NUMBER
15:21:29 418  );
15:21:29 419  
15:21:29 420  PROCEDURE GET_OFFER_CHAIN_MD_VALUE (
15:21:29 421  	in_offer_chain_id IN NUMBER,
15:21:29 422  	in_meta_data_name IN VARCHAR2,
15:21:29 423  	out_value	  OUT VARCHAR2
15:21:29 424  );
15:21:29 425  
15:21:29 426  PROCEDURE GET_ACT_SUBS_W_CPT_CHARGEBACKS (
15:21:29 427  	out_result_set	    OUT SYS_REFCURSOR
15:21:29 428  );
15:21:29 429  
15:21:29 430  PROCEDURE GET_ACT_SUBS_W_PP_CHARGEBACKS (
15:21:29 431  	out_result_set	    OUT SYS_REFCURSOR
15:21:29 432  );
15:21:29 433  
15:21:29 434  PROCEDURE GET_ACT_SUBS_W_AMEX_CB (
15:21:29 435  	out_result_set	    OUT SYS_REFCURSOR
15:21:29 436  );
15:21:29 437  
15:21:29 438  PROCEDURE GET_GRACE_PERIOD_SUB_REGIS (
15:21:29 439  	in_max_days_until_close IN NUMBER,
15:21:29 440  	in_num_subs_to_fetch	IN NUMBER,
15:21:29 441  	out_result_set		OUT SYS_REFCURSOR
15:21:29 442  );
15:21:29 443  
15:21:29 444  PROCEDURE GET_GRACE_LICE_FOR_FINAL_TRANS (
15:21:29 445  	in_days_before_close	 IN NUMBER,
15:21:29 446  	in_num_licenses_to_fetch IN NUMBER,
15:21:29 447  	out_result_set		 OUT SYS_REFCURSOR
15:21:29 448  );
15:21:29 449  
15:21:29 450  END PUBLIC_PROCS_RENEWAL_V18;
15:21:29 451  .
15:21:29 SQL> /

Package created.

Elapsed: 00:00:00.05
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_ACCOUNT_CRU_V18" AS
15:21:29   2  
15:21:29   3  PROCEDURE CREATE_ACCOUNT (
15:21:29   4  	out_account_id	      OUT ACCOUNT.ID%TYPE,
15:21:29   5  	in_account_status_id  IN ACCOUNT.ACCOUNT_STATUS_ID%TYPE,
15:21:29   6  	in_suspend_date       IN ACCOUNT.SUSPEND_DATE%TYPE DEFAULT NULL,
15:21:29   7  	in_group_id	      IN ACCOUNT.GROUP_ID%TYPE,
15:21:29   8  	in_created_by	      IN ACCOUNT.CREATED_BY%TYPE,
15:21:29   9  	in_system_category_id IN ACCOUNT.SYSTEM_CATEGORY_ID%TYPE,
15:21:29  10  	in_instrument_type_id IN ACCOUNT.INSTRUMENT_TYPE_ID%TYPE DEFAULT NULL,
15:21:29  11  	in_instrument_id      IN ACCOUNT.INSTRUMENT_ID%TYPE DEFAULT NULL
15:21:29  12  ) AS
15:21:29  13  -- VARIABLES
15:21:29  14  var_new_account_id ACCOUNT.ID%TYPE;
15:21:29  15  -- arosolovskiy: using data variable instead of direct get data calls (#38860)
15:21:29  16  var_date DATE := SYSDATE;
15:21:29  17  BEGIN
15:21:29  18  	SELECT
15:21:29  19  	  ACC_ID_SEQ.nextVal into var_new_account_id
15:21:29  20  	FROM DUAL;
15:21:29  21  	INSERT INTO ACCOUNT (
15:21:29  22  	  ID,
15:21:29  23  	  ACCOUNT_STATUS_ID,
15:21:29  24  	  SUSPEND_DATE,
15:21:29  25  	  GROUP_ID,
15:21:29  26  	  CREATE_DATE,
15:21:29  27  	  CREATED_BY,
15:21:29  28  	  UPDATE_DATE,
15:21:29  29  	  UPDATED_BY,
15:21:29  30  	  SYSTEM_CATEGORY_ID,
15:21:29  31  	  INSTRUMENT_TYPE_ID,
15:21:29  32  	  INSTRUMENT_ID,
15:21:29  33  	  TAX_EXEMPT_ID
15:21:29  34  	) VALUES (
15:21:29  35  	  var_new_account_id,
15:21:29  36  	  in_account_status_id,
15:21:29  37  	  in_suspend_date,
15:21:29  38  	  in_group_id,
15:21:29  39  	  var_date,
15:21:29  40  	  in_created_by,
15:21:29  41  	  var_date,
15:21:29  42  	  in_created_by,
15:21:29  43  	  in_system_category_id,
15:21:29  44  	  in_instrument_type_id,
15:21:29  45  	  in_instrument_id,
15:21:29  46  	  NULL
15:21:29  47  	);
15:21:29  48  
15:21:29  49  	out_account_id := var_new_account_id;
15:21:29  50  END CREATE_ACCOUNT;
15:21:29  51  
15:21:29  52  /*************************************************************/
15:21:29  53  
15:21:29  54  PROCEDURE UPDATE_ACCOUNT (
15:21:29  55  	in_account_id	      IN ACCOUNT.ID%TYPE,
15:21:29  56  	in_account_status_id  IN ACCOUNT.ACCOUNT_STATUS_ID%TYPE DEFAULT NULL,
15:21:29  57  	in_suspend_date       IN ACCOUNT.SUSPEND_DATE%TYPE DEFAULT NULL,
15:21:29  58  	in_updated_by	      IN ACCOUNT.UPDATED_BY%TYPE,
15:21:29  59  	in_system_category_id IN ACCOUNT.SYSTEM_CATEGORY_ID%TYPE DEFAULT NULL,
15:21:29  60  	in_instrument_type_id IN ACCOUNT.INSTRUMENT_TYPE_ID%TYPE DEFAULT NULL,
15:21:29  61  	in_instrument_id      IN ACCOUNT.INSTRUMENT_ID%TYPE DEFAULT NULL
15:21:29  62  ) AS
15:21:29  63  BEGIN
15:21:29  64  
15:21:29  65  	-- CREATE HISTORY
15:21:29  66  	PROCS_HISTORY_V18.CREATE_ACCOUNT_HISTORY(
15:21:29  67  	  in_account_id 	       => in_account_id,
15:21:29  68  	  in_system_activity_reason_id => GLOBAL_ENUMS_V18.SAC_SYSTEM_APPLIED_RULE
15:21:29  69  	);
15:21:29  70  
15:21:29  71  	UPDATE ACCOUNT SET
15:21:29  72  	  ACCOUNT_STATUS_ID  = NVL(in_account_status_id, ACCOUNT_STATUS_ID),
15:21:29  73  	  SUSPEND_DATE	     = NVL(in_suspend_date, SUSPEND_DATE),
15:21:29  74  	  UPDATED_BY	     = in_updated_by,
15:21:29  75  	  UPDATE_DATE	     = SYSDATE,
15:21:29  76  	  SYSTEM_CATEGORY_ID = NVL(in_system_category_id, SYSTEM_CATEGORY_ID),
15:21:29  77  	  INSTRUMENT_TYPE_ID = NVL(in_instrument_type_id, INSTRUMENT_TYPE_ID),
15:21:29  78  	  INSTRUMENT_ID      = NVL(in_instrument_id, INSTRUMENT_ID)
15:21:29  79  	WHERE
15:21:29  80  	  ACCOUNT.ID = in_account_id;
15:21:29  81  
15:21:29  82  END UPDATE_ACCOUNT;
15:21:29  83  
15:21:29  84  /*************************************************************/
15:21:29  85  
15:21:29  86  PROCEDURE UPDATE_DEF_FIN_INSTRUMENT(
15:21:29  87  	in_account_id	      IN ACCOUNT.ID%TYPE,
15:21:29  88  	in_instrument_type_id IN ACCOUNT.INSTRUMENT_TYPE_ID%TYPE,
15:21:29  89  	in_instrument_id      IN ACCOUNT.INSTRUMENT_ID%TYPE,
15:21:29  90  	in_updated_by	      IN ACCOUNT.UPDATED_BY%TYPE
15:21:29  91  ) AS
15:21:29  92  BEGIN
15:21:29  93  
15:21:29  94  	-- CREATE HISTORY
15:21:29  95  	PROCS_HISTORY_V18.CREATE_ACCOUNT_HISTORY(
15:21:29  96  	  in_account_id 	       => in_account_id,
15:21:29  97  	  in_system_activity_reason_id => GLOBAL_ENUMS_V18.SAC_SYSTEM_APPLIED_RULE
15:21:29  98  	);
15:21:29  99  
15:21:29 100  	UPDATE ACCOUNT SET
15:21:29 101  	  INSTRUMENT_TYPE_ID = in_instrument_type_id,
15:21:29 102  	  INSTRUMENT_ID      = in_instrument_id
15:21:29 103  	WHERE
15:21:29 104  	  ACCOUNT.ID = in_account_id;
15:21:29 105  
15:21:29 106  END;
15:21:29 107  
15:21:29 108  /*************************************************************/
15:21:29 109  
15:21:29 110  PROCEDURE READ_ACCOUNT (
15:21:29 111  	in_account_id  IN ACCOUNT.ID%TYPE,
15:21:29 112  	out_result_set OUT SYS_REFCURSOR
15:21:29 113  ) AS
15:21:29 114  BEGIN
15:21:29 115  	OPEN out_result_set FOR
15:21:29 116  	SELECT
15:21:29 117  	  ACCOUNT_STATUS_ID,
15:21:29 118  	  SUSPEND_DATE,
15:21:29 119  	  GROUP_ID
15:21:29 120  	FROM
15:21:29 121  	  ACCOUNT
15:21:29 122  	WHERE
15:21:29 123  	  ID = in_account_id;
15:21:29 124  END READ_ACCOUNT;
15:21:29 125  
15:21:29 126  /*************************************************************/
15:21:29 127  
15:21:29 128  PROCEDURE CREATE_ACCOUNT_NOTE (
15:21:29 129  	inout_account_note_id IN OUT ACCOUNT_NOTE.ID%TYPE,
15:21:29 130  	in_agent_id	      IN ACCOUNT_NOTE.AGENT_ID%TYPE,
15:21:29 131  	in_account_id	      IN ACCOUNT_NOTE.ACCOUNT_ID%TYPE,
15:21:29 132  	in_note 	      IN ACCOUNT_NOTE.NOTE%TYPE,
15:21:29 133  	in_created_by	      IN ACCOUNT_NOTE.CREATED_BY%TYPE
15:21:29 134  ) AS
15:21:29 135  BEGIN
15:21:29 136  	IF inout_account_note_id IS NULL THEN
15:21:29 137  	  SELECT
15:21:29 138  	    ACCN_ID_SEQ.nextVal into inout_account_note_id
15:21:29 139  	  FROM DUAL;
15:21:29 140  	END IF;
15:21:29 141  	INSERT INTO ACCOUNT_NOTE(
15:21:29 142  	  ID,
15:21:29 143  	  AGENT_ID,
15:21:29 144  	  ACCOUNT_ID,
15:21:29 145  	  NOTE,
15:21:29 146  	  CREATE_DATE,
15:21:29 147  	  CREATED_BY
15:21:29 148  	) VALUES (
15:21:29 149  	  inout_account_note_id,
15:21:29 150  	  in_agent_id,
15:21:29 151  	  in_account_id,
15:21:29 152  	  in_note,
15:21:29 153  	  SYSDATE,
15:21:29 154  	  in_created_by
15:21:29 155  	);
15:21:29 156  END CREATE_ACCOUNT_NOTE;
15:21:29 157  
15:21:29 158  END PROCS_ACCOUNT_CRU_V18;
15:21:29 159  .
15:21:29 SQL> /

Package body created.

Elapsed: 00:00:00.02
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_ADDRESS_CRU_V18" AS
15:21:29   2  
15:21:29   3  PROCEDURE CREATE_ADDRESS(
15:21:29   4  	out_address_id	      OUT ADDRESS.ID%TYPE,
15:21:29   5  	in_address_id	      IN ADDRESS.ID%TYPE DEFAULT NULL,
15:21:29   6  	in_address1	      IN ADDRESS.ADDRESS1%TYPE DEFAULT NULL,
15:21:29   7  	in_address2	      IN ADDRESS.ADDRESS2%TYPE DEFAULT NULL,
15:21:29   8  	in_city 	      IN ADDRESS.CITY%TYPE DEFAULT NULL,
15:21:29   9  	in_state	      IN ADDRESS.STATE%TYPE DEFAULT NULL,
15:21:29  10  	in_postal_code	      IN ADDRESS.POSTAL_CODE%TYPE DEFAULT NULL,
15:21:29  11  	in_country	      IN ADDRESS.COUNTRY%TYPE DEFAULT NULL,
15:21:29  12  	in_created_by	      IN ADDRESS.CREATED_BY%TYPE
15:21:29  13  ) AS
15:21:29  14  -- VARIABLES
15:21:29  15  var_address_id ADDRESS.ID%TYPE;
15:21:29  16  var_date DATE := SYSDATE;
15:21:29  17  BEGIN
15:21:29  18  	IF in_address_id IS NULL THEN
15:21:29  19  	  SELECT
15:21:29  20  	    ADDRESS_ID_SEQ.nextVal into var_address_id
15:21:29  21  	  FROM DUAL;
15:21:29  22  	ELSE
15:21:29  23  	  var_address_id := in_address_id;
15:21:29  24  	END IF;
15:21:29  25  	INSERT INTO
15:21:29  26  	  ADDRESS (
15:21:29  27  	    ID,
15:21:29  28  	    ADDRESS1,
15:21:29  29  	    ADDRESS2,
15:21:29  30  	    CITY,
15:21:29  31  	    STATE,
15:21:29  32  	    POSTAL_CODE,
15:21:29  33  	    COUNTRY,
15:21:29  34  	    CREATE_DATE,
15:21:29  35  	    CREATED_BY,
15:21:29  36  	    UPDATE_DATE,
15:21:29  37  	    UPDATED_BY
15:21:29  38  	  ) VALUES (
15:21:29  39  	    var_address_id,
15:21:29  40  	    in_address1,
15:21:29  41  	    in_address2,
15:21:29  42  	    in_city,
15:21:29  43  	    in_state,
15:21:29  44  	    in_postal_code,
15:21:29  45  	    in_country,
15:21:29  46  	    var_date,
15:21:29  47  	    in_created_by,
15:21:29  48  	    var_date,
15:21:29  49  	    in_created_by
15:21:29  50  	  );
15:21:29  51  
15:21:29  52  	out_address_id := var_address_id;
15:21:29  53  END CREATE_ADDRESS;
15:21:29  54  
15:21:29  55  PROCEDURE UPDATE_ADDRESS(
15:21:29  56  	in_address_id	      IN ADDRESS.ID%TYPE,
15:21:29  57  	in_address1	      IN ADDRESS.ADDRESS1%TYPE DEFAULT NULL,
15:21:29  58  	in_address2	      IN ADDRESS.ADDRESS2%TYPE DEFAULT NULL,
15:21:29  59  	in_city 	      IN ADDRESS.CITY%TYPE DEFAULT NULL,
15:21:29  60  	in_state	      IN ADDRESS.STATE%TYPE DEFAULT NULL,
15:21:29  61  	in_postal_code	      IN ADDRESS.POSTAL_CODE%TYPE DEFAULT NULL,
15:21:29  62  	in_country	      IN ADDRESS.COUNTRY%TYPE DEFAULT NULL,
15:21:29  63  	in_updated_by	      IN ADDRESS.UPDATED_BY%TYPE
15:21:29  64  ) AS
15:21:29  65  BEGIN
15:21:29  66  
15:21:29  67  	-- Create history
15:21:29  68  	PROCS_HISTORY_V18.CREATE_ADDRESS_HISTORY(
15:21:29  69  	  in_address_id 		=> in_address_id,
15:21:29  70  	  in_system_activity_reason_id => GLOBAL_ENUMS_V18.SAC_SYSTEM_APPLIED_RULE
15:21:29  71  	);
15:21:29  72  
15:21:29  73  	UPDATE
15:21:29  74  	  ADDRESS
15:21:29  75  	SET
15:21:29  76  	  ADDRESS1 = NVL(in_address1, ADDRESS1),
15:21:29  77  	  ADDRESS2 = NVL(in_address2, ADDRESS2),
15:21:29  78  	  CITY = NVL(in_city, CITY),
15:21:29  79  	  STATE = NVL(in_state, STATE),
15:21:29  80  	  POSTAL_CODE = NVL(in_postal_code, POSTAL_CODE),
15:21:29  81  	  COUNTRY = NVL(in_country, COUNTRY),
15:21:29  82  	  UPDATE_DATE = SYSDATE,
15:21:29  83  	  UPDATED_BY = in_updated_by
15:21:29  84  	WHERE
15:21:29  85  	  ID = in_address_id;
15:21:29  86  
15:21:29  87  END UPDATE_ADDRESS;
15:21:29  88  
15:21:29  89  END PROCS_ADDRESS_CRU_V18;
15:21:29  90  .
15:21:29 SQL> /

Package body created.

Elapsed: 00:00:00.02
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_AMAZON_CRU_V18" AS
15:21:29   2  
15:21:29   3  PROCEDURE CREATE_AMAZON_SUB(
15:21:29   4  /*
15:21:29   5  Throws exceptions:
15:21:29   6  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29   7  */
15:21:29   8  	  out_id	      OUT NUMBER,
15:21:29   9  	  in_subscription_id  IN AMAZON_SUB.SUBSCRIPTION_ID%TYPE,
15:21:29  10  	  in_amazon_id	      IN AMAZON_SUB.AMAZON_ID%TYPE,
15:21:29  11  	  in_created_by       IN AMAZON_SUB.CREATED_BY%TYPE
15:21:29  12  ) AS
15:21:29  13  -- VARIABLES
15:21:29  14  SPROC_NAME	CONSTANT VARCHAR2(32) := 'CREATE_AMAZON_SUB';
15:21:29  15  var_current_date	DATE;
15:21:29  16  var_count 	NUMBER;
15:21:29  17  AMAZON_SUB_USED	EXCEPTION;
15:21:29  18  BEGIN
15:21:29  19  
15:21:29  20  	SELECT COUNT(1) INTO var_count
15:21:29  21  	FROM SUBSCRIPTION s, AMAZON_SUB am
15:21:29  22  	WHERE
15:21:29  23  	  am.AMAZON_ID = in_amazon_id
15:21:29  24  	  and am.subscription_id = s.id
15:21:29  25  	  and s.subscription_status_id = GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE;
15:21:29  26  
15:21:29  27  	if var_count > 0 then
15:21:29  28  	  raise AMAZON_SUB_USED;
15:21:29  29  	end if;
15:21:29  30  
15:21:29  31  	SELECT
15:21:29  32  	  CORE_OWNER.AMAZON_SUB_ID_SEQ.NEXTVAL
15:21:29  33  	INTO
15:21:29  34  	  out_id
15:21:29  35  	FROM
15:21:29  36  	  dual
15:21:29  37  	;
15:21:29  38  
15:21:29  39  	SELECT
15:21:29  40  	  sysdate
15:21:29  41  	INTO
15:21:29  42  	  var_current_date
15:21:29  43  	FROM
15:21:29  44  	  dual
15:21:29  45  	;
15:21:29  46  
15:21:29  47  	INSERT INTO CORE_OWNER.AMAZON_SUB
15:21:29  48  	(
15:21:29  49  	  id,
15:21:29  50  	  subscription_id,
15:21:29  51  	  amazon_id,
15:21:29  52  	  create_date,
15:21:29  53  	  created_by,
15:21:29  54  	  update_date,
15:21:29  55  	  updated_by
15:21:29  56  	)
15:21:29  57  	VALUES
15:21:29  58  	(
15:21:29  59  	  out_id,
15:21:29  60  	  in_subscription_id,
15:21:29  61  	  in_amazon_id,
15:21:29  62  	  var_current_date,
15:21:29  63  	  in_created_by,
15:21:29  64  	  var_current_date,
15:21:29  65  	  in_created_by
15:21:29  66  	);
15:21:29  67  
15:21:29  68  EXCEPTION
15:21:29  69  WHEN AMAZON_SUB_USED THEN
15:21:29  70  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.DUPLICATE_ERROR,
15:21:29  71  	  SPROC_NAME, 'Amazon sub already used', SQLERRM);
15:21:29  72  WHEN DUP_VAL_ON_INDEX THEN
15:21:29  73  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.DUPLICATE_ERROR,
15:21:29  74  	  SPROC_NAME, 'Duplicate value', SQLERRM);
15:21:29  75  WHEN OTHERS THEN
15:21:29  76  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:29  77  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:29  78  END CREATE_AMAZON_SUB;
15:21:29  79  
15:21:29  80  END PROCS_AMAZON_CRU_V18;
15:21:29  81  .
15:21:29 SQL> /

Package body created.

Elapsed: 00:00:00.02
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_CHARGE_CRU_V18" AS
15:21:29   2  
15:21:29   3  PROCEDURE CREATE_CHARGE(
15:21:29   4  	out_charge_id	      OUT CHARGE.ID%TYPE,
15:21:29   5  	in_charge_id	      IN CHARGE.ID%TYPE DEFAULT NULL,
15:21:29   6  	in_invoice_id	      IN CHARGE.INVOICE_ID%TYPE,
15:21:29   7  	in_transaction_id     IN CHARGE.TRANSACTION_ID%TYPE DEFAULT NULL,
15:21:29   8  	in_instrument_type_id IN CHARGE.INSTRUMENT_TYPE_ID%TYPE,
15:21:29   9  	in_instrument_id      IN CHARGE.INSTRUMENT_ID%TYPE,
15:21:29  10  	in_charge_amount      IN CHARGE.CHARGE_AMOUNT%TYPE,
15:21:29  11  	in_charge_status_id   IN CHARGE.CHARGE_STATUS_ID%TYPE,
15:21:29  12  	in_created_by	      IN CHARGE.CREATED_BY%TYPE
15:21:29  13  ) AS
15:21:29  14  -- VARIABLES
15:21:29  15  var_charge_id CHARGE.ID%TYPE;
15:21:29  16  -- arosolovskiy: using data variable instead of direct get data calls (#38860)
15:21:29  17  var_date DATE := SYSDATE;
15:21:29  18  BEGIN
15:21:29  19  	IF in_charge_id IS NULL THEN
15:21:29  20  	  SELECT
15:21:29  21  	    CRG_ID_SEQ.nextVal into var_charge_id
15:21:29  22  	  FROM DUAL;
15:21:29  23  	ELSE
15:21:29  24  	  var_charge_id := in_charge_id;
15:21:29  25  	END IF;
15:21:29  26  	INSERT INTO
15:21:29  27  	  CHARGE (
15:21:29  28  	    ID,
15:21:29  29  	    INVOICE_ID,
15:21:29  30  	    TRANSACTION_ID,
15:21:29  31  	    INSTRUMENT_TYPE_ID,
15:21:29  32  	    INSTRUMENT_ID,
15:21:29  33  	    CHARGE_AMOUNT,
15:21:29  34  	    CHARGE_STATUS_ID,
15:21:29  35  	    CREATE_DATE,
15:21:29  36  	    CREATED_BY,
15:21:29  37  	    UPDATE_DATE,
15:21:29  38  	    UPDATED_BY
15:21:29  39  	  ) VALUES (
15:21:29  40  	    var_charge_id,
15:21:29  41  	    in_invoice_id,
15:21:29  42  	    in_transaction_id,
15:21:29  43  	    in_instrument_type_id,
15:21:29  44  	    in_instrument_id,
15:21:29  45  	    in_charge_amount,
15:21:29  46  	    in_charge_status_id,
15:21:29  47  	    var_date,
15:21:29  48  	    in_created_by,
15:21:29  49  	    var_date,
15:21:29  50  	    in_created_by
15:21:29  51  	  );
15:21:29  52  
15:21:29  53  	out_charge_id := var_charge_id;
15:21:29  54  END CREATE_CHARGE;
15:21:29  55  
15:21:29  56  PROCEDURE UPDATE_CHARGE(
15:21:29  57  	in_charge_id	      IN CHARGE.ID%TYPE,
15:21:29  58  	in_instrument_type_id IN CHARGE.INSTRUMENT_TYPE_ID%TYPE DEFAULT NULL,
15:21:29  59  	in_instrument_id      IN CHARGE.INSTRUMENT_ID%TYPE DEFAULT NULL,
15:21:29  60  	in_charge_amount      IN CHARGE.CHARGE_AMOUNT%TYPE DEFAULT NULL,
15:21:29  61  	in_charge_status_id   IN CHARGE.CHARGE_STATUS_ID%TYPE DEFAULT NULL,
15:21:29  62  	in_updated_by	      IN CHARGE.UPDATED_BY%TYPE
15:21:29  63  ) AS
15:21:29  64  BEGIN
15:21:29  65  
15:21:29  66  	-- Create history
15:21:29  67  	PROCS_HISTORY_V18.CREATE_CHARGE_HISTORY(
15:21:29  68  	  in_charge_id		       => in_charge_id,
15:21:29  69  	  in_system_activity_reason_id => GLOBAL_ENUMS_V18.SAC_SYSTEM_APPLIED_RULE
15:21:29  70  	);
15:21:29  71  
15:21:29  72  	UPDATE
15:21:29  73  	  CHARGE
15:21:29  74  	SET
15:21:29  75  	  INSTRUMENT_TYPE_ID = NVL(in_instrument_type_id, INSTRUMENT_TYPE_ID),
15:21:29  76  	  INSTRUMENT_ID      = NVL(in_instrument_id, INSTRUMENT_ID),
15:21:29  77  	  CHARGE_AMOUNT      = NVL(in_charge_amount, CHARGE_AMOUNT),
15:21:29  78  	  CHARGE_STATUS_ID   = NVL(in_charge_status_id, CHARGE_STATUS_ID),
15:21:29  79  	  UPDATE_DATE	     = SYSDATE,
15:21:29  80  	  UPDATED_BY	     = in_updated_by
15:21:29  81  	WHERE
15:21:29  82  	  ID = in_charge_id;
15:21:29  83  
15:21:29  84  END UPDATE_CHARGE;
15:21:29  85  
15:21:29  86  END PROCS_CHARGE_CRU_V18;
15:21:29  87  .
15:21:29 SQL> /

Package body created.

Elapsed: 00:00:00.02
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_FIN_INSTRUMENTS_CRU_V18" AS
15:21:29   2  
15:21:29   3  PROCEDURE CREATE_CREDIT_CARD(
15:21:29   4  	out_credit_card_id	    OUT CREDIT_CARD.ID%TYPE,
15:21:29   5  	in_credit_card_id	    IN CREDIT_CARD.ID%TYPE DEFAULT NULL,
15:21:29   6  	in_account_id		    IN CREDIT_CARD.ACCOUNT_ID%TYPE,
15:21:29   7  	in_instrument_name	    IN CREDIT_CARD.INSTRUMENT_NAME%TYPE,
15:21:29   8  	in_private_card_holder_name IN CREDIT_CARD.PRIVATE_CARD_HOLDER_NAME%TYPE,
15:21:29   9  	in_private_street_address   IN CREDIT_CARD.PRIVATE_STREET_ADDRESS%TYPE,
15:21:29  10  	in_private_street_address2  IN CREDIT_CARD.PRIVATE_STREET_ADDRESS2%TYPE DEFAULT NULL,
15:21:29  11  	in_state		    IN CREDIT_CARD.STATE%TYPE,
15:21:29  12  	in_city 		    IN CREDIT_CARD.CITY%TYPE,
15:21:29  13  	in_postal_code		    IN CREDIT_CARD.POSTAL_CODE%TYPE,
15:21:29  14  	in_country		    IN CREDIT_CARD.COUNTRY%TYPE,
15:21:29  15  	in_last_four_cc 	    IN CREDIT_CARD.LAST_FOUR_CC%TYPE,
15:21:29  16  	in_expiration_date	    IN CREDIT_CARD.EXPIRATION_DATE%TYPE,
15:21:29  17  	in_credit_card_type_id	    IN CREDIT_CARD.CREDIT_CARD_TYPE_ID%TYPE,
15:21:29  18  	in_secret_token 	    IN CREDIT_CARD.SECRET_TOKEN%TYPE,
15:21:29  19  	in_chase_profile_id		in CREDIT_CARD.CHASE_PROFILE_ID%TYPE,
15:21:29  20  	in_created_by		    IN CREDIT_CARD.CREATED_BY%TYPE,
15:21:29  21  	in_credit_card_status_id    IN CREDIT_CARD.CREDIT_CARD_STATUS_ID%TYPE,
15:21:29  22  	in_private_first_name	    IN CREDIT_CARD.PRIVATE_FIRST_NAME%TYPE,
15:21:29  23  	in_private_last_name	    IN CREDIT_CARD.PRIVATE_LAST_NAME%TYPE
15:21:29  24  ) AS
15:21:29  25  -- VARIABLES
15:21:29  26  var_credit_card_id CREDIT_CARD.ID%TYPE;
15:21:29  27  -- arosolovskiy: using data variable instead of direct get data calls (#38860)
15:21:29  28  var_date DATE := SYSDATE;
15:21:29  29  BEGIN
15:21:29  30  	IF in_credit_card_id IS NULL THEN
15:21:29  31  	  SELECT
15:21:29  32  	    CC_ID_SEQ.nextVal into var_credit_card_id
15:21:29  33  	  FROM DUAL;
15:21:29  34  	ELSE
15:21:29  35  	  var_credit_card_id := in_credit_card_id;
15:21:29  36  	END IF;
15:21:29  37  	INSERT INTO CREDIT_CARD(
15:21:29  38  	    ID,
15:21:29  39  	    ACCOUNT_ID,
15:21:29  40  	    INSTRUMENT_NAME,
15:21:29  41  	    PRIVATE_CARD_HOLDER_NAME,
15:21:29  42  	    PRIVATE_STREET_ADDRESS,
15:21:29  43  	    PRIVATE_STREET_ADDRESS2,
15:21:29  44  	    STATE,
15:21:29  45  	    CITY,
15:21:29  46  	    POSTAL_CODE,
15:21:29  47  	    COUNTRY,
15:21:29  48  	    LAST_FOUR_CC,
15:21:29  49  	    EXPIRATION_DATE,
15:21:29  50  	    CREDIT_CARD_TYPE_ID,
15:21:29  51  	    SECRET_TOKEN,
15:21:29  52  	    CHASE_PROFILE_ID,
15:21:29  53  	    CREATE_DATE,
15:21:29  54  	    CREATED_BY,
15:21:29  55  	    UPDATE_DATE,
15:21:29  56  	    UPDATED_BY,
15:21:29  57  	    CREDIT_CARD_STATUS_ID,
15:21:29  58  	    PRIVATE_FIRST_NAME,
15:21:29  59  	    PRIVATE_LAST_NAME
15:21:29  60  	  ) VALUES (
15:21:29  61  	    var_credit_card_id,
15:21:29  62  	    in_account_id,
15:21:29  63  	    in_instrument_name,
15:21:29  64  	    in_private_card_holder_name,
15:21:29  65  	    in_private_street_address,
15:21:29  66  	    in_private_street_address2,
15:21:29  67  	    in_state,
15:21:29  68  	    in_city,
15:21:29  69  	    in_postal_code,
15:21:29  70  	    in_country,
15:21:29  71  	    in_last_four_cc,
15:21:29  72  	    in_expiration_date,
15:21:29  73  	    in_credit_card_type_id,
15:21:29  74  	    in_secret_token,
15:21:29  75  	    in_chase_profile_id,
15:21:29  76  	    var_date,
15:21:29  77  	    in_created_by,
15:21:29  78  	    var_date,
15:21:29  79  	    in_created_by,
15:21:29  80  	    in_credit_card_status_id,
15:21:29  81  	    in_private_first_name,
15:21:29  82  	    in_private_last_name
15:21:29  83  	  );
15:21:29  84  
15:21:29  85  	out_credit_card_id := var_credit_card_id;
15:21:29  86  END CREATE_CREDIT_CARD;
15:21:29  87  
15:21:29  88  /******************************************************************************/
15:21:29  89  
15:21:29  90  PROCEDURE UPDATE_CREDIT_CARD(
15:21:29  91  	in_credit_card_id	    IN CREDIT_CARD.ID%TYPE,
15:21:29  92  	in_instrument_name	    IN CREDIT_CARD.INSTRUMENT_NAME%TYPE DEFAULT NULL,
15:21:29  93  	in_private_card_holder_name IN CREDIT_CARD.PRIVATE_CARD_HOLDER_NAME%TYPE DEFAULT NULL,
15:21:29  94  	in_private_street_address   IN CREDIT_CARD.PRIVATE_STREET_ADDRESS%TYPE DEFAULT NULL,
15:21:29  95  	in_private_street_address2  IN CREDIT_CARD.PRIVATE_STREET_ADDRESS2%TYPE DEFAULT NULL,
15:21:29  96  	in_state		    IN CREDIT_CARD.STATE%TYPE DEFAULT NULL,
15:21:29  97  	in_city 		    IN CREDIT_CARD.CITY%TYPE DEFAULT NULL,
15:21:29  98  	in_postal_code		    IN CREDIT_CARD.POSTAL_CODE%TYPE DEFAULT NULL,
15:21:29  99  	in_country		    IN CREDIT_CARD.COUNTRY%TYPE DEFAULT NULL,
15:21:29 100  	in_last_four_cc 	    IN CREDIT_CARD.LAST_FOUR_CC%TYPE DEFAULT NULL,
15:21:29 101  	in_expiration_date	    IN CREDIT_CARD.EXPIRATION_DATE%TYPE DEFAULT NULL,
15:21:29 102  	in_credit_card_type_id	    IN CREDIT_CARD.CREDIT_CARD_TYPE_ID%TYPE DEFAULT NULL,
15:21:29 103  	in_secret_token 	    IN CREDIT_CARD.SECRET_TOKEN%TYPE DEFAULT NULL,
15:21:29 104  	in_chase_profile_id	    IN CREDIT_CARD.CHASE_PROFILE_ID%TYPE DEFAULT NULL,
15:21:29 105  	in_updated_by		    IN CREDIT_CARD.UPDATED_BY%TYPE,
15:21:29 106  	in_credit_card_status_id    IN CREDIT_CARD.CREDIT_CARD_STATUS_ID%TYPE DEFAULT NULL,
15:21:29 107  	in_private_first_name	    IN CREDIT_CARD.PRIVATE_FIRST_NAME%TYPE DEFAULT NULL,
15:21:29 108  	in_private_last_name	    IN CREDIT_CARD.PRIVATE_LAST_NAME%TYPE DEFAULT NULL
15:21:29 109  ) AS
15:21:29 110  BEGIN
15:21:29 111  
15:21:29 112  	-- Create history
15:21:29 113  	PROCS_HISTORY_V18.CREATE_CREDIT_CARD_HISTORY(
15:21:29 114  	  in_credit_card_id	       => in_credit_card_id,
15:21:29 115  	  in_system_activity_reason_id => GLOBAL_ENUMS_V18.SAC_SYSTEM_APPLIED_RULE
15:21:29 116  	);
15:21:29 117  
15:21:29 118  	UPDATE CREDIT_CARD SET
15:21:29 119  	  INSTRUMENT_NAME	   = NVL(in_instrument_name, INSTRUMENT_NAME),
15:21:29 120  	  PRIVATE_CARD_HOLDER_NAME = NVL(in_private_card_holder_name, PRIVATE_CARD_HOLDER_NAME),
15:21:29 121  	  PRIVATE_STREET_ADDRESS   = NVL(in_private_street_address, PRIVATE_STREET_ADDRESS),
15:21:29 122  	  PRIVATE_STREET_ADDRESS2  = NVL(in_private_street_address, PRIVATE_STREET_ADDRESS2),
15:21:29 123  	  STATE 		   = NVL(in_state, STATE),
15:21:29 124  	  CITY			   = NVL(in_city, CITY),
15:21:29 125  	  POSTAL_CODE		   = NVL(in_postal_code, POSTAL_CODE),
15:21:29 126  	  COUNTRY		   = NVL(in_country, COUNTRY),
15:21:29 127  	  LAST_FOUR_CC		   = NVL(in_last_four_cc, LAST_FOUR_CC),
15:21:29 128  	  EXPIRATION_DATE	   = NVL(in_expiration_date, EXPIRATION_DATE),
15:21:29 129  	  CREDIT_CARD_TYPE_ID	   = NVL(in_credit_card_type_id, CREDIT_CARD_TYPE_ID),
15:21:29 130  	  SECRET_TOKEN		   = NVL(in_secret_token, SECRET_TOKEN),
15:21:29 131  	  CHASE_PROFILE_ID	   = NVL(in_chase_profile_id, CHASE_PROFILE_ID),
15:21:29 132  	  UPDATE_DATE		   = SYSDATE,
15:21:29 133  	  UPDATED_BY		   = in_updated_by,
15:21:29 134  	  CREDIT_CARD_STATUS_ID    = NVL(in_credit_card_status_id, CREDIT_CARD_STATUS_ID),
15:21:29 135  	  PRIVATE_FIRST_NAME	   = NVL(in_private_first_name, PRIVATE_FIRST_NAME),
15:21:29 136  	  PRIVATE_LAST_NAME	   = NVL(in_private_last_name, PRIVATE_LAST_NAME)
15:21:29 137  	WHERE
15:21:29 138  	  ID = in_credit_card_id;
15:21:29 139  
15:21:29 140  END UPDATE_CREDIT_CARD;
15:21:29 141  
15:21:29 142  /******************************************************************************/
15:21:29 143  
15:21:29 144  PROCEDURE CREATE_PAYPAL(
15:21:29 145  	out_paypal_id			OUT PAYPAL.ID%TYPE,
15:21:29 146  	in_paypal_id			IN PAYPAL.ID%TYPE DEFAULT NULL,
15:21:29 147  	in_account_id			IN PAYPAL.ACCOUNT_ID%TYPE,
15:21:29 148  	in_instrument_name		IN PAYPAL.INSTRUMENT_NAME%TYPE DEFAULT NULL,
15:21:29 149  	in_private_email_address	IN PAYPAL.PRIVATE_EMAIL_ADDRESS%TYPE DEFAULT NULL,
15:21:29 150  	in_created_by			IN PAYPAL.CREATED_BY%TYPE,
15:21:29 151  	in_paypal_status_id		IN PAYPAL.PAYPAL_STATUS_ID%TYPE,
15:21:29 152  	in_paypal_prvt_street_address	IN PAYPAL.PRIVATE_STREET_ADDRESS%TYPE,
15:21:29 153  	in_paypal_prvt_street_address2	IN PAYPAL.PRIVATE_STREET_ADDRESS%TYPE,
15:21:29 154  	in_state			IN PAYPAL.STATE%TYPE,
15:21:29 155  	in_city 			IN PAYPAL.CITY%TYPE,
15:21:29 156  	in_postal_code			IN PAYPAL.POSTAL_CODE%TYPE,
15:21:29 157  	in_country			IN PAYPAL.COUNTRY%TYPE,
15:21:29 158  	in_expiration_date		IN PAYPAL.EXPIRATION_DATE%TYPE,
15:21:29 159  	in_secret_token 		IN PAYPAL.SECRET_TOKEN%TYPE
15:21:29 160  ) AS
15:21:29 161  -- VARIABLES
15:21:29 162  var_paypal_id PAYPAL.ID%TYPE;
15:21:29 163  -- arosolovskiy: using data variable instead of direct get data calls (#38860)
15:21:29 164  var_date DATE := SYSDATE;
15:21:29 165  BEGIN
15:21:29 166  	IF in_paypal_id IS NULL THEN
15:21:29 167  	  SELECT
15:21:29 168  	    PP_ID_SEQ.nextVal into var_paypal_id
15:21:29 169  	  FROM DUAL;
15:21:29 170  	ELSE
15:21:29 171  	  var_paypal_id := in_paypal_id;
15:21:29 172  	END IF;
15:21:29 173  	INSERT INTO PAYPAL(
15:21:29 174  	    ID,
15:21:29 175  	    ACCOUNT_ID,
15:21:29 176  	    INSTRUMENT_NAME,
15:21:29 177  	    PRIVATE_EMAIL_ADDRESS,
15:21:29 178  	    CREATE_DATE,
15:21:29 179  	    CREATED_BY,
15:21:29 180  	    UPDATE_DATE,
15:21:29 181  	    UPDATED_BY,
15:21:29 182  	    PAYPAL_STATUS_ID,
15:21:29 183  	    PRIVATE_STREET_ADDRESS,
15:21:29 184  	    PRIVATE_STREET_ADDRESS2,
15:21:29 185  	    STATE,
15:21:29 186  	    CITY,
15:21:29 187  	    POSTAL_CODE,
15:21:29 188  	    COUNTRY,
15:21:29 189  	    EXPIRATION_DATE,
15:21:29 190  	    SECRET_TOKEN
15:21:29 191  	  ) VALUES (
15:21:29 192  	    var_paypal_id,
15:21:29 193  	    in_account_id,
15:21:29 194  	    in_instrument_name,
15:21:29 195  	    in_private_email_address,
15:21:29 196  	    var_date,
15:21:29 197  	    in_created_by,
15:21:29 198  	    var_date,
15:21:29 199  	    in_created_by,
15:21:29 200  	    in_paypal_status_id,
15:21:29 201  	    in_paypal_prvt_street_address,
15:21:29 202  	    in_paypal_prvt_street_address2,
15:21:29 203  	    in_state,
15:21:29 204  	    in_city,
15:21:29 205  	    in_postal_code,
15:21:29 206  	    in_country,
15:21:29 207  	    in_expiration_date,
15:21:29 208  	    in_secret_token
15:21:29 209  	  );
15:21:29 210  	out_paypal_id := var_paypal_id;
15:21:29 211  END CREATE_PAYPAL;
15:21:29 212  
15:21:29 213  /******************************************************************************/
15:21:29 214  
15:21:29 215  PROCEDURE UPDATE_PAYPAL(
15:21:29 216  	in_paypal_id			IN PAYPAL.ID%TYPE,
15:21:29 217  	in_instrument_name		IN PAYPAL.INSTRUMENT_NAME%TYPE DEFAULT NULL,
15:21:29 218  	in_private_email_address	IN PAYPAL.PRIVATE_EMAIL_ADDRESS%TYPE DEFAULT NULL,
15:21:29 219  	in_updated_by			IN PAYPAL.UPDATED_BY%TYPE,
15:21:29 220  	in_paypal_status_id		IN PAYPAL.PAYPAL_STATUS_ID%TYPE DEFAULT NULL,
15:21:29 221  	in_paypal_prvt_street_address	IN PAYPAL.PRIVATE_STREET_ADDRESS%TYPE DEFAULT NULL,
15:21:29 222  	in_paypal_prvt_street_address2	IN PAYPAL.PRIVATE_STREET_ADDRESS%TYPE DEFAULT NULL,
15:21:29 223  	in_state			IN PAYPAL.STATE%TYPE DEFAULT NULL,
15:21:29 224  	in_city 			IN PAYPAL.CITY%TYPE DEFAULT NULL,
15:21:29 225  	in_postal_code			IN PAYPAL.POSTAL_CODE%TYPE DEFAULT NULL,
15:21:29 226  	in_country			IN PAYPAL.COUNTRY%TYPE DEFAULT NULL,
15:21:29 227  	in_expiration_date		IN PAYPAL.EXPIRATION_DATE%TYPE DEFAULT NULL,
15:21:29 228  	in_secret_token 		IN PAYPAL.SECRET_TOKEN%TYPE
15:21:29 229  ) AS
15:21:29 230  BEGIN
15:21:29 231  	-- Create history
15:21:29 232  	PROCS_HISTORY_V18.CREATE_PAYPAL_HISTORY(
15:21:29 233  	  in_paypal_id		       => in_paypal_id,
15:21:29 234  	  in_system_activity_reason_id => GLOBAL_ENUMS_V18.SAC_SYSTEM_APPLIED_RULE
15:21:29 235  	);
15:21:29 236  
15:21:29 237  	UPDATE PAYPAL SET
15:21:29 238  	  INSTRUMENT_NAME  = NVL(in_instrument_name, INSTRUMENT_NAME),
15:21:29 239  	  PRIVATE_EMAIL_ADDRESS    = NVL(in_private_email_address, PRIVATE_EMAIL_ADDRESS),
15:21:29 240  	  UPDATE_DATE	   = SYSDATE,
15:21:29 241  	  UPDATED_BY	   = in_updated_by,
15:21:29 242  	  PAYPAL_STATUS_ID = NVL(in_paypal_status_id, PAYPAL_STATUS_ID),
15:21:29 243  	  PRIVATE_STREET_ADDRESS  = NVL(in_paypal_prvt_street_address, PRIVATE_STREET_ADDRESS),
15:21:29 244  	  PRIVATE_STREET_ADDRESS2 = NVL(in_paypal_prvt_street_address2, PRIVATE_STREET_ADDRESS2),
15:21:29 245  	  STATE 		  = NVL(in_state, STATE),
15:21:29 246  	  CITY			  = NVL(in_city, CITY),
15:21:29 247  	  POSTAL_CODE		  = NVL(in_postal_code, POSTAL_CODE),
15:21:29 248  	  COUNTRY		  = NVL(in_country, COUNTRY),
15:21:29 249  	  EXPIRATION_DATE	  = NVL(in_expiration_date, EXPIRATION_DATE),
15:21:29 250  	  SECRET_TOKEN		  = NVL(in_secret_token, SECRET_TOKEN)
15:21:29 251  	WHERE
15:21:29 252  	  ID = in_paypal_id;
15:21:29 253  END UPDATE_PAYPAL;
15:21:29 254  
15:21:29 255  /******************************************************************************/
15:21:29 256  
15:21:29 257  PROCEDURE CREATE_GIFT_CERTIFICATE(
15:21:29 258  	out_gift_certificate_id       OUT GIFT_CERTIFICATE.ID%TYPE,
15:21:29 259  	in_gift_certificate_id	      IN GIFT_CERTIFICATE.ID%TYPE DEFAULT NULL,
15:21:29 260  	in_purchaser_group_id	      IN GIFT_CERTIFICATE.PURCHASER_GROUP_ID%TYPE,
15:21:29 261  	in_purchaser_invoice_id       IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
15:21:29 262  	in_offer_chain_id	      IN GIFT_CERTIFICATE.OFFER_CHAIN_ID%TYPE,
15:21:29 263  	in_expiration_date	      IN GIFT_CERTIFICATE.EXPIRATION_DATE%TYPE DEFAULT NULL,
15:21:29 264  	in_purchase_date	      IN GIFT_CERTIFICATE.PURCHASE_DATE%TYPE,
15:21:29 265  	in_gift_certificate_status_id IN GIFT_CERTIFICATE.GIFT_CERTIFICATE_STATUS_ID%TYPE,
15:21:29 266  	in_code 		      IN GIFT_CERTIFICATE.CODE%TYPE,
15:21:29 267  	in_created_by		      IN GIFT_CERTIFICATE.CREATED_BY%TYPE,
15:21:29 268  	in_recipient_name	      IN GIFT_CERTIFICATE.RECIPIENT_NAME%TYPE DEFAULT NULL,
15:21:29 269  	in_gift_message 	      IN GIFT_CERTIFICATE.GIFT_MESSAGE%TYPE DEFAULT NULL,
15:21:29 270  	in_recipient_email	      IN GIFT_CERTIFICATE.RECIPIENT_EMAIL%TYPE DEFAULT NULL,
15:21:29 271  	in_finalized_invoice_id       IN GIFT_CERTIFICATE.FINALIZED_INVOICE_ID%TYPE DEFAULT NULL,
15:21:29 272  	in_sender_email 	      IN GIFT_CERTIFICATE.SENDER_EMAIL%TYPE,
15:21:29 273  	in_sender_name		      IN GIFT_CERTIFICATE.SENDER_NAME%TYPE,
15:21:29 274  	in_redemption_date	      IN GIFT_CERTIFICATE.REDEMPTION_DATE%TYPE DEFAULT NULL,
15:21:29 275  	in_cancelation_date	      IN GIFT_CERTIFICATE.CANCELATION_DATE%TYPE DEFAULT NULL,
15:21:29 276  	in_redeemer_group_id	      IN GIFT_CERTIFICATE.REDEEMER_GROUP_ID%TYPE DEFAULT NULL,
15:21:29 277  	in_recipient_address_id       IN GIFT_CERTIFICATE.RECIPIENT_ADDRESS_ID%TYPE DEFAULT NULL,
15:21:29 278  	in_recipient_notify_date      IN GIFT_CERTIFICATE.RECIPIENT_NOTIFY_DATE%TYPE DEFAULT NULL
15:21:29 279  ) AS
15:21:29 280  -- VARIABLES
15:21:29 281  var_gift_certificate_id GIFT_CERTIFICATE.ID%TYPE;
15:21:29 282  -- arosolovskiy: using data variable instead of direct get data calls (#38860)
15:21:29 283  var_date DATE := SYSDATE;
15:21:29 284  BEGIN
15:21:29 285  	IF in_gift_certificate_id IS NULL THEN
15:21:29 286  	  SELECT
15:21:29 287  	    GC_ID_SEQ.nextVal into var_gift_certificate_id
15:21:29 288  	  FROM DUAL;
15:21:29 289  	ELSE
15:21:29 290  	  var_gift_certificate_id := in_gift_certificate_id;
15:21:29 291  	END IF;
15:21:29 292  	INSERT INTO GIFT_CERTIFICATE (
15:21:29 293  	    ID,
15:21:29 294  	    PURCHASER_GROUP_ID,
15:21:29 295  	    PURCHASE_INVOICE_ID,
15:21:29 296  	    OFFER_CHAIN_ID,
15:21:29 297  	    EXPIRATION_DATE,
15:21:29 298  	    PURCHASE_DATE,
15:21:29 299  	    GIFT_CERTIFICATE_STATUS_ID,
15:21:29 300  	    CODE,
15:21:29 301  	    CREATE_DATE,
15:21:29 302  	    CREATED_BY,
15:21:29 303  	    UPDATE_DATE,
15:21:29 304  	    UPDATED_BY,
15:21:29 305  	    RECIPIENT_NAME,
15:21:29 306  	    GIFT_MESSAGE,
15:21:29 307  	    RECIPIENT_EMAIL,
15:21:29 308  	    FINALIZED_INVOICE_ID,
15:21:29 309  	    SENDER_EMAIL,
15:21:29 310  	    SENDER_NAME,
15:21:29 311  	    REDEMPTION_DATE,
15:21:29 312  	    CANCELATION_DATE,
15:21:29 313  	    REDEEMER_GROUP_ID,
15:21:29 314  	    RECIPIENT_ADDRESS_ID,
15:21:29 315  	    RECIPIENT_NOTIFY_DATE
15:21:29 316  	  ) VALUES(
15:21:29 317  	    var_gift_certificate_id,
15:21:29 318  	    in_purchaser_group_id,
15:21:29 319  	    in_purchaser_invoice_id,
15:21:29 320  	    in_offer_chain_id,
15:21:29 321  	    in_expiration_date,
15:21:29 322  	    in_purchase_date,
15:21:29 323  	    in_gift_certificate_status_id,
15:21:29 324  	    in_code,
15:21:29 325  	    var_date,
15:21:29 326  	    in_created_by,
15:21:29 327  	    var_date,
15:21:29 328  	    in_created_by,
15:21:29 329  	    in_recipient_name,
15:21:29 330  	    in_gift_message,
15:21:29 331  	    in_recipient_email,
15:21:29 332  	    in_finalized_invoice_id,
15:21:29 333  	    in_sender_email,
15:21:29 334  	    in_sender_name,
15:21:29 335  	    in_redemption_date,
15:21:29 336  	    in_cancelation_date,
15:21:29 337  	    in_redeemer_group_id,
15:21:29 338  	    in_recipient_address_id,
15:21:29 339  	    in_recipient_notify_date
15:21:29 340  	  );
15:21:29 341  
15:21:29 342  	out_gift_certificate_id := var_gift_certificate_id;
15:21:29 343  END CREATE_GIFT_CERTIFICATE;
15:21:29 344  
15:21:29 345  /******************************************************************************/
15:21:29 346  
15:21:29 347  PROCEDURE UPDATE_GIFT_CERTIFICATE(
15:21:29 348  	in_gift_certificate_id	      IN GIFT_CERTIFICATE.ID%TYPE,
15:21:29 349  	in_expiration_date	      IN GIFT_CERTIFICATE.EXPIRATION_DATE%TYPE DEFAULT NULL,
15:21:29 350  	in_gift_certificate_status_id IN GIFT_CERTIFICATE.GIFT_CERTIFICATE_STATUS_ID%TYPE DEFAULT NULL,
15:21:29 351  	in_code 		      IN GIFT_CERTIFICATE.CODE%TYPE DEFAULT NULL,
15:21:29 352  	in_updated_by		      IN GIFT_CERTIFICATE.UPDATED_BY%TYPE,
15:21:29 353  	in_recipient_name	      IN GIFT_CERTIFICATE.RECIPIENT_NAME%TYPE DEFAULT NULL,
15:21:29 354  	in_gift_message 	      IN GIFT_CERTIFICATE.GIFT_MESSAGE%TYPE DEFAULT NULL,
15:21:29 355  	in_recipient_email	      IN GIFT_CERTIFICATE.RECIPIENT_EMAIL%TYPE DEFAULT NULL,
15:21:29 356  	in_finalized_invoice_id       IN GIFT_CERTIFICATE.FINALIZED_INVOICE_ID%TYPE DEFAULT NULL,
15:21:29 357  	in_sender_email 	      IN GIFT_CERTIFICATE.SENDER_EMAIL%TYPE DEFAULT NULL,
15:21:29 358  	in_sender_name		      IN GIFT_CERTIFICATE.SENDER_NAME%TYPE DEFAULT NULL,
15:21:29 359  	in_redemption_date	      IN GIFT_CERTIFICATE.REDEMPTION_DATE%TYPE DEFAULT NULL,
15:21:29 360  	in_cancelation_date	      IN GIFT_CERTIFICATE.CANCELATION_DATE%TYPE DEFAULT NULL,
15:21:29 361  	in_redeemer_group_id	      IN GIFT_CERTIFICATE.REDEEMER_GROUP_ID%TYPE DEFAULT NULL,
15:21:29 362  	in_recipient_address_id       IN GIFT_CERTIFICATE.RECIPIENT_ADDRESS_ID%TYPE DEFAULT NULL,
15:21:29 363  	in_redeemer_address_id	      IN GIFT_CERTIFICATE.REDEEMER_ADDRESS_ID%TYPE DEFAULT NULL,
15:21:29 364  	in_recipient_notify_date      IN GIFT_CERTIFICATE.RECIPIENT_NOTIFY_DATE%TYPE DEFAULT NULL
15:21:29 365  ) AS
15:21:29 366  BEGIN
15:21:29 367  
15:21:29 368  	-- Create history
15:21:29 369  	PROCS_HISTORY_V18.CREATE_GIFT_CERT_HISTORY(
15:21:29 370  	  in_gift_certificate_id       => in_gift_certificate_id,
15:21:29 371  	  in_system_activity_reason_id => GLOBAL_ENUMS_V18.SAC_SYSTEM_APPLIED_RULE
15:21:29 372  	);
15:21:29 373  
15:21:29 374  	UPDATE GIFT_CERTIFICATE SET
15:21:29 375  	  EXPIRATION_DATE	     = NVL(in_expiration_date, EXPIRATION_DATE),
15:21:29 376  	  GIFT_CERTIFICATE_STATUS_ID = NVL(in_gift_certificate_status_id, GIFT_CERTIFICATE_STATUS_ID),
15:21:29 377  	  CODE			     = NVL(in_code, CODE),
15:21:29 378  	  UPDATE_DATE		     = SYSDATE,
15:21:29 379  	  UPDATED_BY		     = in_updated_by,
15:21:29 380  	  RECIPIENT_NAME	     = NVL(in_recipient_name, RECIPIENT_NAME),
15:21:29 381  	  GIFT_MESSAGE		     = NVL(in_gift_message, GIFT_MESSAGE),
15:21:29 382  	  RECIPIENT_EMAIL	     = NVL(in_recipient_email, RECIPIENT_EMAIL),
15:21:29 383  	  FINALIZED_INVOICE_ID	     = NVL(in_finalized_invoice_id, FINALIZED_INVOICE_ID),
15:21:29 384  	  SENDER_EMAIL		     = NVL(in_sender_email, SENDER_EMAIL),
15:21:29 385  	  SENDER_NAME		     = NVL(in_sender_name, SENDER_NAME),
15:21:29 386  	  REDEMPTION_DATE	     = NVL(in_redemption_date, REDEMPTION_DATE),
15:21:29 387  	  CANCELATION_DATE	     = NVL(in_cancelation_date, CANCELATION_DATE),
15:21:29 388  	  REDEEMER_GROUP_ID	     = NVL(in_redeemer_group_id, REDEEMER_GROUP_ID),
15:21:29 389  	  RECIPIENT_ADDRESS_ID	     = NVL(in_recipient_address_id, RECIPIENT_ADDRESS_ID),
15:21:29 390  	  REDEEMER_ADDRESS_ID	     = NVL(in_redeemer_address_id, REDEEMER_ADDRESS_ID),
15:21:29 391  	  RECIPIENT_NOTIFY_DATE      = NVL(in_recipient_notify_date, RECIPIENT_NOTIFY_DATE)
15:21:29 392  	WHERE
15:21:29 393  	  ID = in_gift_certificate_id;
15:21:29 394  
15:21:29 395  END UPDATE_GIFT_CERTIFICATE;
15:21:29 396  
15:21:29 397  END PROCS_FIN_INSTRUMENTS_CRU_V18;
15:21:29 398  .
15:21:29 SQL> /

Package body created.

Elapsed: 00:00:00.05
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_GROUP_ACCOUNT_CRU_V18" AS
15:21:29   2  
15:21:29   3  PROCEDURE UPDATE_SUBSCRIPTION_SHARE (
15:21:29   4  	in_id		       IN SUBSCRIPTION_SHARE.ID%TYPE,
15:21:29   5  	in_group_account_id    IN SUBSCRIPTION_SHARE.GROUP_ACCOUNT_ID%TYPE DEFAULT NULL,
15:21:29   6  	in_borrower_account_id IN SUBSCRIPTION_SHARE.BORROWER_ACCOUNT_ID%TYPE DEFAULT NULL,
15:21:29   7  	in_ip_address	       IN SUBSCRIPTION_SHARE.IP_ADDRESS%TYPE DEFAULT NULL,
15:21:29   8  	in_start_date	       IN SUBSCRIPTION_SHARE.START_DATE%TYPE DEFAULT NULL,
15:21:29   9  	in_end_date	       IN SUBSCRIPTION_SHARE.END_DATE%TYPE DEFAULT NULL,
15:21:29  10  	in_needs_entitlements  IN SUBSCRIPTION_SHARE.NEEDS_ENTITLEMENTS%TYPE DEFAULT NULL,
15:21:29  11  	in_updated_by	       IN SUBSCRIPTION_SHARE.UPDATED_BY%TYPE
15:21:29  12  ) AS
15:21:29  13  SPROC_NAME CONSTANT VARCHAR2(32) := 'UPDATE_SUBSCRIPTION_SHARE';
15:21:29  14  BEGIN
15:21:29  15  	UPDATE SUBSCRIPTION_SHARE SET
15:21:29  16  	  GROUP_ACCOUNT_ID     = NVL(in_group_account_id,GROUP_ACCOUNT_ID),
15:21:29  17  	  BORROWER_ACCOUNT_ID  = NVL(in_borrower_account_id,BORROWER_ACCOUNT_ID),
15:21:29  18  	  IP_ADDRESS	       = NVL(in_ip_address,IP_ADDRESS),
15:21:29  19  	  START_DATE	       = NVL(in_start_date,START_DATE),
15:21:29  20  	  END_DATE	       = NVL(in_end_date,END_DATE),
15:21:29  21  	  NEEDS_ENTITLEMENTS   = NVL(in_needs_entitlements,NEEDS_ENTITLEMENTS),
15:21:29  22  	  UPDATED_BY	       = in_updated_by,
15:21:29  23  	  UPDATE_DATE	       = SYSDATE
15:21:29  24  	WHERE
15:21:29  25  	  SUBSCRIPTION_SHARE.ID = in_id;
15:21:29  26  EXCEPTION
15:21:29  27  	WHEN OTHERS THEN
15:21:29  28  	  Procs_Common_V18.Throw_Exception(APP_EXCEPTION_CODES_V18.Internal_Error,
15:21:29  29  	    SPROC_NAME, 'Error while updating subscription share', SQLERRM);
15:21:29  30  END UPDATE_SUBSCRIPTION_SHARE;
15:21:29  31  
15:21:29  32  PROCEDURE CREATE_GROUP_ACCOUNT (
15:21:29  33  	in_subscription_id	 IN NUMBER,
15:21:29  34  	in_group_name		 IN VARCHAR2,
15:21:29  35  	in_first_name		 IN VARCHAR2,
15:21:29  36  	in_last_name		 IN VARCHAR2,
15:21:29  37  	in_email		 IN VARCHAR2,
15:21:29  38  	in_phone		 IN VARCHAR2,
15:21:29  39  	in_organization_type	 IN VARCHAR2,
15:21:29  40  	in_seats		 IN NUMBER,
15:21:29  41  	in_seat_ttl_in_hours	 IN NUMBER,
15:21:29  42  	in_ip			 IN NUMBER,
15:21:29  43  	in_created_by		 IN VARCHAR2
15:21:29  44  ) AS
15:21:29  45  SPROC_NAME CONSTANT VARCHAR2(32) := 'CREATE_GROUP_ACCOUNT';
15:21:29  46  var_now DATE;
15:21:29  47  BEGIN
15:21:29  48  
15:21:29  49  	SELECT
15:21:29  50  	  SYSDATE INTO var_now
15:21:29  51  	FROM dual;
15:21:29  52  
15:21:29  53  	INSERT INTO GROUP_ACCOUNT (
15:21:29  54  	  id,
15:21:29  55  	  subscription_id,
15:21:29  56  	  group_name,
15:21:29  57  	  first_name,
15:21:29  58  	  last_name,
15:21:29  59  	  email,
15:21:29  60  	  phone,
15:21:29  61  	  organization_type,
15:21:29  62  	  seats,
15:21:29  63  	  seat_ttl_in_hours,
15:21:29  64  	  ip,
15:21:29  65  	  create_date,
15:21:29  66  	  created_by,
15:21:29  67  	  update_date,
15:21:29  68  	  updated_by
15:21:29  69  	) VALUES (
15:21:29  70  	  core_owner.GRPACCNT_ID_SEQ.NEXTVAL,
15:21:29  71  	  in_subscription_id,
15:21:29  72  	  in_group_name,
15:21:29  73  	  in_first_name,
15:21:29  74  	  in_last_name,
15:21:29  75  	  in_email,
15:21:29  76  	  in_phone,
15:21:29  77  	  in_organization_type,
15:21:29  78  	  in_seats,
15:21:29  79  	  in_seat_ttl_in_hours,
15:21:29  80  	  in_ip,
15:21:29  81  	  var_now,
15:21:29  82  	  in_created_by,
15:21:29  83  	  var_now,
15:21:29  84  	  in_created_by
15:21:29  85  	);
15:21:29  86  
15:21:29  87  EXCEPTION
15:21:29  88  	WHEN PROGRAM_ERROR THEN
15:21:29  89  	  PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:29  90  	    SPROC_NAME, 'Program error when inserting group account', SQLERRM);
15:21:29  91  	WHEN OTHERS THEN
15:21:29  92  	  PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:29  93  	    SPROC_NAME, 'Unknown error when inserting group account', SQLERRM);
15:21:29  94  END CREATE_GROUP_ACCOUNT;
15:21:29  95  
15:21:29  96  
15:21:29  97  PROCEDURE CREATE_SUBSCRIPTION_SHARE (
15:21:29  98  	in_group_account_id    IN NUMBER,
15:21:29  99  	in_borrower_account_id IN NUMBER,
15:21:29 100  	in_ip_address	       IN VARCHAR2,
15:21:29 101  	in_email_domain        IN VARCHAR2,
15:21:29 102  	in_start_date	       IN DATE,
15:21:29 103  	in_end_date	       IN DATE,
15:21:29 104  	in_created_by	       IN VARCHAR2
15:21:29 105  ) AS
15:21:29 106  SPROC_NAME CONSTANT VARCHAR2(32) := 'CREATE_SUBSCRIPTION_SHARE';
15:21:29 107  var_now DATE;
15:21:29 108  BEGIN
15:21:29 109  
15:21:29 110  	SELECT
15:21:29 111  	  SYSDATE INTO var_now
15:21:29 112  	FROM dual;
15:21:29 113  
15:21:29 114  	INSERT INTO SUBSCRIPTION_SHARE (
15:21:29 115  	  id,
15:21:29 116  	  group_account_id,
15:21:29 117  	  borrower_account_id,
15:21:29 118  	  ip_address,
15:21:29 119  	  email_domain,
15:21:29 120  	  start_date,
15:21:29 121  	  end_date,
15:21:29 122  	  create_date,
15:21:29 123  	  created_by,
15:21:29 124  	  update_date,
15:21:29 125  	  updated_by
15:21:29 126  	) VALUES (
15:21:29 127  	  core_owner.SUBSCRIPTIONSHARE_ID_SEQ.NEXTVAL,
15:21:29 128  	  in_group_account_id,
15:21:29 129  	  in_borrower_account_id,
15:21:29 130  	  in_ip_address,
15:21:29 131  	  in_email_domain,
15:21:29 132  	  in_start_date,
15:21:29 133  	  in_end_date,
15:21:29 134  	  var_now,
15:21:29 135  	  in_created_by,
15:21:29 136  	  var_now,
15:21:29 137  	  in_created_by
15:21:29 138  	);
15:21:29 139  
15:21:29 140  EXCEPTION
15:21:29 141  	WHEN PROGRAM_ERROR THEN
15:21:29 142  	  PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:29 143  	    SPROC_NAME, 'Program error when inserting subscription share', SQLERRM);
15:21:29 144  END CREATE_SUBSCRIPTION_SHARE;
15:21:29 145  
15:21:29 146  -- Eh, I don't like the cru packages at all
15:21:29 147  -- the idea of code reuse in PL/SQL is still lost on me
15:21:29 148  PROCEDURE DISABLE_IP_RANGES_BY_GA_ID(
15:21:29 149  	in_group_account_id IN GROUP_ACCOUNT_IP_RANGE.GROUP_ACCOUNT_ID%TYPE,
15:21:29 150  	in_updated_by IN GROUP_ACCOUNT_IP_RANGE.UPDATED_BY%TYPE
15:21:29 151  ) AS
15:21:29 152  SPROC_NAME CONSTANT VARCHAR2(32) := 'DISABLE_IP_RANGES_BY_GA_ID';
15:21:29 153  BEGIN
15:21:29 154  	update
15:21:29 155  	  GROUP_ACCOUNT_IP_RANGE IR
15:21:29 156  	set
15:21:29 157  	  IR.GROUP_ACC_IP_RNG_STATUS_ID = GLOBAL_STATUSES_V18.GROUP_ACC_IP_RNG_INACTIVE,
15:21:29 158  	  IR.UPDATED_BY = in_updated_by,
15:21:29 159  	  IR.UPDATE_DATE = sysdate
15:21:29 160  	where
15:21:29 161  	  IR.GROUP_ACCOUNT_ID = in_group_account_id and
15:21:29 162  	  IR.GROUP_ACC_IP_RNG_STATUS_ID = GLOBAL_STATUSES_V18.GROUP_ACC_IP_RNG_ACTIVE
15:21:29 163  	;
15:21:29 164  EXCEPTION
15:21:29 165  WHEN OTHERS THEN
15:21:29 166  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:29 167  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:29 168  END DISABLE_IP_RANGES_BY_GA_ID;
15:21:29 169  
15:21:29 170  PROCEDURE DISABLE_IP_RANGE_BY_ID(
15:21:29 171  	in_id	IN GROUP_ACCOUNT_IP_RANGE.ID%TYPE,
15:21:29 172  	in_updated_by IN GROUP_ACCOUNT_IP_RANGE.UPDATED_BY%TYPE
15:21:29 173  ) AS
15:21:29 174  SPROC_NAME CONSTANT VARCHAR2(32) := 'DISABLE_IP_RANGE_BY_ID';
15:21:29 175  BEGIN
15:21:29 176  	update
15:21:29 177  	  GROUP_ACCOUNT_IP_RANGE IR
15:21:29 178  	set
15:21:29 179  	  IR.GROUP_ACC_IP_RNG_STATUS_ID = GLOBAL_STATUSES_V18.GROUP_ACC_IP_RNG_INACTIVE,
15:21:29 180  	  IR.UPDATED_BY = in_updated_by,
15:21:29 181  	  IR.UPDATE_DATE = sysdate
15:21:29 182  	where
15:21:29 183  	  IR.ID = in_id and
15:21:29 184  	  IR.GROUP_ACC_IP_RNG_STATUS_ID = GLOBAL_STATUSES_V18.GROUP_ACC_IP_RNG_ACTIVE
15:21:29 185  	;
15:21:29 186  raise no_data_found;
15:21:29 187  EXCEPTION
15:21:29 188  WHEN OTHERS THEN
15:21:29 189  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:29 190  	  SPROC_NAME, 'Unknown error '||in_id, SQLERRM);
15:21:29 191  END DISABLE_IP_RANGE_BY_ID;
15:21:29 192  
15:21:29 193  PROCEDURE ADD_IP_RANGE (
15:21:29 194  	in_group_account_id IN GROUP_ACCOUNT_IP_RANGE.GROUP_ACCOUNT_ID%TYPE,
15:21:29 195  	in_minimum_ip_string IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_STRING%TYPE,
15:21:29 196  	in_minimum_ip_low IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_LOW%TYPE,
15:21:29 197  	in_minimum_ip_high IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_HIGH%TYPE,
15:21:29 198  	in_maximum_ip_string IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_STRING%TYPE,
15:21:29 199  	in_maximum_ip_low IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_LOW%TYPE,
15:21:29 200  	in_maximum_ip_high IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_HIGH%TYPE,
15:21:29 201  	in_created_by IN GROUP_ACCOUNT_IP_RANGE.CREATED_BY%TYPE
15:21:29 202  ) AS
15:21:29 203  SPROC_NAME CONSTANT VARCHAR2(32) := 'ADD_IP_RANGE';
15:21:29 204  BEGIN
15:21:29 205  	  INSERT INTO GROUP_ACCOUNT_IP_RANGE (
15:21:29 206  	    ID,
15:21:29 207  	    GROUP_ACCOUNT_ID,
15:21:29 208  	    MINIMUM_IP_STRING,
15:21:29 209  	    MINIMUM_IP_LOW,
15:21:29 210  	    MINIMUM_IP_HIGH,
15:21:29 211  	    MAXIMUM_IP_STRING,
15:21:29 212  	    MAXIMUM_IP_LOW,
15:21:29 213  	    MAXIMUM_IP_HIGH,
15:21:29 214  	    CREATED_BY,
15:21:29 215  	    CREATE_DATE,
15:21:29 216  	    UPDATED_BY,
15:21:29 217  	    UPDATE_DATE,
15:21:29 218  	    GROUP_ACC_IP_RNG_STATUS_ID
15:21:29 219  	  )
15:21:29 220  	  VALUES (
15:21:29 221  	    GROUPACCOUNTIPRANGE_ID_SEQ.nextval,
15:21:29 222  	    in_group_account_id,
15:21:29 223  	    in_minimum_ip_string,
15:21:29 224  	    in_minimum_ip_low,
15:21:29 225  	    in_minimum_ip_high,
15:21:29 226  	    in_maximum_ip_string,
15:21:29 227  	    in_maximum_ip_low,
15:21:29 228  	    in_maximum_ip_high,
15:21:29 229  	    in_created_by,
15:21:29 230  	    sysdate,
15:21:29 231  	    in_created_by,
15:21:29 232  	    sysdate,
15:21:29 233  	    GLOBAL_STATUSES_V18.GROUP_ACC_IP_RNG_ACTIVE
15:21:29 234  	  );
15:21:29 235  EXCEPTION
15:21:29 236  WHEN OTHERS THEN
15:21:29 237  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:29 238  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:29 239  END ADD_IP_RANGE;
15:21:29 240  
15:21:29 241  PROCEDURE DISABLE_EMAIL_DOMAIN_BY_GA_ID(
15:21:29 242  	in_group_account_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
15:21:29 243  	in_updated_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.UPDATED_BY%TYPE
15:21:29 244  ) AS
15:21:29 245  SPROC_NAME CONSTANT VARCHAR2(32) := 'DISABLE_EMAIL_DOMAIN_BY_GA_ID';
15:21:29 246  BEGIN
15:21:29 247  	update
15:21:29 248  	  GROUP_ACCOUNT_EMAIL_DOMAIN ED
15:21:29 249  	set
15:21:29 250  	  ED.IS_ACTIVE = GLOBAL_STATUSES_V18.GROUP_ACC_EMAIL_DOMAIN_INACT,
15:21:29 251  	  ED.UPDATED_BY = in_updated_by,
15:21:29 252  	  ED.UPDATE_DATE = sysdate
15:21:29 253  	where
15:21:29 254  	  ED.GROUP_ACCOUNT_ID = in_group_account_id and
15:21:29 255  	  ED.IS_ACTIVE = GLOBAL_STATUSES_V18.GROUP_ACC_EMAIL_DOMAIN_ACT
15:21:29 256  	;
15:21:29 257  EXCEPTION
15:21:29 258  WHEN OTHERS THEN
15:21:29 259  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:29 260  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:29 261  END DISABLE_EMAIL_DOMAIN_BY_GA_ID;
15:21:29 262  
15:21:29 263  PROCEDURE DISABLE_EMAIL_DOMAIN_BY_ID(
15:21:29 264  	in_id	IN GROUP_ACCOUNT_EMAIL_DOMAIN.ID%TYPE,
15:21:29 265  	in_updated_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.UPDATED_BY%TYPE
15:21:29 266  ) AS
15:21:29 267  SPROC_NAME CONSTANT VARCHAR2(32) := 'DISABLE_EMAIL_DOMAIN_BY_ID';
15:21:29 268  BEGIN
15:21:29 269  	update
15:21:29 270  	  GROUP_ACCOUNT_EMAIL_DOMAIN ED
15:21:29 271  	set
15:21:29 272  	  ED.IS_ACTIVE = GLOBAL_STATUSES_V18.GROUP_ACC_EMAIL_DOMAIN_INACT,
15:21:29 273  	  ED.UPDATED_BY = in_updated_by,
15:21:29 274  	  ED.UPDATE_DATE = sysdate
15:21:29 275  	where
15:21:29 276  	  ED.ID = in_id and
15:21:29 277  	  ED.IS_ACTIVE = GLOBAL_STATUSES_V18.GROUP_ACC_EMAIL_DOMAIN_ACT
15:21:29 278  	;
15:21:29 279  EXCEPTION
15:21:29 280  WHEN OTHERS THEN
15:21:29 281  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:29 282  	  SPROC_NAME, 'Unknown error '||in_id, SQLERRM);
15:21:29 283  END DISABLE_EMAIL_DOMAIN_BY_ID;
15:21:29 284  
15:21:29 285  
15:21:29 286  PROCEDURE ENABLE_EMAIL_DOMAIN_BY_ID(
15:21:29 287  	in_id	IN GROUP_ACCOUNT_EMAIL_DOMAIN.ID%TYPE,
15:21:29 288  	in_updated_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.UPDATED_BY%TYPE
15:21:29 289  ) AS
15:21:29 290  SPROC_NAME CONSTANT VARCHAR2(32) := 'ENABLE_EMAIL_DOMAIN_BY_ID';
15:21:29 291  BEGIN
15:21:29 292  	update
15:21:29 293  	  GROUP_ACCOUNT_EMAIL_DOMAIN ED
15:21:29 294  	set
15:21:29 295  	  ED.IS_ACTIVE = GLOBAL_STATUSES_V18.GROUP_ACC_EMAIL_DOMAIN_ACT,
15:21:29 296  	  ED.UPDATED_BY = in_updated_by,
15:21:29 297  	  ED.UPDATE_DATE = sysdate
15:21:29 298  	where
15:21:29 299  	  ED.ID = in_id and
15:21:29 300  	  ED.IS_ACTIVE = GLOBAL_STATUSES_V18.GROUP_ACC_EMAIL_DOMAIN_INACT
15:21:29 301  	;
15:21:29 302  EXCEPTION
15:21:29 303  WHEN OTHERS THEN
15:21:29 304  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:29 305  	  SPROC_NAME, 'Unknown error '||in_id, SQLERRM);
15:21:29 306  END ENABLE_EMAIL_DOMAIN_BY_ID;
15:21:29 307  
15:21:29 308  
15:21:29 309  PROCEDURE ADD_EMAIL_DOMAIN (
15:21:29 310  	in_group_account_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
15:21:29 311  	in_email_domain IN GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE,
15:21:29 312  	in_is_active IN  GROUP_ACCOUNT_EMAIL_DOMAIN.IS_ACTIVE%TYPE,
15:21:29 313  	in_created_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.CREATED_BY%TYPE
15:21:29 314  ) AS
15:21:29 315  SPROC_NAME CONSTANT VARCHAR2(32) := 'ADD_EMAIL_DOMAIN';
15:21:29 316  BEGIN
15:21:29 317  	  INSERT INTO GROUP_ACCOUNT_EMAIL_DOMAIN (
15:21:29 318  	    ID,
15:21:29 319  	    GROUP_ACCOUNT_ID,
15:21:29 320  	    EMAIL_DOMAIN,
15:21:29 321  		IS_ACTIVE,
15:21:29 322  	    CREATED_BY,
15:21:29 323  	    CREATE_DATE,
15:21:29 324  	    UPDATED_BY,
15:21:29 325  	    UPDATE_DATE
15:21:29 326  	  )
15:21:29 327  	  VALUES (
15:21:29 328  	    GROUPACCOUNTEMAILDOMAIN_SEQ.nextval,
15:21:29 329  	    in_group_account_id,
15:21:29 330  		in_email_domain,
15:21:29 331  		in_is_active,
15:21:29 332  		in_created_by,
15:21:29 333  	    sysdate,
15:21:29 334  	    in_created_by,
15:21:29 335  	    sysdate
15:21:29 336  	  );
15:21:29 337  EXCEPTION
15:21:29 338  WHEN DUP_VAL_ON_INDEX THEN
15:21:29 339  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:29 340  	  SPROC_NAME, 'Unique Constraint Violated', SQLERRM);
15:21:29 341  WHEN OTHERS THEN
15:21:29 342  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:29 343  	  SPROC_NAME, 'Unknown error 1', SQLERRM);
15:21:29 344  END ADD_EMAIL_DOMAIN;
15:21:29 345  
15:21:29 346  PROCEDURE UPDATE_GROUP_ACCOUNT (
15:21:29 347  	in_group_account_id	 IN GROUP_ACCOUNT.ID%TYPE,
15:21:29 348  	in_group_name		 IN GROUP_ACCOUNT.GROUP_NAME%TYPE,
15:21:29 349  	in_first_name		 IN GROUP_ACCOUNT.FIRST_NAME%TYPE,
15:21:29 350  	in_last_name		 IN GROUP_ACCOUNT.LAST_NAME%TYPE,
15:21:29 351  	in_email		 IN GROUP_ACCOUNT.EMAIL%TYPE,
15:21:29 352  	in_phone		 IN GROUP_ACCOUNT.PHONE%TYPE,
15:21:29 353  	in_updated_by		 IN GROUP_ACCOUNT.UPDATED_BY%TYPE
15:21:29 354  ) AS
15:21:29 355  SPROC_NAME CONSTANT VARCHAR2(32) := 'UPDATE_GROUP_ACCOUNT';
15:21:29 356  BEGIN
15:21:29 357  	update
15:21:29 358  	  group_account
15:21:29 359  	set
15:21:29 360  	  group_name = nvl(in_group_name, group_name),
15:21:29 361  	  first_name = nvl(in_first_name, first_name),
15:21:29 362  	  last_name = nvl(in_last_name, last_name),
15:21:29 363  	  email = nvl(in_email, email),
15:21:29 364  	  phone = nvl(in_phone, phone),
15:21:29 365  	  updated_by = in_updated_by,
15:21:29 366  	  update_date = sysdate
15:21:29 367  	where
15:21:29 368  	  id = in_group_account_id;
15:21:29 369  
15:21:29 370  	if(sql%rowcount = 0) then
15:21:29 371  	  PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:29 372  	  SPROC_NAME, 'Group Account not found', SQLERRM);
15:21:29 373  	end if;
15:21:29 374  EXCEPTION
15:21:29 375  	WHEN OTHERS THEN
15:21:29 376  	  PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:29 377  	    SPROC_NAME, 'Error while updating group account', SQLERRM);
15:21:29 378  END UPDATE_GROUP_ACCOUNT;
15:21:29 379  
15:21:29 380  PROCEDURE UPDATE_GROUP_ACCOUNT_SEATS (
15:21:29 381  	in_group_account_id	 IN GROUP_ACCOUNT.ID%TYPE,
15:21:29 382  	in_seats		 IN GROUP_ACCOUNT.SEATS%TYPE,
15:21:29 383  	in_updated_by		 IN GROUP_ACCOUNT.UPDATED_BY%TYPE
15:21:29 384  ) AS
15:21:29 385  SPROC_NAME CONSTANT VARCHAR2(32) := 'UPDATE_GROUP_ACCOUNT_SEATS';
15:21:29 386  var_subscription_id NUMBER;
15:21:29 387  var_seats NUMBER;
15:21:29 388  BEGIN
15:21:29 389  	select subscription_id, seats into var_subscription_id, var_seats
15:21:29 390  	from group_account
15:21:29 391  	where id = in_group_account_id;
15:21:29 392  
15:21:29 393  	update
15:21:29 394  	  group_account
15:21:29 395  	set
15:21:29 396  	  seats = in_seats,
15:21:29 397  	  updated_by = in_updated_by,
15:21:29 398  	  update_date = sysdate
15:21:29 399  	where
15:21:29 400  	  id = in_group_account_id;
15:21:29 401  
15:21:29 402  	if(sql%rowcount = 0) then
15:21:29 403  	  PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:29 404  	  SPROC_NAME, 'Group Account not found', SQLERRM);
15:21:29 405  	end if;
15:21:29 406  
15:21:29 407  	PROCS_SUBSCRIPTION_V18.ANNOTATE_SUBSCRIPTION(
15:21:29 408  	  in_subscription_id => var_subscription_id,
15:21:29 409  	  in_agent_id	     => 0,
15:21:29 410  	  in_note	     => 'seats updated from '||var_seats||' to '||in_seats,
15:21:29 411  	  in_created_by      => in_updated_by
15:21:29 412  	);
15:21:29 413  EXCEPTION
15:21:29 414  	WHEN NO_DATA_FOUND THEN
15:21:29 415  	  PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:29 416  	  SPROC_NAME, 'Group Account not found', SQLERRM);
15:21:29 417  	WHEN OTHERS THEN
15:21:29 418  	  PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:29 419  	    SPROC_NAME, 'Error while updating group account seats', SQLERRM);
15:21:29 420  END UPDATE_GROUP_ACCOUNT_SEATS;
15:21:29 421  
15:21:29 422  END PROCS_GROUP_ACCOUNT_CRU_V18;
15:21:29 423  .
15:21:29 SQL> /

Package body created.

Elapsed: 00:00:00.06
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_INVOICE_CRU_V18" AS
15:21:29   2  
15:21:29   3  PROCEDURE CREATE_INVOICE (
15:21:29   4  	out_invoice_id		       OUT INVOICE.ID%TYPE,
15:21:29   5  	in_invoice_id		       IN INVOICE.ID%TYPE DEFAULT NULL,
15:21:29   6  	in_invoice_status_id	       IN INVOICE.INVOICE_STATUS_ID%TYPE,
15:21:29   7  	in_tax_exempt_id	       IN INVOICE.TAX_EXEMPT_ID%TYPE,
15:21:29   8  	in_created_by		       IN INVOICE.CREATED_BY%TYPE
15:21:29   9  ) AS
15:21:29  10  -- VARIABLES
15:21:29  11  var_invoice_id INVOICE.ID%TYPE;
15:21:29  12  -- arosolovskiy: using data variable instead of direct get data calls (#38860)
15:21:29  13  var_date DATE := SYSDATE;
15:21:29  14  BEGIN
15:21:29  15  	IF in_invoice_id IS NULL THEN
15:21:29  16  	  SELECT
15:21:29  17  	    INV_ID_SEQ.nextVal into var_invoice_id
15:21:29  18  	  FROM DUAL;
15:21:29  19  	ELSE
15:21:29  20  	  var_invoice_id := in_invoice_id;
15:21:29  21  	END IF;
15:21:29  22  	INSERT INTO
15:21:29  23  	  INVOICE (
15:21:29  24  	    ID,
15:21:29  25  	    INVOICE_STATUS_ID,
15:21:29  26  	    CREATE_DATE,
15:21:29  27  	    CREATED_BY,
15:21:29  28  	    UPDATE_DATE,
15:21:29  29  	    UPDATED_BY,
15:21:29  30  	    TAX_EXEMPT_ID,
15:21:29  31  	    IS_TAX_CALCULATION_NEEDED
15:21:29  32  	  ) VALUES (
15:21:29  33  	    var_invoice_id,
15:21:29  34  	    in_invoice_status_id,
15:21:29  35  	    var_date,
15:21:29  36  	    in_created_by,
15:21:29  37  	    var_date,
15:21:29  38  	    in_created_by,
15:21:29  39  	    in_tax_exempt_id,
15:21:29  40  	    0 -- DEFAULT VALUE
15:21:29  41  	  );
15:21:29  42  
15:21:29  43  	out_invoice_id := var_invoice_id;
15:21:29  44  END;
15:21:29  45  
15:21:29  46  /*****************************************************************/
15:21:29  47  
15:21:29  48  PROCEDURE UPDATE_INVOICE (
15:21:29  49  	in_invoice_id		       IN INVOICE.ID%TYPE,
15:21:29  50  	in_updated_by		       IN INVOICE.UPDATED_BY%TYPE,
15:21:29  51  	in_invoice_status_id	       IN INVOICE.INVOICE_STATUS_ID%TYPE DEFAULT NULL,
15:21:29  52  	in_is_tax_calculation_needed   IN INVOICE.IS_TAX_CALCULATION_NEEDED%TYPE DEFAULT NULL
15:21:29  53  ) AS
15:21:29  54  BEGIN
15:21:29  55  	-- Create history
15:21:29  56  	PROCS_HISTORY_V18.CREATE_INVOICE_HISTORY(
15:21:29  57  	  in_invoice_id 	       => in_invoice_id,
15:21:29  58  	  in_system_activity_reason_id => GLOBAL_ENUMS_V18.SAC_SYSTEM_APPLIED_RULE
15:21:29  59  	);
15:21:29  60  
15:21:29  61  	UPDATE
15:21:29  62  	  INVOICE
15:21:29  63  	SET
15:21:29  64  	  INVOICE_STATUS_ID	    = NVL(in_invoice_status_id, INVOICE_STATUS_ID),
15:21:29  65  	  UPDATE_DATE		    = SYSDATE,
15:21:29  66  	  UPDATED_BY		    = in_updated_by,
15:21:29  67  	  IS_TAX_CALCULATION_NEEDED = NVL(in_is_tax_calculation_needed, IS_TAX_CALCULATION_NEEDED)
15:21:29  68  	WHERE
15:21:29  69  	  ID = in_invoice_id;
15:21:29  70  END;
15:21:29  71  
15:21:29  72  END PROCS_INVOICE_CRU_V18;
15:21:29  73  .
15:21:29 SQL> /

Package body created.

Elapsed: 00:00:00.04
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_ITUNES_RECEIPT_CRU_V18" AS
15:21:29   2  
15:21:29   3  PROCEDURE CREATE_RECEIPT(
15:21:29   4  /*
15:21:29   5  Throws exceptions:
15:21:29   6  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29   7  */
15:21:29   8  	  out_id	      OUT NUMBER,
15:21:29   9  	  in_subscription_id  IN CORE_OWNER.ITUNES_RECEIPT.SUBSCRIPTION_ID%TYPE,
15:21:29  10  	  in_receipt	      IN CORE_OWNER.ITUNES_RECEIPT.RECEIPT%TYPE,
15:21:29  11  	  in_status	      IN CORE_OWNER.ITUNES_RECEIPT.STATUS%TYPE,
15:21:29  12  	  in_quantity	      IN CORE_OWNER.ITUNES_RECEIPT.QUANTITY%TYPE,
15:21:29  13  	  in_product_id       IN CORE_OWNER.ITUNES_RECEIPT.PRODUCT_ID%TYPE,
15:21:29  14  	  in_transaction_id   IN CORE_OWNER.ITUNES_RECEIPT.TRANSACTION_ID%TYPE,
15:21:29  15  	  in_purchase_date    IN CORE_OWNER.ITUNES_RECEIPT.PURCHASE_DATE%TYPE,
15:21:29  16  	  in_original_transaction_id IN CORE_OWNER.ITUNES_RECEIPT.ORIGINAL_TRANSACTION_ID%TYPE,
15:21:29  17  	  in_original_purchase_date IN CORE_OWNER.ITUNES_RECEIPT.ORIGINAL_PURCHASE_DATE%TYPE,
15:21:29  18  	  in_app_item_id      IN CORE_OWNER.ITUNES_RECEIPT.APP_ITEM_ID%TYPE,
15:21:29  19  	  in_version_external_id IN CORE_OWNER.ITUNES_RECEIPT.VERSION_EXTERNAL_ID%TYPE,
15:21:29  20  	  in_bid	      IN CORE_OWNER.ITUNES_RECEIPT.BID%TYPE,
15:21:29  21  	  in_bvrs	      IN CORE_OWNER.ITUNES_RECEIPT.BVRS%TYPE,
15:21:29  22  	  in_expires_date     IN CORE_OWNER.ITUNES_RECEIPT.EXPIRES_DATE%TYPE,
15:21:29  23  	  in_created_by       IN CORE_OWNER.ITUNES_RECEIPT.CREATED_BY%TYPE
15:21:29  24  ) AS
15:21:29  25  -- VARIABLES
15:21:29  26  SPROC_NAME	CONSTANT VARCHAR2(32) := 'CREATE_RECEIPT';
15:21:29  27  var_current_date	    DATE;
15:21:29  28  var_count 	    NUMBER;
15:21:29  29  ITUNES_ORG_TNX_USED   EXCEPTION;
15:21:29  30  BEGIN
15:21:29  31  	SELECT COUNT(1) into var_count
15:21:29  32  	FROM
15:21:29  33  	  ITUNES_RECEIPT IR, SUBSCRIPTION S
15:21:29  34  	WHERE
15:21:29  35  	  IR.ORIGINAL_TRANSACTION_ID = in_original_transaction_id AND
15:21:29  36  	  IR.SUBSCRIPTION_ID = S.ID AND
15:21:29  37  	  S.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE;
15:21:29  38  
15:21:29  39  	if var_count > 0 then
15:21:29  40  	  raise ITUNES_ORG_TNX_USED;
15:21:29  41  	end if;
15:21:29  42  
15:21:29  43  	SELECT
15:21:29  44  	  CORE_OWNER.ITUNES_RECEIPT_ID_SEQ.NEXTVAL
15:21:29  45  	INTO
15:21:29  46  	  out_id
15:21:29  47  	FROM
15:21:29  48  	  dual
15:21:29  49  	;
15:21:29  50  
15:21:29  51  	SELECT
15:21:29  52  	  sysdate
15:21:29  53  	INTO
15:21:29  54  	  var_current_date
15:21:29  55  	FROM
15:21:29  56  	  dual
15:21:29  57  	;
15:21:29  58  
15:21:29  59  	INSERT INTO CORE_OWNER.ITUNES_RECEIPT
15:21:29  60  	(
15:21:29  61  	  id,
15:21:29  62  	  subscription_id,
15:21:29  63  	  receipt,
15:21:29  64  	  status,
15:21:29  65  	  quantity,
15:21:29  66  	  product_id,
15:21:29  67  	  transaction_id,
15:21:29  68  	  purchase_date,
15:21:29  69  	  original_transaction_id,
15:21:29  70  	  original_purchase_date,
15:21:29  71  	  app_item_id,
15:21:29  72  	  version_external_id,
15:21:29  73  	  bid,
15:21:29  74  	  bvrs,
15:21:29  75  	  expires_date,
15:21:29  76  	  create_date,
15:21:29  77  	  created_by,
15:21:29  78  	  update_date,
15:21:29  79  	  updated_by,
15:21:29  80  	  last_check_date
15:21:29  81  	)
15:21:29  82  	VALUES
15:21:29  83  	(
15:21:29  84  	  out_id,
15:21:29  85  	  in_subscription_id,
15:21:29  86  	  in_receipt,
15:21:29  87  	  in_status,
15:21:29  88  	  in_quantity,
15:21:29  89  	  in_product_id,
15:21:29  90  	  in_transaction_id,
15:21:29  91  	  in_purchase_date,
15:21:29  92  	  in_original_transaction_id,
15:21:29  93  	  in_original_purchase_date,
15:21:29  94  	  in_app_item_id,
15:21:29  95  	  in_version_external_id,
15:21:29  96  	  in_bid,
15:21:29  97  	  in_bvrs,
15:21:29  98  	  in_expires_date,
15:21:29  99  	  var_current_date,
15:21:29 100  	  in_created_by,
15:21:29 101  	  var_current_date,
15:21:29 102  	  in_created_by,
15:21:29 103  	  var_current_date
15:21:29 104  	);
15:21:29 105  
15:21:29 106  EXCEPTION
15:21:29 107  WHEN ITUNES_ORG_TNX_USED THEN
15:21:29 108  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.DUPLICATE_ERROR,
15:21:29 109  	  SPROC_NAME, 'iTunes orginal transaction id already in use', SQLERRM);
15:21:29 110  WHEN DUP_VAL_ON_INDEX THEN
15:21:29 111  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.DUPLICATE_ERROR,
15:21:29 112  	  SPROC_NAME, 'Duplicate value', SQLERRM);
15:21:29 113  WHEN OTHERS THEN
15:21:29 114  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:29 115  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:29 116  END CREATE_RECEIPT;
15:21:29 117  
15:21:29 118  PROCEDURE UPDATE_RECEIPT(
15:21:29 119  /*
15:21:29 120  Throws exceptions:
15:21:29 121  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 122  */
15:21:29 123  	  in_id 	      IN CORE_OWNER.ITUNES_RECEIPT.ID%TYPE,
15:21:29 124  	  in_receipt	      IN CORE_OWNER.ITUNES_RECEIPT.RECEIPT%TYPE,
15:21:29 125  	  in_status	      IN CORE_OWNER.ITUNES_RECEIPT.STATUS%TYPE,
15:21:29 126  	  in_quantity	      IN CORE_OWNER.ITUNES_RECEIPT.QUANTITY%TYPE,
15:21:29 127  	  in_product_id       IN CORE_OWNER.ITUNES_RECEIPT.PRODUCT_ID%TYPE,
15:21:29 128  	  in_transaction_id   IN CORE_OWNER.ITUNES_RECEIPT.TRANSACTION_ID%TYPE,
15:21:29 129  	  in_purchase_date    IN CORE_OWNER.ITUNES_RECEIPT.PURCHASE_DATE%TYPE,
15:21:29 130  	  in_original_transaction_id IN CORE_OWNER.ITUNES_RECEIPT.ORIGINAL_TRANSACTION_ID%TYPE,
15:21:29 131  	  in_original_purchase_date IN CORE_OWNER.ITUNES_RECEIPT.ORIGINAL_PURCHASE_DATE%TYPE,
15:21:29 132  	  in_app_item_id      IN CORE_OWNER.ITUNES_RECEIPT.APP_ITEM_ID%TYPE,
15:21:29 133  	  in_version_external_id IN CORE_OWNER.ITUNES_RECEIPT.VERSION_EXTERNAL_ID%TYPE,
15:21:29 134  	  in_bid	      IN CORE_OWNER.ITUNES_RECEIPT.BID%TYPE,
15:21:29 135  	  in_bvrs	      IN CORE_OWNER.ITUNES_RECEIPT.BVRS%TYPE,
15:21:29 136  	  in_expires_date     IN CORE_OWNER.ITUNES_RECEIPT.EXPIRES_DATE%TYPE,
15:21:29 137  	  in_updated_by       IN CORE_OWNER.ITUNES_RECEIPT.UPDATED_BY%TYPE,
15:21:29 138  	  in_cancel_date      IN CORE_OWNER.ITUNES_RECEIPT.CANCEL_DATE%TYPE
15:21:29 139  ) AS
15:21:29 140  -- VARIABLES
15:21:29 141  SPROC_NAME	CONSTANT VARCHAR2(32) := 'UPDATE_RECEIPT';
15:21:29 142  var_current_date	    DATE;
15:21:29 143  BEGIN
15:21:29 144  
15:21:29 145  	SELECT
15:21:29 146  	  sysdate
15:21:29 147  	INTO
15:21:29 148  	  var_current_date
15:21:29 149  	FROM
15:21:29 150  	  dual
15:21:29 151  	;
15:21:29 152  
15:21:29 153  	FOR REC IN (SELECT * FROM CORE_OWNER.ITUNES_RECEIPT WHERE ID = in_id) LOOP
15:21:29 154  	  CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V18.CREATE_ITUNES_RECEIPT_HISTORY
15:21:29 155  	  (
15:21:29 156  	      rec.id,
15:21:29 157  	      rec.subscription_id,
15:21:29 158  	      rec.receipt,
15:21:29 159  	      rec.status,
15:21:29 160  	      rec.quantity,
15:21:29 161  	      rec.product_id,
15:21:29 162  	      rec.transaction_id,
15:21:29 163  	      rec.purchase_date,
15:21:29 164  	      rec.original_transaction_id,
15:21:29 165  	      rec.original_purchase_date,
15:21:29 166  	      rec.app_item_id,
15:21:29 167  	      rec.version_external_id,
15:21:29 168  	      rec.bid,
15:21:29 169  	      rec.bvrs,
15:21:29 170  	      rec.expires_date,
15:21:29 171  	      rec.create_date,
15:21:29 172  	      rec.created_by,
15:21:29 173  	      rec.update_date,
15:21:29 174  	      rec.updated_by,
15:21:29 175  	      rec.last_check_date,
15:21:29 176  	      rec.cancel_date
15:21:29 177  	  );
15:21:29 178  	END LOOP;
15:21:29 179  
15:21:29 180  	UPDATE CORE_OWNER.ITUNES_RECEIPT
15:21:29 181  	SET
15:21:29 182  	  receipt = in_receipt,
15:21:29 183  	  status = in_status,
15:21:29 184  	  quantity = in_quantity,
15:21:29 185  	  product_id = in_product_id,
15:21:29 186  	  transaction_id = in_transaction_id,
15:21:29 187  	  purchase_date = in_purchase_date,
15:21:29 188  	  original_transaction_id = in_original_transaction_id,
15:21:29 189  	  original_purchase_date = in_original_purchase_date,
15:21:29 190  	  app_item_id = in_app_item_id,
15:21:29 191  	  version_external_id = in_version_external_id,
15:21:29 192  	  bid = in_bid,
15:21:29 193  	  bvrs = in_bvrs,
15:21:29 194  	  expires_date = in_expires_date,
15:21:29 195  	  update_date = var_current_date,
15:21:29 196  	  updated_by = in_updated_by,
15:21:29 197  	  last_check_date = var_current_date,
15:21:29 198  	  cancel_date = in_cancel_date
15:21:29 199  	WHERE
15:21:29 200  	  id = in_id
15:21:29 201  	;
15:21:29 202  
15:21:29 203  EXCEPTION
15:21:29 204  WHEN DUP_VAL_ON_INDEX THEN
15:21:29 205  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.DUPLICATE_ERROR,
15:21:29 206  	  SPROC_NAME, 'Duplicate value', SQLERRM);
15:21:29 207  WHEN OTHERS THEN
15:21:29 208  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:29 209  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:29 210  
15:21:29 211  END UPDATE_RECEIPT;
15:21:29 212  
15:21:29 213  PROCEDURE LINK_ITUNES_RECEIPT(
15:21:29 214  /*
15:21:29 215  Throws exceptions:
15:21:29 216  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 217  */
15:21:29 218  	  in_id 	      IN CORE_OWNER.ITUNES_RECEIPT.ID%TYPE,
15:21:29 219  	  in_subscription_id  IN CORE_OWNER.ITUNES_RECEIPT.SUBSCRIPTION_ID%TYPE,
15:21:29 220  	  in_updated_by       IN CORE_OWNER.ITUNES_RECEIPT.UPDATED_BY%TYPE
15:21:29 221  ) AS
15:21:29 222  -- VARIABLES
15:21:29 223  SPROC_NAME	CONSTANT VARCHAR2(32) := 'LINK_ITUNES_RECEIPT';
15:21:29 224  var_current_date	    DATE;
15:21:29 225  BEGIN
15:21:29 226  
15:21:29 227  	      SELECT
15:21:29 228  	  sysdate
15:21:29 229  	      INTO
15:21:29 230  	  var_current_date
15:21:29 231  	      FROM
15:21:29 232  	  dual
15:21:29 233  	      ;
15:21:29 234  
15:21:29 235  	      FOR REC IN (SELECT * FROM CORE_OWNER.ITUNES_RECEIPT WHERE ID = in_id) LOOP
15:21:29 236  	      CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V18.CREATE_ITUNES_RECEIPT_HISTORY
15:21:29 237  	      (
15:21:29 238  	    rec.id,
15:21:29 239  	    rec.subscription_id,
15:21:29 240  	    rec.receipt,
15:21:29 241  	    rec.status,
15:21:29 242  	    rec.quantity,
15:21:29 243  	    rec.product_id,
15:21:29 244  	    rec.transaction_id,
15:21:29 245  	    rec.purchase_date,
15:21:29 246  	    rec.original_transaction_id,
15:21:29 247  	    rec.original_purchase_date,
15:21:29 248  	    rec.app_item_id,
15:21:29 249  	    rec.version_external_id,
15:21:29 250  	    rec.bid,
15:21:29 251  	    rec.bvrs,
15:21:29 252  	    rec.expires_date,
15:21:29 253  	    rec.create_date,
15:21:29 254  	    rec.created_by,
15:21:29 255  	    rec.update_date,
15:21:29 256  	    rec.updated_by,
15:21:29 257  	    rec.last_check_date,
15:21:29 258  	    rec.cancel_date
15:21:29 259  	      );
15:21:29 260  	      END LOOP;
15:21:29 261  
15:21:29 262  	      UPDATE CORE_OWNER.ITUNES_RECEIPT
15:21:29 263  		SET
15:21:29 264  		      subscription_id = in_subscription_id,
15:21:29 265  		      update_date = var_current_date,
15:21:29 266  	      updated_by = in_updated_by,
15:21:29 267  	      last_check_date = var_current_date
15:21:29 268  	      WHERE
15:21:29 269  		  id = in_id
15:21:29 270  	      ;
15:21:29 271  
15:21:29 272  	      EXCEPTION
15:21:29 273  	      WHEN DUP_VAL_ON_INDEX THEN
15:21:29 274  		PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.DUPLICATE_ERROR,
15:21:29 275  		  SPROC_NAME, 'Duplicate value', SQLERRM);
15:21:29 276  	      WHEN OTHERS THEN
15:21:29 277  		PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:29 278  		  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:29 279  END LINK_ITUNES_RECEIPT;
15:21:29 280  
15:21:29 281  
15:21:29 282  PROCEDURE MARK_RECEIPT_CHECKED(
15:21:29 283  /*
15:21:29 284  Throws exceptions:
15:21:29 285  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:29 286  */
15:21:29 287  	  in_id       IN CORE_OWNER.ITUNES_RECEIPT.ID%TYPE
15:21:29 288  ) AS
15:21:29 289  SPROC_NAME	CONSTANT VARCHAR2(32) := 'MARK_RECEIPT_CHECKED';
15:21:29 290  BEGIN
15:21:29 291  	UPDATE
15:21:29 292  	  CORE_OWNER.ITUNES_RECEIPT
15:21:29 293  	SET
15:21:29 294  	  last_check_date = sysdate
15:21:29 295  	WHERE
15:21:29 296  	  id = in_id
15:21:29 297  	;
15:21:29 298  EXCEPTION
15:21:29 299  WHEN OTHERS THEN
15:21:29 300  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:29 301  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:29 302  END MARK_RECEIPT_CHECKED;
15:21:29 303  
15:21:29 304  END PROCS_ITUNES_RECEIPT_CRU_V18;
15:21:29 305  .
15:21:29 SQL> /

Package body created.

Elapsed: 00:00:00.05
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_LICENSE_CRU_V18" AS
15:21:29   2  
15:21:29   3  PROCEDURE CREATE_LICENSE(
15:21:29   4  	out_license_id		    OUT LICENSE.ID%TYPE,
15:21:29   5  	in_license_id		    IN LICENSE.ID%TYPE DEFAULT NULL,
15:21:29   6  	in_license_status_id	    IN LICENSE.LICENSE_STATUS_ID%TYPE,
15:21:29   7  	in_needs_entitlements	    IN LICENSE.NEEDS_ENTITLEMENTS%TYPE,
15:21:29   8  	in_start_date		    IN LICENSE.START_DATE%TYPE,
15:21:29   9  	in_offer_id		    IN LICENSE.OFFER_ID%TYPE,
15:21:29  10  	in_subscription_id	    IN LICENSE.SUBSCRIPTION_ID%TYPE,
15:21:29  11  	in_invoice_id		    IN LICENSE.INVOICE_ID%TYPE,
15:21:29  12  	in_end_date		    IN LICENSE.END_DATE%TYPE,
15:21:29  13  	in_created_by		    IN LICENSE.CREATED_BY%TYPE,
15:21:29  14  	in_is_extension 	    IN LICENSE.IS_EXTENSION%TYPE,
15:21:29  15  	in_current_offer_index	    IN LICENSE.CURRENT_OFFER_INDEX%TYPE,
15:21:29  16  	in_current_offer_recurr_num IN LICENSE.CURRENT_OFFER_RECURR_NUM%TYPE
15:21:29  17  ) AS
15:21:29  18  -- VARIABLES
15:21:29  19  var_license_id LICENSE.ID%TYPE;
15:21:29  20  -- arosolovskiy: using data variable instead of direct get data calls (#38860)
15:21:29  21  var_date DATE := SYSDATE;
15:21:29  22  BEGIN
15:21:29  23  	IF in_license_id IS NULL THEN
15:21:29  24  	  SELECT
15:21:29  25  	    LCN_ID_SEQ.nextVal into var_license_id
15:21:29  26  	  FROM DUAL;
15:21:29  27  	ELSE
15:21:29  28  	  var_license_id := in_license_id;
15:21:29  29  	END IF;
15:21:29  30  	INSERT INTO
15:21:29  31  	  LICENSE (
15:21:29  32  	    ID,
15:21:29  33  	    LICENSE_STATUS_ID,
15:21:29  34  	    NEEDS_ENTITLEMENTS,
15:21:29  35  	    START_DATE,
15:21:29  36  	    OFFER_ID,
15:21:29  37  	    SUBSCRIPTION_ID,
15:21:29  38  	    INVOICE_ID,
15:21:29  39  	    END_DATE,
15:21:29  40  	    CREATE_DATE,
15:21:29  41  	    CREATED_BY,
15:21:29  42  	    UPDATE_DATE,
15:21:29  43  	    UPDATED_BY,
15:21:29  44  	    IS_EXTENSION,
15:21:29  45  	    CURRENT_OFFER_INDEX,
15:21:29  46  	    CURRENT_OFFER_RECURR_NUM,
15:21:29  47  	    ENTITLEMENT_END_DATE
15:21:29  48  	  ) VALUES (
15:21:29  49  	    var_license_id,
15:21:29  50  	    in_license_status_id,
15:21:29  51  	    in_needs_entitlements,
15:21:29  52  	    in_start_date,
15:21:29  53  	    in_offer_id,
15:21:29  54  	    in_subscription_id,
15:21:29  55  	    in_invoice_id,
15:21:29  56  	    in_end_date,
15:21:29  57  	    var_date,
15:21:29  58  	    in_created_by,
15:21:29  59  	    var_date,
15:21:29  60  	    in_created_by,
15:21:29  61  	    in_is_extension,
15:21:29  62  	    in_current_offer_index,
15:21:29  63  	    in_current_offer_recurr_num,
15:21:29  64  	    in_end_date
15:21:29  65  	  );
15:21:29  66  
15:21:29  67  	out_license_id := var_license_id;
15:21:29  68  END CREATE_LICENSE;
15:21:29  69  
15:21:29  70  /********************************************************************/
15:21:29  71  
15:21:29  72  PROCEDURE UPDATE_LICENSE (
15:21:29  73  	in_license_id		    IN LICENSE.ID%TYPE,
15:21:29  74  	in_license_status_id	    IN LICENSE.LICENSE_STATUS_ID%TYPE DEFAULT NULL,
15:21:29  75  	in_needs_entitlements	    IN LICENSE.NEEDS_ENTITLEMENTS%TYPE DEFAULT NULL,
15:21:29  76  	in_start_date		    IN LICENSE.START_DATE%TYPE DEFAULT NULL,
15:21:29  77  	in_end_date		    IN LICENSE.END_DATE%TYPE DEFAULT NULL,
15:21:29  78  	in_updated_by		    IN LICENSE.CREATED_BY%TYPE,
15:21:29  79  	in_is_extension 	    IN LICENSE.IS_EXTENSION%TYPE DEFAULT NULL,
15:21:29  80  	in_current_offer_index	    IN LICENSE.CURRENT_OFFER_INDEX%TYPE DEFAULT NULL,
15:21:29  81  	in_current_offer_recurr_num IN LICENSE.CURRENT_OFFER_RECURR_NUM%TYPE DEFAULT NULL,
15:21:29  82  	in_entitlement_end_date     IN LICENSE.ENTITLEMENT_END_DATE%TYPE DEFAULT NULL,
15:21:29  83  	in_grace_start_date	    IN LICENSE.GRACE_START_DATE%TYPE DEFAULT NULL,
15:21:29  84  	in_grace_end_date	    IN LICENSE.GRACE_END_DATE%TYPE DEFAULT NULL
15:21:29  85  ) AS
15:21:29  86  BEGIN
15:21:29  87  	-- Create history
15:21:29  88  	PROCS_HISTORY_V18.CREATE_LICENSE_HISTORY(
15:21:29  89  	  in_license_id 	       => in_license_id,
15:21:29  90  	  in_system_activity_reason_id => GLOBAL_ENUMS_V18.SAC_SYSTEM_APPLIED_RULE
15:21:29  91  	);
15:21:29  92  
15:21:29  93  	UPDATE
15:21:29  94  	  LICENSE
15:21:29  95  	SET
15:21:29  96  	  LICENSE_STATUS_ID	   = NVL(in_license_status_id, LICENSE_STATUS_ID),
15:21:29  97  	  NEEDS_ENTITLEMENTS	   = NVL(in_needs_entitlements, NEEDS_ENTITLEMENTS),
15:21:29  98  	  START_DATE		   = NVL(in_start_date, START_DATE),
15:21:29  99  	  END_DATE		   = NVL(in_end_date, END_DATE),
15:21:29 100  	  UPDATE_DATE		   = SYSDATE,
15:21:29 101  	  UPDATED_BY		   = in_updated_by,
15:21:29 102  	  IS_EXTENSION		   = NVL(in_is_extension, IS_EXTENSION),
15:21:29 103  	  CURRENT_OFFER_INDEX	   = NVL(in_current_offer_index, CURRENT_OFFER_INDEX),
15:21:29 104  	  CURRENT_OFFER_RECURR_NUM = NVL(in_current_offer_recurr_num, CURRENT_OFFER_RECURR_NUM),
15:21:29 105  	  ENTITLEMENT_END_DATE	   = NVL(in_entitlement_end_date, ENTITLEMENT_END_DATE),
15:21:29 106  	  GRACE_START_DATE	   = NVL(in_grace_start_date, GRACE_START_DATE),
15:21:29 107  	  GRACE_END_DATE	   = NVL(in_grace_end_date, GRACE_END_DATE)
15:21:29 108  	WHERE
15:21:29 109  	  LICENSE.ID = in_license_id;
15:21:29 110  END UPDATE_LICENSE;
15:21:29 111  
15:21:29 112  END PROCS_LICENSE_CRU_V18;
15:21:29 113  .
15:21:29 SQL> /

Package body created.

Elapsed: 00:00:00.06
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_LINE_ITEMS_CRU_V18" AS
15:21:29   2  
15:21:29   3  PROCEDURE CREATE_LINE_ITEM (
15:21:29   4  	inout_line_item_id  IN OUT LINE_ITEM.ID%TYPE,
15:21:29   5  	in_product_offer_id IN LINE_ITEM.PRODUCT_OFFER_ID%TYPE,
15:21:29   6  	in_invoice_id	    IN LINE_ITEM.INVOICE_ID%TYPE,
15:21:29   7  	in_amount	    IN LINE_ITEM.AMOUNT%TYPE,
15:21:29   8  	in_created_by	    IN LINE_ITEM.CREATED_BY%TYPE,
15:21:29   9  	in_discount_amount  IN LINE_ITEM.DISCOUNT_AMOUNT%TYPE,
15:21:29  10  	in_taxes_amount     IN LINE_ITEM.TAXES_AMOUNT%TYPE
15:21:29  11  ) AS
15:21:29  12  BEGIN
15:21:29  13  	IF inout_line_item_id IS NULL THEN
15:21:29  14  	  SELECT
15:21:29  15  	    LI_ID_SEQ.nextVal into inout_line_item_id
15:21:29  16  	  FROM DUAL;
15:21:29  17  	END IF;
15:21:29  18  	INSERT INTO LINE_ITEM (
15:21:29  19  	  ID,
15:21:29  20  	  PRODUCT_OFFER_ID,
15:21:29  21  	  INVOICE_ID,
15:21:29  22  	  AMOUNT,
15:21:29  23  	  QUANTITY,
15:21:29  24  	  CREATE_DATE,
15:21:29  25  	  CREATED_BY,
15:21:29  26  	  DISCOUNT_AMOUNT,
15:21:29  27  	  TAXES_AMOUNT
15:21:29  28  	) VALUES (
15:21:29  29  	  inout_line_item_id,
15:21:29  30  	  in_product_offer_id,
15:21:29  31  	  in_invoice_id,
15:21:29  32  	  in_amount,
15:21:29  33  	  1, -- [REVU]: Deprecated. Ignore this field
15:21:29  34  	  SYSDATE,
15:21:29  35  	  in_created_by,
15:21:29  36  	  in_discount_amount,
15:21:29  37  	  in_taxes_amount
15:21:29  38  	);
15:21:29  39  END CREATE_LINE_ITEM;
15:21:29  40  
15:21:29  41  /******************************************************************************/
15:21:29  42  
15:21:29  43  PROCEDURE UPDATE_LINE_ITEM (
15:21:29  44  	in_line_item_id     IN LINE_ITEM.ID%TYPE,
15:21:29  45  	in_amount	    IN LINE_ITEM.AMOUNT%TYPE DEFAULT NULL,
15:21:29  46  	in_discount_amount  IN LINE_ITEM.DISCOUNT_AMOUNT%TYPE  DEFAULT NULL,
15:21:29  47  	in_taxes_amount     IN LINE_ITEM.TAXES_AMOUNT%TYPE DEFAULT NULL
15:21:29  48  ) AS
15:21:29  49  BEGIN
15:21:29  50  	UPDATE
15:21:29  51  	  LINE_ITEM
15:21:29  52  	SET
15:21:29  53  	  LINE_ITEM.AMOUNT	    = NVL(in_amount, LINE_ITEM.AMOUNT),
15:21:29  54  	  LINE_ITEM.DISCOUNT_AMOUNT = NVL(in_discount_amount, LINE_ITEM.DISCOUNT_AMOUNT),
15:21:29  55  	  LINE_ITEM.TAXES_AMOUNT    = NVL(in_taxes_amount, LINE_ITEM.TAXES_AMOUNT)
15:21:29  56  	WHERE
15:21:29  57  	  LINE_ITEM.ID = in_line_item_id;
15:21:29  58  END UPDATE_LINE_ITEM;
15:21:29  59  
15:21:29  60  /******************************************************************************/
15:21:29  61  
15:21:29  62  PROCEDURE CREATE_DISCOUNT_LINE_ITEM (
15:21:29  63  	in_discount_id	IN DISCOUNT.ID%TYPE,
15:21:29  64  	in_line_item_id IN LINE_ITEM.ID%TYPE
15:21:29  65  ) AS
15:21:29  66  BEGIN
15:21:29  67  	INSERT INTO DISCOUNT_LINE_ITEM(
15:21:29  68  	  DISCOUNT_ID,
15:21:29  69  	  LINE_ITEM_ID
15:21:29  70  	) VALUES (
15:21:29  71  	  in_discount_id,
15:21:29  72  	  in_line_item_id
15:21:29  73  	);
15:21:29  74  END CREATE_DISCOUNT_LINE_ITEM;
15:21:29  75  
15:21:29  76  END PROCS_LINE_ITEMS_CRU_V18;
15:21:29  77  .
15:21:29 SQL> /

Package body created.

Elapsed: 00:00:00.03
15:21:29 SQL> 
15:21:29 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_RECONCILIATION_CRU_V18" AS
15:21:29   2  
15:21:29   3  PROCEDURE CREATE_CPT_CHARGEBACK_ACT (
15:21:29   4  	out_cpt_chargeback_act_id   OUT RCN_CPT_CHARGEBACK_ACT_DETAIL.ID%TYPE,
15:21:29   5  	in_cpt_chargeback_act_id    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.ID%TYPE DEFAULT NULL,
15:21:29   6  	in_ext_source_log_id	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.RCN_EXT_SOURCE_LOG_ID%TYPE,
15:21:29   7  	in_record_type		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.RECORD_TYPE%TYPE,
15:21:29   8  	in_entity_type		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.ENTITY_TYPE%TYPE,
15:21:29   9  	in_entity_number	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.ENTITY_NUMBER%TYPE,
15:21:29  10  	in_chargeback_amount_issuer IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CHARGEBACK_AMOUNT_ISSUER%TYPE,
15:21:29  11  	in_prev_partial_repres	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.PREV_PARTIAL_REPRESENTMENT%TYPE,
15:21:29  12  	in_presentment_currency     IN RCN_CPT_CHARGEBACK_ACT_DETAIL.PRESENTMENT_CURRENCY%TYPE,
15:21:29  13  	in_chargeback_category	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CHARGEBACK_CATEGORY%TYPE,
15:21:29  14  	in_status_flag		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.STATUS_FLAG%TYPE,
15:21:29  15  	in_sequence_number	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.SEQUENCE_NUMBER%TYPE,
15:21:29  16  	in_merchant_order_number    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.MERCHANT_ORDER_NUMBER%TYPE,
15:21:29  17  	in_account_number	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.ACCOUNT_NUMBER%TYPE,
15:21:29  18  	in_reason_code		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.REASON_CODE%TYPE,
15:21:29  19  	in_transaction_date	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.TRANSACTION_DATE%TYPE,
15:21:29  20  	in_chargeback_date	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CHARGEBACK_DATE%TYPE,
15:21:29  21  	in_activity_date	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.ACTIVITY_DATE%TYPE,
15:21:29  22  	in_chargeback_amount_action IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CHARGEBACK_AMOUNT_ACTION%TYPE,
15:21:29  23  	in_fee_amount		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.FEE_AMOUNT%TYPE,
15:21:29  24  	in_usage_code		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.USAGE_CODE%TYPE,
15:21:29  25  	in_mop_code		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.MOP_CODE%TYPE,
15:21:29  26  	in_authorization_date	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.AUTHORIZATION_DATE%TYPE,
15:21:29  27  	in_chargeback_due_date	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CHARGEBACK_DUE_DATE%TYPE,
15:21:29  28  	in_created_by		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CREATED_BY%TYPE
15:21:29  29  ) AS
15:21:29  30  -- VARIABLES
15:21:29  31  var_cpt_chargeback_act_id RCN_CPT_CHARGEBACK_ACT_DETAIL.ID%TYPE;
15:21:29  32  var_date DATE := SYSDATE;
15:21:29  33  BEGIN
15:21:29  34  	IF in_cpt_chargeback_act_id IS NULL THEN
15:21:29  35  	  SELECT
15:21:29  36  	    RCN_CPT_CHRGBK_ACT_DETAIL_SEQ.nextVal into var_cpt_chargeback_act_id
15:21:29  37  	  FROM DUAL;
15:21:29  38  	ELSE
15:21:29  39  	  var_cpt_chargeback_act_id := in_cpt_chargeback_act_id;
15:21:29  40  	END IF;
15:21:29  41  	INSERT INTO
15:21:29  42  	  RCN_CPT_CHARGEBACK_ACT_DETAIL (
15:21:29  43  	    id,
15:21:29  44  	    rcn_ext_source_log_id,
15:21:29  45  	    record_type,
15:21:29  46  	    entity_type,
15:21:29  47  	    entity_number,
15:21:29  48  	    chargeback_amount_issuer,
15:21:29  49  	    prev_partial_representment,
15:21:29  50  	    presentment_currency,
15:21:29  51  	    chargeback_category,
15:21:29  52  	    status_flag,
15:21:29  53  	    sequence_number,
15:21:29  54  	    merchant_order_number,
15:21:29  55  	    account_number,
15:21:29  56  	    reason_code,
15:21:29  57  	    transaction_date,
15:21:29  58  	    chargeback_date,
15:21:29  59  	    activity_date,
15:21:29  60  	    chargeback_amount_action,
15:21:29  61  	    fee_amount,
15:21:29  62  	    usage_code,
15:21:29  63  	    mop_code,
15:21:29  64  	    authorization_date,
15:21:29  65  	    chargeback_due_date,
15:21:29  66  	    create_date,
15:21:29  67  	    created_by
15:21:29  68  	  ) VALUES (
15:21:29  69  	    var_cpt_chargeback_act_id,
15:21:29  70  	    in_ext_source_log_id,
15:21:29  71  	    in_record_type,
15:21:29  72  	    in_entity_type,
15:21:29  73  	    in_entity_number,
15:21:29  74  	    in_chargeback_amount_issuer,
15:21:29  75  	    in_prev_partial_repres,
15:21:29  76  	    in_presentment_currency,
15:21:29  77  	    in_chargeback_category,
15:21:29  78  	    in_status_flag,
15:21:29  79  	    in_sequence_number,
15:21:29  80  	    in_merchant_order_number,
15:21:29  81  	    in_account_number,
15:21:29  82  	    in_reason_code,
15:21:29  83  	    in_transaction_date,
15:21:29  84  	    in_chargeback_date,
15:21:29  85  	    in_activity_date,
15:21:29  86  	    in_chargeback_amount_action,
15:21:29  87  	    in_fee_amount,
15:21:29  88  	    in_usage_code,
15:21:29  89  	    in_mop_code,
15:21:29  90  	    in_authorization_date,
15:21:29  91  	    in_chargeback_due_date,
15:21:29  92  	    var_date,
15:21:29  93  	    in_created_by
15:21:29  94  	  );
15:21:29  95  
15:21:29  96  	out_cpt_chargeback_act_id := var_cpt_chargeback_act_id;
15:21:29  97  END CREATE_CPT_CHARGEBACK_ACT;
15:21:29  98  
15:21:29  99  PROCEDURE CREATE_EXT_SOURCE_LOG (
15:21:29 100  	out_ext_source_log_id	    OUT RCN_EXT_SOURCE_LOG.ID%TYPE,
15:21:29 101  	in_ext_source_log_id	    IN RCN_EXT_SOURCE_LOG.ID%TYPE DEFAULT NULL,
15:21:29 102  	in_extraction_timestamp     IN RCN_EXT_SOURCE_LOG.EXTRACTION_TIMESTAMP%TYPE,
15:21:29 103  	in_report_date		    IN RCN_EXT_SOURCE_LOG.REPORT_DATE%TYPE,
15:21:29 104  	in_report_gen_datetime	    IN RCN_EXT_SOURCE_LOG.REPORT_GENERATION_DATETIME%TYPE,
15:21:29 105  	in_record_type		    IN RCN_EXT_SOURCE_LOG.RECORD_TYPE%TYPE,
15:21:29 106  	in_report_file_name	    IN RCN_EXT_SOURCE_LOG.REPORT_FILE_NAME%TYPE,
15:21:29 107  	in_created_by		    IN RCN_EXT_SOURCE_LOG.CREATED_BY%TYPE
15:21:29 108  ) AS
15:21:29 109  -- VARIABLES
15:21:29 110  var_ext_source_log_id RCN_EXT_SOURCE_LOG.ID%TYPE;
15:21:29 111  var_date DATE := SYSDATE;
15:21:29 112  BEGIN
15:21:29 113  	IF in_ext_source_log_id IS NULL THEN
15:21:29 114  	  SELECT
15:21:29 115  	    RCN_EXT_SOURCE_LOG_SEQ.nextVal into var_ext_source_log_id
15:21:29 116  	  FROM DUAL;
15:21:29 117  	ELSE
15:21:29 118  	  var_ext_source_log_id := in_ext_source_log_id;
15:21:29 119  	END IF;
15:21:29 120  	INSERT INTO
15:21:29 121  	  RCN_EXT_SOURCE_LOG (
15:21:29 122  	    id,
15:21:29 123  	    extraction_timestamp,
15:21:29 124  	    report_date,
15:21:29 125  	    report_generation_datetime,
15:21:29 126  	    record_type,
15:21:29 127  	    report_file_name,
15:21:29 128  	    create_date,
15:21:29 129  	    created_by
15:21:29 130  	  ) VALUES (
15:21:29 131  	    var_ext_source_log_id,
15:21:29 132  	    in_extraction_timestamp,
15:21:29 133  	    in_report_date,
15:21:29 134  	    in_report_gen_datetime,
15:21:29 135  	    in_record_type,
15:21:29 136  	    in_report_file_name,
15:21:29 137  	    var_date,
15:21:29 138  	    in_created_by
15:21:29 139  	  );
15:21:29 140  
15:21:29 141  	out_ext_source_log_id := var_ext_source_log_id;
15:21:29 142  END CREATE_EXT_SOURCE_LOG;
15:21:29 143  
15:21:29 144  PROCEDURE CREATE_CPT_SERVICE_CHARGE (
15:21:29 145  	out_cpt_service_charge_id   OUT RCN_CPT_SERVICE_CHARGE_DETAIL.ID%TYPE,
15:21:29 146  	in_cpt_service_charge_id    IN RCN_CPT_SERVICE_CHARGE_DETAIL.ID%TYPE DEFAULT NULL,
15:21:29 147  	in_ext_source_log_id	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.RCN_EXT_SOURCE_LOG_ID%TYPE,
15:21:29 148  	in_record_type		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.RECORD_TYPE%TYPE,
15:21:29 149  	in_category		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.CATEGORY%TYPE,
15:21:29 150  	in_sub_category 	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.SUB_CATEGORY%TYPE,
15:21:29 151  	in_entity_type		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.ENTITY_TYPE%TYPE,
15:21:29 152  	in_entity_number	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.ENTITY_NUMBER%TYPE,
15:21:29 153  	in_funds_trans_inst_number  IN RCN_CPT_SERVICE_CHARGE_DETAIL.FUNDS_TRANSFER_INST_NUMBER%TYPE,
15:21:29 154  	in_secure_ba_number	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.SECURE_BA_NUMBER%TYPE,
15:21:29 155  	in_settlement_currency	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.SETTLEMENT_CURRENCY%TYPE,
15:21:29 156  	in_fee_schedule 	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.FEE_SCHEDULE%TYPE,
15:21:29 157  	in_mop			    IN RCN_CPT_SERVICE_CHARGE_DETAIL.MOP%TYPE,
15:21:29 158  	in_interchange_qual	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.INTERCHANGE_QUALIFICATION%TYPE,
15:21:29 159  	in_fee_type_description     IN RCN_CPT_SERVICE_CHARGE_DETAIL.FEE_TYPE_DESCRIPTION%TYPE,
15:21:29 160  	in_action_type		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.ACTION_TYPE%TYPE,
15:21:29 161  	in_unit_quantity	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.UNIT_QUANTITY%TYPE,
15:21:29 162  	in_unit_fee		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.UNIT_FEE%TYPE,
15:21:29 163  	in_amount		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.AMOUNT%TYPE,
15:21:29 164  	in_percentage_rate	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.PERCENTAGE_RATE%TYPE,
15:21:29 165  	in_total_charge 	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.TOTAL_CHARGE%TYPE,
15:21:29 166  	in_created_by		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.CREATED_BY%TYPE
15:21:29 167  ) AS
15:21:29 168  -- VARIABLES
15:21:29 169  var_cpt_service_charge_id RCN_CPT_SERVICE_CHARGE_DETAIL.ID%TYPE;
15:21:29 170  var_date DATE := SYSDATE;
15:21:29 171  BEGIN
15:21:29 172  	IF in_cpt_service_charge_id IS NULL THEN
15:21:29 173  	  SELECT
15:21:29 174  	    RCN_CPT_SERV_CHARGE_DETAIL_SEQ.nextVal into var_cpt_service_charge_id
15:21:29 175  	  FROM DUAL;
15:21:29 176  	ELSE
15:21:29 177  	  var_cpt_service_charge_id := in_cpt_service_charge_id;
15:21:29 178  	END IF;
15:21:29 179  	INSERT INTO
15:21:29 180  	  RCN_CPT_SERVICE_CHARGE_DETAIL (
15:21:29 181  	    id,
15:21:29 182  	    rcn_ext_source_log_id,
15:21:29 183  	    record_type,
15:21:29 184  	    category,
15:21:29 185  	    sub_category,
15:21:29 186  	    entity_type,
15:21:29 187  	    entity_number,
15:21:29 188  	    funds_transfer_inst_number,
15:21:29 189  	    secure_ba_number,
15:21:29 190  	    settlement_currency,
15:21:29 191  	    fee_schedule,
15:21:29 192  	    mop,
15:21:29 193  	    interchange_qualification,
15:21:29 194  	    fee_type_description,
15:21:29 195  	    action_type,
15:21:29 196  	    unit_quantity,
15:21:29 197  	    unit_fee,
15:21:29 198  	    amount,
15:21:29 199  	    percentage_rate,
15:21:29 200  	    total_charge,
15:21:29 201  	    create_date,
15:21:29 202  	    created_by
15:21:29 203  	  ) VALUES (
15:21:29 204  	    var_cpt_service_charge_id,
15:21:29 205  	    in_ext_source_log_id,
15:21:29 206  	    in_record_type,
15:21:29 207  	    in_category,
15:21:29 208  	    in_sub_category,
15:21:29 209  	    in_entity_type,
15:21:29 210  	    in_entity_number,
15:21:29 211  	    in_funds_trans_inst_number,
15:21:29 212  	    in_secure_ba_number,
15:21:29 213  	    in_settlement_currency,
15:21:29 214  	    in_fee_schedule,
15:21:29 215  	    in_mop,
15:21:29 216  	    in_interchange_qual,
15:21:29 217  	    in_fee_type_description,
15:21:29 218  	    in_action_type,
15:21:29 219  	    in_unit_quantity,
15:21:29 220  	    in_unit_fee,
15:21:29 221  	    in_amount,
15:21:29 222  	    in_percentage_rate,
15:21:29 223  	    in_total_charge,
15:21:29 224  	    var_date,
15:21:29 225  	    in_created_by
15:21:29 226  	  );
15:21:29 227  
15:21:29 228  	out_cpt_service_charge_id := var_cpt_service_charge_id;
15:21:29 229  END CREATE_CPT_SERVICE_CHARGE;
15:21:29 230  
15:21:29 231  PROCEDURE CREATE_CPT_EXCEPTION (
15:21:29 232  	out_cpt_exception_id	 OUT RCN_CPT_EXCEPTION_DETAIL.ID%TYPE,
15:21:29 233  	in_cpt_exception_id	 IN RCN_CPT_EXCEPTION_DETAIL.ID%TYPE DEFAULT NULL,
15:21:29 234  	in_ext_source_log_id	 IN RCN_CPT_EXCEPTION_DETAIL.RCN_EXT_SOURCE_LOG_ID%TYPE,
15:21:29 235  	in_record_type		 IN RCN_CPT_EXCEPTION_DETAIL.RECORD_TYPE%TYPE,
15:21:29 236  	in_submission_date	 IN RCN_CPT_EXCEPTION_DETAIL.SUBMISSION_DATE%TYPE,
15:21:29 237  	in_pid_number		 IN RCN_CPT_EXCEPTION_DETAIL.PID_NUMBER%TYPE,
15:21:29 238  	in_pid_short_name	 IN RCN_CPT_EXCEPTION_DETAIL.PID_SHORT_NAME%TYPE,
15:21:29 239  	in_submission_number	 IN RCN_CPT_EXCEPTION_DETAIL.SUBMISSION_NUMBER%TYPE,
15:21:29 240  	in_record_number	 IN RCN_CPT_EXCEPTION_DETAIL.RECORD_NUMBER%TYPE,
15:21:29 241  	in_entity_type		 IN RCN_CPT_EXCEPTION_DETAIL.ENTITY_TYPE%TYPE,
15:21:29 242  	in_entity_number	 IN RCN_CPT_EXCEPTION_DETAIL.ENTITY_NUMBER%TYPE,
15:21:29 243  	in_presentment_currency  IN RCN_CPT_EXCEPTION_DETAIL.PRESENTMENT_CURRENCY%TYPE,
15:21:29 244  	in_merchant_order_number IN RCN_CPT_EXCEPTION_DETAIL.MERCHANT_ORDER_NUMBER%TYPE,
15:21:29 245  	in_rdfi_number		 IN RCN_CPT_EXCEPTION_DETAIL.RDFI_NUMBER%TYPE,
15:21:29 246  	in_account_number	 IN RCN_CPT_EXCEPTION_DETAIL.ACCOUNT_NUMBER%TYPE,
15:21:29 247  	in_expiration_date	 IN RCN_CPT_EXCEPTION_DETAIL.EXPIRATION_DATE%TYPE,
15:21:29 248  	in_amount		 IN RCN_CPT_EXCEPTION_DETAIL.AMOUNT%TYPE,
15:21:29 249  	in_mop			 IN RCN_CPT_EXCEPTION_DETAIL.MOP%TYPE,
15:21:29 250  	in_action_code		 IN RCN_CPT_EXCEPTION_DETAIL.ACTION_CODE%TYPE,
15:21:29 251  	in_auth_date		 IN RCN_CPT_EXCEPTION_DETAIL.AUTH_DATE%TYPE,
15:21:29 252  	in_auth_code		 IN RCN_CPT_EXCEPTION_DETAIL.AUTH_CODE%TYPE,
15:21:29 253  	in_auth_response_code	 IN RCN_CPT_EXCEPTION_DETAIL.AUTH_RESPONSE_CODE%TYPE,
15:21:29 254  	in_trace_number 	 IN RCN_CPT_EXCEPTION_DETAIL.TRACE_NUMBER%TYPE,
15:21:29 255  	in_consumer_country_code IN RCN_CPT_EXCEPTION_DETAIL.CONSUMER_COUNTRY_CODE%TYPE,
15:21:29 256  	in_category		 IN RCN_CPT_EXCEPTION_DETAIL.CATEGORY%TYPE,
15:21:29 257  	in_mcc			 IN RCN_CPT_EXCEPTION_DETAIL.MCC%TYPE,
15:21:29 258  	in_reject_code		 IN RCN_CPT_EXCEPTION_DETAIL.REJECT_CODE%TYPE,
15:21:29 259  	in_submission_status	 IN RCN_CPT_EXCEPTION_DETAIL.SUBMISSION_STATUS%TYPE,
15:21:29 260  	in_created_by		 IN RCN_CPT_EXCEPTION_DETAIL.CREATED_BY%TYPE
15:21:29 261  ) AS
15:21:29 262  -- VARIABLES
15:21:29 263  var_cpt_exception_id RCN_CPT_EXCEPTION_DETAIL.ID%TYPE;
15:21:29 264  var_date DATE := SYSDATE;
15:21:29 265  BEGIN
15:21:29 266  	IF in_cpt_exception_id IS NULL THEN
15:21:29 267  	  SELECT
15:21:29 268  	    RCN_CPT_EXCEPTION_DETAIL_SEQ.nextVal into var_cpt_exception_id
15:21:29 269  	  FROM DUAL;
15:21:29 270  	ELSE
15:21:29 271  	  var_cpt_exception_id := in_cpt_exception_id;
15:21:29 272  	END IF;
15:21:29 273  	INSERT INTO
15:21:29 274  	  RCN_CPT_EXCEPTION_DETAIL (
15:21:29 275  	    id,
15:21:29 276  	    rcn_ext_source_log_id,
15:21:29 277  	    record_type,
15:21:29 278  	    submission_date,
15:21:29 279  	    pid_number,
15:21:29 280  	    pid_short_name,
15:21:29 281  	    submission_number,
15:21:29 282  	    record_number,
15:21:29 283  	    entity_type,
15:21:29 284  	    entity_number,
15:21:29 285  	    presentment_currency,
15:21:29 286  	    merchant_order_number,
15:21:29 287  	    rdfi_number,
15:21:29 288  	    account_number,
15:21:29 289  	    expiration_date,
15:21:29 290  	    amount,
15:21:29 291  	    mop,
15:21:29 292  	    action_code,
15:21:29 293  	    auth_date,
15:21:29 294  	    auth_code,
15:21:29 295  	    auth_response_code,
15:21:29 296  	    trace_number,
15:21:29 297  	    consumer_country_code,
15:21:29 298  	    category,
15:21:29 299  	    mcc,
15:21:29 300  	    reject_code,
15:21:29 301  	    submission_status,
15:21:29 302  	    create_date,
15:21:29 303  	    created_by
15:21:29 304  	  ) VALUES (
15:21:29 305  	    var_cpt_exception_id,
15:21:29 306  	    in_ext_source_log_id,
15:21:29 307  	    in_record_type,
15:21:29 308  	    in_submission_date,
15:21:29 309  	    in_pid_number,
15:21:29 310  	    in_pid_short_name,
15:21:29 311  	    in_submission_number,
15:21:29 312  	    in_record_number,
15:21:29 313  	    in_entity_type,
15:21:29 314  	    in_entity_number,
15:21:29 315  	    in_presentment_currency,
15:21:29 316  	    in_merchant_order_number,
15:21:29 317  	    in_rdfi_number,
15:21:29 318  	    in_account_number,
15:21:29 319  	    in_expiration_date,
15:21:29 320  	    in_amount,
15:21:29 321  	    in_mop,
15:21:29 322  	    in_action_code,
15:21:29 323  	    in_auth_date,
15:21:29 324  	    in_auth_code,
15:21:29 325  	    in_auth_response_code,
15:21:29 326  	    in_trace_number,
15:21:29 327  	    in_consumer_country_code,
15:21:29 328  	    in_category,
15:21:29 329  	    in_mcc,
15:21:29 330  	    in_reject_code,
15:21:29 331  	    in_submission_status,
15:21:29 332  	    var_date,
15:21:29 333  	    in_created_by
15:21:29 334  	  );
15:21:29 335  
15:21:29 336  	out_cpt_exception_id := var_cpt_exception_id;
15:21:29 337  END CREATE_CPT_EXCEPTION;
15:21:29 338  
15:21:29 339  PROCEDURE CREATE_CPT_DEPOSIT (
15:21:29 340  	out_cpt_deposit_id	  OUT RCN_CPT_DEPOSIT_DETAIL.ID%TYPE,
15:21:29 341  	in_cpt_deposit_id	  IN RCN_CPT_DEPOSIT_DETAIL.ID%TYPE DEFAULT NULL,
15:21:29 342  	in_ext_source_log_id	  IN RCN_CPT_DEPOSIT_DETAIL.RCN_EXT_SOURCE_LOG_ID%TYPE,
15:21:29 343  	in_record_type		  IN RCN_CPT_DEPOSIT_DETAIL.RECORD_TYPE%TYPE,
15:21:29 344  	in_submission_date	  IN RCN_CPT_DEPOSIT_DETAIL.SUBMISSION_DATE%TYPE,
15:21:29 345  	in_pid_number		  IN RCN_CPT_DEPOSIT_DETAIL.PID_NUMBER%TYPE,
15:21:29 346  	in_pid_short_name	  IN RCN_CPT_DEPOSIT_DETAIL.PID_SHORT_NAME%TYPE,
15:21:29 347  	in_submission_number	  IN RCN_CPT_DEPOSIT_DETAIL.SUBMISSION_NUMBER%TYPE,
15:21:29 348  	in_record_number	  IN RCN_CPT_DEPOSIT_DETAIL.RECORD_NUMBER%TYPE,
15:21:29 349  	in_entity_type		  IN RCN_CPT_DEPOSIT_DETAIL.ENTITY_TYPE%TYPE,
15:21:29 350  	in_entity_number	  IN RCN_CPT_DEPOSIT_DETAIL.ENTITY_NUMBER%TYPE,
15:21:29 351  	in_presentment_currency   IN RCN_CPT_DEPOSIT_DETAIL.PRESENTMENT_CURRENCY%TYPE,
15:21:29 352  	in_merchant_order_number  IN RCN_CPT_DEPOSIT_DETAIL.MERCHANT_ORDER_NUMBER%TYPE,
15:21:29 353  	in_rdfi_number		  IN RCN_CPT_DEPOSIT_DETAIL.RDFI_NUMBER%TYPE,
15:21:29 354  	in_account_number	  IN RCN_CPT_DEPOSIT_DETAIL.ACCOUNT_NUMBER%TYPE,
15:21:29 355  	in_expiration_date	  IN RCN_CPT_DEPOSIT_DETAIL.EXPIRATION_DATE%TYPE,
15:21:29 356  	in_amount		  IN RCN_CPT_DEPOSIT_DETAIL.AMOUNT%TYPE,
15:21:29 357  	in_mop			  IN RCN_CPT_DEPOSIT_DETAIL.MOP%TYPE,
15:21:29 358  	in_action_code		  IN RCN_CPT_DEPOSIT_DETAIL.ACTION_CODE%TYPE,
15:21:29 359  	in_auth_date		  IN RCN_CPT_DEPOSIT_DETAIL.AUTH_DATE%TYPE,
15:21:29 360  	in_auth_code		  IN RCN_CPT_DEPOSIT_DETAIL.AUTH_CODE%TYPE,
15:21:29 361  	in_auth_response_code	  IN RCN_CPT_DEPOSIT_DETAIL.AUTH_RESPONSE_CODE%TYPE,
15:21:29 362  	in_trace_number 	  IN RCN_CPT_DEPOSIT_DETAIL.TRACE_NUMBER%TYPE,
15:21:29 363  	in_consumer_country_code  IN RCN_CPT_DEPOSIT_DETAIL.CONSUMER_COUNTRY_CODE%TYPE,
15:21:29 364  	in_mcc			  IN RCN_CPT_DEPOSIT_DETAIL.MCC%TYPE,
15:21:29 365  	in_fee_code		  IN RCN_CPT_DEPOSIT_DETAIL.FEE_CODE%TYPE,
15:21:29 366  	in_unit_fee		  IN RCN_CPT_DEPOSIT_DETAIL.UNIT_FEE%TYPE,
15:21:29 367  	in_percent_fee		  IN RCN_CPT_DEPOSIT_DETAIL.PERCENT_FEE%TYPE,
15:21:29 368  	in_total_interchange_fee  IN RCN_CPT_DEPOSIT_DETAIL.TOTAL_INTERCHANGE_FEE%TYPE,
15:21:29 369  	in_total_assessment_fee   IN RCN_CPT_DEPOSIT_DETAIL.TOTAL_ASSESSMENT_FEE%TYPE,
15:21:29 370  	in_other_fee		  IN RCN_CPT_DEPOSIT_DETAIL.OTHER_FEE%TYPE,
15:21:29 371  	in_created_by		  IN RCN_CPT_DEPOSIT_DETAIL.CREATED_BY%TYPE
15:21:29 372  ) AS
15:21:29 373  -- VARIABLES
15:21:29 374  var_cpt_deposit_id RCN_CPT_DEPOSIT_DETAIL.ID%TYPE;
15:21:29 375  var_date DATE := SYSDATE;
15:21:29 376  BEGIN
15:21:29 377  	IF in_cpt_deposit_id IS NULL THEN
15:21:29 378  	  SELECT
15:21:29 379  	    RCN_CPT_DEPOSIT_DETAIL_SEQ.nextVal into var_cpt_deposit_id
15:21:29 380  	  FROM DUAL;
15:21:29 381  	ELSE
15:21:29 382  	  var_cpt_deposit_id := in_cpt_deposit_id;
15:21:29 383  	END IF;
15:21:29 384  	INSERT INTO
15:21:29 385  	  RCN_CPT_DEPOSIT_DETAIL (
15:21:29 386  	    id,
15:21:29 387  	    rcn_ext_source_log_id,
15:21:29 388  	    record_type,
15:21:29 389  	    submission_date,
15:21:29 390  	    pid_number,
15:21:29 391  	    pid_short_name,
15:21:29 392  	    submission_number,
15:21:29 393  	    record_number,
15:21:29 394  	    entity_type,
15:21:29 395  	    entity_number,
15:21:29 396  	    presentment_currency,
15:21:29 397  	    merchant_order_number,
15:21:29 398  	    rdfi_number,
15:21:29 399  	    account_number,
15:21:29 400  	    expiration_date,
15:21:29 401  	    amount,
15:21:29 402  	    mop,
15:21:29 403  	    action_code,
15:21:29 404  	    auth_date,
15:21:29 405  	    auth_code,
15:21:29 406  	    auth_response_code,
15:21:29 407  	    trace_number,
15:21:29 408  	    consumer_country_code,
15:21:29 409  	    mcc,
15:21:29 410  	    fee_code,
15:21:29 411  	    unit_fee,
15:21:29 412  	    percent_fee,
15:21:29 413  	    total_interchange_fee,
15:21:29 414  	    total_assessment_fee,
15:21:29 415  	    other_fee,
15:21:29 416  	    create_date,
15:21:29 417  	    created_by
15:21:29 418  	  ) VALUES (
15:21:29 419  	    var_cpt_deposit_id,
15:21:29 420  	    in_ext_source_log_id,
15:21:29 421  	    in_record_type,
15:21:29 422  	    in_submission_date,
15:21:29 423  	    in_pid_number,
15:21:29 424  	    in_pid_short_name,
15:21:29 425  	    in_submission_number,
15:21:29 426  	    in_record_number,
15:21:29 427  	    in_entity_type,
15:21:29 428  	    in_entity_number,
15:21:29 429  	    in_presentment_currency,
15:21:29 430  	    in_merchant_order_number,
15:21:29 431  	    in_rdfi_number,
15:21:29 432  	    in_account_number,
15:21:29 433  	    in_expiration_date,
15:21:29 434  	    in_amount,
15:21:29 435  	    in_mop,
15:21:29 436  	    in_action_code,
15:21:29 437  	    in_auth_date,
15:21:29 438  	    in_auth_code,
15:21:29 439  	    in_auth_response_code,
15:21:29 440  	    in_trace_number,
15:21:29 441  	    in_consumer_country_code,
15:21:29 442  	    in_mcc,
15:21:29 443  	    in_fee_code,
15:21:29 444  	    in_unit_fee,
15:21:29 445  	    in_percent_fee,
15:21:29 446  	    in_total_interchange_fee,
15:21:29 447  	    in_total_assessment_fee,
15:21:29 448  	    in_other_fee,
15:21:29 449  	    var_date,
15:21:29 450  	    in_created_by
15:21:29 451  	  );
15:21:29 452  
15:21:29 453  	out_cpt_deposit_id := var_cpt_deposit_id;
15:21:29 454  END CREATE_CPT_DEPOSIT;
15:21:29 455  
15:21:29 456  PROCEDURE CREATE_PP_SETTLEMENT (
15:21:29 457  	out_pp_settlement_id	   OUT RCN_PP_SETTLEMENT.ID%TYPE,
15:21:29 458  	in_pp_settlement_id	   IN RCN_PP_SETTLEMENT.ID%TYPE DEFAULT NULL,
15:21:29 459  	in_ext_source_log_id	   IN RCN_PP_SETTLEMENT.RCN_EXT_SOURCE_LOG_ID%TYPE,
15:21:29 460  	in_transaction_id	   IN RCN_PP_SETTLEMENT.TRANSACTION_ID%TYPE,
15:21:29 461  	in_invoice_id		   IN RCN_PP_SETTLEMENT.INVOICE_ID%TYPE,
15:21:29 462  	in_pp_ref_id		   IN RCN_PP_SETTLEMENT.PP_REF_ID%TYPE,
15:21:29 463  	in_pp_ref_id_type	   IN RCN_PP_SETTLEMENT.PP_REF_ID_TYPE%TYPE,
15:21:29 464  	in_trans_event_code	   IN RCN_PP_SETTLEMENT.TRANS_EVENT_CODE%TYPE,
15:21:29 465  	in_trans_init_date	   IN RCN_PP_SETTLEMENT.TRANS_INIT_DATE%TYPE,
15:21:29 466  	in_trans_comp_date	   IN RCN_PP_SETTLEMENT.TRANS_COMP_DATE%TYPE,
15:21:29 467  	in_trans_deb_or_cred	   IN RCN_PP_SETTLEMENT.TRANS_DEB_OR_CRED%TYPE,
15:21:29 468  	in_gross_trans_amount	   IN RCN_PP_SETTLEMENT.GROSS_TRANS_AMOUNT%TYPE,
15:21:29 469  	in_gross_trans_currency    IN RCN_PP_SETTLEMENT.GROSS_TRANS_CURRENCY%TYPE,
15:21:29 470  	in_fee_deb_or_cred	   IN RCN_PP_SETTLEMENT.FEE_DEB_OR_CRED%TYPE,
15:21:29 471  	in_fee_amount		   IN RCN_PP_SETTLEMENT.FEE_AMOUNT%TYPE,
15:21:29 472  	in_fee_currency 	   IN RCN_PP_SETTLEMENT.FEE_CURRENCY%TYPE,
15:21:29 473  	in_custom_field 	   IN RCN_PP_SETTLEMENT.CUSTOM_FIELD%TYPE,
15:21:29 474  	in_created_by		   IN RCN_PP_SETTLEMENT.CREATED_BY%TYPE
15:21:29 475  ) AS
15:21:29 476  -- VARIABLES
15:21:29 477  var_pp_settlement_id RCN_PP_SETTLEMENT.ID%TYPE;
15:21:29 478  var_date DATE := SYSDATE;
15:21:29 479  BEGIN
15:21:29 480  	IF in_pp_settlement_id IS NULL THEN
15:21:29 481  	  SELECT
15:21:29 482  	    RCN_PP_SETTLEMENT_SEQ.nextVal into var_pp_settlement_id
15:21:29 483  	  FROM DUAL;
15:21:29 484  	ELSE
15:21:29 485  	  var_pp_settlement_id := in_pp_settlement_id;
15:21:29 486  	END IF;
15:21:29 487  	INSERT INTO
15:21:29 488  	  RCN_PP_SETTLEMENT (
15:21:29 489  	    id,
15:21:29 490  	    rcn_ext_source_log_id,
15:21:29 491  	    transaction_id,
15:21:29 492  	    invoice_id,
15:21:29 493  	    pp_ref_id,
15:21:29 494  	    pp_ref_id_type,
15:21:29 495  	    trans_event_code,
15:21:29 496  	    trans_init_date,
15:21:29 497  	    trans_comp_date,
15:21:29 498  	    trans_deb_or_cred,
15:21:29 499  	    gross_trans_amount,
15:21:29 500  	    gross_trans_currency,
15:21:29 501  	    fee_deb_or_cred,
15:21:29 502  	    fee_amount,
15:21:29 503  	    fee_currency,
15:21:29 504  	    custom_field,
15:21:29 505  	    create_date,
15:21:29 506  	    created_by
15:21:29 507  	  ) VALUES (
15:21:29 508  	    var_pp_settlement_id,
15:21:29 509  	    in_ext_source_log_id,
15:21:29 510  	    in_transaction_id,
15:21:29 511  	    in_invoice_id,
15:21:29 512  	    in_pp_ref_id,
15:21:29 513  	    in_pp_ref_id_type,
15:21:29 514  	    in_trans_event_code,
15:21:29 515  	    in_trans_init_date,
15:21:29 516  	    in_trans_comp_date,
15:21:29 517  	    in_trans_deb_or_cred,
15:21:29 518  	    in_gross_trans_amount,
15:21:29 519  	    in_gross_trans_currency,
15:21:29 520  	    in_fee_deb_or_cred,
15:21:29 521  	    in_fee_amount,
15:21:29 522  	    in_fee_currency,
15:21:29 523  	    in_custom_field,
15:21:29 524  	    var_date,
15:21:29 525  	    in_created_by
15:21:29 526  	  );
15:21:29 527  
15:21:29 528  	out_pp_settlement_id := var_pp_settlement_id;
15:21:29 529  END CREATE_PP_SETTLEMENT;
15:21:29 530  
15:21:29 531  PROCEDURE CREATE_PP_DISPUTE (
15:21:29 532  	out_pp_dispute_id	     OUT RCN_PP_DISPUTE.ID%TYPE,
15:21:29 533  	in_pp_dispute_id	     IN RCN_PP_DISPUTE.ID%TYPE DEFAULT NULL,
15:21:29 534  	in_ext_source_log_id	     IN RCN_PP_DISPUTE.RCN_EXT_SOURCE_LOG_ID%TYPE,
15:21:29 535  	in_dispute_type 	     IN RCN_PP_DISPUTE.DISPUTE_TYPE%TYPE,
15:21:29 536  	in_claimant_name	     IN RCN_PP_DISPUTE.CLAIMANT_NAME%TYPE,
15:21:29 537  	in_claimant_email	     IN RCN_PP_DISPUTE.CLAIMANT_EMAIL%TYPE,
15:21:29 538  	in_transaction_id	     IN RCN_PP_DISPUTE.TRANSACTION_ID%TYPE,
15:21:29 539  	in_trans_date		     IN RCN_PP_DISPUTE.TRANS_DATE%TYPE,
15:21:29 540  	in_disputed_amount	     IN RCN_PP_DISPUTE.DISPUTED_AMOUNT%TYPE,
15:21:29 541  	in_disputed_amount_currency  IN RCN_PP_DISPUTE.DISPUTED_AMOUNT_CURRENCY%TYPE,
15:21:29 542  	in_dispute_reason	     IN RCN_PP_DISPUTE.DISPUTE_REASON%TYPE,
15:21:29 543  	in_dispute_filing_date	     IN RCN_PP_DISPUTE.DISPUTE_FILING_DATE%TYPE,
15:21:29 544  	in_dispute_status	     IN RCN_PP_DISPUTE.DISPUTE_STATUS%TYPE,
15:21:29 545  	in_dispute_case_id	     IN RCN_PP_DISPUTE.DISPUTE_CASE_ID%TYPE,
15:21:29 546  	in_invoice_id		     IN RCN_PP_DISPUTE.INVOICE_ID%TYPE,
15:21:29 547  	in_created_by		     IN RCN_PP_DISPUTE.CREATED_BY%TYPE
15:21:29 548  ) AS
15:21:29 549  -- VARIABLES
15:21:29 550  var_pp_dispute_id RCN_PP_DISPUTE.ID%TYPE;
15:21:29 551  var_date DATE := SYSDATE;
15:21:29 552  BEGIN
15:21:29 553  	IF in_pp_dispute_id IS NULL THEN
15:21:29 554  	  SELECT
15:21:29 555  	    RCN_PP_DISPUTE_SEQ.nextVal into var_pp_dispute_id
15:21:29 556  	  FROM DUAL;
15:21:29 557  	ELSE
15:21:29 558  	  var_pp_dispute_id := in_pp_dispute_id;
15:21:29 559  	END IF;
15:21:29 560  	INSERT INTO
15:21:29 561  	  RCN_PP_DISPUTE (
15:21:29 562  	    id,
15:21:29 563  	    rcn_ext_source_log_id,
15:21:29 564  	    dispute_type,
15:21:29 565  	    claimant_name,
15:21:29 566  	    claimant_email,
15:21:29 567  	    transaction_id,
15:21:29 568  	    trans_date,
15:21:29 569  	    disputed_amount,
15:21:29 570  	    disputed_amount_currency,
15:21:29 571  	    dispute_reason,
15:21:29 572  	    dispute_filing_date,
15:21:29 573  	    dispute_status,
15:21:29 574  	    dispute_case_id,
15:21:29 575  	    invoice_id,
15:21:29 576  	    create_date,
15:21:29 577  	    created_by
15:21:29 578  	  ) VALUES (
15:21:29 579  	    var_pp_dispute_id,
15:21:29 580  	    in_ext_source_log_id,
15:21:29 581  	    in_dispute_type,
15:21:29 582  	    in_claimant_name,
15:21:29 583  	    in_claimant_email,
15:21:29 584  	    in_transaction_id,
15:21:29 585  	    in_trans_date,
15:21:29 586  	    in_disputed_amount,
15:21:29 587  	    in_disputed_amount_currency,
15:21:29 588  	    in_dispute_reason,
15:21:29 589  	    in_dispute_filing_date,
15:21:29 590  	    in_dispute_status,
15:21:29 591  	    in_dispute_case_id,
15:21:29 592  	    in_invoice_id,
15:21:29 593  	    var_date,
15:21:29 594  	    in_created_by
15:21:29 595  	  );
15:21:29 596  
15:21:29 597  	out_pp_dispute_id := var_pp_dispute_id;
15:21:29 598  END CREATE_PP_DISPUTE;
15:21:29 599  
15:21:29 600  PROCEDURE CREATE_PP_TRANS_DETAIL (
15:21:29 601  	out_pp_trans_detail_id	     OUT RCN_PP_TRANS_DETAIL.ID%TYPE,
15:21:29 602  	in_pp_trans_detail_id	     IN RCN_PP_TRANS_DETAIL.ID%TYPE DEFAULT NULL,
15:21:29 603  	in_ext_source_log_id	     IN RCN_PP_TRANS_DETAIL.RCN_EXT_SOURCE_LOG_ID%TYPE,
15:21:29 604  	in_invoice_id		     IN RCN_PP_TRANS_DETAIL.INVOICE_ID%TYPE,
15:21:29 605  	in_transaction_id	     IN RCN_PP_TRANS_DETAIL.TRANSACTION_ID%TYPE,
15:21:29 606  	in_pp_ref_id		     IN RCN_PP_TRANS_DETAIL.PP_REF_ID%TYPE,
15:21:29 607  	in_trans_deb_or_cred	     IN RCN_PP_TRANS_DETAIL.TRANS_DEB_OR_CRED%TYPE,
15:21:29 608  	in_trans_init_date	     IN RCN_PP_TRANS_DETAIL.TRANS_INIT_DATE%TYPE,
15:21:29 609  	in_trans_comp_date	     IN RCN_PP_TRANS_DETAIL.TRANS_COMP_DATE%TYPE,
15:21:29 610  	in_gross_trans_amount	     IN RCN_PP_TRANS_DETAIL.GROSS_TRANS_AMOUNT%TYPE,
15:21:29 611  	in_gross_trans_currency      IN RCN_PP_TRANS_DETAIL.GROSS_TRANS_CURRENCY%TYPE,
15:21:29 612  	in_fee_amount		     IN RCN_PP_TRANS_DETAIL.FEE_AMOUNT%TYPE,
15:21:29 613  	in_fee_currency 	     IN RCN_PP_TRANS_DETAIL.FEE_CURRENCY%TYPE,
15:21:29 614  	in_fee_deb_or_cred	     IN RCN_PP_TRANS_DETAIL.FEE_DEB_OR_CRED%TYPE,
15:21:29 615  	in_trans_event_code	     IN RCN_PP_TRANS_DETAIL.TRANS_EVENT_CODE%TYPE,
15:21:29 616  	in_trans_status 	     IN RCN_PP_TRANS_DETAIL.TRANS_STATUS%TYPE,
15:21:29 617  	in_insurance_amount	     IN RCN_PP_TRANS_DETAIL.INSURANCE_AMOUNT%TYPE,
15:21:29 618  	in_sales_tax_amount	     IN RCN_PP_TRANS_DETAIL.SALES_TAX_AMOUNT%TYPE,
15:21:29 619  	in_shipping_amount	     IN RCN_PP_TRANS_DETAIL.SHIPPING_AMOUNT%TYPE,
15:21:29 620  	in_trans_subject	     IN RCN_PP_TRANS_DETAIL.TRANS_SUBJECT%TYPE,
15:21:29 621  	in_trans_note		     IN RCN_PP_TRANS_DETAIL.TRANS_NOTE%TYPE,
15:21:29 622  	in_payer_acct_id	     IN RCN_PP_TRANS_DETAIL.PAYER_ACCT_ID%TYPE,
15:21:29 623  	in_payer_addr_status	     IN RCN_PP_TRANS_DETAIL.PAYER_ADDR_STATUS%TYPE,
15:21:29 624  	in_item_name		     IN RCN_PP_TRANS_DETAIL.ITEM_NAME%TYPE,
15:21:29 625  	in_item_id		     IN RCN_PP_TRANS_DETAIL.ITEM_ID%TYPE,
15:21:29 626  	in_option_1_name	     IN RCN_PP_TRANS_DETAIL.OPTION_1_NAME%TYPE,
15:21:29 627  	in_option_1_value	     IN RCN_PP_TRANS_DETAIL.OPTION_1_VALUE%TYPE,
15:21:29 628  	in_option_2_name	     IN RCN_PP_TRANS_DETAIL.OPTION_2_NAME%TYPE,
15:21:29 629  	in_option_2_value	     IN RCN_PP_TRANS_DETAIL.OPTION_2_VALUE%TYPE,
15:21:29 630  	in_auction_site 	     IN RCN_PP_TRANS_DETAIL.AUCTION_SITE%TYPE,
15:21:29 631  	in_auction_buyer_id	     IN RCN_PP_TRANS_DETAIL.AUCTION_BUYER_ID%TYPE,
15:21:29 632  	in_auction_closing_date      IN RCN_PP_TRANS_DETAIL.AUCTION_CLOSING_DATE%TYPE,
15:21:29 633  	in_shipping_addr_line_1      IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_LINE_1%TYPE,
15:21:29 634  	in_shipping_addr_line_2      IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_LINE_2%TYPE,
15:21:29 635  	in_shipping_addr_city	     IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_CITY%TYPE,
15:21:29 636  	in_shipping_addr_state	     IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_STATE%TYPE,
15:21:29 637  	in_shipping_addr_zip	     IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_ZIP%TYPE,
15:21:29 638  	in_shipping_addr_country     IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_COUNTRY%TYPE,
15:21:29 639  	in_custom_field 	     IN RCN_PP_TRANS_DETAIL.CUSTOM_FIELD%TYPE,
15:21:29 640  	in_created_by		     IN RCN_PP_TRANS_DETAIL.CREATED_BY%TYPE
15:21:29 641  ) AS
15:21:29 642  -- VARIABLES
15:21:29 643  var_pp_trans_detail_id RCN_PP_TRANS_DETAIL.ID%TYPE;
15:21:29 644  var_date DATE := SYSDATE;
15:21:29 645  BEGIN
15:21:29 646  	IF in_pp_trans_detail_id IS NULL THEN
15:21:29 647  	  SELECT
15:21:29 648  	    RCN_PP_TRANS_DETAIL_SEQ.nextVal into var_pp_trans_detail_id
15:21:29 649  	  FROM DUAL;
15:21:29 650  	ELSE
15:21:29 651  	  var_pp_trans_detail_id := in_pp_trans_detail_id;
15:21:29 652  	END IF;
15:21:29 653  	INSERT INTO
15:21:29 654  	  RCN_PP_TRANS_DETAIL (
15:21:29 655  	    id,
15:21:29 656  	    rcn_ext_source_log_id,
15:21:29 657  	    transaction_id,
15:21:29 658  	    invoice_id,
15:21:29 659  	    pp_ref_id,
15:21:29 660  	    trans_event_code,
15:21:29 661  	    trans_init_date,
15:21:29 662  	    trans_comp_date,
15:21:29 663  	    trans_deb_or_cred,
15:21:29 664  	    gross_trans_amount,
15:21:29 665  	    gross_trans_currency,
15:21:29 666  	    fee_deb_or_cred,
15:21:29 667  	    fee_amount,
15:21:29 668  	    fee_currency,
15:21:29 669  	    trans_status,
15:21:29 670  	    insurance_amount,
15:21:29 671  	    sales_tax_amount,
15:21:29 672  	    shipping_amount,
15:21:29 673  	    trans_subject,
15:21:29 674  	    trans_note,
15:21:29 675  	    payer_acct_id,
15:21:29 676  	    payer_addr_status,
15:21:29 677  	    item_name,
15:21:29 678  	    item_id,
15:21:29 679  	    option_1_name,
15:21:29 680  	    option_1_value,
15:21:29 681  	    option_2_name,
15:21:29 682  	    option_2_value,
15:21:29 683  	    auction_site,
15:21:29 684  	    auction_buyer_id,
15:21:29 685  	    auction_closing_date,
15:21:29 686  	    shipping_addr_line_1,
15:21:29 687  	    shipping_addr_line_2,
15:21:29 688  	    shipping_addr_city,
15:21:29 689  	    shipping_addr_state,
15:21:29 690  	    shipping_addr_zip,
15:21:29 691  	    shipping_addr_country,
15:21:29 692  	    custom_field,
15:21:29 693  	    create_date,
15:21:29 694  	    created_by
15:21:29 695  	  ) VALUES (
15:21:29 696  	    var_pp_trans_detail_id,
15:21:29 697  	    in_ext_source_log_id,
15:21:29 698  	    in_transaction_id,
15:21:29 699  	    in_invoice_id,
15:21:29 700  	    in_pp_ref_id,
15:21:29 701  	    in_trans_event_code,
15:21:29 702  	    in_trans_init_date,
15:21:29 703  	    in_trans_comp_date,
15:21:29 704  	    in_trans_deb_or_cred,
15:21:29 705  	    in_gross_trans_amount,
15:21:29 706  	    in_gross_trans_currency,
15:21:29 707  	    in_fee_deb_or_cred,
15:21:29 708  	    in_fee_amount,
15:21:29 709  	    in_fee_currency,
15:21:29 710  	    in_trans_status,
15:21:29 711  	    in_insurance_amount,
15:21:29 712  	    in_sales_tax_amount,
15:21:29 713  	    in_shipping_amount,
15:21:29 714  	    in_trans_subject,
15:21:29 715  	    in_trans_note,
15:21:29 716  	    in_payer_acct_id,
15:21:29 717  	    in_payer_addr_status,
15:21:29 718  	    in_item_name,
15:21:29 719  	    in_item_id,
15:21:29 720  	    in_option_1_name,
15:21:29 721  	    in_option_1_value,
15:21:29 722  	    in_option_2_name,
15:21:29 723  	    in_option_2_value,
15:21:29 724  	    in_auction_site,
15:21:29 725  	    in_auction_buyer_id,
15:21:29 726  	    in_auction_closing_date,
15:21:29 727  	    in_shipping_addr_line_1,
15:21:29 728  	    in_shipping_addr_line_2,
15:21:29 729  	    in_shipping_addr_city,
15:21:29 730  	    in_shipping_addr_state,
15:21:29 731  	    in_shipping_addr_zip,
15:21:29 732  	    in_shipping_addr_country,
15:21:29 733  	    in_custom_field,
15:21:29 734  	    var_date,
15:21:29 735  	    in_created_by
15:21:29 736  	  );
15:21:29 737  
15:21:29 738  	out_pp_trans_detail_id := var_pp_trans_detail_id;
15:21:29 739  END CREATE_PP_TRANS_DETAIL;
15:21:29 740  
15:21:29 741  PROCEDURE DELETE_EXT_SOURCE_LOG (
15:21:29 742  	in_record_type		 IN RCN_EXT_SOURCE_LOG.RECORD_TYPE%TYPE,
15:21:29 743  	in_report_file_name	 IN RCN_EXT_SOURCE_LOG.REPORT_FILE_NAME%TYPE
15:21:29 744  ) AS
15:21:29 745  BEGIN
15:21:29 746  	DELETE FROM
15:21:29 747  	  RCN_EXT_SOURCE_LOG
15:21:29 748  	WHERE
15:21:29 749  	  RCN_EXT_SOURCE_LOG.RECORD_TYPE = in_record_type AND
15:21:29 750  	  RCN_EXT_SOURCE_LOG.REPORT_FILE_NAME = in_report_file_name;
15:21:29 751  END DELETE_EXT_SOURCE_LOG;
15:21:29 752  
15:21:29 753  PROCEDURE GET_EXT_SOURCE_LOG (
15:21:29 754  	in_record_type		 IN RCN_EXT_SOURCE_LOG.RECORD_TYPE%TYPE,
15:21:29 755  	in_report_file_name	 IN RCN_EXT_SOURCE_LOG.REPORT_FILE_NAME%TYPE,
15:21:29 756  	out_result_set		 OUT SYS_REFCURSOR
15:21:29 757  ) AS
15:21:29 758  BEGIN
15:21:29 759  	OPEN out_result_set FOR
15:21:29 760  	SELECT * FROM
15:21:29 761  	  RCN_EXT_SOURCE_LOG
15:21:29 762  	WHERE
15:21:29 763  	  RCN_EXT_SOURCE_LOG.RECORD_TYPE = in_record_type AND
15:21:29 764  	  RCN_EXT_SOURCE_LOG.REPORT_FILE_NAME = in_report_file_name;
15:21:29 765  END GET_EXT_SOURCE_LOG;
15:21:29 766  
15:21:29 767  FUNCTION CHECK_EXT_SOURCE_LOG (
15:21:29 768  	in_record_type		 IN RCN_EXT_SOURCE_LOG.RECORD_TYPE%TYPE,
15:21:29 769  	in_report_file_name	 IN RCN_EXT_SOURCE_LOG.REPORT_FILE_NAME%TYPE
15:21:29 770  ) RETURN NUMBER AS
15:21:29 771  var_exists NUMBER;
15:21:29 772  BEGIN
15:21:29 773  	SELECT count(1) INTO var_exists
15:21:29 774  	FROM
15:21:29 775  	  RCN_EXT_SOURCE_LOG
15:21:29 776  	WHERE
15:21:29 777  	  RCN_EXT_SOURCE_LOG.RECORD_TYPE = in_record_type AND
15:21:29 778  	  RCN_EXT_SOURCE_LOG.REPORT_FILE_NAME = in_report_file_name;
15:21:29 779  
15:21:29 780  	IF var_exists > 1 THEN
15:21:29 781  	  var_exists := 1;
15:21:29 782  	END IF;
15:21:29 783  
15:21:29 784  	RETURN var_exists;
15:21:29 785  END;
15:21:29 786  
15:21:29 787  PROCEDURE CREATE_AMEX_CHARGEBACK (
15:21:29 788  	  in_rcn_ext_source_log_id IN RCN_EXT_SOURCE_LOG.ID%TYPE,
15:21:29 789  	  in_resolution IN RCN_AMEX_CHARGEBACK.RESOLUTION%TYPE,
15:21:29 790  	  in_from_system IN RCN_AMEX_CHARGEBACK.FROM_SYSTEM%TYPE,
15:21:29 791  	  in_rejects_to_system IN RCN_AMEX_CHARGEBACK.REJECTS_TO_SYSTEM%TYPE,
15:21:29 792  	  in_disputes_to_system IN RCN_AMEX_CHARGEBACK.DISPUTES_TO_SYSTEM%TYPE,
15:21:29 793  	  in_date_of_adjustment IN RCN_AMEX_CHARGEBACK.DATE_OF_ADJUSTMENT%TYPE,
15:21:29 794  	  in_date_of_charge IN RCN_AMEX_CHARGEBACK.DATE_OF_CHARGE%TYPE,
15:21:29 795  	  in_case_type IN RCN_AMEX_CHARGEBACK.CASE_TYPE%TYPE,
15:21:29 796  	  in_cb_reas_code IN RCN_AMEX_CHARGEBACK.CB_REAS_CODE%TYPE,
15:21:29 797  	  in_cb_amount IN RCN_AMEX_CHARGEBACK.CB_AMOUNT%TYPE,
15:21:29 798  	  in_cb_adjustment_number IN RCN_AMEX_CHARGEBACK.CB_ADJUSTMENT_NUMBER%TYPE,
15:21:29 799  	  in_billed_amount IN RCN_AMEX_CHARGEBACK.BILLED_AMOUNT%TYPE,
15:21:29 800  	  in_soc_amount IN RCN_AMEX_CHARGEBACK.SOC_AMOUNT%TYPE,
15:21:29 801  	  in_foreign_amount IN RCN_AMEX_CHARGEBACK.FOREIGN_AMOUNT%TYPE,
15:21:29 802  	  in_currency IN RCN_AMEX_CHARGEBACK.CURRENCY%TYPE,
15:21:29 803  	  in_note1 IN RCN_AMEX_CHARGEBACK.NOTE1%TYPE,
15:21:29 804  	  in_note2 IN RCN_AMEX_CHARGEBACK.NOTE2%TYPE,
15:21:29 805  	  in_note3 IN RCN_AMEX_CHARGEBACK.NOTE3%TYPE,
15:21:29 806  	  in_note4 IN RCN_AMEX_CHARGEBACK.NOTE4%TYPE,
15:21:29 807  	  in_note5 IN RCN_AMEX_CHARGEBACK.NOTE5%TYPE,
15:21:29 808  	  in_note6 IN RCN_AMEX_CHARGEBACK.NOTE6%TYPE,
15:21:29 809  	  in_note7 IN RCN_AMEX_CHARGEBACK.NOTE7%TYPE,
15:21:29 810  	  in_ind_ref_number IN RCN_AMEX_CHARGEBACK.IND_REF_NUMBER%TYPE,
15:21:29 811  	  in_created_by IN RCN_AMEX_CHARGEBACK.CREATED_BY%TYPE
15:21:29 812  ) AS
15:21:29 813  var_amex_chargeback_id RCN_AMEX_CHARGEBACK.ID%TYPE;
15:21:29 814  var_date DATE := SYSDATE;
15:21:29 815  BEGIN
15:21:29 816  	SELECT
15:21:29 817  	  RCNAMEXCB_ID_SEQ.nextVal into var_amex_chargeback_id
15:21:29 818  	FROM DUAL;
15:21:29 819  
15:21:29 820  	INSERT INTO
15:21:29 821  	  RCN_AMEX_CHARGEBACK (
15:21:29 822  	    id,
15:21:29 823  	    rcn_ext_source_log_id,
15:21:29 824  	    resolution,
15:21:29 825  	    from_system,
15:21:29 826  	    rejects_to_system,
15:21:29 827  	    disputes_to_system,
15:21:29 828  	    date_of_adjustment,
15:21:29 829  	    date_of_charge,
15:21:29 830  	    case_type,
15:21:29 831  	    cb_reas_code,
15:21:29 832  	    cb_amount,
15:21:29 833  	    cb_adjustment_number,
15:21:29 834  	    billed_amount,
15:21:29 835  	    soc_amount,
15:21:29 836  	    foreign_amount,
15:21:29 837  	    currency,
15:21:29 838  	    note1,
15:21:29 839  	    note2,
15:21:29 840  	    note3,
15:21:29 841  	    note4,
15:21:29 842  	    note5,
15:21:29 843  	    note6,
15:21:29 844  	    note7,
15:21:29 845  	    ind_ref_number,
15:21:29 846  	    create_date,
15:21:29 847  	    created_by,
15:21:29 848  	    update_date,
15:21:29 849  	    updated_by
15:21:29 850  	  ) VALUES (
15:21:29 851  	    var_amex_chargeback_id,
15:21:29 852  	    in_rcn_ext_source_log_id,
15:21:29 853  	    in_resolution,
15:21:29 854  	    in_from_system,
15:21:29 855  	    in_rejects_to_system,
15:21:29 856  	    in_disputes_to_system,
15:21:29 857  	    in_date_of_adjustment,
15:21:29 858  	    in_date_of_charge,
15:21:29 859  	    in_case_type,
15:21:29 860  	    in_cb_reas_code,
15:21:29 861  	    in_cb_amount,
15:21:29 862  	    in_cb_adjustment_number,
15:21:29 863  	    in_billed_amount,
15:21:29 864  	    in_soc_amount,
15:21:29 865  	    in_foreign_amount,
15:21:29 866  	    in_currency,
15:21:29 867  	    in_note1,
15:21:29 868  	    in_note2,
15:21:29 869  	    in_note3,
15:21:29 870  	    in_note4,
15:21:29 871  	    in_note5,
15:21:29 872  	    in_note6,
15:21:29 873  	    in_note7,
15:21:29 874  	    in_ind_ref_number,
15:21:29 875  	    var_date,
15:21:29 876  	    in_created_by,
15:21:29 877  	    var_date,
15:21:29 878  	    in_created_by
15:21:29 879  	  );
15:21:29 880  
15:21:29 881  END CREATE_AMEX_CHARGEBACK;
15:21:29 882  
15:21:29 883  END PROCS_RECONCILIATION_CRU_V18;
15:21:29 884  .
15:21:29 SQL> /

Package body created.

Elapsed: 00:00:00.08
15:21:30 SQL> 
15:21:30 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_SUBSCRIPTION_CRU_V18" AS
15:21:30   2  
15:21:30   3  PROCEDURE CREATE_SUBSCRIPTION(
15:21:30   4  	out_subscription_id	     OUT SUBSCRIPTION.ID%TYPE,
15:21:30   5  	in_subscription_id	     IN SUBSCRIPTION.ID%TYPE DEFAULT NULL,
15:21:30   6  	in_suspend_date 	     IN SUBSCRIPTION.SUSPEND_DATE%TYPE DEFAULT NULL,
15:21:30   7  	in_account_id		     IN SUBSCRIPTION.ACCOUNT_ID%TYPE,
15:21:30   8  	in_purchase_date	     IN SUBSCRIPTION.PURCHASE_DATE%TYPE,
15:21:30   9  	in_offer_chain_id	     IN SUBSCRIPTION.OFFER_CHAIN_ID%TYPE,
15:21:30  10  	in_termination_date	     IN SUBSCRIPTION.TERMINATION_DATE%TYPE DEFAULT NULL,
15:21:30  11  	in_days_remainning_ajustment IN SUBSCRIPTION.DAYS_REMAINING_ADJUSTMENT%TYPE DEFAULT NULL,
15:21:30  12  	in_sct_id		     IN SUBSCRIPTION.SCT_ID%TYPE DEFAULT NULL,
15:21:30  13  	in_created_by		     IN SUBSCRIPTION.CREATED_BY%TYPE,
15:21:30  14  	in_instrument_type_id	     IN SUBSCRIPTION.INSTRUMENT_TYPE_ID%TYPE,
15:21:30  15  	in_instrument_id	     IN SUBSCRIPTION.INSTRUMENT_ID%TYPE,
15:21:30  16  	in_subscription_status_id    IN SUBSCRIPTION.SUBSCRIPTION_STATUS_ID%TYPE,
15:21:30  17  	in_cancelation_date	     IN SUBSCRIPTION.CANCELLATION_DATE%TYPE DEFAULT NULL,
15:21:30  18  	in_reactivation_date	     IN SUBSCRIPTION.REACTIVATION_DATE%TYPE DEFAULT NULL
15:21:30  19  ) AS
15:21:30  20  -- VARIABLES
15:21:30  21  var_new_subscription_id SUBSCRIPTION.ID%TYPE;
15:21:30  22  -- arosolovskiy: using data variable instead of direct get data calls (#38860)
15:21:30  23  var_date DATE := SYSDATE;
15:21:30  24  BEGIN
15:21:30  25  	IF in_subscription_id IS NULL THEN
15:21:30  26  	  SELECT
15:21:30  27  	    SUB_ID_SEQ.nextVal into var_new_subscription_id
15:21:30  28  	  FROM DUAL;
15:21:30  29  	ELSE
15:21:30  30  	  var_new_subscription_id := in_subscription_id;
15:21:30  31  	END IF;
15:21:30  32  	INSERT INTO SUBSCRIPTION (
15:21:30  33  	  ID,
15:21:30  34  	  SUSPEND_DATE,
15:21:30  35  	  ACCOUNT_ID,
15:21:30  36  	  PURCHASE_DATE,
15:21:30  37  	  OFFER_CHAIN_ID,
15:21:30  38  	  TERMINATION_DATE,
15:21:30  39  	  DAYS_REMAINING_ADJUSTMENT,
15:21:30  40  	  SCT_ID,
15:21:30  41  	  CREATE_DATE,
15:21:30  42  	  CREATED_BY,
15:21:30  43  	  UPDATE_DATE,
15:21:30  44  	  UPDATED_BY,
15:21:30  45  	  INSTRUMENT_TYPE_ID,
15:21:30  46  	  INSTRUMENT_ID,
15:21:30  47  	  SUBSCRIPTION_STATUS_ID,
15:21:30  48  	  CANCELLATION_DATE,
15:21:30  49  	  REACTIVATION_DATE
15:21:30  50  	) VALUES (
15:21:30  51  	  var_new_subscription_id,
15:21:30  52  	  in_suspend_date,
15:21:30  53  	  in_account_id,
15:21:30  54  	  in_purchase_date,
15:21:30  55  	  in_offer_chain_id,
15:21:30  56  	  in_termination_date,
15:21:30  57  	  in_days_remainning_ajustment,
15:21:30  58  	  in_sct_id,
15:21:30  59  	  var_date,
15:21:30  60  	  in_created_by,
15:21:30  61  	  var_date,
15:21:30  62  	  in_created_by,
15:21:30  63  	  in_instrument_type_id,
15:21:30  64  	  in_instrument_id,
15:21:30  65  	  in_subscription_status_id,
15:21:30  66  	  in_cancelation_date,
15:21:30  67  	  in_reactivation_date
15:21:30  68  	);
15:21:30  69  
15:21:30  70  	out_subscription_id := var_new_subscription_id;
15:21:30  71  END CREATE_SUBSCRIPTION;
15:21:30  72  
15:21:30  73  /******************************************************************************/
15:21:30  74  
15:21:30  75  PROCEDURE UPDATE_SUBSCRIPTION(
15:21:30  76  	in_subscription_id	     IN SUBSCRIPTION.ID%TYPE,
15:21:30  77  	in_suspend_date 	     IN SUBSCRIPTION.SUSPEND_DATE%TYPE DEFAULT NULL,
15:21:30  78  	in_purchase_date	     IN SUBSCRIPTION.PURCHASE_DATE%TYPE DEFAULT NULL,
15:21:30  79  	in_termination_date	     IN SUBSCRIPTION.TERMINATION_DATE%TYPE DEFAULT NULL,
15:21:30  80  	in_days_remainning_ajustment IN SUBSCRIPTION.DAYS_REMAINING_ADJUSTMENT%TYPE DEFAULT NULL,
15:21:30  81  	in_sct_id		     IN SUBSCRIPTION.SCT_ID%TYPE DEFAULT NULL,
15:21:30  82  	in_updated_by		     IN SUBSCRIPTION.CREATED_BY%TYPE,
15:21:30  83  	in_instrument_type_id	     IN SUBSCRIPTION.INSTRUMENT_TYPE_ID%TYPE DEFAULT NULL,
15:21:30  84  	in_instrument_id	     IN SUBSCRIPTION.INSTRUMENT_ID%TYPE DEFAULT NULL,
15:21:30  85  	in_subscription_status_id    IN SUBSCRIPTION.SUBSCRIPTION_STATUS_ID%TYPE DEFAULT NULL,
15:21:30  86  	in_cancelation_date	     IN SUBSCRIPTION.CANCELLATION_DATE%TYPE DEFAULT NULL,
15:21:30  87  	in_reactivation_date	     IN SUBSCRIPTION.REACTIVATION_DATE%TYPE DEFAULT NULL
15:21:30  88  ) AS
15:21:30  89  BEGIN
15:21:30  90  	-- Create history
15:21:30  91  	PROCS_HISTORY_V18.CREATE_SUBSCRIPTION_HISTORY(
15:21:30  92  	  in_subscription_id	       => in_subscription_id,
15:21:30  93  	  in_system_activity_reason_id => GLOBAL_ENUMS_V18.SAC_SYSTEM_APPLIED_RULE
15:21:30  94  	);
15:21:30  95  
15:21:30  96  	UPDATE SUBSCRIPTION SET
15:21:30  97  	  SUSPEND_DATE		    = NVL(in_suspend_date, SUSPEND_DATE),
15:21:30  98  	  PURCHASE_DATE 	    = NVL(in_purchase_date, PURCHASE_DATE),
15:21:30  99  	  TERMINATION_DATE	    = NVL(in_termination_date, TERMINATION_DATE),
15:21:30 100  	  DAYS_REMAINING_ADJUSTMENT = NVL(days_remaining_adjustment, DAYS_REMAINING_ADJUSTMENT),
15:21:30 101  	  SCT_ID		    = NVL(in_sct_id, SCT_ID),
15:21:30 102  	  UPDATE_DATE		    = SYSDATE,
15:21:30 103  	  UPDATED_BY		    = in_updated_by,
15:21:30 104  	  INSTRUMENT_TYPE_ID	    = NVL(in_instrument_type_id, INSTRUMENT_TYPE_ID),
15:21:30 105  	  INSTRUMENT_ID 	    = NVL(in_instrument_id, INSTRUMENT_ID),
15:21:30 106  	  SUBSCRIPTION_STATUS_ID    = NVL(in_subscription_status_id, SUBSCRIPTION_STATUS_ID),
15:21:30 107  	  CANCELLATION_DATE	    = NVL(in_cancelation_date, CANCELLATION_DATE),
15:21:30 108  	  REACTIVATION_DATE	    = NVL(in_reactivation_date, REACTIVATION_DATE)
15:21:30 109  	WHERE
15:21:30 110  	  ID = in_subscription_id;
15:21:30 111  END UPDATE_SUBSCRIPTION;
15:21:30 112  
15:21:30 113  /******************************************************************************/
15:21:30 114  
15:21:30 115  PROCEDURE CREATE_SUBSCRIPTION_NOTE (
15:21:30 116  	inout_subscription_note_id IN OUT SUBSCRIPTION_NOTE.ID%TYPE,
15:21:30 117  	in_agent_id		   IN SUBSCRIPTION_NOTE.AGENT_ID%TYPE,
15:21:30 118  	in_subscription_id	   IN SUBSCRIPTION_NOTE.ID%TYPE,
15:21:30 119  	in_note 		   IN SUBSCRIPTION_NOTE.NOTE%TYPE,
15:21:30 120  	in_created_by		   IN SUBSCRIPTION_NOTE.CREATED_BY%TYPE
15:21:30 121  ) AS
15:21:30 122  BEGIN
15:21:30 123  	IF inout_subscription_note_id IS NULL THEN
15:21:30 124  	  SELECT
15:21:30 125  	    SUBN_ID_SEQ.nextVal into inout_subscription_note_id
15:21:30 126  	  FROM DUAL;
15:21:30 127  	END IF;
15:21:30 128  	INSERT INTO SUBSCRIPTION_NOTE (
15:21:30 129  	  ID,
15:21:30 130  	  AGENT_ID,
15:21:30 131  	  SUBSCRIPTION_ID,
15:21:30 132  	  NOTE,
15:21:30 133  	  CREATE_DATE,
15:21:30 134  	  CREATED_BY
15:21:30 135  	) VALUES (
15:21:30 136  	  inout_subscription_note_id,
15:21:30 137  	  in_agent_id,
15:21:30 138  	  in_subscription_id,
15:21:30 139  	  in_note,
15:21:30 140  	  SYSDATE,
15:21:30 141  	  in_created_by
15:21:30 142  	);
15:21:30 143  END CREATE_SUBSCRIPTION_NOTE;
15:21:30 144  
15:21:30 145  END PROCS_SUBSCRIPTION_CRU_V18;
15:21:30 146  .
15:21:30 SQL> /

Package body created.

Elapsed: 00:00:00.02
15:21:30 SQL> 
15:21:30 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_TAXES_CRU_V18" AS
15:21:30   2  
15:21:30   3  PROCEDURE CREATE_TAX (
15:21:30   4  	inout_tax_id		 IN OUT NUMBER,
15:21:30   5  	in_tax_type_id		 IN NUMBER,
15:21:30   6  	in_calculated_amount	 IN NUMBER,
15:21:30   7  	in_created_by		 IN VARCHAR2,
15:21:30   8  	in_line_item_id 	 IN NUMBER,
15:21:30   9  	in_effective_rate	 IN VARCHAR2,
15:21:30  10  	in_taxable_amount	 IN NUMBER,
15:21:30  11  	in_tax_rule_id		 IN NUMBER,
15:21:30  12  	in_jurisdiction_level_id IN NUMBER,
15:21:30  13  	in_jurisdiction_name	 IN VARCHAR2,
15:21:30  14  	in_jurisdiction_id	 IN VARCHAR2,
15:21:30  15  	in_ext_tax_type 	 IN VARCHAR2,
15:21:30  16  	in_ext_result		 IN VARCHAR2,
15:21:30  17  	in_imposition_type	 IN VARCHAR2,
15:21:30  18  	in_imposition		 IN VARCHAR2
15:21:30  19  ) AS
15:21:30  20  var_date DATE := SYSDATE;
15:21:30  21  BEGIN
15:21:30  22  
15:21:30  23  	IF inout_tax_id IS NULL THEN
15:21:30  24  	  SELECT
15:21:30  25  	    TAX_ID_SEQ.nextVal into inout_tax_id
15:21:30  26  	  FROM DUAL;
15:21:30  27  	END IF;
15:21:30  28  
15:21:30  29  	INSERT INTO TAX (
15:21:30  30  	  ID,
15:21:30  31  	  TAX_TYPE_ID,
15:21:30  32  	  CALCULATED_AMOUNT,
15:21:30  33  	  CREATE_DATE,
15:21:30  34  	  CREATED_BY,
15:21:30  35  	  LINE_ITEM_ID,
15:21:30  36  	  EFFECTIVE_RATE,
15:21:30  37  	  TAXABLE_AMOUNT,
15:21:30  38  	  TAX_RULE_ID,
15:21:30  39  	  JURISDICTION_LEVEL_ID,
15:21:30  40  	  JURISDICTION_NAME,
15:21:30  41  	  JURISDICTION_ID,
15:21:30  42  	  EXT_TAX_TYPE,
15:21:30  43  	  EXT_RESULT,
15:21:30  44  	  IMPOSITION_TYPE,
15:21:30  45  	  IMPOSITION
15:21:30  46  	) VALUES (
15:21:30  47  	  inout_tax_id,
15:21:30  48  	  in_tax_type_id,
15:21:30  49  	  in_calculated_amount,
15:21:30  50  	  var_date,
15:21:30  51  	  in_created_by,
15:21:30  52  	  in_line_item_id,
15:21:30  53  	  in_effective_rate,
15:21:30  54  	  in_taxable_amount,
15:21:30  55  	  in_tax_rule_id,
15:21:30  56  	  in_jurisdiction_level_id,
15:21:30  57  	  in_jurisdiction_name,
15:21:30  58  	  in_jurisdiction_id,
15:21:30  59  	  in_ext_tax_type,
15:21:30  60  	  in_ext_result,
15:21:30  61  	  in_imposition_type,
15:21:30  62  	  in_imposition
15:21:30  63  	);
15:21:30  64  
15:21:30  65  END CREATE_TAX;
15:21:30  66  
15:21:30  67  END PROCS_TAXES_CRU_V18;
15:21:30  68  .
15:21:30 SQL> /

Package body created.

Elapsed: 00:00:00.04
15:21:30 SQL> 
15:21:30 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_TRANSACTION_CRU_V18" AS
15:21:30   2  
15:21:30   3  PROCEDURE CREATE_TRANSACTION (
15:21:30   4  	out_transaction_id	 OUT TRANSACTION.ID%TYPE,
15:21:30   5  	in_transaction_id	 IN TRANSACTION.ID%TYPE DEFAULT NULL,
15:21:30   6  	in_transaction_status_id IN TRANSACTION.TRANSACTION_STATUS_ID%TYPE,
15:21:30   7  	in_transaction_amount	 IN TRANSACTION.TRANSACTION_AMOUNT%TYPE,
15:21:30   8  	in_created_by		 IN TRANSACTION.CREATED_BY%TYPE,
15:21:30   9  	in_order_id		 IN TRANSACTION.ORDER_ID%TYPE,
15:21:30  10  	in_is_refund		 IN TRANSACTION.IS_REFUND%TYPE DEFAULT GLOBAL_CONSTANTS_V18.FALSE,
15:21:30  11  	in_transaction_type_code IN TRANSACTION.TRANSACTION_TYPE_CODE%TYPE DEFAULT NULL
15:21:30  12  ) AS
15:21:30  13  -- VARIABLES
15:21:30  14  var_transaction_id TRANSACTION.ID%TYPE;
15:21:30  15  -- arosolovskiy: using data variable instead of direct get data calls (#38860)
15:21:30  16  var_date DATE := SYSDATE;
15:21:30  17  BEGIN
15:21:30  18  	IF in_transaction_id IS NULL THEN
15:21:30  19  	  SELECT
15:21:30  20  	    TRN_ID_SEQ.nextVal into var_transaction_id
15:21:30  21  	  FROM DUAL;
15:21:30  22  	ELSE
15:21:30  23  	  var_transaction_id := in_transaction_id;
15:21:30  24  	END IF;
15:21:30  25  	INSERT INTO
15:21:30  26  	  TRANSACTION (
15:21:30  27  	    ID,
15:21:30  28  	    TRANSACTION_STATUS_ID,
15:21:30  29  	    TRANSACTION_AMOUNT,
15:21:30  30  	    CREATE_DATE,
15:21:30  31  	    CREATED_BY,
15:21:30  32  	    UPDATE_DATE,
15:21:30  33  	    UPDATED_BY,
15:21:30  34  	    ORDER_ID,
15:21:30  35  	    IS_REFUND,
15:21:30  36  	    TRANSACTION_TYPE_CODE
15:21:30  37  	  ) VALUES (
15:21:30  38  	    var_transaction_id,
15:21:30  39  	    in_transaction_status_id,
15:21:30  40  	    in_transaction_amount,
15:21:30  41  	    var_date,
15:21:30  42  	    in_created_by,
15:21:30  43  	    var_date,
15:21:30  44  	    in_created_by,
15:21:30  45  	    in_order_id,
15:21:30  46  	    in_is_refund,
15:21:30  47  	    in_transaction_type_code
15:21:30  48  	  );
15:21:30  49  
15:21:30  50  	out_transaction_id := var_transaction_id;
15:21:30  51  END CREATE_TRANSACTION;
15:21:30  52  
15:21:30  53  /*******************************************************************/
15:21:30  54  
15:21:30  55  PROCEDURE UPDATE_TRANSACTION (
15:21:30  56  	in_transaction_id	 IN TRANSACTION.ID%TYPE,
15:21:30  57  	in_transaction_status_id IN TRANSACTION.TRANSACTION_STATUS_ID%TYPE DEFAULT NULL,
15:21:30  58  	in_transaction_amount	 IN TRANSACTION.TRANSACTION_AMOUNT%TYPE DEFAULT NULL,
15:21:30  59  	in_updated_by		 IN TRANSACTION.CREATED_BY%TYPE,
15:21:30  60  	in_order_id		 IN TRANSACTION.ORDER_ID%TYPE DEFAULT NULL,
15:21:30  61  	in_is_settled		 IN TRANSACTION.IS_SETTLED%TYPE DEFAULT NULL
15:21:30  62  ) AS
15:21:30  63  BEGIN
15:21:30  64  	-- Create history
15:21:30  65  	PROCS_HISTORY_V18.CREATE_TRANSACTION_HISTORY(
15:21:30  66  	  in_transaction_id	       => in_transaction_id,
15:21:30  67  	  in_system_activity_reason_id => GLOBAL_ENUMS_V18.SAC_SYSTEM_APPLIED_RULE
15:21:30  68  	);
15:21:30  69  	UPDATE
15:21:30  70  	  TRANSACTION
15:21:30  71  	SET
15:21:30  72  	  TRANSACTION_STATUS_ID = NVL(in_transaction_status_id, TRANSACTION_STATUS_ID),
15:21:30  73  	  TRANSACTION_AMOUNT	= NVL(in_transaction_amount, TRANSACTION_AMOUNT),
15:21:30  74  	  UPDATE_DATE		= SYSDATE,
15:21:30  75  	  UPDATED_BY		= in_updated_by,
15:21:30  76  	  ORDER_ID		= NVL(in_order_id, ORDER_ID),
15:21:30  77  	  IS_SETTLED		= NVL(in_is_settled, IS_SETTLED)
15:21:30  78  	WHERE
15:21:30  79  	  ID = in_transaction_id;
15:21:30  80  END UPDATE_TRANSACTION;
15:21:30  81  
15:21:30  82  /*******************************************************************/
15:21:30  83  
15:21:30  84  PROCEDURE READ_TRANSACTION (
15:21:30  85  	in_transaction_id IN TRANSACTION.ID%TYPE,
15:21:30  86  	out_result_set	  OUT SYS_REFCURSOR
15:21:30  87  ) AS
15:21:30  88  BEGIN
15:21:30  89  	OPEN out_result_set FOR
15:21:30  90  	SELECT
15:21:30  91  	  ID,
15:21:30  92  	  TRANSACTION_STATUS_ID,
15:21:30  93  	  TRANSACTION_TYPE_CODE,
15:21:30  94  	  TRANSACTION_AMOUNT,
15:21:30  95  	  CREATE_DATE,
15:21:30  96  	  CREATED_BY,
15:21:30  97  	  UPDATE_DATE,
15:21:30  98  	  UPDATED_BY,
15:21:30  99  	  ORDER_ID,
15:21:30 100  	  IS_REFUND,
15:21:30 101  	  IS_SETTLED,
15:21:30 102  	  TRANSACTION_TYPE_CODE
15:21:30 103  	FROM
15:21:30 104  	  TRANSACTION
15:21:30 105  	WHERE
15:21:30 106  	  ID = in_transaction_id;
15:21:30 107  END READ_TRANSACTION;
15:21:30 108  
15:21:30 109  /*******************************************************************/
15:21:30 110  
15:21:30 111  PROCEDURE CREATE_TRANSACTION_ATTEMPT(
15:21:30 112  	inout_transaction_attempt_id IN OUT TRANSACTION_ATTEMPT.ID%TYPE,
15:21:30 113  	in_transaction_id	     IN TRANSACTION_ATTEMPT.TRANSACTION_ID%TYPE,
15:21:30 114  	in_external_status_code      IN TRANSACTION_ATTEMPT.EXTERNAL_STATUS_CODE%TYPE DEFAULT NULL,
15:21:30 115  	in_external_status_message   IN TRANSACTION_ATTEMPT.EXTERNAL_STATUS_MESSAGE%TYPE DEFAULT NULL,
15:21:30 116  	in_created_by		     IN TRANSACTION_ATTEMPT.CREATED_BY%TYPE,
15:21:30 117  	in_external_transaction_id   IN TRANSACTION_ATTEMPT.EXTERNAL_TRANSACTION_ID%TYPE DEFAULT NULL,
15:21:30 118  	in_transaction_start_time    IN TRANSACTION_ATTEMPT.TRANSACTION_START_TIME%TYPE DEFAULT NULL,
15:21:30 119  	in_status_id		     IN TRANSACTION_ATTEMPT.TRANSACTION_ATTEMPT_STATUS_ID%TYPE
15:21:30 120  ) AS
15:21:30 121  BEGIN
15:21:30 122  	IF inout_transaction_attempt_id IS NULL THEN
15:21:30 123  	  SELECT
15:21:30 124  	    TRNA_ID_SEQ.nextVal into inout_transaction_attempt_id
15:21:30 125  	  FROM DUAL;
15:21:30 126  	END IF;
15:21:30 127  	INSERT INTO TRANSACTION_ATTEMPT (
15:21:30 128  	  ID,
15:21:30 129  	  TRANSACTION_ID,
15:21:30 130  	  EXTERNAL_STATUS_CODE,
15:21:30 131  	  EXTERNAL_STATUS_MESSAGE,
15:21:30 132  	  CREATE_DATE,
15:21:30 133  	  CREATED_BY,
15:21:30 134  	  EXTERNAL_TRANSACTION_ID,
15:21:30 135  	  TRANSACTION_START_TIME,
15:21:30 136  	  TRANSACTION_ATTEMPT_STATUS_ID
15:21:30 137  	) VALUES (
15:21:30 138  	  inout_transaction_attempt_id,
15:21:30 139  	  in_transaction_id,
15:21:30 140  	  in_external_status_code,
15:21:30 141  	  in_external_status_message,
15:21:30 142  	  SYSDATE,
15:21:30 143  	  in_created_by,
15:21:30 144  	  in_external_transaction_id,
15:21:30 145  	  in_transaction_start_time,
15:21:30 146  	  in_status_id
15:21:30 147  	);
15:21:30 148  END;
15:21:30 149  
15:21:30 150  /*******************************************************************/
15:21:30 151  
15:21:30 152  PROCEDURE UPDATE_TRANSACTION_ATTEMPT (
15:21:30 153  	in_transaction_attempt_id  IN TRANSACTION_ATTEMPT.ID%TYPE,
15:21:30 154  	in_external_status_code    IN TRANSACTION_ATTEMPT.EXTERNAL_STATUS_CODE%TYPE DEFAULT NULL,
15:21:30 155  	in_external_status_message IN TRANSACTION_ATTEMPT.EXTERNAL_STATUS_MESSAGE%TYPE DEFAULT NULL,
15:21:30 156  	in_external_transaction_id IN TRANSACTION_ATTEMPT.EXTERNAL_TRANSACTION_ID%TYPE DEFAULT NULL,
15:21:30 157  	in_transaction_start_time  IN TRANSACTION_ATTEMPT.TRANSACTION_START_TIME%TYPE DEFAULT NULL,
15:21:30 158  	in_status_id		   IN TRANSACTION_ATTEMPT.TRANSACTION_ATTEMPT_STATUS_ID%TYPE
15:21:30 159  ) AS
15:21:30 160  BEGIN
15:21:30 161  	UPDATE
15:21:30 162  	  TRANSACTION_ATTEMPT
15:21:30 163  	SET
15:21:30 164  	  EXTERNAL_STATUS_CODE		= NVL(in_external_status_code, EXTERNAL_STATUS_CODE),
15:21:30 165  	  EXTERNAL_STATUS_MESSAGE	= NVL(in_external_status_message, EXTERNAL_STATUS_MESSAGE),
15:21:30 166  	  EXTERNAL_TRANSACTION_ID	= NVL(in_external_transaction_id, EXTERNAL_TRANSACTION_ID),
15:21:30 167  	  TRANSACTION_START_TIME	= NVL(in_transaction_start_time, TRANSACTION_START_TIME),
15:21:30 168  	  TRANSACTION_ATTEMPT_STATUS_ID = NVL(in_status_id, TRANSACTION_ATTEMPT_STATUS_ID)
15:21:30 169  	WHERE
15:21:30 170  	  ID = in_transaction_attempt_id;
15:21:30 171  END;
15:21:30 172  
15:21:30 173  /*******************************************************************/
15:21:30 174  
15:21:30 175  PROCEDURE UPDATE_TRANSACTION_ORDER_ID (
15:21:30 176  /*
15:21:30 177  Throws exceptions:
15:21:30 178  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30 179  APP_EXCEPTION_CODES_V18.INTRNAL_ERROR
15:21:30 180  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 181  */
15:21:30 182  	in_transaction_id IN TRANSACTION.ID%TYPE,
15:21:30 183  	in_order_id	  IN TRANSACTION.ORDER_ID%TYPE,
15:21:30 184  	in_updated_by	  IN TRANSACTION.UPDATED_BY%TYPE
15:21:30 185  ) AS
15:21:30 186  SPROC_NAME CONSTANT VARCHAR2(27) := 'UPDATE_TRANSACTION_ORDER_ID';
15:21:30 187  -- EXCEPTIONS
15:21:30 188  BAD_TRANSACTION_ID EXCEPTION;
15:21:30 189  BEGIN
15:21:30 190  
15:21:30 191  	PROCS_HISTORY_V18.CREATE_TRANSACTION_HISTORY(
15:21:30 192  	  in_transaction_id	       => in_transaction_id,
15:21:30 193  	  in_system_activity_reason_id => GLOBAL_ENUMS_V18.SAC_SYSTEM_APPLIED_RULE
15:21:30 194  	);
15:21:30 195  
15:21:30 196  	UPDATE
15:21:30 197  	  TRANSACTION
15:21:30 198  	SET
15:21:30 199  	  TRANSACTION.ORDER_ID	 = in_order_id,
15:21:30 200  	  TRANSACTION.UPDATED_BY = in_updated_by,
15:21:30 201  	  TRANSACTION.UPDATE_DATE= SYSDATE
15:21:30 202  	WHERE
15:21:30 203  	  TRANSACTION.ID = in_transaction_id
15:21:30 204  	  AND TRANSACTION.ORDER_ID IS NULL;
15:21:30 205  
15:21:30 206  	IF SQL%ROWCOUNT = 0 THEN
15:21:30 207  	  RAISE BAD_TRANSACTION_ID;
15:21:30 208  	END IF;
15:21:30 209  EXCEPTION
15:21:30 210  WHEN BAD_TRANSACTION_ID THEN
15:21:30 211  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 212  	  SPROC_NAME, 'No such transaction');
15:21:30 213  END UPDATE_TRANSACTION_ORDER_ID;
15:21:30 214  
15:21:30 215  END PROCS_TRANSACTION_CRU_V18;
15:21:30 216  .
15:21:30 SQL> /

Package body created.

Elapsed: 00:00:00.05
15:21:30 SQL> 
15:21:30 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_ADDRESS_V18" AS
15:21:30   2  
15:21:30   3  PROCEDURE CREATE_ADDRESS(
15:21:30   4  /*
15:21:30   5  Throws exceptions:
15:21:30   6  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30   7  */
15:21:30   8  	  out_address_id	OUT NUMBER,
15:21:30   9  	  in_address1		IN ADDRESS.ADDRESS1%TYPE DEFAULT NULL,
15:21:30  10  	  in_address2		IN ADDRESS.ADDRESS2%TYPE DEFAULT NULL,
15:21:30  11  	  in_city		IN ADDRESS.CITY%TYPE DEFAULT NULL,
15:21:30  12  	  in_state		IN ADDRESS.STATE%TYPE DEFAULT NULL,
15:21:30  13  	  in_postal_code	IN ADDRESS.POSTAL_CODE%TYPE DEFAULT NULL,
15:21:30  14  	  in_country		IN ADDRESS.COUNTRY%TYPE DEFAULT NULL,
15:21:30  15  	  in_created_by 	IN ADDRESS.CREATED_BY%TYPE
15:21:30  16  ) AS
15:21:30  17  -- VARIABLES
15:21:30  18  SPROC_NAME	 CONSTANT VARCHAR2(14) := 'CREATE_ADDRESS';
15:21:30  19  -- EXCEPTIONS
15:21:30  20  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:30  21  BEGIN
15:21:30  22  
15:21:30  23  	CORE_OWNER.PROCS_ADDRESS_CRU_V18.CREATE_ADDRESS(
15:21:30  24  	  out_address_id      => out_address_id,
15:21:30  25  	  in_address_id       => null,
15:21:30  26  	  in_address1	      => in_address1,
15:21:30  27  	  in_address2	      => in_address2,
15:21:30  28  	  in_city	      => in_city,
15:21:30  29  	  in_state	      => in_state,
15:21:30  30  	  in_postal_code      => in_postal_code,
15:21:30  31  	  in_country	      => in_country,
15:21:30  32  	  in_created_by       => in_created_by
15:21:30  33  	);
15:21:30  34  
15:21:30  35  END CREATE_ADDRESS;
15:21:30  36  
15:21:30  37  PROCEDURE UPDATE_ADDRESS(
15:21:30  38  /*
15:21:30  39  Throws exceptions:
15:21:30  40  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30  41  */
15:21:30  42  	  in_address_id 	IN ADDRESS.ID%TYPE,
15:21:30  43  	  in_address1		IN ADDRESS.ADDRESS1%TYPE DEFAULT NULL,
15:21:30  44  	  in_address2		IN ADDRESS.ADDRESS2%TYPE DEFAULT NULL,
15:21:30  45  	  in_city		IN ADDRESS.CITY%TYPE DEFAULT NULL,
15:21:30  46  	  in_state		IN ADDRESS.STATE%TYPE DEFAULT NULL,
15:21:30  47  	  in_postal_code	IN ADDRESS.POSTAL_CODE%TYPE DEFAULT NULL,
15:21:30  48  	  in_country		IN ADDRESS.COUNTRY%TYPE DEFAULT NULL,
15:21:30  49  	  in_updated_by 	IN ADDRESS.UPDATED_BY%TYPE
15:21:30  50  ) AS
15:21:30  51  BEGIN
15:21:30  52  	CORE_OWNER.PROCS_ADDRESS_CRU_V18.UPDATE_ADDRESS(
15:21:30  53  	  in_address_id 	=> in_address_id,
15:21:30  54  	  in_address1		=> in_address1,
15:21:30  55  	  in_address2		=> in_address2,
15:21:30  56  	  in_city		=> in_city,
15:21:30  57  	  in_state		=> in_state,
15:21:30  58  	  in_postal_code	=> in_postal_code,
15:21:30  59  	  in_country		=> in_country,
15:21:30  60  	  in_updated_by 	=> in_updated_by
15:21:30  61  	);
15:21:30  62  END UPDATE_ADDRESS;
15:21:30  63  
15:21:30  64  PROCEDURE GET_ADDRESS (
15:21:30  65  /*
15:21:30  66  Throws exceptions:
15:21:30  67  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30  68  */
15:21:30  69  	  in_id 		IN ADDRESS.ID%TYPE,
15:21:30  70  	  out_result_set	OUT SYS_REFCURSOR
15:21:30  71  ) AS
15:21:30  72  SPROC_NAME CONSTANT VARCHAR2(11) := 'GET_ADDRESS';
15:21:30  73  BEGIN
15:21:30  74  
15:21:30  75  OPEN out_result_set FOR
15:21:30  76  SELECT * FROM ADDRESS WHERE ADDRESS.ID = in_id;
15:21:30  77  
15:21:30  78  END GET_ADDRESS;
15:21:30  79  
15:21:30  80  END PROCS_ADDRESS_V18;
15:21:30  81  .
15:21:30 SQL> /

Package body created.

Elapsed: 00:00:00.02
15:21:30 SQL> 
15:21:30 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_ADJUSTMENTS_V18" AS
15:21:30   2  
15:21:30   3  PROCEDURE CREATE_INVOICE_ADJUSTMENT (
15:21:30   4  	in_invoice_id		  IN NUMBER,
15:21:30   5  	in_adjustment_reason	  IN VARCHAR2,
15:21:30   6  	in_is_credit		  IN NUMBER,
15:21:30   7  	in_charge_id		  IN NUMBER,
15:21:30   8  	in_business_date	  IN DATE,
15:21:30   9  	in_created_by		  IN VARCHAR2,
15:21:30  10  	out_invoice_adjustment_id OUT NUMBER
15:21:30  11  ) AS
15:21:30  12  SPROC_NAME CONSTANT VARCHAR2(25) := 'CREATE_INVOICE_ADJUSTMENT';
15:21:30  13  -- VARIABLES
15:21:30  14  var_current_date	    DATE := SYSDATE;
15:21:30  15  var_new_entity_id     NUMBER;
15:21:30  16  var_inv_adj_reason_id NUMBER;
15:21:30  17  -- EXCEPTIONS
15:21:30  18  BAD_IN_IS_CREDIT_VALUE EXCEPTION;
15:21:30  19  DAB_ADJUSTMENT_REASON  EXCEPTION;
15:21:30  20  BEGIN
15:21:30  21  
15:21:30  22  	IF in_is_credit != GLOBAL_CONSTANTS_V18.TRUE AND in_is_credit != GLOBAL_CONSTANTS_V18.FALSE THEN
15:21:30  23  	  RAISE BAD_IN_IS_CREDIT_VALUE;
15:21:30  24  	END IF;
15:21:30  25  
15:21:30  26  	BEGIN
15:21:30  27  	  SELECT
15:21:30  28  	    ID into var_inv_adj_reason_id
15:21:30  29  	  FROM
15:21:30  30  	    INVOICE_ADJUSTMENT_REASON
15:21:30  31  	  WHERE
15:21:30  32  	    UPPER(VALUE) = UPPER(in_adjustment_reason);
15:21:30  33  	  EXCEPTION
15:21:30  34  	    WHEN NO_DATA_FOUND THEN
15:21:30  35  	      RAISE DAB_ADJUSTMENT_REASON;
15:21:30  36  	END;
15:21:30  37  
15:21:30  38  	SELECT
15:21:30  39  	  INV_ADJ_ID_SEQ.nextVal into var_new_entity_id
15:21:30  40  	FROM
15:21:30  41  	  DUAL;
15:21:30  42  
15:21:30  43  	INSERT INTO INVOICE_ADJUSTMENT (
15:21:30  44  	  ID,
15:21:30  45  	  INVOICE_ID,
15:21:30  46  	  INVOICE_ADJUSTMENT_REASON_ID,
15:21:30  47  	  IS_CREDIT,
15:21:30  48  	  CHARGE_ID,
15:21:30  49  	  ADJUSTMENT_DATE,
15:21:30  50  	  CREATE_DATE,
15:21:30  51  	  CREATED_BY,
15:21:30  52  	  UPDATE_DATE,
15:21:30  53  	  UPDATED_BY
15:21:30  54  	)
15:21:30  55  	VALUES (
15:21:30  56  	  var_new_entity_id,
15:21:30  57  	  in_invoice_id,
15:21:30  58  	  var_inv_adj_reason_id,
15:21:30  59  	  in_is_credit,
15:21:30  60  	  in_charge_id,
15:21:30  61  	  in_business_date,
15:21:30  62  	  var_current_date,
15:21:30  63  	  in_created_by,
15:21:30  64  	  var_current_date,
15:21:30  65  	  in_created_by
15:21:30  66  	);
15:21:30  67  
15:21:30  68  	out_invoice_adjustment_id := var_new_entity_id;
15:21:30  69  
15:21:30  70  EXCEPTION
15:21:30  71  WHEN BAD_IN_IS_CREDIT_VALUE THEN
15:21:30  72  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:30  73  	  SPROC_NAME, 'Bad in_is_credit value');
15:21:30  74  WHEN DAB_ADJUSTMENT_REASON THEN
15:21:30  75  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:30  76  	  SPROC_NAME, 'Bad adjustment reason');
15:21:30  77  WHEN OTHERS THEN
15:21:30  78  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30  79  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30  80  END CREATE_INVOICE_ADJUSTMENT;
15:21:30  81  
15:21:30  82  /******************************************************************************/
15:21:30  83  
15:21:30  84  PROCEDURE UPDATE_INVOICE_ADJUSTMENT (
15:21:30  85  	  in_invoice_id 	    IN NUMBER,
15:21:30  86  	  in_original_charge_id     IN NUMBER,
15:21:30  87  	  in_charge_id		    IN NUMBER,
15:21:30  88  	  in_updated_by 	    IN VARCHAR2
15:21:30  89  ) AS
15:21:30  90  SPROC_NAME CONSTANT VARCHAR2(32) := 'UPDATE_INVOICE_ADJUSTMENT';
15:21:30  91  var_invoice_adjustment_id NUMBER;
15:21:30  92  BEGIN
15:21:30  93  	SELECT
15:21:30  94  	  id into var_invoice_adjustment_id
15:21:30  95  	FROM
15:21:30  96  	  INVOICE_ADJUSTMENT
15:21:30  97  	WHERE INVOICE_ID = in_invoice_id
15:21:30  98  	      AND CHARGE_ID = in_original_charge_id;
15:21:30  99  
15:21:30 100  	--create history
15:21:30 101  	PROCS_HISTORY_V18.CREATE_INVOICE_ADJ_HISTORY(
15:21:30 102  	  in_invoice_adjustment_id    => var_invoice_adjustment_id,
15:21:30 103  	  in_system_activity_reason_id => GLOBAL_ENUMS_V18.SAC_SYSTEM_APPLIED_RULE
15:21:30 104  	);
15:21:30 105  
15:21:30 106  	UPDATE INVOICE_ADJUSTMENT
15:21:30 107  	SET CHARGE_ID = in_charge_id, UPDATE_DATE=sysdate, UPDATED_BY=in_updated_by
15:21:30 108  	WHERE ID = var_invoice_adjustment_id;
15:21:30 109  
15:21:30 110  EXCEPTION
15:21:30 111  WHEN NO_DATA_FOUND THEN
15:21:30 112  	    NULL;
15:21:30 113  END UPDATE_INVOICE_ADJUSTMENT;
15:21:30 114  
15:21:30 115  /******************************************************************************/
15:21:30 116  
15:21:30 117  PROCEDURE CREATE_LINE_ITEM_ADJUSTMENT (
15:21:30 118  	in_line_item_id 	    IN NUMBER,
15:21:30 119  	in_invoice_adjustment_id    IN NUMBER,
15:21:30 120  	in_amount		    IN NUMBER,
15:21:30 121  	in_tax			    IN NUMBER,
15:21:30 122  	in_discount		    IN NUMBER,
15:21:30 123  	in_created_by		    IN VARCHAR2,
15:21:30 124  	out_line_item_adjustment_id OUT NUMBER
15:21:30 125  ) AS
15:21:30 126  SPROC_NAME CONSTANT VARCHAR2(30) := 'CREATE_LINE_ITEM_ADJUSTMENT';
15:21:30 127  -- VARIABLES
15:21:30 128  var_current_date DATE := SYSDATE;
15:21:30 129  var_new_entity_id NUMBER;
15:21:30 130  BEGIN
15:21:30 131  
15:21:30 132  	SELECT
15:21:30 133  	  LI_ADJ_ID_SEQ.nextVal into var_new_entity_id
15:21:30 134  	FROM
15:21:30 135  	  DUAL;
15:21:30 136  
15:21:30 137  	INSERT INTO LINE_ITEM_ADJUSTMENT (
15:21:30 138  	  ID,
15:21:30 139  	  LINE_ITEM_ID,
15:21:30 140  	  INVOICE_ADJUSTMENT_ID,
15:21:30 141  	  AMOUNT,
15:21:30 142  	  TAX,
15:21:30 143  	  DISCOUNT,
15:21:30 144  	  CREATE_DATE,
15:21:30 145  	  CREATED_BY
15:21:30 146  	)
15:21:30 147  	VALUES (
15:21:30 148  	  var_new_entity_id,
15:21:30 149  	  in_line_item_id,
15:21:30 150  	  in_invoice_adjustment_id,
15:21:30 151  	  in_amount,
15:21:30 152  	  in_tax,
15:21:30 153  	  in_discount,
15:21:30 154  	  var_current_date,
15:21:30 155  	  in_created_by
15:21:30 156  	);
15:21:30 157  
15:21:30 158  	out_line_item_adjustment_id := var_new_entity_id;
15:21:30 159  
15:21:30 160  EXCEPTION
15:21:30 161  WHEN OTHERS THEN
15:21:30 162  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 163  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 164  END CREATE_LINE_ITEM_ADJUSTMENT;
15:21:30 165  
15:21:30 166  /******************************************************************************/
15:21:30 167  
15:21:30 168  PROCEDURE CREATE_TAX_ADJUSTMENT (
15:21:30 169  	in_tax_id		   IN NUMBER,
15:21:30 170  	in_line_item_adjustment_id IN NUMBER,
15:21:30 171  	in_amount		   IN NUMBER,
15:21:30 172  	in_created_by		   IN VARCHAR2,
15:21:30 173  	out_tax_adjustment_id	   OUT NUMBER
15:21:30 174  ) AS
15:21:30 175  SPROC_NAME CONSTANT VARCHAR2(30) := 'CREATE_TAX_ADJUSTMENT';
15:21:30 176  -- VARIABLES
15:21:30 177  var_current_date DATE := SYSDATE;
15:21:30 178  var_new_entity_id NUMBER;
15:21:30 179  BEGIN
15:21:30 180  
15:21:30 181  	SELECT
15:21:30 182  	  TAXADJ_ID_SEQ.nextVal into var_new_entity_id
15:21:30 183  	FROM
15:21:30 184  	  DUAL;
15:21:30 185  
15:21:30 186  	INSERT INTO TAX_ADJUSTMENT (
15:21:30 187  	  ID,
15:21:30 188  	  TAX_ID,
15:21:30 189  	  LINE_ITEM_ADJUSTMENT_ID,
15:21:30 190  	  AMOUNT,
15:21:30 191  	  CREATE_DATE,
15:21:30 192  	  CREATED_BY
15:21:30 193  	)
15:21:30 194  	VALUES (
15:21:30 195  	  var_new_entity_id,
15:21:30 196  	  in_tax_id,
15:21:30 197  	  in_line_item_adjustment_id,
15:21:30 198  	  in_amount,
15:21:30 199  	  var_current_date,
15:21:30 200  	  in_created_by
15:21:30 201  	);
15:21:30 202  
15:21:30 203  	out_tax_adjustment_id := var_new_entity_id;
15:21:30 204  
15:21:30 205  EXCEPTION
15:21:30 206  WHEN OTHERS THEN
15:21:30 207  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 208  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 209  END CREATE_TAX_ADJUSTMENT;
15:21:30 210  
15:21:30 211  /******************************************************************************/
15:21:30 212  
15:21:30 213  PROCEDURE CREATE_DISCOUNT_LI_ADJUSTMENT (
15:21:30 214  	in_discount_id		   NUMBER,
15:21:30 215  	in_line_item_id 	   NUMBER,
15:21:30 216  	in_line_item_adjustment_id IN NUMBER,
15:21:30 217  	in_amount		   IN NUMBER,
15:21:30 218  	in_created_by		   IN VARCHAR2,
15:21:30 219  	out_discount_li_id	   OUT NUMBER
15:21:30 220  ) AS
15:21:30 221  SPROC_NAME CONSTANT VARCHAR2(32) := 'CREATE_DISCOUNT_LI_ADJUSTMENT';
15:21:30 222  -- VARIABLES
15:21:30 223  var_current_date DATE := SYSDATE;
15:21:30 224  var_new_entity_id NUMBER;
15:21:30 225  BEGIN
15:21:30 226  
15:21:30 227  	SELECT
15:21:30 228  	  DLIADJ_ID_SEQ.nextVal into var_new_entity_id
15:21:30 229  	FROM
15:21:30 230  	  DUAL;
15:21:30 231  
15:21:30 232  	INSERT INTO DISCOUNT_LINEITEM_ADJUSTMENT (
15:21:30 233  	  ID,
15:21:30 234  	  DISCOUNT_ID,
15:21:30 235  	  LINE_ITEM_ID,
15:21:30 236  	  LINE_ITEM_ADJUSTMENT_ID,
15:21:30 237  	  AMOUNT,
15:21:30 238  	  CREATE_DATE,
15:21:30 239  	  CREATED_BY
15:21:30 240  	)
15:21:30 241  	VALUES (
15:21:30 242  	  var_new_entity_id,
15:21:30 243  	  in_discount_id,
15:21:30 244  	  in_line_item_id,
15:21:30 245  	  in_line_item_adjustment_id,
15:21:30 246  	  in_amount,
15:21:30 247  	  var_current_date,
15:21:30 248  	  in_created_by
15:21:30 249  	);
15:21:30 250  
15:21:30 251  	out_discount_li_id := var_new_entity_id;
15:21:30 252  
15:21:30 253  EXCEPTION
15:21:30 254  WHEN OTHERS THEN
15:21:30 255  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 256  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 257  END CREATE_DISCOUNT_LI_ADJUSTMENT;
15:21:30 258  
15:21:30 259  END PROCS_ADJUSTMENTS_V18;
15:21:30 260  .
15:21:30 SQL> /

Package body created.

Elapsed: 00:00:00.03
15:21:30 SQL> 
15:21:30 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_ADX_V18" AS
15:21:30   2  
15:21:30   3  PROCEDURE GET_SUB_ADX_INFO (
15:21:30   4  /*
15:21:30   5  Throws exceptions:
15:21:30   6  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30   7  */
15:21:30   8  	out_result_set	    OUT SYS_REFCURSOR,
15:21:30   9  	in_group_id    IN ACCOUNT.GROUP_ID%TYPE
15:21:30  10  ) AS
15:21:30  11  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_SUB_ADX_INFO';
15:21:30  12  BEGIN
15:21:30  13  OPEN out_result_set FOR
15:21:30  14  SELECT /*+ FIRST_ROWS(5) */
15:21:30  15  	s.offer_chain_id,
15:21:30  16  	s.create_date,
15:21:30  17  	decode(s.subscription_status_id, 1, 'a', 'c') status,
15:21:30  18  	ocmd.value,
15:21:30  19  	a.group_id,
15:21:30  20  	s.id subscription_id
15:21:30  21  FROM
15:21:30  22  	account a,
15:21:30  23  	subscription s,
15:21:30  24  	offer_chain_meta_data ocmd,
15:21:30  25  	group_account g,
15:21:30  26  	subscription_share ss,
15:21:30  27  	account a2
15:21:30  28  WHERE
15:21:30  29  	s.account_id = a.id and
15:21:30  30  	s.offer_chain_id = ocmd.offer_chain_id and
15:21:30  31  	g.id = ss.group_account_id and
15:21:30  32  	ss.borrower_account_id = a2.id and
15:21:30  33  	s.id = g.subscription_id and
15:21:30  34  	ocmd.name = 'ADX_BUNDLE' and
15:21:30  35  	a2.group_id = in_group_id and
15:21:30  36  	rownum < 5
15:21:30  37  union all
15:21:30  38  SELECT /*+ FIRST_ROWS(5) */
15:21:30  39  	s.offer_chain_id,
15:21:30  40  	s.create_date,
15:21:30  41  	decode(s.subscription_status_id, 1, 'a', 'c') status,
15:21:30  42  	ocmd.value,
15:21:30  43  	a.group_id,
15:21:30  44  	s.id subscription_id
15:21:30  45  FROM
15:21:30  46  	account a,
15:21:30  47  	subscription s,
15:21:30  48  	offer_chain_meta_data ocmd
15:21:30  49  WHERE
15:21:30  50  	s.account_id = a.id and
15:21:30  51  	s.offer_chain_id = ocmd.offer_chain_id and
15:21:30  52  	ocmd.name = 'ADX_BUNDLE' and
15:21:30  53  	a.group_id = in_group_id and
15:21:30  54  	rownum < 5
15:21:30  55  ;
15:21:30  56  
15:21:30  57  END GET_SUB_ADX_INFO;
15:21:30  58  
15:21:30  59  END PROCS_ADX_V18;
15:21:30  60  .
15:21:30 SQL> /

Package body created.

Elapsed: 00:00:00.04
15:21:30 SQL> 
15:21:30 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_AMAZON_V18" AS
15:21:30   2  
15:21:30   3  PROCEDURE CREATE_AMAZON_SUB(
15:21:30   4  /*
15:21:30   5  Throws exceptions:
15:21:30   6  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30   7  */
15:21:30   8  	  out_id	      OUT NUMBER,
15:21:30   9  	  in_subscription_id  IN AMAZON_SUB.SUBSCRIPTION_ID%TYPE,
15:21:30  10  	  in_amazon_id	      IN AMAZON_SUB.AMAZON_ID%TYPE,
15:21:30  11  	  in_created_by       IN AMAZON_SUB.CREATED_BY%TYPE
15:21:30  12  ) AS
15:21:30  13  -- VARIABLES
15:21:30  14  SPROC_NAME	 CONSTANT VARCHAR2(32) := 'CREATE_AMAZON_SUB';
15:21:30  15  -- EXCEPTIONS
15:21:30  16  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:30  17  BEGIN
15:21:30  18  
15:21:30  19  	CORE_OWNER.PROCS_AMAZON_CRU_V18.CREATE_AMAZON_SUB(
15:21:30  20  	  out_id	      =>  out_id,
15:21:30  21  	  in_subscription_id  =>  in_subscription_id,
15:21:30  22  	  in_amazon_id	      =>  in_amazon_id,
15:21:30  23  	  in_created_by       =>  in_created_by
15:21:30  24  	);
15:21:30  25  
15:21:30  26  END CREATE_AMAZON_SUB;
15:21:30  27  
15:21:30  28  PROCEDURE GET_ACTIVE_SUB_IDS (
15:21:30  29  /*
15:21:30  30  Throws exceptions:
15:21:30  31  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30  32  */
15:21:30  33  	out_result_set	    OUT SYS_REFCURSOR,
15:21:30  34  	in_amazon_id	IN AMAZON_SUB.AMAZON_ID%TYPE
15:21:30  35  ) AS
15:21:30  36  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_ACTIVE_SUB_IDS';
15:21:30  37  BEGIN
15:21:30  38  OPEN out_result_set FOR
15:21:30  39  SELECT s.id
15:21:30  40  FROM subscription s, amazon_sub am
15:21:30  41  WHERE
15:21:30  42  	s.id = am.subscription_id
15:21:30  43  	and s.subscription_status_id = GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE
15:21:30  44  	and am.amazon_id = in_amazon_id
15:21:30  45  ;
15:21:30  46  
15:21:30  47  END GET_ACTIVE_SUB_IDS;
15:21:30  48  
15:21:30  49  PROCEDURE GET_ACTIVE_GROUP_IDS (
15:21:30  50  /*
15:21:30  51  Throws exceptions:
15:21:30  52  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30  53  */
15:21:30  54  	out_result_set	    OUT SYS_REFCURSOR,
15:21:30  55  	in_amazon_id	IN AMAZON_SUB.AMAZON_ID%TYPE
15:21:30  56  ) AS
15:21:30  57  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_ACTIVE_GROUP_IDS';
15:21:30  58  BEGIN
15:21:30  59  OPEN out_result_set FOR
15:21:30  60  SELECT distinct a.group_id id
15:21:30  61  FROM subscription s, amazon_sub am, account a
15:21:30  62  WHERE
15:21:30  63  	s.id = am.subscription_id
15:21:30  64  	and a.id = s.account_id
15:21:30  65  	and s.subscription_status_id = GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE
15:21:30  66  	and am.amazon_id = in_amazon_id
15:21:30  67  ;
15:21:30  68  
15:21:30  69  END GET_ACTIVE_GROUP_IDS;
15:21:30  70  
15:21:30  71  END PROCS_AMAZON_V18;
15:21:30  72  .
15:21:30 SQL> /

Package body created.

Elapsed: 00:00:00.02
15:21:30 SQL> 
15:21:30 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_CUPY" AS
15:21:30   2  
15:21:30   3  	/****************************************************************************/
15:21:30   4  
15:21:30   5  	PROCEDURE POPULATE_REQUEST_INFO(
15:21:30   6  	  in_hours_prior    IN	NUMBER,
15:21:30   7  	  in_filename	    IN	CC_REQUEST_FILE.FILE_NAME%TYPE,
15:21:30   8  	  in_creator	    IN	CC_REQUEST_FILE.UPDATED_BY%TYPE
15:21:30   9  	) AS
15:21:30  10  	SPROC_NAME CONSTANT VARCHAR2(32) := 'POPULATE_REQUEST_INFO';
15:21:30  11  	var_start_date	    DATE := SYSDATE;
15:21:30  12  	var_end_date	    DATE := var_start_date + (in_hours_prior/24);
15:21:30  13  	var_request_file_id NUMBER := 0;
15:21:30  14  	var_license_count   NUMBER := 0;
15:21:30  15  	var_cc_update_count NUMBER := 0;
15:21:30  16  	BEGIN
15:21:30  17  	    SELECT CC_REQUEST_FILE_ID_SEQ.NEXTVAL INTO var_request_file_id  FROM DUAL;
15:21:30  18  	    INSERT INTO CC_REQUEST_FILE (ID,
15:21:30  19  					 FILE_NAME,
15:21:30  20  					 CC_REQUEST_FILE_STATUS,
15:21:30  21  					 CREATE_DATE,
15:21:30  22  					 CREATED_BY,
15:21:30  23  					 UPDATE_DATE,
15:21:30  24  					 UPDATED_BY)
15:21:30  25  					 VALUES (
15:21:30  26  					 var_request_file_id,
15:21:30  27  					 in_filename,
15:21:30  28  					 'NOT_CREATED',
15:21:30  29  					 var_start_date,
15:21:30  30  					 in_creator,
15:21:30  31  					 var_start_date,
15:21:30  32  					 in_creator);
15:21:30  33  
15:21:30  34  	   FOR record IN (SELECT
15:21:30  35  			    l.ID LICENSE_ID, cc.ID CREDIT_CARD_ID
15:21:30  36  			  FROM
15:21:30  37  			    LICENSE l INNER JOIN SUBSCRIPTION s ON L.SUBSCRIPTION_ID = s.ID
15:21:30  38  				      INNER JOIN CREDIT_CARD cc ON S.INSTRUMENT_ID   = cc.ID
15:21:30  39  			  WHERE
15:21:30  40  			    s.INSTRUMENT_TYPE_ID	 = 1
15:21:30  41  			    AND cc.CREDIT_CARD_STATUS_ID = 1
15:21:30  42  			    AND s.SUBSCRIPTION_STATUS_ID = 1
15:21:30  43  			    AND l.LICENSE_STATUS_ID	 = 2
15:21:30  44  			    AND cc.CREDIT_CARD_TYPE_ID IN (2,3)
15:21:30  45  			    AND l.END_DATE BETWEEN var_start_date AND var_end_date
15:21:30  46  			    AND l.ID NOT IN (SELECT LICENSE_ID FROM CC_UPDATE))
15:21:30  47  	   LOOP
15:21:30  48  	     var_license_count := 0;
15:21:30  49  	     SELECT COUNT(1) INTO  var_license_count FROM CC_UPDATE WHERE LICENSE_ID = record.LICENSE_ID;
15:21:30  50  
15:21:30  51  	     IF var_license_count = 0 THEN
15:21:30  52  		INSERT INTO CC_UPDATE (ID,
15:21:30  53  				       CREDIT_CARD_ID,
15:21:30  54  				       LICENSE_ID,
15:21:30  55  				       CC_UPDATE_STATUS,
15:21:30  56  				       CC_REQUEST_FILE_ID,
15:21:30  57  				       CREATE_DATE,
15:21:30  58  				       UPDATE_DATE,
15:21:30  59  				       CREATED_BY,
15:21:30  60  				       UPDATED_BY
15:21:30  61  				       ) VALUES (
15:21:30  62  				       CC_UPDATE_SEQ.NEXTVAL,
15:21:30  63  				       record.CREDIT_CARD_ID,
15:21:30  64  				       record.LICENSE_ID,
15:21:30  65  				       'NOT_ADDED_TO_FILE',
15:21:30  66  				       var_request_file_id,
15:21:30  67  				       var_start_date,
15:21:30  68  				       var_start_date,
15:21:30  69  				       in_creator,
15:21:30  70  				       in_creator
15:21:30  71  				       );
15:21:30  72  	     END IF;
15:21:30  73  	   END LOOP;
15:21:30  74  
15:21:30  75  	   SELECT COUNT(1) INTO var_cc_update_count
15:21:30  76  	   FROM CC_UPDATE
15:21:30  77  	   WHERE CC_REQUEST_FILE_ID = var_request_file_id;
15:21:30  78  	   IF var_cc_update_count <= 0 THEN
15:21:30  79  	     UPDATE CC_REQUEST_FILE
15:21:30  80  	     SET CC_REQUEST_FILE_STATUS = 'EMPTY'
15:21:30  81  	     WHERE ID = var_request_file_id;
15:21:30  82  	   END IF;
15:21:30  83  
15:21:30  84  	END POPULATE_REQUEST_INFO;
15:21:30  85  
15:21:30  86  	/****************************************************************************/
15:21:30  87  
15:21:30  88  	PROCEDURE CHASE_PROFILE_BY_REQ_FILE_ID(
15:21:30  89  	  in_request_file_id IN CC_UPDATE.CC_REQUEST_FILE_ID%TYPE,
15:21:30  90  	  in_start	     IN NUMBER,
15:21:30  91  	  in_end	     IN NUMBER,
15:21:30  92  	  out_result_set     OUT SYS_REFCURSOR
15:21:30  93  	) AS
15:21:30  94  	SPROC_NAME CONSTANT VARCHAR2(32) := 'CHASE_PROFILE_BY_REQ_FILE_ID';
15:21:30  95  	var_range_diff	    NUMBER := 0;
15:21:30  96  	var_upper_bond_diff NUMBER := 0;
15:21:30  97  	var_l_start	    NUMBER := 0;
15:21:30  98  	var_l_end	    NUMBER := 0;
15:21:30  99  	BEGIN
15:21:30 100  	  --Normalize the end points [START]
15:21:30 101  	  IF (in_start IS NULL OR in_start < 0) Then
15:21:30 102  	    var_l_start := 0;
15:21:30 103  	  ELSE
15:21:30 104  	    var_l_start := in_start;
15:21:30 105  	  END IF;
15:21:30 106  
15:21:30 107  	  IF (in_end IS NULL) Then
15:21:30 108  	    var_l_end := 500;
15:21:30 109  	  ELSE
15:21:30 110  	    var_l_end := in_end;
15:21:30 111  	  END IF;
15:21:30 112  
15:21:30 113  	  var_l_start := var_l_start + 1;
15:21:30 114  	  var_l_end   := var_l_end   + 1;
15:21:30 115  
15:21:30 116  	  var_range_diff  := var_l_end - var_l_start;
15:21:30 117  	  var_upper_bond_diff :=  var_range_diff - 1000;
15:21:30 118  
15:21:30 119  	  IF (var_upper_bond_diff > 0) Then
15:21:30 120  	    var_l_end := var_l_end - var_upper_bond_diff;
15:21:30 121  	  END IF;
15:21:30 122  	  --Normalize the end points [END]
15:21:30 123  
15:21:30 124  	  OPEN out_result_set FOR
15:21:30 125  	    SELECT CHASE_PROFILE_ID FROM
15:21:30 126  	      (SELECT rownum rnum, q.* FROM
15:21:30 127  		 (SELECT
15:21:30 128  		    cc.CHASE_PROFILE_ID
15:21:30 129  		  FROM
15:21:30 130  		    CREDIT_CARD cc,
15:21:30 131  		    CC_UPDATE ccu
15:21:30 132  		  WHERE
15:21:30 133  		    ccu.CC_REQUEST_FILE_ID = in_request_file_id
15:21:30 134  		    AND ccu.CREDIT_CARD_ID = cc.id
15:21:30 135  		) Q
15:21:30 136  	      WHERE rownum <= var_l_end)
15:21:30 137  	    WHERE rnum >= var_l_Start;
15:21:30 138  	END CHASE_PROFILE_BY_REQ_FILE_ID;
15:21:30 139  
15:21:30 140  	/****************************************************************************/
15:21:30 141  
15:21:30 142  	PROCEDURE UPDATE_REQUEST_FILE_STATUS(
15:21:30 143  	  in_request_file_id IN CC_REQUEST_FILE.ID%TYPE,
15:21:30 144  	  in_status	     IN CC_REQUEST_FILE.CC_REQUEST_FILE_STATUS%TYPE,
15:21:30 145  	  in_updated_by      IN CC_REQUEST_FILE.UPDATED_BY%TYPE
15:21:30 146  	)AS
15:21:30 147  	SPROC_NAME CONSTANT VARCHAR2(32) := 'UPDATE_REQUEST_FILE_STATUS';
15:21:30 148  	BEGIN
15:21:30 149  	  UPDATE CC_REQUEST_FILE
15:21:30 150  	  SET CC_REQUEST_FILE_STATUS = in_status,
15:21:30 151  	      UPDATE_DATE = SYSDATE,
15:21:30 152  	      UPDATED_BY  = in_updated_by
15:21:30 153  	  WHERE ID = in_request_file_id;
15:21:30 154  	END UPDATE_REQUEST_FILE_STATUS;
15:21:30 155  
15:21:30 156  	/****************************************************************************/
15:21:30 157  
15:21:30 158  	PROCEDURE UPDATE_CC_REQUEST_STATUS(
15:21:30 159  	  in_request_file_id IN CC_UPDATE.CC_REQUEST_FILE_ID%TYPE,
15:21:30 160  	  in_status	     IN CC_UPDATE.CC_UPDATE_STATUS%TYPE,
15:21:30 161  	  in_updated_by      IN CC_UPDATE.UPDATED_BY%TYPE
15:21:30 162  	) AS
15:21:30 163  	SPROC_NAME CONSTANT VARCHAR2(32) := 'UPDATE_CC_REQUEST_STATUS';
15:21:30 164  	BEGIN
15:21:30 165  	  UPDATE CC_UPDATE
15:21:30 166  	  SET CC_UPDATE_STATUS = in_status,
15:21:30 167  	      UPDATE_DATE      = SYSDATE,
15:21:30 168  	      UPDATED_BY       = in_updated_by
15:21:30 169  	  WHERE
15:21:30 170  	    CC_REQUEST_FILE_ID = in_request_file_id;
15:21:30 171  	END UPDATE_CC_REQUEST_STATUS;
15:21:30 172  
15:21:30 173  	/****************************************************************************/
15:21:30 174  
15:21:30 175  	PROCEDURE REQUEST_FILES_BY_STATUS (
15:21:30 176  	  in_status	      IN  CC_REQUEST_FILE.CC_REQUEST_FILE_STATUS%TYPE,
15:21:30 177  	  in_older_than_hours IN  NUMBER DEFAULT -288,
15:21:30 178  	  out_request_files   OUT SYS_REFCURSOR
15:21:30 179  	) AS
15:21:30 180  	var_older_than_hours NUMBER := in_older_than_hours;
15:21:30 181  	BEGIN
15:21:30 182  	 IF (var_older_than_hours IS NULL) THEN
15:21:30 183  	   var_older_than_hours := -288;
15:21:30 184  	 END IF;
15:21:30 185  
15:21:30 186  	 OPEN out_request_files FOR
15:21:30 187  	 SELECT
15:21:30 188  	   ID,
15:21:30 189  	   FILE_NAME
15:21:30 190  	 FROM
15:21:30 191  	   CC_REQUEST_FILE
15:21:30 192  	 WHERE
15:21:30 193  	   CC_REQUEST_FILE_STATUS = in_status
15:21:30 194  	 AND
15:21:30 195  	   UPDATE_DATE < SYSDATE - (var_older_than_hours / 24);
15:21:30 196  	END REQUEST_FILES_BY_STATUS;
15:21:30 197  
15:21:30 198  	/****************************************************************************/
15:21:30 199  
15:21:30 200  	PROCEDURE COUNT_BY_REQUEST_FILE_ID (
15:21:30 201  	  in_id     IN	CC_UPDATE.CC_REQUEST_FILE_ID%TYPE,
15:21:30 202  	  out_count OUT NUMBER
15:21:30 203  	) AS
15:21:30 204  	SPROC_NAME CONSTANT VARCHAR2(32) := 'COUNT_BY_REQUEST_FILE_ID';
15:21:30 205  	BEGIN
15:21:30 206  	  SELECT COUNT(1) INTO out_count
15:21:30 207  	  FROM CC_UPDATE
15:21:30 208  	  WHERE CC_REQUEST_FILE_ID = in_id;
15:21:30 209  	END COUNT_BY_REQUEST_FILE_ID;
15:21:30 210  
15:21:30 211  	/****************************************************************************/
15:21:30 212  
15:21:30 213  	PROCEDURE GET_CREDIT_CARD_LICENSE (
15:21:30 214  	  in_chase_profile_id  IN  CREDIT_CARD.CHASE_PROFILE_ID%TYPE,
15:21:30 215  	  in_request_filename  IN  CC_REQUEST_FILE.FILE_NAME%TYPE DEFAULT NULL,
15:21:30 216  	  out_card_license     OUT SYS_REFCURSOR
15:21:30 217  	) AS
15:21:30 218  	BEGIN
15:21:30 219  	  OPEN out_card_license FOR
15:21:30 220  	  SELECT
15:21:30 221  	    cc.ID CREDIT_CARD_ID,
15:21:30 222  	    cc.CHASE_PROFILE_ID,
15:21:30 223  	    cc.LAST_FOUR_CC CREDIT_CARD_LAST_DIGITS,
15:21:30 224  	    cc.UPDATE_DATE CREDIT_CARD_UPDATE_DATE,
15:21:30 225  	    cc.EXPIRATION_DATE CREDIT_CARD_EXPIRATION_DATE,
15:21:30 226  	    cc.UPDATED_BY CREDIT_CARD_UPDATED_BY,
15:21:30 227  	    a.GROUP_ID,
15:21:30 228  	    u.LICENSE_ID,
15:21:30 229  	    u.ID CC_UPDATE_ID,
15:21:30 230  	    l.END_DATE LICENSE_END_DATE,
15:21:30 231  	    DECODE(cc.CREDIT_CARD_STATUS_ID, 1, 1, 0) ACTIVE
15:21:30 232  	  FROM CREDIT_CARD cc, CC_UPDATE u, CC_REQUEST_FILE rf, ACCOUNT a, LICENSE l
15:21:30 233  	  WHERE cc.ID = u.CREDIT_CARD_ID
15:21:30 234  	  AND u.CC_REQUEST_FILE_ID = rf.ID
15:21:30 235  	  AND rf.CC_REQUEST_FILE_STATUS in ('SENT', 'RESPONSE_DOWNLOADED', 'REPORT_DOWNLOADED', 'RESPONSE_COMPLETE', 'NO_RESPONSE')
15:21:30 236  	  AND rf.FILE_NAME = NVL(in_request_filename, rf.FILE_NAME)
15:21:30 237  	  AND upper(cc.CHASE_PROFILE_ID) = in_chase_profile_id
15:21:30 238  	  AND cc.ACCOUNT_ID = a.ID
15:21:30 239  	  AND u.LICENSE_ID = l.ID
15:21:30 240  	  AND u.CC_UPDATE_STATUS NOT IN ('NO_UPDATE', 'UPDATED')
15:21:30 241  	  AND SYSDATE BETWEEN l.START_DATE and l.END_DATE
15:21:30 242  	  ORDER BY cc.UPDATE_DATE DESC;
15:21:30 243  	END GET_CREDIT_CARD_LICENSE;
15:21:30 244  
15:21:30 245  	/****************************************************************************/
15:21:30 246  
15:21:30 247  	PROCEDURE UPDATE_CC_UPDATE(
15:21:30 248  	  in_id 	     IN CC_UPDATE.ID%TYPE,
15:21:30 249  	  in_status	     IN CC_UPDATE.CC_UPDATE_STATUS%TYPE,
15:21:30 250  	  in_action	     IN CC_UPDATE.CC_UPDATE_ACTION%TYPE DEFAULT NULL,
15:21:30 251  	  in_reason	     IN CC_UPDATE.CC_UPDATE_REASON%TYPE DEFAULT NULL,
15:21:30 252  	  in_response_proc_status_code IN CC_UPDATE.RESPONSE_PROC_STATUS_CODE%TYPE DEFAULT NULL,
15:21:30 253  	  in_response_proc_status_msg  IN CC_UPDATE.RESPONSE_PROC_STATUS_MESSAGE%TYPE DEFAULT NULL,
15:21:30 254  	  in_updated_by      IN CC_UPDATE.UPDATED_BY%TYPE
15:21:30 255  	) AS
15:21:30 256  	BEGIN
15:21:30 257  	  UPDATE CC_UPDATE
15:21:30 258  	  SET CC_UPDATE_STATUS = in_status,
15:21:30 259  	  CC_UPDATE_ACTION = NVL(in_action, CC_UPDATE_ACTION),
15:21:30 260  	  CC_UPDATE_REASON = NVL(in_reason, CC_UPDATE_REASON),
15:21:30 261  	  RESPONSE_PROC_STATUS_CODE = NVL(RESPONSE_PROC_STATUS_CODE, in_response_proc_status_code),
15:21:30 262  	  RESPONSE_PROC_STATUS_MESSAGE = NVL(RESPONSE_PROC_STATUS_MESSAGE, in_response_proc_status_msg),
15:21:30 263  	  UPDATE_DATE = SYSDATE,
15:21:30 264  	  UPDATED_BY = in_updated_by
15:21:30 265  	  WHERE ID = in_id;
15:21:30 266  	END UPDATE_CC_UPDATE;
15:21:30 267  
15:21:30 268  	/****************************************************************************/
15:21:30 269  
15:21:30 270  	PROCEDURE UPDATE_CC_UPDATE_STATUS(
15:21:30 271  	  in_id 	IN CC_UPDATE.ID%TYPE,
15:21:30 272  	  in_status	IN CC_UPDATE.CC_UPDATE_STATUS%TYPE,
15:21:30 273  	  in_updated_by IN CC_UPDATE.UPDATED_BY%TYPE
15:21:30 274  	) AS
15:21:30 275  	BEGIN
15:21:30 276  	  UPDATE CC_UPDATE
15:21:30 277  	  SET CC_UPDATE_STATUS = in_status,
15:21:30 278  	  UPDATE_DATE = SYSDATE,
15:21:30 279  	  UPDATED_BY = in_updated_by
15:21:30 280  	  WHERE ID = in_id;
15:21:30 281  	END UPDATE_CC_UPDATE_STATUS;
15:21:30 282  
15:21:30 283  	/****************************************************************************/
15:21:30 284  
15:21:30 285  	PROCEDURE GET_REQUEST_FILE_BY_FILENAME (
15:21:30 286  	  in_request_filename  IN  CC_REQUEST_FILE.FILE_NAME%TYPE,
15:21:30 287  	  out_request_file     OUT SYS_REFCURSOR
15:21:30 288  	) AS
15:21:30 289  	BEGIN
15:21:30 290  	  OPEN out_request_file FOR
15:21:30 291  	  SELECT ID, FILE_NAME
15:21:30 292  	  FROM CC_REQUEST_FILE
15:21:30 293  	  WHERE FILE_NAME = in_request_filename;
15:21:30 294  	END GET_REQUEST_FILE_BY_FILENAME;
15:21:30 295  
15:21:30 296  	/****************************************************************************/
15:21:30 297  
15:21:30 298  	PROCEDURE SUSPEND_CREDIT_CARD (
15:21:30 299  	  in_credit_card_id  IN CREDIT_CARD.ID%TYPE,
15:21:30 300  	  in_updated_by      IN CREDIT_CARD.UPDATED_BY%TYPE
15:21:30 301  	) AS
15:21:30 302  	BEGIN
15:21:30 303  	  -- Create history
15:21:30 304  	  PROCS_HISTORY_V18.CREATE_CREDIT_CARD_HISTORY(
15:21:30 305  	      in_credit_card_id 	   => in_credit_card_id,
15:21:30 306  	      in_system_activity_reason_id => GLOBAL_ENUMS_V18.SAC_SYSTEM_APPLIED_RULE
15:21:30 307  	  );
15:21:30 308  
15:21:30 309  	  UPDATE CREDIT_CARD
15:21:30 310  	  SET UPDATE_DATE = SYSDATE,
15:21:30 311  	  UPDATED_BY = in_updated_by,
15:21:30 312  	  CREDIT_CARD_STATUS_ID = GLOBAL_STATUSES_V18.CREDIT_CARD_DISABLED
15:21:30 313  	  WHERE ID = in_credit_card_id;
15:21:30 314  	END SUSPEND_CREDIT_CARD;
15:21:30 315  
15:21:30 316  	/****************************************************************************/
15:21:30 317  
15:21:30 318  	PROCEDURE UPDATE_CREDIT_CARD (
15:21:30 319  	  in_credit_card_id   IN CREDIT_CARD.ID%TYPE,
15:21:30 320  	  in_last_four_cc     IN CREDIT_CARD.LAST_FOUR_CC%TYPE,
15:21:30 321  	  in_expiration_date  IN CREDIT_CARD.EXPIRATION_DATE%TYPE,
15:21:30 322  	  in_updated_by       IN CREDIT_CARD.UPDATED_BY%TYPE
15:21:30 323  	) AS
15:21:30 324  	BEGIN
15:21:30 325  	  -- Create history
15:21:30 326  	  PROCS_HISTORY_V18.CREATE_CREDIT_CARD_HISTORY(
15:21:30 327  	      in_credit_card_id 	   => in_credit_card_id,
15:21:30 328  	      in_system_activity_reason_id => GLOBAL_ENUMS_V18.SAC_SYSTEM_APPLIED_RULE
15:21:30 329  	  );
15:21:30 330  
15:21:30 331  	  UPDATE CREDIT_CARD
15:21:30 332  	  SET UPDATE_DATE = SYSDATE,
15:21:30 333  	  UPDATED_BY = in_updated_by,
15:21:30 334  	  LAST_FOUR_CC = NVL(in_last_four_cc, LAST_FOUR_CC),
15:21:30 335  	  EXPIRATION_DATE = NVL(in_expiration_date, EXPIRATION_DATE)
15:21:30 336  	  WHERE ID = in_credit_card_id;
15:21:30 337  	END UPDATE_CREDIT_CARD;
15:21:30 338  
15:21:30 339  	/****************************************************************************/
15:21:30 340  
15:21:30 341  	PROCEDURE COMPLETABLE_REQUESTS (
15:21:30 342  	  out_request_files OUT SYS_REFCURSOR
15:21:30 343  	) AS
15:21:30 344  	BEGIN
15:21:30 345  	  OPEN out_request_files FOR
15:21:30 346  	  SELECT DISTINCT rf.ID, rf.FILE_NAME
15:21:30 347  	  FROM CC_REQUEST_FILE rf, CC_UPDATE u
15:21:30 348  	  WHERE CC_REQUEST_FILE_STATUS in ('SENT', 'RESPONSE_DOWNLOADED', 'REPORT_DOWNLOADED', 'RESPONSE_COMPLETE')
15:21:30 349  	  AND rf.ID = u.CC_REQUEST_FILE_ID
15:21:30 350  	  AND u.CC_UPDATE_STATUS IN ('UPDATED', 'NO_UPDATE')
15:21:30 351  	  MINUS
15:21:30 352  	  SELECT rf.ID, rf.FILE_NAME
15:21:30 353  	  FROM CC_REQUEST_FILE rf, CC_UPDATE u
15:21:30 354  	  WHERE CC_REQUEST_FILE_STATUS in ('SENT', 'RESPONSE_DOWNLOADED', 'REPORT_DOWNLOADED', 'RESPONSE_COMPLETE')
15:21:30 355  	  AND rf.ID = u.CC_REQUEST_FILE_ID
15:21:30 356  	  AND u.CC_UPDATE_STATUS NOT IN ('UPDATED', 'NO_UPDATE');
15:21:30 357  	END COMPLETABLE_REQUESTS;
15:21:30 358  
15:21:30 359  	/****************************************************************************/
15:21:30 360  
15:21:30 361  	PROCEDURE COMPLETABLE_REQUESTS_W_FAILS (
15:21:30 362  	  in_max_hours_before_report IN  NUMBER,
15:21:30 363  	  out_request_files	     OUT SYS_REFCURSOR
15:21:30 364  	) AS
15:21:30 365  	BEGIN
15:21:30 366  	  OPEN out_request_files FOR
15:21:30 367  	  SELECT DISTINCT rf.ID, rf.FILE_NAME
15:21:30 368  	  FROM CC_REQUEST_FILE rf, CC_UPDATE u
15:21:30 369  	  WHERE CC_REQUEST_FILE_STATUS in ('SENT', 'RESPONSE_DOWNLOADED', 'REPORT_DOWNLOADED', 'RESPONSE_COMPLETE')
15:21:30 370  	  AND rf.ID = u.CC_REQUEST_FILE_ID
15:21:30 371  	  AND u.CC_UPDATE_STATUS  = 'REQUEST_FAILED'
15:21:30 372  	  AND u.UPDATE_DATE < SYSDATE - (in_max_hours_before_report / 24)
15:21:30 373  	  MINUS
15:21:30 374  	  SELECT rf.ID, rf.FILE_NAME
15:21:30 375  	  FROM CC_REQUEST_FILE rf, CC_UPDATE u
15:21:30 376  	  WHERE CC_REQUEST_FILE_STATUS in ('SENT', 'RESPONSE_DOWNLOADED', 'REPORT_DOWNLOADED', 'RESPONSE_COMPLETE')
15:21:30 377  	  AND rf.ID = u.CC_REQUEST_FILE_ID
15:21:30 378  	  AND u.UPDATE_DATE < SYSDATE - (in_max_hours_before_report / 24)
15:21:30 379  	  AND u.CC_UPDATE_STATUS NOT IN ('UPDATED', 'NO_UPDATE', 'REQUEST_FAILED');
15:21:30 380  	END COMPLETABLE_REQUESTS_W_FAILS;
15:21:30 381  
15:21:30 382  END PROCS_CUPY;
15:21:30 383  .
15:21:30 SQL> /

Package body created.

Elapsed: 00:00:00.24
15:21:30 SQL> 
15:21:30 SQL> CREATE OR REPLACE
15:21:30   2  PACKAGE BODY PROCS_ENTITLEMENT_V18 AS
15:21:30   3  
15:21:30   4  	PROCEDURE GET_ARCHIVE_ENTITLEMENT_URI(
15:21:30   5  	  in_subscription_id IN NUMBER,
15:21:30   6  	  out_uri OUT VARCHAR2)
15:21:30   7  	AS
15:21:30   8  	  SPROC_NAME	  CONSTANT VARCHAR2(30) := 'GET_ARCHIVE_ENTITLEMENT_URI';
15:21:30   9  	  UNKNOWN_ERROR   EXCEPTION;
15:21:30  10  	BEGIN
15:21:30  11  	  SELECT
15:21:30  12  	    POMD.VALUE INTO out_uri
15:21:30  13  	  FROM
15:21:30  14  	     OFFER_PRODUCT_OFFERING OPO,
15:21:30  15  	     PRODUCT_OFFERING PO,
15:21:30  16  	     OFFER_OFFER_CHAIN OOC,
15:21:30  17  	     SUBSCRIPTION S,
15:21:30  18  	     LICENSE LL,
15:21:30  19  	     PRODUCT_OFFERING_META_DATA POMD
15:21:30  20  	  WHERE
15:21:30  21  	     OPO.OFFER_ID = OOC.OFFER_ID AND
15:21:30  22  	     OOC.OFFER_CHAIN_ID = S.OFFER_CHAIN_ID AND
15:21:30  23  	     S.ID = in_subscription_id AND
15:21:30  24  	     PO.ID = OPO.PRODUCT_OFFERING_ID AND
15:21:30  25  	     PO.ID = POMD.PRODUCT_OFFERING_ID AND
15:21:30  26  	     PO.CAPABILITY_ID = 1 AND
15:21:30  27  	     S.ID = LL.SUBSCRIPTION_ID AND
15:21:30  28  	     SYSDATE BETWEEN LL.START_DATE AND LL.ENTITLEMENT_END_DATE AND
15:21:30  29  	     NAME = 'entitlement_uri' AND
15:21:30  30  	     rownum < 2;
15:21:30  31  	EXCEPTION
15:21:30  32  	  WHEN OTHERS THEN
15:21:30  33  	    PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30  34  	      SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30  35  	END GET_ARCHIVE_ENTITLEMENT_URI;
15:21:30  36  
15:21:30  37  	PROCEDURE GET_ALL_ENTITLEMENTS(
15:21:30  38  	  in_group_id	 IN  NUMBER,
15:21:30  39  	  out_result_set OUT SYS_REFCURSOR)
15:21:30  40  	AS
15:21:30  41  	  -- CONSTANTS
15:21:30  42  	  SPROC_NAME	  CONSTANT VARCHAR2(20) := 'GET_ALL_ENTITLEMENTS';
15:21:30  43  	  -- EXCEPTIONS
15:21:30  44  	  NOT_FOUND	  EXCEPTION;
15:21:30  45  	  UNKNOWN_ERROR   EXCEPTION;
15:21:30  46  	  -- VARIABLES
15:21:30  47  	  var_subs	  SYS_REFCURSOR;
15:21:30  48  	BEGIN
15:21:30  49  	  OPEN out_result_set FOR
15:21:30  50  
15:21:30  51  	SELECT
15:21:30  52  	  C.CODE NAME,
15:21:30  53  	  C.DESCRIPTION,
15:21:30  54  	  0 INHERITED,
15:21:30  55  	  C.SHAREABLE,
15:21:30  56  	  MAX(LIC.ENTITLEMENT_END_DATE) EXPIRES
15:21:30  57  	FROM
15:21:30  58  	  SUBSCRIPTION SB
15:21:30  59  	  INNER JOIN ACCOUNT AC ON AC.ID = SB.ACCOUNT_ID
15:21:30  60  	  INNER JOIN LICENSE LIC ON LIC.SUBSCRIPTION_ID = SB.ID
15:21:30  61  	  INNER JOIN OFFER_PRODUCT_OFFERING OPO ON OPO.OFFER_ID = LIC.OFFER_ID
15:21:30  62  	  INNER JOIN PRODUCT_OFFERING PO ON PO.ID = OPO.PRODUCT_OFFERING_ID
15:21:30  63  	  INNER JOIN CAPABILITY C ON PO.CAPABILITY_ID = C.ID
15:21:30  64  	WHERE
15:21:30  65  	  LIC.ENTITLEMENT_END_DATE >= TRUNC(SYSDATE)
15:21:30  66  	  AND LIC.START_DATE <= SYSDATE
15:21:30  67  	  AND AC.GROUP_ID = in_group_id
15:21:30  68  	GROUP BY
15:21:30  69  	  C.CODE, 0, C.SHAREABLE, C.DESCRIPTION
15:21:30  70  UNION ALL
15:21:30  71  	SELECT
15:21:30  72  	  C.CODE NAME,
15:21:30  73  	  C.DESCRIPTION,
15:21:30  74  	  1 INHERITED,
15:21:30  75  	  C.SHAREABLE,
15:21:30  76  	  MAX(LEAST(SS.END_DATE, LIC.ENTITLEMENT_END_DATE)) EXPIRES
15:21:30  77  	FROM
15:21:30  78  	  ACCOUNT BORROWER,
15:21:30  79  	  SUBSCRIPTION S,
15:21:30  80  	  LICENSE LIC,
15:21:30  81  	  OFFER_PRODUCT_OFFERING OPO,
15:21:30  82  	  PRODUCT_OFFERING PO,
15:21:30  83  	  CAPABILITY C,
15:21:30  84  	  GROUP_ACCOUNT GA,
15:21:30  85  	  SUBSCRIPTION_SHARE SS
15:21:30  86  	WHERE
15:21:30  87  	  BORROWER.GROUP_ID = in_group_id
15:21:30  88  	  AND LIC.SUBSCRIPTION_ID = S.ID
15:21:30  89  	  AND OPO.OFFER_ID = LIC.OFFER_ID
15:21:30  90  	  AND PO.ID = OPO.PRODUCT_OFFERING_ID
15:21:30  91  	  AND PO.CAPABILITY_ID = C.ID
15:21:30  92  	  AND GA.SUBSCRIPTION_ID = S.ID
15:21:30  93  	  AND SS.BORROWER_ACCOUNT_ID = BORROWER.ID
15:21:30  94  	  AND SS.GROUP_ACCOUNT_ID = GA.ID
15:21:30  95  	  AND SYSDATE BETWEEN SS.START_DATE AND SS.END_DATE
15:21:30  96  	  AND SYSDATE BETWEEN LIC.START_DATE AND LIC.ENTITLEMENT_END_DATE
15:21:30  97  	  AND C.SHAREABLE = 1
15:21:30  98  	GROUP BY
15:21:30  99  	  C.CODE, 0, C.SHAREABLE, C.DESCRIPTION;
15:21:30 100  
15:21:30 101  	EXCEPTION
15:21:30 102  	  WHEN OTHERS THEN
15:21:30 103  	    PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 104  	      SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 105  	END GET_ALL_ENTITLEMENTS;
15:21:30 106  
15:21:30 107  	PROCEDURE GET_ITUNES_ENTITLEMENTS(
15:21:30 108  	  in_product_id IN CORE_OWNER.ITUNES_RECEIPT.PRODUCT_ID%TYPE,
15:21:30 109  	  out_result_set OUT SYS_REFCURSOR)
15:21:30 110  	AS
15:21:30 111  	  -- CONSTANTS
15:21:30 112  	  SPROC_NAME	  CONSTANT VARCHAR2(25) := 'GET_ITUNES_ENTITLEMENTS';
15:21:30 113  	  -- EXCEPTIONS
15:21:30 114  	  NOT_FOUND	  EXCEPTION;
15:21:30 115  	  UNKNOWN_ERROR   EXCEPTION;
15:21:30 116  	  -- VARIABLES
15:21:30 117  	  var_subs	  SYS_REFCURSOR;
15:21:30 118  	BEGIN
15:21:30 119  	  OPEN out_result_set FOR
15:21:30 120  
15:21:30 121  	      SELECT
15:21:30 122  		c.code NAME,
15:21:30 123  		C.DESCRIPTION,
15:21:30 124  		0 INHERITED,
15:21:30 125  		C.SHAREABLE,
15:21:30 126  		sysdate as EXPIRES
15:21:30 127  	      FROM
15:21:30 128  		offer_offer_chain ooc,
15:21:30 129  		offer o,
15:21:30 130  		offer_product_offering opo,
15:21:30 131  		product_offering po,
15:21:30 132  		capability c
15:21:30 133  	      WHERE
15:21:30 134  		o.id = ooc.offer_id AND
15:21:30 135  		opo.offer_id = o.id AND
15:21:30 136  		po.id = opo.product_offering_id AND
15:21:30 137  		c.id = po.capability_id AND
15:21:30 138  		c.id !=0 AND
15:21:30 139  		ooc.offer_chain_id =
15:21:30 140  		(SELECT
15:21:30 141  		    ocmd.offer_chain_id
15:21:30 142  		  FROM
15:21:30 143  		      offer_chain_meta_data ocmd
15:21:30 144  		  WHERE
15:21:30 145  			      ocmd.name = 'ITUNES_PRODUCT_ID' AND
15:21:30 146  		      ocmd.value = in_product_id AND
15:21:30 147  		      rownum < 2
15:21:30 148  		)
15:21:30 149  	      ;
15:21:30 150  
15:21:30 151  	EXCEPTION
15:21:30 152  	  WHEN OTHERS THEN
15:21:30 153  	    PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 154  	      SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 155  	END GET_ITUNES_ENTITLEMENTS;
15:21:30 156  
15:21:30 157  END PROCS_ENTITLEMENT_V18;
15:21:30 158  .
15:21:30 SQL> /

Package body created.

Elapsed: 00:00:00.03
15:21:30 SQL> 
15:21:30 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_HISTORY_V18" AS
15:21:30   2  
15:21:30   3  PROCEDURE CREATE_ADDRESS_HISTORY(
15:21:30   4  	in_address_id		     IN NUMBER,
15:21:30   5  	in_system_activity_reason_id IN NUMBER
15:21:30   6  ) AS
15:21:30   7  SPROC_NAME CONSTANT VARCHAR2(22) := 'CREATE_ADDRESS_HISTORY';
15:21:30   8  -- VARIABLES
15:21:30   9  var_address1    ADDRESS.ADDRESS1%TYPE;
15:21:30  10  var_address2    ADDRESS.ADDRESS2%TYPE;
15:21:30  11  var_city	      ADDRESS.CITY%TYPE;
15:21:30  12  var_state       ADDRESS.STATE%TYPE;
15:21:30  13  var_postal_code ADDRESS.POSTAL_CODE%TYPE;
15:21:30  14  var_country     ADDRESS.COUNTRY%TYPE;
15:21:30  15  var_created_by  ADDRESS.CREATED_BY%TYPE;
15:21:30  16  var_create_date ADDRESS.CREATE_DATE%TYPE;
15:21:30  17  var_updated_by  ADDRESS.UPDATED_BY%TYPE;
15:21:30  18  var_update_date ADDRESS.UPDATE_DATE%TYPE;
15:21:30  19  -- EXCEPTIONS
15:21:30  20  BAD_ADDRESS_ID	     EXCEPTION;
15:21:30  21  CAN_NOT_CREATE_HISTORY EXCEPTION;
15:21:30  22  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:30  23  BEGIN
15:21:30  24  
15:21:30  25  	BEGIN
15:21:30  26  	  SELECT
15:21:30  27  	    ADDRESS.ADDRESS1,
15:21:30  28  	    ADDRESS.ADDRESS2,
15:21:30  29  	    ADDRESS.CITY,
15:21:30  30  	    ADDRESS.STATE,
15:21:30  31  	    ADDRESS.POSTAL_CODE,
15:21:30  32  	    ADDRESS.COUNTRY,
15:21:30  33  	    ADDRESS.CREATED_BY,
15:21:30  34  	    ADDRESS.CREATE_DATE,
15:21:30  35  	    ADDRESS.UPDATED_BY,
15:21:30  36  	    ADDRESS.UPDATE_DATE
15:21:30  37  	    into
15:21:30  38  	    var_address1,
15:21:30  39  	    var_address2,
15:21:30  40  	    var_city,
15:21:30  41  	    var_state,
15:21:30  42  	    var_postal_code,
15:21:30  43  	    var_country,
15:21:30  44  	    var_created_by,
15:21:30  45  	    var_create_date,
15:21:30  46  	    var_updated_by,
15:21:30  47  	    var_update_date
15:21:30  48  	  FROM
15:21:30  49  	    ADDRESS
15:21:30  50  	  WHERE
15:21:30  51  	    ADDRESS.ID = in_address_id;
15:21:30  52  	  EXCEPTION
15:21:30  53  	    WHEN NO_DATA_FOUND THEN
15:21:30  54  	      RAISE BAD_ADDRESS_ID;
15:21:30  55  	END;
15:21:30  56  
15:21:30  57  	BEGIN
15:21:30  58  	  CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V18.CREATE_ADDRESS_HISTORY(
15:21:30  59  	    in_address_id,
15:21:30  60  	    in_system_activity_reason_id,
15:21:30  61  	    var_address1,
15:21:30  62  	    var_address2,
15:21:30  63  	    var_city,
15:21:30  64  	    var_state,
15:21:30  65  	    var_postal_code,
15:21:30  66  	    var_country,
15:21:30  67  	    var_created_by,
15:21:30  68  	    var_create_date,
15:21:30  69  	    var_updated_by,
15:21:30  70  	    var_update_date
15:21:30  71  	  );
15:21:30  72  	  EXCEPTION
15:21:30  73  	    WHEN OTHERS THEN
15:21:30  74  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:30  75  	      RAISE CAN_NOT_CREATE_HISTORY;
15:21:30  76  	END;
15:21:30  77  
15:21:30  78  EXCEPTION
15:21:30  79  WHEN BAD_ADDRESS_ID THEN
15:21:30  80  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30  81  	  SPROC_NAME, 'Bad recipientAddress id');
15:21:30  82  WHEN CAN_NOT_CREATE_HISTORY THEN
15:21:30  83  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:30  84  	  SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
15:21:30  85  WHEN OTHERS THEN
15:21:30  86  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30  87  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30  88  END CREATE_ADDRESS_HISTORY;
15:21:30  89  
15:21:30  90  /********************************************************************/
15:21:30  91  
15:21:30  92  PROCEDURE CREATE_ACCOUNT_HISTORY(
15:21:30  93  	in_account_id		     IN NUMBER,
15:21:30  94  	in_system_activity_reason_id IN NUMBER
15:21:30  95  ) AS
15:21:30  96  SPROC_NAME CONSTANT VARCHAR2(22) := 'CREATE_ACCOUNT_HISTORY';
15:21:30  97  -- VARIABLES
15:21:30  98  var_account_status_id  NUMBER;
15:21:30  99  var_suspend_date	     DATE;
15:21:30 100  var_group_id	     NUMBER;
15:21:30 101  var_instrument_type_id NUMBER;
15:21:30 102  var_instrument_id      NUMBER;
15:21:30 103  var_updated_by	     VARCHAR2(255);
15:21:30 104  var_update_date	     DATE;
15:21:30 105  -- EXCEPTIONS
15:21:30 106  BAD_ACCOUNT_ID	     EXCEPTION;
15:21:30 107  CAN_NOT_CREATE_HISTORY EXCEPTION;
15:21:30 108  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:30 109  BEGIN
15:21:30 110  
15:21:30 111  	BEGIN
15:21:30 112  	  SELECT
15:21:30 113  	    ACCOUNT.ACCOUNT_STATUS_ID,
15:21:30 114  	    ACCOUNT.GROUP_ID,
15:21:30 115  	    ACCOUNT.INSTRUMENT_TYPE_ID,
15:21:30 116  	    ACCOUNT.INSTRUMENT_ID,
15:21:30 117  	    ACCOUNT.UPDATED_BY,
15:21:30 118  	    ACCOUNT.UPDATE_DATE
15:21:30 119  	    into
15:21:30 120  	    var_account_status_id,
15:21:30 121  	    var_group_id,
15:21:30 122  	    var_instrument_type_id,
15:21:30 123  	    var_instrument_id,
15:21:30 124  	    var_updated_by,
15:21:30 125  	    var_update_date
15:21:30 126  	  FROM
15:21:30 127  	    ACCOUNT
15:21:30 128  	  WHERE
15:21:30 129  	    ACCOUNT.ID = in_account_id;
15:21:30 130  	  EXCEPTION
15:21:30 131  	    WHEN NO_DATA_FOUND THEN
15:21:30 132  	      RAISE BAD_ACCOUNT_ID;
15:21:30 133  	END;
15:21:30 134  
15:21:30 135  	BEGIN
15:21:30 136  	  CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V18.CREATE_ACCOUNT_HISTORY(
15:21:30 137  	    in_account_id,
15:21:30 138  	    var_suspend_date,
15:21:30 139  	    var_group_id,
15:21:30 140  	    var_updated_by,
15:21:30 141  	    var_update_date,
15:21:30 142  	    in_system_activity_reason_id,
15:21:30 143  	    var_account_status_id,
15:21:30 144  	    var_instrument_type_id,
15:21:30 145  	    var_instrument_id
15:21:30 146  	  );
15:21:30 147  	  EXCEPTION
15:21:30 148  	    WHEN OTHERS THEN
15:21:30 149  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:30 150  	      RAISE CAN_NOT_CREATE_HISTORY;
15:21:30 151  	END;
15:21:30 152  
15:21:30 153  EXCEPTION
15:21:30 154  WHEN BAD_ACCOUNT_ID THEN
15:21:30 155  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 156  	  SPROC_NAME, 'Bad account id');
15:21:30 157  WHEN CAN_NOT_CREATE_HISTORY THEN
15:21:30 158  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:30 159  	  SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
15:21:30 160  WHEN OTHERS THEN
15:21:30 161  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 162  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 163  END CREATE_ACCOUNT_HISTORY;
15:21:30 164  
15:21:30 165  /********************************************************************/
15:21:30 166  
15:21:30 167  PROCEDURE CREATE_SUBSCRIPTION_HISTORY (
15:21:30 168  /*
15:21:30 169  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30 170  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 171  */
15:21:30 172  	in_subscription_id	     IN NUMBER,
15:21:30 173  	in_system_activity_reason_id IN NUMBER
15:21:30 174  ) AS
15:21:30 175  SPROC_NAME CONSTANT VARCHAR2(27) := 'CREATE_SUBSCRIPTION_HISTORY';
15:21:30 176  -- VARIABLES
15:21:30 177  var_account_id		    NUMBER;
15:21:30 178  var_purchase_date 	    DATE;
15:21:30 179  var_offer_chain_id	    NUMBER;
15:21:30 180  var_suspend_date		    DATE;
15:21:30 181  var_termination_date	    DATE;
15:21:30 182  var_days_ramaining_adjustment NUMBER;
15:21:30 183  var_sct_id		    NUMBER;
15:21:30 184  var_updated_by		    VARCHAR2(255);
15:21:30 185  var_update_date		    DATE;
15:21:30 186  -- EXCEPTIONS
15:21:30 187  BAD_SUBSCRIPTION_ID    EXCEPTION;
15:21:30 188  CAN_NOT_CREATE_HISTORY EXCEPTION;
15:21:30 189  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:30 190  BEGIN
15:21:30 191  
15:21:30 192  	BEGIN
15:21:30 193  	  SELECT
15:21:30 194  	    SUBSCRIPTION.account_id,
15:21:30 195  	    SUBSCRIPTION.PURCHASE_DATE,
15:21:30 196  	    SUBSCRIPTION.OFFER_CHAIN_ID,
15:21:30 197  	    SUBSCRIPTION.SUSPEND_DATE,
15:21:30 198  	    SUBSCRIPTION.TERMINATION_DATE,
15:21:30 199  	    SUBSCRIPTION.DAYS_REMAINING_ADJUSTMENT,
15:21:30 200  	    SUBSCRIPTION.SCT_ID,
15:21:30 201  	    SUBSCRIPTION.UPDATED_BY,
15:21:30 202  	    SUBSCRIPTION.UPDATE_DATE
15:21:30 203  	    into
15:21:30 204  	    var_account_id,
15:21:30 205  	    var_purchase_date,
15:21:30 206  	    var_offer_chain_id,
15:21:30 207  	    var_suspend_date,
15:21:30 208  	    var_termination_date,
15:21:30 209  	    var_days_ramaining_adjustment,
15:21:30 210  	    var_sct_id,
15:21:30 211  	    var_updated_by,
15:21:30 212  	    var_update_date
15:21:30 213  	  FROM
15:21:30 214  	    SUBSCRIPTION
15:21:30 215  	  WHERE
15:21:30 216  	    SUBSCRIPTION.ID = in_subscription_id;
15:21:30 217  	  EXCEPTION
15:21:30 218  	    WHEN NO_DATA_FOUND THEN
15:21:30 219  	      RAISE BAD_SUBSCRIPTION_ID;
15:21:30 220  	END;
15:21:30 221  
15:21:30 222  	BEGIN
15:21:30 223  	  CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V18.CREATE_SUBSCRIPTION_HISTORY(
15:21:30 224  	    in_subscription_id,
15:21:30 225  	    var_account_id,
15:21:30 226  	    var_purchase_date,
15:21:30 227  	    var_offer_chain_id,
15:21:30 228  	    var_suspend_date,
15:21:30 229  	    var_termination_date,
15:21:30 230  	    var_days_ramaining_adjustment,
15:21:30 231  	    var_sct_id,
15:21:30 232  	    var_updated_by,
15:21:30 233  	    var_update_date,
15:21:30 234  	    in_system_activity_reason_id
15:21:30 235  	  );
15:21:30 236  	  EXCEPTION
15:21:30 237  	    WHEN OTHERS THEN
15:21:30 238  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:30 239  	      RAISE CAN_NOT_CREATE_HISTORY;
15:21:30 240  	END;
15:21:30 241  
15:21:30 242  EXCEPTION
15:21:30 243  WHEN BAD_SUBSCRIPTION_ID THEN
15:21:30 244  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 245  	  SPROC_NAME, 'No such subscription');
15:21:30 246  WHEN CAN_NOT_CREATE_HISTORY THEN
15:21:30 247  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:30 248  	  SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
15:21:30 249  WHEN OTHERS THEN
15:21:30 250  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 251  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 252  END CREATE_SUBSCRIPTION_HISTORY;
15:21:30 253  
15:21:30 254  /********************************************************************/
15:21:30 255  
15:21:30 256  PROCEDURE CREATE_CREDIT_CARD_HISTORY(
15:21:30 257  	in_credit_card_id	      IN NUMBER,
15:21:30 258  	in_system_activity_reason_id  IN NUMBER
15:21:30 259  ) AS
15:21:30 260  SPROC_NAME CONSTANT VARCHAR2(26) := 'CREATE_CREDIT_CARD_HISTORY';
15:21:30 261  -- VARIABLES
15:21:30 262  var_account_id		     NUMBER;
15:21:30 263  var_instrument_name	     VARCHAR2(255);
15:21:30 264  var_private_card_holder_name   VARCHAR2(256);
15:21:30 265  var_private_street_address     VARCHAR2(256);
15:21:30 266  var_private_street_address2    VARCHAR2(256);
15:21:30 267  var_state 		     VARCHAR2(50);
15:21:30 268  var_city			     VARCHAR2(50);
15:21:30 269  var_postal_code		     VARCHAR2(20);
15:21:30 270  var_country		     CHAR(2);
15:21:30 271  var_last_four_cc		     VARCHAR2(4);
15:21:30 272  var_expiration_date	     DATE;
15:21:30 273  var_credit_card_type_id	     NUMBER;
15:21:30 274  var_secret_token		     VARCHAR2(255);
15:21:30 275  var_chase_profile_id	     VARCHAR2(255);
15:21:30 276  var_credit_card_status_id      NUMBER;
15:21:30 277  var_updated_by		     VARCHAR2(255);
15:21:30 278  var_update_date		     DATE;
15:21:30 279  -- EXCEPTIONS
15:21:30 280  BAD_CREDIT_CARD_ID     EXCEPTION;
15:21:30 281  CAN_NOT_CREATE_HISTORY EXCEPTION;
15:21:30 282  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:30 283  BEGIN
15:21:30 284  
15:21:30 285  	BEGIN
15:21:30 286  	  SELECT
15:21:30 287  	    ACCOUNT_ID,
15:21:30 288  	    INSTRUMENT_NAME,
15:21:30 289  	    PRIVATE_CARD_HOLDER_NAME,
15:21:30 290  	    PRIVATE_STREET_ADDRESS,
15:21:30 291  	    PRIVATE_STREET_ADDRESS2,
15:21:30 292  	    STATE,
15:21:30 293  	    CITY,
15:21:30 294  	    POSTAL_CODE,
15:21:30 295  	    COUNTRY,
15:21:30 296  	    LAST_FOUR_CC,
15:21:30 297  	    EXPIRATION_DATE,
15:21:30 298  	    CREDIT_CARD_TYPE_ID,
15:21:30 299  	    SECRET_TOKEN,
15:21:30 300  	    CHASE_PROFILE_ID,
15:21:30 301  	    CREDIT_CARD_STATUS_ID,
15:21:30 302  	    UPDATED_BY,
15:21:30 303  	    UPDATE_DATE
15:21:30 304  	    into
15:21:30 305  	    var_account_id,
15:21:30 306  	    var_instrument_name,
15:21:30 307  	    var_private_card_holder_name,
15:21:30 308  	    var_private_street_address,
15:21:30 309  	    var_private_street_address2,
15:21:30 310  	    var_state,
15:21:30 311  	    var_city,
15:21:30 312  	    var_postal_code,
15:21:30 313  	    var_country,
15:21:30 314  	    var_last_four_cc,
15:21:30 315  	    var_expiration_date,
15:21:30 316  	    var_credit_card_type_id,
15:21:30 317  	    var_secret_token,
15:21:30 318  	    var_chase_profile_id,
15:21:30 319  	    var_credit_card_status_id,
15:21:30 320  	    var_updated_by,
15:21:30 321  	    var_update_date
15:21:30 322  	  FROM
15:21:30 323  	    CREDIT_CARD
15:21:30 324  	  WHERE
15:21:30 325  	    CREDIT_CARD.ID = in_credit_card_id;
15:21:30 326  	  EXCEPTION
15:21:30 327  	    WHEN NO_DATA_FOUND THEN
15:21:30 328  	      RAISE BAD_CREDIT_CARD_ID;
15:21:30 329  	END;
15:21:30 330  
15:21:30 331  	BEGIN
15:21:30 332  	  CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V18.CREATE_CREDIT_CARD_HISTORY(
15:21:30 333  	    in_credit_card_id,
15:21:30 334  	    var_account_id,
15:21:30 335  	    var_instrument_name,
15:21:30 336  	    var_private_card_holder_name,
15:21:30 337  	    var_private_street_address,
15:21:30 338  	    var_private_street_address2,
15:21:30 339  	    var_state,
15:21:30 340  	    var_city,
15:21:30 341  	    var_postal_code,
15:21:30 342  	    var_country,
15:21:30 343  	    var_last_four_cc,
15:21:30 344  	    var_expiration_date,
15:21:30 345  	    var_credit_card_type_id,
15:21:30 346  	    var_secret_token,
15:21:30 347  	    var_chase_profile_id,
15:21:30 348  	    var_credit_card_status_id,
15:21:30 349  	    var_updated_by,
15:21:30 350  	    var_update_date,
15:21:30 351  	    in_system_activity_reason_id
15:21:30 352  	  );
15:21:30 353  	  EXCEPTION
15:21:30 354  	    WHEN OTHERS THEN
15:21:30 355  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:30 356  	      RAISE CAN_NOT_CREATE_HISTORY;
15:21:30 357  	END;
15:21:30 358  
15:21:30 359  EXCEPTION
15:21:30 360  WHEN BAD_CREDIT_CARD_ID THEN
15:21:30 361  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 362  	  SPROC_NAME, 'No such credit card');
15:21:30 363  WHEN CAN_NOT_CREATE_HISTORY THEN
15:21:30 364  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:30 365  	  SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
15:21:30 366  WHEN OTHERS THEN
15:21:30 367  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 368  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 369  END CREATE_CREDIT_CARD_HISTORY;
15:21:30 370  
15:21:30 371  /********************************************************************/
15:21:30 372  
15:21:30 373  PROCEDURE CREATE_PAYPAL_HISTORY(
15:21:30 374  /*
15:21:30 375  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30 376  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 377  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:30 378  */
15:21:30 379  	in_paypal_id		      IN NUMBER,
15:21:30 380  	in_system_activity_reason_id  IN NUMBER
15:21:30 381  ) AS
15:21:30 382  SPROC_NAME CONSTANT VARCHAR(21) := 'CREATE_PAYPAL_HISTORY';
15:21:30 383  -- VARIABLES
15:21:30 384  var_account_id		   PAYPAL.ACCOUNT_ID%TYPE;
15:21:30 385  var_instrument_name	   PAYPAL.INSTRUMENT_NAME%TYPE DEFAULT NULL;
15:21:30 386  var_private_email_address    PAYPAL.PRIVATE_EMAIL_ADDRESS%TYPE DEFAULT NULL;
15:21:30 387  var_created_by		   PAYPAL.CREATED_BY%TYPE;
15:21:30 388  var_paypal_status_id	   PAYPAL.PAYPAL_STATUS_ID%TYPE;
15:21:30 389  var_paypal_prvt_street_addr  PAYPAL.PRIVATE_STREET_ADDRESS%TYPE;
15:21:30 390  var_paypal_prvt_street_addr2 PAYPAL.PRIVATE_STREET_ADDRESS2%TYPE;
15:21:30 391  var_state 		   PAYPAL.STATE%TYPE;
15:21:30 392  var_city			   PAYPAL.CITY%TYPE;
15:21:30 393  var_postal_code		   PAYPAL.POSTAL_CODE%TYPE;
15:21:30 394  var_country		   PAYPAL.COUNTRY%TYPE;
15:21:30 395  var_expiration_date	   PAYPAL.EXPIRATION_DATE%TYPE;
15:21:30 396  var_update_date		   PAYPAL.UPDATE_DATE%TYPE;
15:21:30 397  var_updated_by		   PAYPAL.UPDATED_BY%TYPE;
15:21:30 398  var_secret_token		   PAYPAL.SECRET_TOKEN%TYPE;
15:21:30 399  -- EXCEPTION
15:21:30 400  BAD_PAYPAL_ID	  EXCEPTION;
15:21:30 401  CAN_NOT_ADD_HISTORY EXCEPTION;
15:21:30 402  EXCEPTION_MESSAGE   VARCHAR2(1024);
15:21:30 403  BEGIN
15:21:30 404  
15:21:30 405  	BEGIN
15:21:30 406  	  SELECT
15:21:30 407  	    ACCOUNT_ID,
15:21:30 408  	    INSTRUMENT_NAME,
15:21:30 409  	    PRIVATE_EMAIL_ADDRESS,
15:21:30 410  	    UPDATE_DATE,
15:21:30 411  	    UPDATED_BY,
15:21:30 412  	    PAYPAL_STATUS_ID,
15:21:30 413  	    PRIVATE_STREET_ADDRESS,
15:21:30 414  	    PRIVATE_STREET_ADDRESS2,
15:21:30 415  	    STATE,
15:21:30 416  	    CITY,
15:21:30 417  	    POSTAL_CODE,
15:21:30 418  	    COUNTRY,
15:21:30 419  	    EXPIRATION_DATE,
15:21:30 420  	    SECRET_TOKEN
15:21:30 421  	  INTO
15:21:30 422  	    var_account_id,
15:21:30 423  	    var_instrument_name,
15:21:30 424  	    var_private_email_address,
15:21:30 425  	    var_update_date,
15:21:30 426  	    var_updated_by,
15:21:30 427  	    var_paypal_status_id,
15:21:30 428  	    var_paypal_prvt_street_addr,
15:21:30 429  	    var_paypal_prvt_street_addr2,
15:21:30 430  	    var_state,
15:21:30 431  	    var_city,
15:21:30 432  	    var_postal_code,
15:21:30 433  	    var_country,
15:21:30 434  	    var_expiration_date,
15:21:30 435  	    var_secret_token
15:21:30 436  	  FROM
15:21:30 437  	    PAYPAL
15:21:30 438  	  WHERE
15:21:30 439  	    ID = in_paypal_id;
15:21:30 440  	  EXCEPTION
15:21:30 441  	    WHEN NO_DATA_FOUND THEN
15:21:30 442  	      RAISE BAD_PAYPAL_ID;
15:21:30 443  	END;
15:21:30 444  
15:21:30 445  	BEGIN
15:21:30 446  	  CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V18.CREATE_PAYPAL_HISTORY(
15:21:30 447  	    in_paypal_id,
15:21:30 448  	    var_account_id,
15:21:30 449  	    var_instrument_name,
15:21:30 450  	    var_private_email_address,
15:21:30 451  	    var_updated_by,
15:21:30 452  	    var_update_date,
15:21:30 453  	    var_paypal_status_id,
15:21:30 454  	    var_paypal_prvt_street_addr,
15:21:30 455  	    var_paypal_prvt_street_addr2,
15:21:30 456  	    var_state,
15:21:30 457  	    var_city,
15:21:30 458  	    var_postal_code,
15:21:30 459  	    var_country,
15:21:30 460  	    var_expiration_date,
15:21:30 461  	    in_system_activity_reason_id,
15:21:30 462  	    var_secret_token
15:21:30 463  	  );
15:21:30 464  	  EXCEPTION
15:21:30 465  	    WHEN OTHERS THEN
15:21:30 466  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:30 467  	      RAISE CAN_NOT_ADD_HISTORY;
15:21:30 468  	END;
15:21:30 469  
15:21:30 470  EXCEPTION
15:21:30 471  WHEN BAD_PAYPAL_ID THEN
15:21:30 472  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 473  	  SPROC_NAME, 'No such paypal');
15:21:30 474  WHEN CAN_NOT_ADD_HISTORY THEN
15:21:30 475  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:30 476  	  SPROC_NAME, 'Could not add history', EXCEPTION_MESSAGE);
15:21:30 477  WHEN OTHERS THEN
15:21:30 478  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 479  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 480  END CREATE_PAYPAL_HISTORY;
15:21:30 481  
15:21:30 482  /********************************************************************/
15:21:30 483  
15:21:30 484  PROCEDURE CREATE_GIFT_CERT_HISTORY(
15:21:30 485  	in_gift_certificate_id	      IN NUMBER,
15:21:30 486  	in_system_activity_reason_id  IN NUMBER
15:21:30 487  ) AS
15:21:30 488  SPROC_NAME CONSTANT VARCHAR2(24) := 'CREATE_GIFT_CERT_HISTORY';
15:21:30 489  -- VARIABLES
15:21:30 490  var_purchaser_group_id	     NUMBER;
15:21:30 491  var_purchase_invoice_id	     NUMBER;
15:21:30 492  var_offer_chain_id	     NUMBER;
15:21:30 493  var_expiration_date	     DATE;
15:21:30 494  var_purchase_date 	     DATE;
15:21:30 495  var_gift_certificate_status_id NUMBER;
15:21:30 496  var_code			     VARCHAR2(255);
15:21:30 497  var_recipient_name	     VARCHAR2(255);
15:21:30 498  var_gift_message		     VARCHAR2(500);
15:21:30 499  var_recipient_email	     VARCHAR2(255);
15:21:30 500  var_finalized_invoice_id	     NUMBER;
15:21:30 501  var_sender_email		     VARCHAR2(50);
15:21:30 502  var_sender_name		     VARCHAR2(50);
15:21:30 503  var_redemption_date	     DATE;
15:21:30 504  var_redeemer_group_id	     NUMBER;
15:21:30 505  var_cancelation_date	     DATE;
15:21:30 506  var_updated_by		     VARCHAR2(255);
15:21:30 507  var_update_date		     DATE;
15:21:30 508  var_recipient_address_id	     NUMBER;
15:21:30 509  var_redeemer_address_id	     NUMBER;
15:21:30 510  var_recipient_notify_date      DATE;
15:21:30 511  -- EXCEPTIONS
15:21:30 512  BAD_GIFT_CERTIFICATE_ID EXCEPTION;
15:21:30 513  CAN_NOT_CREATE_HISTORY  EXCEPTION;
15:21:30 514  EXCEPTION_MESSAGE       VARCHAR2(1024);
15:21:30 515  BEGIN
15:21:30 516  
15:21:30 517  	BEGIN
15:21:30 518  	  SELECT
15:21:30 519  	    GIFT_CERTIFICATE.PURCHASER_GROUP_ID,
15:21:30 520  	    GIFT_CERTIFICATE.PURCHASE_INVOICE_ID,
15:21:30 521  	    GIFT_CERTIFICATE.OFFER_CHAIN_ID,
15:21:30 522  	    GIFT_CERTIFICATE.EXPIRATION_DATE,
15:21:30 523  	    GIFT_CERTIFICATE.PURCHASE_DATE,
15:21:30 524  	    GIFT_CERTIFICATE.GIFT_CERTIFICATE_STATUS_ID,
15:21:30 525  	    GIFT_CERTIFICATE.CODE,
15:21:30 526  	    GIFT_CERTIFICATE.RECIPIENT_NAME,
15:21:30 527  	    GIFT_CERTIFICATE.GIFT_MESSAGE,
15:21:30 528  	    GIFT_CERTIFICATE.RECIPIENT_EMAIL,
15:21:30 529  	    GIFT_CERTIFICATE.FINALIZED_INVOICE_ID,
15:21:30 530  	    GIFT_CERTIFICATE.SENDER_EMAIL,
15:21:30 531  	    GIFT_CERTIFICATE.SENDER_NAME,
15:21:30 532  	    GIFT_CERTIFICATE.REDEMPTION_DATE,
15:21:30 533  	    GIFT_CERTIFICATE.REDEEMER_GROUP_ID,
15:21:30 534  	    GIFT_CERTIFICATE.CANCELATION_DATE,
15:21:30 535  	    GIFT_CERTIFICATE.UPDATED_BY,
15:21:30 536  	    GIFT_CERTIFICATE.UPDATE_DATE,
15:21:30 537  	    GIFT_CERTIFICATE.RECIPIENT_ADDRESS_ID,
15:21:30 538  	    GIFT_CERTIFICATE.REDEEMER_ADDRESS_ID,
15:21:30 539  	    GIFT_CERTIFICATE.RECIPIENT_NOTIFY_DATE
15:21:30 540  	    into
15:21:30 541  	    var_purchaser_group_id,
15:21:30 542  	    var_purchase_invoice_id,
15:21:30 543  	    var_offer_chain_id,
15:21:30 544  	    var_expiration_date,
15:21:30 545  	    var_purchase_date,
15:21:30 546  	    var_gift_certificate_status_id,
15:21:30 547  	    var_code,
15:21:30 548  	    var_recipient_name,
15:21:30 549  	    var_gift_message,
15:21:30 550  	    var_recipient_email,
15:21:30 551  	    var_finalized_invoice_id,
15:21:30 552  	    var_sender_email,
15:21:30 553  	    var_sender_name,
15:21:30 554  	    var_redemption_date,
15:21:30 555  	    var_redeemer_group_id,
15:21:30 556  	    var_cancelation_date,
15:21:30 557  	    var_updated_by,
15:21:30 558  	    var_update_date,
15:21:30 559  	    var_recipient_address_id,
15:21:30 560  	    var_redeemer_address_id,
15:21:30 561  	    var_recipient_notify_date
15:21:30 562  	  FROM
15:21:30 563  	    GIFT_CERTIFICATE
15:21:30 564  	  WHERE
15:21:30 565  	    GIFT_CERTIFICATE.ID = in_gift_certificate_id;
15:21:30 566  	END;
15:21:30 567  
15:21:30 568  	BEGIN
15:21:30 569  	  CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V18.CREATE_GIFT_CERT_HISTORY(
15:21:30 570  	    in_gift_certificate_id,
15:21:30 571  	    var_purchaser_group_id,
15:21:30 572  	    var_purchase_invoice_id,
15:21:30 573  	    var_offer_chain_id,
15:21:30 574  	    var_expiration_date,
15:21:30 575  	    var_purchase_date,
15:21:30 576  	    var_gift_certificate_status_id,
15:21:30 577  	    var_code,
15:21:30 578  	    var_updated_by,
15:21:30 579  	    var_update_date,
15:21:30 580  	    in_system_activity_reason_id,
15:21:30 581  	    var_recipient_name,
15:21:30 582  	    var_gift_message,
15:21:30 583  	    var_recipient_email,
15:21:30 584  	    var_finalized_invoice_id,
15:21:30 585  	    var_sender_email,
15:21:30 586  	    var_sender_name,
15:21:30 587  	    var_redemption_date,
15:21:30 588  	    var_redeemer_group_id,
15:21:30 589  	    var_cancelation_date,
15:21:30 590  	    var_recipient_address_id,
15:21:30 591  	    var_redeemer_address_id,
15:21:30 592  	    var_recipient_notify_date
15:21:30 593  	  );
15:21:30 594  	  EXCEPTION
15:21:30 595  	    WHEN OTHERS THEN
15:21:30 596  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:30 597  	      RAISE CAN_NOT_CREATE_HISTORY;
15:21:30 598  	END;
15:21:30 599  
15:21:30 600  EXCEPTION
15:21:30 601  WHEN BAD_GIFT_CERTIFICATE_ID THEN
15:21:30 602  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 603  	  SPROC_NAME, 'No such gift certificate');
15:21:30 604  WHEN CAN_NOT_CREATE_HISTORY THEN
15:21:30 605  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:30 606  	  SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
15:21:30 607  WHEN OTHERS THEN
15:21:30 608  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 609  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 610  END CREATE_GIFT_CERT_HISTORY;
15:21:30 611  
15:21:30 612  /********************************************************************/
15:21:30 613  
15:21:30 614  PROCEDURE CREATE_TRANSACTION_HISTORY (
15:21:30 615  	in_transaction_id	     IN NUMBER,
15:21:30 616  	in_system_activity_reason_id IN NUMBER
15:21:30 617  ) AS
15:21:30 618  SPROC_NAME CONSTANT VARCHAR2(26) := 'CREATE_TRANSACTION_HISTORY';
15:21:30 619  -- VARIABLES
15:21:30 620  var_transaction_status_id  TRANSACTION.TRANSACTION_STATUS_ID%TYPE;
15:21:30 621  var_transaction_amount	 TRANSACTION.TRANSACTION_AMOUNT%TYPE;
15:21:30 622  var_updated_by		 TRANSACTION.UPDATED_BY%TYPE;
15:21:30 623  var_update_date		 TRANSACTION.UPDATE_DATE%TYPE;
15:21:30 624  var_order_id		 TRANSACTION.ORDER_ID%TYPE;
15:21:30 625  var_charge_id		 TRANSACTION.CHARGE_ID%TYPE;
15:21:30 626  var_is_refund		 TRANSACTION.IS_REFUND%TYPE;
15:21:30 627  var_is_settled		 TRANSACTION.IS_SETTLED%TYPE;
15:21:30 628  var_transaction_type_code  TRANSACTION.TRANSACTION_TYPE_CODE%TYPE;
15:21:30 629  -- EXCEPTIONS
15:21:30 630  BAD_TRANSACTION_ID     EXCEPTION;
15:21:30 631  CAN_NOT_CREATE_HISTORY EXCEPTION;
15:21:30 632  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:30 633  BEGIN
15:21:30 634  
15:21:30 635  	BEGIN
15:21:30 636  	  SELECT
15:21:30 637  	    TRANSACTION.TRANSACTION_STATUS_ID,
15:21:30 638  	    TRANSACTION.TRANSACTION_AMOUNT,
15:21:30 639  	    TRANSACTION.UPDATED_BY,
15:21:30 640  	    TRANSACTION.UPDATE_DATE,
15:21:30 641  	    TRANSACTION.ORDER_ID,
15:21:30 642  	    TRANSACTION.CHARGE_ID,
15:21:30 643  	    TRANSACTION.IS_REFUND,
15:21:30 644  	    TRANSACTION.IS_SETTLED,
15:21:30 645  	    TRANSACTION.TRANSACTION_TYPE_CODE
15:21:30 646  	    into
15:21:30 647  	    var_transaction_status_id,
15:21:30 648  	    var_transaction_amount,
15:21:30 649  	    var_updated_by,
15:21:30 650  	    var_update_date,
15:21:30 651  	    var_order_id,
15:21:30 652  	    var_charge_id,
15:21:30 653  	    var_is_refund,
15:21:30 654  	    var_is_settled,
15:21:30 655  	    var_transaction_type_code
15:21:30 656  	  FROM
15:21:30 657  	    TRANSACTION
15:21:30 658  	  WHERE
15:21:30 659  	    TRANSACTION.ID = in_transaction_id;
15:21:30 660  	  EXCEPTION
15:21:30 661  	    WHEN NO_DATA_FOUND THEN
15:21:30 662  	      RAISE BAD_TRANSACTION_ID;
15:21:30 663  	END;
15:21:30 664  
15:21:30 665  	BEGIN
15:21:30 666  	  CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V18.CREATE_TRANSACTION_HISTORY(
15:21:30 667  	    in_transaction_id,
15:21:30 668  	    var_transaction_status_id,
15:21:30 669  	    var_transaction_amount,
15:21:30 670  	    var_updated_by,
15:21:30 671  	    var_update_date,
15:21:30 672  	    var_order_id,
15:21:30 673  	    var_charge_id,
15:21:30 674  	    var_is_refund,
15:21:30 675  	    var_is_settled,
15:21:30 676  	    var_transaction_type_code,
15:21:30 677  	    in_system_activity_reason_id
15:21:30 678  	  );
15:21:30 679  	  EXCEPTION
15:21:30 680  	    WHEN OTHERS THEN
15:21:30 681  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:30 682  	      RAISE CAN_NOT_CREATE_HISTORY;
15:21:30 683  	END;
15:21:30 684  
15:21:30 685  EXCEPTION
15:21:30 686  WHEN BAD_TRANSACTION_ID THEN
15:21:30 687  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 688  	  SPROC_NAME, 'No such transaction');
15:21:30 689  WHEN CAN_NOT_CREATE_HISTORY THEN
15:21:30 690  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:30 691  	  SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
15:21:30 692  WHEN OTHERS THEN
15:21:30 693  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 694  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 695  END CREATE_TRANSACTION_HISTORY;
15:21:30 696  
15:21:30 697  /********************************************************************/
15:21:30 698  
15:21:30 699  PROCEDURE CREATE_INVOICE_HISTORY (
15:21:30 700  /*
15:21:30 701  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30 702  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 703  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:30 704  */
15:21:30 705  	in_invoice_id		     IN NUMBER,
15:21:30 706  	in_system_activity_reason_id IN NUMBER
15:21:30 707  ) AS
15:21:30 708  SPROC_NAME CONSTANT VARCHAR2(22) := 'CREATE_INVOICE_HISTORY';
15:21:30 709  -- VARIABLES
15:21:30 710  var_invoice_status_id NUMBER;
15:21:30 711  var_updated_by	    VARCHAR2(255);
15:21:30 712  var_update_date	    DATE;
15:21:30 713  -- EXCEPTIONS
15:21:30 714  BAD_INVOICE_ID	     EXCEPTION;
15:21:30 715  CAN_NOT_CREATE_HISTORY EXCEPTION;
15:21:30 716  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:30 717  BEGIN
15:21:30 718  
15:21:30 719  	BEGIN
15:21:30 720  	  SELECT
15:21:30 721  	    INVOICE.INVOICE_STATUS_ID,
15:21:30 722  	    INVOICE.UPDATED_BY,
15:21:30 723  	    INVOICE.UPDATE_DATE
15:21:30 724  	    into
15:21:30 725  	    var_invoice_status_id,
15:21:30 726  	    var_updated_by,
15:21:30 727  	    var_update_date
15:21:30 728  	  FROM
15:21:30 729  	    INVOICE
15:21:30 730  	  WHERE
15:21:30 731  	    INVOICE.ID = in_invoice_id;
15:21:30 732  	  EXCEPTION
15:21:30 733  	    WHEN NO_DATA_FOUND THEN
15:21:30 734  	      RAISE BAD_INVOICE_ID;
15:21:30 735  	END;
15:21:30 736  
15:21:30 737  	BEGIN
15:21:30 738  	  CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V18.CREATE_INVOICE_HISTORY(
15:21:30 739  	    in_invoice_id,
15:21:30 740  	    var_invoice_status_id,
15:21:30 741  	    var_updated_by,
15:21:30 742  	    var_update_date,
15:21:30 743  	    in_system_activity_reason_id
15:21:30 744  	  );
15:21:30 745  	  EXCEPTION
15:21:30 746  	    WHEN OTHERS THEN
15:21:30 747  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:30 748  	      RAISE CAN_NOT_CREATE_HISTORY;
15:21:30 749  	END;
15:21:30 750  
15:21:30 751  EXCEPTION
15:21:30 752  WHEN BAD_INVOICE_ID THEN
15:21:30 753  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 754  	  SPROC_NAME, 'No such invoice');
15:21:30 755  WHEN CAN_NOT_CREATE_HISTORY THEN
15:21:30 756  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:30 757  	  SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
15:21:30 758  WHEN OTHERS THEN
15:21:30 759  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 760  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 761  END CREATE_INVOICE_HISTORY;
15:21:30 762  
15:21:30 763  /********************************************************************/
15:21:30 764  
15:21:30 765  PROCEDURE CREATE_LICENSE_HISTORY (
15:21:30 766  /*
15:21:30 767  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30 768  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 769  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:30 770  */
15:21:30 771  	in_license_id		     IN NUMBER,
15:21:30 772  	in_system_activity_reason_id IN NUMBER
15:21:30 773  ) AS
15:21:30 774  SPROC_NAME CONSTANT VARCHAR2(22) := 'CREATE_LICENSE_HISTORY';
15:21:30 775  -- VARIABLES
15:21:30 776  var_license_status_id	    NUMBER;
15:21:30 777  var_needs_entitlements	    NUMBER;
15:21:30 778  var_start_date		    DATE;
15:21:30 779  var_offer_id		    NUMBER;
15:21:30 780  var_subscription_id	    NUMBER;
15:21:30 781  var_invoice_id		    NUMBER;
15:21:30 782  var_end_date		    DATE;
15:21:30 783  var_is_extension		    NUMBER;
15:21:30 784  var_current_offer_index	    NUMBER;
15:21:30 785  var_current_offer_recurr_num  NUMBER;
15:21:30 786  var_updated_by		    VARCHAR2(255);
15:21:30 787  var_update_date		    DATE;
15:21:30 788  var_entitlement_end_date	    DATE;
15:21:30 789  var_grace_start_date	    DATE;
15:21:30 790  var_grace_end_date	    DATE;
15:21:30 791  -- EXCEPTIONS
15:21:30 792  BAD_LICENSE_ID	     EXCEPTION;
15:21:30 793  CAN_NOT_CREATE_HISTORY EXCEPTION;
15:21:30 794  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:30 795  BEGIN
15:21:30 796  
15:21:30 797  	BEGIN
15:21:30 798  	  SELECT
15:21:30 799  	    LICENSE.LICENSE_STATUS_ID,
15:21:30 800  	    LICENSE.NEEDS_ENTITLEMENTS,
15:21:30 801  	    LICENSE.START_DATE,
15:21:30 802  	    LICENSE.OFFER_ID,
15:21:30 803  	    LICENSE.SUBSCRIPTION_ID,
15:21:30 804  	    LICENSE.INVOICE_ID,
15:21:30 805  	    LICENSE.END_DATE,
15:21:30 806  	    LICENSE.IS_EXTENSION,
15:21:30 807  	    LICENSE.CURRENT_OFFER_INDEX,
15:21:30 808  	    LICENSE.CURRENT_OFFER_RECURR_NUM,
15:21:30 809  	    LICENSE.UPDATED_BY,
15:21:30 810  	    LICENSE.UPDATE_DATE,
15:21:30 811  	    LICENSE.ENTITLEMENT_END_DATE,
15:21:30 812  	    LICENSE.GRACE_START_DATE,
15:21:30 813  	    LICENSE.GRACE_END_DATE
15:21:30 814  	    into
15:21:30 815  	    var_license_status_id,
15:21:30 816  	    var_needs_entitlements,
15:21:30 817  	    var_start_date,
15:21:30 818  	    var_offer_id,
15:21:30 819  	    var_subscription_id,
15:21:30 820  	    var_invoice_id,
15:21:30 821  	    var_end_date,
15:21:30 822  	    var_is_extension,
15:21:30 823  	    var_current_offer_index,
15:21:30 824  	    var_current_offer_recurr_num,
15:21:30 825  	    var_updated_by,
15:21:30 826  	    var_update_date,
15:21:30 827  	    var_entitlement_end_date,
15:21:30 828  	    var_grace_start_date,
15:21:30 829  	    var_grace_end_date
15:21:30 830  	  FROM
15:21:30 831  	    LICENSE
15:21:30 832  	  WHERE
15:21:30 833  	    LICENSE.ID = in_license_id;
15:21:30 834  	  EXCEPTION
15:21:30 835  	    WHEN NO_DATA_FOUND THEN
15:21:30 836  	      RAISE BAD_LICENSE_ID;
15:21:30 837  	END;
15:21:30 838  
15:21:30 839  	BEGIN
15:21:30 840  	  CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V18.CREATE_LICENSE_HISTORY(
15:21:30 841  	    in_license_id,
15:21:30 842  	    var_license_status_id,
15:21:30 843  	    var_needs_entitlements,
15:21:30 844  	    var_start_date,
15:21:30 845  	    var_offer_id,
15:21:30 846  	    var_subscription_id,
15:21:30 847  	    var_invoice_id,
15:21:30 848  	    var_end_date,
15:21:30 849  	    var_updated_by,
15:21:30 850  	    var_update_date,
15:21:30 851  	    var_is_extension,
15:21:30 852  	    var_current_offer_index,
15:21:30 853  	    var_current_offer_recurr_num,
15:21:30 854  	    in_system_activity_reason_id,
15:21:30 855  	    var_entitlement_end_date,
15:21:30 856  	    var_grace_start_date,
15:21:30 857  	    var_grace_end_date
15:21:30 858  	  );
15:21:30 859  	  EXCEPTION
15:21:30 860  	    WHEN OTHERS THEN
15:21:30 861  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:30 862  	      RAISE CAN_NOT_CREATE_HISTORY;
15:21:30 863  	END;
15:21:30 864  
15:21:30 865  EXCEPTION
15:21:30 866  WHEN BAD_LICENSE_ID THEN
15:21:30 867  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 868  	  SPROC_NAME, 'No such license');
15:21:30 869  WHEN CAN_NOT_CREATE_HISTORY THEN
15:21:30 870  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:30 871  	  SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
15:21:30 872  WHEN OTHERS THEN
15:21:30 873  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 874  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 875  END CREATE_LICENSE_HISTORY;
15:21:30 876  
15:21:30 877  /********************************************************************/
15:21:30 878  
15:21:30 879  PROCEDURE CREATE_CHARGE_HISTORY (
15:21:30 880  /*
15:21:30 881  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30 882  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 883  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:30 884  */
15:21:30 885  	in_charge_id		    IN NUMBER,
15:21:30 886  	in_system_activity_reason_id IN NUMBER
15:21:30 887  ) AS
15:21:30 888  SPROC_NAME CONSTANT VARCHAR2(21) := 'CREATE_CHARGE_HISTORY';
15:21:30 889  -- VARIABLES
15:21:30 890  var_invoice_id	     NUMBER;
15:21:30 891  var_transaction_id     NUMBER;
15:21:30 892  var_instrument_type_id NUMBER;
15:21:30 893  var_instrument_id      NUMBER;
15:21:30 894  var_charge_amount      NUMBER;
15:21:30 895  var_charge_status_id   NUMBER;
15:21:30 896  var_updated_by	     VARCHAR2(255);
15:21:30 897  var_update_date	     DATE;
15:21:30 898  -- EXCEPTIONS
15:21:30 899  BAD_CHARGE_ID	     EXCEPTION;
15:21:30 900  CAN_NOT_CREATE_HISTORY EXCEPTION;
15:21:30 901  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:30 902  BEGIN
15:21:30 903  
15:21:30 904  	BEGIN
15:21:30 905  	  SELECT
15:21:30 906  	    CHARGE.INVOICE_ID,
15:21:30 907  	    CHARGE.TRANSACTION_ID,
15:21:30 908  	    CHARGE.INSTRUMENT_TYPE_ID,
15:21:30 909  	    CHARGE.INSTRUMENT_ID,
15:21:30 910  	    CHARGE.CHARGE_AMOUNT,
15:21:30 911  	    CHARGE.CHARGE_STATUS_ID,
15:21:30 912  	    CHARGE.UPDATED_BY,
15:21:30 913  	    CHARGE.UPDATE_DATE
15:21:30 914  	    into
15:21:30 915  	    var_invoice_id,
15:21:30 916  	    var_transaction_id,
15:21:30 917  	    var_instrument_type_id,
15:21:30 918  	    var_instrument_id,
15:21:30 919  	    var_charge_amount,
15:21:30 920  	    var_charge_status_id,
15:21:30 921  	    var_updated_by,
15:21:30 922  	    var_update_date
15:21:30 923  	  FROM
15:21:30 924  	    CHARGE
15:21:30 925  	  WHERE
15:21:30 926  	    CHARGE.ID = in_charge_id;
15:21:30 927  	  EXCEPTION
15:21:30 928  	    WHEN NO_DATA_FOUND THEN
15:21:30 929  	      RAISE BAD_CHARGE_ID;
15:21:30 930  	END;
15:21:30 931  
15:21:30 932  	BEGIN
15:21:30 933  	  CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V18.CREATE_CHARGE_HISTORY (
15:21:30 934  	    in_charge_id,
15:21:30 935  	    var_invoice_id,
15:21:30 936  	    var_transaction_id,
15:21:30 937  	    var_instrument_type_id,
15:21:30 938  	    var_instrument_id,
15:21:30 939  	    var_charge_amount,
15:21:30 940  	    var_updated_by,
15:21:30 941  	    var_update_date,
15:21:30 942  	    var_charge_status_id,
15:21:30 943  	    in_system_activity_reason_id
15:21:30 944  	  );
15:21:30 945  	  EXCEPTION
15:21:30 946  	    WHEN OTHERS THEN
15:21:30 947  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:30 948  	      RAISE CAN_NOT_CREATE_HISTORY;
15:21:30 949  	END;
15:21:30 950  
15:21:30 951  EXCEPTION
15:21:30 952  WHEN BAD_CHARGE_ID THEN
15:21:30 953  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 954  	  SPROC_NAME, 'No such license');
15:21:30 955  WHEN CAN_NOT_CREATE_HISTORY THEN
15:21:30 956  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:30 957  	  SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
15:21:30 958  WHEN OTHERS THEN
15:21:30 959  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 960  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 961  END CREATE_CHARGE_HISTORY;
15:21:30 962  
15:21:30 963  PROCEDURE CREATE_INVOICE_ADJ_HISTORY (
15:21:30 964  /*
15:21:30 965  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30 966  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 967  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:30 968  */
15:21:30 969  	in_invoice_adjustment_id  IN NUMBER,
15:21:30 970  	in_system_activity_reason_id IN NUMBER
15:21:30 971  ) AS
15:21:30 972  SPROC_NAME CONSTANT VARCHAR(32) := 'CREATE_INVOICE_ADJ_HISTORY';
15:21:30 973  --VARIABLED
15:21:30 974  var_invoice_adj_id	  INVOICE_ADJUSTMENT.ID%TYPE;
15:21:30 975  var_invoice_id		  INVOICE_ADJUSTMENT.INVOICE_ID%TYPE;
15:21:30 976  var_is_credit		  INVOICE_ADJUSTMENT.IS_CREDIT%TYPE;
15:21:30 977  var_charge_id		  INVOICE_ADJUSTMENT.CHARGE_ID%TYPE;
15:21:30 978  var_adjustment_date	  INVOICE_ADJUSTMENT.ADJUSTMENT_DATE%TYPE;
15:21:30 979  var_create_date		  INVOICE_ADJUSTMENT.CREATE_DATE%TYPE;
15:21:30 980  var_created_by		  INVOICE_ADJUSTMENT.CREATED_BY%TYPE;
15:21:30 981  var_invoice_adj_reason_id INVOICE_ADJUSTMENT.INVOICE_ADJUSTMENT_REASON_ID%TYPE;
15:21:30 982  var_update_date		  INVOICE_ADJUSTMENT.UPDATE_DATE%TYPE;
15:21:30 983  var_updated_by		  INVOICE_ADJUSTMENT.UPDATED_BY%TYPE;
15:21:30 984  BAD_INVOICE_ADJ_ID	  EXCEPTION;
15:21:30 985  CAN_NOT_CREATE_HISTORY	  EXCEPTION;
15:21:30 986  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:30 987  BEGIN
15:21:30 988  
15:21:30 989  	BEGIN
15:21:30 990  	  SELECT
15:21:30 991  	    INVOICE_ADJUSTMENT.ID,
15:21:30 992  	    INVOICE_ADJUSTMENT.INVOICE_ID,
15:21:30 993  	    INVOICE_ADJUSTMENT.IS_CREDIT,
15:21:30 994  	    INVOICE_ADJUSTMENT.CHARGE_ID,
15:21:30 995  	    INVOICE_ADJUSTMENT.ADJUSTMENT_DATE,
15:21:30 996  	    INVOICE_ADJUSTMENT.CREATE_DATE,
15:21:30 997  	    INVOICE_ADJUSTMENT.CREATED_BY,
15:21:30 998  	    INVOICE_ADJUSTMENT.INVOICE_ADJUSTMENT_REASON_ID,
15:21:30 999  	    INVOICE_ADJUSTMENT.UPDATE_DATE,
15:21:30 1000  	     INVOICE_ADJUSTMENT.UPDATED_BY
15:21:30 1001  	     into
15:21:30 1002  	     var_invoice_adj_id,
15:21:30 1003  	     var_invoice_id,
15:21:30 1004  	     var_is_credit,
15:21:30 1005  	     var_charge_id,
15:21:30 1006  	     var_adjustment_date,
15:21:30 1007  	     var_create_date,
15:21:30 1008  	     var_created_by,
15:21:30 1009  	     var_invoice_adj_reason_id,
15:21:30 1010  	     var_update_date,
15:21:30 1011  	     var_updated_by
15:21:30 1012  	   FROM
15:21:30 1013  	     INVOICE_ADJUSTMENT
15:21:30 1014  	   WHERE
15:21:30 1015  	     INVOICE_ADJUSTMENT.ID = in_invoice_adjustment_id;
15:21:30 1016  	   EXCEPTION
15:21:30 1017  	     WHEN NO_DATA_FOUND THEN
15:21:30 1018  	       RAISE BAD_INVOICE_ADJ_ID;
15:21:30 1019  	 END;
15:21:30 1020  
15:21:30 1021  	 BEGIN
15:21:30 1022  	   CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V18.CREATE_INVOICE_ADJ_HISTORY (
15:21:30 1023  	     var_invoice_adj_id,
15:21:30 1024  	     var_invoice_id,
15:21:30 1025  	     var_is_credit,
15:21:30 1026  	     var_charge_id,
15:21:30 1027  	     var_adjustment_date,
15:21:30 1028  	     var_create_date,
15:21:30 1029  	     var_created_by,
15:21:30 1030  	     var_invoice_adj_reason_id,
15:21:30 1031  	     var_update_date,
15:21:30 1032  	     var_updated_by
15:21:30 1033  	   );
15:21:30 1034  	   EXCEPTION
15:21:30 1035  	     WHEN OTHERS THEN
15:21:30 1036  	       EXCEPTION_MESSAGE := SQLERRM;
15:21:30 1037  	       RAISE CAN_NOT_CREATE_HISTORY;
15:21:30 1038  	 END;
15:21:30 1039  
15:21:30 1040  EXCEPTION
15:21:30 1041  WHEN BAD_INVOICE_ADJ_ID THEN
15:21:30 1042  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 1043  	   SPROC_NAME, 'No such invoice adjustment');
15:21:30 1044  WHEN CAN_NOT_CREATE_HISTORY THEN
15:21:30 1045  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:30 1046  	   SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
15:21:30 1047  WHEN OTHERS THEN
15:21:30 1048  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 1049  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 1050  END CREATE_INVOICE_ADJ_HISTORY;
15:21:30 1051  
15:21:30 1052  END PROCS_HISTORY_V18;
15:21:30 1053  .
15:21:30 SQL> /

Package body created.

Elapsed: 00:00:00.08
15:21:30 SQL> 
15:21:30 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_ITUNES_RECEIPT_V18" AS
15:21:30   2  
15:21:30   3  PROCEDURE ITUNES_RECEIPT_SUBSCRIPTION (
15:21:30   4  /*
15:21:30   5  Throws exceptions:
15:21:30   6  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30   7  */
15:21:30   8  	in_original_transaction_id IN ITUNES_RECEIPT.ORIGINAL_TRANSACTION_ID%TYPE,
15:21:30   9  	out_result_set	    OUT SYS_REFCURSOR
15:21:30  10  ) AS
15:21:30  11  SPROC_NAME CONSTANT VARCHAR2(28) := 'ITUNES_RECEIPT_SUBSCRIPTION';
15:21:30  12  BEGIN
15:21:30  13  OPEN out_result_set FOR
15:21:30  14  	      SELECT
15:21:30  15  	      i.id as ITUNES_RECEIPT_ID,
15:21:30  16  	      s.id as SUBSCRIPTION_ID,
15:21:30  17  	      s.SUBSCRIPTION_STATUS_ID,
15:21:30  18  	      i.STATUS,
15:21:30  19  	      a.GROUP_ID
15:21:30  20  	      FROM ITUNES_RECEIPT i, SUBSCRIPTION s, ACCOUNT a
15:21:30  21  	      WHERE i.ORIGINAL_TRANSACTION_ID = in_original_transaction_id
15:21:30  22  	      AND s.ID(+) = i.SUBSCRIPTION_ID
15:21:30  23  	      AND a.ID(+) = s.ACCOUNT_ID;
15:21:30  24  END ITUNES_RECEIPT_SUBSCRIPTION;
15:21:30  25  
15:21:30  26  
15:21:30  27  PROCEDURE CREATE_RECEIPT(
15:21:30  28  /*
15:21:30  29  Throws exceptions:
15:21:30  30  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30  31  */
15:21:30  32  	  out_id      OUT NUMBER,
15:21:30  33  	  in_subscription_id  IN ITUNES_RECEIPT.SUBSCRIPTION_ID%TYPE,
15:21:30  34  	  in_receipt	      IN ITUNES_RECEIPT.RECEIPT%TYPE,
15:21:30  35  	  in_status	      IN ITUNES_RECEIPT.STATUS%TYPE,
15:21:30  36  	  in_quantity	      IN ITUNES_RECEIPT.QUANTITY%TYPE,
15:21:30  37  	  in_product_id       IN ITUNES_RECEIPT.PRODUCT_ID%TYPE,
15:21:30  38  	  in_transaction_id   IN ITUNES_RECEIPT.TRANSACTION_ID%TYPE,
15:21:30  39  	  in_purchase_date    IN ITUNES_RECEIPT.PURCHASE_DATE%TYPE,
15:21:30  40  	  in_original_transaction_id IN ITUNES_RECEIPT.ORIGINAL_TRANSACTION_ID%TYPE,
15:21:30  41  	  in_original_purchase_date IN ITUNES_RECEIPT.ORIGINAL_PURCHASE_DATE%TYPE,
15:21:30  42  	  in_app_item_id      IN ITUNES_RECEIPT.APP_ITEM_ID%TYPE,
15:21:30  43  	  in_version_external_id IN ITUNES_RECEIPT.VERSION_EXTERNAL_ID%TYPE,
15:21:30  44  	  in_bid	      IN ITUNES_RECEIPT.BID%TYPE,
15:21:30  45  	  in_bvrs	      IN ITUNES_RECEIPT.BVRS%TYPE,
15:21:30  46  	  in_expires_date     IN ITUNES_RECEIPT.EXPIRES_DATE%TYPE,
15:21:30  47  	  in_created_by       IN ITUNES_RECEIPT.CREATED_BY%TYPE
15:21:30  48  ) AS
15:21:30  49  -- VARIABLES
15:21:30  50  SPROC_NAME	 CONSTANT VARCHAR2(14) := 'CREATE_RECEIPT';
15:21:30  51  -- EXCEPTIONS
15:21:30  52  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:30  53  BEGIN
15:21:30  54  
15:21:30  55  	CORE_OWNER.PROCS_ITUNES_RECEIPT_CRU_V18.CREATE_RECEIPT(
15:21:30  56  	  out_id	      =>  out_id,
15:21:30  57  	  in_subscription_id  =>  in_subscription_id,
15:21:30  58  	  in_receipt	      =>  in_receipt,
15:21:30  59  	  in_status	      =>  in_status,
15:21:30  60  	  in_quantity	      =>  in_quantity,
15:21:30  61  	  in_product_id       =>  in_product_id,
15:21:30  62  	  in_transaction_id   =>  in_transaction_id,
15:21:30  63  	  in_purchase_date    =>  in_purchase_date,
15:21:30  64  	  in_original_transaction_id  =>  in_original_transaction_id,
15:21:30  65  	  in_original_purchase_date => in_original_purchase_date,
15:21:30  66  	  in_app_item_id      =>  in_app_item_id,
15:21:30  67  	  in_version_external_id  =>  in_version_external_id,
15:21:30  68  	  in_bid	      =>  in_bid,
15:21:30  69  	  in_bvrs	      =>  in_bvrs,
15:21:30  70  	  in_expires_date     =>  in_expires_date,
15:21:30  71  	  in_created_by       =>  in_created_by
15:21:30  72  	);
15:21:30  73  
15:21:30  74  END CREATE_RECEIPT;
15:21:30  75  
15:21:30  76  PROCEDURE UPDATE_RECEIPT(
15:21:30  77  /*
15:21:30  78  Throws exceptions:
15:21:30  79  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30  80  */
15:21:30  81  	  in_id 	      IN ITUNES_RECEIPT.ID%TYPE,
15:21:30  82  	  in_receipt	      IN ITUNES_RECEIPT.RECEIPT%TYPE,
15:21:30  83  	  in_status	      IN ITUNES_RECEIPT.STATUS%TYPE,
15:21:30  84  	  in_quantity	      IN ITUNES_RECEIPT.QUANTITY%TYPE,
15:21:30  85  	  in_product_id       IN ITUNES_RECEIPT.PRODUCT_ID%TYPE,
15:21:30  86  	  in_transaction_id   IN ITUNES_RECEIPT.TRANSACTION_ID%TYPE,
15:21:30  87  	  in_purchase_date    IN ITUNES_RECEIPT.PURCHASE_DATE%TYPE,
15:21:30  88  	  in_original_transaction_id IN ITUNES_RECEIPT.ORIGINAL_TRANSACTION_ID%TYPE,
15:21:30  89  	  in_original_purchase_date IN ITUNES_RECEIPT.ORIGINAL_PURCHASE_DATE%TYPE,
15:21:30  90  	  in_app_item_id      IN ITUNES_RECEIPT.APP_ITEM_ID%TYPE,
15:21:30  91  	  in_version_external_id IN ITUNES_RECEIPT.VERSION_EXTERNAL_ID%TYPE,
15:21:30  92  	  in_bid	      IN ITUNES_RECEIPT.BID%TYPE,
15:21:30  93  	  in_bvrs	      IN ITUNES_RECEIPT.BVRS%TYPE,
15:21:30  94  	  in_expires_date     IN ITUNES_RECEIPT.EXPIRES_DATE%TYPE,
15:21:30  95  	  in_updated_by       IN ITUNES_RECEIPT.UPDATED_BY%TYPE,
15:21:30  96  	  in_is_expired       IN NUMBER
15:21:30  97  ) AS
15:21:30  98  CANCEL_DATE DATE;
15:21:30  99  BEGIN
15:21:30 100  	-- see if cancel date is already set
15:21:30 101  	BEGIN
15:21:30 102  	  SELECT
15:21:30 103  	    IR.CANCEL_DATE INTO CANCEL_DATE
15:21:30 104  	  FROM
15:21:30 105  	    ITUNES_RECEIPT IR
15:21:30 106  	  WHERE
15:21:30 107  	    IR.ID = in_id;
15:21:30 108  	EXCEPTION
15:21:30 109  	  WHEN NO_DATA_FOUND THEN
15:21:30 110  	    CANCEL_DATE := NULL;
15:21:30 111  	END;
15:21:30 112  
15:21:30 113  	-- only update cancel date if it isn't already set and the receipt is expired
15:21:30 114  	IF in_is_expired = 1 THEN
15:21:30 115  	  IF CANCEL_DATE IS NULL THEN
15:21:30 116  	    CANCEL_DATE := SYSDATE;
15:21:30 117  	  END IF;
15:21:30 118  	ELSE
15:21:30 119  	  CANCEL_DATE := NULL;
15:21:30 120  	END IF;
15:21:30 121  
15:21:30 122  	CORE_OWNER.PROCS_ITUNES_RECEIPT_CRU_V18.UPDATE_RECEIPT(
15:21:30 123  	  in_id => in_id,
15:21:30 124  	  in_receipt => in_receipt,
15:21:30 125  	  in_status => in_status,
15:21:30 126  	  in_quantity => in_quantity,
15:21:30 127  	  in_product_id => in_product_id,
15:21:30 128  	  in_transaction_id => in_transaction_id,
15:21:30 129  	  in_purchase_date => in_purchase_date,
15:21:30 130  	  in_original_transaction_id => in_original_transaction_id,
15:21:30 131  	  in_original_purchase_date => in_original_purchase_date,
15:21:30 132  	  in_app_item_id => in_app_item_id,
15:21:30 133  	  in_version_external_id => in_version_external_id,
15:21:30 134  	  in_bid => in_bid,
15:21:30 135  	  in_bvrs => in_bvrs,
15:21:30 136  	  in_expires_date => in_expires_date,
15:21:30 137  	  in_updated_by => in_updated_by,
15:21:30 138  	  in_cancel_date => CANCEL_DATE
15:21:30 139  	);
15:21:30 140  END UPDATE_RECEIPT;
15:21:30 141  
15:21:30 142  PROCEDURE LINK_ITUNES_RECEIPT(
15:21:30 143  /*
15:21:30 144  Throws exceptions:
15:21:30 145  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 146  */
15:21:30 147  	  in_id 	      IN ITUNES_RECEIPT.ID%TYPE,
15:21:30 148  	  in_subscription_id  IN ITUNES_RECEIPT.SUBSCRIPTION_ID%TYPE,
15:21:30 149  	  in_updated_by       IN ITUNES_RECEIPT.UPDATED_BY%TYPE
15:21:30 150  ) AS
15:21:30 151  BEGIN
15:21:30 152  	      CORE_OWNER.PROCS_ITUNES_RECEIPT_CRU_V18.LINK_ITUNES_RECEIPT(
15:21:30 153  		      in_id => in_id,
15:21:30 154  		      in_subscription_id => in_subscription_id,
15:21:30 155  		      in_updated_by => in_updated_by
15:21:30 156  		      );
15:21:30 157  END LINK_ITUNES_RECEIPT;
15:21:30 158  
15:21:30 159  PROCEDURE MARK_RECEIPT_CHECKED(
15:21:30 160  /*
15:21:30 161  Throws exceptions:
15:21:30 162  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 163  */
15:21:30 164  	  in_id       IN ITUNES_RECEIPT.ID%TYPE
15:21:30 165  ) AS
15:21:30 166  BEGIN
15:21:30 167  	CORE_OWNER.PROCS_ITUNES_RECEIPT_CRU_V18.MARK_RECEIPT_CHECKED(
15:21:30 168  	  in_id => in_id
15:21:30 169  	);
15:21:30 170  END MARK_RECEIPT_CHECKED;
15:21:30 171  
15:21:30 172  PROCEDURE GET_ITUNES_RECEIPTS (
15:21:30 173  /*
15:21:30 174  Throws exceptions:
15:21:30 175  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 176  */
15:21:30 177  	out_result_set	    OUT SYS_REFCURSOR,
15:21:30 178  	in_row_number	    IN NUMBER DEFAULT 500
15:21:30 179  ) AS
15:21:30 180  SPROC_NAME CONSTANT VARCHAR2(26) := 'GET_ITUNES_RECEIPTS';
15:21:30 181  BEGIN
15:21:30 182  OPEN out_result_set FOR
15:21:30 183  SELECT * FROM
15:21:30 184  (
15:21:30 185  	SELECT * FROM
15:21:30 186  	(
15:21:30 187  	  SELECT
15:21:30 188  	    IR.ID,
15:21:30 189  	    IR.SUBSCRIPTION_ID,
15:21:30 190  	    IR.RECEIPT,
15:21:30 191  	    IR.STATUS,
15:21:30 192  	    IR.QUANTITY,
15:21:30 193  	    IR.PRODUCT_ID,
15:21:30 194  	    IR.TRANSACTION_ID,
15:21:30 195  	    IR.PURCHASE_DATE,
15:21:30 196  	    IR.ORIGINAL_TRANSACTION_ID,
15:21:30 197  	    IR.ORIGINAL_PURCHASE_DATE,
15:21:30 198  	    IR.APP_ITEM_ID,
15:21:30 199  	    IR.VERSION_EXTERNAL_ID,
15:21:30 200  	    IR.BID,
15:21:30 201  	    IR.BVRS,
15:21:30 202  	    IR.EXPIRES_DATE,
15:21:30 203  	    IR.CREATE_DATe,
15:21:30 204  	    IR.CREATED_BY,
15:21:30 205  	    IR.UPDATE_DATE,
15:21:30 206  	    IR.UPDATED_BY,
15:21:30 207  	    IR.LAST_CHECK_DATE,
15:21:30 208  	    OC.VENDOR_SOURCE_ID
15:21:30 209  	  FROM
15:21:30 210  	    CORE_OWNER.ITUNES_RECEIPT IR
15:21:30 211  	    LEFT JOIN CORE_OWNER.SUBSCRIPTION S ON IR.subscription_id = S.id
15:21:30 212  	    LEFT JOIN CORE_OWNER.OFFER_CHAIN OC ON S.offer_chain_id = OC.id
15:21:30 213  	  WHERE
15:21:30 214  	    NOT EXISTS
15:21:30 215  	    (
15:21:30 216  	      SELECT NULL
15:21:30 217  	      FROM PROCESS_RETRY_THROTTLE
15:21:30 218  	      WHERE PROCESS_NAME = SPROC_NAME
15:21:30 219  		AND GENERIC_ID = IR.ID
15:21:30 220  	    ) AND
15:21:30 221  	    (S.subscription_status_id in (GLOBAL_STATUSES_V18.SUBSCRIPTION_SUSPENDED, GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE) or (S.subscription_status_id is null and IR.status != 21006)) AND
15:21:30 222  	    ROWNUM <= in_row_number*10
15:21:30 223  	)
15:21:30 224  	ORDER BY dbms_random.value
15:21:30 225  )
15:21:30 226  WHERE
15:21:30 227  	ROWNUM <= in_row_number;
15:21:30 228  
15:21:30 229  END GET_ITUNES_RECEIPTS;
15:21:30 230  
15:21:30 231  PROCEDURE GET_VENDOR_FROM_ITUNES_PID(
15:21:30 232  /*
15:21:30 233  Throws exceptions:
15:21:30 234  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 235  */
15:21:30 236  	  out_vendor_source_id OUT OFFER_CHAIN.VENDOR_SOURCE_ID%TYPE,
15:21:30 237  	  in_itunes_pid        IN ITUNES_RECEIPT.PRODUCT_ID%TYPE
15:21:30 238  ) AS
15:21:30 239  BEGIN
15:21:30 240  
15:21:30 241  SELECT
15:21:30 242  	  oc.vendor_source_id
15:21:30 243  INTO
15:21:30 244  	  out_vendor_source_id
15:21:30 245  FROM
15:21:30 246  	  offer_chain_meta_data ocmd
15:21:30 247  JOIN
15:21:30 248  	  offer_chain oc
15:21:30 249  ON
15:21:30 250  	  ocmd.offer_chain_id = oc.id
15:21:30 251  WHERE
15:21:30 252  	  ocmd.name = 'ITUNES_PRODUCT_ID'
15:21:30 253  AND ocmd.value = in_itunes_pid
15:21:30 254  AND rownum <= 1;
15:21:30 255  
15:21:30 256  END GET_VENDOR_FROM_ITUNES_PID;
15:21:30 257  
15:21:30 258  END PROCS_ITUNES_RECEIPT_V18;
15:21:30 259  .
15:21:30 SQL> /

Package body created.

Elapsed: 00:00:00.07
15:21:30 SQL> 
15:21:30 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_LINE_ITEMS_V18" AS
15:21:30   2  
15:21:30   3  PROCEDURE ADD_LINE_ITEMS(
15:21:30   4  /*
15:21:30   5  Throws exceptions:
15:21:30   6  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30   7  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30   8  */
15:21:30   9  	in_invoice_id IN NUMBER,
15:21:30  10  	in_offer_id   IN NUMBER,
15:21:30  11  	in_created_by IN VARCHAR2
15:21:30  12  ) AS
15:21:30  13  -- VARIABLES
15:21:30  14  SPROC_NAME      CONSTANT VARCHAR2(14) := 'ADD_LINE_ITEMS';
15:21:30  15  temp_invoice_id NUMBER;
15:21:30  16  temp_offer_id   NUMBER;
15:21:30  17  
15:21:30  18  var_line_item_data SYS_REFCURSOR;
15:21:30  19  var_new_line_item_id NUMBER;
15:21:30  20  var_product_unit_price NUMBER (10,6);
15:21:30  21  var_product_offering_price NUMBER(10,6);
15:21:30  22  var_product_offering_oprice NUMBER(10,6);
15:21:30  23  var_product_quantity NUMBER;
15:21:30  24  var_product_offering_id NUMBER;
15:21:30  25  
15:21:30  26  var_line_item_price	  NUMBER(10,2);
15:21:30  27  var_discount_fixed_amount   NUMBER(10,6);
15:21:30  28  var_discount_percent_amount NUMBER(10,2);
15:21:30  29  
15:21:30  30  
15:21:30  31  -- EXCEPTIONS
15:21:30  32  BAD_INVOICE_ID EXCEPTION;
15:21:30  33  BAD_OFFER_ID EXCEPTION;
15:21:30  34  BAD_DISCOUNT EXCEPTION;
15:21:30  35  BEGIN
15:21:30  36  
15:21:30  37  	-- Check that given invoice exists
15:21:30  38  	BEGIN
15:21:30  39  	  SELECT
15:21:30  40  	    INVOICE.ID into temp_invoice_id
15:21:30  41  	  FROM
15:21:30  42  	    INVOICE
15:21:30  43  	  WHERE
15:21:30  44  	    INVOICE.ID = in_invoice_id;
15:21:30  45  
15:21:30  46  	  EXCEPTION
15:21:30  47  	    WHEN NO_DATA_FOUND THEN
15:21:30  48  	      RAISE BAD_INVOICE_ID;
15:21:30  49  	END;
15:21:30  50  
15:21:30  51  	-- Check that given offer exists
15:21:30  52  	BEGIN
15:21:30  53  	  SELECT
15:21:30  54  	    OFFER.ID into temp_offer_id
15:21:30  55  	  FROM
15:21:30  56  	    OFFER
15:21:30  57  	  WHERE
15:21:30  58  	    OFFER.ID = in_offer_id;
15:21:30  59  
15:21:30  60  	  EXCEPTION
15:21:30  61  	    WHEN NO_DATA_FOUND THEN
15:21:30  62  	      RAISE BAD_OFFER_ID;
15:21:30  63  	END;
15:21:30  64  
15:21:30  65  	-- Get product_offering data
15:21:30  66  	OPEN var_line_item_data FOR
15:21:30  67  	SELECT
15:21:30  68  	  PRODUCT_OFFERING.ID,
15:21:30  69  	  PRODUCT_OFFERING.UNIT_PRICE,
15:21:30  70  	  PRODUCT_OFFERING.QUANTITY
15:21:30  71  	FROM
15:21:30  72  	  OFFER_PRODUCT_OFFERING
15:21:30  73  	  INNER JOIN PRODUCT_OFFERING ON OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = PRODUCT_OFFERING.ID
15:21:30  74  	WHERE
15:21:30  75  	  OFFER_PRODUCT_OFFERING.OFFER_ID = in_offer_id;
15:21:30  76  
15:21:30  77  	-- insert line items
15:21:30  78  	-- add discounts to line items
15:21:30  79  	LOOP
15:21:30  80  	  FETCH var_line_item_data INTO
15:21:30  81  	    var_product_offering_id,
15:21:30  82  	    var_product_unit_price,
15:21:30  83  	    var_product_quantity;
15:21:30  84  	  EXIT WHEN var_line_item_data%NOTFOUND;
15:21:30  85  
15:21:30  86  	  var_product_offering_oprice := var_product_unit_price * var_product_quantity;
15:21:30  87  	  var_product_offering_price := var_product_offering_oprice;
15:21:30  88  
15:21:30  89  	  -- Apply discounts to line_item
15:21:30  90  	  BEGIN
15:21:30  91  	    SELECT
15:21:30  92  	      SUM (DISCOUNT.FIXED_AMOUNT) into var_discount_fixed_amount
15:21:30  93  	    FROM
15:21:30  94  	      DISCOUNT_PRODUCT_OFFERING
15:21:30  95  	      INNER JOIN DISCOUNT ON DISCOUNT_PRODUCT_OFFERING.DISCOUNT_ID = DISCOUNT.ID
15:21:30  96  	    WHERE
15:21:30  97  	      DISCOUNT_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = var_product_offering_id
15:21:30  98  	      AND DISCOUNT.FIXED_AMOUNT IS NOT NULL;
15:21:30  99  	    EXCEPTION
15:21:30 100  	    WHEN NO_DATA_FOUND THEN
15:21:30 101  	      var_discount_fixed_amount := NULL;
15:21:30 102  	  END;
15:21:30 103  
15:21:30 104  	  BEGIN
15:21:30 105  	    SELECT
15:21:30 106  	      SUM (DISCOUNT.PERCENT_AMOUNT) into var_discount_percent_amount
15:21:30 107  	    FROM
15:21:30 108  	      DISCOUNT_PRODUCT_OFFERING
15:21:30 109  	      INNER JOIN DISCOUNT ON DISCOUNT_PRODUCT_OFFERING.DISCOUNT_ID = DISCOUNT.ID
15:21:30 110  	    WHERE
15:21:30 111  	      DISCOUNT_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = var_product_offering_id
15:21:30 112  	      AND DISCOUNT.PERCENT_AMOUNT IS NOT NULL;
15:21:30 113  	    EXCEPTION
15:21:30 114  	    WHEN NO_DATA_FOUND THEN
15:21:30 115  	      var_discount_percent_amount := NULL;
15:21:30 116  	  END;
15:21:30 117  
15:21:30 118  	  IF (var_discount_percent_amount IS NOT NULL) THEN
15:21:30 119  	    var_product_offering_price := var_product_offering_price * ( 1 - var_discount_percent_amount / 100 );
15:21:30 120  	  END IF;
15:21:30 121  
15:21:30 122  	  IF (var_discount_fixed_amount IS NOT NULL) THEN
15:21:30 123  	    var_product_offering_price := var_product_offering_price - var_discount_fixed_amount;
15:21:30 124  	  END IF;
15:21:30 125  
15:21:30 126  	  var_line_item_price := PROCS_COMMON_V18.ROUND_10_6_TO_10_2(var_product_offering_price);
15:21:30 127  
15:21:30 128  	  IF (var_line_item_price < 0) THEN
15:21:30 129  	      RAISE BAD_DISCOUNT;
15:21:30 130  	  END IF;
15:21:30 131  
15:21:30 132  	  var_new_line_item_id := NULL;
15:21:30 133  	  PROCS_LINE_ITEMS_CRU_V18.CREATE_LINE_ITEM(
15:21:30 134  	    inout_line_item_id	=> var_new_line_item_id,
15:21:30 135  	    in_product_offer_id => var_product_offering_id,
15:21:30 136  	    in_invoice_id	=> in_invoice_id,
15:21:30 137  	    in_amount		=> var_line_item_price,
15:21:30 138  	    in_created_by	=> in_created_by,
15:21:30 139  	    in_discount_amount	=> var_product_offering_oprice - var_line_item_price,
15:21:30 140  	    in_taxes_amount	=> NULL
15:21:30 141  	  );
15:21:30 142  
15:21:30 143  	  FOR f_discount IN (
15:21:30 144  	    SELECT
15:21:30 145  	      DISCOUNT.ID
15:21:30 146  	    FROM
15:21:30 147  	      DISCOUNT_PRODUCT_OFFERING
15:21:30 148  	      INNER JOIN DISCOUNT ON DISCOUNT_PRODUCT_OFFERING.DISCOUNT_ID = DISCOUNT.ID
15:21:30 149  	    WHERE
15:21:30 150  	      DISCOUNT_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = var_product_offering_id
15:21:30 151  	  )
15:21:30 152  	  LOOP
15:21:30 153  	    PROCS_LINE_ITEMS_CRU_V18.CREATE_DISCOUNT_LINE_ITEM(
15:21:30 154  	      in_discount_id =>  f_discount.ID,
15:21:30 155  	      in_line_item_id => var_new_line_item_id
15:21:30 156  	    );
15:21:30 157  	  END LOOP;
15:21:30 158  	END LOOP;
15:21:30 159  
15:21:30 160  EXCEPTION
15:21:30 161  WHEN BAD_INVOICE_ID THEN
15:21:30 162  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 163  	  SPROC_NAME, 'No such license');
15:21:30 164  WHEN BAD_OFFER_ID THEN
15:21:30 165  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 166  	  SPROC_NAME, 'No such offer');
15:21:30 167  WHEN BAD_DISCOUNT THEN
15:21:30 168  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 169  	  SPROC_NAME, 'Bad Discount');
15:21:30 170  WHEN OTHERS THEN
15:21:30 171  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 172  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 173  END ADD_LINE_ITEMS;
15:21:30 174  
15:21:30 175  /******************************************************************************/
15:21:30 176  
15:21:30 177  PROCEDURE UPDATE_LINE_ITEM_AMOUNT (
15:21:30 178  	in_line_item_id    IN NUMBER,
15:21:30 179  	in_amount	   IN NUMBER,
15:21:30 180  	in_discount_amount IN NUMBER,
15:21:30 181  	in_taxes_amount    IN NUMBER
15:21:30 182  ) AS
15:21:30 183  SPROC_NAME CONSTANT VARCHAR2(24) := 'UPDATE_LINE_ITEM_AMOUNTS';
15:21:30 184  -- VARIABLES
15:21:30 185  temp_line_item_id NUMBER;
15:21:30 186  -- EXCEPTIONS
15:21:30 187  BAD_LINE_ITEM_ID EXCEPTION;
15:21:30 188  BEGIN
15:21:30 189  
15:21:30 190  	-- Check that line item exists
15:21:30 191  	BEGIN
15:21:30 192  	  SELECT
15:21:30 193  	    LINE_ITEM.ID into temp_line_item_id
15:21:30 194  	  FROM
15:21:30 195  	    LINE_ITEM
15:21:30 196  	  WHERE
15:21:30 197  	    LINE_ITEM.ID = in_line_item_id;
15:21:30 198  	  EXCEPTION
15:21:30 199  	    WHEN NO_DATA_FOUND THEN
15:21:30 200  	      RAISE BAD_LINE_ITEM_ID;
15:21:30 201  	END;
15:21:30 202  
15:21:30 203  	-- Update line item
15:21:30 204  	PROCS_LINE_ITEMS_CRU_V18.UPDATE_LINE_ITEM(
15:21:30 205  	  in_line_item_id    => in_line_item_id,
15:21:30 206  	  in_amount	     => in_amount,
15:21:30 207  	  in_discount_amount => in_discount_amount,
15:21:30 208  	  in_taxes_amount    => in_taxes_amount
15:21:30 209  	);
15:21:30 210  
15:21:30 211  EXCEPTION
15:21:30 212  WHEN BAD_LINE_ITEM_ID THEN
15:21:30 213  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 214  	  SPROC_NAME, 'No such line item');
15:21:30 215  WHEN OTHERS THEN
15:21:30 216  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 217  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 218  END UPDATE_LINE_ITEM_AMOUNT;
15:21:30 219  
15:21:30 220  /******************************************************************************/
15:21:30 221  
15:21:30 222  PROCEDURE GET_INVOICE_LINE_ITEMS (
15:21:30 223  /*
15:21:30 224  Throws exceptions:
15:21:30 225  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30 226  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 227  */
15:21:30 228  	in_invoice_id  IN NUMBER,
15:21:30 229  	out_result_set OUT SYS_REFCURSOR
15:21:30 230  ) AS
15:21:30 231  -- VARIABLES
15:21:30 232  SPROC_NAME      CONSTANT VARCHAR2(22) := 'GET_INVOICE_LINE_ITEMS';
15:21:30 233  temp_invoice_id NUMBER;
15:21:30 234  
15:21:30 235  -- EXCEPTIONS
15:21:30 236  BAD_INVOICE_ID EXCEPTION;
15:21:30 237  BEGIN
15:21:30 238  
15:21:30 239  	-- Check that given invoice exists
15:21:30 240  	BEGIN
15:21:30 241  	  SELECT
15:21:30 242  	    INVOICE.ID into temp_invoice_id
15:21:30 243  	  FROM
15:21:30 244  	    INVOICE
15:21:30 245  	  WHERE
15:21:30 246  	    INVOICE.ID = in_invoice_id;
15:21:30 247  	  EXCEPTION
15:21:30 248  	    WHEN NO_DATA_FOUND THEN
15:21:30 249  	      RAISE BAD_INVOICE_ID;
15:21:30 250  	END;
15:21:30 251  
15:21:30 252  	-- Select line items
15:21:30 253  	OPEN out_result_set FOR
15:21:30 254  	SELECT
15:21:30 255  	  LINE_ITEM.ID,
15:21:30 256  	  LINE_ITEM.AMOUNT,
15:21:30 257  	  LINE_ITEM.CREATE_DATE,
15:21:30 258  	  LINE_ITEM.CREATED_BY,
15:21:30 259  	  LINE_ITEM.INVOICE_ID,
15:21:30 260  	  LINE_ITEM.DISCOUNT_AMOUNT,
15:21:30 261  	  LINE_ITEM.TAXES_AMOUNT,
15:21:30 262  	  LINE_ITEM.PRODUCT_OFFER_ID
15:21:30 263  	FROM
15:21:30 264  	  LINE_ITEM
15:21:30 265  	WHERE
15:21:30 266  	  LINE_ITEM.INVOICE_ID = in_invoice_id;
15:21:30 267  
15:21:30 268  EXCEPTION
15:21:30 269  WHEN BAD_INVOICE_ID THEN
15:21:30 270  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 271  	  SPROC_NAME, 'No such invoice');
15:21:30 272  WHEN OTHERS THEN
15:21:30 273  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 274  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 275  END GET_INVOICE_LINE_ITEMS;
15:21:30 276  
15:21:30 277  /******************************************************************************/
15:21:30 278  
15:21:30 279  PROCEDURE GET_LINE_ITEM_TAXES (
15:21:30 280  /*
15:21:30 281  Throws exceptions:
15:21:30 282  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30 283  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 284  */
15:21:30 285  	in_line_item_id IN  NUMBER,
15:21:30 286  	out_result_set	OUT SYS_REFCURSOR
15:21:30 287  ) AS
15:21:30 288  -- VARIABLES
15:21:30 289  SPROC_NAME	CONSTANT VARCHAR2(19) := 'GET_LINE_ITEM_TAXES';
15:21:30 290  temp_line_item_id NUMBER;
15:21:30 291  -- EXCEPTIONS
15:21:30 292  BAD_LINE_ITEM_ID EXCEPTION;
15:21:30 293  BEGIN
15:21:30 294  
15:21:30 295  	-- Check that line item exists
15:21:30 296  	BEGIN
15:21:30 297  	  SELECT
15:21:30 298  	    LINE_ITEM.ID into temp_line_item_id
15:21:30 299  	  FROM
15:21:30 300  	    LINE_ITEM
15:21:30 301  	  WHERE
15:21:30 302  	    LINE_ITEM.ID = in_line_item_id;
15:21:30 303  	  EXCEPTION
15:21:30 304  	    WHEN NO_DATA_FOUND THEN
15:21:30 305  	      RAISE BAD_LINE_ITEM_ID;
15:21:30 306  	END;
15:21:30 307  
15:21:30 308  	-- Get all taxes for given line item
15:21:30 309  	OPEN out_result_set FOR
15:21:30 310  	SELECT
15:21:30 311  	  TAX.ID,
15:21:30 312  	  TAX.CALCULATED_AMOUNT,
15:21:30 313  	  TAX.CREATE_DATE,
15:21:30 314  	  TAX.CREATED_BY,
15:21:30 315  	  TAX.EFFECTIVE_RATE,
15:21:30 316  	  TAX.EXT_RESULT,
15:21:30 317  	  TAX.EXT_TAX_TYPE,
15:21:30 318  	  TAX.IMPOSITION,
15:21:30 319  	  TAX.IMPOSITION_TYPE,
15:21:30 320  	  TAX.JURISDICTION_ID,
15:21:30 321  	  TAX.JURISDICTION_LEVEL_ID,
15:21:30 322  	  TAX.JURISDICTION_NAME,
15:21:30 323  	  TAX.LINE_ITEM_ID,
15:21:30 324  	  TAX.TAX_RULE_ID,
15:21:30 325  	  TAX.TAX_TYPE_ID,
15:21:30 326  	  TAX.TAXABLE_AMOUNT
15:21:30 327  	FROM
15:21:30 328  	  TAX
15:21:30 329  	WHERE
15:21:30 330  	  TAX.LINE_ITEM_ID = in_line_item_id;
15:21:30 331  
15:21:30 332  EXCEPTION
15:21:30 333  WHEN BAD_LINE_ITEM_ID THEN
15:21:30 334  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 335  	  SPROC_NAME, 'No such line item');
15:21:30 336  WHEN OTHERS THEN
15:21:30 337  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 338  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 339  END GET_LINE_ITEM_TAXES;
15:21:30 340  
15:21:30 341  -- norlov: #38770
15:21:30 342  PROCEDURE GET_LINE_ITEM_DISCOUNTS (
15:21:30 343  /*
15:21:30 344  Throws exceptions:
15:21:30 345  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30 346  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 347  */
15:21:30 348  	in_line_item_id IN  NUMBER,
15:21:30 349  	out_result_set	OUT SYS_REFCURSOR
15:21:30 350  ) AS
15:21:30 351  -- VARIABLES
15:21:30 352  SPROC_NAME	CONSTANT VARCHAR2(23) := 'GET_LINE_ITEM_DISCOUNTS';
15:21:30 353  temp_line_item_id NUMBER;
15:21:30 354  -- EXCEPTIONS
15:21:30 355  BAD_LINE_ITEM_ID EXCEPTION;
15:21:30 356  BEGIN
15:21:30 357  
15:21:30 358  	-- Check that line item exists
15:21:30 359  	BEGIN
15:21:30 360  	  SELECT
15:21:30 361  	    LINE_ITEM.ID into temp_line_item_id
15:21:30 362  	  FROM
15:21:30 363  	    LINE_ITEM
15:21:30 364  	  WHERE
15:21:30 365  	    LINE_ITEM.ID = in_line_item_id;
15:21:30 366  	  EXCEPTION
15:21:30 367  	    WHEN NO_DATA_FOUND THEN
15:21:30 368  	      RAISE BAD_LINE_ITEM_ID;
15:21:30 369  	END;
15:21:30 370  
15:21:30 371  	-- Get all discounts for given line item
15:21:30 372  	OPEN out_result_set FOR
15:21:30 373  	SELECT
15:21:30 374  	  DISCOUNT.FIXED_AMOUNT,
15:21:30 375  	  DISCOUNT.NAME,
15:21:30 376  	  DISCOUNT.ID,
15:21:30 377  	  DISCOUNT.PERCENT_AMOUNT
15:21:30 378  	FROM
15:21:30 379  	  DISCOUNT_LINE_ITEM
15:21:30 380  	  INNER JOIN DISCOUNT ON DISCOUNT_LINE_ITEM.DISCOUNT_ID = DISCOUNT.ID
15:21:30 381  	WHERE
15:21:30 382  	  DISCOUNT_LINE_ITEM.LINE_ITEM_ID = in_line_item_id;
15:21:30 383  
15:21:30 384  EXCEPTION
15:21:30 385  WHEN BAD_LINE_ITEM_ID THEN
15:21:30 386  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 387  	  SPROC_NAME, 'No such line item');
15:21:30 388  WHEN OTHERS THEN
15:21:30 389  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 390  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 391  END GET_LINE_ITEM_DISCOUNTS;
15:21:30 392  /******************************************************************************/
15:21:30 393  
15:21:30 394  PROCEDURE CALCULATE_LINE_ITEM_AMOUNT (
15:21:30 395  /*
15:21:30 396  Throws exceptions:
15:21:30 397  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30 398  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 399  */
15:21:30 400  	in_line_item_id     IN	NUMBER,
15:21:30 401  	out_amount	    OUT NUMBER
15:21:30 402  ) AS
15:21:30 403  -- VARIABLES
15:21:30 404  SPROC_NAME CONSTANT VARCHAR2(26) := 'CALCULATE_LINE_ITEM_AMOUNT';
15:21:30 405  -- EXCEPTIONS
15:21:30 406  BAD_LINE_ITEM_ID EXCEPTION;
15:21:30 407  BEGIN
15:21:30 408  
15:21:30 409  	BEGIN
15:21:30 410  	  SELECT
15:21:30 411  	    LINE_ITEM.AMOUNT into out_amount
15:21:30 412  	  FROM
15:21:30 413  	    LINE_ITEM
15:21:30 414  	  WHERE
15:21:30 415  	    LINE_ITEM.ID = in_line_item_id;
15:21:30 416  	  EXCEPTION
15:21:30 417  	    WHEN NO_DATA_FOUND THEN
15:21:30 418  	      RAISE BAD_LINE_ITEM_ID;
15:21:30 419  	END;
15:21:30 420  
15:21:30 421  EXCEPTION
15:21:30 422  WHEN BAD_LINE_ITEM_ID THEN
15:21:30 423  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 424  	  SPROC_NAME, 'No such line item');
15:21:30 425  WHEN OTHERS THEN
15:21:30 426  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 427  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 428  END CALCULATE_LINE_ITEM_AMOUNT;
15:21:30 429  
15:21:30 430  /******************************************************************************/
15:21:30 431  
15:21:30 432  FUNCTION F_CALCULATE_LINE_ITEM_AMOUNT (
15:21:30 433  /*
15:21:30 434  Throws exceptions:
15:21:30 435  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30 436  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 437  */
15:21:30 438  	in_line_item_id     IN	NUMBER
15:21:30 439  ) RETURN NUMBER AS
15:21:30 440  var_invoice_amount NUMBER(10, 2);
15:21:30 441  BEGIN
15:21:30 442  	PROCS_LINE_ITEMS_V18.CALCULATE_LINE_ITEM_AMOUNT(in_line_item_id, var_invoice_amount);
15:21:30 443  	RETURN var_invoice_amount;
15:21:30 444  END F_CALCULATE_LINE_ITEM_AMOUNT;
15:21:30 445  
15:21:30 446  END PROCS_LINE_ITEMS_V18;
15:21:30 447  .
15:21:30 SQL> /

Package body created.

Elapsed: 00:00:00.05
15:21:30 SQL> 
15:21:30 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_LOCKING_V18" AS
15:21:30   2  
15:21:30   3  /*
15:21:30   4  PROCEDURE INITIALIZE_SYSTEM AS
15:21:30   5  SPROC_NAME CONSTANT VARCHAR2(17) := 'INITIALIZE_SYSTEM';
15:21:30   6  -- VARIABLES
15:21:30   7  var_account_ids SYS_REFCURSOR;
15:21:30   8  var_account_id  NUMBER;
15:21:30   9  BEGIN
15:21:30  10  
15:21:30  11  	OPEN var_account_ids FOR
15:21:30  12  	SELECT
15:21:30  13  	  ACCOUNT.ID
15:21:30  14  	FROM
15:21:30  15  	  ACCOUNT;
15:21:30  16  
15:21:30  17  	LOOP
15:21:30  18  	  FETCH var_account_ids into var_account_id;
15:21:30  19  	  EXIT WHEN var_account_ids%NOTFOUND;
15:21:30  20  	  BEGIN
15:21:30  21  	    INITIALIZE_ACCOUNT(var_account_id);
15:21:30  22  	    EXCEPTION
15:21:30  23  	      WHEN OTHERS THEN
15:21:30  24  		NULL;
15:21:30  25  	  END;
15:21:30  26  	END LOOP;
15:21:30  27  
15:21:30  28  END INITIALIZE_SYSTEM;
15:21:30  29  
15:21:30  30  PROCEDURE INITIALIZE_ACCOUNT (
15:21:30  31  	in_account_id IN NUMBER
15:21:30  32  ) AS
15:21:30  33  SPROC_NAME CONSTANT VARCHAR2(18) := 'INITIALIZE_ACCOUNT';
15:21:30  34  -- EXCEPTIONS
15:21:30  35  ACCOUNT_ALREADY_INITIALIZED EXCEPTION;
15:21:30  36  BEGIN
15:21:30  37  
15:21:30  38  	BEGIN
15:21:30  39  	  INSERT INTO ACCOUNT_LOCK(
15:21:30  40  	    ACCOUNT_ID,
15:21:30  41  	    LOCK_KEY,
15:21:30  42  	    END_DATE,
15:21:30  43  	    CREATED_BY,
15:21:30  44  	    REASON
15:21:30  45  	  ) VALUES (
15:21:30  46  	    in_account_id,
15:21:30  47  	    'initialization key',
15:21:30  48  	    SYSDATE,
15:21:30  49  	    'system',
15:21:30  50  	    'initialization'
15:21:30  51  	  );
15:21:30  52  	  EXCEPTION
15:21:30  53  	    WHEN DUP_VAL_ON_INDEX THEN
15:21:30  54  	      RAISE ACCOUNT_ALREADY_INITIALIZED;
15:21:30  55  	END;
15:21:30  56  
15:21:30  57  EXCEPTION
15:21:30  58  WHEN ACCOUNT_ALREADY_INITIALIZED THEN
15:21:30  59  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:30  60  	  SPROC_NAME, 'Account already initialized');
15:21:30  61  WHEN OTHERS THEN
15:21:30  62  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30  63  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30  64  END;
15:21:30  65  
15:21:30  66  PROCEDURE INITIALIZE_GROUP (
15:21:30  67  	in_group_id IN NUMBER
15:21:30  68  ) AS
15:21:30  69  SPROC_NAME CONSTANT VARCHAR2(16) := 'INITIALIZE_GROUP';
15:21:30  70  -- VARIABLES
15:21:30  71  var_account_id NUMBER;
15:21:30  72  -- EXCEPTIONS
15:21:30  73  BAD_GROUP_ID		EXCEPTION;
15:21:30  74  GROUP_ALREADY_INITIALIZED EXCEPTION;
15:21:30  75  BEGIN
15:21:30  76  
15:21:30  77  	BEGIN
15:21:30  78  	  SELECT
15:21:30  79  	    ACCOUNT.ID into var_account_id
15:21:30  80  	  FROM
15:21:30  81  	    ACCOUNT
15:21:30  82  	  WHERE
15:21:30  83  	    ACCOUNT.GROUP_ID = in_group_id;
15:21:30  84  	  EXCEPTION
15:21:30  85  	    WHEN NO_DATA_FOUND THEN
15:21:30  86  	     RAISE BAD_GROUP_ID;
15:21:30  87  	END;
15:21:30  88  
15:21:30  89  	BEGIN
15:21:30  90  	  INSERT INTO ACCOUNT_LOCK (
15:21:30  91  	    ACCOUNT_ID,
15:21:30  92  	    LOCK_KEY,
15:21:30  93  	    END_DATE,
15:21:30  94  	    CREATED_BY,
15:21:30  95  	    REASON
15:21:30  96  	  ) VALUES (
15:21:30  97  	    var_account_id,
15:21:30  98  	    'initialization key',
15:21:30  99  	    SYSDATE,
15:21:30 100  	    'system',
15:21:30 101  	    'initialization'
15:21:30 102  	  );
15:21:30 103  	  EXCEPTION
15:21:30 104  	    WHEN DUP_VAL_ON_INDEX THEN
15:21:30 105  	      RAISE GROUP_ALREADY_INITIALIZED;
15:21:30 106  	END;
15:21:30 107  
15:21:30 108  EXCEPTION
15:21:30 109  WHEN BAD_GROUP_ID THEN
15:21:30 110  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 111  	  SPROC_NAME, 'No such account with given group id');
15:21:30 112  WHEN GROUP_ALREADY_INITIALIZED THEN
15:21:30 113  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:30 114  	  SPROC_NAME, 'Group already initialized');
15:21:30 115  WHEN OTHERS THEN
15:21:30 116  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 117  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 118  END INITIALIZE_GROUP;
15:21:30 119  */
15:21:30 120  
15:21:30 121  PROCEDURE LOCK_ACCOUNT (
15:21:30 122  	in_group_id    IN NUMBER,
15:21:30 123  	in_lock_key    IN VARCHAR2,
15:21:30 124  	in_seconds_num IN NUMBER,
15:21:30 125  	in_created_by  IN VARCHAR2,
15:21:30 126  	in_reason      IN VARCHAR2
15:21:30 127  ) AS
15:21:30 128  SPROC_NAME CONSTANT VARCHAR2(12) := 'LOCK_ACCOUNT';
15:21:30 129  -- CONSTANTS
15:21:30 130  one_second_interval CONSTANT INTERVAL DAY TO SECOND := INTERVAL '0 00:00:01' DAY TO SECOND;
15:21:30 131  -- VARIABLES
15:21:30 132  var_account_id NUMBER;
15:21:30 133  -- arosolovskiy: using data variable instead of direct get data calls (#38860)
15:21:30 134  var_date		DATE := SYSDATE;
15:21:30 135  var_lock_end_date DATE;
15:21:30 136  -- EXCEPTIONS
15:21:30 137  BAD_GROUP_ID   EXCEPTION;
15:21:30 138  ALREADY_LOCKED EXCEPTION;
15:21:30 139  BEGIN
15:21:30 140  
15:21:30 141  	BEGIN
15:21:30 142  	  SELECT
15:21:30 143  	    ACCOUNT.ID into var_account_id
15:21:30 144  	  FROM
15:21:30 145  	    ACCOUNT
15:21:30 146  	  WHERE
15:21:30 147  	    ACCOUNT.GROUP_ID = in_group_id;
15:21:30 148  	  EXCEPTION
15:21:30 149  	    WHEN NO_DATA_FOUND THEN
15:21:30 150  	      RAISE BAD_GROUP_ID;
15:21:30 151  	END;
15:21:30 152  
15:21:30 153  	var_lock_end_date := var_date + ( in_seconds_num * one_second_interval );
15:21:30 154  
15:21:30 155  	BEGIN
15:21:30 156  
15:21:30 157  	  INSERT INTO ACCOUNT_LOCK (
15:21:30 158  	    ACCOUNT_ID,
15:21:30 159  	    LOCK_KEY,
15:21:30 160  	    END_DATE,
15:21:30 161  	    CREATED_BY,
15:21:30 162  	    REASON
15:21:30 163  	  ) VALUES (
15:21:30 164  	    var_account_id,
15:21:30 165  	    in_lock_key,
15:21:30 166  	    var_lock_end_date,
15:21:30 167  	    in_created_by,
15:21:30 168  	    in_reason
15:21:30 169  	  );
15:21:30 170  
15:21:30 171  	  EXCEPTION
15:21:30 172  	    WHEN DUP_VAL_ON_INDEX THEN
15:21:30 173  	      -- This rows was created before... I will try to update it
15:21:30 174  	      BEGIN
15:21:30 175  
15:21:30 176  		UPDATE
15:21:30 177  		  ACCOUNT_LOCK
15:21:30 178  		SET
15:21:30 179  		  ACCOUNT_LOCK.LOCK_KEY = in_lock_key,
15:21:30 180  		  ACCOUNT_LOCK.END_DATE = var_lock_end_date,
15:21:30 181  		  ACCOUNT_LOCK.CREATED_BY = in_created_by,
15:21:30 182  		  ACCOUNT_LOCK.REASON = in_reason
15:21:30 183  		WHERE
15:21:30 184  		  ACCOUNT_LOCK.ACCOUNT_ID = var_account_id
15:21:30 185  		  AND ACCOUNT_LOCK.END_DATE <= var_date;
15:21:30 186  
15:21:30 187  		IF SQL%ROWCOUNT = 0 THEN
15:21:30 188  		  RAISE ALREADY_LOCKED;
15:21:30 189  		END IF;
15:21:30 190  
15:21:30 191  	      END;
15:21:30 192  	END;
15:21:30 193  
15:21:30 194  EXCEPTION
15:21:30 195  WHEN BAD_GROUP_ID THEN
15:21:30 196  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 197  	  SPROC_NAME, 'No such group id');
15:21:30 198  WHEN ALREADY_LOCKED THEN
15:21:30 199  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:30 200  	  SPROC_NAME, 'Account already locked');
15:21:30 201  WHEN OTHERS THEN
15:21:30 202  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 203  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 204  END LOCK_ACCOUNT;
15:21:30 205  
15:21:30 206  /******************************************************************************/
15:21:30 207  
15:21:30 208  PROCEDURE RELEASE_LOCK (
15:21:30 209  	in_group_id IN NUMBER,
15:21:30 210  	in_lock_key IN VARCHAR2
15:21:30 211  ) AS
15:21:30 212  SPROC_NAME CONSTANT VARCHAR2(12) := 'RELEASE_LOCK';
15:21:30 213  -- VARIABLES
15:21:30 214  var_account_id NUMBER;
15:21:30 215  -- arosolovskiy: using data variable instead of direct get data calls (#38860)
15:21:30 216  var_date DATE := SYSDATE;
15:21:30 217  -- EXCEPTIONS
15:21:30 218  BAD_GROUP_ID		EXCEPTION;
15:21:30 219  COULD_NOT_RELEASE_ACCOUNT EXCEPTION;
15:21:30 220  BEGIN
15:21:30 221  
15:21:30 222  	BEGIN
15:21:30 223  	  SELECT
15:21:30 224  	    ACCOUNT.ID into var_account_id
15:21:30 225  	  FROM
15:21:30 226  	    ACCOUNT
15:21:30 227  	  WHERE
15:21:30 228  	    ACCOUNT.GROUP_ID = in_group_id;
15:21:30 229  	  EXCEPTION
15:21:30 230  	    WHEN NO_DATA_FOUND THEN
15:21:30 231  	      RAISE BAD_GROUP_ID;
15:21:30 232  	END;
15:21:30 233  
15:21:30 234  	UPDATE
15:21:30 235  	  ACCOUNT_LOCK
15:21:30 236  	SET
15:21:30 237  	  ACCOUNT_LOCK.END_DATE = var_date
15:21:30 238  	WHERE
15:21:30 239  	  ACCOUNT_LOCK.ACCOUNT_ID = var_account_id
15:21:30 240  	  -- AND ACCOUNT_LOCK.END_DATE > var_date
15:21:30 241  	  AND ACCOUNT_LOCK.LOCK_KEY = in_lock_key;
15:21:30 242  
15:21:30 243  	IF SQL%ROWCOUNT = 0 THEN
15:21:30 244  	  RAISE COULD_NOT_RELEASE_ACCOUNT;
15:21:30 245  	END IF;
15:21:30 246  
15:21:30 247  EXCEPTION
15:21:30 248  WHEN BAD_GROUP_ID THEN
15:21:30 249  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 250  	  SPROC_NAME, 'No such group id');
15:21:30 251  WHEN COULD_NOT_RELEASE_ACCOUNT THEN
15:21:30 252  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:30 253  	  SPROC_NAME, 'Could not release account. Maybe you are not owner of this lock, or lock is expired');
15:21:30 254  WHEN OTHERS THEN
15:21:30 255  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 256  	  SPROC_NAME, 'Unknown error');
15:21:30 257  END RELEASE_LOCK;
15:21:30 258  
15:21:30 259  END PROCS_LOCKING_V18;
15:21:30 260  .
15:21:30 SQL> /

Package body created.

Elapsed: 00:00:00.04
15:21:30 SQL> 
15:21:30 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_OFFER_CHAIN_V18" AS
15:21:30   2  
15:21:30   3  PROCEDURE GET_OFFER_CHAIN_BY_ID (
15:21:30   4  /*
15:21:30   5  Throws exceptions:
15:21:30   6  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30   7  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30   8  */
15:21:30   9  	  in_offer_chain_id IN	 NUMBER,
15:21:30  10  	  out_result_set    OUT  SYS_REFCURSOR
15:21:30  11  ) AS
15:21:30  12  SPROC_NAME CONSTANT VARCHAR2(21) := 'GET_OFFER_CHAIN_BY_ID';
15:21:30  13  BEGIN
15:21:30  14  
15:21:30  15  	-- Get offer chain informations
15:21:30  16  	OPEN out_result_set FOR
15:21:30  17  	  SELECT
15:21:30  18  	    OC.ID,
15:21:30  19  	    OC.NAME,
15:21:30  20  	    OC.ADOPTABILITY_WINDOW_START_DATE,
15:21:30  21  	    OC.ADOPTABILITY_WINDOW_END_DATE,
15:21:30  22  	    OC.DESCRIPTION,
15:21:30  23  	    OC.IS_GIFT_CERTIFICATE,
15:21:30  24  	    OC.OFFER_CHAIN_STATUS_ID,
15:21:30  25  	    OC.PRODUCT_URI,
15:21:30  26  	    OC.BILLING_SOURCE_ID,
15:21:30  27  	    OC.VENDOR_SOURCE_ID,
15:21:30  28  	    OC.GROUP_ACCOUNT_TYPE_ID,
15:21:30  29  	    DECODE(OC.IS_ADDRESS_REQUIRED,1,'true','false') IS_ADDRESS_REQUIRED
15:21:30  30  	  FROM
15:21:30  31  	    OFFER_CHAIN OC
15:21:30  32  	  WHERE
15:21:30  33  	    OC.ID = in_offer_chain_id
15:21:30  34  	    AND ROWNUM <= 1;
15:21:30  35  
15:21:30  36  EXCEPTION
15:21:30  37  WHEN OTHERS THEN
15:21:30  38  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30  39  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30  40  END GET_OFFER_CHAIN_BY_ID;
15:21:30  41  
15:21:30  42  /******************************************************************************/
15:21:30  43  
15:21:30  44  PROCEDURE GET_OFFER_CHAINS_BY_IDS (
15:21:30  45  /*
15:21:30  46  Throws exceptions:
15:21:30  47  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30  48  APP_EXCEPTION_CODES_V18.INVALID_PARAMETER
15:21:30  49  */
15:21:30  50  	in_offer_chain_ids IN core_owner.NUMBER_TABLE,
15:21:30  51  	out_result_set	   OUT SYS_REFCURSOR
15:21:30  52  ) AS
15:21:30  53  SPROC_NAME CONSTANT VARCHAR2(23) := 'GET_OFFER_CHAINS_BY_IDS';
15:21:30  54  -- EXCEPTIONS
15:21:30  55  BAD_OFFER_CHAINS_IDS EXCEPTION;
15:21:30  56  BEGIN
15:21:30  57  
15:21:30  58  	IF (in_offer_chain_ids IS NULL) THEN
15:21:30  59  	  RAISE BAD_OFFER_CHAINS_IDS;
15:21:30  60  	END IF;
15:21:30  61  
15:21:30  62  	OPEN out_result_set FOR
15:21:30  63  	SELECT
15:21:30  64  	  OCH.ID,
15:21:30  65  	  OCH.NAME,
15:21:30  66  	  OCH.DESCRIPTION,
15:21:30  67  	  OCH.OFFER_CHAIN_STATUS_ID,
15:21:30  68  	  OCH.ADOPTABILITY_WINDOW_START_DATE,
15:21:30  69  	  OCH.ADOPTABILITY_WINDOW_END_DATE,
15:21:30  70  	  OCH.IS_GIFT_CERTIFICATE,
15:21:30  71  	  PROCS_OFFER_CHAIN_V18.CALCULATE_OFFER_CHAIN_AMOUNT(OCH.ID) AS PRICE,
15:21:30  72  	  PROCS_OFFER_CHAIN_V18.IS_OFFER_CHAIN_CANCELABLE(OCH.ID) AS IS_CANCELABLE,
15:21:30  73  	  OCH.VENDOR_SOURCE_ID,
15:21:30  74  	  DECODE(OCH.IS_ADDRESS_REQUIRED,1,'true','false') IS_ADDRESS_REQUIRED
15:21:30  75  	FROM
15:21:30  76  	  OFFER_CHAIN OCH
15:21:30  77  	WHERE
15:21:30  78  	  OCH.ID IN (SELECT * FROM TABLE(in_offer_chain_ids));
15:21:30  79  
15:21:30  80  EXCEPTION
15:21:30  81  WHEN BAD_OFFER_CHAINS_IDS THEN
15:21:30  82  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:30  83  	  SPROC_NAME, 'Invalid offer chains ids');
15:21:30  84  WHEN OTHERS THEN
15:21:30  85  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30  86  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30  87  END GET_OFFER_CHAINS_BY_IDS;
15:21:30  88  
15:21:30  89  /******************************************************************************/
15:21:30  90  
15:21:30  91  PROCEDURE GET_OFFER_CHAINS_PRODUCTS (
15:21:30  92  /*
15:21:30  93  Throws exceptions:
15:21:30  94  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30  95  APP_EXCEPTION_CODES_V18.INVALID_PARAMETER
15:21:30  96  */
15:21:30  97  	in_offer_chain_ids IN core_owner.NUMBER_TABLE,
15:21:30  98  	out_result_set	   OUT SYS_REFCURSOR
15:21:30  99  ) AS
15:21:30 100  SPROC_NAME CONSTANT VARCHAR2(25) := 'GET_OFFER_CHAINS_PRODUCTS';
15:21:30 101  -- EXCEPTIONS
15:21:30 102  BAD_OFFER_CHAINS_IDS EXCEPTION;
15:21:30 103  BEGIN
15:21:30 104  
15:21:30 105  	IF (in_offer_chain_ids IS NULL) THEN
15:21:30 106  	  RAISE BAD_OFFER_CHAINS_IDS;
15:21:30 107  	END IF;
15:21:30 108  
15:21:30 109  	OPEN out_result_set FOR
15:21:30 110  	SELECT
15:21:30 111  	  OOCH.OFFER_CHAIN_ID,
15:21:30 112  	  PO.PRODUCT_ID
15:21:30 113  	FROM
15:21:30 114  	  PRODUCT_OFFERING PO
15:21:30 115  	  INNER JOIN OFFER_PRODUCT_OFFERING OPO ON OPO.PRODUCT_OFFERING_ID = PO.ID
15:21:30 116  	  INNER JOIN OFFER_OFFER_CHAIN OOCH ON OOCH.OFFER_ID = OPO.OFFER_ID
15:21:30 117  	WHERE
15:21:30 118  	  OOCH.OFFER_CHAIN_ID IN (SELECT * FROM TABLE (in_offer_chain_ids));
15:21:30 119  
15:21:30 120  EXCEPTION
15:21:30 121  WHEN BAD_OFFER_CHAINS_IDS THEN
15:21:30 122  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:30 123  	  SPROC_NAME, 'Invalid offer chains ids');
15:21:30 124  WHEN OTHERS THEN
15:21:30 125  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 126  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 127  END GET_OFFER_CHAINS_PRODUCTS;
15:21:30 128  
15:21:30 129  /******************************************************************************/
15:21:30 130  
15:21:30 131  PROCEDURE GET_OFFER_CHAINS_OFFERS (
15:21:30 132  /*
15:21:30 133  Throws exceptions:
15:21:30 134  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 135  APP_EXCEPTION_CODES_V18.INVALID_PARAMETER
15:21:30 136  */
15:21:30 137  	in_offer_chain_ids IN core_owner.NUMBER_TABLE,
15:21:30 138  	out_result_set	   OUT SYS_REFCURSOR
15:21:30 139  ) AS
15:21:30 140  SPROC_NAME CONSTANT VARCHAR2(23) := 'GET_OFFER_CHAINS_OFFERS';
15:21:30 141  -- EXCEPTIONS
15:21:30 142  BAD_OFFER_CHAINS_IDS EXCEPTION;
15:21:30 143  BEGIN
15:21:30 144  
15:21:30 145  	IF (in_offer_chain_ids IS NULL) THEN
15:21:30 146  	  RAISE BAD_OFFER_CHAINS_IDS;
15:21:30 147  	END IF;
15:21:30 148  
15:21:30 149  	OPEN out_result_set FOR
15:21:30 150  	SELECT
15:21:30 151  	  OOCH.OFFER_CHAIN_ID,
15:21:30 152  	  OOCH.OFFER_ID,
15:21:30 153  	  OOCH.INDEX_VALUE,
15:21:30 154  	  OOCH.NUM_RECURRENCES,
15:21:30 155  	  O.ENTITLEMENT_DURATION,
15:21:30 156  	  PROCS_OFFER_CHAIN_V18.CALCULATE_OFFER_AMOUNT(OOCH.OFFER_ID) AS PRICE
15:21:30 157  	FROM
15:21:30 158  	  OFFER O
15:21:30 159  	  INNER JOIN OFFER_OFFER_CHAIN OOCH ON OOCH.OFFER_ID = O.ID
15:21:30 160  	WHERE
15:21:30 161  	  OOCH.OFFER_CHAIN_ID IN (SELECT * FROM TABLE (in_offer_chain_ids));
15:21:30 162  
15:21:30 163  EXCEPTION
15:21:30 164  WHEN BAD_OFFER_CHAINS_IDS THEN
15:21:30 165  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:30 166  	  SPROC_NAME, 'Invalid offer chains ids');
15:21:30 167  WHEN OTHERS THEN
15:21:30 168  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 169  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 170  END GET_OFFER_CHAINS_OFFERS;
15:21:30 171  
15:21:30 172  /******************************************************************************/
15:21:30 173  
15:21:30 174  PROCEDURE GET_OFFER_CHAINS_BY_PRODUCT (
15:21:30 175  /*
15:21:30 176  Throws exceptions (codes):
15:21:30 177  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 178  */
15:21:30 179  	in_product_id  IN  NUMBER,
15:21:30 180  	out_result_set OUT SYS_REFCURSOR
15:21:30 181  )AS
15:21:30 182  -- VARIBLES
15:21:30 183  SPROC_NAME      CONSTANT VARCHAR2(27) := 'GET_OFFER_CHAINS_BY_PRODUCT';
15:21:30 184  temp_product_id NUMBER;
15:21:30 185  
15:21:30 186  -- EXCEPTIONS
15:21:30 187  BAD_PRODUCT_ID EXCEPTION;
15:21:30 188  BEGIN
15:21:30 189  
15:21:30 190  	-- Check that given product exists
15:21:30 191  	BEGIN
15:21:30 192  	  SELECT
15:21:30 193  	    PRODUCT.ID into temp_product_id
15:21:30 194  	  FROM
15:21:30 195  	    PRODUCT
15:21:30 196  	  WHERE
15:21:30 197  	    PRODUCT.ID = in_product_id;
15:21:30 198  	  EXCEPTION
15:21:30 199  	    WHEN NO_DATA_FOUND THEN
15:21:30 200  	      RAISE BAD_PRODUCT_ID;
15:21:30 201  	END;
15:21:30 202  
15:21:30 203  	-- Select all offer chains that contains given product
15:21:30 204  	OPEN out_result_set FOR
15:21:30 205  	SELECT
15:21:30 206  	  OFFER_CHAIN.ID,
15:21:30 207  	  OFFER_CHAIN.NAME,
15:21:30 208  	  OFFER_CHAIN.DESCRIPTION,
15:21:30 209  	  OFFER_CHAIN.ADOPTABILITY_WINDOW_START_DATE,
15:21:30 210  	  OFFER_CHAIN.ADOPTABILITY_WINDOW_END_DATE,
15:21:30 211  	  OFFER_CHAIN.OFFER_CHAIN_STATUS_ID,
15:21:30 212  	  OFFER_CHAIN.IS_GIFT_CERTIFICATE
15:21:30 213  	FROM
15:21:30 214  	  OFFER_CHAIN
15:21:30 215  	WHERE
15:21:30 216  	  OFFER_CHAIN.ID IN (
15:21:30 217  	    SELECT DISTINCT
15:21:30 218  	      OFFER_OFFER_CHAIN.OFFER_CHAIN_ID
15:21:30 219  	    FROM
15:21:30 220  	      OFFER_OFFER_CHAIN
15:21:30 221  	    WHERE
15:21:30 222  	      OFFER_OFFER_CHAIN.OFFER_ID IN (
15:21:30 223  		SELECT DISTINCT
15:21:30 224  		  OFFER_PRODUCT_OFFERING.OFFER_ID
15:21:30 225  		FROM
15:21:30 226  		  OFFER_PRODUCT_OFFERING
15:21:30 227  		WHERE
15:21:30 228  		  OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = in_product_id
15:21:30 229  	      )
15:21:30 230  	  );
15:21:30 231  
15:21:30 232  EXCEPTION
15:21:30 233  WHEN BAD_PRODUCT_ID THEN
15:21:30 234  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 235  	  SPROC_NAME, 'No such product');
15:21:30 236  WHEN OTHERS THEN
15:21:30 237  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 238  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 239  END GET_OFFER_CHAINS_BY_PRODUCT;
15:21:30 240  
15:21:30 241  /******************************************************************************/
15:21:30 242  
15:21:30 243  PROCEDURE GET_OFFER_CHAIN_PRICE (
15:21:30 244  /*
15:21:30 245  Throws exceptions (codes):
15:21:30 246  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30 247  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 248  */
15:21:30 249  	in_offer_chain_id IN NUMBER,
15:21:30 250  	out_price	  OUT NUMBER
15:21:30 251  ) AS
15:21:30 252  -- VARIABLES
15:21:30 253  SPROC_NAME	  CONSTANT VARCHAR2(21) := 'GET_OFFER_CHAIN_PRICE';
15:21:30 254  temp_offer_chain_id NUMBER;
15:21:30 255  
15:21:30 256  -- EXCEPTION
15:21:30 257  BAD_OFFER_CHAIN_ID       EXCEPTION;
15:21:30 258  CAN_NOT_CALCULATE_AMOUNT EXCEPTION;
15:21:30 259  EXCEPTION_MESSAGE        VARCHAR2(1024);
15:21:30 260  BEGIN
15:21:30 261  
15:21:30 262  	-- Check that given offer chain exists
15:21:30 263  	BEGIN
15:21:30 264  	  SELECT
15:21:30 265  	    OFFER_CHAIN.ID into temp_offer_chain_id
15:21:30 266  	  FROM
15:21:30 267  	    OFFER_CHAIN
15:21:30 268  	  WHERE
15:21:30 269  	    OFFER_CHAIN.ID = in_offer_chain_id;
15:21:30 270  
15:21:30 271  	  EXCEPTION
15:21:30 272  	  WHEN NO_DATA_FOUND THEN
15:21:30 273  	    RAISE BAD_OFFER_CHAIN_ID;
15:21:30 274  	END;
15:21:30 275  
15:21:30 276  	BEGIN
15:21:30 277  	  out_price := CALCULATE_OFFER_CHAIN_AMOUNT(in_offer_chain_id);
15:21:30 278  	  EXCEPTION
15:21:30 279  	    WHEN OTHERS THEN
15:21:30 280  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:30 281  	      RAISE CAN_NOT_CALCULATE_AMOUNT;
15:21:30 282  	END;
15:21:30 283  
15:21:30 284  EXCEPTION
15:21:30 285  WHEN BAD_OFFER_CHAIN_ID THEN
15:21:30 286  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 287  	  SPROC_NAME, 'Bad offer chain id');
15:21:30 288  WHEN CAN_NOT_CALCULATE_AMOUNT THEN
15:21:30 289  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:30 290  	  SPROC_NAME, 'Caould not calculate offer chain amount', EXCEPTION_MESSAGE);
15:21:30 291  WHEN OTHERS THEN
15:21:30 292  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 293  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 294  END GET_OFFER_CHAIN_PRICE;
15:21:30 295  
15:21:30 296  /******************************************************************************/
15:21:30 297  
15:21:30 298  PROCEDURE GET_FIRST_OFFER(
15:21:30 299  /*
15:21:30 300  Throws exceptions (codes):
15:21:30 301  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30 302  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 303  */
15:21:30 304  	in_offer_chain_id IN  NUMBER,
15:21:30 305  	out_offer_id	  OUT NUMBER
15:21:30 306  ) AS
15:21:30 307  SPROC_NAME CONSTANT VARCHAR2(15) := 'GET_FIRST_OFFER';
15:21:30 308  BEGIN
15:21:30 309  	-- Seect first offer in offer chain
15:21:30 310  	SELECT
15:21:30 311  	  OFFER_ID into out_offer_id
15:21:30 312  	FROM (
15:21:30 313  	  SELECT
15:21:30 314  	    OFFER_OFFER_CHAIN.OFFER_ID
15:21:30 315  	  FROM
15:21:30 316  	    OFFER_OFFER_CHAIN
15:21:30 317  	  WHERE
15:21:30 318  	    OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_id
15:21:30 319  	  ORDER BY
15:21:30 320  	    OFFER_OFFER_CHAIN.INDEX_VALUE ASC
15:21:30 321  	)
15:21:30 322  	WHERE
15:21:30 323  	  ROWNUM <= 1;
15:21:30 324  
15:21:30 325  EXCEPTION
15:21:30 326  WHEN NO_DATA_FOUND THEN
15:21:30 327  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 328  	  SPROC_NAME, 'No such offer chain');
15:21:30 329  WHEN OTHERS THEN
15:21:30 330  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 331  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 332  END GET_FIRST_OFFER;
15:21:30 333  
15:21:30 334  /******************************************************************************/
15:21:30 335  
15:21:30 336  PROCEDURE GET_ACTIVE_OFFER_CHAINS (
15:21:30 337  /*
15:21:30 338  Throws exceptions (codes):
15:21:30 339  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 340  */
15:21:30 341  	out_result_set OUT SYS_REFCURSOR
15:21:30 342  ) AS
15:21:30 343  SPROC_NAME CONSTANT VARCHAR2(23) := 'GET_ACTIVE_OFFER_CHAINS';
15:21:30 344  BEGIN
15:21:30 345  	OPEN out_result_set FOR
15:21:30 346  	SELECT
15:21:30 347  	  OFFER_CHAIN.ID,
15:21:30 348  	  OFFER_CHAIN.NAME,
15:21:30 349  	  OFFER_CHAIN.DESCRIPTION,
15:21:30 350  	  OFFER_CHAIN.ADOPTABILITY_WINDOW_START_DATE,
15:21:30 351  	  OFFER_CHAIN.ADOPTABILITY_WINDOW_END_DATE,
15:21:30 352  	  OFFER_CHAIN.OFFER_CHAIN_STATUS_ID,
15:21:30 353  	  OFFER_CHAIN.IS_GIFT_CERTIFICATE,
15:21:30 354  	  PROCS_OFFER_CHAIN_V18.IS_OFFER_CHAIN_CANCELABLE(OFFER_CHAIN.ID) AS "IS_CANCELABLE",
15:21:30 355  	  PRODUCT_OFFERING.PRODUCT_ID
15:21:30 356  	FROM
15:21:30 357  	  OFFER_CHAIN,
15:21:30 358  	  OFFER_OFFER_CHAIN,
15:21:30 359  	  OFFER_PRODUCT_OFFERING,
15:21:30 360  	  PRODUCT_OFFERING
15:21:30 361  	WHERE
15:21:30 362  	  OFFER_CHAIN.ID = OFFER_OFFER_CHAIN.OFFER_CHAIN_ID
15:21:30 363  	  and OFFER_OFFER_CHAIN.OFFER_ID = OFFER_PRODUCT_OFFERING.OFFER_ID
15:21:30 364  	  and OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = PRODUCT_OFFERING.ID
15:21:30 365  	  and OFFER_CHAIN.OFFER_CHAIN_STATUS_ID = GLOBAL_STATUSES_V18.OFFER_CHAIN_ACTIVE;
15:21:30 366  
15:21:30 367  EXCEPTION
15:21:30 368  WHEN OTHERS THEN
15:21:30 369  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 370  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 371  END GET_ACTIVE_OFFER_CHAINS;
15:21:30 372  
15:21:30 373  /******************************************************************************/
15:21:30 374  
15:21:30 375  PROCEDURE GET_OFFER_CHAIN_PRODUCTS (
15:21:30 376  /*
15:21:30 377  Throws exceptions (codes):
15:21:30 378  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 379  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 380  */
15:21:30 381  	in_offer_chain_id IN NUMBER,
15:21:30 382  	out_result_set	  OUT SYS_REFCURSOR
15:21:30 383  ) AS
15:21:30 384  -- VARIABLES
15:21:30 385  SPROC_NAME	  CONSTANT VARCHAR2(24) := 'GET_OFFER_CHAIN_PRODUCTS';
15:21:30 386  temp_offer_chain_id NUMBER;
15:21:30 387  
15:21:30 388  -- EXCEPTIONS
15:21:30 389  BAD_OFFER_CHAIN EXCEPTION;
15:21:30 390  BEGIN
15:21:30 391  
15:21:30 392  	-- Check that offer chain exists
15:21:30 393  	BEGIN
15:21:30 394  	  SELECT
15:21:30 395  	    OFFER_CHAIN.ID into temp_offer_chain_id
15:21:30 396  	  FROM
15:21:30 397  	    OFFER_CHAIN
15:21:30 398  	  WHERE
15:21:30 399  	    OFFER_CHAIN.ID = in_offer_chain_id
15:21:30 400  	    AND ROWNUM <= 1;
15:21:30 401  
15:21:30 402  	  EXCEPTION
15:21:30 403  	    WHEN OTHERS THEN
15:21:30 404  	      RAISE BAD_OFFER_CHAIN;
15:21:30 405  	END;
15:21:30 406  
15:21:30 407  	-- Select all products for given offer chain
15:21:30 408  	OPEN out_result_set FOR
15:21:30 409  	SELECT DISTINCT
15:21:30 410  	  PRODUCT_OFFERING.PRODUCT_ID
15:21:30 411  	FROM
15:21:30 412  	  PRODUCT_OFFERING
15:21:30 413  	WHERE
15:21:30 414  	  PRODUCT_OFFERING.ID IN (
15:21:30 415  	    SELECT DISTINCT
15:21:30 416  	      OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID
15:21:30 417  	    FROM
15:21:30 418  	      OFFER_PRODUCT_OFFERING
15:21:30 419  	    WHERE
15:21:30 420  	      OFFER_PRODUCT_OFFERING.OFFER_ID IN (
15:21:30 421  		SELECT
15:21:30 422  		  OFFER_OFFER_CHAIN.OFFER_ID
15:21:30 423  		FROM
15:21:30 424  		  OFFER_OFFER_CHAIN
15:21:30 425  		WHERE
15:21:30 426  		  OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_id
15:21:30 427  	      )
15:21:30 428  	  );
15:21:30 429  
15:21:30 430  EXCEPTION
15:21:30 431  WHEN BAD_OFFER_CHAIN THEN
15:21:30 432  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 433  	  SPROC_NAME, 'No such offer chain');
15:21:30 434  WHEN OTHERS THEN
15:21:30 435  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 436  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 437  END GET_OFFER_CHAIN_PRODUCTS;
15:21:30 438  
15:21:30 439  /******************************************************************************/
15:21:30 440  
15:21:30 441  FUNCTION CALCULATE_OFFER_CHAIN_END_DATE (
15:21:30 442  /*
15:21:30 443  Throws exceptions (codes):
15:21:30 444  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30 445  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 446  */
15:21:30 447  	in_offer_chain_id	  IN NUMBER,
15:21:30 448  	in_offer_chain_start_date IN DATE
15:21:30 449  ) RETURN DATE AS
15:21:30 450  -- VARIABLES
15:21:30 451  SPROC_NAME	     CONSTANT VARCHAR2(30) := 'CALCULATE_OFFER_CHAIN_END_DATE';
15:21:30 452  temp_offer_chain_id    NUMBER;
15:21:30 453  var_offer_chain_length NUMBER;
15:21:30 454  var_offer_duration     VARCHAR2(30);
15:21:30 455  var_offer_recurrences  NUMBER;
15:21:30 456  var_end_date	     DATE;
15:21:30 457  
15:21:30 458  var_offer_ym_interval INTERVAL YEAR TO MONTH;
15:21:30 459  var_offer_ds_interval INTERVAL DAY(3) TO SECOND;
15:21:30 460  var_offer_years	    NUMBER;
15:21:30 461  var_offer_months	    NUMBER;
15:21:30 462  var_offer_days	    NUMBER;
15:21:30 463  var_infinity_offers_count NUMBER;
15:21:30 464  
15:21:30 465  var_offers_set SYS_REFCURSOR;
15:21:30 466  
15:21:30 467  -- EXCEPTIONS
15:21:30 468  BAD_OFFER_CHAIN_ID EXCEPTION;
15:21:30 469  BEGIN
15:21:30 470  
15:21:30 471  	var_end_date := in_offer_chain_start_date;
15:21:30 472  
15:21:30 473  	-- Check that offer chain exists
15:21:30 474  	BEGIN
15:21:30 475  	  SELECT
15:21:30 476  	    OFFER_CHAIN.ID into temp_offer_chain_id
15:21:30 477  	  FROM
15:21:30 478  	    OFFER_CHAIN
15:21:30 479  	  WHERE
15:21:30 480  	    OFFER_CHAIN.ID = in_offer_chain_id;
15:21:30 481  	  EXCEPTION
15:21:30 482  	    WHEN NO_DATA_FOUND
15:21:30 483  	      THEN RAISE BAD_OFFER_CHAIN_ID;
15:21:30 484  	END;
15:21:30 485  
15:21:30 486  	SELECT
15:21:30 487  	  COUNT(*) into var_infinity_offers_count
15:21:30 488  	FROM
15:21:30 489  	  OFFER_OFFER_CHAIN
15:21:30 490  	WHERE
15:21:30 491  	  OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_id
15:21:30 492  	  AND OFFER_OFFER_CHAIN.NUM_RECURRENCES = GLOBAL_ENUMS_V18.OFFER_REC_INFINITY;
15:21:30 493  
15:21:30 494  	IF var_infinity_offers_count > 0 THEN
15:21:30 495  	  -- Offer chain contains offers with infinity num of recurrences
15:21:30 496  	  RETURN NULL;
15:21:30 497  	END IF;
15:21:30 498  
15:21:30 499  	-- Select offers durations
15:21:30 500  	OPEN var_offers_set FOR
15:21:30 501  	SELECT
15:21:30 502  	  OFFER.ENTITLEMENT_DURATION,
15:21:30 503  	  OFFER_OFFER_CHAIN.NUM_RECURRENCES
15:21:30 504  	FROM
15:21:30 505  	  OFFER_OFFER_CHAIN
15:21:30 506  	  INNER JOIN OFFER ON OFFER_OFFER_CHAIN.OFFER_ID = OFFER.ID
15:21:30 507  	WHERE
15:21:30 508  	  OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_id;
15:21:30 509  
15:21:30 510  	-- Calculate sum of offers durations
15:21:30 511  	LOOP
15:21:30 512  	  FETCH var_offers_set INTO var_offer_duration, var_offer_recurrences;
15:21:30 513  	  EXIT WHEN var_offers_set%NOTFOUND;
15:21:30 514  	  PROCS_COMMON_V18.ISO8601DURATION_TO_INTERVALS(var_offer_duration, var_offer_years, var_offer_months, var_offer_days);
15:21:30 515  	  var_offer_ym_interval := var_offer_years||'-'||var_offer_months;
15:21:30 516  	  var_offer_ds_interval := var_offer_days||' 0:0:0';
15:21:30 517  	  var_end_date := var_end_date + ( var_offer_ym_interval * ( var_offer_recurrences + 1) ) + ( var_offer_ds_interval * ( var_offer_recurrences + 1) );
15:21:30 518  	END LOOP;
15:21:30 519  
15:21:30 520  	RETURN var_end_date;
15:21:30 521  
15:21:30 522  EXCEPTION
15:21:30 523  WHEN BAD_OFFER_CHAIN_ID THEN
15:21:30 524  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 525  	  SPROC_NAME, 'No such offer chain');
15:21:30 526  WHEN OTHERS THEN
15:21:30 527  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 528  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 529  END CALCULATE_OFFER_CHAIN_END_DATE;
15:21:30 530  
15:21:30 531  /******************************************************************************/
15:21:30 532  
15:21:30 533  FUNCTION CALCULATE_OFFER_AMOUNT (
15:21:30 534  	in_offer_id IN NUMBER
15:21:30 535  ) RETURN NUMBER AS
15:21:30 536  -- VARIABLES
15:21:30 537  SPROC_NAME    CONSTANT VARCHAR2(22) := 'CALCULATE_OFFER_AMOUNT';
15:21:30 538  temp_offer_id NUMBER;
15:21:30 539  
15:21:30 540  var_product_offering_set	    SYS_REFCURSOR;
15:21:30 541  var_product_offering_id	    NUMBER;
15:21:30 542  var_product_offering_price    NUMBER(10,6);
15:21:30 543  var_product_offering_t_amount NUMBER(10,6);
15:21:30 544  var_product_offering_quantity NUMBER;
15:21:30 545  
15:21:30 546  var_total_amount NUMBER(10,6);
15:21:30 547  var_final_amount NUMBER(10,2);
15:21:30 548  
15:21:30 549  var_percent_discount NUMBER(10,2);
15:21:30 550  var_fixed_discount NUMBER(10,6);
15:21:30 551  
15:21:30 552  -- EXCEPTIONS
15:21:30 553  BAD_OFFER_ID EXCEPTION;
15:21:30 554  BEGIN
15:21:30 555  
15:21:30 556  	BEGIN
15:21:30 557  	  SELECT
15:21:30 558  	    OFFER.ID into temp_offer_id
15:21:30 559  	  FROM
15:21:30 560  	    OFFER
15:21:30 561  	  WHERE
15:21:30 562  	    OFFER.ID = in_offer_id;
15:21:30 563  	  EXCEPTION
15:21:30 564  	    WHEN NO_DATA_FOUND THEN
15:21:30 565  	      RAISE BAD_OFFER_ID;
15:21:30 566  	END;
15:21:30 567  
15:21:30 568  	OPEN var_product_offering_set FOR
15:21:30 569  	SELECT
15:21:30 570  	  OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID,
15:21:30 571  	  PRODUCT_OFFERING.UNIT_PRICE,
15:21:30 572  	  PRODUCT_OFFERING.QUANTITY
15:21:30 573  	FROM
15:21:30 574  	  OFFER_PRODUCT_OFFERING
15:21:30 575  	  INNER JOIN PRODUCT_OFFERING ON OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = PRODUCT_OFFERING.ID
15:21:30 576  	WHERE
15:21:30 577  	  OFFER_PRODUCT_OFFERING.OFFER_ID = in_offer_id;
15:21:30 578  
15:21:30 579  	var_total_amount := 0;
15:21:30 580  
15:21:30 581  	LOOP
15:21:30 582  	  FETCH var_product_offering_set into
15:21:30 583  	    var_product_offering_id,
15:21:30 584  	    var_product_offering_price,
15:21:30 585  	    var_product_offering_quantity;
15:21:30 586  	  EXIT WHEN var_product_offering_set%NOTFOUND;
15:21:30 587  
15:21:30 588  	  SELECT
15:21:30 589  	    SUM(DISCOUNT.FIXED_AMOUNT) into var_fixed_discount
15:21:30 590  	  FROM
15:21:30 591  	    DISCOUNT_PRODUCT_OFFERING
15:21:30 592  	    INNER JOIN DISCOUNT ON DISCOUNT_PRODUCT_OFFERING.DISCOUNT_ID = DISCOUNT.ID
15:21:30 593  	  WHERE
15:21:30 594  	    DISCOUNT_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = var_product_offering_id
15:21:30 595  	    AND DISCOUNT.FIXED_AMOUNT IS NOT NULL;
15:21:30 596  
15:21:30 597  	  SELECT
15:21:30 598  	    SUM(DISCOUNT.PERCENT_AMOUNT) into var_percent_discount
15:21:30 599  	  FROM
15:21:30 600  	    DISCOUNT_PRODUCT_OFFERING
15:21:30 601  	    INNER JOIN DISCOUNT ON DISCOUNT_PRODUCT_OFFERING.DISCOUNT_ID = DISCOUNT.ID
15:21:30 602  	  WHERE
15:21:30 603  	    DISCOUNT_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = var_product_offering_id
15:21:30 604  	    AND DISCOUNT.PERCENT_AMOUNT IS NOT NULL;
15:21:30 605  
15:21:30 606  	  var_product_offering_t_amount := var_product_offering_price * var_product_offering_quantity;
15:21:30 607  
15:21:30 608  	  IF var_percent_discount IS NOT NULL THEN
15:21:30 609  	    var_product_offering_t_amount := var_product_offering_t_amount - ( var_product_offering_t_amount * var_percent_discount / 100 );
15:21:30 610  	  END IF;
15:21:30 611  
15:21:30 612  	  IF var_fixed_discount IS NOT NULL THEN
15:21:30 613  	    var_product_offering_t_amount := var_product_offering_t_amount - var_fixed_discount;
15:21:30 614  	  END IF;
15:21:30 615  
15:21:30 616  	  var_total_amount := var_total_amount + var_product_offering_t_amount;
15:21:30 617  	END LOOP;
15:21:30 618  	var_final_amount := var_total_amount;
15:21:30 619  	RETURN var_final_amount;
15:21:30 620  
15:21:30 621  EXCEPTION
15:21:30 622  WHEN BAD_OFFER_ID THEN
15:21:30 623  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 624  	  SPROC_NAME, 'No such offer');
15:21:30 625  WHEN OTHERS THEN
15:21:30 626  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 627  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 628  END CALCULATE_OFFER_AMOUNT;
15:21:30 629  
15:21:30 630  /******************************************************************************/
15:21:30 631  
15:21:30 632  FUNCTION CALCULATE_OFFER_CHAIN_AMOUNT (
15:21:30 633  	in_offer_chain_id IN NUMBER
15:21:30 634  ) RETURN NUMBER AS
15:21:30 635  -- VARIABLES
15:21:30 636  SPROC_NAME	     CONSTANT VARCHAR2(28) := 'CALCULATE_OFFER_CHAIN_AMOUNT';
15:21:30 637  temp_offer_chain_id    NUMBER;
15:21:30 638  var_first_offer_id     NUMBER;
15:21:30 639  -- EXCEPTIONS
15:21:30 640  BAD_OFFER_CHAIN_ID      EXCEPTION;
15:21:30 641  CAN_NOT_GET_FIRST_OFFER EXCEPTION;
15:21:30 642  EXCEPTION_MESSAGE       VARCHAR2(1024);
15:21:30 643  BEGIN
15:21:30 644  
15:21:30 645  	BEGIN
15:21:30 646  	  SELECT
15:21:30 647  	    OFFER_CHAIN.ID into temp_offer_chain_id
15:21:30 648  	  FROM
15:21:30 649  	    OFFER_CHAIN
15:21:30 650  	  WHERE
15:21:30 651  	    OFFER_CHAIN.ID = in_offer_chain_id;
15:21:30 652  	  EXCEPTION
15:21:30 653  	    WHEN NO_DATA_FOUND THEN
15:21:30 654  	      RAISE BAD_OFFER_CHAIN_ID;
15:21:30 655  	END;
15:21:30 656  
15:21:30 657  	BEGIN
15:21:30 658  	  PROCS_OFFER_CHAIN_V18.GET_FIRST_OFFER(
15:21:30 659  	    in_offer_chain_id => in_offer_chain_id,
15:21:30 660  	    out_offer_id      => var_first_offer_id
15:21:30 661  	  );
15:21:30 662  	  EXCEPTION
15:21:30 663  	    WHEN OTHERS THEN
15:21:30 664  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:30 665  	      RAISE CAN_NOT_GET_FIRST_OFFER;
15:21:30 666  	END;
15:21:30 667  
15:21:30 668  	RETURN CALCULATE_OFFER_AMOUNT(var_first_offer_id);
15:21:30 669  
15:21:30 670  EXCEPTION
15:21:30 671  WHEN BAD_OFFER_CHAIN_ID THEN
15:21:30 672  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 673  	  SPROC_NAME, 'No such offer chain');
15:21:30 674  WHEN CAN_NOT_GET_FIRST_OFFER THEN
15:21:30 675  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 676  	  SPROC_NAME, 'Could not find first offer', EXCEPTION_MESSAGE);
15:21:30 677  WHEN OTHERS THEN
15:21:30 678  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 679  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 680  END CALCULATE_OFFER_CHAIN_AMOUNT;
15:21:30 681  
15:21:30 682  /******************************************************************************/
15:21:30 683  
15:21:30 684  FUNCTION GET_FIRST_OFFER_INDEX (
15:21:30 685  	in_offer_chain_id IN NUMBER
15:21:30 686  ) RETURN NUMBER AS
15:21:30 687  -- VARIABLES
15:21:30 688  SPROC_NAME	    CONSTANT VARCHAR2(21) := 'GET_FIRST_OFFER_INDEX';
15:21:30 689  var_first_offer_index NUMBER;
15:21:30 690  BEGIN
15:21:30 691  
15:21:30 692  	SELECT
15:21:30 693  	  INDEX_VALUE into var_first_offer_index
15:21:30 694  	FROM (
15:21:30 695  	  SELECT
15:21:30 696  	    OFFER_OFFER_CHAIN.INDEX_VALUE
15:21:30 697  	  FROM
15:21:30 698  	    OFFER_OFFER_CHAIN
15:21:30 699  	  WHERE
15:21:30 700  	    OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_id
15:21:30 701  	  ORDER BY
15:21:30 702  	    OFFER_OFFER_CHAIN.INDEX_VALUE ASC
15:21:30 703  	)
15:21:30 704  	WHERE
15:21:30 705  	  ROWNUM <= 1;
15:21:30 706  
15:21:30 707  	RETURN var_first_offer_index;
15:21:30 708  
15:21:30 709  EXCEPTION
15:21:30 710  WHEN NO_DATA_FOUND THEN
15:21:30 711  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 712  	  SPROC_NAME, 'No such offer chain');
15:21:30 713  WHEN OTHERS THEN
15:21:30 714  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 715  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 716  END GET_FIRST_OFFER_INDEX;
15:21:30 717  
15:21:30 718  /******************************************************************************/
15:21:30 719  
15:21:30 720  FUNCTION GET_NEXT_OFFER_INDEX (
15:21:30 721  /*
15:21:30 722  NULL, if not exists
15:21:30 723  */
15:21:30 724  	in_offer_chain_id	     IN NUMBER,
15:21:30 725  	in_offer_chain_current_index IN NUMBER
15:21:30 726  ) RETURN NUMBER AS
15:21:30 727  -- VARIABLES
15:21:30 728  SPROC_NAME		     CONSTANT VARCHAR2(20) := 'GET_NEXT_OFFER_INDEX';
15:21:30 729  temp_offer_chain_id	     NUMBER;
15:21:30 730  temp_offer_chain_current_index NUMBER;
15:21:30 731  var_result		     NUMBER;
15:21:30 732  -- EXCEPTIONS
15:21:30 733  BAD_OFFER_CHAIN_ID      EXCEPTION;
15:21:30 734  BAD_CURRENT_INDEX_VALUE EXCEPTION;
15:21:30 735  BEGIN
15:21:30 736  
15:21:30 737  	-- Check that offer chain exists
15:21:30 738  	BEGIN
15:21:30 739  	  SELECT
15:21:30 740  	    OFFER_CHAIN.ID into temp_offer_chain_id
15:21:30 741  	  FROM
15:21:30 742  	    OFFER_CHAIN
15:21:30 743  	  WHERE
15:21:30 744  	    OFFER_CHAIN.ID = in_offer_chain_id;
15:21:30 745  	  EXCEPTION
15:21:30 746  	    WHEN NO_DATA_FOUND THEN
15:21:30 747  	      RAISE BAD_OFFER_CHAIN_ID;
15:21:30 748  	END;
15:21:30 749  
15:21:30 750  	-- Check that current offer index exists
15:21:30 751  	BEGIN
15:21:30 752  	  SELECT
15:21:30 753  	    OFFER_OFFER_CHAIN.INDEX_VALUE into temp_offer_chain_current_index
15:21:30 754  	  FROM
15:21:30 755  	    OFFER_OFFER_CHAIN
15:21:30 756  	  WHERE
15:21:30 757  	    OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_id
15:21:30 758  	    AND OFFER_OFFER_CHAIN.INDEX_VALUE = in_offer_chain_current_index
15:21:30 759  	    -- TODO: delete next line
15:21:30 760  	    AND ROWNUM <= 1;
15:21:30 761  	  EXCEPTION
15:21:30 762  	    WHEN NO_DATA_FOUND THEN
15:21:30 763  	      RAISE BAD_CURRENT_INDEX_VALUE;
15:21:30 764  	END;
15:21:30 765  
15:21:30 766  	-- Get next offer index
15:21:30 767  	BEGIN
15:21:30 768  	  SELECT
15:21:30 769  	    INDEX_VALUE into var_result
15:21:30 770  	  FROM (
15:21:30 771  	    SELECT
15:21:30 772  	      OFFER_OFFER_CHAIN.INDEX_VALUE
15:21:30 773  	    FROM
15:21:30 774  	      OFFER_OFFER_CHAIN
15:21:30 775  	    WHERE
15:21:30 776  	      OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_id
15:21:30 777  	      AND OFFER_OFFER_CHAIN.INDEX_VALUE > in_offer_chain_current_index
15:21:30 778  	    ORDER BY
15:21:30 779  	      OFFER_OFFER_CHAIN.INDEX_VALUE ASC
15:21:30 780  	  )
15:21:30 781  	  WHERE
15:21:30 782  	    ROWNUM <= 1;
15:21:30 783  	  EXCEPTION
15:21:30 784  	    WHEN NO_DATA_FOUND THEN
15:21:30 785  	      var_result := NULL;
15:21:30 786  	END;
15:21:30 787  
15:21:30 788  	RETURN var_result;
15:21:30 789  
15:21:30 790  EXCEPTION
15:21:30 791  WHEN BAD_OFFER_CHAIN_ID THEN
15:21:30 792  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 793  	  SPROC_NAME, 'No such offer chain');
15:21:30 794  WHEN BAD_CURRENT_INDEX_VALUE THEN
15:21:30 795  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:30 796  	  SPROC_NAME, 'Bad current index value');
15:21:30 797  WHEN OTHERS THEN
15:21:30 798  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 799  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 800  END GET_NEXT_OFFER_INDEX;
15:21:30 801  
15:21:30 802  /******************************************************************************/
15:21:30 803  
15:21:30 804  PROCEDURE P_GET_NEXT_OFFER_INDEX (
15:21:30 805  	in_offer_chain_id	     IN NUMBER,
15:21:30 806  	in_offer_chain_current_index IN NUMBER,
15:21:30 807  	out_next_offer_index	     OUT NUMBER
15:21:30 808  ) AS
15:21:30 809  BEGIN
15:21:30 810  	out_next_offer_index := GET_NEXT_OFFER_INDEX(
15:21:30 811  	  in_offer_chain_id,
15:21:30 812  	  in_offer_chain_current_index
15:21:30 813  	);
15:21:30 814  END P_GET_NEXT_OFFER_INDEX;
15:21:30 815  
15:21:30 816  /******************************************************************************/
15:21:30 817  
15:21:30 818  PROCEDURE GET_NEXT_OFFER_INDEX_BY_LCNS (
15:21:30 819  	in_license_id		     IN NUMBER,
15:21:30 820  	in_offer_chain_current_index IN NUMBER,
15:21:30 821  	out_next_offer_index	     OUT NUMBER
15:21:30 822  ) AS
15:21:30 823  -- VARIABLES
15:21:30 824  SPROC_NAME	 CONSTANT VARCHAR2(28) := 'GET_NEXT_OFFER_INDEX_BY_LCNS';
15:21:30 825  var_offer_chain_id NUMBER;
15:21:30 826  -- EXCEPTIONS
15:21:30 827  BAD_LICENSE_ID		   EXCEPTION;
15:21:30 828  CAN_NOT_GET_NEXT_OFFER_INDEX EXCEPTION;
15:21:30 829  EXCEPTION_MESSAGE 	   VARCHAR2(1024);
15:21:30 830  BEGIN
15:21:30 831  
15:21:30 832  	BEGIN
15:21:30 833  	  SELECT
15:21:30 834  	    SUBSCRIPTION.OFFER_CHAIN_ID into var_offer_chain_id
15:21:30 835  	  FROM
15:21:30 836  	    SUBSCRIPTION
15:21:30 837  	  WHERE
15:21:30 838  	    SUBSCRIPTION.ID = (
15:21:30 839  	      SELECT
15:21:30 840  		LICENSE.SUBSCRIPTION_ID
15:21:30 841  	      FROM
15:21:30 842  		LICENSE
15:21:30 843  	      WHERE
15:21:30 844  		LICENSE.ID = in_license_id
15:21:30 845  	    );
15:21:30 846  	  EXCEPTION
15:21:30 847  	    WHEN NO_DATA_FOUND THEN
15:21:30 848  	      RAISE BAD_LICENSE_ID;
15:21:30 849  	END;
15:21:30 850  
15:21:30 851  	BEGIN
15:21:30 852  	  out_next_offer_index := GET_NEXT_OFFER_INDEX(
15:21:30 853  	    var_offer_chain_id,
15:21:30 854  	    in_offer_chain_current_index
15:21:30 855  	  );
15:21:30 856  	  EXCEPTION
15:21:30 857  	    WHEN OTHERS THEN
15:21:30 858  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:30 859  	      RAISE CAN_NOT_GET_NEXT_OFFER_INDEX;
15:21:30 860  	END;
15:21:30 861  
15:21:30 862  EXCEPTION
15:21:30 863  WHEN BAD_LICENSE_ID THEN
15:21:30 864  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 865  	  SPROC_NAME, 'No such license');
15:21:30 866  WHEN CAN_NOT_GET_NEXT_OFFER_INDEX THEN
15:21:30 867  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:30 868  	  SPROC_NAME, 'Could not get next offer index', EXCEPTION_MESSAGE);
15:21:30 869  WHEN OTHERS THEN
15:21:30 870  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 871  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 872  END GET_NEXT_OFFER_INDEX_BY_LCNS;
15:21:30 873  
15:21:30 874  /******************************************************************************/
15:21:30 875  
15:21:30 876  FUNCTION IS_OFFER_INDEX_EXISTS (
15:21:30 877  /*
15:21:30 878  GLOBAL_CONSTANTS_V18.TRUE - exists
15:21:30 879  GLOBAL_CONSTANTS_V18.FALSE - not exists
15:21:30 880  */
15:21:30 881  	in_offer_chain_id	   IN NUMBER,
15:21:30 882  	in_offer_chain_offer_index IN NUMBER
15:21:30 883  ) RETURN NUMBER AS
15:21:30 884  -- VARIABLES
15:21:30 885  SPROC_NAME CONSTANT VARCHAR2(21) := 'IS_OFFER_INDEX_EXISTS';
15:21:30 886  temp_count NUMBER;
15:21:30 887  BEGIN
15:21:30 888  
15:21:30 889  	SELECT
15:21:30 890  	  COUNT(*) into temp_count
15:21:30 891  	FROM
15:21:30 892  	  OFFER_OFFER_CHAIN
15:21:30 893  	WHERE
15:21:30 894  	  OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_id
15:21:30 895  	  AND OFFER_OFFER_CHAIN.INDEX_VALUE = in_offer_chain_offer_index;
15:21:30 896  
15:21:30 897  	IF temp_count > 0 THEN
15:21:30 898  	  RETURN GLOBAL_CONSTANTS_V18.TRUE;
15:21:30 899  	ELSE
15:21:30 900  	  RETURN GLOBAL_CONSTANTS_V18.FALSE;
15:21:30 901  	END IF;
15:21:30 902  
15:21:30 903  EXCEPTION
15:21:30 904  WHEN OTHERS THEN
15:21:30 905  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 906  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 907  END IS_OFFER_INDEX_EXISTS;
15:21:30 908  
15:21:30 909  /******************************************************************************/
15:21:30 910  
15:21:30 911  PROCEDURE GET_OFFER_LENGTH (
15:21:30 912  	in_offer_id IN NUMBER,
15:21:30 913  	out_years   OUT NUMBER,
15:21:30 914  	out_months  OUT NUMBER,
15:21:30 915  	out_days    OUT NUMBER
15:21:30 916  ) AS
15:21:30 917  -- VARIABLES
15:21:30 918  var_offer_duration VARCHAR2(30);
15:21:30 919  SPROC_NAME	 CONSTANT VARCHAR2(16) := 'GET_OFFER_LENGTH';
15:21:30 920  -- EXCEPTIONS
15:21:30 921  BAD_OFFER_ID	     EXCEPTION;
15:21:30 922  CAN_NOT_PARSE_DURATION EXCEPTION;
15:21:30 923  EXCEPTION_MESSAGE       VARCHAR2(1024);
15:21:30 924  BEGIN
15:21:30 925  
15:21:30 926  	BEGIN
15:21:30 927  	  SELECT
15:21:30 928  	    OFFER.ENTITLEMENT_DURATION into var_offer_duration
15:21:30 929  	  FROM
15:21:30 930  	    OFFER
15:21:30 931  	  WHERE
15:21:30 932  	    OFFER.ID = in_offer_id;
15:21:30 933  	  EXCEPTION
15:21:30 934  	    WHEN NO_DATA_FOUND THEN
15:21:30 935  	      RAISE BAD_OFFER_ID;
15:21:30 936  	END;
15:21:30 937  
15:21:30 938  	BEGIN
15:21:30 939  	  PROCS_COMMON_V18.ISO8601DURATION_TO_INTERVALS(
15:21:30 940  	    var_offer_duration,
15:21:30 941  	    out_years,
15:21:30 942  	    out_months,
15:21:30 943  	    out_days
15:21:30 944  	  );
15:21:30 945  	  EXCEPTION
15:21:30 946  	    WHEN OTHERS THEN
15:21:30 947  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:30 948  	      RAISE CAN_NOT_PARSE_DURATION;
15:21:30 949  	END;
15:21:30 950  
15:21:30 951  EXCEPTION
15:21:30 952  WHEN BAD_OFFER_ID THEN
15:21:30 953  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 954  	  SPROC_NAME, 'No such offer');
15:21:30 955  WHEN CAN_NOT_PARSE_DURATION THEN
15:21:30 956  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:30 957  	  SPROC_NAME, 'Can not parse offer duration', EXCEPTION_MESSAGE);
15:21:30 958  WHEN OTHERS THEN
15:21:30 959  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 960  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 961  END GET_OFFER_LENGTH;
15:21:30 962  
15:21:30 963  /******************************************************************************/
15:21:30 964  
15:21:30 965  PROCEDURE GET_OFFER_LENGTH_IN_DAYS (
15:21:30 966  	in_offer_id   IN NUMBER,
15:21:30 967  	in_start_date IN DATE DEFAULT SYSDATE,
15:21:30 968  	out_days      OUT NUMBER
15:21:30 969  ) AS
15:21:30 970  SPROC_NAME CONSTANT VARCHAR2(24) := 'GET_OFFER_LENGTH_IN_DAYS';
15:21:30 971  -- VARIABLES
15:21:30 972  var_offer_duration VARCHAR2(30);
15:21:30 973  var_offer_years	 NUMBER;
15:21:30 974  var_offer_months	 NUMBER;
15:21:30 975  var_offer_days	 NUMBER;
15:21:30 976  var_offer_end_date DATE;
15:21:30 977  -- EXCEPTIONS
15:21:30 978  BAD_OFFER_ID EXCEPTION;
15:21:30 979  BEGIN
15:21:30 980  
15:21:30 981  	BEGIN
15:21:30 982  	  SELECT
15:21:30 983  	    OFFER.ENTITLEMENT_DURATION into var_offer_duration
15:21:30 984  	  FROM
15:21:30 985  	    OFFER
15:21:30 986  	  WHERE
15:21:30 987  	    OFFER.ID = in_offer_id;
15:21:30 988  	  EXCEPTION
15:21:30 989  	    WHEN NO_DATA_FOUND THEN
15:21:30 990  	      RAISE BAD_OFFER_ID;
15:21:30 991  	END;
15:21:30 992  
15:21:30 993  	PROCS_COMMON_V18.ISO8601DURATION_TO_INTERVALS (
15:21:30 994  	  var_offer_duration,
15:21:30 995  	  var_offer_years,
15:21:30 996  	  var_offer_months,
15:21:30 997  	  var_offer_days
15:21:30 998  	);
15:21:30 999  
15:21:30 1000  	 var_offer_end_date := ( ( in_start_date
15:21:30 1001  	   + GLOBAL_CONSTANTS_V18.ONE_DAY_INTERVAL * var_offer_days )
15:21:30 1002  	   + GLOBAL_CONSTANTS_V18.ONE_MONTH_INTERVAL * var_offer_months )
15:21:30 1003  	   + GLOBAL_CONSTANTS_V18.ONE_YEAR_INTERVAL * var_offer_years;
15:21:30 1004  
15:21:30 1005  	 out_days := var_offer_end_date - in_start_date;
15:21:30 1006  
15:21:30 1007  EXCEPTION
15:21:30 1008  WHEN BAD_OFFER_ID THEN
15:21:30 1009  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 1010  	   SPROC_NAME, 'No such offer');
15:21:30 1011  WHEN OTHERS THEN
15:21:30 1012  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 1013  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 1014  END GET_OFFER_LENGTH_IN_DAYS;
15:21:30 1015  
15:21:30 1016  /******************************************************************************/
15:21:30 1017  
15:21:30 1018  PROCEDURE GET_OFFER_PRODUCTS (
15:21:30 1019  /*
15:21:30 1020  Throws exceptions (codes):
15:21:30 1021  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30 1022  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 1023  */
15:21:30 1024  	 in_offer_id	IN NUMBER,
15:21:30 1025  	 out_result_set OUT SYS_REFCURSOR
15:21:30 1026  ) AS
15:21:30 1027  -- VARIABLES
15:21:30 1028  SPROC_NAME     CONSTANT VARCHAR2(18) := 'GET_OFFER_PRODUCTS';
15:21:30 1029  temp_offerr_id NUMBER;
15:21:30 1030  -- EXCEPTIONS
15:21:30 1031  BAD_OFFER_ID EXCEPTION;
15:21:30 1032  BEGIN
15:21:30 1033  
15:21:30 1034  	 BEGIN
15:21:30 1035  	   SELECT
15:21:30 1036  	     OFFER.ID into temp_offerr_id
15:21:30 1037  	   FROM
15:21:30 1038  	     OFFER
15:21:30 1039  	   WHERE
15:21:30 1040  	     OFFER.ID = in_offer_id;
15:21:30 1041  	   EXCEPTION
15:21:30 1042  	     WHEN NO_DATA_FOUND THEN
15:21:30 1043  	       RAISE BAD_OFFER_ID;
15:21:30 1044  	 END;
15:21:30 1045  
15:21:30 1046  	 OPEN out_result_set FOR
15:21:30 1047  	 SELECT DISTINCT
15:21:30 1048  	   PRODUCT.ID,
15:21:30 1049  	   PRODUCT.NAME
15:21:30 1050  	 FROM
15:21:30 1051  	   PRODUCT
15:21:30 1052  	 WHERE
15:21:30 1053  	   PRODUCT.ID IN (
15:21:30 1054  	       SELECT
15:21:30 1055  		 PRODUCT_OFFERING.PRODUCT_ID
15:21:30 1056  	       FROM
15:21:30 1057  		 OFFER_PRODUCT_OFFERING
15:21:30 1058  		 INNER JOIN PRODUCT_OFFERING ON OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = PRODUCT_OFFERING.ID
15:21:30 1059  	       WHERE
15:21:30 1060  		 OFFER_PRODUCT_OFFERING.OFFER_ID = in_offer_id
15:21:30 1061  	     );
15:21:30 1062  
15:21:30 1063  EXCEPTION
15:21:30 1064  WHEN BAD_OFFER_ID THEN
15:21:30 1065  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 1066  	   SPROC_NAME, 'No such offer');
15:21:30 1067  WHEN OTHERS THEN
15:21:30 1068  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 1069  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 1070  END GET_OFFER_PRODUCTS;
15:21:30 1071  
15:21:30 1072  /******************************************************************************/
15:21:30 1073  
15:21:30 1074  PROCEDURE GET_OFFER_CHAIN_PROD_OFFERINGS (
15:21:30 1075  /*
15:21:30 1076  Throws exceptions (codes):
15:21:30 1077  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30 1078  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 1079  */
15:21:30 1080  	 in_offer_chain_id IN NUMBER,
15:21:30 1081  	 out_result_set    OUT SYS_REFCURSOR
15:21:30 1082  ) AS
15:21:30 1083  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_OFFER_CHAIN_PROD_OFFERINGS';
15:21:30 1084  -- VARIABLES
15:21:30 1085  temp_offer_chain_id NUMBER;
15:21:30 1086  -- EXCEPTIONS
15:21:30 1087  BAD_OFFER_CHAIN_ID EXCEPTION;
15:21:30 1088  BEGIN
15:21:30 1089  
15:21:30 1090  	 BEGIN
15:21:30 1091  	   SELECT
15:21:30 1092  	     OFFER_CHAIN.ID into temp_offer_chain_id
15:21:30 1093  	   FROM
15:21:30 1094  	     OFFER_CHAIN
15:21:30 1095  	   WHERE
15:21:30 1096  	     OFFER_CHAIN.ID = in_offer_chain_id;
15:21:30 1097  	   EXCEPTION
15:21:30 1098  	     WHEN NO_DATA_FOUND THEN
15:21:30 1099  	       RAISE BAD_OFFER_CHAIN_ID;
15:21:30 1100  	 END;
15:21:30 1101  
15:21:30 1102  	 OPEN out_result_set FOR
15:21:30 1103  	 SELECT
15:21:30 1104  	   PRODUCT_OFFERING.ID,
15:21:30 1105  	   PRODUCT_OFFERING.PRODUCT_ID,
15:21:30 1106  	   PRODUCT_OFFERING.TAX_CATEGORY_ID,
15:21:30 1107  	   PRODUCT_OFFERING.UNIT_PRICE,
15:21:30 1108  	   PRODUCT_OFFERING.QUANTITY,
15:21:30 1109  	   PRODUCT_OFFERING.CREATE_DATE,
15:21:30 1110  	   PRODUCT_OFFERING.CREATED_BY,
15:21:30 1111  	   PRODUCT.NAME,
15:21:30 1112  	   PRODUCT.PRODUCT_URI,
15:21:30 1113  	   CAPABILITY.ID CAP_ID,
15:21:30 1114  	   CAPABILITY.CODE CAP_CODE,
15:21:30 1115  	   CAPABILITY.DESCRIPTION CAP_DESCRIPTION,
15:21:30 1116  	   CAPABILITY.SHAREABLE CAP_SHAREABLE
15:21:30 1117  	 FROM
15:21:30 1118  	   PRODUCT_OFFERING
15:21:30 1119  	   INNER JOIN PRODUCT ON PRODUCT_OFFERING.PRODUCT_ID = PRODUCT.ID
15:21:30 1120  	   INNER JOIN CAPABILITY ON PRODUCT_OFFERING.CAPABILITY_ID = CAPABILITY.ID
15:21:30 1121  	 WHERE
15:21:30 1122  	   PRODUCT_OFFERING.ID IN (
15:21:30 1123  	     SELECT DISTINCT
15:21:30 1124  	       PRODUCT_OFFERING_ID
15:21:30 1125  	     FROM
15:21:30 1126  	       OFFER_PRODUCT_OFFERING
15:21:30 1127  	     WHERE
15:21:30 1128  	       OFFER_PRODUCT_OFFERING.OFFER_ID IN (
15:21:30 1129  		 SELECT DISTINCT
15:21:30 1130  		   OFFER_ID
15:21:30 1131  		 FROM
15:21:30 1132  		   OFFER_OFFER_CHAIN
15:21:30 1133  		 WHERE
15:21:30 1134  		   OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_id
15:21:30 1135  	       )
15:21:30 1136  	   );
15:21:30 1137  
15:21:30 1138  EXCEPTION
15:21:30 1139  WHEN BAD_OFFER_CHAIN_ID THEN
15:21:30 1140  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 1141  	   SPROC_NAME, 'Bad offer chain id');
15:21:30 1142  WHEN OTHERS THEN
15:21:30 1143  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 1144  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 1145  END GET_OFFER_CHAIN_PROD_OFFERINGS;
15:21:30 1146  
15:21:30 1147  /******************************************************************************/
15:21:30 1148  
15:21:30 1149  FUNCTION CHECK_FOR_SAME_PRODUCTS (
15:21:30 1150  /*
15:21:30 1151  Throws exceptions (codes):
15:21:30 1152  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30 1153  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 1154  Returns:
15:21:30 1155  GLOBAL_CONSTANTS_V18.TRUE if there are at least one same product
15:21:30 1156  GLOBAL_CONSTANTS_V18.FALSE else
15:21:30 1157  */
15:21:30 1158  	 in_offer_chain_1	  IN OFFER_CHAIN.ID%TYPE,
15:21:30 1159  	 in_offer_chain_2	  IN OFFER_CHAIN.ID%TYPE,
15:21:30 1160  	 in_use_eligibility_rules IN NUMBER DEFAULT GLOBAL_CONSTANTS_V18.FALSE
15:21:30 1161  ) RETURN NUMBER AS
15:21:30 1162  SPROC_NAME CONSTANT VARCHAR2(23) := 'CHECK_FOR_SAME_PRODUCTS';
15:21:30 1163  -- CONSTANTS
15:21:30 1164  PRODUCT_ELIGIBILITY_NAME CONSTANT VARCHAR2(19) := 'MAX_CONCURRENT_SUBS';
15:21:30 1165  -- VARIABLES
15:21:30 1166  temp_offer_chain_id	OFFER_CHAIN.ID%TYPE;
15:21:30 1167  var_same_products	SYS_REFCURSOR;
15:21:30 1168  var_same_product_id	NUMBER;
15:21:30 1169  same_product_count	NUMBER;
15:21:30 1170  var_product_eligibility_limit NUMBER;
15:21:30 1171  s_product_eligibility_limit   VARCHAR2(100);
15:21:30 1172  -- EXCEPTIONS
15:21:30 1173  BAD_FIRST_OFFER_CHAIN	      EXCEPTION;
15:21:30 1174  BAD_SECOND_OFFER_CHAIN	      EXCEPTION;
15:21:30 1175  BEGIN
15:21:30 1176  
15:21:30 1177  	 -- Check that first offer chain exists
15:21:30 1178  	 BEGIN
15:21:30 1179  	   SELECT
15:21:30 1180  	     OFFER_CHAIN.ID into temp_offer_chain_id
15:21:30 1181  	   FROM
15:21:30 1182  	     OFFER_CHAIN
15:21:30 1183  	   WHERE
15:21:30 1184  	     OFFER_CHAIN.ID = in_offer_chain_1;
15:21:30 1185  	   EXCEPTION
15:21:30 1186  	     WHEN NO_DATA_FOUND THEN
15:21:30 1187  	       RAISE BAD_FIRST_OFFER_CHAIN;
15:21:30 1188  	 END;
15:21:30 1189  
15:21:30 1190  	 -- Check that second offer chain exists
15:21:30 1191  	 BEGIN
15:21:30 1192  	   SELECT
15:21:30 1193  	     OFFER_CHAIN.ID into temp_offer_chain_id
15:21:30 1194  	   FROM
15:21:30 1195  	     OFFER_CHAIN
15:21:30 1196  	   WHERE
15:21:30 1197  	     OFFER_CHAIN.ID = in_offer_chain_2;
15:21:30 1198  	   EXCEPTION
15:21:30 1199  	     WHEN NO_DATA_FOUND THEN
15:21:30 1200  	       RAISE BAD_SECOND_OFFER_CHAIN;
15:21:30 1201  	 END;
15:21:30 1202  
15:21:30 1203  	 PROCS_OFFER_CHAIN_V18.GET_OFF_CHAINS_SAME_PRODUCTS(
15:21:30 1204  	   in_offer_chain_1 => in_offer_chain_1,
15:21:30 1205  	   in_offer_chain_2 => in_offer_chain_2,
15:21:30 1206  	   out_result_set   => var_same_products
15:21:30 1207  	 );
15:21:30 1208  
15:21:30 1209  	 LOOP
15:21:30 1210  	   FETCH var_same_products INTO var_same_product_id, same_product_count;
15:21:30 1211  	   EXIT WHEN var_same_products%NOTFOUND;
15:21:30 1212  
15:21:30 1213  	   IF in_use_eligibility_rules = GLOBAL_CONSTANTS_V18.FALSE THEN
15:21:30 1214  	     -- Return false because this offer chains having same products
15:21:30 1215  	     RETURN GLOBAL_CONSTANTS_V18.TRUE;
15:21:30 1216  	   ELSE
15:21:30 1217  
15:21:30 1218  	     -- Get eligibility rule for given product
15:21:30 1219  	     BEGIN
15:21:30 1220  	       SELECT
15:21:30 1221  		 PRODUCT_ELIGIBILITY.VALUE into s_product_eligibility_limit
15:21:30 1222  	       FROM
15:21:30 1223  		 PRODUCT_ELIGIBILITY
15:21:30 1224  	       WHERE
15:21:30 1225  		 PRODUCT_ELIGIBILITY.PRODUCT_ID = var_same_product_id
15:21:30 1226  		 AND PRODUCT_ELIGIBILITY.NAME = PRODUCT_ELIGIBILITY_NAME;
15:21:30 1227  
15:21:30 1228  	       -- REVU: What should to be here? 1?
15:21:30 1229  	       EXCEPTION
15:21:30 1230  		 WHEN NO_DATA_FOUND THEN
15:21:30 1231  		   s_product_eligibility_limit := '1';
15:21:30 1232  	     END;
15:21:30 1233  
15:21:30 1234  	     IF UPPER(s_product_eligibility_limit) = GLOBAL_CONSTANTS_V18.MAX_CONSURRENT_PRD_UNLIM THEN
15:21:30 1235  	       RETURN GLOBAL_CONSTANTS_V18.FALSE;
15:21:30 1236  	     END IF;
15:21:30 1237  
15:21:30 1238  	     var_product_eligibility_limit := TO_NUMBER(s_product_eligibility_limit);
15:21:30 1239  
15:21:30 1240  	     -- Check for limit
15:21:30 1241  	     IF var_product_eligibility_limit < same_product_count THEN
15:21:30 1242  	       RETURN GLOBAL_CONSTANTS_V18.TRUE;
15:21:30 1243  	     END IF;
15:21:30 1244  
15:21:30 1245  	   END IF;
15:21:30 1246  	 END LOOP;
15:21:30 1247  
15:21:30 1248  	 RETURN GLOBAL_CONSTANTS_V18.FALSE;
15:21:30 1249  
15:21:30 1250  EXCEPTION
15:21:30 1251  WHEN BAD_FIRST_OFFER_CHAIN THEN
15:21:30 1252  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 1253  	   SPROC_NAME, 'First offer chain not found');
15:21:30 1254  WHEN BAD_SECOND_OFFER_CHAIN THEN
15:21:30 1255  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 1256  	   SPROC_NAME, 'Second offer chain not found');
15:21:30 1257  WHEN OTHERS THEN
15:21:30 1258  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 1259  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 1260  END CHECK_FOR_SAME_PRODUCTS;
15:21:30 1261  
15:21:30 1262  /******************************************************************************/
15:21:30 1263  
15:21:30 1264  FUNCTION IS_OFFER_CHAIN_CANCELABLE (
15:21:30 1265  /*
15:21:30 1266  Throws exceptions (codes):
15:21:30 1267  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 1268  Returns:
15:21:30 1269  GLOBAL_CONSTANTS_V18.TRUE cancelation key is 1 (in OFFER_CHAIN_META_DATA)
15:21:30 1270  GLOBAL_CONSTANTS_V18.FALSE else
15:21:30 1271  */
15:21:30 1272  	 in_offer_chain_id IN NUMBER
15:21:30 1273  ) RETURN NUMBER AS
15:21:30 1274  SPROC_NAME CONSTANT VARCHAR2(25) := 'IS_OFFER_CHAIN_CANCELABLE';
15:21:30 1275  -- VARIABLES
15:21:30 1276  var_is_cancelable_str VARCHAR2(1);
15:21:30 1277  var_is_cancelable     NUMBER;
15:21:30 1278  BEGIN
15:21:30 1279  
15:21:30 1280  	 BEGIN
15:21:30 1281  	   SELECT
15:21:30 1282  	     VALUE INTO var_is_cancelable_str
15:21:30 1283  	   FROM (
15:21:30 1284  	     SELECT
15:21:30 1285  	       VALUE, NAME
15:21:30 1286  	     FROM
15:21:30 1287  	       OFFER_CHAIN_META_DATA
15:21:30 1288  	     WHERE
15:21:30 1289  	       OFFER_CHAIN_ID = in_offer_chain_id
15:21:30 1290  	     )
15:21:30 1291  	   WHERE
15:21:30 1292  	     UPPER(NAME) = 'CANCELABLE';
15:21:30 1293  	   var_is_cancelable := TO_NUMBER(var_is_cancelable_str);
15:21:30 1294  	   EXCEPTION
15:21:30 1295  	     WHEN NO_DATA_FOUND THEN
15:21:30 1296  	       var_is_cancelable := GLOBAL_CONSTANTS_V18.FALSE;
15:21:30 1297  	 END;
15:21:30 1298  
15:21:30 1299  	 IF var_is_cancelable = GLOBAL_CONSTANTS_V18.FALSE THEN
15:21:30 1300  	   RETURN GLOBAL_CONSTANTS_V18.FALSE;
15:21:30 1301  	 END IF;
15:21:30 1302  
15:21:30 1303  	 RETURN GLOBAL_CONSTANTS_V18.TRUE;
15:21:30 1304  
15:21:30 1305  EXCEPTION
15:21:30 1306  WHEN OTHERS THEN
15:21:30 1307  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 1308  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 1309  END IS_OFFER_CHAIN_CANCELABLE;
15:21:30 1310  
15:21:30 1311  /******************************************************************************/
15:21:30 1312  
15:21:30 1313  FUNCTION GET_OFFER_CHAIN_MAX_CONC_SUBSC (
15:21:30 1314  /*
15:21:30 1315  Throws exceptions (codes):
15:21:30 1316  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 1317  */
15:21:30 1318  	 in_offer_chain_id IN NUMBER
15:21:30 1319  ) RETURN NUMBER AS
15:21:30 1320  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_OFFER_CHAIN_MAX_CONC_SUBSC';
15:21:30 1321  -- VARIABLES
15:21:30 1322  var_max_concurrent_subs_str VARCHAR2(100);
15:21:30 1323  var_max_concurrent_subs	   NUMBER;
15:21:30 1324  BEGIN
15:21:30 1325  
15:21:30 1326  	 BEGIN
15:21:30 1327  	   SELECT
15:21:30 1328  	     VALUE into var_max_concurrent_subs_str
15:21:30 1329  	   FROM
15:21:30 1330  	     (
15:21:30 1331  	       SELECT
15:21:30 1332  		 NAME,
15:21:30 1333  		 VALUE
15:21:30 1334  	       FROM
15:21:30 1335  		 OFFER_CHAIN_ELIGIBILITY
15:21:30 1336  	       WHERE
15:21:30 1337  		 OFFER_CHAIN_ID = in_offer_chain_id
15:21:30 1338  	     )
15:21:30 1339  	   WHERE
15:21:30 1340  	     NAME LIKE GLOBAL_CONSTANTS_V18.MAX_CONCURRENT_SUBS;
15:21:30 1341  
15:21:30 1342  	   IF var_max_concurrent_subs_str = GLOBAL_CONSTANTS_V18.MAX_CONCURRENT_SUBS_UNLIM THEN
15:21:30 1343  	     var_max_concurrent_subs := GLOBAL_CONSTANTS_V18.INFINITY;
15:21:30 1344  	   ELSE
15:21:30 1345  	     var_max_concurrent_subs := TO_NUMBER(var_max_concurrent_subs_str);
15:21:30 1346  	   END IF;
15:21:30 1347  
15:21:30 1348  	   EXCEPTION
15:21:30 1349  	     WHEN NO_DATA_FOUND THEN
15:21:30 1350  	       var_max_concurrent_subs := 1;
15:21:30 1351  	 END;
15:21:30 1352  
15:21:30 1353  	 RETURN var_max_concurrent_subs;
15:21:30 1354  
15:21:30 1355  EXCEPTION
15:21:30 1356  WHEN OTHERS THEN
15:21:30 1357  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 1358  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 1359  END GET_OFFER_CHAIN_MAX_CONC_SUBSC;
15:21:30 1360  
15:21:30 1361  /******************************************************************************/
15:21:30 1362  
15:21:30 1363  PROCEDURE GET_OFFER_CHAIN_ELIGIBILITY (
15:21:30 1364  /*
15:21:30 1365  Throws exceptions (codes):
15:21:30 1366  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30 1367  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 1368  */
15:21:30 1369  	 in_offer_chain_id   IN NUMBER,
15:21:30 1370  	 in_eligibility_name IN VARCHAR2,
15:21:30 1371  	 out_result_set      OUT SYS_REFCURSOR
15:21:30 1372  ) AS
15:21:30 1373  SPROC_NAME CONSTANT VARCHAR2(27) := 'GET_OFFER_CHAIN_ELIGIBILITY';
15:21:30 1374  -- VARIABLES
15:21:30 1375  temp_offer_chain_id NUMBER;
15:21:30 1376  var_eligibility_name OFFER_CHAIN_ELIGIBILITY.NAME%TYPE;
15:21:30 1377  -- EXCEPTIONS
15:21:30 1378  BAD_OFFER_CHAIN_ID EXCEPTION;
15:21:30 1379  BEGIN
15:21:30 1380  
15:21:30 1381  	 BEGIN
15:21:30 1382  	   SELECT
15:21:30 1383  	     OFFER_CHAIN.ID into temp_offer_chain_id
15:21:30 1384  	   FROM
15:21:30 1385  	     OFFER_CHAIN
15:21:30 1386  	   WHERE
15:21:30 1387  	     OFFER_CHAIN.ID = in_offer_chain_id;
15:21:30 1388  	   EXCEPTION
15:21:30 1389  	     WHEN NO_DATA_FOUND THEN
15:21:30 1390  	       RAISE BAD_OFFER_CHAIN_ID;
15:21:30 1391  	 END;
15:21:30 1392  
15:21:30 1393  	 var_eligibility_name := UPPER(in_eligibility_name);
15:21:30 1394  
15:21:30 1395  	 OPEN out_result_set FOR
15:21:30 1396  	 SELECT
15:21:30 1397  	   OFFER_CHAIN_ELIGIBILITY.ID,
15:21:30 1398  	   OFFER_CHAIN_ELIGIBILITY.NAME,
15:21:30 1399  	   OFFER_CHAIN_ELIGIBILITY.VALUE,
15:21:30 1400  	   OFFER_CHAIN_ELIGIBILITY.OFFER_CHAIN_ID,
15:21:30 1401  	   OFFER_CHAIN_ELIGIBILITY.CREATE_DATE,
15:21:30 1402  	   OFFER_CHAIN_ELIGIBILITY.CREATED_BY
15:21:30 1403  	 FROM
15:21:30 1404  	   OFFER_CHAIN_ELIGIBILITY
15:21:30 1405  	 WHERE
15:21:30 1406  	   OFFER_CHAIN_ELIGIBILITY.OFFER_CHAIN_ID = in_offer_chain_id
15:21:30 1407  	   AND UPPER(OFFER_CHAIN_ELIGIBILITY.NAME) = var_eligibility_name;
15:21:30 1408  
15:21:30 1409  EXCEPTION
15:21:30 1410  WHEN BAD_OFFER_CHAIN_ID THEN
15:21:30 1411  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 1412  	   SPROC_NAME, 'No such offer chain');
15:21:30 1413  WHEN OTHERS THEN
15:21:30 1414  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 1415  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 1416  END GET_OFFER_CHAIN_ELIGIBILITY;
15:21:30 1417  
15:21:30 1418  /******************************************************************************/
15:21:30 1419  
15:21:30 1420  PROCEDURE GET_OFFER_CHAINS_ELIGIBILITY (
15:21:30 1421  /*
15:21:30 1422  Throws exceptions (codes):
15:21:30 1423  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 1424  */
15:21:30 1425  	 in_offer_chain_ids  IN VARCHAR2,
15:21:30 1426  	 in_eligibility_name IN VARCHAR2,
15:21:30 1427  	 out_result_set      OUT SYS_REFCURSOR
15:21:30 1428  ) AS
15:21:30 1429  SPROC_NAME CONSTANT VARCHAR2(28) := 'GET_OFFER_CHAINS_ELIGIBILITY';
15:21:30 1430  -- VARIABLES
15:21:30 1431  var_eligibility_name OFFER_CHAIN_ELIGIBILITY.NAME%TYPE;
15:21:30 1432  BEGIN
15:21:30 1433  
15:21:30 1434  	 var_eligibility_name := UPPER(in_eligibility_name);
15:21:30 1435  
15:21:30 1436  	 -- TODO: Reveiw this procedure and fine a normal way to implement this feature
15:21:30 1437  
15:21:30 1438  	 open out_result_set for
15:21:30 1439  	 'SELECT
15:21:30 1440  	   ID,
15:21:30 1441  	   NAME,
15:21:30 1442  	   VALUE,
15:21:30 1443  	   OFFER_CHAIN_ID,
15:21:30 1444  	   CREATE_DATE,
15:21:30 1445  	   CREATED_BY
15:21:30 1446  	 FROM
15:21:30 1447  	   OFFER_CHAIN_ELIGIBILITY
15:21:30 1448  	 WHERE
15:21:30 1449  	   OFFER_CHAIN_ID in ( '|| in_offer_chain_ids ||' )
15:21:30 1450  	   AND UPPER(NAME) = :1'
15:21:30 1451  	 using var_eligibility_name;
15:21:30 1452  
15:21:30 1453  EXCEPTION
15:21:30 1454  WHEN OTHERS THEN
15:21:30 1455  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 1456  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 1457  END GET_OFFER_CHAINS_ELIGIBILITY;
15:21:30 1458  
15:21:30 1459  /******************************************************************************/
15:21:30 1460  
15:21:30 1461  PROCEDURE GET_OFFER_CHAINS_META_DATA (
15:21:30 1462  	 in_offer_chain_ids IN VARCHAR2,
15:21:30 1463  	 in_meta_data_name  IN VARCHAR2,
15:21:30 1464  	 out_result_set     OUT SYS_REFCURSOR
15:21:30 1465  ) AS
15:21:30 1466  SPROC_NAME CONSTANT VARCHAR2(28) := 'GET_OFFER_CHAINS_META_DATA';
15:21:30 1467  -- VARIABLES
15:21:30 1468  var_meta_data_name  OFFER_CHAIN_META_DATA.NAME%TYPE;
15:21:30 1469  BEGIN
15:21:30 1470  
15:21:30 1471  	 var_meta_data_name := UPPER(in_meta_data_name);
15:21:30 1472  
15:21:30 1473  	 open out_result_set for
15:21:30 1474  	 'select
15:21:30 1475  	   ID,
15:21:30 1476  	   NAME,
15:21:30 1477  	   VALUE,
15:21:30 1478  	   OFFER_CHAIN_ID,
15:21:30 1479  	   CREATED_BY,
15:21:30 1480  	   CREATE_DATE
15:21:30 1481  	 from
15:21:30 1482  	   OFFER_CHAIN_META_DATA
15:21:30 1483  	 where
15:21:30 1484  	   OFFER_CHAIN_ID in ( '||in_offer_chain_ids||' )
15:21:30 1485  	   and UPPER(OFFER_CHAIN_META_DATA.NAME) = :1'
15:21:30 1486  	 using var_meta_data_name;
15:21:30 1487  
15:21:30 1488  EXCEPTION
15:21:30 1489  WHEN OTHERS THEN
15:21:30 1490  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 1491  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 1492  END GET_OFFER_CHAINS_META_DATA;
15:21:30 1493  
15:21:30 1494  PROCEDURE GET_OFFER_CHAIN_META_DATA (
15:21:30 1495  /*
15:21:30 1496  Throws exceptions (codes):
15:21:30 1497  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30 1498  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 1499  */
15:21:30 1500  	 in_offer_chain_id IN NUMBER,
15:21:30 1501  	 in_meta_data_name IN VARCHAR2,
15:21:30 1502  	 out_result_set    OUT SYS_REFCURSOR
15:21:30 1503  ) AS
15:21:30 1504  SPROC_NAME CONSTANT VARCHAR2(27) := 'GET_OFFER_CHAIN_META_DATA';
15:21:30 1505  -- VARIABLES
15:21:30 1506  temp_offer_chain_id NUMBER;
15:21:30 1507  var_meta_data_name  OFFER_CHAIN_META_DATA.NAME%TYPE;
15:21:30 1508  -- EXCEPTIONS
15:21:30 1509  BAD_OFFER_CHAIN_ID EXCEPTION;
15:21:30 1510  BEGIN
15:21:30 1511  
15:21:30 1512  	 BEGIN
15:21:30 1513  	   SELECT
15:21:30 1514  	     OFFER_CHAIN.ID into temp_offer_chain_id
15:21:30 1515  	   FROM
15:21:30 1516  	     OFFER_CHAIN
15:21:30 1517  	   WHERE
15:21:30 1518  	     OFFER_CHAIN.ID = in_offer_chain_id;
15:21:30 1519  	   EXCEPTION
15:21:30 1520  	     WHEN NO_DATA_FOUND THEN
15:21:30 1521  	       RAISE BAD_OFFER_CHAIN_ID;
15:21:30 1522  	 END;
15:21:30 1523  
15:21:30 1524  	 var_meta_data_name := UPPER(in_meta_data_name);
15:21:30 1525  
15:21:30 1526  	 OPEN out_result_set FOR
15:21:30 1527  	 SELECT
15:21:30 1528  	   OFFER_CHAIN_META_DATA.ID,
15:21:30 1529  	   OFFER_CHAIN_META_DATA.NAME,
15:21:30 1530  	   OFFER_CHAIN_META_DATA.VALUE,
15:21:30 1531  	   OFFER_CHAIN_META_DATA.OFFER_CHAIN_ID,
15:21:30 1532  	   OFFER_CHAIN_META_DATA.CREATED_BY,
15:21:30 1533  	   OFFER_CHAIN_META_DATA.CREATE_DATE
15:21:30 1534  	 FROM
15:21:30 1535  	   OFFER_CHAIN_META_DATA
15:21:30 1536  	 WHERE
15:21:30 1537  	   OFFER_CHAIN_META_DATA.OFFER_CHAIN_ID = in_offer_chain_id
15:21:30 1538  	   AND UPPER(OFFER_CHAIN_META_DATA.NAME) = var_meta_data_name;
15:21:30 1539  
15:21:30 1540  EXCEPTION
15:21:30 1541  WHEN BAD_OFFER_CHAIN_ID THEN
15:21:30 1542  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 1543  	   SPROC_NAME, 'No such offer chain');
15:21:30 1544  WHEN OTHERS THEN
15:21:30 1545  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 1546  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 1547  END GET_OFFER_CHAIN_META_DATA;
15:21:30 1548  
15:21:30 1549  PROCEDURE GET_PROD_OFFERINGS_BY_OFFER_ID (
15:21:30 1550  /*
15:21:30 1551  Throws exceptions (codes):
15:21:30 1552  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30 1553  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 1554  */
15:21:30 1555  	 in_offer_id	IN NUMBER,
15:21:30 1556  	 out_result_set OUT SYS_REFCURSOR
15:21:30 1557  ) AS
15:21:30 1558  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_PROD_OFFERINGS_BY_OFFER_ID';
15:21:30 1559  -- VARIABLES
15:21:30 1560  temp_offer_id NUMBER;
15:21:30 1561  -- EXCEPTIONS
15:21:30 1562  BAD_OFFER_ID EXCEPTION;
15:21:30 1563  BEGIN
15:21:30 1564  
15:21:30 1565  	 BEGIN
15:21:30 1566  	   SELECT
15:21:30 1567  	     OFFER.ID into temp_offer_id
15:21:30 1568  	   FROM
15:21:30 1569  	     OFFER
15:21:30 1570  	   WHERE
15:21:30 1571  	     OFFER.ID = in_offer_id;
15:21:30 1572  	   EXCEPTION
15:21:30 1573  	     WHEN NO_DATA_FOUND THEN
15:21:30 1574  	       RAISE BAD_OFFER_ID;
15:21:30 1575  	 END;
15:21:30 1576  
15:21:30 1577  	 OPEN out_result_set FOR
15:21:30 1578  	 SELECT DISTINCT
15:21:30 1579  	   PRODUCT_OFFERING.ID,
15:21:30 1580  	   PRODUCT_OFFERING.PRODUCT_ID,
15:21:30 1581  	   PRODUCT_OFFERING.TAX_CATEGORY_ID,
15:21:30 1582  	   PRODUCT_OFFERING.UNIT_PRICE,
15:21:30 1583  	   PRODUCT_OFFERING.QUANTITY,
15:21:30 1584  	   PRODUCT_OFFERING.CREATE_DATE,
15:21:30 1585  	   PRODUCT_OFFERING.CREATED_BY,
15:21:30 1586  	   CAPABILITY.ID CAP_ID,
15:21:30 1587  	   CAPABILITY.CODE CAP_CODE,
15:21:30 1588  	   CAPABILITY.DESCRIPTION CAP_DESCRIPTION,
15:21:30 1589  	   CAPABILITY.SHAREABLE CAP_SHAREABLE
15:21:30 1590  	 FROM
15:21:30 1591  	   OFFER_PRODUCT_OFFERING
15:21:30 1592  	   INNER JOIN PRODUCT_OFFERING ON PRODUCT_OFFERING.ID = OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID
15:21:30 1593  	   INNER JOIN CAPABILITY ON PRODUCT_OFFERING.CAPABILITY_ID = CAPABILITY.ID
15:21:30 1594  	 WHERE
15:21:30 1595  	   OFFER_PRODUCT_OFFERING.OFFER_ID = in_offer_id;
15:21:30 1596  
15:21:30 1597  EXCEPTION
15:21:30 1598  WHEN BAD_OFFER_ID THEN
15:21:30 1599  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 1600  	   SPROC_NAME, 'No such offer');
15:21:30 1601  WHEN OTHERS THEN
15:21:30 1602  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 1603  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 1604  END GET_PROD_OFFERINGS_BY_OFFER_ID;
15:21:30 1605  
15:21:30 1606  PROCEDURE GET_PRODUCT_OFFERING_META_DATA (
15:21:30 1607  /*
15:21:30 1608  Throws exceptions (codes):
15:21:30 1609  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:30 1610  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 1611  */
15:21:30 1612  	 in_product_offering_id IN NUMBER,
15:21:30 1613  	 in_meta_data_name	IN VARCHAR2 DEFAULT NULL,
15:21:30 1614  	 out_result_set 	OUT SYS_REFCURSOR
15:21:30 1615  ) AS
15:21:30 1616  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_PRODUCT_OFFERING_META_DATA';
15:21:30 1617  -- VARIABLES
15:21:30 1618  temp_product_offering_id NUMBER;
15:21:30 1619  -- EXCEPTIONS
15:21:30 1620  BAD_PRODUCT_OFFERING_ID EXCEPTION;
15:21:30 1621  BEGIN
15:21:30 1622  
15:21:30 1623  	 BEGIN
15:21:30 1624  	   SELECT
15:21:30 1625  	     PRODUCT_OFFERING.ID into temp_product_offering_id
15:21:30 1626  	   FROM
15:21:30 1627  	     PRODUCT_OFFERING
15:21:30 1628  	   WHERE
15:21:30 1629  	     PRODUCT_OFFERING.ID = in_product_offering_id;
15:21:30 1630  	   EXCEPTION
15:21:30 1631  	     WHEN NO_DATA_FOUND THEN
15:21:30 1632  	       RAISE BAD_PRODUCT_OFFERING_ID;
15:21:30 1633  	 END;
15:21:30 1634  
15:21:30 1635  	 OPEN out_result_set FOR
15:21:30 1636  	 SELECT
15:21:30 1637  	   PRODUCT_OFFERING_META_DATA.ID,
15:21:30 1638  	   PRODUCT_OFFERING_META_DATA.NAME,
15:21:30 1639  	   PRODUCT_OFFERING_META_DATA.VALUE,
15:21:30 1640  	   PRODUCT_OFFERING_META_DATA.PRODUCT_OFFERING_ID,
15:21:30 1641  	   PRODUCT_OFFERING_META_DATA.CREATE_DATE,
15:21:30 1642  	   PRODUCT_OFFERING_META_DATA.CREATED_BY
15:21:30 1643  	 FROM
15:21:30 1644  	   PRODUCT_OFFERING_META_DATA
15:21:30 1645  	 WHERE
15:21:30 1646  	   PRODUCT_OFFERING_META_DATA.PRODUCT_OFFERING_ID = in_product_offering_id
15:21:30 1647  	   AND UPPER(PRODUCT_OFFERING_META_DATA.NAME) = UPPER(NVL(in_meta_data_name, PRODUCT_OFFERING_META_DATA.NAME));
15:21:30 1648  
15:21:30 1649  EXCEPTION
15:21:30 1650  WHEN BAD_PRODUCT_OFFERING_ID THEN
15:21:30 1651  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 1652  	   SPROC_NAME, 'No such product offering');
15:21:30 1653  END GET_PRODUCT_OFFERING_META_DATA;
15:21:30 1654  
15:21:30 1655  /******************************************************************************/
15:21:30 1656  
15:21:30 1657  PROCEDURE GET_OFF_CHAINS_SAME_PRODUCTS (
15:21:30 1658  /*
15:21:30 1659  Throws exceptions (codes):
15:21:30 1660  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:30 1661  */
15:21:30 1662  	 in_offer_chain_1 IN NUMBER,
15:21:30 1663  	 in_offer_chain_2 IN NUMBER,
15:21:30 1664  	 out_result_set   OUT SYS_REFCURSOR
15:21:30 1665  ) AS
15:21:30 1666  BEGIN
15:21:30 1667  
15:21:30 1668  	 OPEN out_result_set FOR
15:21:30 1669  	 SELECT
15:21:30 1670  	   PRODUCT_ID_IN_OFFER_CH_1 AS "PRODUCT_ID",
15:21:30 1671  	   COUNT_1 + COUNT_2	    AS "COUNT"
15:21:30 1672  	 FROM
15:21:30 1673  	   (
15:21:30 1674  	     SELECT
15:21:30 1675  	       PRODUCT_OFFERING.PRODUCT_ID as "PRODUCT_ID_IN_OFFER_CH_1",
15:21:30 1676  	       COUNT(*) 		   as "COUNT_1"
15:21:30 1677  	     FROM
15:21:30 1678  	       (
15:21:30 1679  		 SELECT OFFER_ID as "OFFER_OFFER_CHAIN_OFFER_ID" FROM OFFER_OFFER_CHAIN WHERE OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_1
15:21:30 1680  	       )
15:21:30 1681  	       INNER JOIN OFFER_PRODUCT_OFFERING ON OFFER_OFFER_CHAIN_OFFER_ID = OFFER_PRODUCT_OFFERING.OFFER_ID
15:21:30 1682  	       INNER JOIN PRODUCT_OFFERING ON OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = PRODUCT_OFFERING.ID
15:21:30 1683  	     GROUP BY
15:21:30 1684  	       PRODUCT_OFFERING.PRODUCT_ID
15:21:30 1685  	   )
15:21:30 1686  	   INNER JOIN
15:21:30 1687  	   (
15:21:30 1688  	     SELECT
15:21:30 1689  	       PRODUCT_OFFERING.PRODUCT_ID as "PRODUCT_ID_IN_OFFER_CH_2",
15:21:30 1690  	       COUNT(*) 		   as "COUNT_2"
15:21:30 1691  	     FROM
15:21:30 1692  	       (
15:21:30 1693  		 SELECT OFFER_ID as "OFFER_OFFER_CHAIN_OFFER_ID" FROM OFFER_OFFER_CHAIN WHERE OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_2
15:21:30 1694  	       )
15:21:30 1695  	       INNER JOIN OFFER_PRODUCT_OFFERING ON OFFER_OFFER_CHAIN_OFFER_ID = OFFER_PRODUCT_OFFERING.OFFER_ID
15:21:30 1696  	       INNER JOIN PRODUCT_OFFERING ON OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = PRODUCT_OFFERING.ID
15:21:30 1697  	     GROUP BY
15:21:30 1698  	       PRODUCT_OFFERING.PRODUCT_ID
15:21:30 1699  	   ) ON PRODUCT_ID_IN_OFFER_CH_1 = PRODUCT_ID_IN_OFFER_CH_2;
15:21:30 1700  
15:21:30 1701  END GET_OFF_CHAINS_SAME_PRODUCTS;
15:21:30 1702  
15:21:30 1703  /******************************************************************************/
15:21:30 1704  
15:21:30 1705  PROCEDURE GET_OFFER_CHAIN_MD_VALUE (
15:21:30 1706  	 in_offer_chain_id IN NUMBER,
15:21:30 1707  	 in_meta_data_name IN VARCHAR2,
15:21:30 1708  	 out_value	   OUT VARCHAR2
15:21:30 1709  ) AS
15:21:30 1710  BEGIN
15:21:30 1711  	 BEGIN
15:21:30 1712  	   SELECT
15:21:30 1713  	     OFFER_CHAIN_META_DATA.VALUE into out_value
15:21:30 1714  	   FROM
15:21:30 1715  	     OFFER_CHAIN_META_DATA
15:21:30 1716  	   WHERE
15:21:30 1717  	     OFFER_CHAIN_META_DATA.OFFER_CHAIN_ID = in_offer_chain_id
15:21:30 1718  	     AND UPPER(OFFER_CHAIN_META_DATA.NAME) = UPPER(in_meta_data_name);
15:21:30 1719  
15:21:30 1720  	   EXCEPTION
15:21:30 1721  	     WHEN NO_DATA_FOUND THEN
15:21:30 1722  	       out_value := NULL;
15:21:30 1723  	 END;
15:21:30 1724  END GET_OFFER_CHAIN_MD_VALUE;
15:21:30 1725  
15:21:30 1726  /******************************************************************************/
15:21:30 1727  
15:21:30 1728  PROCEDURE GET_OFFER_CHAIN_EL_VALUE (
15:21:30 1729  	 in_offer_chain_id   IN NUMBER,
15:21:30 1730  	 in_eligibility_name IN VARCHAR2,
15:21:30 1731  	 out_value	     OUT VARCHAR2
15:21:30 1732  ) AS
15:21:30 1733  BEGIN
15:21:30 1734  	 BEGIN
15:21:30 1735  	   SELECT
15:21:30 1736  	     OFFER_CHAIN_ELIGIBILITY.VALUE into out_value
15:21:30 1737  	   FROM
15:21:30 1738  	     OFFER_CHAIN_ELIGIBILITY
15:21:30 1739  	   WHERE
15:21:30 1740  	     OFFER_CHAIN_ELIGIBILITY.OFFER_CHAIN_ID = in_offer_chain_id
15:21:30 1741  	     AND UPPER(OFFER_CHAIN_ELIGIBILITY.NAME) = UPPER(in_eligibility_name);
15:21:30 1742  
15:21:30 1743  	   EXCEPTION
15:21:30 1744  	     WHEN NO_DATA_FOUND THEN
15:21:30 1745  	       out_value := NULL;
15:21:30 1746  	 END;
15:21:30 1747  END GET_OFFER_CHAIN_EL_VALUE;
15:21:30 1748  
15:21:30 1749  PROCEDURE GET_OFFER_PRODUCT_OFFERINGS (
15:21:30 1750  	 in_offer_id	IN NUMBER,
15:21:30 1751  	 out_result_set OUT SYS_REFCURSOR
15:21:30 1752  ) AS
15:21:30 1753  SPROC_NAME CONSTANT VARCHAR2(27) := 'GET_OFFER_PRODUCT_OFFERINGS';
15:21:30 1754  -- VARIABLES
15:21:30 1755  temp_offer_id NUMBER;
15:21:30 1756  -- EXCEPTIONS
15:21:30 1757  BAD_OFFER_ID EXCEPTION;
15:21:30 1758  BEGIN
15:21:30 1759  
15:21:30 1760  	 BEGIN
15:21:30 1761  	   SELECT
15:21:30 1762  	     OFFER.ID into temp_offer_id
15:21:30 1763  	   FROM
15:21:30 1764  	     OFFER
15:21:30 1765  	   WHERE
15:21:30 1766  	     OFFER.ID = in_offer_id;
15:21:30 1767  	   EXCEPTION
15:21:30 1768  	     WHEN NO_DATA_FOUND THEN
15:21:30 1769  	       RAISE BAD_OFFER_ID;
15:21:30 1770  	 END;
15:21:30 1771  
15:21:30 1772  	 OPEN out_result_set FOR
15:21:30 1773  	 SELECT
15:21:30 1774  	   PRODUCT_OFFERING.ID,
15:21:30 1775  	   PRODUCT_OFFERING.PRODUCT_ID,
15:21:30 1776  	   PRODUCT_OFFERING.TAX_CATEGORY_ID,
15:21:30 1777  	   PRODUCT_OFFERING.UNIT_PRICE,
15:21:30 1778  	   PRODUCT_OFFERING.QUANTITY,
15:21:30 1779  	   PRODUCT_OFFERING.CREATE_DATE,
15:21:30 1780  	   PRODUCT_OFFERING.CREATED_BY,
15:21:30 1781  	   PRODUCT_OFFERING.TAX_POLICY_TYPE_ID
15:21:30 1782  	 FROM
15:21:30 1783  	   PRODUCT_OFFERING
15:21:30 1784  	   INNER JOIN OFFER_PRODUCT_OFFERING ON PRODUCT_OFFERING.ID = OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID
15:21:30 1785  	 WHERE
15:21:30 1786  	   OFFER_PRODUCT_OFFERING.OFFER_ID = in_offer_id;
15:21:30 1787  
15:21:30 1788  EXCEPTION
15:21:30 1789  WHEN BAD_OFFER_ID THEN
15:21:30 1790  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 1791  	   SPROC_NAME, 'No such offer');
15:21:30 1792  WHEN OTHERS THEN
15:21:30 1793  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 1794  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 1795  END GET_OFFER_PRODUCT_OFFERINGS;
15:21:30 1796  
15:21:30 1797  /******************************************************************************/
15:21:30 1798  
15:21:30 1799  PROCEDURE GET_OFFER_CHAINS_BY_META_DATA (
15:21:30 1800  	 in_meta_data_name  IN VARCHAR2,
15:21:30 1801  	 in_meta_data_value IN VARCHAR2,
15:21:30 1802  	 out_result_set     OUT SYS_REFCURSOR
15:21:30 1803  ) AS
15:21:30 1804  SPROC_NAME CONSTANT VARCHAR2(29) := 'GET_OFFER_CHAINS_BY_META_DATA';
15:21:30 1805  -- VARIABLES
15:21:30 1806  v_meta_data_name  CONSTANT OFFER_CHAIN_META_DATA.NAME%TYPE  := UPPER(in_meta_data_name);
15:21:30 1807  v_meta_data_value CONSTANT OFFER_CHAIN_META_DATA.VALUE%TYPE := UPPER(in_meta_data_value);
15:21:30 1808  BEGIN
15:21:30 1809  
15:21:30 1810  	 OPEN out_result_set FOR
15:21:30 1811  	 SELECT
15:21:30 1812  	   och.ID,
15:21:30 1813  	   och.NAME,
15:21:30 1814  	   och.DESCRIPTION,
15:21:30 1815  	   och.OFFER_CHAIN_STATUS_ID,
15:21:30 1816  	   PROCS_OFFER_CHAIN_V18.CALCULATE_OFFER_CHAIN_AMOUNT(och.id) as amount,
15:21:30 1817  	   och.ADOPTABILITY_WINDOW_START_DATE,
15:21:30 1818  	   och.ADOPTABILITY_WINDOW_END_DATE,
15:21:30 1819  	   PROCS_OFFER_CHAIN_V18.IS_OFFER_CHAIN_CANCELABLE(och.id) as is_cancelable,
15:21:30 1820  	   och.IS_GIFT_CERTIFICATE,
15:21:30 1821  	   'false' as comf_offer_chain, -- TODO
15:21:30 1822  	   po.PRODUCT_ID,
15:21:30 1823  	   och.GROUP_ACCOUNT_TYPE_ID
15:21:30 1824  	 FROM
15:21:30 1825  	   OFFER_CHAIN och,
15:21:30 1826  	   OFFER_OFFER_CHAIN ooch,
15:21:30 1827  	   OFFER_PRODUCT_OFFERING opo,
15:21:30 1828  	   PRODUCT_OFFERING po
15:21:30 1829  	 WHERE
15:21:30 1830  	   och.ID = ooch.OFFER_CHAIN_ID
15:21:30 1831  	   and ooch.OFFER_ID = opo.OFFER_ID
15:21:30 1832  	   and opo.PRODUCT_OFFERING_ID = po.ID
15:21:30 1833  	   and och.OFFER_CHAIN_STATUS_ID = GLOBAL_STATUSES_V18.OFFER_CHAIN_ACTIVE
15:21:30 1834  	   and och.id in (
15:21:30 1835  	     SELECT DISTINCT
15:21:30 1836  	       och2.id
15:21:30 1837  	     from
15:21:30 1838  	       offer_chain och2
15:21:30 1839  	       inner join offer_chain_meta_data ochmd on och2.id = ochmd.offer_chain_id
15:21:30 1840  	     where
15:21:30 1841  	       UPPER(ochmd.name) = v_meta_data_name
15:21:30 1842  	       AND UPPER(ochmd.value) = v_meta_data_value
15:21:30 1843  	   );
15:21:30 1844  
15:21:30 1845  EXCEPTION
15:21:30 1846  WHEN OTHERS THEN
15:21:30 1847  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 1848  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 1849  END GET_OFFER_CHAINS_BY_META_DATA;
15:21:30 1850  
15:21:30 1851  /******************************************************************************/
15:21:30 1852  
15:21:30 1853  PROCEDURE GET_ALL_META_DATA (
15:21:30 1854  	 in_offer_chain_id IN NUMBER,
15:21:30 1855  	 out_result_set    OUT SYS_REFCURSOR
15:21:30 1856  ) AS
15:21:30 1857  SPROC_NAME CONSTANT VARCHAR2(17) := 'GET_ALL_META_DATA';
15:21:30 1858  -- Variables
15:21:30 1859  temp_offer_chain_id NUMBER;
15:21:30 1860  -- Exceptions
15:21:30 1861  BAD_OFFER_CHAIN_ID EXCEPTION;
15:21:30 1862  BEGIN
15:21:30 1863  
15:21:30 1864  	 BEGIN
15:21:30 1865  	   SELECT
15:21:30 1866  	     OCH.ID into temp_offer_chain_id
15:21:30 1867  	   FROM
15:21:30 1868  	     OFFER_CHAIN OCH
15:21:30 1869  	   WHERE
15:21:30 1870  	     OCH.ID = in_offer_chain_id;
15:21:30 1871  	   EXCEPTION
15:21:30 1872  	     WHEN NO_DATA_FOUND THEN
15:21:30 1873  	       RAISE BAD_OFFER_CHAIN_ID;
15:21:30 1874  	 END;
15:21:30 1875  
15:21:30 1876  	 OPEN out_result_set FOR
15:21:30 1877  	 SELECT
15:21:30 1878  	   OCHMD.ID,
15:21:30 1879  	   OCHMD.OFFER_CHAIN_ID,
15:21:30 1880  	   OCHMD.NAME,
15:21:30 1881  	   OCHMD.VALUE,
15:21:30 1882  	   OCHMD.CREATE_DATE,
15:21:30 1883  	   OCHMD.CREATED_BY
15:21:30 1884  	 FROM
15:21:30 1885  	   OFFER_CHAIN_META_DATA OCHMD
15:21:30 1886  	 WHERE
15:21:30 1887  	   OCHMD.OFFER_CHAIN_ID = in_offer_chain_id;
15:21:30 1888  
15:21:30 1889  EXCEPTION
15:21:30 1890  WHEN BAD_OFFER_CHAIN_ID THEN
15:21:30 1891  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 1892  	   SPROC_NAME, 'No such offer chain', SQLERRM);
15:21:30 1893  WHEN OTHERS THEN
15:21:30 1894  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 1895  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 1896  END GET_ALL_META_DATA;
15:21:30 1897  
15:21:30 1898  PROCEDURE CHECK_PRODUCT_ELIGIBILITY (
15:21:30 1899  	 in_group_id	   IN NUMBER,
15:21:30 1900  	 in_offer_chain_id IN NUMBER,
15:21:30 1901  	 out_is_eligible   OUT NUMBER,
15:21:30 1902  	 out_concurrent_subscription_id OUT NUMBER
15:21:30 1903  ) AS
15:21:30 1904  SPROC_NAME CONSTANT VARCHAR2(25) := 'CHECK_PRODUCT_ELIGIBILITY';
15:21:30 1905  -- Variables
15:21:30 1906  var_account_id  NUMBER;
15:21:30 1907  var_is_eligible NUMBER;
15:21:30 1908  var_is_gc       NUMBER;
15:21:30 1909  -- Exceptions
15:21:30 1910  BAD_GROUP_ID		   EXCEPTION;
15:21:30 1911  CAN_NOT_CHECK_SAME_PRODUCTS EXCEPTION;
15:21:30 1912  BAD_OC_ID		   EXCEPTION;
15:21:30 1913  EXCEPTION_MESSAGE	   VARCHAR(1024);
15:21:30 1914  BEGIN
15:21:30 1915  
15:21:30 1916  	 var_is_eligible := GLOBAL_CONSTANTS_V18.TRUE;
15:21:30 1917  
15:21:30 1918  	 out_concurrent_subscription_id := NULL;
15:21:30 1919  
15:21:30 1920  	 BEGIN
15:21:30 1921  	   SELECT
15:21:30 1922  	     OC.IS_GIFT_CERTIFICATE into var_is_gc
15:21:30 1923  	   FROM
15:21:30 1924  	     OFFER_CHAIN OC
15:21:30 1925  	   WHERE
15:21:30 1926  	     OC.ID = in_offer_chain_id;
15:21:30 1927  	   EXCEPTION
15:21:30 1928  	     WHEN NO_DATA_FOUND THEN
15:21:30 1929  	       RAISE BAD_OC_ID;
15:21:30 1930  	 END;
15:21:30 1931  
15:21:30 1932  	 -- only check eligibility if this is not a gift certificate
15:21:30 1933  	 IF (var_is_gc IS NULL OR var_is_gc != 1) THEN
15:21:30 1934  	   BEGIN
15:21:30 1935  	     SELECT
15:21:30 1936  	       A.ID into var_account_id
15:21:30 1937  	     FROM
15:21:30 1938  	       ACCOUNT A
15:21:30 1939  	     WHERE
15:21:30 1940  	       A.GROUP_ID = in_group_id;
15:21:30 1941  	     EXCEPTION
15:21:30 1942  	       WHEN NO_DATA_FOUND THEN
15:21:30 1943  		 RAISE BAD_GROUP_ID;
15:21:30 1944  	   END;
15:21:30 1945  
15:21:30 1946  
15:21:30 1947  	   FOR f_offer_chain IN (
15:21:30 1948  	       SELECT
15:21:30 1949  		 S.ID as SUBSCRIPTION_ID,
15:21:30 1950  		 S.OFFER_CHAIN_ID
15:21:30 1951  	       FROM
15:21:30 1952  		 SUBSCRIPTION S
15:21:30 1953  	       WHERE
15:21:30 1954  		 S.ACCOUNT_ID = var_account_id
15:21:30 1955  		 AND (S.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE
15:21:30 1956  		      OR S.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_IN_GRACE_PERIOD)
15:21:30 1957  	   )
15:21:30 1958  	   LOOP
15:21:30 1959  	     BEGIN
15:21:30 1960  	       IF (
15:21:30 1961  		 PROCS_OFFER_CHAIN_V18.CHECK_FOR_SAME_PRODUCTS(
15:21:30 1962  		   in_offer_chain_id,
15:21:30 1963  		   f_offer_chain.offer_chain_id,
15:21:30 1964  		   GLOBAL_CONSTANTS_V18.TRUE
15:21:30 1965  		 ) = GLOBAL_CONSTANTS_V18.TRUE
15:21:30 1966  	       ) THEN
15:21:30 1967  		 var_is_eligible := GLOBAL_CONSTANTS_V18.FALSE;
15:21:30 1968  		 out_concurrent_subscription_id := f_offer_chain.SUBSCRIPTION_ID;
15:21:30 1969  	       END IF;
15:21:30 1970  	       EXCEPTION
15:21:30 1971  		 WHEN OTHERS THEN
15:21:30 1972  		   EXCEPTION_MESSAGE := SQLERRM;
15:21:30 1973  		   RAISE CAN_NOT_CHECK_SAME_PRODUCTS;
15:21:30 1974  	     END;
15:21:30 1975  	   END LOOP;
15:21:30 1976  	 END IF;
15:21:30 1977  	 out_is_eligible := var_is_eligible;
15:21:30 1978  
15:21:30 1979  EXCEPTION
15:21:30 1980  WHEN BAD_GROUP_ID THEN
15:21:30 1981  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 1982  	   SPROC_NAME, 'No such offer chain', SQLERRM);
15:21:30 1983  WHEN BAD_OC_ID THEN
15:21:30 1984  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:30 1985  	   SPROC_NAME, 'No such offer chain', SQLERRM);
15:21:30 1986  WHEN CAN_NOT_CHECK_SAME_PRODUCTS THEN
15:21:30 1987  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:30 1988  	   SPROC_NAME, 'Could not check offers for same products', EXCEPTION_MESSAGE);
15:21:30 1989  WHEN OTHERS THEN
15:21:30 1990  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 1991  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 1992  END CHECK_PRODUCT_ELIGIBILITY;
15:21:30 1993  
15:21:30 1994  PROCEDURE GET_NOTIFICATION_TYPE_ID (
15:21:30 1995  	 in_offer_chain_id	  IN NUMBER,
15:21:30 1996  	 in_action_name 	  IN VARCHAR2,
15:21:30 1997  	 out_notification_type_id OUT NUMBER
15:21:30 1998  ) AS
15:21:30 1999  SPROC_NAME CONSTANT VARCHAR2(28) := 'GET_NOTIFICATION_TEMPLATE_ID';
15:21:30 2000  -- Variables
15:21:30 2001  var_action_id NUMBER;
15:21:30 2002  -- Exceptions
15:21:30 2003  BAD_ACTION_NAME	      EXCEPTION;
15:21:30 2004  MULTIPLY_ACTIONS_FOUND EXCEPTION;
15:21:30 2005  BEGIN
15:21:30 2006  
15:21:30 2007  	 BEGIN
15:21:30 2008  	   SELECT
15:21:30 2009  	     A.ID into var_action_id
15:21:30 2010  	   FROM
15:21:30 2011  	     ACTION A
15:21:30 2012  	   WHERE
15:21:30 2013  	     UPPER(A.NAME) = UPPER(in_action_name);
15:21:30 2014  	   EXCEPTION
15:21:30 2015  	     WHEN NO_DATA_FOUND THEN
15:21:30 2016  	       RAISE BAD_ACTION_NAME;
15:21:30 2017  	     WHEN TOO_MANY_ROWS THEN
15:21:30 2018  	       RAISE MULTIPLY_ACTIONS_FOUND;
15:21:30 2019  	 END;
15:21:30 2020  
15:21:30 2021  	 SELECT
15:21:30 2022  	   OCNT.NOTIFICATION_TYPE_ID into out_notification_type_id
15:21:30 2023  	 FROM
15:21:30 2024  	   OFFER_CHAIN_NOTIFICATION_TYPE OCNT
15:21:30 2025  	 WHERE
15:21:30 2026  	   OCNT.OFFER_CHAIN_ID = in_offer_chain_id
15:21:30 2027  	   AND OCNT.ACTION_ID = var_action_id;
15:21:30 2028  
15:21:30 2029  EXCEPTION
15:21:30 2030  WHEN NO_DATA_FOUND THEN
15:21:30 2031  	 out_notification_type_id := NULL;
15:21:30 2032  WHEN BAD_ACTION_NAME THEN
15:21:30 2033  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:30 2034  	   SPROC_NAME, 'Bad action name', SQLERRM);
15:21:30 2035  WHEN MULTIPLY_ACTIONS_FOUND THEN
15:21:30 2036  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:30 2037  	   SPROC_NAME, 'Found more then one action with given name', SQLERRM);
15:21:30 2038  WHEN OTHERS THEN
15:21:30 2039  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:30 2040  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:30 2041  END GET_NOTIFICATION_TYPE_ID;
15:21:30 2042  
15:21:30 2043  END PROCS_OFFER_CHAIN_V18;
15:21:30 2044  .
15:21:30 SQL> /

Package body created.

Elapsed: 00:00:00.14
15:21:30 SQL> 
15:21:30 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_POLLING_SYNC"
15:21:30   2  AS
15:21:30   3  	  --------------------------------------------------------------------------------
15:21:30   4  PROCEDURE GATHER_SYNC_EVENTS
15:21:30   5  	  (
15:21:30   6  	      in_last_timestamp TIMESTAMP,
15:21:30   7  	      out_new_timestamp OUT TIMESTAMP)
15:21:30   8  IS
15:21:30   9  BEGIN
15:21:30  10  	  out_new_timestamp := systimestamp;
15:21:30  11  	  GATHER_SYNC_EVENTS_RANGE(in_last_timestamp, out_new_timestamp, (3 / 24 / 60));
15:21:30  12  END;
15:21:30  13  	  --------------------------------------------------------------------------------
15:21:30  14  PROCEDURE GATHER_SYNC_EVENTS_RANGE(in_start_ts timestamp, in_end_ts timestamp, in_offset number)
15:21:30  15  IS
15:21:30  16  BEGIN
15:21:30  17  	  INSERT
15:21:30  18  	  INTO
15:21:30  19  	      core_owner.polling_sync
15:21:31  20  	      (
15:21:31  21  		  account_id,
15:21:31  22  		  group_id,
15:21:31  23  		  event_type,
15:21:31  24  		  event_date
15:21:31  25  	      )
15:21:31  26  	  select id, group_id, event_type, event_date from (
15:21:31  27  	      SELECT
15:21:31  28  		  a.id,
15:21:31  29  		  a.group_id,
15:21:31  30  		  'I' event_type,
15:21:31  31  		  in_end_ts event_date,
15:21:31  32  		  max(cl.change_time) last_change_time
15:21:31  33  	      FROM
15:21:31  34  		  core_hist_owner.change_log cl,
15:21:31  35  		  core_owner.credit_card cc,
15:21:31  36  		  core_owner.account a
15:21:31  37  	      WHERE
15:21:31  38  		  cl.change_time between in_start_ts-in_offset and in_end_ts
15:21:31  39  	      AND cl.item = 'CREDIT_CARD'
15:21:31  40  	      AND cl.id = cc.id
15:21:31  41  	      AND cc.account_id = a.id
15:21:31  42  	      GROUP BY a.id, a.group_id
15:21:31  43  	      UNION ALL
15:21:31  44  	      SELECT
15:21:31  45  		  a.id,
15:21:31  46  		  a.group_id,
15:21:31  47  		  'I',
15:21:31  48  		  in_end_ts,
15:21:31  49  		  max(cl.change_time) last_change_time
15:21:31  50  	      FROM
15:21:31  51  		  core_hist_owner.change_log cl,
15:21:31  52  		  core_owner.paypal p,
15:21:31  53  		  core_owner.account a
15:21:31  54  	      WHERE
15:21:31  55  		  cl.change_time between in_start_ts-in_offset and in_end_ts
15:21:31  56  	      AND cl.item = 'PAYPAL'
15:21:31  57  	      AND cl.id = p.id
15:21:31  58  	      AND p.account_id = a.id
15:21:31  59  	      GROUP BY a.id, a.group_id
15:21:31  60  	      UNION ALL
15:21:31  61  	      SELECT
15:21:31  62  		  a.id,
15:21:31  63  		  a.group_id,
15:21:31  64  		  'S',
15:21:31  65  		  in_end_ts,
15:21:31  66  		  max(cl.change_time) last_change_time
15:21:31  67  	      FROM
15:21:31  68  		  core_hist_owner.change_log cl,
15:21:31  69  		  core_owner.subscription s,
15:21:31  70  		  core_owner.account a
15:21:31  71  	      WHERE
15:21:31  72  		  cl.change_time between in_start_ts-in_offset and in_end_ts
15:21:31  73  	      AND cl.item = 'SUBSCRIPTION'
15:21:31  74  	      AND cl.id = s.id
15:21:31  75  	      AND s.account_id = a.id
15:21:31  76  	      GROUP BY a.id, a.group_id
15:21:31  77  	      UNION ALL
15:21:31  78  	      SELECT
15:21:31  79  		  a.id,
15:21:31  80  		  a.group_id,
15:21:31  81  		  'G',
15:21:31  82  		  in_end_ts,
15:21:31  83  		  max(cl.change_time) last_change_time
15:21:31  84  	      FROM
15:21:31  85  		  core_hist_owner.change_log cl,
15:21:31  86  		  core_owner.gift_certificate gc,
15:21:31  87  		  core_owner.account a
15:21:31  88  	      WHERE
15:21:31  89  		  cl.change_time between in_start_ts-in_offset and in_end_ts
15:21:31  90  	      AND cl.item = 'GIFT_CERTIFICATE'
15:21:31  91  	      AND cl.id = gc.id
15:21:31  92  	      AND gc.purchaser_group_id = a.group_id
15:21:31  93  	      GROUP BY a.id, a.group_id
15:21:31  94  	  ) t
15:21:31  95  	  where not exists (
15:21:31  96  	      select 1 --ps.account_id, ps.group_id, ps.event_type
15:21:31  97  	      from polling_sync ps
15:21:31  98  	      where ps.account_id = t.id
15:21:31  99  		and ps.group_id = t.group_id
15:21:31 100  		and ps.event_type = t.event_type
15:21:31 101  		and ps.event_date >= t.last_change_time
15:21:31 102  	  )
15:21:31 103  	  ;
15:21:31 104  END;
15:21:31 105  --------------------------------------------------------------------------------
15:21:31 106  FUNCTION CREATE_NEW_TRANSFER_SET
15:21:31 107  	  (
15:21:31 108  	      in_set_maximum NUMBER)
15:21:31 109  	  RETURN core_owner.polling_sync.set_id%type
15:21:31 110  IS
15:21:31 111  	  pragma autonomous_transaction;
15:21:31 112  	  v_set_id core_owner.polling_sync.set_id%type;
15:21:31 113  BEGIN
15:21:31 114  	  SELECT
15:21:31 115  	      pollsync_setid_seq.nextval
15:21:31 116  	  INTO
15:21:31 117  	      v_set_id
15:21:31 118  	  FROM
15:21:31 119  	      dual;
15:21:31 120  	  update
15:21:31 121  	    core_owner.polling_sync ps
15:21:31 122  	  set
15:21:31 123  	    ps.set_id = v_set_id
15:21:31 124  	  where
15:21:31 125  	    ps.set_id IS NULL and
15:21:31 126  	    rownum <= in_set_maximum
15:21:31 127  	  ;
15:21:31 128  	  COMMIT;
15:21:31 129  	  RETURN v_set_id;
15:21:31 130  END;
15:21:31 131  --------------------------------------------------------------------------------
15:21:31 132  FUNCTION RETREIVE_TRANSFER_SET
15:21:31 133  	  (
15:21:31 134  	      in_set_id core_owner.polling_sync.set_id%type)
15:21:31 135  	  RETURN sys_refcursor
15:21:31 136  IS
15:21:31 137  	  v_refcursor sys_refcursor;
15:21:31 138  BEGIN
15:21:31 139  	  UPDATE
15:21:31 140  	      core_owner.polling_sync ps
15:21:31 141  	  SET
15:21:31 142  	      ps.last_send_date = sysdate,
15:21:31 143  	      ps.num_calls = ps.num_calls + 1
15:21:31 144  	  WHERE
15:21:31 145  	      ps.set_id = in_set_id ;
15:21:31 146  	  OPEN v_refcursor FOR
15:21:31 147  	  SELECT
15:21:31 148  	      ps.set_id,
15:21:31 149  	      ps.group_id,
15:21:31 150  	      ps.event_type,
15:21:31 151  	      ps.event_date
15:21:31 152  	  FROM
15:21:31 153  	      core_owner.polling_sync ps
15:21:31 154  	  WHERE
15:21:31 155  	      ps.set_id = in_set_id
15:21:31 156  	  AND ps.group_id IS NOT NULL ;
15:21:31 157  	  RETURN v_refcursor;
15:21:31 158  END;
15:21:31 159  --------------------------------------------------------------------------------
15:21:31 160  PROCEDURE GET_TRANSFER_SET
15:21:31 161  	  (
15:21:31 162  	      in_set_maximum NUMBER,
15:21:31 163  	      in_max_retries NUMBER,
15:21:31 164  	      out_refcursor OUT sys_refcursor)
15:21:31 165  IS
15:21:31 166  	  v_set_id core_owner.polling_sync.set_id%type;
15:21:31 167  BEGIN
15:21:31 168  	  /* Look for previously sent but unconfirmed sets and
15:21:31 169  	  send again until max_retries calls */
15:21:31 170  	  FOR x IN
15:21:31 171  	  (
15:21:31 172  	      SELECT
15:21:31 173  		  ps.set_id,
15:21:31 174  		  COUNT( *) set_size
15:21:31 175  	      FROM
15:21:31 176  		  core_owner.polling_sync ps
15:21:31 177  	      WHERE
15:21:31 178  		  ps.event_date > sysdate - 14
15:21:31 179  	      AND ps.confirm_date IS NULL
15:21:31 180  	      AND ps.last_send_date IS NOT NULL
15:21:31 181  	      AND ps.num_calls < in_max_retries
15:21:31 182  	      GROUP BY
15:21:31 183  		  ps.set_id
15:21:31 184  	      ORDER BY
15:21:31 185  		  ps.set_id
15:21:31 186  	  )
15:21:31 187  	  LOOP
15:21:31 188  	      out_refcursor := Retreive_Transfer_Set(x.set_id) ;
15:21:31 189  	      RETURN;
15:21:31 190  	  END LOOP;
15:21:31 191  	  v_set_id := Create_New_Transfer_Set(in_set_maximum) ;
15:21:31 192  	  out_refcursor := Retreive_Transfer_Set(v_set_id) ;
15:21:31 193  	  RETURN;
15:21:31 194  END;
15:21:31 195  --------------------------------------------------------------------------------
15:21:31 196  PROCEDURE CONFIRM_TRANSFER_SET
15:21:31 197  	  (
15:21:31 198  	      in_set_id core_owner.polling_sync.set_id%type)
15:21:31 199  IS
15:21:31 200  	  v_unconfirmable EXCEPTION;
15:21:31 201  BEGIN
15:21:31 202  	  UPDATE
15:21:31 203  	      core_owner.polling_sync ps
15:21:31 204  	  SET
15:21:31 205  	      ps.confirm_date = systimestamp
15:21:31 206  	  WHERE
15:21:31 207  	      ps.set_id = in_set_id
15:21:31 208  	  AND ps.confirm_date IS NULL ;
15:21:31 209  	  IF(sql%rowcount < 1) THEN
15:21:31 210  	      raise v_unconfirmable;
15:21:31 211  	  END IF;
15:21:31 212  END;
15:21:31 213  PROCEDURE SET_LAST_RUN(ts in timestamp)
15:21:31 214  IS
15:21:31 215  BEGIN
15:21:31 216  	  UPDATE POLLING_SYNC_LASTRUN
15:21:31 217  	  SET last_run = current_timestamp;
15:21:31 218  	  IF ( sql%rowcount = 0 )
15:21:31 219  	  THEN
15:21:31 220  	    INSERT INTO POLLING_SYNC_LASTRUN VALUES (ts);
15:21:31 221  	  END if;
15:21:31 222  	  COMMIT;
15:21:31 223  END;
15:21:31 224  PROCEDURE GET_LAST_RUN(ts out timestamp)
15:21:31 225  IS
15:21:31 226  BEGIN
15:21:31 227  	  SELECT LAST_RUN INTO ts
15:21:31 228  	  FROM POLLING_SYNC_LASTRUN
15:21:31 229  	  WHERE ROWNUM < 2;
15:21:31 230  EXCEPTION
15:21:31 231  	WHEN NO_DATA_FOUND
15:21:31 232  	THEN
15:21:31 233  	  ts := current_timestamp;
15:21:31 234  END;
15:21:31 235  END PROCS_POLLING_SYNC;
15:21:31 236  .
15:21:31 SQL> /

Package body created.

Elapsed: 00:00:00.05
15:21:31 SQL> 
15:21:31 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_PRODUCT_V18" AS
15:21:31   2  
15:21:31   3  PROCEDURE GET_PRODUCTS (
15:21:31   4  /*
15:21:31   5  Throws exceptions:
15:21:31   6  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31   7  */
15:21:31   8  	in_status_id   IN  NUMBER,
15:21:31   9  	out_result_set OUT SYS_REFCURSOR
15:21:31  10  ) AS
15:21:31  11  SPROC_NAME CONSTANT VARCHAR2(12) := 'GET_PRODUCTS';
15:21:31  12  BEGIN
15:21:31  13  	OPEN out_result_set FOR
15:21:31  14  	SELECT
15:21:31  15  	  PRODUCT.ID,
15:21:31  16  	  PRODUCT.NAME,
15:21:31  17  	  PRODUCT.UNIT_PRICE,
15:21:31  18  	  PRODUCT.PRODUCTION_COST,
15:21:31  19  	  PRODUCT.CREATE_DATE,
15:21:31  20  	  PRODUCT.CREATED_BY,
15:21:31  21  	  PRODUCT.PRODUCT_STATUS_ID,
15:21:31  22  	  PRODUCT.PRODUCT_URI
15:21:31  23  	FROM
15:21:31  24  	  PRODUCT
15:21:31  25   WHERE
15:21:31  26  	  PRODUCT.PRODUCT_STATUS_ID = NVL(in_status_id, PRODUCT.PRODUCT_STATUS_ID);
15:21:31  27  EXCEPTION
15:21:31  28  WHEN OTHERS THEN
15:21:31  29  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31  30  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31  31  END GET_PRODUCTS;
15:21:31  32  
15:21:31  33  /******************************************************************************/
15:21:31  34  
15:21:31  35  PROCEDURE GET_PRODUCT_OFFERING_META_DATA (
15:21:31  36  	in_product_offering_id	IN NUMBER,
15:21:31  37  	out_result_set OUT SYS_REFCURSOR
15:21:31  38  ) AS
15:21:31  39  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_PRODUCT_OFFERING_META_DATA';
15:21:31  40  -- VARIABLES
15:21:31  41  temp_product_offering_id NUMBER;
15:21:31  42  -- EXCEPTIONS
15:21:31  43  BAD_PRODUCT_OFFERING_ID EXCEPTION;
15:21:31  44  BEGIN
15:21:31  45  
15:21:31  46  	-- Check that product offering exists
15:21:31  47  	BEGIN
15:21:31  48  	  SELECT
15:21:31  49  	    PRODUCT_OFFERING.ID into temp_product_offering_id
15:21:31  50  	  FROM
15:21:31  51  	    PRODUCT_OFFERING
15:21:31  52  	  WHERE
15:21:31  53  	    PRODUCT_OFFERING.ID = in_product_offering_id;
15:21:31  54  	  EXCEPTION
15:21:31  55  	    WHEN NO_DATA_FOUND THEN
15:21:31  56  	      RAISE BAD_PRODUCT_OFFERING_ID;
15:21:31  57  	END;
15:21:31  58  
15:21:31  59  	OPEN out_result_set FOR
15:21:31  60  	SELECT
15:21:31  61  	  PRODUCT_OFFERING_META_DATA.ID,
15:21:31  62  	  PRODUCT_OFFERING_META_DATA.NAME,
15:21:31  63  	  PRODUCT_OFFERING_META_DATA.VALUE,
15:21:31  64  	  PRODUCT_OFFERING_META_DATA.CREATED_BY,
15:21:31  65  	  PRODUCT_OFFERING_META_DATA.CREATE_DATE
15:21:31  66  	FROM
15:21:31  67  	  PRODUCT_OFFERING_META_DATA
15:21:31  68  	WHERE
15:21:31  69  	  PRODUCT_OFFERING_META_DATA.PRODUCT_OFFERING_ID = in_product_offering_id;
15:21:31  70  
15:21:31  71  EXCEPTION
15:21:31  72  WHEN BAD_PRODUCT_OFFERING_ID THEN
15:21:31  73  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31  74  	  SPROC_NAME, 'No such product offering id');
15:21:31  75  WHEN OTHERS THEN
15:21:31  76  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31  77  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31  78  END GET_PRODUCT_OFFERING_META_DATA;
15:21:31  79  
15:21:31  80  /******************************************************************************/
15:21:31  81  
15:21:31  82  PROCEDURE GET_PRODUCT_ELIGIBIL_BY_NAME (
15:21:31  83  /*
15:21:31  84  Throws exceptions:
15:21:31  85  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:31  86  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31  87  */
15:21:31  88  	in_product_id	    IN NUMBER,
15:21:31  89  	in_eligibility_name IN VARCHAR2 DEFAULT NULL,
15:21:31  90  	out_result_set	    OUT SYS_REFCURSOR
15:21:31  91  ) AS
15:21:31  92  SPROC_NAME CONSTANT VARCHAR2(28) := 'GET_PRODUCT_ELIGIBIL_BY_NAME';
15:21:31  93  -- VARIABLES
15:21:31  94  temp_product_id NUMBER;
15:21:31  95  -- EXCEPTIONS
15:21:31  96  BAD_PRODUCT_ID EXCEPTION;
15:21:31  97  BEGIN
15:21:31  98  
15:21:31  99  	BEGIN
15:21:31 100  	  SELECT
15:21:31 101  	    PRODUCT.ID into temp_product_id
15:21:31 102  	  FROM
15:21:31 103  	    PRODUCT
15:21:31 104  	  WHERE
15:21:31 105  	    PRODUCT.ID = in_product_id;
15:21:31 106  	  EXCEPTION
15:21:31 107  	    WHEN NO_DATA_FOUND THEN
15:21:31 108  	      RAISE BAD_PRODUCT_ID;
15:21:31 109  	END;
15:21:31 110  
15:21:31 111  	OPEN out_result_set FOR
15:21:31 112  	SELECT
15:21:31 113  	  PRODUCT_ELIGIBILITY.ID
15:21:31 114  	FROM
15:21:31 115  	  PRODUCT_ELIGIBILITY
15:21:31 116  	WHERE
15:21:31 117  	  PRODUCT_ELIGIBILITY.ID = in_product_id
15:21:31 118  	  AND UPPER(PRODUCT_ELIGIBILITY.NAME) = UPPER(NVL(in_eligibility_name, PRODUCT_ELIGIBILITY.NAME));
15:21:31 119  
15:21:31 120  EXCEPTION
15:21:31 121  WHEN BAD_PRODUCT_ID THEN
15:21:31 122  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 123  	  SPROC_NAME, 'No such product');
15:21:31 124  WHEN OTHERS THEN
15:21:31 125  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 126  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 127  END GET_PRODUCT_ELIGIBIL_BY_NAME;
15:21:31 128  
15:21:31 129  /******************************************************************************/
15:21:31 130  
15:21:31 131  PROCEDURE GET_PRODUCT_BY_ID (
15:21:31 132  	in_product_id  IN NUMBER,
15:21:31 133  	out_result_set OUT SYS_REFCURSOR
15:21:31 134  ) AS
15:21:31 135  SPROC_NAME CONSTANT VARCHAR2(17) := 'GET_PRODUCT_BY_ID';
15:21:31 136  -- VARIABLES
15:21:31 137  temp_product_id NUMBER;
15:21:31 138  -- EXCEPTIONS
15:21:31 139  BAD_PRODUCT_ID EXCEPTION;
15:21:31 140  BEGIN
15:21:31 141  
15:21:31 142  	BEGIN
15:21:31 143  	  SELECT
15:21:31 144  	    PRODUCT.ID into temp_product_id
15:21:31 145  	  FROM
15:21:31 146  	    PRODUCT
15:21:31 147  	  WHERE
15:21:31 148  	    PRODUCT.ID = in_product_id;
15:21:31 149  	  EXCEPTION
15:21:31 150  	    WHEN NO_DATA_FOUND THEN
15:21:31 151  	      RAISE BAD_PRODUCT_ID;
15:21:31 152  	END;
15:21:31 153  
15:21:31 154  	OPEN out_result_set FOR
15:21:31 155  	SELECT
15:21:31 156  	  PRODUCT.ID,
15:21:31 157  	  PRODUCT.NAME,
15:21:31 158  	  PRODUCT.PRODUCT_STATUS_ID,
15:21:31 159  	  PRODUCT.PRODUCT_URI,
15:21:31 160  	  PRODUCT.PRODUCTION_COST,
15:21:31 161  	  PRODUCT.UNIT_PRICE,
15:21:31 162  	  PRODUCT.CREATE_DATE,
15:21:31 163  	  PRODUCT.CREATED_BY
15:21:31 164  	FROM
15:21:31 165  	  PRODUCT
15:21:31 166  	WHERE
15:21:31 167  	  PRODUCT.ID = in_product_id;
15:21:31 168  
15:21:31 169  EXCEPTION
15:21:31 170  WHEN BAD_PRODUCT_ID THEN
15:21:31 171  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 172  	  SPROC_NAME, 'No such product');
15:21:31 173  WHEN OTHERS THEN
15:21:31 174  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 175  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 176  END GET_PRODUCT_BY_ID;
15:21:31 177  
15:21:31 178  /******************************************************************************/
15:21:31 179  
15:21:31 180  PROCEDURE GET_PRD_OFFERING_BY_LINE_IT_ID (
15:21:31 181  	in_line_item_id IN NUMBER,
15:21:31 182  	out_result_set	OUT SYS_REFCURSOR
15:21:31 183  ) AS
15:21:31 184  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_PRD_OFFERING_BY_LINE_IT_ID';
15:21:31 185  -- VARIABLES
15:21:31 186  temp_line_item_id NUMBER;
15:21:31 187  -- EXCEPTIONS
15:21:31 188  BAD_LINE_ITEM_ID EXCEPTION;
15:21:31 189  BEGIN
15:21:31 190  
15:21:31 191  	BEGIN
15:21:31 192  	  SELECT
15:21:31 193  	    LINE_ITEM.ID into temp_line_item_id
15:21:31 194  	  FROM
15:21:31 195  	    LINE_ITEM
15:21:31 196  	  WHERE
15:21:31 197  	    LINE_ITEM.ID = in_line_item_id;
15:21:31 198  	  EXCEPTION
15:21:31 199  	    WHEN NO_DATA_FOUND THEN
15:21:31 200  	      RAISE BAD_LINE_ITEM_ID;
15:21:31 201  	END;
15:21:31 202  
15:21:31 203  	OPEN out_result_set FOR
15:21:31 204  	SELECT
15:21:31 205  	  PRODUCT_OFFERING.ID,
15:21:31 206  	  PRODUCT_OFFERING.PRODUCT_ID,
15:21:31 207  	  PRODUCT_OFFERING.QUANTITY,
15:21:31 208  	  PRODUCT_OFFERING.UNIT_PRICE,
15:21:31 209  	  PRODUCT_OFFERING.TAX_CATEGORY_ID,
15:21:31 210  	  PRODUCT_OFFERING.CREATE_DATE,
15:21:31 211  	  PRODUCT_OFFERING.CREATED_BY,
15:21:31 212  	  PRODUCT_OFFERING.TAX_POLICY_TYPE_ID,
15:21:31 213  	  CAPABILITY.ID CAP_ID,
15:21:31 214  	  CAPABILITY.CODE CAP_CODE,
15:21:31 215  	  CAPABILITY.DESCRIPTION CAP_DESCRIPTION,
15:21:31 216  	  CAPABILITY.SHAREABLE CAP_SHAREABLE
15:21:31 217  	FROM
15:21:31 218  	  PRODUCT_OFFERING
15:21:31 219  	  INNER JOIN LINE_ITEM ON LINE_ITEM.PRODUCT_OFFER_ID = PRODUCT_OFFERING.ID
15:21:31 220  	  INNER JOIN CAPABILITY ON PRODUCT_OFFERING.CAPABILITY_ID = CAPABILITY.ID
15:21:31 221  	WHERE
15:21:31 222  	  LINE_ITEM.ID = in_line_item_id;
15:21:31 223  
15:21:31 224  EXCEPTION
15:21:31 225  WHEN BAD_LINE_ITEM_ID THEN
15:21:31 226  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 227  	  SPROC_NAME, 'No such line item');
15:21:31 228  WHEN OTHERS THEN
15:21:31 229  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 230  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 231  END GET_PRD_OFFERING_BY_LINE_IT_ID;
15:21:31 232  
15:21:31 233  /******************************************************************************/
15:21:31 234  
15:21:31 235  PROCEDURE GET_PRD_OFFERING_BY_ID (
15:21:31 236  	in_product_offering_id IN NUMBER,
15:21:31 237  	out_result_set	OUT SYS_REFCURSOR
15:21:31 238  ) AS
15:21:31 239  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_PRD_OFFERING_BY_ID';
15:21:31 240  BEGIN
15:21:31 241  	OPEN out_result_set FOR
15:21:31 242  	SELECT
15:21:31 243  	  PRODUCT_OFFERING.ID,
15:21:31 244  	  PRODUCT_OFFERING.PRODUCT_ID,
15:21:31 245  	  PRODUCT_OFFERING.QUANTITY,
15:21:31 246  	  PRODUCT_OFFERING.UNIT_PRICE,
15:21:31 247  	  PRODUCT_OFFERING.TAX_CATEGORY_ID,
15:21:31 248  	  PRODUCT_OFFERING.CREATE_DATE,
15:21:31 249  	  PRODUCT_OFFERING.CREATED_BY,
15:21:31 250  	  CAPABILITY.ID CAP_ID,
15:21:31 251  	  CAPABILITY.CODE CAP_CODE,
15:21:31 252  	  CAPABILITY.DESCRIPTION CAP_DESCRIPTION,
15:21:31 253  	  CAPABILITY.SHAREABLE CAP_SHAREABLE
15:21:31 254  	FROM
15:21:31 255  	  PRODUCT_OFFERING
15:21:31 256  	  INNER JOIN CAPABILITY ON PRODUCT_OFFERING.CAPABILITY_ID = CAPABILITY.ID
15:21:31 257  	WHERE
15:21:31 258  	  PRODUCT_OFFERING.ID = in_product_offering_id;
15:21:31 259  
15:21:31 260  EXCEPTION
15:21:31 261  WHEN OTHERS THEN
15:21:31 262  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 263  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 264  END GET_PRD_OFFERING_BY_ID;
15:21:31 265  
15:21:31 266  /******************************************************************************/
15:21:31 267  
15:21:31 268  PROCEDURE GET_PRODUCT_OFFERING_DISCOUNTS(
15:21:31 269  	in_product_offering_id IN NUMBER,
15:21:31 270  	out_result_set	       OUT SYS_REFCURSOR
15:21:31 271  ) AS
15:21:31 272  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_PRODUCT_OFFERING_DISCOUNTS';
15:21:31 273  -- VARIABLES
15:21:31 274  temp_product_offering_id NUMBER;
15:21:31 275  -- EXCEPTIONS
15:21:31 276  BAD_PRODUCT_OFFERING_ID EXCEPTION;
15:21:31 277  BEGIN
15:21:31 278  
15:21:31 279  	BEGIN
15:21:31 280  	  SELECT
15:21:31 281  	    PRODUCT_OFFERING.ID into temp_product_offering_id
15:21:31 282  	  FROM
15:21:31 283  	    PRODUCT_OFFERING
15:21:31 284  	  WHERE
15:21:31 285  	    PRODUCT_OFFERING.ID = in_product_offering_id;
15:21:31 286  	  EXCEPTION
15:21:31 287  	    WHEN NO_DATA_FOUND THEN
15:21:31 288  	      RAISE BAD_PRODUCT_OFFERING_ID;
15:21:31 289  	END;
15:21:31 290  
15:21:31 291  	OPEN out_result_set FOR
15:21:31 292  	SELECT
15:21:31 293  	  DISCOUNT.ID,
15:21:31 294  	  DISCOUNT.NAME,
15:21:31 295  	  DISCOUNT.FIXED_AMOUNT,
15:21:31 296  	  DISCOUNT.PERCENT_AMOUNT,
15:21:31 297  	  DISCOUNT.DISCOUNT_TYPE_ID,
15:21:31 298  	  DISCOUNT.CREATE_DATE,
15:21:31 299  	  DISCOUNT.CREATED_BY,
15:21:31 300  	  DISCOUNT.DESCRIPTION
15:21:31 301  	FROM
15:21:31 302  	  DISCOUNT
15:21:31 303  	  INNER JOIN DISCOUNT_PRODUCT_OFFERING on DISCOUNT.ID = DISCOUNT_PRODUCT_OFFERING.DISCOUNT_ID
15:21:31 304  	WHERE
15:21:31 305  	  DISCOUNT_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = in_product_offering_id;
15:21:31 306  
15:21:31 307  EXCEPTION
15:21:31 308  WHEN BAD_PRODUCT_OFFERING_ID THEN
15:21:31 309  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 310  	  SPROC_NAME, 'No such product offering');
15:21:31 311  WHEN OTHERS THEN
15:21:31 312  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 313  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 314  END GET_PRODUCT_OFFERING_DISCOUNTS;
15:21:31 315  
15:21:31 316  END PROCS_PRODUCT_V18;
15:21:31 317  .
15:21:31 SQL> /

Package body created.

Elapsed: 00:00:00.03
15:21:31 SQL> 
15:21:31 SQL> CREATE OR REPLACE
15:21:31   2  PACKAGE BODY PROCS_REPORTING AS
15:21:31   3  
15:21:31   4  ----
15:21:31   5  --------------------------------------------------------------------------------
15:21:31   6  ----
15:21:31   7  	  procedure ext_charge(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31   8  	  is
15:21:31   9  	  begin
15:21:31  10  	      open out_cursor for
15:21:31  11  		  with ids as ( select id from change_log cl where cl.item = 'CHARGE' and cl.change_time between in_start_date and in_end_date group by id )
15:21:31  12  		  select c.id charge_id, c.invoice_id, c.transaction_id, c.instrument_type_id, it.value instrument_type
15:21:31  13  			,c.instrument_id, c.charge_amount, c.charge_status_id, cs.value charge_status
15:21:31  14  			,c.create_date, c.update_date
15:21:31  15  		  from charge c
15:21:31  16  		      ,charge_status cs
15:21:31  17  		      ,instrument_type it
15:21:31  18  		      ,ids
15:21:31  19  		  where c.id = ids.id
15:21:31  20  		    and c.charge_status_id = cs.id
15:21:31  21  		    and c.instrument_type_id = it.id
15:21:31  22  	      ;
15:21:31  23  	  end;
15:21:31  24  ----
15:21:31  25  --------------------------------------------------------------------------------
15:21:31  26  ----
15:21:31  27  	  procedure ext_license(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31  28  	  is
15:21:31  29  	  begin
15:21:31  30  	      open out_cursor for
15:21:31  31  		  with ids as (select id from change_log cl where cl.item = 'LICENSE' and cl.change_time between in_start_date and in_end_date group by id)
15:21:31  32  		  select l.id license_id, l.start_date, l.end_date, l.offer_id, l.subscription_id, l.invoice_id
15:21:31  33  			,l.license_status_id, ls.value license_status ,l.create_date, l.update_date
15:21:31  34  			,l.current_offer_index, l.current_offer_recurr_num, l.entitlement_end_date, l.grace_start_date, l.grace_end_date
15:21:31  35  		  from license l
15:21:31  36  		      ,license_status ls
15:21:31  37  		      ,ids
15:21:31  38  		  where l.id = ids.id
15:21:31  39  		    and l.license_status_id = ls.id
15:21:31  40  	      ;
15:21:31  41  	  end;
15:21:31  42  ----
15:21:31  43  --------------------------------------------------------------------------------
15:21:31  44  ----
15:21:31  45  	  procedure ext_invoice(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31  46  	  is
15:21:31  47  	  begin
15:21:31  48  	      open out_cursor for
15:21:31  49  		  with ids as ( select id from change_log cl where cl.item = 'INVOICE' and cl.change_time between in_start_date and in_end_date group by id )
15:21:31  50  		  select
15:21:31  51  		    i.id invoice_id,
15:21:31  52  		    i.create_date,
15:21:31  53  		    i.update_date,
15:21:31  54  		    i.invoice_status_id,
15:21:31  55  		    istat.value invoice_status,
15:21:31  56  		    NVL(
15:21:31  57  		       (select offer_chain_id from gift_certificate g where g.purchase_invoice_id = i.id and rownum <= 1),
15:21:31  58  		       (select offer_chain_id from subscription s, license l where l.subscription_id = s.id and l.invoice_id = i.id and rownum <= 1)
15:21:31  59  		    ) offer_chain_id
15:21:31  60  		  from	   invoice i
15:21:31  61  		      join invoice_status istat ON istat.id = i.invoice_status_id
15:21:31  62  		      join ids			on ids.id = i.id
15:21:31  63  		  where 1 = 1
15:21:31  64  	      ;
15:21:31  65  	  end;
15:21:31  66  ----
15:21:31  67  --------------------------------------------------------------------------------
15:21:31  68  ----
15:21:31  69  	  procedure ext_line_item(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31  70  	  is
15:21:31  71  	  begin
15:21:31  72  	      open out_cursor for
15:21:31  73  		  with ids as ( select id from change_log cl where cl.item = 'LINE_ITEM' and cl.change_time between in_start_date and in_end_date group by id )
15:21:31  74  		  select li.id line_item_id, li.invoice_id, li.product_offer_id, li.amount, li.quantity
15:21:31  75  		    ,li.discount_amount, li.taxes_amount, li.create_date
15:21:31  76  		  from line_item li
15:21:31  77  		    , ids
15:21:31  78  		  where li.id = ids.id
15:21:31  79  	      ;
15:21:31  80  	  end;
15:21:31  81  ----
15:21:31  82  --------------------------------------------------------------------------------
15:21:31  83  ----
15:21:31  84  	  procedure ext_account(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31  85  	  is
15:21:31  86  	  begin
15:21:31  87  	      open out_cursor for
15:21:31  88  		  with ids as (select id from change_log cl where cl.item = 'ACCOUNT' and cl.change_time between in_start_date and in_end_date group by id)
15:21:31  89  		  select a.id account_id, a.account_status_id, astat.value account_status, a.group_id, a.suspend_date
15:21:31  90  			,a.create_date, a.update_date, a.instrument_type_id, it.value instrument_type
15:21:31  91  			,a.instrument_id, a.tax_exempt_id
15:21:31  92  			-- need system category??
15:21:31  93  		  from account a
15:21:31  94  		      ,account_status astat
15:21:31  95  		      ,instrument_type it
15:21:31  96  		      , ids
15:21:31  97  		  where a.id = ids.id
15:21:31  98  		    and astat.id = a.account_status_id
15:21:31  99  		    and a.instrument_type_id = it.id(+)
15:21:31 100  	      ;
15:21:31 101  	  end;
15:21:31 102  ----
15:21:31 103  --------------------------------------------------------------------------------
15:21:31 104  ----
15:21:31 105  	  procedure ext_subscription(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31 106  	  is
15:21:31 107  	  begin
15:21:31 108  	      open out_cursor for
15:21:31 109  		  with ids as (select id from change_log cl where cl.item = 'SUBSCRIPTION' and cl.change_time between in_start_date and in_end_date group by id)
15:21:31 110  		  select s.id subscription_id, s.account_id, s.purchase_date, s.offer_chain_id
15:21:31 111  			,s.cancellation_date, sct.value cancellation_reason,0 cancellation_is_credit
15:21:31 112  			,s.create_date, s.update_date, s.subscription_status_id, ss.value subscription_status
15:21:31 113  			,s.instrument_type_id, it.value instrument_type, s.instrument_id, s.updated_by
15:21:31 114  		  from subscription s
15:21:31 115  		      ,subscription_status ss
15:21:31 116  		      ,subscription_cancel_reason sct
15:21:31 117  		      ,instrument_type it
15:21:31 118  		      , ids
15:21:31 119  		  where s.id = ids.id
15:21:31 120  		    and ss.id = s.subscription_status_id
15:21:31 121  		    and s.instrument_type_id = it.id
15:21:31 122  		    and sct.id(+) = s.sct_id
15:21:31 123  	      ;
15:21:31 124  	  end;
15:21:31 125  ----
15:21:31 126  --------------------------------------------------------------------------------
15:21:31 127  ----
15:21:31 128  	  procedure ext_transaction(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31 129  	  is
15:21:31 130  	  begin
15:21:31 131  	      open out_cursor for
15:21:31 132  		  with ids as (select id from change_log cl where cl.item = 'TRANSACTION' and cl.change_time between in_start_date and in_end_date group by id)
15:21:31 133  		  select t.id transaction_id, t.transaction_amount
15:21:31 134  			,t.transaction_status_id, ts.value transaction_status, t.order_id
15:21:31 135  			,t.create_date, t.update_date, t.is_settled
15:21:31 136  		  from transaction t
15:21:31 137  		      ,transaction_status ts
15:21:31 138  		      , ids
15:21:31 139  		  where t.id = ids.id
15:21:31 140  		    and t.transaction_status_id = ts.id
15:21:31 141  	      ;
15:21:31 142  	  end;
15:21:31 143  ----
15:21:31 144  --------------------------------------------------------------------------------
15:21:31 145  ----
15:21:31 146  	  procedure ext_offer_chain(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31 147  	  is
15:21:31 148  	  begin
15:21:31 149  	      open out_cursor for
15:21:31 150  		  with ids as (select id from change_log cl where cl.item = 'OFFER_CHAIN' and cl.change_time between in_start_date and in_end_date group by id)
15:21:31 151  		  select oc.id offer_chain_id, oc.name, oc.description, oc.offer_chain_status_id, ocs.value offer_chain_status
15:21:31 152  			,oc.adoptability_window_start_date adoptability_start_date, oc.adoptability_window_end_date adoptability_end_date
15:21:31 153  			,oc.is_gift_certificate, oc.product_uri, oc.create_date, oc.update_date, oc.vendor_source_id, vs.name vendor_source_name
15:21:31 154  			,oc.billing_source_id, bs.name billing_source_name
15:21:31 155  			,oc.is_seat_license,oc.group_account_type_id
15:21:31 156  		  from offer_chain oc
15:21:31 157  		      , offer_chain_status ocs
15:21:31 158  		      , ids
15:21:31 159  		      , vendor_source vs
15:21:31 160  		      , billing_source bs
15:21:31 161  		  where oc.id = ids.id
15:21:31 162  		    and oc.offer_chain_status_id = ocs.id
15:21:31 163  		    and oc.vendor_source_id = vs.id
15:21:31 164  		    and oc.billing_source_id = bs.id
15:21:31 165  	      ;
15:21:31 166  	  end;
15:21:31 167  ----
15:21:31 168  --------------------------------------------------------------------------------
15:21:31 169  ----
15:21:31 170  	  procedure ext_offer_offer_chain(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31 171  	  is
15:21:31 172  	  begin
15:21:31 173  	      open out_cursor for
15:21:31 174  		  with ids as (select combined_id id from change_log cl where cl.item = 'OFFER_OFFER_CHAIN' and cl.change_time between in_start_date and in_end_date group by combined_id)
15:21:31 175  		  select ooc.offer_id||'~'||ooc.offer_chain_id offer_offer_chain_id, ooc.offer_id, ooc.offer_chain_id
15:21:31 176  			,ooc.index_value, ooc.num_recurrences, ooc.create_date, ooc.update_date
15:21:31 177  		  from offer_offer_chain ooc
15:21:31 178  		  , ids
15:21:31 179  		  where ooc.offer_id||'~'||ooc.offer_chain_id = ids.id
15:21:31 180  	      ;
15:21:31 181  	  end;
15:21:31 182  ----
15:21:31 183  --------------------------------------------------------------------------------
15:21:31 184  ----
15:21:31 185  	  procedure ext_offer(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31 186  	  is
15:21:31 187  	  begin
15:21:31 188  	      open out_cursor for
15:21:31 189  		  with ids as (select id from change_log cl where cl.item = 'OFFER' and cl.change_time between in_start_date and in_end_date group by id)
15:21:31 190  		  select o.id offer_id, o.offer_status_id, os.value offer_status, o.entitlement_duration, o.create_date, o.update_date
15:21:31 191  		  from offer o
15:21:31 192  		      ,offer_status os
15:21:31 193  		      , ids
15:21:31 194  		  where o.id = ids.id
15:21:31 195  		    and o.offer_status_id = os.id
15:21:31 196  	      ;
15:21:31 197  	  end;
15:21:31 198  ----
15:21:31 199  --------------------------------------------------------------------------------
15:21:31 200  ----
15:21:31 201  	  procedure ext_gift_certificate(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31 202  	  is
15:21:31 203  	  begin
15:21:31 204  	      open out_cursor for
15:21:31 205  		  with ids as (select id from change_log cl where cl.item = 'GIFT_CERTIFICATE' and cl.change_time between in_start_date and in_end_date group by id)
15:21:31 206  		  select  gc.id gift_certificate_id, gc.purchaser_group_id, gc.purchase_invoice_id, gc.offer_chain_id
15:21:31 207  			 ,gc.expiration_date, gc.purchase_date
15:21:31 208  			 ,gc.gift_certificate_status_id, gcs.value gift_certificate_status, gc.redeemer_group_id
15:21:31 209  			 ,gc.finalized_invoice_id, gc.create_date, gc.update_date
15:21:31 210  			 ,recipient_address_id
15:21:31 211  			 ,redeemer_address_id
15:21:31 212  			 ,recipient_notify_date
15:21:31 213  			 ,recipient_name
15:21:31 214  			 ,redemption_date
15:21:31 215  			 ,recipient_email
15:21:31 216  		  from gift_certificate gc
15:21:31 217  		      ,gift_certificate_status gcs
15:21:31 218  		      , ids
15:21:31 219  		  where gc.id = ids.id
15:21:31 220  		    and gc.gift_certificate_status_id = gcs.id
15:21:31 221  	      ;
15:21:31 222  	  end;
15:21:31 223  ----
15:21:31 224  --------------------------------------------------------------------------------
15:21:31 225  ----
15:21:31 226  	  procedure ext_product_offering(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31 227  	  is
15:21:31 228  	  begin
15:21:31 229  	      open out_cursor for
15:21:31 230  		  with ids as (select id from change_log cl where cl.item = 'PRODUCT_OFFERING' and cl.change_time between in_start_date and in_end_date group by id)
15:21:31 231  		  select po.id product_offering_id, po.product_id, po.unit_price, po.quantity, po.create_date
15:21:31 232  		  from product_offering po
15:21:31 233  		  , ids
15:21:31 234  		  where po.id = ids.id
15:21:31 235  	      ;
15:21:31 236  	  end;
15:21:31 237  ----
15:21:31 238  --------------------------------------------------------------------------------
15:21:31 239  ----
15:21:31 240  	  procedure ext_product(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31 241  	  is
15:21:31 242  	  begin
15:21:31 243  	      open out_cursor for
15:21:31 244  		  with ids as (select id from change_log cl where cl.item = 'PRODUCT' and cl.change_time between in_start_date and in_end_date group by id)
15:21:31 245  		  select p.id product_id, p.name, p.unit_price, p.production_cost, p.product_status_id, ps.value product_status
15:21:31 246  			,product_uri, p.create_date
15:21:31 247  		  from product p
15:21:31 248  		      ,product_status ps
15:21:31 249  		      , ids
15:21:31 250  		  where p.id = ids.id
15:21:31 251  		    and p.product_status_id = ps.id
15:21:31 252  	      ;
15:21:31 253  	  end;
15:21:31 254  ----
15:21:31 255  --------------------------------------------------------------------------------
15:21:31 256  ----
15:21:31 257  	  procedure ext_offer_product_offering(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31 258  	  is
15:21:31 259  	  begin
15:21:31 260  	      open out_cursor for
15:21:31 261  		  with ids as (select combined_id id from change_log cl where cl.item = 'OFFER_PRODUCT_OFFERING' and cl.change_time between in_start_date and in_end_date group by combined_id)
15:21:31 262  		  select opo.product_offering_id||'~'||opo.offer_id, opo.product_offering_id, opo.offer_id, opo.create_date
15:21:31 263  		  from offer_product_offering opo
15:21:31 264  		  , ids
15:21:31 265  		  where opo.product_offering_id||'~'||opo.offer_id = ids.id
15:21:31 266  	      ;
15:21:31 267  	  end;
15:21:31 268  ----
15:21:31 269  --------------------------------------------------------------------------------
15:21:31 270  ----
15:21:31 271  	  procedure ext_discount_product_offering(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31 272  	  is
15:21:31 273  	  begin
15:21:31 274  	      open out_cursor for
15:21:31 275  		  with ids as (select combined_id id from change_log cl where cl.item = 'DISCOUNT_PRODUCT_OFFERING' and cl.change_time between in_start_date and in_end_date group by combined_id)
15:21:31 276  		  select dpo.discount_id||'~'||dpo.product_offering_id, dpo.discount_id, dpo.product_offering_id, dpo.create_date
15:21:31 277  		  from discount_product_offering dpo
15:21:31 278  		  , ids
15:21:31 279  		  where dpo.discount_id||'~'||dpo.product_offering_id = ids.id
15:21:31 280  	      ;
15:21:31 281  	  end;
15:21:31 282  ----
15:21:31 283  --------------------------------------------------------------------------------
15:21:31 284  ----
15:21:31 285  	  procedure ext_discount(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31 286  	  is
15:21:31 287  	  begin
15:21:31 288  	      open out_cursor for
15:21:31 289  		  with ids as (select id from change_log cl where cl.item = 'DISCOUNT' and cl.change_time between in_start_date and in_end_date group by id)
15:21:31 290  		  select d.id discount_id, d.name, d.description, d.fixed_amount, d.percent_amount
15:21:31 291  			,d.discount_type_id, dt.value discount_type, d.create_date
15:21:31 292  		  from discount d
15:21:31 293  		      ,discount_type dt
15:21:31 294  		      , ids
15:21:31 295  		  where d.id = ids.id
15:21:31 296  		    and d.discount_type_id = dt.id
15:21:31 297  	      ;
15:21:31 298  	  end;
15:21:31 299  ----
15:21:31 300  --------------------------------------------------------------------------------
15:21:31 301  ----
15:21:31 302  	  procedure ext_product_eligibility(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31 303  	  is
15:21:31 304  	  begin
15:21:31 305  	      open out_cursor for
15:21:31 306  		  with ids as (select id from change_log cl where cl.item = 'PRODUCT_ELIGIBILITY' and cl.change_time between in_start_date and in_end_date group by id)
15:21:31 307  		  select pg.id product_eligibility_id, pg.product_id, pg.name, pg.value, pg.create_date
15:21:31 308  		  from product_eligibility pg
15:21:31 309  		  , ids
15:21:31 310  		  where pg.id = ids.id
15:21:31 311  	      ;
15:21:31 312  	  end;
15:21:31 313  ----
15:21:31 314  --------------------------------------------------------------------------------
15:21:31 315  ----
15:21:31 316  	  procedure ext_offer_chain_eligibility(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31 317  	  is
15:21:31 318  	  begin
15:21:31 319  	      open out_cursor for
15:21:31 320  		  with ids as (select id from change_log cl where cl.item = 'OFFER_CHAIN_ELIGIBILITY' and cl.change_time between in_start_date and in_end_date group by id)
15:21:31 321  		  select oce.id offer_chain_eligibility_id, oce.offer_chain_id, oce.name, oce.value, oce.create_date
15:21:31 322  		  from offer_chain_eligibility oce
15:21:31 323  		  , ids
15:21:31 324  		  where oce.id = ids.id
15:21:31 325  	      ;
15:21:31 326  	  end;
15:21:31 327  ----
15:21:31 328  --------------------------------------------------------------------------------
15:21:31 329  ----
15:21:31 330  	  procedure ext_offer_chain_metadata(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31 331  	  is
15:21:31 332  	  begin
15:21:31 333  	      open out_cursor for
15:21:31 334  		  with ids as (select id from change_log cl where cl.item = 'OFFER_CHAIN_META_DATA' and cl.change_time between in_start_date and in_end_date group by id)
15:21:31 335  		  select ocm.id offer_chain_meta_data_id, ocm.offer_chain_id, ocm.name, ocm.value, ocm.create_date
15:21:31 336  		  from offer_chain_meta_data ocm
15:21:31 337  		  , ids
15:21:31 338  		  where ocm.id = ids.id
15:21:31 339  	      ;
15:21:31 340  	  end;
15:21:31 341  ----
15:21:31 342  --------------------------------------------------------------------------------
15:21:31 343  ----
15:21:31 344  	  procedure ext_product_offering_metadata(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31 345  	  is
15:21:31 346  	  begin
15:21:31 347  	      open out_cursor for
15:21:31 348  		  with ids as (select id from change_log cl where cl.item = 'PRODUCT_OFFERING_META_DATA' and cl.change_time between in_start_date and in_end_date group by id)
15:21:31 349  		  select pom.id prod_offer_meta_data_id, pom.product_offering_id, pom.name, pom.value, pom.create_date
15:21:31 350  		  from product_offering_meta_data pom
15:21:31 351  		  , ids
15:21:31 352  		  where pom.id = ids.id
15:21:31 353  	      ;
15:21:31 354  	  end;
15:21:31 355  ----
15:21:31 356  --------------------------------------------------------------------------------
15:21:31 357  ----
15:21:31 358  	  procedure ext_subscription_metadata(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31 359  	  is
15:21:31 360  	  begin
15:21:31 361  	      open out_cursor for
15:21:31 362  		  with ids as (select id from change_log cl where cl.item = 'SUBSCRIPTION_META_DATA' and cl.change_time between in_start_date and in_end_date group by id)
15:21:31 363  		  select sm.id subscription_meta_data_id, sm.subscription_id, sm.name, sm.value, sm.create_date
15:21:31 364  		  from subscription_meta_data sm
15:21:31 365  		  , ids
15:21:31 366  		  where sm.id = ids.id
15:21:31 367  	      ;
15:21:31 368  	  end;
15:21:31 369  ----
15:21:31 370  --------------------------------------------------------------------------------
15:21:31 371  ----
15:21:31 372  	  procedure ext_credit_card(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31 373  	  is
15:21:31 374  	  begin
15:21:31 375  	      open out_cursor for
15:21:31 376  		  with ids as (select id from change_log cl where cl.item = 'CREDIT_CARD' and cl.change_time between in_start_date and in_end_date group by id)
15:21:31 377  		  select cc.id credit_card_id, cc.account_id, cc.instrument_name, cc.state, cc.city, cc.postal_code
15:21:31 378  			,cc.country, cc.expiration_date, cc.credit_card_type_id, cct.value credit_card_type
15:21:31 379  			,cc.credit_card_status_id, ccs.value credit_card_status, cc.create_date, cc.update_date
15:21:31 380  		  from credit_card cc
15:21:31 381  		      ,credit_card_type cct
15:21:31 382  		      ,credit_card_status ccs
15:21:31 383  		      , ids
15:21:31 384  		  where cc.id = ids.id
15:21:31 385  		    and cc.credit_card_type_id = cct.id(+)
15:21:31 386  		    and cc.credit_card_status_id = ccs.id
15:21:31 387  	      ;
15:21:31 388  	  end;
15:21:31 389  ----
15:21:31 390  --------------------------------------------------------------------------------
15:21:31 391  ----
15:21:31 392  	  procedure ext_transaction_attempt(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31 393  	  is
15:21:31 394  	  begin
15:21:31 395  	      open out_cursor for
15:21:31 396  		  with ids as (select id from change_log cl where cl.item = 'TRANSACTION_ATTEMPT' and cl.change_time between in_start_date and in_end_date group by id)
15:21:31 397  		  select ta.id transaction_attempt_id, ta.transaction_id, ta.external_transaction_id
15:21:31 398  			,ta.transaction_start_time, ta.external_status_code, ta.external_status_message
15:21:31 399  			,ta.transaction_attempt_status_id trans_attempt_status_id, tas.value transaction_attempt_status
15:21:31 400  			,ta.create_date
15:21:31 401  		  from transaction_attempt ta
15:21:31 402  		      ,transaction_attempt_status tas
15:21:31 403  		      , ids
15:21:31 404  		  where ta.id = ids.id
15:21:31 405  		    and ta.transaction_attempt_status_id = tas.id
15:21:31 406  	      ;
15:21:31 407  	  end;
15:21:31 408  ----
15:21:31 409  --------------------------------------------------------------------------------
15:21:31 410  ----
15:21:31 411  	  procedure ext_invoice_adjustment(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31 412  	  is
15:21:31 413  	  begin
15:21:31 414  	      open out_cursor for
15:21:31 415  		  with ids as (select id from change_log cl where cl.item = 'INVOICE_ADJUSTMENT' and cl.change_time between in_start_date and in_end_date group by id)
15:21:31 416  		  select ia.id invoice_adjustment_id, ia.invoice_id, ia.is_credit, ir.value adjustment_reason, ia.charge_id
15:21:31 417  			,ia.adjustment_date, ia.create_date
15:21:31 418  		  from invoice_adjustment ia, invoice_adjustment_reason ir
15:21:31 419  		  , ids
15:21:31 420  		  where ia.id = ids.id
15:21:31 421  		  and ir.id = ia.invoice_adjustment_reason_id
15:21:31 422  	      ;
15:21:31 423  	  end;
15:21:31 424  ----
15:21:31 425  --------------------------------------------------------------------------------
15:21:31 426  ----
15:21:31 427  
15:21:31 428  	  procedure ext_line_item_adjustment(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31 429  	  is
15:21:31 430  	  begin
15:21:31 431  	      open out_cursor for
15:21:31 432  		  with ids as (select id from change_log cl where cl.item = 'LINE_ITEM_ADJUSTMENT' and cl.change_time between in_start_date and in_end_date group by id)
15:21:31 433  		  select lia.id line_item_adjustment_id, lia.line_item_id, lia.invoice_adjustment_id, lia.amount, lia.tax, lia.discount, lia.create_date
15:21:31 434  		  from line_item_adjustment lia
15:21:31 435  		  , ids
15:21:31 436  		  where lia.id = ids.id
15:21:31 437  	      ;
15:21:31 438  	  end;
15:21:31 439  ----
15:21:31 440  --------------------------------------------------------------------------------
15:21:31 441  ----
15:21:31 442  
15:21:31 443  	  procedure ext_tax(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31 444  	  is
15:21:31 445  	  begin
15:21:31 446  	      open out_cursor for
15:21:31 447  		  with ids as (select id from change_log cl where cl.item = 'TAX' and cl.change_time between in_start_date and in_end_date group by id)
15:21:31 448  		  select
15:21:31 449  		    tax.id tax_id,
15:21:31 450  		    ttype.code tax_type,
15:21:31 451  		    tax.calculated_amount,
15:21:31 452  		    tax.create_date,
15:21:31 453  		    tax.line_item_id,
15:21:31 454  		    tax.effective_rate,
15:21:31 455  		    tax.taxable_amount,
15:21:31 456  		    tax.tax_rule_id,
15:21:31 457  		    j.name jurisdiction_level,
15:21:31 458  		    tax.jurisdiction_name,
15:21:31 459  		    tax.jurisdiction_id,
15:21:31 460  		    tax.ext_tax_type,
15:21:31 461  		    tax.ext_result,
15:21:31 462  		    tax.imposition_type,
15:21:31 463  		    tax.imposition
15:21:31 464  		  from tax
15:21:31 465  		  , tax_type ttype
15:21:31 466  		  , jurisdiction_level j
15:21:31 467  		  , ids
15:21:31 468  		  where tax.id = ids.id and ttype.id = tax.tax_type_id and j.id = tax.jurisdiction_level_id
15:21:31 469  	      ;
15:21:31 470  	  end;
15:21:31 471  ----
15:21:31 472  --------------------------------------------------------------------------------
15:21:31 473  ----
15:21:31 474  	  procedure ext_tax_adjustment(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
15:21:31 475  	  is
15:21:31 476  	  begin
15:21:31 477  	      open out_cursor for
15:21:31 478  		  with ids as (select id from change_log cl where cl.item = 'TAX_ADJUSTMENT' and cl.change_time between in_start_date and in_end_date group by id)
15:21:31 479  		  select
15:21:31 480  		    tax.id tad_adjustment_id,
15:21:31 481  		    tax.tax_id tax_id,
15:21:31 482  		    tax.line_item_adjustment_id line_item_adjustment_id,
15:21:31 483  		    tax.amount tax_amount,
15:21:31 484  		    tax.create_date create_date
15:21:31 485  		  from tax_adjustment tax
15:21:31 486  		  , ids
15:21:31 487  		  where tax.id = ids.id
15:21:31 488  	      ;
15:21:31 489  	  end;
15:21:31 490  ----
15:21:31 491  --------------------------------------------------------------------------------
15:21:31 492  ----
15:21:31 493  /**/
15:21:31 494  	  procedure ext_rcn_ext_source_log(in_start_date date, in_end_date date, out_cursor out sys_refcursor) IS
15:21:31 495  	  BEGIN
15:21:31 496  	    OPEN OUT_CURSOR FOR
15:21:31 497  	    with ids As ( SELECT cl.id FROM change_log cl where cl.item = 'RCN_EXT_SOURCE_LOG' and change_time between in_start_date and in_end_date group by cl.id )
15:21:31 498  	    SELECT
15:21:31 499  		t.id rcn_ext_source_log_id
15:21:31 500  	      , t.extraction_timestamp
15:21:31 501  	      , t.report_date
15:21:31 502  	      , t.report_generation_datetime
15:21:31 503  	      , t.record_type
15:21:31 504  	      , t.report_file_name
15:21:31 505  	      , t.create_date
15:21:31 506  	      , t.created_by
15:21:31 507  	    FROM rcn_ext_source_log t, ids
15:21:31 508  	    WHERE ids.id = t.id;
15:21:31 509  	  END;
15:21:31 510  
15:21:31 511  	  procedure ext_rcn_cpt_svc_chg_dtl(in_start_date date, in_end_date date, out_cursor out sys_refcursor) IS
15:21:31 512  	  BEGIN
15:21:31 513  	    OPEN OUT_CURSOR FOR
15:21:31 514  	    with ids As ( SELECT cl.id FROM change_log cl where cl.item = 'RCN_CPT_SERVICE_CHARGE_DETAIL' and change_time between in_start_date and in_end_date group by cl.id )
15:21:31 515  	    SELECT
15:21:31 516  		t.id rcn_cpt_svc_chg_dtl_id
15:21:31 517  	      , t.rcn_ext_source_log_id
15:21:31 518  	      , t.record_type
15:21:31 519  	      , t.category
15:21:31 520  	      , t.sub_category
15:21:31 521  	      , t.entity_type
15:21:31 522  	      , t.entity_number
15:21:31 523  	      , t.funds_transfer_inst_number
15:21:31 524  	      , t.secure_ba_number
15:21:31 525  	      , t.settlement_currency
15:21:31 526  	      , t.fee_schedule
15:21:31 527  	      , t.mop
15:21:31 528  	      , t.interchange_qualification
15:21:31 529  	      , t.fee_type_description
15:21:31 530  	      , t.action_type
15:21:31 531  	      , t.unit_quantity
15:21:31 532  	      , t.unit_fee
15:21:31 533  	      , t.amount
15:21:31 534  	      , t.percentage_rate
15:21:31 535  	      , t.total_charge
15:21:31 536  	      , t.create_date
15:21:31 537  	      , t.created_by
15:21:31 538  	    FROM rcn_cpt_service_charge_detail t, ids
15:21:31 539  	    WHERE ids.id = t.id;
15:21:31 540  	  END;
15:21:31 541  ----
15:21:31 542  --------------------------------------------------------------------------------
15:21:31 543  ----
15:21:31 544  
15:21:31 545  	  procedure ext_rcn_cpt_excpt_dtl(in_start_date date, in_end_date date, out_cursor out sys_refcursor) IS
15:21:31 546  	  BEGIN
15:21:31 547  	    OPEN OUT_CURSOR FOR
15:21:31 548  	    with ids As ( SELECT cl.id FROM change_log cl where cl.item = 'RCN_CPT_EXCEPTION_DETAIL' and change_time between in_start_date and in_end_date group by cl.id )
15:21:31 549  	    SELECT
15:21:31 550  		t.id rcn_cpt_excp_dtl_id
15:21:31 551  	      , t.rcn_ext_source_log_id
15:21:31 552  	      , t.record_type
15:21:31 553  	      , t.submission_date
15:21:31 554  	      , t.pid_number
15:21:31 555  	      , t.pid_short_name
15:21:31 556  	      , t.submission_number
15:21:31 557  	      , t.record_number
15:21:31 558  	      , t.entity_type
15:21:31 559  	      , t.entity_number
15:21:31 560  	      , t.presentment_currency
15:21:31 561  	      , t.merchant_order_number
15:21:31 562  	      , t.rdfi_number
15:21:31 563  	      , t.account_number
15:21:31 564  	      , t.expiration_date
15:21:31 565  	      , t.amount
15:21:31 566  	      , t.mop
15:21:31 567  	      , t.action_code
15:21:31 568  	      , t.auth_date
15:21:31 569  	      , t.auth_code
15:21:31 570  	      , t.auth_response_code
15:21:31 571  	      , t.trace_number
15:21:31 572  	      , t.consumer_country_code
15:21:31 573  	      , t.category
15:21:31 574  	      , t.mcc
15:21:31 575  	      , t.reject_code
15:21:31 576  	      , t.submission_status
15:21:31 577  	      , t.create_date
15:21:31 578  	      , t.created_by
15:21:31 579  	    FROM rcn_cpt_exception_detail t, ids
15:21:31 580  	    WHERE ids.id = t.id;
15:21:31 581  	  END;
15:21:31 582  ----
15:21:31 583  --------------------------------------------------------------------------------
15:21:31 584  ----
15:21:31 585  
15:21:31 586  	  procedure ext_rcn_cpt_dpst_dtl(in_start_date date, in_end_date date, out_cursor out sys_refcursor) IS
15:21:31 587  	  BEGIN
15:21:31 588  	    OPEN OUT_CURSOR FOR
15:21:31 589  	    with ids As ( SELECT cl.id FROM change_log cl where cl.item = 'RCN_CPT_DEPOSIT_DETAIL' and change_time between in_start_date and in_end_date group by cl.id )
15:21:31 590  	      SELECT
15:21:31 591  		t.id rcn_cpt_deposit_dtl_id
15:21:31 592  	      , t.rcn_ext_source_log_id
15:21:31 593  	      , t.record_type
15:21:31 594  	      , t.submission_date
15:21:31 595  	      , t.pid_number
15:21:31 596  	      , t.pid_short_name
15:21:31 597  	      , t.submission_number
15:21:31 598  	      , t.record_number
15:21:31 599  	      , t.entity_type
15:21:31 600  	      , t.entity_number
15:21:31 601  	      , t.presentment_currency
15:21:31 602  	      , t.merchant_order_number
15:21:31 603  	      , t.rdfi_number
15:21:31 604  	      , t.account_number
15:21:31 605  	      , t.expiration_date
15:21:31 606  	      , t.amount
15:21:31 607  	      , t.mop
15:21:31 608  	      , t.action_code
15:21:31 609  	      , t.auth_date
15:21:31 610  	      , t.auth_code
15:21:31 611  	      , t.auth_response_code
15:21:31 612  	      , t.trace_number
15:21:31 613  	      , t.consumer_country_code
15:21:31 614  	      , t.mcc
15:21:31 615  	      , t.create_date
15:21:31 616  	      , t.created_by
15:21:31 617  	      , t.fee_code
15:21:31 618  	      , t.unit_fee
15:21:31 619  	      , t.percent_fee
15:21:31 620  	      , t.total_interchange_fee
15:21:31 621  	      , t.total_assessment_fee
15:21:31 622  	      , t.other_fee
15:21:31 623  	    FROM rcn_cpt_deposit_detail t, ids
15:21:31 624  	    WHERE ids.id = t.id;
15:21:31 625  	  END;
15:21:31 626  ----
15:21:31 627  --------------------------------------------------------------------------------
15:21:31 628  ----
15:21:31 629  
15:21:31 630  	  procedure ext_rcn_cpt_chgbk_act_dtl(in_start_date date, in_end_date date, out_cursor out sys_refcursor) IS
15:21:31 631  	  BEGIN
15:21:31 632  	    OPEN OUT_CURSOR FOR
15:21:31 633  	    with ids As ( SELECT cl.id FROM change_log cl where cl.item = 'RCN_CPT_CHARGEBACK_ACT_DETAIL' and change_time between in_start_date and in_end_date group by cl.id )
15:21:31 634  	    SELECT
15:21:31 635  		t.id rcn_cpt_chgbk_act_dtl_id
15:21:31 636  	      , t.rcn_ext_source_log_id
15:21:31 637  	      , t.record_type
15:21:31 638  	      , t.entity_type
15:21:31 639  	      , t.entity_number
15:21:31 640  	      , t.chargeback_amount_issuer
15:21:31 641  	      , t.prev_partial_representment
15:21:31 642  	      , t.presentment_currency
15:21:31 643  	      , t.chargeback_category
15:21:31 644  	      , t.status_flag
15:21:31 645  	      , t.sequence_number
15:21:31 646  	      , t.merchant_order_number
15:21:31 647  	      , t.account_number
15:21:31 648  	      , t.reason_code
15:21:31 649  	      , t.transaction_date
15:21:31 650  	      , t.chargeback_date
15:21:31 651  	      , t.activity_date
15:21:31 652  	      , t.chargeback_amount_action
15:21:31 653  	      , t.fee_amount
15:21:31 654  	      , t.usage_code
15:21:31 655  	      , t.mop_code
15:21:31 656  	      , t.authorization_date
15:21:31 657  	      , t.chargeback_due_date
15:21:31 658  	      , t.create_date
15:21:31 659  	      , t.created_by
15:21:31 660  	    FROM rcn_cpt_chargeback_act_detail t, ids
15:21:31 661  	    WHERE ids.id = t.id;
15:21:31 662  	  END;
15:21:31 663  ----
15:21:31 664  --------------------------------------------------------------------------------
15:21:31 665  ----
15:21:31 666  
15:21:31 667  	  procedure ext_rcn_pp_sttlmnt(in_start_date date, in_end_date date, out_cursor out sys_refcursor) IS
15:21:31 668  	  BEGIN
15:21:31 669  	    OPEN OUT_CURSOR FOR
15:21:31 670  	    with ids As ( SELECT cl.id FROM change_log cl where cl.item = 'RCN_PP_SETTLEMENT' and change_time between in_start_date and in_end_date group by cl.id )
15:21:31 671  	    SELECT
15:21:31 672  		t.id rcn_pp_settlement_id
15:21:31 673  	      , t.rcn_ext_source_log_id
15:21:31 674  	      , t.transaction_id
15:21:31 675  	      , t.invoice_id
15:21:31 676  	      , t.pp_ref_id
15:21:31 677  	      , t.pp_ref_id_type
15:21:31 678  	      , t.trans_event_code
15:21:31 679  	      , t.trans_init_date
15:21:31 680  	      , t.trans_comp_date
15:21:31 681  	      , t.trans_deb_or_cred
15:21:31 682  	      , t.gross_trans_amount
15:21:31 683  	      , t.gross_trans_currency
15:21:31 684  	      , t.fee_deb_or_cred
15:21:31 685  	      , t.fee_amount
15:21:31 686  	      , t.fee_currency
15:21:31 687  	      , t.custom_field
15:21:31 688  	      , t.create_date
15:21:31 689  	      , t.created_by
15:21:31 690  	    FROM rcn_pp_settlement t, ids
15:21:31 691  	    WHERE ids.id = t.id;
15:21:31 692  	  END;
15:21:31 693  ----
15:21:31 694  --------------------------------------------------------------------------------
15:21:31 695  ----
15:21:31 696  
15:21:31 697  	  procedure ext_rcn_pp_dispute(in_start_date date, in_end_date date, out_cursor out sys_refcursor) IS
15:21:31 698  	  BEGIN
15:21:31 699  	    OPEN OUT_CURSOR FOR
15:21:31 700  	    with ids As ( SELECT cl.id FROM change_log cl where cl.item = 'RCN_PP_DISPUTE' and change_time between in_start_date and in_end_date group by cl.id )
15:21:31 701  	    SELECT
15:21:31 702  		t.id rcn_pp_dispute_id
15:21:31 703  	      , t.rcn_ext_source_log_id
15:21:31 704  	      , t.dispute_type
15:21:31 705  	      , t.claimant_name
15:21:31 706  	      , t.claimant_email
15:21:31 707  	      , t.transaction_id
15:21:31 708  	      , t.trans_date
15:21:31 709  	      , t.disputed_amount
15:21:31 710  	      , t.disputed_amount_currency
15:21:31 711  	      , t.dispute_reason
15:21:31 712  	      , t.dispute_filing_date
15:21:31 713  	      , t.dispute_status
15:21:31 714  	      , t.dispute_case_id
15:21:31 715  	      , t.invoice_id
15:21:31 716  	      , t.create_date
15:21:31 717  	      , t.created_by
15:21:31 718  	    FROM
15:21:31 719  	    rcn_pp_dispute t, ids
15:21:31 720  	    WHERE ids.id = t.id;
15:21:31 721  	  END;
15:21:31 722  ----
15:21:31 723  --------------------------------------------------------------------------------
15:21:31 724  ----
15:21:31 725  
15:21:31 726  	  procedure ext_rcn_pp_trns_dtl(in_start_date date, in_end_date date, out_cursor out sys_refcursor) IS
15:21:31 727  	  BEGIN
15:21:31 728  	    OPEN OUT_CURSOR FOR
15:21:31 729  	    with ids As ( SELECT cl.id FROM change_log cl where cl.item = 'RCN_PP_TRANS_DETAIL' and change_time between in_start_date and in_end_date group by cl.id )
15:21:31 730  	    SELECT
15:21:31 731  		t.id rcn_pp_trans_dtl_id
15:21:31 732  	      , t.rcn_ext_source_log_id
15:21:31 733  	      , t.transaction_id
15:21:31 734  	      , t.invoice_id
15:21:31 735  	      , t.pp_ref_id
15:21:31 736  	      , t.trans_event_code
15:21:31 737  	      , t.trans_init_date
15:21:31 738  	      , t.trans_comp_date
15:21:31 739  	      , t.trans_deb_or_cred
15:21:31 740  	      , t.gross_trans_amount
15:21:31 741  	      , t.gross_trans_currency
15:21:31 742  	      , t.fee_deb_or_cred
15:21:31 743  	      , t.fee_amount
15:21:31 744  	      , t.fee_currency
15:21:31 745  	      , t.trans_status
15:21:31 746  	      , t.insurance_amount
15:21:31 747  	      , t.sales_tax_amount
15:21:31 748  	      , t.shipping_amount
15:21:31 749  	      , t.trans_subject
15:21:31 750  	      , t.trans_note
15:21:31 751  	      , t.payer_acct_id
15:21:31 752  	      , t.payer_addr_status
15:21:31 753  	      , t.item_name
15:21:31 754  	      , t.item_id
15:21:31 755  	      , t.option_1_name
15:21:31 756  	      , t.option_1_value
15:21:31 757  	      , t.option_2_name
15:21:31 758  	      , t.option_2_value
15:21:31 759  	      , t.auction_site
15:21:31 760  	      , t.auction_buyer_id
15:21:31 761  	      , t.auction_closing_date
15:21:31 762  	      , t.shipping_addr_line_1
15:21:31 763  	      , t.shipping_addr_line_2
15:21:31 764  	      , t.shipping_addr_city
15:21:31 765  	      , t.shipping_addr_state
15:21:31 766  	      , t.shipping_addr_zip
15:21:31 767  	      , t.shipping_addr_country
15:21:31 768  	      , t.custom_field
15:21:31 769  	      , t.create_date
15:21:31 770  	      , t.created_by
15:21:31 771  	    FROM rcn_pp_trans_detail t, ids
15:21:31 772  	    WHERE ids.id = t.id;
15:21:31 773  	  END;
15:21:31 774  ----
15:21:31 775  --------------------------------------------------------------------------------
15:21:31 776  ----
15:21:31 777  	  procedure ext_rcn_amex_chargeback(in_start_date date, in_end_date date, out_cursor out sys_refcursor) IS
15:21:31 778  	  BEGIN
15:21:31 779  	    OPEN OUT_CURSOR FOR
15:21:31 780  	    with ids As ( SELECT cl.id FROM change_log cl where cl.item = 'RCN_AMEX_CHARGEBACK' and change_time between in_start_date and in_end_date group by cl.id )
15:21:31 781  	    SELECT
15:21:31 782  	      rac.id
15:21:31 783  	    , rac.rcn_ext_source_log_id
15:21:31 784  	    , rac.resolution
15:21:31 785  	    , rac.from_system
15:21:31 786  	    , rac.rejects_to_system
15:21:31 787  	    , rac.disputes_to_system
15:21:31 788  	    , rac.date_of_adjustment
15:21:31 789  	    , rac.date_of_charge
15:21:31 790  	    , rac.case_type
15:21:31 791  	    , rac.cb_reas_code
15:21:31 792  	    , rac.cb_amount
15:21:31 793  	    , rac.cb_adjustment_number
15:21:31 794  	    , rac.billed_amount
15:21:31 795  	    , rac.soc_amount
15:21:31 796  	    , rac.foreign_amount
15:21:31 797  	    , rac.currency
15:21:31 798  	    , rac.note1
15:21:31 799  	    , rac.note2
15:21:31 800  	    , rac.note3
15:21:31 801  	    , rac.note4
15:21:31 802  	    , rac.note5
15:21:31 803  	    , rac.note6
15:21:31 804  	    , rac.note7
15:21:31 805  	    , rac.ind_ref_number
15:21:31 806  	    , rac.create_date
15:21:31 807  	    , rac.created_by
15:21:31 808  	    , rac.update_date
15:21:31 809  	    , rac.updated_by
15:21:31 810  	    FROM rcn_amex_chargeback rac, ids
15:21:31 811  	    WHERE ids.id = rac.id;
15:21:31 812  	  END;
15:21:31 813  ----
15:21:31 814  --------------------------------------------------------------------------------
15:21:31 815  ----
15:21:31 816  	  procedure ext_paypal(in_start_date date, in_end_date date, out_cursor out sys_refcursor) IS
15:21:31 817  	  BEGIN
15:21:31 818  	    OPEN OUT_CURSOR FOR
15:21:31 819  	    with ids as ( SELECT cl.id FROM change_log cl where cl.item = 'PAYPAL' and change_time between in_start_date and in_end_date group by cl.id )
15:21:31 820  	    SELECT
15:21:31 821  		t.ID PAYPAL_ID
15:21:31 822  	      , ACCOUNT_ID
15:21:31 823  	      , INSTRUMENT_NAME
15:21:31 824  	      , CREATE_DATE
15:21:31 825  	      , CREATED_BY
15:21:31 826  	      , UPDATE_DATE
15:21:31 827  	      , UPDATED_BY
15:21:31 828  	      , s.value PAYPAL_STATUS
15:21:31 829  	      , STATE
15:21:31 830  	      , CITY
15:21:31 831  	      , POSTAL_CODE
15:21:31 832  	      , COUNTRY
15:21:31 833  	      , EXPIRATION_DATE
15:21:31 834  	    FROM paypal t, paypal_status s, ids
15:21:31 835  	    WHERE ids.id = t.id and t.paypal_status_id = s.id;
15:21:31 836  	  END;
15:21:31 837  ----
15:21:31 838  --------------------------------------------------------------------------------
15:21:31 839  ----
15:21:31 840  	  procedure ext_address(in_start_date date, in_end_date date, out_cursor out sys_refcursor) IS
15:21:31 841  	  BEGIN
15:21:31 842  	    OPEN OUT_CURSOR FOR
15:21:31 843  	    with ids as ( SELECT cl.id FROM change_log cl where cl.item = 'ADDRESS' and change_time between in_start_date and in_end_date group by cl.id )
15:21:31 844  	    SELECT
15:21:31 845  	      a.id ADDRESS_ID,
15:21:31 846  	      address1,
15:21:31 847  	      address2,
15:21:31 848  	      city,
15:21:31 849  	      state,
15:21:31 850  	      postal_code,
15:21:31 851  	      country,
15:21:31 852  	      create_date,
15:21:31 853  	      created_by,
15:21:31 854  	      update_date,
15:21:31 855  	      updated_by
15:21:31 856  	    FROM address a, ids
15:21:31 857  	    WHERE ids.id = a.id;
15:21:31 858  	  END;
15:21:31 859  ----
15:21:31 860  --------------------------------------------------------------------------------
15:21:31 861  ----
15:21:31 862  /**/
15:21:31 863  END PROCS_REPORTING;
15:21:31 864  .
15:21:31 SQL> /

Package body created.

Elapsed: 00:00:00.36
15:21:31 SQL> 
15:21:31 SQL> create or replace PACKAGE BODY		  "PROCS_REPORTING_1A" AS
15:21:31   2  
15:21:31   3  ----
15:21:31   4  --------------------------------------------------------------------------------
15:21:31   5  ----
15:21:31   6  	  function getDiscountAmount(in_line_item_id line_item.id%type)
15:21:31   7  	      return line_item.amount%type
15:21:31   8  	  is
15:21:31   9  	      v_discount  line_item.amount%type := 0;
15:21:31  10  	  begin
15:21:31  11  	      for x in (
15:21:31  12  		  select d.id discount_id
15:21:31  13  			,nvl(d.fixed_amount, d.percent_amount * (po.quantity * po.unit_price)) discount_amount
15:21:31  14  		  from discount d
15:21:31  15  		      join discount_line_item dli	      on dli.discount_id = d.id
15:21:31  16  		      join discount_product_offering dop      on dop.discount_id = d.id
15:21:31  17  		      join product_offering po		      on po.id = dop.product_offering_id
15:21:31  18  		      join line_item li 		      on li.id = dli.line_item_id and li.product_offer_id = po.id
15:21:31  19  		  where dli.line_item_id = in_line_item_id
15:21:31  20  	      )
15:21:31  21  	      loop
15:21:31  22  		  v_discount := v_discount + x.discount_amount;
15:21:31  23  	      end loop;
15:21:31  24  
15:21:31  25  	      return v_discount;
15:21:31  26  	  end;
15:21:31  27  ----
15:21:31  28  --------------------------------------------------------------------------------
15:21:31  29  ----
15:21:31  30  	  function getRefundAmount(in_line_item_id line_item.id%type)
15:21:31  31  	      return line_item.amount%type
15:21:31  32  	  is
15:21:31  33  	      v_li_total  line_item.amount%type;
15:21:31  34  	      v_inv_total line_item.amount%type;
15:21:31  35  	      v_ref_total line_item.amount%type;
15:21:31  36  	  begin
15:21:31  37  
15:21:31  38  	      for li in (
15:21:31  39  		  select li.invoice_id, po.*
15:21:31  40  		  from line_item li
15:21:31  41  			  join core_owner.product_offering po on li.product_offer_id = po.id
15:21:31  42  		  where li.id = in_line_item_id
15:21:31  43  	      )
15:21:31  44  	      loop
15:21:31  45  		  v_li_total := (li.quantity * li.unit_price) - getDiscountAmount(in_line_item_id);
15:21:31  46  
15:21:31  47  		  v_inv_total := 0;
15:21:31  48  		  v_ref_total := 0;
15:21:31  49  		  for x in (
15:21:31  50  		      select case when c.charge_amount < 0 then -1 else 1 end type, sum(c.charge_amount) total
15:21:31  51  		      from charge c
15:21:31  52  		      where c.invoice_id = li.invoice_id
15:21:31  53  		      group by case when c.charge_amount < 0 then -1 else 1 end
15:21:31  54  		  )
15:21:31  55  		  loop
15:21:31  56  		      if (x.type = 1) then
15:21:31  57  			  v_inv_total := x.total;
15:21:31  58  		      else
15:21:31  59  			  v_ref_total := x.total;
15:21:31  60  		      end if;
15:21:31  61  		  end loop;
15:21:31  62  
15:21:31  63  		  if (v_inv_total > 0) then
15:21:31  64  		      return (v_ref_total / v_inv_total) * v_li_total;
15:21:31  65  		  else
15:21:31  66  		      return 0;
15:21:31  67  		  end if;
15:21:31  68  
15:21:31  69  	      end loop;
15:21:31  70  
15:21:31  71  	      return 0;
15:21:31  72  	  end;
15:21:31  73  ----
15:21:31  74  --------------------------------------------------------------------------------
15:21:31  75  ----
15:21:31  76  	PROCEDURE EXTRACT_LINE_ITEMS(
15:21:31  77  	  in_lower_date_bound DATE,
15:21:31  78  	  in_upper_date_bound DATE,
15:21:31  79  	  out_lic_cur OUT sys_refcursor
15:21:31  80  	) AS
15:21:31  81  	BEGIN
15:21:31  82  	  OPEN out_lic_cur FOR
15:21:31  83  	  with liq as (
15:21:31  84  		SELECT li2.id
15:21:31  85  		      FROM
15:21:31  86  			   line_item li2
15:21:31  87  		      WHERE
15:21:31  88  		      TRUNC(li2.create_date, 'HH') BETWEEN TRUNC(in_lower_date_bound,'HH') AND TRUNC(in_upper_date_bound,'HH')
15:21:31  89  		UNION
15:21:31  90  		SELECT li2.id
15:21:31  91  		      FROM
15:21:31  92  			   line_item li2
15:21:31  93  		      JOIN invoice i2 ON i2.id = li2.invoice_id
15:21:31  94  		      WHERE
15:21:31  95  		      TRUNC(i2.create_date, 'HH') BETWEEN TRUNC(in_lower_date_bound,'HH') AND TRUNC(in_upper_date_bound,'HH')
15:21:31  96  		UNION
15:21:31  97  		SELECT li2.id
15:21:31  98  		      FROM
15:21:31  99  			   line_item li2
15:21:31 100  		      JOIN license l2 ON li2.invoice_id = l2.invoice_id
15:21:31 101  		      WHERE
15:21:31 102  		      TRUNC(l2.create_date, 'HH') BETWEEN TRUNC(in_lower_date_bound,'HH') AND TRUNC(in_upper_date_bound,'HH')
15:21:31 103  		UNION
15:21:31 104  		SELECT li2.id
15:21:31 105  		      FROM
15:21:31 106  			   line_item li2
15:21:31 107  		      JOIN license l2 ON li2.invoice_id = l2.invoice_id
15:21:31 108  		      JOIN subscription s2 ON s2.id = l2.subscription_id
15:21:31 109  		      WHERE
15:21:31 110  		      TRUNC(s2.create_date, 'HH') BETWEEN TRUNC(in_lower_date_bound,'HH') AND TRUNC(in_upper_date_bound,'HH')
15:21:31 111  		UNION
15:21:31 112  		SELECT li2.id
15:21:31 113  		      FROM
15:21:31 114  			   line_item li2
15:21:31 115  		      JOIN invoice i2 ON i2.id = li2.invoice_id
15:21:31 116  		      JOIN charge c2 ON i2.id = c2.invoice_id
15:21:31 117  		      WHERE
15:21:31 118  		      TRUNC(c2.create_date, 'HH') BETWEEN TRUNC(in_lower_date_bound,'HH') AND TRUNC(in_upper_date_bound,'HH')
15:21:31 119  		UNION
15:21:31 120  		SELECT li2.id
15:21:31 121  		      FROM
15:21:31 122  			   line_item li2
15:21:31 123  		      JOIN invoice i2 ON i2.id = li2.invoice_id
15:21:31 124  		      JOIN charge c2 ON i2.id = c2.invoice_id
15:21:31 125  		      JOIN transaction t2 ON t2.id = c2.transaction_id
15:21:31 126  		      WHERE
15:21:31 127  		      TRUNC(t2.create_date, 'HH') BETWEEN TRUNC(in_lower_date_bound,'HH') AND TRUNC(in_upper_date_bound,'HH')
15:21:31 128  	  )
15:21:31 129  	  SELECT distinct
15:21:31 130  	    line_item.id				 line_item_id
15:21:31 131  	  , product.name				 product_name
15:21:31 132  	  , product.unit_price				 product_unit_price
15:21:31 133  	  , product.production_cost			 product_production_cost
15:21:31 134  	  , offer_chain.name				 offer_chain_name
15:21:31 135  	  , offer_chain_meta_data.value 		 offer_chain_metadata
15:21:31 136  	  , gclicense.purchase_date			 subscription_start_date
15:21:31 137  	  , gclicense.start_date			 license_start_date
15:21:31 138  	  , gclicense.end_date				 license_end_date
15:21:31 139  	  , credit_card.city				 cc_city
15:21:31 140  	  , credit_card.state				 cc_state
15:21:31 141  	  , credit_card.postal_code			 cc_postal_code
15:21:31 142  	  , line_item.create_date			 line_item_purchase_date
15:21:31 143  	  , gclicense.account_regi_id
15:21:31 144  	  , product_offering.quantity			 purchase_quantity
15:21:31 145  	  , case when charge.charge_amount > 0 then charge.charge_amount else 0 end purchase_amount
15:21:31 146  	  , PROCS_REPORTING_1A.getDiscountAmount(line_item.id) discount_amount
15:21:31 147  	  , PROCS_REPORTING_1A.getRefundAmount(line_item.id) refund_amount
15:21:31 148  	  , decode(gclicense.sct_id,null,0, 1)		 is_refund_cancel
15:21:31 149  	  , 0						 purchase_tax_amount
15:21:31 150  	  , transaction_attempt.external_transaction_id  external_transaction_id
15:21:31 151  	  , invoice.id					 invoice_number
15:21:31 152  	  , NVL2(transaction.id, 1, 0)			 has_transaction
15:21:31 153  	  , NVL2(credit_card.id, 1, 0)			 is_cc_transaction
15:21:31 154  	  , NVL2(gift_certificate.id, 1, 0)		 is_gc_transaction
15:21:31 155  	  FROM
15:21:31 156  	       line_item
15:21:31 157  	  JOIN invoice				ON invoice.id	       = line_item.invoice_id
15:21:31 158  	  JOIN product_offering 		ON product_offering.id = line_item.product_offer_id
15:21:31 159  	  JOIN product				ON product.id	       = product_offering.product_id
15:21:31 160  	  join (
15:21:31 161  		select license.invoice_id, subscription.offer_chain_id, subscription.purchase_date
15:21:31 162  		      ,subscription.sct_id, license.start_date, license.end_date
15:21:31 163  		      ,account.group_id account_regi_id
15:21:31 164  		from	 license
15:21:31 165  		    join subscription ON subscription.id = license.subscription_id
15:21:31 166  		    join account      ON account.id	 = subscription.account_id
15:21:31 167  		union all
15:21:31 168  		select gc.purchase_invoice_id invoice_id, gc.offer_chain_id, gc.purchase_date
15:21:31 169  		      ,null sct_id, gc.purchase_date start_date, gc.expiration_date end_date
15:21:31 170  		      ,gc.purchaser_group_id account_regi_id
15:21:31 171  		from	 gift_certificate gc
15:21:31 172  		where
15:21:31 173  		      TRUNC(gc.create_date, 'HH') between TRUNC(in_lower_date_bound,'HH') AND TRUNC(in_upper_date_bound,'HH')
15:21:31 174  
15:21:31 175  	  ) gclicense
15:21:31 176  						on gclicense.invoice_id = invoice.id
15:21:31 177  	  JOIN offer_chain			ON offer_chain.id      = gclicense.offer_chain_id
15:21:31 178  	  JOIN charge				ON invoice.id	       = charge.invoice_id and charge.charge_status_id = 2
15:21:31 179  	  JOIN transaction			ON transaction.id      = charge.transaction_id and transaction.transaction_status_id = 2
15:21:31 180  	  JOIN transaction_attempt		ON transaction.id	= transaction_attempt.transaction_id AND transaction_attempt.transaction_attempt_status_id = 2
15:21:31 181  	  LEFT OUTER JOIN credit_card		ON charge.instrument_id = credit_card.id AND charge.instrument_type_id = 1
15:21:31 182  	  LEFT OUTER JOIN gift_certificate	ON charge.instrument_id = gift_certificate.id AND charge.instrument_type_id = 3
15:21:31 183  	  LEFT OUTER JOIN offer_chain_meta_data ON offer_chain.id	= offer_chain_meta_data.offer_chain_id
15:21:31 184  	  join liq				on line_item.id 	= liq.id
15:21:31 185  	    ;
15:21:31 186  	END EXTRACT_LINE_ITEMS;
15:21:31 187  ----
15:21:31 188  --------------------------------------------------------------------------------
15:21:31 189  ----
15:21:31 190  END PROCS_REPORTING_1A;
15:21:31 191  .
15:21:31 SQL> /

Package body created.

Elapsed: 00:00:00.14
15:21:31 SQL> 
15:21:31 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_REPORTS_V5" AS
15:21:31   2  
15:21:31   3  FUNCTION GET_PRODUCT_NAMES(
15:21:31   4  	in_offer_id IN NUMBER
15:21:31   5  ) RETURN VARCHAR2 AS
15:21:31   6  var_result_names VARCHAR2(1024);
15:21:31   7  BEGIN
15:21:31   8  
15:21:31   9  	var_result_names := NULL;
15:21:31  10  
15:21:31  11  	FOR f_product IN (
15:21:31  12  	  SELECT
15:21:31  13  	    PRODUCT.NAME
15:21:31  14  	  FROM
15:21:31  15  	    PRODUCT
15:21:31  16  	    INNER JOIN PRODUCT_OFFERING ON PRODUCT_OFFERING.PRODUCT_ID = PRODUCT.ID
15:21:31  17  	    INNER JOIN OFFER_PRODUCT_OFFERING ON OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = PRODUCT_OFFERING.ID
15:21:31  18  	  WHERE
15:21:31  19  	    OFFER_PRODUCT_OFFERING.OFFER_ID = in_offer_id
15:21:31  20  	)
15:21:31  21  	LOOP
15:21:31  22  
15:21:31  23  	  IF var_result_names IS NULL THEN
15:21:31  24  	    var_result_names := f_product.NAME;
15:21:31  25  	  ELSE
15:21:31  26  	    var_result_names := var_result_names || ',' || CHR(13) || f_product.NAME;
15:21:31  27  	  END IF;
15:21:31  28  
15:21:31  29  	END LOOP;
15:21:31  30  
15:21:31  31  	RETURN var_result_names;
15:21:31  32  
15:21:31  33  END GET_PRODUCT_NAMES;
15:21:31  34  
15:21:31  35  /******************************************************************************/
15:21:31  36  
15:21:31  37  PROCEDURE GET_FULL_FLASH_REPORT_PURCH (
15:21:31  38  	in_start_date  IN DATE,
15:21:31  39  	in_end_date    IN DATE,
15:21:31  40  	out_result_set OUT SYS_REFCURSOR
15:21:31  41  ) AS
15:21:31  42  -- CONSTANTS
15:21:31  43  const_license_process_name CONSTANT VARCHAR2(9) := 'LICENSING';
15:21:31  44  BEGIN
15:21:31  45  
15:21:31  46  	OPEN out_result_set FOR
15:21:31  47  	SELECT
15:21:31  48  	  GET_PRODUCT_NAMES("Offer_Id") as "Product_Names",
15:21:31  49  	  "Offer_Id",
15:21:31  50  	  "New_Purchases_Num",
15:21:31  51  	  "Number_Of_renewals",
15:21:31  52  	  FLR_TOTAL_DOLLAR_VALUE("Offer_Id", in_start_date, in_end_date) as "Total_Dollar_Value",
15:21:31  53  	  FLR_UNIQUE_PURCHASERS("Offer_Id", in_start_date, in_end_date) as "Unique_Purchasers_num"
15:21:31  54  	FROM (
15:21:31  55  	  SELECT
15:21:31  56  	    "Offer_Id",
15:21:31  57  	    "Number_Of_renewals",
15:21:31  58  	    "New_Purchases_Num"
15:21:31  59  	  FROM (
15:21:31  60  	    SELECT
15:21:31  61  	      OFFER.ID as "Offer_Id",
15:21:31  62  	      FLR_RENEWALS_NUM(offer.id, in_start_date, in_end_date) as "Number_Of_renewals",
15:21:31  63  	      FLR_NEW_PURCHASERS_NUM(offer.id, in_start_date, in_end_date) as "New_Purchases_Num"
15:21:31  64  	    FROM
15:21:31  65  	      OFFER
15:21:31  66  	  )
15:21:31  67  	  WHERE
15:21:31  68  	    "New_Purchases_Num" > 0
15:21:31  69  	    OR "Number_Of_renewals" > 0
15:21:31  70  	);
15:21:31  71  
15:21:31  72  	/*
15:21:31  73  	OPEN out_result_set FOR
15:21:31  74  	SELECT
15:21:31  75  	  "Product_Names",
15:21:31  76  	  "Offer_Id",
15:21:31  77  	  "New_Purchases_Num",
15:21:31  78  	  "Number_Of_renewals",
15:21:31  79  	  "Total_Dollar_Value",
15:21:31  80  	  "Unique_Purchasers_num"
15:21:31  81  	FROM (
15:21:31  82  	  SELECT
15:21:31  83  	    GET_PRODUCT_NAMES(offer.id) as "Product_Names",
15:21:31  84  	    offer.id as "Offer_Id",
15:21:31  85  	    FLR_NEW_PURCHASERS_NUM(offer.id, in_start_date, in_end_date) as "New_Purchases_Num",
15:21:31  86  	    FLR_RENEWALS_NUM(offer.id, in_start_date, in_end_date) as "Number_Of_renewals",
15:21:31  87  	    FLR_TOTAL_DOLLAR_VALUE(offer.id, in_start_date, in_end_date) as "Total_Dollar_Value",
15:21:31  88  	    FLR_UNIQUE_PURCHASERS(offer.id, in_start_date, in_end_date) as "Unique_Purchasers_num"
15:21:31  89  	  FROM
15:21:31  90  	    OFFER
15:21:31  91  	)
15:21:31  92  	WHERE
15:21:31  93  	  "New_Purchases_Num" > 0
15:21:31  94  	  OR "Number_Of_renewals" > 0
15:21:31  95  	  OR "Total_Dollar_Value" > 0
15:21:31  96  	  OR "Unique_Purchasers_num" > 0;
15:21:31  97  	*/
15:21:31  98  
15:21:31  99  END GET_FULL_FLASH_REPORT_PURCH;
15:21:31 100  
15:21:31 101  /******************************************************************************/
15:21:31 102  
15:21:31 103  PROCEDURE GET_FLASH_REPORT_PURCHASES (
15:21:31 104  	in_offer_id	       IN NUMBER,
15:21:31 105  	in_start_date	       IN DATE,
15:21:31 106  	in_end_date	       IN DATE,
15:21:31 107  	out_new_purchasers_num OUT NUMBER,
15:21:31 108  	out_renewals_num       OUT NUMBER,
15:21:31 109  	out_product_names      OUT VARCHAR2,
15:21:31 110  	out_total_dollar_value OUT NUMBER,
15:21:31 111  	out_unique_purchasers  OUT NUMBER
15:21:31 112  ) AS
15:21:31 113  -- CONSTANTS
15:21:31 114  const_license_process_name CONSTANT VARCHAR2(9) := 'LICENSING';
15:21:31 115  BEGIN
15:21:31 116  
15:21:31 117  	out_product_names := GET_PRODUCT_NAMES(in_offer_id);
15:21:31 118  
15:21:31 119  	out_total_dollar_value := FLR_TOTAL_DOLLAR_VALUE(
15:21:31 120  	  in_offer_id,
15:21:31 121  	  in_start_date,
15:21:31 122  	  in_end_date
15:21:31 123  	);
15:21:31 124  
15:21:31 125  	out_new_purchasers_num := FLR_NEW_PURCHASERS_NUM(
15:21:31 126  	  in_offer_id,
15:21:31 127  	  in_start_date,
15:21:31 128  	  in_end_date
15:21:31 129  	);
15:21:31 130  
15:21:31 131  	out_renewals_num := FLR_RENEWALS_NUM(
15:21:31 132  	  in_offer_id,
15:21:31 133  	  in_start_date,
15:21:31 134  	  in_end_date
15:21:31 135  	);
15:21:31 136  
15:21:31 137  	out_unique_purchasers := FLR_UNIQUE_PURCHASERS(
15:21:31 138  	  in_offer_id,
15:21:31 139  	  in_start_date,
15:21:31 140  	  in_end_date
15:21:31 141  	);
15:21:31 142  
15:21:31 143  END GET_FLASH_REPORT_PURCHASES;
15:21:31 144  
15:21:31 145  /******************************************************************************/
15:21:31 146  
15:21:31 147  FUNCTION FLR_NEW_PURCHASERS_NUM (
15:21:31 148  	in_offer_id	       IN NUMBER,
15:21:31 149  	in_start_date	       IN DATE,
15:21:31 150  	in_end_date	       IN DATE
15:21:31 151  ) RETURN NUMBER AS
15:21:31 152  -- CONSTANTS
15:21:31 153  const_license_process_name CONSTANT VARCHAR2(9) := 'LICENSING';
15:21:31 154  -- VARIABLES
15:21:31 155  var_new_purchases_num NUMBER;
15:21:31 156  BEGIN
15:21:31 157  	SELECT
15:21:31 158  	  COUNT(LICENSE.ID)
15:21:31 159  	  into
15:21:31 160  	  var_new_purchases_num
15:21:31 161  	FROM
15:21:31 162  	  LICENSE
15:21:31 163  	  INNER JOIN CHARGE ON LICENSE.INVOICE_ID = CHARGE.INVOICE_ID
15:21:31 164  	WHERE
15:21:31 165  	  LICENSE.CREATED_BY NOT LIKE const_license_process_name
15:21:31 166  	  AND LICENSE.OFFER_ID = in_offer_id
15:21:31 167  	  AND CHARGE.CHARGE_AMOUNT > 0
15:21:31 168  	  AND PROCS_CHARGE_V5.IS_CHARGE_COLLECTED(CHARGE.ID) = 1 -- GLOBAL_CONSTANTS_V5.TRUE
15:21:31 169  	  AND LICENSE.START_DATE BETWEEN in_start_date AND in_end_date;
15:21:31 170  
15:21:31 171  	RETURN var_new_purchases_num;
15:21:31 172  END FLR_NEW_PURCHASERS_NUM;
15:21:31 173  
15:21:31 174  /******************************************************************************/
15:21:31 175  
15:21:31 176  FUNCTION FLR_RENEWALS_NUM (
15:21:31 177  	in_offer_id	       IN NUMBER,
15:21:31 178  	in_start_date	       IN DATE,
15:21:31 179  	in_end_date	       IN DATE
15:21:31 180  ) RETURN NUMBER AS
15:21:31 181  -- CONSTANTS
15:21:31 182  const_license_process_name CONSTANT VARCHAR2(9) := 'LICENSING';
15:21:31 183  -- VARIABLES
15:21:31 184  var_renewals_num NUMBER;
15:21:31 185  BEGIN
15:21:31 186  	SELECT
15:21:31 187  	  COUNT(LICENSE.ID)
15:21:31 188  	  into
15:21:31 189  	  var_renewals_num
15:21:31 190  	FROM
15:21:31 191  	  LICENSE
15:21:31 192  	  INNER JOIN CHARGE ON LICENSE.INVOICE_ID = CHARGE.INVOICE_ID
15:21:31 193  	WHERE
15:21:31 194  	  LICENSE.CREATED_BY LIKE const_license_process_name
15:21:31 195  	  AND LICENSE.OFFER_ID = in_offer_id
15:21:31 196  	  AND CHARGE.CHARGE_AMOUNT > 0
15:21:31 197  	  AND PROCS_CHARGE_V5.IS_CHARGE_COLLECTED(CHARGE.ID) = 1 -- GLOBAL_CONSTANTS_V5.TRUE
15:21:31 198  	  AND LICENSE.START_DATE BETWEEN in_start_date AND in_end_date;
15:21:31 199  
15:21:31 200  	RETURN var_renewals_num;
15:21:31 201  END FLR_RENEWALS_NUM;
15:21:31 202  
15:21:31 203  /******************************************************************************/
15:21:31 204  
15:21:31 205  FUNCTION FLR_TOTAL_DOLLAR_VALUE (
15:21:31 206  	in_offer_id	       IN NUMBER,
15:21:31 207  	in_start_date	       IN DATE,
15:21:31 208  	in_end_date	       IN DATE
15:21:31 209  ) RETURN NUMBER AS
15:21:31 210  var_dollar_value NUMBER(10,2);
15:21:31 211  BEGIN
15:21:31 212  	SELECT
15:21:31 213  	  SUM(CHARGE.CHARGE_AMOUNT)
15:21:31 214  	  into
15:21:31 215  	  var_dollar_value
15:21:31 216  	FROM
15:21:31 217  	  LICENSE
15:21:31 218  	  INNER JOIN CHARGE ON LICENSE.INVOICE_ID = CHARGE.INVOICE_ID
15:21:31 219  	WHERE
15:21:31 220  	  LICENSE.OFFER_ID = in_offer_id
15:21:31 221  	  AND CHARGE.CHARGE_AMOUNT > 0
15:21:31 222  	  AND PROCS_CHARGE_V5.IS_CHARGE_COLLECTED(CHARGE.ID) = 1 -- GLOBAL_CONSTANTS_V5.TRUE
15:21:31 223  	  AND LICENSE.START_DATE BETWEEN in_start_date AND in_end_date;
15:21:31 224  
15:21:31 225  	RETURN var_dollar_value;
15:21:31 226  END FLR_TOTAL_DOLLAR_VALUE;
15:21:31 227  
15:21:31 228  /******************************************************************************/
15:21:31 229  
15:21:31 230  FUNCTION FLR_UNIQUE_PURCHASERS (
15:21:31 231  	in_offer_id	       IN NUMBER,
15:21:31 232  	in_start_date	       IN DATE,
15:21:31 233  	in_end_date	       IN DATE
15:21:31 234  ) RETURN NUMBER AS
15:21:31 235  -- CONSTANTS
15:21:31 236  const_license_process_name CONSTANT VARCHAR2(9) := 'LICENSING';
15:21:31 237  -- VARIABLES
15:21:31 238  var_unique_purchasers NUMBER;
15:21:31 239  BEGIN
15:21:31 240  	SELECT
15:21:31 241  	  COUNT(DISTINCT SUBSCRIPTION.ACCOUNT_ID) into var_unique_purchasers
15:21:31 242  	FROM
15:21:31 243  	  LICENSE
15:21:31 244  	  INNER JOIN CHARGE ON LICENSE.INVOICE_ID = CHARGE.INVOICE_ID
15:21:31 245  	  INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
15:21:31 246  	WHERE
15:21:31 247  	  LICENSE.CREATED_BY NOT LIKE const_license_process_name
15:21:31 248  	  AND LICENSE.OFFER_ID = in_offer_id
15:21:31 249  	  AND CHARGE.CHARGE_AMOUNT > 0
15:21:31 250  	  AND PROCS_CHARGE_V5.IS_CHARGE_COLLECTED(CHARGE.ID) = 1 -- GLOBAL_CONSTANTS_V5.TRUE
15:21:31 251  	  AND LICENSE.START_DATE BETWEEN in_start_date AND in_end_date;
15:21:31 252  
15:21:31 253  	RETURN var_unique_purchasers;
15:21:31 254  END;
15:21:31 255  
15:21:31 256  END PROCS_REPORTS_V5;
15:21:31 257  .
15:21:31 SQL> /

Package body created.

Elapsed: 00:00:00.25
15:21:31 SQL> 
15:21:31 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_SYSTEM_V18" AS
15:21:31   2  
15:21:31   3  PROCEDURE INCREMENT_VERSION
15:21:31   4  /*
15:21:31   5  Throws exceptions:
15:21:31   6  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31   7  */
15:21:31   8  AS
15:21:31   9  BEGIN
15:21:31  10  
15:21:31  11  	UPDATE SYS_VERSION SET version=version+1;
15:21:31  12  
15:21:31  13  END INCREMENT_VERSION;
15:21:31  14  
15:21:31  15  /*************************************************************/
15:21:31  16  
15:21:31  17  PROCEDURE CHECK_VERSION(
15:21:31  18  	  in_vers    IN NUMBER,
15:21:31  19  	  out_result OUT NUMBER
15:21:31  20  ) AS
15:21:31  21  	current_version NUMBER;
15:21:31  22  BEGIN
15:21:31  23  	SELECT version INTO current_version FROM SYS_VERSION;
15:21:31  24  	IF(current_version != in_vers) THEN
15:21:31  25  	  out_result := 1;
15:21:31  26  	ELSE
15:21:31  27  	  out_result := 0;
15:21:31  28  	END IF;
15:21:31  29  END CHECK_VERSION;
15:21:31  30  
15:21:31  31  END PROCS_SYSTEM_V18;
15:21:31  32  .
15:21:31 SQL> /

Package body created.

Elapsed: 00:00:00.02
15:21:31 SQL> 
15:21:31 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_TAXES_V18" AS
15:21:31   2  
15:21:31   3  PROCEDURE ADD_TAX (
15:21:31   4  	in_tax_type_id		 IN NUMBER,
15:21:31   5  	in_calculated_amount	 IN NUMBER,
15:21:31   6  	in_created_by		 IN VARCHAR2,
15:21:31   7  	in_line_item_id 	 IN NUMBER,
15:21:31   8  	in_effective_rate	 IN VARCHAR2,
15:21:31   9  	in_taxable_amount	 IN NUMBER,
15:21:31  10  	in_tax_rule_id		 IN NUMBER,
15:21:31  11  	in_jurisdiction_level_id IN NUMBER,
15:21:31  12  	in_jurisdiction_name	 IN VARCHAR2,
15:21:31  13  	in_jurisdiction_id	 IN VARCHAR2,
15:21:31  14  	in_ext_tax_type 	 IN VARCHAR2,
15:21:31  15  	in_ext_result		 IN VARCHAR2,
15:21:31  16  	in_imposition_type	 IN VARCHAR2,
15:21:31  17  	in_imposition		 IN VARCHAR2
15:21:31  18  ) AS
15:21:31  19  SPROC_NAME CONSTANT VARCHAR2(7) := 'ADD_TAX';
15:21:31  20  -- VARIABLES
15:21:31  21  var_new_tax_id	NUMBER;
15:21:31  22  temp_line_item_id NUMBER;
15:21:31  23  -- EXCEPTIONS
15:21:31  24  BAD_LINE_ITEM_ID EXCEPTION;
15:21:31  25  BEGIN
15:21:31  26  
15:21:31  27  	BEGIN
15:21:31  28  	  SELECT
15:21:31  29  	    LINE_ITEM.ID into temp_line_item_id
15:21:31  30  	  FROM
15:21:31  31  	    LINE_ITEM
15:21:31  32  	  WHERE
15:21:31  33  	    LINE_ITEM.ID = in_line_item_id;
15:21:31  34  	  EXCEPTION
15:21:31  35  	    WHEN NO_DATA_FOUND THEN
15:21:31  36  	      RAISE BAD_LINE_ITEM_ID;
15:21:31  37  	END;
15:21:31  38  
15:21:31  39  	var_new_tax_id := NULL;
15:21:31  40  
15:21:31  41  	PROCS_TAXES_CRU_V18.CREATE_TAX(
15:21:31  42  	  var_new_tax_id,
15:21:31  43  	  in_tax_type_id,
15:21:31  44  	  in_calculated_amount,
15:21:31  45  	  in_created_by,
15:21:31  46  	  in_line_item_id,
15:21:31  47  	  in_effective_rate,
15:21:31  48  	  in_taxable_amount,
15:21:31  49  	  in_tax_rule_id,
15:21:31  50  	  in_jurisdiction_level_id,
15:21:31  51  	  in_jurisdiction_name,
15:21:31  52  	  in_jurisdiction_id,
15:21:31  53  	  in_ext_tax_type,
15:21:31  54  	  in_ext_result,
15:21:31  55  	  in_imposition_type,
15:21:31  56  	  in_imposition
15:21:31  57  	);
15:21:31  58  
15:21:31  59  EXCEPTION
15:21:31  60  WHEN BAD_LINE_ITEM_ID THEN
15:21:31  61  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31  62  	  SPROC_NAME, 'No such line item');
15:21:31  63  WHEN OTHERS THEN
15:21:31  64  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31  65  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31  66  END ADD_TAX;
15:21:31  67  
15:21:31  68  /******************************************************************************/
15:21:31  69  
15:21:31  70  PROCEDURE CHECK_COUNTRY_FOR_EXCLUSION (
15:21:31  71  	in_country_code IN CHAR,
15:21:31  72  	in_check_date IN DATE,
15:21:31  73  	out_is_founded	OUT NUMBER -- GLOBAL_CONSTANT.TRUE of GLOBAL_CONSTANTS_V18.FALSE
15:21:31  74  ) AS
15:21:31  75  SPROC_NAME CONSTANT VARCHAR2(27) := 'CHECK_COUNTRY_FOR_EXCLUSION';
15:21:31  76  -- VARIABLES
15:21:31  77  var_countries_count NUMBER;
15:21:31  78  var_result	  NUMBER;
15:21:31  79  BEGIN
15:21:31  80  
15:21:31  81  	SELECT
15:21:31  82  	  COUNT(1) into var_countries_count
15:21:31  83  	FROM
15:21:31  84  	  TAX_COUNTRY_EXCLUSION_LIST
15:21:31  85  	WHERE
15:21:31  86  	  country_code = in_country_code
15:21:31  87  	  AND TRUNC(EFFECTIVE_DATE) <= TRUNC(in_check_date)
15:21:31  88  	  AND (
15:21:31  89  	    end_date is null
15:21:31  90  	    OR TRUNC(END_DATE) >= TRUNC(in_check_date)
15:21:31  91  	  );
15:21:31  92  
15:21:31  93  	IF var_countries_count > 1 THEN
15:21:31  94  	  -- [REVU] Should not happen. DB structure error
15:21:31  95  	  var_result := GLOBAL_CONSTANTS_V18.TRUE;
15:21:31  96  	ELSIF var_countries_count = 1 THEN
15:21:31  97  	  var_result := GLOBAL_CONSTANTS_V18.TRUE;
15:21:31  98  	ELSE
15:21:31  99  	  var_result := GLOBAL_CONSTANTS_V18.FALSE;
15:21:31 100  	END IF;
15:21:31 101  
15:21:31 102  	out_is_founded := var_result;
15:21:31 103  
15:21:31 104  EXCEPTION
15:21:31 105  WHEN OTHERS THEN
15:21:31 106  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 107  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 108  END CHECK_COUNTRY_FOR_EXCLUSION;
15:21:31 109  
15:21:31 110  /******************************************************************************/
15:21:31 111  
15:21:31 112  PROCEDURE GET_TAX_CATEGORY (
15:21:31 113  	in_tax_category_id IN NUMBER,
15:21:31 114  	out_result_set	   OUT SYS_REFCURSOR
15:21:31 115  ) AS
15:21:31 116  SPROC_NAME CONSTANT VARCHAR2(16) := 'GET_TAX_CATEGORY';
15:21:31 117  BEGIN
15:21:31 118  
15:21:31 119  	OPEN out_result_set FOR
15:21:31 120  	SELECT
15:21:31 121  	  ID,
15:21:31 122  	  CODE,
15:21:31 123  	  DESCRIPTION
15:21:31 124  	FROM
15:21:31 125  	  TAX_CATEGORY
15:21:31 126  	WHERE
15:21:31 127  	  ID = in_tax_category_id;
15:21:31 128  
15:21:31 129  EXCEPTION
15:21:31 130  WHEN OTHERS THEN
15:21:31 131  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 132  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 133  END GET_TAX_CATEGORY;
15:21:31 134  
15:21:31 135  END PROCS_TAXES_V18;
15:21:31 136  .
15:21:31 SQL> /

Package body created.

Elapsed: 00:00:00.03
15:21:31 SQL> 
15:21:31 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_TRANSACTION_V18" AS
15:21:31   2  
15:21:31   3  PROCEDURE CREATE_TRANSACTION (
15:21:31   4  /*
15:21:31   5  Throws exceptions:
15:21:31   6  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:31   7  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31   8  */
15:21:31   9  	in_transaction_id	  IN NUMBER,
15:21:31  10  	in_status_id		  IN NUMBER,
15:21:31  11  	in_amount		  IN NUMBER,
15:21:31  12  	in_created_by		  IN VARCHAR2,
15:21:31  13  	in_order_id		  IN VARCHAR2,
15:21:31  14  	in_is_refund		  IN NUMBER DEFAULT GLOBAL_CONSTANTS_V18.FALSE,
15:21:31  15  	in_transaction_type_code  IN VARCHAR2 DEFAULT NULL,
15:21:31  16  	out_transaction_id	  OUT NUMBER
15:21:31  17  ) AS
15:21:31  18  -- VARIABLES
15:21:31  19  SPROC_NAME	     CONSTANT VARCHAR2(18) := 'CREATE_TRANSACTION';
15:21:31  20  var_transaction_count  NUMBER;
15:21:31  21  -- EXCEPTIONS
15:21:31  22  BAD_TRANSACTION_ID     EXCEPTION;
15:21:31  23  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:31  24  BEGIN
15:21:31  25  
15:21:31  26  	IF in_transaction_id IS NOT NULL THEN
15:21:31  27  	  SELECT
15:21:31  28  	    COUNT(*) into var_transaction_count
15:21:31  29  	  FROM
15:21:31  30  	    TRANSACTION
15:21:31  31  	  WHERE
15:21:31  32  	    TRANSACTION.ID = in_transaction_id;
15:21:31  33  	  IF var_transaction_count > 0 THEN
15:21:31  34  	    RAISE BAD_TRANSACTION_ID;
15:21:31  35  	  END IF;
15:21:31  36  	END IF;
15:21:31  37  
15:21:31  38  	PROCS_TRANSACTION_CRU_V18.CREATE_TRANSACTION(
15:21:31  39  	  out_transaction_id	   => out_transaction_id,
15:21:31  40  	  in_transaction_id	   => in_transaction_id,
15:21:31  41  	  in_transaction_status_id => in_status_id,
15:21:31  42  	  in_transaction_amount    => in_amount,
15:21:31  43  	  in_created_by 	   => in_created_by,
15:21:31  44  	  in_order_id		   => in_order_id,
15:21:31  45  	  in_is_refund		   => in_is_refund,
15:21:31  46  	  in_transaction_type_code => in_transaction_type_code
15:21:31  47  	);
15:21:31  48  
15:21:31  49  EXCEPTION
15:21:31  50  WHEN BAD_TRANSACTION_ID THEN
15:21:31  51  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.DUPLICATE_ERROR,
15:21:31  52  	  SPROC_NAME, 'Transaction with given id already exists');
15:21:31  53  WHEN OTHERS THEN
15:21:31  54  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31  55  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31  56  END CREATE_TRANSACTION;
15:21:31  57  
15:21:31  58  /******************************************************************************/
15:21:31  59  
15:21:31  60  PROCEDURE CREATE_TRANSACTION_ATTEMPT (
15:21:31  61  /*
15:21:31  62  Throws exceptions:
15:21:31  63  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:31  64  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31  65  */
15:21:31  66  	in_transaction_id	   IN NUMBER,
15:21:31  67  	in_trans_attempt_status    IN NUMBER,
15:21:31  68  	in_external_status_code    IN VARCHAR2,
15:21:31  69  	in_external_status_message IN VARCHAR2,
15:21:31  70  	in_created_by		   IN VARCHAR2,
15:21:31  71  	in_ext_transaction_id	   IN VARCHAR2,
15:21:31  72  	out_transaction_attempt_id OUT NUMBER
15:21:31  73  ) AS
15:21:31  74  -- VARIABLES
15:21:31  75  SPROC_NAME		 CONSTANT VARCHAR2(26) := 'CREATE_TRANSACTION_ATTEMPT';
15:21:31  76  var_transaction_create_date DATE;
15:21:31  77  var_transaction_attempt_id  NUMBER;
15:21:31  78  
15:21:31  79  -- EXCEPTIONS
15:21:31  80  BAD_TRANS_ATTEMPT_STATUS EXCEPTION;
15:21:31  81  BAD_TRANSACTION_ID       EXCEPTION;
15:21:31  82  BEGIN
15:21:31  83  
15:21:31  84  	-- Check that transaction exists
15:21:31  85  	BEGIN
15:21:31  86  	  SELECT
15:21:31  87  	    TRANSACTION.CREATE_DATE into var_transaction_create_date
15:21:31  88  	  FROM
15:21:31  89  	    TRANSACTION
15:21:31  90  	  WHERE
15:21:31  91  	    TRANSACTION.ID = in_transaction_id;
15:21:31  92  	  EXCEPTION
15:21:31  93  	    WHEN OTHERS THEN
15:21:31  94  	      RAISE BAD_TRANSACTION_ID;
15:21:31  95  	END;
15:21:31  96  
15:21:31  97  	-- Check that transaction status is correct
15:21:31  98  	IF in_trans_attempt_status != GLOBAL_STATUSES_V18.TRANS_ATTEMPT_IN_PROGRESS
15:21:31  99  	  AND in_trans_attempt_status != GLOBAL_STATUSES_V18.TRANS_ATTEMPT_SUCCESS
15:21:31 100  	  AND in_trans_attempt_status != GLOBAL_STATUSES_V18.TRANS_ATTEMPT_FAILED THEN
15:21:31 101  	  RAISE BAD_TRANS_ATTEMPT_STATUS;
15:21:31 102  	END IF;
15:21:31 103  
15:21:31 104  	var_transaction_attempt_id := NULL;
15:21:31 105  	PROCS_TRANSACTION_CRU_V18.CREATE_TRANSACTION_ATTEMPT(
15:21:31 106  	  inout_transaction_attempt_id => var_transaction_attempt_id,
15:21:31 107  	  in_transaction_id	       => in_transaction_id,
15:21:31 108  	  in_external_status_code      => in_external_status_code,
15:21:31 109  	  in_external_status_message   => in_external_status_message,
15:21:31 110  	  in_created_by 	       => in_created_by,
15:21:31 111  	  in_external_transaction_id   => in_ext_transaction_id,
15:21:31 112  	  in_transaction_start_time    => var_transaction_create_date,
15:21:31 113  	  in_status_id		       => in_trans_attempt_status
15:21:31 114  	);
15:21:31 115  
15:21:31 116  	PROCS_TRANSACTION_CRU_V18.UPDATE_TRANSACTION(
15:21:31 117  	  in_transaction_id => in_transaction_id,
15:21:31 118  	  in_updated_by     => in_created_by
15:21:31 119  	);
15:21:31 120  
15:21:31 121  	out_transaction_attempt_id := var_transaction_attempt_id;
15:21:31 122  
15:21:31 123  EXCEPTION
15:21:31 124  WHEN BAD_TRANSACTION_ID THEN
15:21:31 125  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 126  	  SPROC_NAME, 'No such transaction');
15:21:31 127  WHEN BAD_TRANS_ATTEMPT_STATUS THEN
15:21:31 128  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:31 129  	  SPROC_NAME, 'Bad transaction attempt status');
15:21:31 130  WHEN OTHERS THEN
15:21:31 131  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 132  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 133  END CREATE_TRANSACTION_ATTEMPT;
15:21:31 134  
15:21:31 135  /******************************************************************************/
15:21:31 136  
15:21:31 137  PROCEDURE UPDATE_TRANSACTION_STATUS (
15:21:31 138  /*
15:21:31 139  Throws exceptions:
15:21:31 140  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:31 141  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31 142  */
15:21:31 143  	in_transaction_id	 IN NUMBER,
15:21:31 144  	in_updated_by		 IN VARCHAR2,
15:21:31 145  	in_transaction_status_id IN NUMBER
15:21:31 146  ) AS
15:21:31 147  -- VARIABLES
15:21:31 148  SPROC_NAME	  CONSTANT VARCHAR2(25) := 'UPDATE_TRANSACTION_STATUS';
15:21:31 149  temp_transaction_id NUMBER;
15:21:31 150  
15:21:31 151  -- EXCEPTIONS
15:21:31 152  BAD_TRANSACTION_ID     EXCEPTION;
15:21:31 153  BAD_TRANSACTION_STATUS EXCEPTION;
15:21:31 154  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:31 155  BEGIN
15:21:31 156  
15:21:31 157  	-- Check that transaction exists
15:21:31 158  	BEGIN
15:21:31 159  	  SELECT
15:21:31 160  	    TRANSACTION.ID into temp_transaction_id
15:21:31 161  	  FROM
15:21:31 162  	    TRANSACTION
15:21:31 163  	  WHERE
15:21:31 164  	    TRANSACTION.ID = in_transaction_id;
15:21:31 165  	  EXCEPTION
15:21:31 166  	    WHEN OTHERS THEN
15:21:31 167  	      RAISE BAD_TRANSACTION_ID;
15:21:31 168  	END;
15:21:31 169  
15:21:31 170  	-- Check that transaction status is correct
15:21:31 171  	IF    in_transaction_status_id != GLOBAL_STATUSES_V18.TRANSACTION_PENDING
15:21:31 172  	  AND in_transaction_status_id != GLOBAL_STATUSES_V18.TRANSACTION_CLOSED
15:21:31 173  	  AND in_transaction_status_id != GLOBAL_STATUSES_V18.TRANSACTION_CHARGEBACK
15:21:31 174  	  AND in_transaction_status_id != GLOBAL_STATUSES_V18.TRANSACTION_DECLINED THEN
15:21:31 175  	  RAISE BAD_TRANSACTION_STATUS;
15:21:31 176  	END IF;
15:21:31 177  
15:21:31 178  	PROCS_TRANSACTION_CRU_V18.UPDATE_TRANSACTION(
15:21:31 179  	  in_transaction_id	   => in_transaction_id,
15:21:31 180  	  in_updated_by 	   => in_updated_by,
15:21:31 181  	  in_transaction_status_id => in_transaction_status_id
15:21:31 182  	);
15:21:31 183  
15:21:31 184  EXCEPTION
15:21:31 185  WHEN BAD_TRANSACTION_ID THEN
15:21:31 186  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 187  	  SPROC_NAME, 'No such transaction');
15:21:31 188  WHEN BAD_TRANSACTION_STATUS THEN
15:21:31 189  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:31 190  	  SPROC_NAME, 'Bad transaction status');
15:21:31 191  WHEN OTHERS THEN
15:21:31 192  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 193  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 194  END UPDATE_TRANSACTION_STATUS;
15:21:31 195  
15:21:31 196  /******************************************************************************/
15:21:31 197  
15:21:31 198  PROCEDURE UPDATE_TRANSACTION_SETTLED (
15:21:31 199  /*
15:21:31 200  Throws exceptions:
15:21:31 201  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:31 202  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31 203  */
15:21:31 204  	in_transaction_id	 IN NUMBER,
15:21:31 205  	in_updated_by		 IN VARCHAR2,
15:21:31 206  	in_is_settled		 IN NUMBER
15:21:31 207  ) AS
15:21:31 208  -- VARIABLES
15:21:31 209  SPROC_NAME	  CONSTANT VARCHAR2(26) := 'UPDATE_TRANSACTION_SETTLED';
15:21:31 210  temp_transaction_id NUMBER;
15:21:31 211  
15:21:31 212  -- EXCEPTIONS
15:21:31 213  BAD_TRANSACTION_ID     EXCEPTION;
15:21:31 214  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:31 215  BEGIN
15:21:31 216  
15:21:31 217  	-- Check that transaction exists
15:21:31 218  	BEGIN
15:21:31 219  	  SELECT
15:21:31 220  	    TRANSACTION.ID into temp_transaction_id
15:21:31 221  	  FROM
15:21:31 222  	    TRANSACTION
15:21:31 223  	  WHERE
15:21:31 224  	    TRANSACTION.ID = in_transaction_id;
15:21:31 225  	  EXCEPTION
15:21:31 226  	    WHEN OTHERS THEN
15:21:31 227  	      RAISE BAD_TRANSACTION_ID;
15:21:31 228  	END;
15:21:31 229  
15:21:31 230  	PROCS_TRANSACTION_CRU_V18.UPDATE_TRANSACTION(
15:21:31 231  	  in_transaction_id	   => in_transaction_id,
15:21:31 232  	  in_updated_by 	   => in_updated_by,
15:21:31 233  	  in_is_settled 	   => in_is_settled
15:21:31 234  	);
15:21:31 235  
15:21:31 236  EXCEPTION
15:21:31 237  WHEN BAD_TRANSACTION_ID THEN
15:21:31 238  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 239  	  SPROC_NAME, 'No such transaction');
15:21:31 240  WHEN OTHERS THEN
15:21:31 241  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 242  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 243  END UPDATE_TRANSACTION_SETTLED;
15:21:31 244  
15:21:31 245  /******************************************************************************/
15:21:31 246  
15:21:31 247  PROCEDURE UPDATE_TRNSCTN_ATTEMPT_TIME (
15:21:31 248  /*
15:21:31 249  Throws exceptions:
15:21:31 250  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:31 251  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31 252  */
15:21:31 253  	in_transaction_attempt_id IN NUMBER,
15:21:31 254  	in_updated_by		  IN VARCHAR2
15:21:31 255  ) AS
15:21:31 256  SPROC_NAME CONSTANT VARCHAR2(27) := 'UPDATE_TRNSCTN_ATTEMPT_TIME';
15:21:31 257  -- VARIABLES
15:21:31 258  var_transaction_id NUMBER;
15:21:31 259  -- EXCEPTION
15:21:31 260  BAD_TRANSACTION_ATTEMPT_ID EXCEPTION;
15:21:31 261  BEGIN
15:21:31 262  
15:21:31 263  	BEGIN
15:21:31 264  	  SELECT
15:21:31 265  	    TRANSACTION_ATTEMPT.TRANSACTION_ID into var_transaction_id
15:21:31 266  	  FROM
15:21:31 267  	    TRANSACTION_ATTEMPT
15:21:31 268  	  WHERE
15:21:31 269  	    TRANSACTION_ATTEMPT.ID = in_transaction_attempt_id;
15:21:31 270  	  EXCEPTION
15:21:31 271  	    WHEN NO_DATA_FOUND THEN
15:21:31 272  	      RAISE BAD_TRANSACTION_ATTEMPT_ID;
15:21:31 273  	END;
15:21:31 274  
15:21:31 275  	PROCS_TRANSACTION_CRU_V18.UPDATE_TRANSACTION(
15:21:31 276  	  in_transaction_id => var_transaction_id,
15:21:31 277  	  in_updated_by     => in_updated_by
15:21:31 278  	);
15:21:31 279  
15:21:31 280  EXCEPTION
15:21:31 281  WHEN BAD_TRANSACTION_ATTEMPT_ID THEN
15:21:31 282  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 283  	  SPROC_NAME, 'No such transaction attempt');
15:21:31 284  WHEN OTHERS THEN
15:21:31 285  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 286  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 287  END UPDATE_TRNSCTN_ATTEMPT_TIME;
15:21:31 288  
15:21:31 289  /******************************************************************************/
15:21:31 290  
15:21:31 291  PROCEDURE UPDATE_TRNSCTN_ATTEMPT_STATUS (
15:21:31 292  /*
15:21:31 293  Throws exceptions:
15:21:31 294  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:31 295  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31 296  */
15:21:31 297  	in_transaction_attempt_id     IN NUMBER,
15:21:31 298  	in_transaction_attempt_status IN NUMBER
15:21:31 299  ) AS
15:21:31 300  -- VARIABLES
15:21:31 301  SPROC_NAME		  CONSTANT VARCHAR2(29) := 'UPDATE_TRNSCTN_ATTEMPT_STATUS';
15:21:31 302  temp_transaction_attempt_id NUMBER;
15:21:31 303  
15:21:31 304  -- EXCEPTION
15:21:31 305  BAD_TRANSACTION_ATTEMPT_ID EXCEPTION;
15:21:31 306  BAD_TRANS_ATTEMPT_STATUS	 EXCEPTION;
15:21:31 307  BEGIN
15:21:31 308  
15:21:31 309  	-- Check that transaction attempt exists
15:21:31 310  	BEGIN
15:21:31 311  	  SELECT
15:21:31 312  	    TRANSACTION_ATTEMPT.ID into temp_transaction_attempt_id
15:21:31 313  	  FROM
15:21:31 314  	    TRANSACTION_ATTEMPT
15:21:31 315  	  WHERE
15:21:31 316  	    TRANSACTION_ATTEMPT.ID = in_transaction_attempt_id;
15:21:31 317  	  EXCEPTION
15:21:31 318  	    WHEN NO_DATA_FOUND THEN
15:21:31 319  	      RAISE BAD_TRANSACTION_ATTEMPT_ID;
15:21:31 320  	END;
15:21:31 321  
15:21:31 322  	-- Check that transaction attempt is correct
15:21:31 323  	IF in_transaction_attempt_status != GLOBAL_STATUSES_V18.TRANS_ATTEMPT_IN_PROGRESS
15:21:31 324  	  AND in_transaction_attempt_status != GLOBAL_STATUSES_V18.TRANS_ATTEMPT_SUCCESS
15:21:31 325  	  AND in_transaction_attempt_status != GLOBAL_STATUSES_V18.TRANS_ATTEMPT_FAILED THEN
15:21:31 326  	  RAISE BAD_TRANS_ATTEMPT_STATUS;
15:21:31 327  	END IF;
15:21:31 328  
15:21:31 329  	PROCS_TRANSACTION_CRU_V18.UPDATE_TRANSACTION_ATTEMPT(
15:21:31 330  	  in_transaction_attempt_id => in_transaction_attempt_id,
15:21:31 331  	  in_status_id		    => in_transaction_attempt_status
15:21:31 332  	);
15:21:31 333  
15:21:31 334  EXCEPTION
15:21:31 335  WHEN BAD_TRANSACTION_ATTEMPT_ID THEN
15:21:31 336  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 337  	  SPROC_NAME, 'No such transaction attempt');
15:21:31 338  WHEN BAD_TRANS_ATTEMPT_STATUS THEN
15:21:31 339  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:31 340  	  SPROC_NAME, 'Bad transaction attempt status');
15:21:31 341  WHEN OTHERS THEN
15:21:31 342  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 343  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 344  END UPDATE_TRNSCTN_ATTEMPT_STATUS;
15:21:31 345  
15:21:31 346  /******************************************************************************/
15:21:31 347  
15:21:31 348  PROCEDURE GET_TRNSCTN_ATTEMPTS_BY_STATUS (
15:21:31 349  /*
15:21:31 350  Throws exceptions:
15:21:31 351  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31 352  */
15:21:31 353  	in_transaction_id	      IN NUMBER,
15:21:31 354  	in_transaction_attempt_status IN NUMBER,
15:21:31 355  	out_result_set		      OUT SYS_REFCURSOR
15:21:31 356  ) AS
15:21:31 357  -- VARIABLES
15:21:31 358  SPROC_NAME	  CONSTANT VARCHAR2(30) := 'GET_TRNSCTN_ATTEMPTS_BY_STATUS';
15:21:31 359  temp_transaction_id NUMBER;
15:21:31 360  -- EXCEPTIONS
15:21:31 361  BAD_TRANSACTION_ID       EXCEPTION;
15:21:31 362  BAD_TRANS_ATTEMPT_STATUS EXCEPTION;
15:21:31 363  BEGIN
15:21:31 364  
15:21:31 365  	-- Check that transaction exists
15:21:31 366  	BEGIN
15:21:31 367  	  SELECT
15:21:31 368  	    TRANSACTION.ID into temp_transaction_id
15:21:31 369  	  FROM
15:21:31 370  	    TRANSACTION
15:21:31 371  	  WHERE
15:21:31 372  	    TRANSACTION.ID = in_transaction_id;
15:21:31 373  	  EXCEPTION
15:21:31 374  	    WHEN OTHERS THEN
15:21:31 375  	      RAISE BAD_TRANSACTION_ID;
15:21:31 376  	END;
15:21:31 377  
15:21:31 378  	-- Check that transaction attempt status is correct
15:21:31 379  	IF in_transaction_attempt_status != GLOBAL_STATUSES_V18.TRANS_ATTEMPT_IN_PROGRESS
15:21:31 380  	  AND in_transaction_attempt_status != GLOBAL_STATUSES_V18.TRANS_ATTEMPT_SUCCESS
15:21:31 381  	  AND in_transaction_attempt_status != GLOBAL_STATUSES_V18.TRANS_ATTEMPT_FAILED THEN
15:21:31 382  	  RAISE BAD_TRANS_ATTEMPT_STATUS;
15:21:31 383  	END IF;
15:21:31 384  
15:21:31 385  	OPEN out_result_set FOR
15:21:31 386  	SELECT
15:21:31 387  	  TRANSACTION_ATTEMPT.ID,
15:21:31 388  	  TRANSACTION_ATTEMPT.EXTERNAL_STATUS_CODE,
15:21:31 389  	  TRANSACTION_ATTEMPT.EXTERNAL_STATUS_MESSAGE,
15:21:31 390  	  TRANSACTION_ATTEMPT.CREATE_DATE,
15:21:31 391  	  TRANSACTION_ATTEMPT.CREATED_BY,
15:21:31 392  	  TRANSACTION_ATTEMPT.EXTERNAL_TRANSACTION_ID,
15:21:31 393  	  TRANSACTION_ATTEMPT.TRANSACTION_START_TIME,
15:21:31 394  	  TRANSACTION.TRANSACTION_AMOUNT,
15:21:31 395  	  TRANSACTION.ID as "TRANSACTION_ID",
15:21:31 396  	  TRANSACTION.UPDATE_DATE as "TRANSACTION_UPDATE_TIME"
15:21:31 397  	FROM
15:21:31 398  	  TRANSACTION_ATTEMPT
15:21:31 399  	  INNER JOIN TRANSACTION ON TRANSACTION_ATTEMPT.TRANSACTION_ID = TRANSACTION.ID
15:21:31 400  	WHERE
15:21:31 401  	  TRANSACTION_ATTEMPT.TRANSACTION_ID = in_transaction_id
15:21:31 402  	  AND TRANSACTION_ATTEMPT.TRANSACTION_ATTEMPT_STATUS_ID = in_transaction_attempt_status;
15:21:31 403  
15:21:31 404  EXCEPTION
15:21:31 405  WHEN BAD_TRANSACTION_ID THEN
15:21:31 406  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 407  	  SPROC_NAME, 'No such transaction');
15:21:31 408  WHEN BAD_TRANS_ATTEMPT_STATUS THEN
15:21:31 409  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:31 410  	  SPROC_NAME, 'Bad transaction attempt status');
15:21:31 411  WHEN OTHERS THEN
15:21:31 412  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 413  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 414  END GET_TRNSCTN_ATTEMPTS_BY_STATUS;
15:21:31 415  
15:21:31 416  /******************************************************************************/
15:21:31 417  
15:21:31 418  PROCEDURE UPDATE_TRANSACTION_ATTEMPT_INF (
15:21:31 419  /*
15:21:31 420  Throws exceptions:
15:21:31 421  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:31 422  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31 423  */
15:21:31 424  	in_transaction_attempt_id IN NUMBER,
15:21:31 425  	in_ext_status_code	  IN VARCHAR2,
15:21:31 426  	in_ext_status_message	  IN VARCHAR2,
15:21:31 427  	in_ext_transaction_id	  IN VARCHAR2
15:21:31 428  ) AS
15:21:31 429  -- VARIABLES
15:21:31 430  SPROC_NAME	       CONSTANT VARCHAR2(30) := 'UPDATE_TRANSACTION_ATTEMPT_INF';
15:21:31 431  temp_trans_attempt_count NUMBER;
15:21:31 432  -- EXCEPTIONS
15:21:31 433  BAD_ATTEMPT_ID EXCEPTION;
15:21:31 434  BEGIN
15:21:31 435  
15:21:31 436  	SELECT
15:21:31 437  	  COUNT(*) into temp_trans_attempt_count
15:21:31 438  	FROM
15:21:31 439  	  TRANSACTION_ATTEMPT
15:21:31 440  	WHERE
15:21:31 441  	  TRANSACTION_ATTEMPT.ID = in_transaction_attempt_id;
15:21:31 442  
15:21:31 443  	IF temp_trans_attempt_count = 0 THEN
15:21:31 444  	  RAISE BAD_ATTEMPT_ID;
15:21:31 445  	END IF;
15:21:31 446  
15:21:31 447  	PROCS_TRANSACTION_CRU_V18.UPDATE_TRANSACTION_ATTEMPT(
15:21:31 448  	  in_transaction_attempt_id  => in_transaction_attempt_id,
15:21:31 449  	  in_external_status_code    => in_ext_status_code,
15:21:31 450  	  in_external_status_message => in_ext_status_message,
15:21:31 451  	  in_external_transaction_id => in_ext_transaction_id
15:21:31 452  	);
15:21:31 453  
15:21:31 454  EXCEPTION
15:21:31 455  WHEN BAD_ATTEMPT_ID THEN
15:21:31 456  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 457  	  SPROC_NAME, 'No such attempt');
15:21:31 458  WHEN OTHERS THEN
15:21:31 459  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 460  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 461  END UPDATE_TRANSACTION_ATTEMPT_INF;
15:21:31 462  
15:21:31 463  /******************************************************************************/
15:21:31 464  
15:21:31 465  PROCEDURE GET_FAILED_ATTEMPTS_NUMBER (
15:21:31 466  /*
15:21:31 467  Throws exceptions:
15:21:31 468  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:31 469  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31 470  */
15:21:31 471  	in_transaction_id IN  NUMBER,
15:21:31 472  	out_attempts_num  OUT NUMBER
15:21:31 473  ) AS
15:21:31 474  -- VARIABLES
15:21:31 475  SPROC_NAME	     CONSTANT VARCHAR2(26) := 'GET_FAILED_ATTEMPTS_NUMBER';
15:21:31 476  temp_transaction_count NUMBER;
15:21:31 477  
15:21:31 478  -- EXCEPTIONS
15:21:31 479  BAD_TRANSACTION_ID EXCEPTION;
15:21:31 480  BEGIN
15:21:31 481  
15:21:31 482  	SELECT
15:21:31 483  	  COUNT(*) into temp_transaction_count
15:21:31 484  	FROM
15:21:31 485  	  TRANSACTION
15:21:31 486  	WHERE
15:21:31 487  	  TRANSACTION.ID = in_transaction_id;
15:21:31 488  
15:21:31 489  	IF temp_transaction_count = 0 THEN
15:21:31 490  	  RAISE BAD_TRANSACTION_ID;
15:21:31 491  	END IF;
15:21:31 492  
15:21:31 493  	SELECT
15:21:31 494  	  COUNT(*) into out_attempts_num
15:21:31 495  	FROM
15:21:31 496  	  TRANSACTION_ATTEMPT
15:21:31 497  	WHERE
15:21:31 498  	  TRANSACTION_ATTEMPT.TRANSACTION_ID = in_transaction_id
15:21:31 499  	  AND TRANSACTION_ATTEMPT.TRANSACTION_ATTEMPT_STATUS_ID = GLOBAL_STATUSES_V18.TRANS_ATTEMPT_FAILED;
15:21:31 500  
15:21:31 501  EXCEPTION
15:21:31 502  WHEN BAD_TRANSACTION_ID THEN
15:21:31 503  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 504  	  SPROC_NAME, 'No such transaction');
15:21:31 505  WHEN OTHERS THEN
15:21:31 506  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 507  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 508  END GET_FAILED_ATTEMPTS_NUMBER;
15:21:31 509  /******************************************************************************/
15:21:31 510  
15:21:31 511  PROCEDURE IS_TRANSACTION_SUCCESSFULL (
15:21:31 512  /*
15:21:31 513  Throws exceptions:
15:21:31 514  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:31 515  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31 516  */
15:21:31 517  	in_transaction_id IN  NUMBER,
15:21:31 518  	out_is_successfull  OUT NUMBER
15:21:31 519  ) AS
15:21:31 520  -- VARIABLES
15:21:31 521  SPROC_NAME	     CONSTANT VARCHAR2(26) := 'IS_TRANSACTION_SUCCESSFULL';
15:21:31 522  temp_transaction_count NUMBER;
15:21:31 523  
15:21:31 524  -- EXCEPTIONS
15:21:31 525  BAD_TRANSACTION_ID EXCEPTION;
15:21:31 526  BEGIN
15:21:31 527  
15:21:31 528  	SELECT
15:21:31 529  	  COUNT(*) into temp_transaction_count
15:21:31 530  	FROM
15:21:31 531  	  TRANSACTION
15:21:31 532  	WHERE
15:21:31 533  	  TRANSACTION.ID = in_transaction_id;
15:21:31 534  
15:21:31 535  	IF temp_transaction_count = 0 THEN
15:21:31 536  	  RAISE BAD_TRANSACTION_ID;
15:21:31 537  	END IF;
15:21:31 538  
15:21:31 539  	SELECT
15:21:31 540  	  COUNT(*) into out_is_successfull
15:21:31 541  	FROM
15:21:31 542  	  TRANSACTION_ATTEMPT
15:21:31 543  	WHERE
15:21:31 544  	  TRANSACTION_ATTEMPT.TRANSACTION_ID = in_transaction_id
15:21:31 545  	  AND TRANSACTION_ATTEMPT.TRANSACTION_ATTEMPT_STATUS_ID = GLOBAL_STATUSES_V18.TRANS_ATTEMPT_SUCCESS;
15:21:31 546  
15:21:31 547  EXCEPTION
15:21:31 548  WHEN BAD_TRANSACTION_ID THEN
15:21:31 549  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 550  	  SPROC_NAME, 'No such transaction');
15:21:31 551  WHEN OTHERS THEN
15:21:31 552  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 553  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 554  END IS_TRANSACTION_SUCCESSFULL;
15:21:31 555  /******************************************************************************/
15:21:31 556  
15:21:31 557  PROCEDURE GET_TRANSACTION_AMOUNT (
15:21:31 558  /*
15:21:31 559  Throws exceptions:
15:21:31 560  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:31 561  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31 562  */
15:21:31 563  	in_transaction_id      IN  NUMBER,
15:21:31 564  	out_transaction_amount OUT NUMBER
15:21:31 565  ) AS
15:21:31 566  SPROC_NAME CONSTANT VARCHAR2(22) := 'GET_TRANSACTION_AMOUNT';
15:21:31 567  BEGIN
15:21:31 568  
15:21:31 569  	SELECT
15:21:31 570  	  TRANSACTION.TRANSACTION_AMOUNT into out_transaction_amount
15:21:31 571  	FROM
15:21:31 572  	  TRANSACTION
15:21:31 573  	WHERE
15:21:31 574  	  TRANSACTION.ID = in_transaction_id;
15:21:31 575  
15:21:31 576  EXCEPTION
15:21:31 577  WHEN NO_DATA_FOUND THEN
15:21:31 578  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 579  	  SPROC_NAME, 'No such transaction');
15:21:31 580  WHEN OTHERS THEN
15:21:31 581  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 582  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 583  END GET_TRANSACTION_AMOUNT;
15:21:31 584  
15:21:31 585  /******************************************************************************/
15:21:31 586  
15:21:31 587  PROCEDURE GET_TRANSACTIONS_BY_CHARGE_ID (
15:21:31 588  /*
15:21:31 589  Throws exceptions:
15:21:31 590  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:31 591  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31 592  */
15:21:31 593  	in_charge_id   IN  NUMBER,
15:21:31 594  	out_result_set OUT SYS_REFCURSOR
15:21:31 595  ) AS
15:21:31 596  -- VARIABLES
15:21:31 597  SPROC_NAME     CONSTANT VARCHAR2(29) := 'GET_TRANSACTIONS_BY_CHARGE_ID';
15:21:31 598  temp_charge_id NUMBER;
15:21:31 599  -- EXCEPTIONS
15:21:31 600  BAD_CHARGE_ID EXCEPTION;
15:21:31 601  BEGIN
15:21:31 602  
15:21:31 603  	BEGIN
15:21:31 604  	  SELECT
15:21:31 605  	    CHARGE.ID into temp_charge_id
15:21:31 606  	  FROM
15:21:31 607  	    CHARGE
15:21:31 608  	  WHERE
15:21:31 609  	    CHARGE.ID = in_charge_id;
15:21:31 610  	  EXCEPTION
15:21:31 611  	    WHEN NO_DATA_FOUND THEN
15:21:31 612  	      RAISE BAD_CHARGE_ID;
15:21:31 613  	END;
15:21:31 614  
15:21:31 615  	OPEN out_result_set FOR
15:21:31 616  	SELECT DISTINCT
15:21:31 617  	  TRANSACTION.ID,
15:21:31 618  	  TRANSACTION.TRANSACTION_STATUS_ID,
15:21:31 619  	  TRANSACTION.CREATE_DATE,
15:21:31 620  	  TRANSACTION.TRANSACTION_AMOUNT,
15:21:31 621  	  TRANSACTION.IS_REFUND,
15:21:31 622  	  TRANSACTION.ORDER_ID
15:21:31 623  	FROM
15:21:31 624  	  CHARGE INNER JOIN TRANSACTION ON
15:21:31 625  	      CHARGE.TRANSACTION_ID = TRANSACTION.ID
15:21:31 626  	WHERE
15:21:31 627  	  CHARGE.ID = in_charge_id;
15:21:31 628  
15:21:31 629  EXCEPTION
15:21:31 630  WHEN BAD_CHARGE_ID THEN
15:21:31 631  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 632  	  SPROC_NAME, 'No such charge');
15:21:31 633  WHEN OTHERS THEN
15:21:31 634  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 635  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 636  END GET_TRANSACTIONS_BY_CHARGE_ID;
15:21:31 637  /******************************************************************************/
15:21:31 638  
15:21:31 639  PROCEDURE GET_TRANSACTION_BY_ORDER_ID (
15:21:31 640  /*
15:21:31 641  Throws exceptions:
15:21:31 642  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31 643  */
15:21:31 644  	in_order_id   IN  TRANSACTION.ORDER_ID%TYPE,
15:21:31 645  	out_result_set OUT SYS_REFCURSOR
15:21:31 646  ) AS
15:21:31 647  -- VARIABLES
15:21:31 648  SPROC_NAME     CONSTANT VARCHAR2(27) := 'GET_TRANSACTION_BY_ORDER_ID';
15:21:31 649  BEGIN
15:21:31 650  	OPEN out_result_set FOR
15:21:31 651  	SELECT DISTINCT
15:21:31 652  	  TRANSACTION.ID
15:21:31 653  	FROM
15:21:31 654  	  TRANSACTION
15:21:31 655  	WHERE
15:21:31 656  	  TRANSACTION.ORDER_ID = in_order_id;
15:21:31 657  
15:21:31 658  EXCEPTION
15:21:31 659  WHEN OTHERS THEN
15:21:31 660  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 661  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 662  END GET_TRANSACTION_BY_ORDER_ID;
15:21:31 663  /******************************************************************************/
15:21:31 664  
15:21:31 665  PROCEDURE GET_TRANSACTIONS_BY_ORDER_ID (
15:21:31 666  /*
15:21:31 667  Throws exceptions:
15:21:31 668  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:31 669  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31 670  */
15:21:31 671  	in_order_id   IN  TRANSACTION.ORDER_ID%TYPE,
15:21:31 672  	out_result_set OUT SYS_REFCURSOR
15:21:31 673  ) AS
15:21:31 674  -- VARIABLES
15:21:31 675  SPROC_NAME     CONSTANT VARCHAR2(28) := 'GET_TRANSACTIONS_BY_ORDER_ID';
15:21:31 676  temp_order_id TRANSACTION.ORDER_ID%TYPE;
15:21:31 677  -- EXCEPTIONS
15:21:31 678  BAD_ORDER_ID EXCEPTION;
15:21:31 679  BEGIN
15:21:31 680  
15:21:31 681  	--TODO BOO, REMOVE ME
15:21:31 682  	BEGIN
15:21:31 683  	  SELECT
15:21:31 684  	    distinct TRANSACTION.ORDER_ID INTO temp_order_id
15:21:31 685  	  FROM
15:21:31 686  	    TRANSACTION
15:21:31 687  	  WHERE
15:21:31 688  	    TRANSACTION.ORDER_ID = in_order_id;
15:21:31 689  	  EXCEPTION
15:21:31 690  	    WHEN NO_DATA_FOUND THEN
15:21:31 691  	      RAISE BAD_ORDER_ID;
15:21:31 692  	END;
15:21:31 693  
15:21:31 694  	OPEN out_result_set FOR
15:21:31 695  	SELECT c.ID CHARGE_ID,
15:21:31 696  	  c.CHARGE_AMOUNT,
15:21:31 697  	  c.CHARGE_STATUS_ID,
15:21:31 698  	  c.INSTRUMENT_ID,
15:21:31 699  	  c.INSTRUMENT_TYPE_ID,
15:21:31 700  	  c.INVOICE_ID,
15:21:31 701  	  t.ID TRANSACTION_ID,
15:21:31 702  	  t.IS_REFUND,
15:21:31 703  	  t.IS_SETTLED,
15:21:31 704  	  t.ORDER_ID,
15:21:31 705  	  t.TRANSACTION_AMOUNT,
15:21:31 706  	  t.TRANSACTION_STATUS_ID,
15:21:31 707  	  t.CREATE_DATE TRANSACTION_CREATE_DATE,
15:21:31 708  	  t.CREATED_BY TRANSACTION_CREATED_BY,
15:21:31 709  	  t.UPDATE_DATE TRANSACTION_UPDATE_DATE,
15:21:31 710  	  t.UPDATED_BY TRANSACTION_UPDATED_BY
15:21:31 711  	FROM CHARGE c
15:21:31 712  	JOIN TRANSACTION t ON c.TRANSACTION_ID = t.ID
15:21:31 713  	WHERE TRANSACTION_ID IN (
15:21:31 714  	  SELECT ID FROM TRANSACTION WHERE ORDER_ID = in_order_id
15:21:31 715  	);
15:21:31 716  
15:21:31 717  EXCEPTION
15:21:31 718  WHEN BAD_ORDER_ID THEN
15:21:31 719  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 720  	  SPROC_NAME, 'No such order');
15:21:31 721  WHEN OTHERS THEN
15:21:31 722  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 723  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 724  END GET_TRANSACTIONS_BY_ORDER_ID;
15:21:31 725  /******************************************************************************/
15:21:31 726  
15:21:31 727  PROCEDURE GET_CLOSED_REFUNDS_BY_INVOICE (
15:21:31 728  /*
15:21:31 729  Throws exceptions:
15:21:31 730  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:31 731  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31 732  */
15:21:31 733  	in_invoice_id	IN  NUMBER,
15:21:31 734  	out_result_set OUT SYS_REFCURSOR
15:21:31 735  ) AS
15:21:31 736  -- VARIABLES
15:21:31 737  SPROC_NAME     CONSTANT VARCHAR2(29) := 'GET_CLOSED_REFUNDS_BY_INVOICE';
15:21:31 738  temp_invoice_id NUMBER;
15:21:31 739  -- EXCEPTIONS
15:21:31 740  BAD_INVOICE_ID EXCEPTION;
15:21:31 741  BEGIN
15:21:31 742  
15:21:31 743  	BEGIN
15:21:31 744  	  SELECT
15:21:31 745  	    INVOICE.ID into temp_invoice_id
15:21:31 746  	  FROM
15:21:31 747  	    INVOICE
15:21:31 748  	  WHERE
15:21:31 749  	    INVOICE.ID = in_invoice_id;
15:21:31 750  	  EXCEPTION
15:21:31 751  	    WHEN NO_DATA_FOUND THEN
15:21:31 752  	      RAISE BAD_INVOICE_ID;
15:21:31 753  	END;
15:21:31 754  
15:21:31 755  	OPEN out_result_set FOR
15:21:31 756  	SELECT DISTINCT
15:21:31 757  	  TRANSACTION.ID,
15:21:31 758  	  TRANSACTION.TRANSACTION_STATUS_ID,
15:21:31 759  	  TRANSACTION.CREATE_DATE,
15:21:31 760  	  TRANSACTION.UPDATE_DATE,
15:21:31 761  	  TRANSACTION.ORDER_ID,
15:21:31 762  	  TRANSACTION.TRANSACTION_AMOUNT
15:21:31 763  	FROM
15:21:31 764  	  INVOICE INNER JOIN CHARGE ON	(INVOICE.ID = CHARGE.INVOICE_ID)
15:21:31 765  	  INNER JOIN TRANSACTION ON (CHARGE.TRANSACTION_ID = TRANSACTION.ID)
15:21:31 766  	WHERE
15:21:31 767  	  INVOICE.ID = in_invoice_id
15:21:31 768  	  AND TRANSACTION.IS_REFUND = GLOBAL_CONSTANTS_V18.TRUE
15:21:31 769  	  AND TRANSACTION.TRANSACTION_AMOUNT <= 0
15:21:31 770  	  AND TRANSACTION.TRANSACTION_STATUS_ID = GLOBAL_STATUSES_V18.TRANSACTION_CLOSED;
15:21:31 771  
15:21:31 772  EXCEPTION
15:21:31 773  WHEN BAD_INVOICE_ID THEN
15:21:31 774  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 775  	  SPROC_NAME, 'No such invoice');
15:21:31 776  WHEN OTHERS THEN
15:21:31 777  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 778  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 779  END GET_CLOSED_REFUNDS_BY_INVOICE;
15:21:31 780  
15:21:31 781  /******************************************************************************/
15:21:31 782  
15:21:31 783  PROCEDURE GET_TRANSACTION_ATTEMPTS (
15:21:31 784  /*
15:21:31 785  Throws exceptions:
15:21:31 786  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:31 787  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31 788  */
15:21:31 789  	in_transaction_id IN  NUMBER,
15:21:31 790  	out_result_set	  OUT SYS_REFCURSOR
15:21:31 791  ) AS
15:21:31 792  -- VARIABLES
15:21:31 793  SPROC_NAME	  CONSTANT VARCHAR2(24) := 'GET_TRANSACTION_ATTEMPTS';
15:21:31 794  temp_transaction_id NUMBER;
15:21:31 795  -- EXCEPTIONS
15:21:31 796  BAD_TRANSACTION_ID EXCEPTION;
15:21:31 797  BEGIN
15:21:31 798  
15:21:31 799  	BEGIN
15:21:31 800  	  SELECT
15:21:31 801  	    TRANSACTION.ID into temp_transaction_id
15:21:31 802  	  FROM
15:21:31 803  	    TRANSACTION
15:21:31 804  	  WHERE
15:21:31 805  	    TRANSACTION.ID = in_transaction_id;
15:21:31 806  	  EXCEPTION
15:21:31 807  	    WHEN NO_DATA_FOUND THEN
15:21:31 808  	      RAISE BAD_TRANSACTION_ID;
15:21:31 809  	END;
15:21:31 810  
15:21:31 811  	OPEN out_result_set FOR
15:21:31 812  	SELECT
15:21:31 813  	  TRANSACTION_ATTEMPT.TRANSACTION_ATTEMPT_STATUS_ID,
15:21:31 814  	  TRANSACTION_ATTEMPT.EXTERNAL_STATUS_CODE,
15:21:31 815  	  TRANSACTION_ATTEMPT.EXTERNAL_STATUS_MESSAGE,
15:21:31 816  	  TRANSACTION_ATTEMPT.CREATE_DATE,
15:21:31 817  	  TRANSACTION_ATTEMPT.EXTERNAL_TRANSACTION_ID
15:21:31 818  	FROM
15:21:31 819  	  TRANSACTION_ATTEMPT
15:21:31 820  	WHERE
15:21:31 821  	  TRANSACTION_ATTEMPT.TRANSACTION_ID = in_transaction_id;
15:21:31 822  
15:21:31 823  EXCEPTION
15:21:31 824  WHEN BAD_TRANSACTION_ID THEN
15:21:31 825  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 826  	  SPROC_NAME, 'No such transaction');
15:21:31 827  WHEN OTHERS THEN
15:21:31 828  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 829  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 830  END GET_TRANSACTION_ATTEMPTS;
15:21:31 831  
15:21:31 832  /******************************************************************************/
15:21:31 833  
15:21:31 834  PROCEDURE RESERVE_TRANSACTION_ID (
15:21:31 835  /*
15:21:31 836  Throws exceptions:
15:21:31 837  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31 838  */
15:21:31 839  	out_transaction_id OUT NUMBER
15:21:31 840  ) AS
15:21:31 841  SPROC_NAME CONSTANT VARCHAR2(22) := 'RESERVE_TRANSACTION_ID';
15:21:31 842  BEGIN
15:21:31 843  	SELECT
15:21:31 844  	  TRN_ID_SEQ.nextVal into out_transaction_id
15:21:31 845  	FROM DUAL;
15:21:31 846  EXCEPTION
15:21:31 847  WHEN OTHERS THEN
15:21:31 848  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 849  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 850  END RESERVE_TRANSACTION_ID;
15:21:31 851  
15:21:31 852  /******************************************************************************/
15:21:31 853  
15:21:31 854  PROCEDURE GET_TRANSACTION_BY_ID (
15:21:31 855  /*
15:21:31 856  Throws exceptions:
15:21:31 857  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:31 858  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31 859  */
15:21:31 860  	in_transaction_id IN NUMBER,
15:21:31 861  	out_result_set	  OUT SYS_REFCURSOR
15:21:31 862  ) AS
15:21:31 863  SPROC_NAME CONSTANT VARCHAR2(21) := 'GET_TRANSACTION_BY_ID';
15:21:31 864  -- VARIABLES
15:21:31 865  temp_transaction_id NUMBER;
15:21:31 866  -- EXCPTIONS
15:21:31 867  BAD_TRANSACTION_ID EXCEPTION;
15:21:31 868  BEGIN
15:21:31 869  	BEGIN
15:21:31 870  	  SELECT
15:21:31 871  	    TRANSACTION.ID into temp_transaction_id
15:21:31 872  	  FROM
15:21:31 873  	    TRANSACTION
15:21:31 874  	  WHERE
15:21:31 875  	    TRANSACTION.ID = in_transaction_id;
15:21:31 876  	  EXCEPTION
15:21:31 877  	    WHEN NO_DATA_FOUND THEN
15:21:31 878  	      RAISE BAD_TRANSACTION_ID;
15:21:31 879  	END;
15:21:31 880  
15:21:31 881  	PROCS_TRANSACTION_CRU_V18.READ_TRANSACTION(
15:21:31 882  	  in_transaction_id => in_transaction_id,
15:21:31 883  	  out_result_set    => out_result_set
15:21:31 884  	);
15:21:31 885  
15:21:31 886  EXCEPTION
15:21:31 887  WHEN NO_DATA_FOUND THEN
15:21:31 888  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 889  	  SPROC_NAME, 'No such transaction');
15:21:31 890  WHEN OTHERS THEN
15:21:31 891  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 892  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 893  END GET_TRANSACTION_BY_ID;
15:21:31 894  
15:21:31 895  PROCEDURE UPDATE_TRANSACTION_ORDER_ID (
15:21:31 896  /*
15:21:31 897  Throws exceptions:
15:21:31 898  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:31 899  APP_EXCEPTION_CODES_V18.INTRNAL_ERROR
15:21:31 900  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31 901  */
15:21:31 902  	in_transaction_id IN TRANSACTION.ID%TYPE,
15:21:31 903  	in_order_id	  IN TRANSACTION.ORDER_ID%TYPE,
15:21:31 904  	in_updated_by	  IN TRANSACTION.UPDATED_BY%TYPE
15:21:31 905  ) AS
15:21:31 906  SPROC_NAME CONSTANT VARCHAR2(27) := 'UPDATE_TRANSACTION_ORDER_ID';
15:21:31 907  -- VARIABLES
15:21:31 908  temp_transaction_id TRANSACTION.ID%TYPE;
15:21:31 909  -- EXCEPTIONS
15:21:31 910  BAD_TRANSACTION_ID   EXCEPTION;
15:21:31 911  ORDER_ID_IS_NOT_NULL EXCEPTION;
15:21:31 912  CRU_UNKNOWN_ERROR    EXCEPTION;
15:21:31 913  EXCEPTION_MESSAGE VARCHAR2(1024);
15:21:31 914  BEGIN
15:21:31 915  	BEGIN
15:21:31 916  	  SELECT
15:21:31 917  	    TRANSACTION.ID into temp_transaction_id
15:21:31 918  	  FROM
15:21:31 919  	    TRANSACTION
15:21:31 920  	  WHERE
15:21:31 921  	    TRANSACTION.ID = in_transaction_id;
15:21:31 922  	  EXCEPTION
15:21:31 923  	    WHEN NO_DATA_FOUND THEN
15:21:31 924  	      RAISE BAD_TRANSACTION_ID;
15:21:31 925  	END;
15:21:31 926  
15:21:31 927  	BEGIN
15:21:31 928  	  PROCS_TRANSACTION_CRU_V18.UPDATE_TRANSACTION_ORDER_ID(
15:21:31 929  	    in_transaction_id => in_transaction_id,
15:21:31 930  	    in_order_id       => in_order_id,
15:21:31 931  	    in_updated_by     => in_updated_by
15:21:31 932  	  );
15:21:31 933  	  EXCEPTION
15:21:31 934  	    WHEN OTHERS THEN
15:21:31 935  	      IF SQLCODE = APP_EXCEPTION_CODES_V18.NOT_FOUND THEN
15:21:31 936  		RAISE ORDER_ID_IS_NOT_NULL;
15:21:31 937  	      ELSE
15:21:31 938  		EXCEPTION_MESSAGE := SQLERRM;
15:21:31 939  		RAISE CRU_UNKNOWN_ERROR;
15:21:31 940  	      END IF;
15:21:31 941  	END;
15:21:31 942  
15:21:31 943  EXCEPTION
15:21:31 944  WHEN BAD_TRANSACTION_ID THEN
15:21:31 945  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 946  	  SPROC_NAME, 'No such transaction');
15:21:31 947  WHEN ORDER_ID_IS_NOT_NULL THEN
15:21:31 948  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:31 949  	  SPROC_NAME, 'Order id is not null');
15:21:31 950  WHEN CRU_UNKNOWN_ERROR THEN
15:21:31 951  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:31 952  	  SPROC_NAME, 'Unknown error while updating order id', EXCEPTION_MESSAGE);
15:21:31 953  WHEN OTHERS THEN
15:21:31 954  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 955  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 956  END UPDATE_TRANSACTION_ORDER_ID;
15:21:31 957  
15:21:31 958  /******************************************************************************/
15:21:31 959  
15:21:31 960  FUNCTION GET_TRANSACTION_TAX_AMOUNT (
15:21:31 961  	in_transaction_id IN NUMBER
15:21:31 962  ) RETURN NUMBER AS
15:21:31 963  SPROC_NAME CONSTANT VARCHAR2(26) := 'GET_TRANSACTION_TAX_AMOUNT';
15:21:31 964  -- Variables
15:21:31 965  var_tax_amount NUMBER(10,2);
15:21:31 966  BEGIN
15:21:31 967  
15:21:31 968  	SELECT
15:21:31 969  	  SUM(LI.TAXES_AMOUNT) into var_tax_amount
15:21:31 970  	FROM
15:21:31 971  	  LINE_ITEM LI
15:21:31 972  	  INNER JOIN INVOICE I ON LI.INVOICE_ID = I.ID
15:21:31 973  	  INNER JOIN CHARGE CH ON CH.INVOICE_ID = I.ID
15:21:31 974  	WHERE
15:21:31 975  	  CH.TRANSACTION_ID = in_transaction_id;
15:21:31 976  
15:21:31 977  	IF var_tax_amount IS NULL THEN
15:21:31 978  	  var_tax_amount := 0;
15:21:31 979  	END IF;
15:21:31 980  
15:21:31 981  	RETURN var_tax_amount;
15:21:31 982  
15:21:31 983  END GET_TRANSACTION_TAX_AMOUNT;
15:21:31 984  
15:21:31 985  /******************************************************************************/
15:21:31 986  
15:21:31 987  FUNCTION GET_TRANSACTION_INTRL_TAXES (
15:21:31 988  	in_transaction_id IN NUMBER
15:21:31 989  ) RETURN NUMBER AS
15:21:31 990  SPROC_NAME CONSTANT VARCHAR2(27) := 'GET_TRANSACTION_INTRL_TAXES';
15:21:31 991  -- Variables
15:21:31 992  var_intrl_tax_amount NUMBER(10, 2);
15:21:31 993  BEGIN
15:21:31 994  
15:21:31 995  	SELECT SUM(T.CALCULATED_AMOUNT) into var_intrl_tax_amount
15:21:31 996  	FROM
15:21:31 997  	  LINE_ITEM LI
15:21:31 998  	  INNER JOIN INVOICE I ON LI.INVOICE_ID = I.ID
15:21:31 999  	  INNER JOIN CHARGE CH ON CH.INVOICE_ID=  I.ID
15:21:31 1000  	   INNER JOIN TAX T ON T.LINE_ITEM_ID = LI.ID
15:21:31 1001  	 WHERE
15:21:31 1002  	   CH.TRANSACTION_ID = in_transaction_id
15:21:31 1003  	   AND T.TAX_TYPE_ID IN (
15:21:31 1004  	     SELECT GLOBAL_ENUMS_V18.TAX_TYPE_VAT FROM DUAL
15:21:31 1005  	   );
15:21:31 1006  
15:21:31 1007  	 IF var_intrl_tax_amount IS NULL THEN
15:21:31 1008  	   var_intrl_tax_amount := 0;
15:21:31 1009  	 END IF;
15:21:31 1010  
15:21:31 1011  	 RETURN var_intrl_tax_amount;
15:21:31 1012  
15:21:31 1013  END GET_TRANSACTION_INTRL_TAXES;
15:21:31 1014  
15:21:31 1015  /******************************************************************************/
15:21:31 1016  -- norlov: #38796
15:21:31 1017  PROCEDURE GET_TRANSACTIONS (
15:21:31 1018  /*
15:21:31 1019  Throws exceptions:
15:21:31 1020  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:31 1021  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31 1022  */
15:21:31 1023  	 in_group_id	       IN  NUMBER,
15:21:31 1024  	 in_invoice_id	       IN NUMBER DEFAULT NULL,
15:21:31 1025  	 in_subscription_id    IN NUMBER DEFAULT NULL,
15:21:31 1026  	 in_start_date	       IN TRANSACTION.CREATE_DATE%TYPE DEFAULT NULL,
15:21:31 1027  	 in_end_date	       IN TRANSACTION.CREATE_DATE%TYPE DEFAULT NULL,
15:21:31 1028  	 in_transaction_status IN NUMBER DEFAULT NULL,
15:21:31 1029  	 out_result_set        OUT SYS_REFCURSOR
15:21:31 1030  ) AS
15:21:31 1031  SPROC_NAME CONSTANT VARCHAR2(16) := 'GET_TRANSACTIONS';
15:21:31 1032  -- VARIABLES
15:21:31 1033  var_account_id ACCOUNT.ID%TYPE;
15:21:31 1034  statement VARCHAR2(2000);
15:21:31 1035  -- EXCEPTIONS
15:21:31 1036  BAD_GROUP_ID   EXCEPTION;
15:21:31 1037  BEGIN
15:21:31 1038  	-- check group id
15:21:31 1039  	BEGIN
15:21:31 1040  	   SELECT
15:21:31 1041  	     ACCOUNT.ID into var_account_id
15:21:31 1042  	   FROM
15:21:31 1043  	     ACCOUNT
15:21:31 1044  	   WHERE
15:21:31 1045  	     ACCOUNT.GROUP_ID = in_group_id;
15:21:31 1046  	   EXCEPTION
15:21:31 1047  	     WHEN NO_DATA_FOUND THEN
15:21:31 1048  	       RAISE BAD_GROUP_ID;
15:21:31 1049  	 END;
15:21:31 1050  
15:21:31 1051  	 OPEN out_result_set FOR
15:21:31 1052  	 SELECT
15:21:31 1053  	   TRANSACTION.ID,
15:21:31 1054  	   TRANSACTION.TRANSACTION_STATUS_ID,
15:21:31 1055  	   TRANSACTION.TRANSACTION_AMOUNT,
15:21:31 1056  	   TRANSACTION.CREATE_DATE,
15:21:31 1057  	   TRANSACTION.CREATED_BY,
15:21:31 1058  	   TRANSACTION.IS_REFUND,
15:21:31 1059  	   GET_TRANSACTION_TAX_AMOUNT(TRANSACTION.ID) as TRANSACTION_TAX_AMOUNT,
15:21:31 1060  	   GET_TRANSACTION_INTRL_TAXES(TRANSACTION.ID) as INTERNATIONAL_TOTAL
15:21:31 1061  	 FROM
15:21:31 1062  	   TRANSACTION
15:21:31 1063  	   INNER JOIN CHARGE ON TRANSACTION.ID = CHARGE.TRANSACTION_ID
15:21:31 1064  	   INNER JOIN INVOICE ON INVOICE.ID = CHARGE.INVOICE_ID
15:21:31 1065  	 WHERE
15:21:31 1066  	   -- Filter by invoice ID
15:21:31 1067  	   (
15:21:31 1068  	     INVOICE.ID IN (
15:21:31 1069  	       -- Gift certificate invoices
15:21:31 1070  	       SELECT
15:21:31 1071  		 GIFT_CERTIFICATE.PURCHASE_INVOICE_ID
15:21:31 1072  	       FROM
15:21:31 1073  		 GIFT_CERTIFICATE
15:21:31 1074  	       WHERE
15:21:31 1075  		 GIFT_CERTIFICATE.PURCHASER_GROUP_ID = in_group_id
15:21:31 1076  		 -- If subscription_id is set then return nothing
15:21:31 1077  		 AND EXISTS (SELECT 1 FROM DUAL WHERE in_subscription_id IS NULL)
15:21:31 1078  	     )
15:21:31 1079  	     OR
15:21:31 1080  	     INVOICE.ID IN (
15:21:31 1081  	       SELECT
15:21:31 1082  		 LICENSE.INVOICE_ID
15:21:31 1083  	       FROM
15:21:31 1084  		 LICENSE
15:21:31 1085  		 INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
15:21:31 1086  	       WHERE
15:21:31 1087  		 SUBSCRIPTION.ACCOUNT_ID = var_account_id
15:21:31 1088  		 -- Filter by subscription id
15:21:31 1089  		 AND SUBSCRIPTION.ID = NVL(in_subscription_id, SUBSCRIPTION.ID)
15:21:31 1090  	     )
15:21:31 1091  	   )
15:21:31 1092  	   -- Filter by invoice id
15:21:31 1093  	   AND INVOICE.ID = NVL(in_invoice_id, INVOICE.ID)
15:21:31 1094  	   -- Filter by start date
15:21:31 1095  	   AND TRANSACTION.CREATE_DATE >= NVL(in_start_date, TRANSACTION.CREATE_DATE)
15:21:31 1096  	   -- Filter by end date
15:21:31 1097  	   AND TRANSACTION.CREATE_DATE <= NVL(in_end_date, TRANSACTION.CREATE_DATE)
15:21:31 1098  	   -- Filter by transaction status
15:21:31 1099  	   AND TRANSACTION.TRANSACTION_STATUS_ID IN ( SELECT NVL(in_transaction_status, TRANSACTION.TRANSACTION_STATUS_ID) FROM DUAL);
15:21:31 1100  
15:21:31 1101  /*
15:21:31 1102  
15:21:31 1103  statement :=  'select distinct '||CHR(10)
15:21:31 1104  || ' TRANSACTION.ID,'||CHR(10)
15:21:31 1105  || ' TRANSACTION.TRANSACTION_STATUS_ID, '||CHR(10)
15:21:31 1106  || ' TRANSACTION.TRANSACTION_AMOUNT, '||CHR(10)
15:21:31 1107  || ' TRANSACTION.CREATE_DATE, '||CHR(10)
15:21:31 1108  || ' TRANSACTION.CREATED_BY, '||CHR(10)
15:21:31 1109  || ' TRANSACTION.IS_REFUND from TRANSACTION '||CHR(10)
15:21:31 1110  || ' inner join CHARGE on (CHARGE.TRANSACTION_ID = TRANSACTION.ID)'||CHR(10)
15:21:31 1111  || ' inner join INVOICE on (INVOICE.ID = CHARGE.INVOICE_ID)'||CHR(10)
15:21:31 1112  || ' inner join LICENSE on (LICENSE.INVOICE_ID = INVOICE.ID)'||CHR(10)
15:21:31 1113  || ' inner join SUBSCRIPTION on (SUBSCRIPTION.ID = LICENSE.SUBSCRIPTION_ID)'||CHR(10)
15:21:31 1114  || ' inner join ACCOUNT on (ACCOUNT.ID = SUBSCRIPTION.ACCOUNT_ID)'||CHR(10)
15:21:31 1115  || ' where ACCOUNT.GROUP_ID = '||in_group_id;
15:21:31 1116  
15:21:31 1117  IF (in_transaction_status IS NOT NULL) THEN
15:21:31 1118  	 statement := statement || CHR(10) || 'AND TRANSACTION.TRANSACTION_STATUS_ID=' || in_transaction_status;
15:21:31 1119  END IF;
15:21:31 1120  
15:21:31 1121  IF (in_invoice_id IS NOT NULL) THEN
15:21:31 1122  	 statement := statement || CHR(10) || 'AND INVOICE.ID=' || in_invoice_id;
15:21:31 1123  END IF;
15:21:31 1124  
15:21:31 1125  IF (in_subscription_id IS NOT NULL) THEN
15:21:31 1126  	 statement := statement || CHR(10) || 'AND SUBSCRIPTION.ID=' || in_subscription_id;
15:21:31 1127  END IF;
15:21:31 1128  
15:21:31 1129  IF (in_start_date IS NOT NULL) THEN
15:21:31 1130  	 statement := statement || CHR(10) || 'AND TRANSACTION.CREATE_DATE>= TO_DATE(''' || TO_CHAR(in_start_date,'yyyy/mm/dd:hh:mi:ss') || ''',''yyyy/mm/dd:hh:mi:ss'')';  -- norlov: ??
15:21:31 1131  END IF;
15:21:31 1132  
15:21:31 1133  IF (in_end_date IS NOT NULL) THEN
15:21:31 1134  	 statement := statement || CHR(10) || 'AND TRANSACTION.CREATE_DATE<= TO_DATE(''' || TO_CHAR(in_end_date,'yyyy/mm/dd:hh:mi:ss') || ''',''yyyy/mm/dd:hh:mi:ss'')'; -- norlov: ??
15:21:31 1135  END IF;
15:21:31 1136  dbms_output.put_line(statement);
15:21:31 1137  OPEN out_result_set FOR statement;
15:21:31 1138  
15:21:31 1139  */
15:21:31 1140  
15:21:31 1141  EXCEPTION
15:21:31 1142  WHEN BAD_GROUP_ID THEN
15:21:31 1143  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 1144  	   SPROC_NAME, 'No such group');
15:21:31 1145  WHEN OTHERS THEN
15:21:31 1146  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 1147  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 1148  END GET_TRANSACTIONS;
15:21:31 1149  
15:21:31 1150  FUNCTION IS_TRANSACTION_COLLECTED (
15:21:31 1151  /*
15:21:31 1152  Throws:
15:21:31 1153  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:31 1154  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31 1155  Returns:
15:21:31 1156  GLOBAL_CONST.TRUE if transaction collected,
15:21:31 1157  GLOBAL_CONST.FALSE else
15:21:31 1158  */
15:21:31 1159  	 in_transaction_id IN NUMBER
15:21:31 1160  ) RETURN NUMBER AS
15:21:31 1161  SPROC_NAME CONSTANT VARCHAR2(24) := 'IS_TRANSACTION_COLLECTED';
15:21:31 1162  -- VARIABLES
15:21:31 1163  temp_transaction_id     NUMBER;
15:21:31 1164  var_success_attemps_num NUMBER;
15:21:31 1165  -- EXCEPTIONS
15:21:31 1166  BAD_TRANSACTION_ID EXCEPTION;
15:21:31 1167  BEGIN
15:21:31 1168  
15:21:31 1169  	 BEGIN
15:21:31 1170  	   SELECT
15:21:31 1171  	     TRANSACTION.ID into temp_transaction_id
15:21:31 1172  	   FROM
15:21:31 1173  	     TRANSACTION
15:21:31 1174  	   WHERE
15:21:31 1175  	     TRANSACTION.ID = in_transaction_id;
15:21:31 1176  	   EXCEPTION
15:21:31 1177  	     WHEN NO_DATA_FOUND THEN
15:21:31 1178  	       RAISE BAD_TRANSACTION_ID;
15:21:31 1179  	 END;
15:21:31 1180  
15:21:31 1181  	 SELECT
15:21:31 1182  	   COUNT(*) into var_success_attemps_num
15:21:31 1183  	 FROM
15:21:31 1184  	   TRANSACTION_ATTEMPT
15:21:31 1185  	 WHERE
15:21:31 1186  	   TRANSACTION_ATTEMPT.TRANSACTION_ID = in_transaction_id
15:21:31 1187  	   AND TRANSACTION_ATTEMPT.TRANSACTION_ATTEMPT_STATUS_ID IN ( SELECT GLOBAL_STATUSES_V18.TRANS_ATTEMPT_SUCCESS FROM DUAL );
15:21:31 1188  
15:21:31 1189  	 IF var_success_attemps_num > 0 THEN
15:21:31 1190  	   RETURN GLOBAL_CONSTANTS_V18.TRUE;
15:21:31 1191  	 ELSE
15:21:31 1192  	   RETURN GLOBAL_CONSTANTS_V18.FALSE;
15:21:31 1193  	 END IF;
15:21:31 1194  
15:21:31 1195  EXCEPTION
15:21:31 1196  WHEN BAD_TRANSACTION_ID THEN
15:21:31 1197  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 1198  	   SPROC_NAME, 'No such transaction');
15:21:31 1199  WHEN OTHERS THEN
15:21:31 1200  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 1201  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 1202  END IS_TRANSACTION_COLLECTED;
15:21:31 1203  
15:21:31 1204  
15:21:31 1205  /******************************************************************************/
15:21:31 1206  PROCEDURE GET_NEXT_ATTEMPT_NUMBER (
15:21:31 1207  /*
15:21:31 1208  Throws exceptions:
15:21:31 1209  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:31 1210  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31 1211  */
15:21:31 1212  	 in_charge_id	in  number,
15:21:31 1213  	 out_attempt_count OUT NUMBER
15:21:31 1214  ) AS
15:21:31 1215  -- VARIABLES
15:21:31 1216  SPROC_NAME     CONSTANT VARCHAR2(29) := 'GET_NEXT_ATTEMPT_NUMBER';
15:21:31 1217  temp_transaction_id NUMBER;
15:21:31 1218  -- EXCEPTIONS
15:21:31 1219  BAD_CHARGE_ID EXCEPTION;
15:21:31 1220  BEGIN
15:21:31 1221  
15:21:31 1222  	 BEGIN
15:21:31 1223  	   SELECT
15:21:31 1224  	     TRANSACTION_ID into temp_transaction_id
15:21:31 1225  	   FROM
15:21:31 1226  	     CHARGE
15:21:31 1227  	   WHERE
15:21:31 1228  	     CHARGE.ID = in_charge_id;
15:21:31 1229  	   EXCEPTION
15:21:31 1230  	     WHEN NO_DATA_FOUND THEN
15:21:31 1231  	       RAISE BAD_CHARGE_ID;
15:21:31 1232  	 END;
15:21:31 1233  
15:21:31 1234  	 select
15:21:31 1235  	   count(1)
15:21:31 1236  	 into
15:21:31 1237  	   out_attempt_count
15:21:31 1238  	 from
15:21:31 1239  	   transaction tr
15:21:31 1240  	 inner join
15:21:31 1241  	   transaction_attempt ta
15:21:31 1242  	 on (tr.id = ta.transaction_id)
15:21:31 1243  	 where
15:21:31 1244  	   tr.ID = temp_transaction_id;
15:21:31 1245  
15:21:31 1246  	 out_attempt_count := out_attempt_count + 1;
15:21:31 1247  
15:21:31 1248  EXCEPTION
15:21:31 1249  WHEN BAD_CHARGE_ID THEN
15:21:31 1250  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 1251  	   SPROC_NAME, 'No such charge');
15:21:31 1252  WHEN OTHERS THEN
15:21:31 1253  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 1254  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 1255  end GET_NEXT_ATTEMPT_NUMBER;
15:21:31 1256  /******************************************************************************/
15:21:31 1257  
15:21:31 1258  END PROCS_TRANSACTION_V18;
15:21:31 1259  .
15:21:31 SQL> /

Package body created.

Elapsed: 00:00:00.08
15:21:31 SQL> 
15:21:31 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_LICENSE_V18" AS
15:21:31   2  
15:21:31   3  PROCEDURE CREATE_LICENSE(
15:21:31   4  /*
15:21:31   5  Throws exceptions:
15:21:31   6  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:31   7  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31   8  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:31   9  */
15:21:31  10  	in_status_id		    IN NUMBER,
15:21:31  11  	in_needs_entitlements	    IN NUMBER,
15:21:31  12  	in_start_date		    IN DATE,
15:21:31  13  	in_end_date		    IN DATE,
15:21:31  14  	in_offer_id		    IN NUMBER,
15:21:31  15  	in_subscription_id	    IN NUMBER,
15:21:31  16  	in_invoice_id		    IN NUMBER,
15:21:31  17  	in_created_by		    IN VARCHAR2,
15:21:31  18  	in_is_extension 	    IN NUMBER,
15:21:31  19  	in_current_offer_index	    IN NUMBER,
15:21:31  20  	in_current_offer_recurr_num IN NUMBER,
15:21:31  21  	out_license_id		    OUT NUMBER
15:21:31  22  ) AS
15:21:31  23  -- VARIABLES
15:21:31  24  SPROC_NAME	   CONSTANT VARCHAR2(14) := 'CREATE_LICENSE';
15:21:31  25  temp_offer_id	   NUMBER;
15:21:31  26  temp_subscription_id NUMBER;
15:21:31  27  temp_invoice_id	   NUMBER;
15:21:31  28  
15:21:31  29  var_new_license_id NUMBER;
15:21:31  30  var_offer_duration VARCHAR2(30);
15:21:31  31  
15:21:31  32  var_offer_ym_interval INTERVAL YEAR TO MONTH;
15:21:31  33  var_offer_ds_interval INTERVAL DAY(3) TO SECOND;
15:21:31  34  var_offer_years	    NUMBER;
15:21:31  35  var_offer_months	    NUMBER;
15:21:31  36  var_offer_days	    NUMBER;
15:21:31  37  
15:21:31  38  -- EXCEPTIONS
15:21:31  39  BAD_OFFER_ID	     EXCEPTION;
15:21:31  40  BAD_SUBSCRIPTION_ID    EXCEPTION;
15:21:31  41  BAD_INVOICE_ID	     EXCEPTION;
15:21:31  42  BAD_OFFER_DURATION     EXCEPTION;
15:21:31  43  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:31  44  BEGIN
15:21:31  45  
15:21:31  46  	-- TODO:
15:21:31  47  	---- check incoming data: in_current_offer_index, in_current_offer_recurr_num, in_is_extension
15:21:31  48  
15:21:31  49  	out_license_id := NULL;
15:21:31  50  
15:21:31  51  	-- get offer id and offer entitlement duration
15:21:31  52  	BEGIN
15:21:31  53  	  SELECT
15:21:31  54  	    OFFER.ID,
15:21:31  55  	    OFFER.ENTITLEMENT_DURATION
15:21:31  56  	    into
15:21:31  57  	    temp_offer_id,
15:21:31  58  	    var_offer_duration
15:21:31  59  	  FROM
15:21:31  60  	    OFFER
15:21:31  61  	  WHERE
15:21:31  62  	    OFFER.ID = in_offer_id;
15:21:31  63  	  EXCEPTION
15:21:31  64  	  WHEN NO_DATA_FOUND THEN
15:21:31  65  	    RAISE BAD_OFFER_ID;
15:21:31  66  	END;
15:21:31  67  
15:21:31  68  	-- Check that subscription exists
15:21:31  69  	BEGIN
15:21:31  70  	  SELECT
15:21:31  71  	    SUBSCRIPTION.ID into temp_subscription_id
15:21:31  72  	  FROM
15:21:31  73  	    SUBSCRIPTION
15:21:31  74  	  WHERE
15:21:31  75  	    SUBSCRIPTION.ID = in_subscription_id;
15:21:31  76  	  EXCEPTION
15:21:31  77  	  WHEN NO_DATA_FOUND THEN
15:21:31  78  	    RAISE BAD_SUBSCRIPTION_ID;
15:21:31  79  	END;
15:21:31  80  
15:21:31  81  	-- Check that invoice exists
15:21:31  82  	BEGIN
15:21:31  83  	  SELECT
15:21:31  84  	    INVOICE.ID into temp_invoice_id
15:21:31  85  	  FROM
15:21:31  86  	    INVOICE
15:21:31  87  	  WHERE
15:21:31  88  	    INVOICE.ID = in_invoice_id;
15:21:31  89  	  EXCEPTION
15:21:31  90  	  WHEN NO_DATA_FOUND THEN
15:21:31  91  	    RAISE BAD_INVOICE_ID;
15:21:31  92  	END;
15:21:31  93  
15:21:31  94  	-- convert offer duration into intervals
15:21:31  95  	BEGIN
15:21:31  96  	  PROCS_COMMON_V18.ISO8601DURATION_TO_INTERVALS(
15:21:31  97  	    var_offer_duration,
15:21:31  98  	    var_offer_years,
15:21:31  99  	    var_offer_months,
15:21:31 100  	    var_offer_days);
15:21:31 101  	  var_offer_ym_interval := var_offer_years||'-'||var_offer_months;
15:21:31 102  	  var_offer_ds_interval := var_offer_days||' 0:0:0';
15:21:31 103  	  EXCEPTION
15:21:31 104  	    WHEN OTHERS THEN
15:21:31 105  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:31 106  	      RAISE BAD_OFFER_DURATION;
15:21:31 107  	END;
15:21:31 108  
15:21:31 109  	-- insert new row into license table
15:21:31 110  	PROCS_LICENSE_CRU_V18.CREATE_LICENSE(
15:21:31 111  	  out_license_id	      => var_new_license_id,
15:21:31 112  	  in_license_status_id	      => in_status_id,
15:21:31 113  	  in_needs_entitlements       => in_needs_entitlements,
15:21:31 114  	  in_start_date 	      => in_start_date,
15:21:31 115  	  in_offer_id		      => in_offer_id,
15:21:31 116  	  in_subscription_id	      => in_subscription_id,
15:21:31 117  	  in_invoice_id 	      => in_invoice_id,
15:21:31 118  	  in_end_date		      => NVL(in_end_date, in_start_date + var_offer_ym_interval + var_offer_ds_interval),
15:21:31 119  	  in_created_by 	      => in_created_by,
15:21:31 120  	  in_is_extension	      => in_is_extension,
15:21:31 121  	  in_current_offer_index      => in_current_offer_index,
15:21:31 122  	  in_current_offer_recurr_num => in_current_offer_recurr_num
15:21:31 123  	);
15:21:31 124  
15:21:31 125  	out_license_id := var_new_license_id;
15:21:31 126  
15:21:31 127  EXCEPTION
15:21:31 128  WHEN BAD_OFFER_DURATION THEN
15:21:31 129  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:31 130  	  SPROC_NAME, 'Bad offer duration format', EXCEPTION_MESSAGE);
15:21:31 131  WHEN BAD_OFFER_ID THEN
15:21:31 132  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 133  	  SPROC_NAME, 'No such offer');
15:21:31 134  WHEN BAD_SUBSCRIPTION_ID THEN
15:21:31 135  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 136  	  SPROC_NAME, 'No such subscription');
15:21:31 137  WHEN BAD_INVOICE_ID THEN
15:21:31 138  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 139  	  SPROC_NAME, 'No such invoice');
15:21:31 140  WHEN OTHERS THEN
15:21:31 141  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 142  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 143  END;
15:21:31 144  
15:21:31 145  /******************************************************************************/
15:21:31 146  
15:21:31 147  PROCEDURE UPDATE_LICENSE_STATUS(
15:21:31 148  	  in_license_id     IN NUMBER,
15:21:31 149  	  in_license_status IN NUMBER,
15:21:31 150  	  in_updated_by     IN VARCHAR2,
15:21:31 151  	  in_ent_end	    IN NUMBER DEFAULT GLOBAL_CONSTANTS_V18.FALSE
15:21:31 152  ) AS
15:21:31 153  SPROC_NAME CONSTANT VARCHAR2(21) := 'UPDATE_LICENSE_STATUS';
15:21:31 154  -- VARIABLES
15:21:31 155  temp_license_id NUMBER;
15:21:31 156  -- EXCEPTIONS
15:21:31 157  BAD_LICENSE_ID	     EXCEPTION;
15:21:31 158  BAD_LICENSE_STATUS     EXCEPTION;
15:21:31 159  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:31 160  BEGIN
15:21:31 161  
15:21:31 162  	BEGIN
15:21:31 163  	  SELECT
15:21:31 164  	    ID into temp_license_id
15:21:31 165  	  FROM
15:21:31 166  	    LICENSE
15:21:31 167  	  WHERE
15:21:31 168  	    LICENSE.ID = in_license_id;
15:21:31 169  	  EXCEPTION
15:21:31 170  	    WHEN NO_DATA_FOUND THEN
15:21:31 171  	      RAISE BAD_LICENSE_ID;
15:21:31 172  	END;
15:21:31 173  
15:21:31 174  	IF in_license_status != GLOBAL_STATUSES_V18.LICENSE_CLOSED
15:21:31 175  	   AND in_license_status != GLOBAL_STATUSES_V18.LICENSE_ACTIVE
15:21:31 176  	   AND in_license_status != GLOBAL_STATUSES_V18.LICENSE_IN_GRACE_PERIOD THEN
15:21:31 177  	  RAISE BAD_LICENSE_STATUS;
15:21:31 178  	END IF;
15:21:31 179  
15:21:31 180  	IF (in_ent_end is not null and in_ent_end = GLOBAL_CONSTANTS_V18.TRUE) then
15:21:31 181  	  PROCS_LICENSE_CRU_V18.UPDATE_LICENSE(
15:21:31 182  	    in_license_id	 => in_license_id,
15:21:31 183  	    in_updated_by	 => in_updated_by,
15:21:31 184  	    in_license_status_id => in_license_status,
15:21:31 185  	    in_entitlement_end_date	 => sysdate
15:21:31 186  	  );
15:21:31 187  	ELSE
15:21:31 188  	  PROCS_LICENSE_CRU_V18.UPDATE_LICENSE(
15:21:31 189  	    in_license_id	 => in_license_id,
15:21:31 190  	    in_updated_by	 => in_updated_by,
15:21:31 191  	    in_license_status_id => in_license_status
15:21:31 192  	  );
15:21:31 193  	END IF;
15:21:31 194  
15:21:31 195  EXCEPTION
15:21:31 196  WHEN BAD_LICENSE_STATUS THEN
15:21:31 197  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:31 198  	  SPROC_NAME, 'Bad status id');
15:21:31 199  WHEN BAD_LICENSE_ID THEN
15:21:31 200  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 201  	  SPROC_NAME, 'No such license');
15:21:31 202  WHEN OTHERS THEN
15:21:31 203  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 204  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 205  END UPDATE_LICENSE_STATUS;
15:21:31 206  
15:21:31 207  /******************************************************************************/
15:21:31 208  
15:21:31 209  PROCEDURE GET_ENDING_LICENSES (
15:21:31 210  	in_hours_number IN NUMBER,
15:21:31 211  	out_result_set	OUT SYS_REFCURSOR
15:21:31 212  ) AS
15:21:31 213  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_ENDING_LICENSES';
15:21:31 214  -- VARIABLES
15:21:31 215  var_days		NUMBER;
15:21:31 216  var_hours 	NUMBER;
15:21:31 217  var_time_interval INTERVAL DAY (3) TO SECOND;
15:21:31 218  BEGIN
15:21:31 219  
15:21:31 220  	var_hours := mod(in_hours_number,24);
15:21:31 221  	var_days := (in_hours_number - var_hours) / 24;
15:21:31 222  	var_time_interval := var_days||' '||var_hours||':0:0';
15:21:31 223  
15:21:31 224  	OPEN out_result_set FOR
15:21:31 225  SELECT * FROM
15:21:31 226  (
15:21:31 227  	SELECT
15:21:31 228  	  LICENSE.ID,
15:21:31 229  	  LICENSE.CREATE_DATE,
15:21:31 230  	  LICENSE.CREATED_BY,
15:21:31 231  	  LICENSE.CURRENT_OFFER_INDEX,
15:21:31 232  	  LICENSE.CURRENT_OFFER_RECURR_NUM,
15:21:31 233  	  LICENSE.END_DATE,
15:21:31 234  	  LICENSE.ENTITLEMENT_END_DATE,
15:21:31 235  	  LICENSE.INVOICE_ID,
15:21:31 236  	  LICENSE.IS_EXTENSION,
15:21:31 237  	  LICENSE.LICENSE_STATUS_ID,
15:21:31 238  	  LICENSE.OFFER_ID,
15:21:31 239  	  LICENSE.START_DATE,
15:21:31 240  	  LICENSE.SUBSCRIPTION_ID,
15:21:31 241  	  LICENSE.UPDATE_DATE,
15:21:31 242  	  LICENSE.UPDATED_BY
15:21:31 243  	FROM
15:21:31 244  	  LICENSE
15:21:31 245  	WHERE
15:21:31 246  	  TO_DATE(LICENSE.END_DATE) <= (current_timestamp + var_time_interval)
15:21:31 247  	  AND LICENSE.LICENSE_STATUS_ID = GLOBAL_STATUSES_V18.LICENSE_ACTIVE
15:21:31 248  	  AND NOT EXISTS
15:21:31 249  	  (
15:21:31 250  	    SELECT NULL
15:21:31 251  	    FROM PROCESS_RETRY_THROTTLE
15:21:31 252  	    WHERE PROCESS_NAME = SPROC_NAME
15:21:31 253  	      AND GENERIC_ID = LICENSE.ID
15:21:31 254  	  )
15:21:31 255  	  AND ROWNUM <= 10000
15:21:31 256  	  ORDER BY dbms_random.value
15:21:31 257  ) WHERE
15:21:31 258  	  ROWNUM <= 1000
15:21:31 259  	  ;
15:21:31 260  EXCEPTION
15:21:31 261  WHEN OTHERS THEN
15:21:31 262  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 263  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 264  END GET_ENDING_LICENSES;
15:21:31 265  
15:21:31 266  
15:21:31 267  /******************************************************************************/
15:21:31 268  
15:21:31 269  PROCEDURE GET_ENDING_LICENSES_CC (
15:21:31 270  	in_hours_number IN NUMBER,
15:21:31 271  	out_result_set	OUT SYS_REFCURSOR,
15:21:31 272  	in_process_name IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE
15:21:31 273  ) AS
15:21:31 274  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_ENDING_LICENSES_CC';
15:21:31 275  -- VARIABLES
15:21:31 276  var_days		NUMBER;
15:21:31 277  var_hours 	NUMBER;
15:21:31 278  var_time_interval INTERVAL DAY (3) TO SECOND;
15:21:31 279  BEGIN
15:21:31 280  
15:21:31 281  	var_hours := mod(in_hours_number,24);
15:21:31 282  	var_days := (in_hours_number - var_hours) / 24;
15:21:31 283  	var_time_interval := var_days||' '||var_hours||':0:0';
15:21:31 284  
15:21:31 285  	OPEN out_result_set FOR
15:21:31 286  SELECT * FROM
15:21:31 287  (
15:21:31 288  	SELECT
15:21:31 289  	  LICENSE.ID,
15:21:31 290  	  LICENSE.CREATE_DATE,
15:21:31 291  	  LICENSE.CREATED_BY,
15:21:31 292  	  LICENSE.CURRENT_OFFER_INDEX,
15:21:31 293  	  LICENSE.CURRENT_OFFER_RECURR_NUM,
15:21:31 294  	  LICENSE.END_DATE,
15:21:31 295  	  LICENSE.ENTITLEMENT_END_DATE,
15:21:31 296  	  LICENSE.INVOICE_ID,
15:21:31 297  	  LICENSE.IS_EXTENSION,
15:21:31 298  	  LICENSE.LICENSE_STATUS_ID,
15:21:31 299  	  LICENSE.OFFER_ID,
15:21:31 300  	  LICENSE.START_DATE,
15:21:31 301  	  LICENSE.SUBSCRIPTION_ID,
15:21:31 302  	  LICENSE.UPDATE_DATE,
15:21:31 303  	  LICENSE.UPDATED_BY
15:21:31 304  	FROM
15:21:31 305  	  LICENSE
15:21:31 306  	WHERE
15:21:31 307  	  TO_DATE(LICENSE.END_DATE) <= (current_timestamp + var_time_interval)
15:21:31 308  	  AND LICENSE.LICENSE_STATUS_ID = GLOBAL_STATUSES_V18.LICENSE_ACTIVE
15:21:31 309  	  AND NOT EXISTS
15:21:31 310  	  (
15:21:31 311  	    SELECT NULL
15:21:31 312  	    FROM PROCESS_RETRY_THROTTLE
15:21:31 313  	    WHERE PROCESS_NAME = in_process_name
15:21:31 314  	      AND GENERIC_ID = LICENSE.INVOICE_ID
15:21:31 315  	  )
15:21:31 316  	  AND ROWNUM <= 10000
15:21:31 317  	  ORDER BY dbms_random.value
15:21:31 318  ) WHERE
15:21:31 319  	  ROWNUM <= 1000
15:21:31 320  	  ;
15:21:31 321  EXCEPTION
15:21:31 322  WHEN OTHERS THEN
15:21:31 323  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 324  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 325  END GET_ENDING_LICENSES_CC;
15:21:31 326  
15:21:31 327  /******************************************************************************/
15:21:31 328  
15:21:31 329  PROCEDURE GET_RECURRING_OFFER (
15:21:31 330  	in_license_id  IN NUMBER,
15:21:31 331  	out_result_set OUT SYS_REFCURSOR
15:21:31 332  ) AS
15:21:31 333  -- VARIABLES
15:21:31 334  SPROC_NAME		    CONSTANT VARCHAR2(19) := 'GET_RECURRING_OFFER';
15:21:31 335  var_offer_chain_id	    NUMBER;
15:21:31 336  var_offer_id		    NUMBER;
15:21:31 337  var_offer_num_recurrences     NUMBER;
15:21:31 338  var_license_cur_offer_rec_num NUMBER;
15:21:31 339  var_offer_index		    NUMBER;
15:21:31 340  -- EXCEPTIONS
15:21:31 341  BAD_LICENSE_ID	     EXCEPTION;
15:21:31 342  CAN_NOT_GET_OFFER_INFO EXCEPTION;
15:21:31 343  BEGIN
15:21:31 344  
15:21:31 345  	BEGIN
15:21:31 346  	  SELECT
15:21:31 347  	    SUBSCRIPTION.OFFER_CHAIN_ID,
15:21:31 348  	    LICENSE.OFFER_ID,
15:21:31 349  	    LICENSE.CURRENT_OFFER_RECURR_NUM
15:21:31 350  	    into
15:21:31 351  	    var_offer_chain_id,
15:21:31 352  	    var_offer_id,
15:21:31 353  	    var_license_cur_offer_rec_num
15:21:31 354  	  FROM
15:21:31 355  	    LICENSE
15:21:31 356  	    INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
15:21:31 357  	  WHERE
15:21:31 358  	    LICENSE.ID = in_license_id;
15:21:31 359  	  EXCEPTION
15:21:31 360  	    WHEN NO_DATA_FOUND THEN
15:21:31 361  	      RAISE BAD_LICENSE_ID;
15:21:31 362  	END;
15:21:31 363  
15:21:31 364  	BEGIN
15:21:31 365  	  SELECT
15:21:31 366  	    OFFER_OFFER_CHAIN.NUM_RECURRENCES,
15:21:31 367  	    OFFER_OFFER_CHAIN.INDEX_VALUE
15:21:31 368  	    into
15:21:31 369  	    var_offer_num_recurrences,
15:21:31 370  	    var_offer_index
15:21:31 371  	  FROM
15:21:31 372  	    OFFER_OFFER_CHAIN
15:21:31 373  	    INNER JOIN OFFER ON OFFER_OFFER_CHAIN.OFFER_ID = OFFER.ID
15:21:31 374  	  WHERE
15:21:31 375  	    OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = var_offer_chain_id
15:21:31 376  	    AND OFFER_OFFER_CHAIN.OFFER_ID = var_offer_id;
15:21:31 377  	  EXCEPTION
15:21:31 378  	    WHEN NO_DATA_FOUND THEN
15:21:31 379  	      RAISE CAN_NOT_GET_OFFER_INFO;
15:21:31 380  	END;
15:21:31 381  
15:21:31 382  	IF var_offer_num_recurrences = 0 THEN
15:21:31 383  	  --out_result_set := NULL;
15:21:31 384  	  -- TODO: Remove this hardcode
15:21:31 385  	  OPEN out_result_set FOR
15:21:31 386  	  SELECT
15:21:31 387  	    OFFER.ID,
15:21:31 388  	    OFFER.OFFER_STATUS_ID,
15:21:31 389  	    OFFER.ENTITLEMENT_DURATION,
15:21:31 390  	    OFFER.CREATED_BY,
15:21:31 391  	    OFFER.CREATE_DATE,
15:21:31 392  	    OFFER.UPDATED_BY,
15:21:31 393  	    OFFER.UPDATE_DATE,
15:21:31 394  	    var_offer_num_recurrences as "RECURRENCE_NUMBER",
15:21:31 395  	    var_offer_index as "OFFER_INDEX"
15:21:31 396  	  FROM
15:21:31 397  	    OFFER_OFFER_CHAIN
15:21:31 398  	    INNER JOIN OFFER ON OFFER_OFFER_CHAIN.OFFER_ID = OFFER.ID
15:21:31 399  	  WHERE ROWNUM = 0;
15:21:31 400  	ELSIF var_license_cur_offer_rec_num = var_offer_num_recurrences THEN
15:21:31 401  	  --out_result_set := NULL;
15:21:31 402  	  -- TODO: Remove this hardcode
15:21:31 403  	  OPEN out_result_set FOR
15:21:31 404  	  SELECT
15:21:31 405  	    OFFER.ID,
15:21:31 406  	    OFFER.OFFER_STATUS_ID,
15:21:31 407  	    OFFER.ENTITLEMENT_DURATION,
15:21:31 408  	    OFFER.CREATED_BY,
15:21:31 409  	    OFFER.CREATE_DATE,
15:21:31 410  	    OFFER.UPDATED_BY,
15:21:31 411  	    OFFER.UPDATE_DATE,
15:21:31 412  	    var_offer_num_recurrences as "RECURRENCE_NUMBER",
15:21:31 413  	    var_offer_index as "OFFER_INDEX"
15:21:31 414  	  FROM
15:21:31 415  	    OFFER_OFFER_CHAIN
15:21:31 416  	    INNER JOIN OFFER ON OFFER_OFFER_CHAIN.OFFER_ID = OFFER.ID
15:21:31 417  	  WHERE ROWNUM = 0;
15:21:31 418  	ELSE
15:21:31 419  	  OPEN out_result_set FOR
15:21:31 420  	  SELECT
15:21:31 421  	    OFFER.ID,
15:21:31 422  	    OFFER.OFFER_STATUS_ID,
15:21:31 423  	    OFFER.ENTITLEMENT_DURATION,
15:21:31 424  	    OFFER.CREATED_BY,
15:21:31 425  	    OFFER.CREATE_DATE,
15:21:31 426  	    OFFER.UPDATED_BY,
15:21:31 427  	    OFFER.UPDATE_DATE,
15:21:31 428  	    var_offer_num_recurrences as "RECURRENCE_NUMBER",
15:21:31 429  	    var_offer_index as "OFFER_INDEX"
15:21:31 430  	  FROM
15:21:31 431  	    OFFER
15:21:31 432  	  WHERE
15:21:31 433  	    OFFER.ID = var_offer_id;
15:21:31 434  	END IF;
15:21:31 435  
15:21:31 436  EXCEPTION
15:21:31 437  WHEN BAD_LICENSE_ID THEN
15:21:31 438  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 439  	  SPROC_NAME, 'No such license');
15:21:31 440  WHEN CAN_NOT_GET_OFFER_INFO THEN
15:21:31 441  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 442  	  SPROC_NAME, 'Could not get offer information. Offer id = '||var_offer_id||', Offer chain id = '||var_offer_chain_id);
15:21:31 443  WHEN OTHERS THEN
15:21:31 444  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 445  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 446  END GET_RECURRING_OFFER;
15:21:31 447  
15:21:31 448  /******************************************************************************/
15:21:31 449  
15:21:31 450  PROCEDURE GET_NEXT_OFFER (
15:21:31 451  /*
15:21:31 452  Throws exceptions:
15:21:31 453  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:31 454  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:31 455  */
15:21:31 456  	in_license_id  IN NUMBER,
15:21:31 457  	out_result_set OUT SYS_REFCURSOR
15:21:31 458  ) AS
15:21:31 459  -- VARIABLES
15:21:31 460  SPROC_NAME		CONSTANT VARCHAR2(14) := 'GET_NEXT_OFFER';
15:21:31 461  var_offer_chain_id	NUMBER;
15:21:31 462  var_offer_id		NUMBER;
15:21:31 463  var_license_current_index NUMBER;
15:21:31 464  var_next_offer_index	NUMBER;
15:21:31 465  -- EXCEPTIONS
15:21:31 466  BAD_LICENSE_ID	      EXCEPTION;
15:21:31 467  CAN_NOT_FIND_NEXT_OFFER EXCEPTION;
15:21:31 468  EXCEPTION_MESSAGE       VARCHAR2(1024);
15:21:31 469  BEGIN
15:21:31 470  
15:21:31 471  	BEGIN
15:21:31 472  	  SELECT
15:21:31 473  	    SUBSCRIPTION.OFFER_CHAIN_ID,
15:21:31 474  	    LICENSE.OFFER_ID,
15:21:31 475  	    LICENSE.CURRENT_OFFER_INDEX
15:21:31 476  	    into
15:21:31 477  	    var_offer_chain_id,
15:21:31 478  	    var_offer_id,
15:21:31 479  	    var_license_current_index
15:21:31 480  	  FROM
15:21:31 481  	    LICENSE
15:21:31 482  	    INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
15:21:31 483  	  WHERE
15:21:31 484  	    LICENSE.ID = in_license_id;
15:21:31 485  	  EXCEPTION
15:21:31 486  	    WHEN NO_DATA_FOUND THEN
15:21:31 487  	      RAISE BAD_LICENSE_ID;
15:21:31 488  	END;
15:21:31 489  
15:21:31 490  	BEGIN
15:21:31 491  	  var_next_offer_index := PROCS_OFFER_CHAIN_V18.GET_NEXT_OFFER_INDEX(
15:21:31 492  	    var_offer_chain_id,
15:21:31 493  	    var_license_current_index
15:21:31 494  	  );
15:21:31 495  	  EXCEPTION
15:21:31 496  	    WHEN OTHERS THEN
15:21:31 497  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:31 498  	      RAISE CAN_NOT_FIND_NEXT_OFFER;
15:21:31 499  	END;
15:21:31 500  
15:21:31 501  	IF var_next_offer_index IS NULL THEN
15:21:31 502  	  -- RETURN NULL;
15:21:31 503  	  -- TODO: Remove this hardcode
15:21:31 504  	  OPEN out_result_set FOR
15:21:31 505  	  SELECT
15:21:31 506  	    OFFER.ID,
15:21:31 507  	    OFFER.OFFER_STATUS_ID,
15:21:31 508  	    OFFER.ENTITLEMENT_DURATION,
15:21:31 509  	    OFFER.CREATED_BY,
15:21:31 510  	    OFFER.CREATE_DATE,
15:21:31 511  	    OFFER.UPDATED_BY,
15:21:31 512  	    OFFER.UPDATE_DATE,
15:21:31 513  	    OFFER_OFFER_CHAIN.NUM_RECURRENCES as "RECURRENCE_NUMBER"
15:21:31 514  	  FROM
15:21:31 515  	    OFFER_OFFER_CHAIN
15:21:31 516  	    INNER JOIN OFFER ON OFFER_OFFER_CHAIN.OFFER_ID = OFFER.ID
15:21:31 517  	  WHERE
15:21:31 518  	    1=2;
15:21:31 519  	ELSE
15:21:31 520  	  OPEN out_result_set FOR
15:21:31 521  	  SELECT
15:21:31 522  	    OFFER.ID,
15:21:31 523  	    OFFER.OFFER_STATUS_ID,
15:21:31 524  	    OFFER.ENTITLEMENT_DURATION,
15:21:31 525  	    OFFER.CREATED_BY,
15:21:31 526  	    OFFER.CREATE_DATE,
15:21:31 527  	    OFFER.UPDATED_BY,
15:21:31 528  	    OFFER.UPDATE_DATE,
15:21:31 529  	    OFFER_OFFER_CHAIN.NUM_RECURRENCES as "RECURRENCE_NUMBER"
15:21:31 530  	  FROM
15:21:31 531  	    OFFER_OFFER_CHAIN
15:21:31 532  	    INNER JOIN OFFER ON OFFER_OFFER_CHAIN.OFFER_ID = OFFER.ID
15:21:31 533  	  WHERE
15:21:31 534  	    OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = var_offer_chain_id
15:21:31 535  	    AND OFFER_OFFER_CHAIN.INDEX_VALUE = var_next_offer_index;
15:21:31 536  	END IF;
15:21:31 537  
15:21:31 538  EXCEPTION
15:21:31 539  WHEN BAD_LICENSE_ID THEN
15:21:31 540  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 541  	  SPROC_NAME, 'No such license');
15:21:31 542  WHEN CAN_NOT_FIND_NEXT_OFFER THEN
15:21:31 543  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:31 544  	  SPROC_NAME, 'Could not find next offer', EXCEPTION_MESSAGE);
15:21:31 545  WHEN OTHERS THEN
15:21:31 546  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 547  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 548  END GET_NEXT_OFFER;
15:21:31 549  
15:21:31 550  /******************************************************************************/
15:21:31 551  
15:21:31 552  PROCEDURE GET_GROUP_ID_BY_LICENSE_ID (
15:21:31 553  	in_license_id IN NUMBER,
15:21:31 554  	out_group_id  OUT NUMBER
15:21:31 555  ) AS
15:21:31 556  -- VARIABLES
15:21:31 557  SPROC_NAME	  CONSTANT VARCHAR2(26) := 'GET_GROUP_ID_BY_LICENSE_ID';
15:21:31 558  var_subscription_id NUMBER;
15:21:31 559  var_group_id	  NUMBER;
15:21:31 560  -- EXCEPTIONS
15:21:31 561  BAD_LICENSE_ID	   EXCEPTION;
15:21:31 562  CAN_NOT_GET_GROUP_ID EXCEPTION;
15:21:31 563  BEGIN
15:21:31 564  
15:21:31 565  	-- Get subscription id
15:21:31 566  	BEGIN
15:21:31 567  	  SELECT
15:21:31 568  	    LICENSE.SUBSCRIPTION_ID into var_subscription_id
15:21:31 569  	  FROM
15:21:31 570  	    LICENSE
15:21:31 571  	  WHERE
15:21:31 572  	    LICENSE.ID = in_license_id;
15:21:31 573  	  EXCEPTION
15:21:31 574  	    WHEN NO_DATA_FOUND THEN
15:21:31 575  	      RAISE BAD_LICENSE_ID;
15:21:31 576  	END;
15:21:31 577  
15:21:31 578  	-- Get group id
15:21:31 579  	BEGIN
15:21:31 580  	  SELECT
15:21:31 581  	    ACCOUNT.GROUP_ID into var_group_id
15:21:31 582  	  FROM
15:21:31 583  	    SUBSCRIPTION
15:21:31 584  	    INNER JOIN ACCOUNT ON SUBSCRIPTION.ACCOUNT_ID = ACCOUNT.ID
15:21:31 585  	  WHERE
15:21:31 586  	    SUBSCRIPTION.ID = var_subscription_id;
15:21:31 587  	  EXCEPTION
15:21:31 588  	    WHEN NO_DATA_FOUND THEN
15:21:31 589  	      RAISE CAN_NOT_GET_GROUP_ID;
15:21:31 590  	END;
15:21:31 591  
15:21:31 592  	out_group_id := var_group_id;
15:21:31 593  
15:21:31 594  EXCEPTION
15:21:31 595  WHEN BAD_LICENSE_ID THEN
15:21:31 596  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 597  	  SPROC_NAME, 'No such license');
15:21:31 598  WHEN CAN_NOT_GET_GROUP_ID THEN
15:21:31 599  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 600  	  SPROC_NAME, 'Could not get group id');
15:21:31 601  WHEN OTHERS THEN
15:21:31 602  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 603  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 604  END GET_GROUP_ID_BY_LICENSE_ID;
15:21:31 605  
15:21:31 606  /******************************************************************************/
15:21:31 607  
15:21:31 608  PROCEDURE GET_NEED_ENTITLEMENTS_LICENSES (
15:21:31 609  	out_result_set OUT SYS_REFCURSOR
15:21:31 610  ) AS
15:21:31 611  BEGIN
15:21:31 612  	OPEN out_result_set FOR
15:21:31 613  SELECT * FROM
15:21:31 614  (
15:21:31 615  	SELECT
15:21:31 616  	  LICENSE.ID,
15:21:31 617  	  LICENSE.INVOICE_ID,
15:21:31 618  	  LICENSE.IS_EXTENSION,
15:21:31 619  	  LICENSE.START_DATE,
15:21:31 620  	  LICENSE.END_DATE,
15:21:31 621  	  LICENSE.ENTITLEMENT_END_DATE,
15:21:31 622  	  LICENSE.CURRENT_OFFER_INDEX,
15:21:31 623  	  LICENSE.CURRENT_OFFER_RECURR_NUM,
15:21:31 624  	  LICENSE.CREATE_DATE,
15:21:31 625  	  LICENSE.CREATED_BY,
15:21:31 626  	  LICENSE.LICENSE_STATUS_ID,
15:21:31 627  	  LICENSE.OFFER_ID,
15:21:31 628  	  LICENSE.SUBSCRIPTION_ID,
15:21:31 629  	  LICENSE.UPDATE_DATE,
15:21:31 630  	  LICENSE.UPDATED_BY,
15:21:31 631  	  LICENSE.NEEDS_ENTITLEMENTS
15:21:31 632  	FROM
15:21:31 633  	  LICENSE
15:21:31 634  	WHERE
15:21:31 635  	  LICENSE.NEEDS_ENTITLEMENTS = GLOBAL_CONSTANTS_V18.TRUE
15:21:31 636  	AND ROWNUM <= 5000
15:21:31 637  	ORDER BY dbms_random.value
15:21:31 638  ) WHERE
15:21:31 639  	ROWNUM <= 500;
15:21:31 640  
15:21:31 641  END GET_NEED_ENTITLEMENTS_LICENSES;
15:21:31 642  
15:21:31 643  /******************************************************************************/
15:21:31 644  
15:21:31 645  PROCEDURE UPDATE_NEED_ENTITLEMENTS_FLAG (
15:21:31 646  	in_license_id	      IN NUMBER,
15:21:31 647  	in_needs_entitlements IN NUMBER,
15:21:31 648  	in_updated_by	      IN VARCHAR2
15:21:31 649  ) AS
15:21:31 650  SPROC_NAME CONSTANT VARCHAR2(29) := 'UPDATE_NEED_ENTITLEMENTS_FLAG';
15:21:31 651  -- VARIABLES
15:21:31 652  temp_license_id NUMBER;
15:21:31 653  -- EXCEPTIONS
15:21:31 654  BAD_LICENSE_ID	     EXCEPTION;
15:21:31 655  BAD_ENTITLEMENTS_FLAG  EXCEPTION;
15:21:31 656  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:31 657  BEGIN
15:21:31 658  
15:21:31 659  	IF in_needs_entitlements != GLOBAL_CONSTANTS_V18.TRUE
15:21:31 660  	  AND in_needs_entitlements != GLOBAL_CONSTANTS_V18.FALSE THEN
15:21:31 661  	  RAISE BAD_ENTITLEMENTS_FLAG;
15:21:31 662  	END IF;
15:21:31 663  
15:21:31 664  	BEGIN
15:21:31 665  	  SELECT
15:21:31 666  	    LICENSE.ID into temp_license_id
15:21:31 667  	  FROM
15:21:31 668  	    LICENSE
15:21:31 669  	  WHERE
15:21:31 670  	    LICENSE.ID = in_license_id;
15:21:31 671  	  EXCEPTION
15:21:31 672  	    WHEN NO_DATA_FOUND THEN
15:21:31 673  	      RAISE BAD_LICENSE_ID;
15:21:31 674  	END;
15:21:31 675  
15:21:31 676  	PROCS_LICENSE_CRU_V18.UPDATE_LICENSE(
15:21:31 677  	  in_license_id 	=> in_license_id,
15:21:31 678  	  in_needs_entitlements => in_needs_entitlements,
15:21:31 679  	  in_updated_by 	=> in_updated_by
15:21:31 680  	);
15:21:31 681  
15:21:31 682  EXCEPTION
15:21:31 683  WHEN BAD_ENTITLEMENTS_FLAG THEN
15:21:31 684  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:31 685  	  SPROC_NAME, 'Bad entitlements flag value');
15:21:31 686  WHEN BAD_LICENSE_ID THEN
15:21:31 687  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 688  	  SPROC_NAME, 'No such license');
15:21:31 689  WHEN OTHERS THEN
15:21:31 690  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 691  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 692  END UPDATE_NEED_ENTITLEMENTS_FLAG;
15:21:31 693  
15:21:31 694  
15:21:31 695  /******************************************************************************/
15:21:31 696  
15:21:31 697  PROCEDURE GET_ENDED_GC_LICENSES (
15:21:31 698  	out_result_set		OUT SYS_REFCURSOR,
15:21:31 699  	in_hours_number 	IN NUMBER DEFAULT 14*24,
15:21:31 700  	in_num_rows		IN NUMBER DEFAULT 10000,
15:21:31 701  	in_process_name IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE
15:21:31 702  ) AS
15:21:31 703  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_ENDED_GC_INVOICES';
15:21:31 704  var_days		NUMBER;
15:21:31 705  var_hours 	NUMBER;
15:21:31 706  var_time_interval INTERVAL DAY (3) TO SECOND;
15:21:31 707  BEGIN
15:21:31 708  	var_hours := mod(in_hours_number,24);
15:21:31 709  	var_days := (in_hours_number - var_hours) / 24;
15:21:31 710  	var_time_interval := var_days||' '||var_hours||':0:0';
15:21:31 711  	OPEN out_result_set FOR
15:21:31 712  SELECT * FROM
15:21:31 713  (
15:21:31 714  	SELECT
15:21:31 715  	  l.ID,
15:21:31 716  	  l.CREATE_DATE,
15:21:31 717  	  l.CREATED_BY,
15:21:31 718  	  l.CURRENT_OFFER_INDEX,
15:21:31 719  	  l.CURRENT_OFFER_RECURR_NUM,
15:21:31 720  	  l.END_DATE,
15:21:31 721  	  l.ENTITLEMENT_END_DATE,
15:21:31 722  	  l.INVOICE_ID,
15:21:31 723  	  l.IS_EXTENSION,
15:21:31 724  	  l.LICENSE_STATUS_ID,
15:21:31 725  	  l.OFFER_ID,
15:21:31 726  	  l.START_DATE,
15:21:31 727  	  l.SUBSCRIPTION_ID,
15:21:31 728  	  l.UPDATE_DATE,
15:21:31 729  	  l.UPDATED_BY
15:21:31 730  	FROM
15:21:31 731  	  GIFT_CERTIFICATE gc
15:21:31 732  	  INNER JOIN INVOICE i ON i.id = gc.PURCHASE_INVOICE_ID
15:21:31 733  	  INNER JOIN LICENSE l ON l.invoice_id = i.id
15:21:31 734  	  LEFT JOIN SUBSCRIPTION s ON s.id = l.subscription_id
15:21:31 735  	WHERE
15:21:31 736  	  l.LICENSE_STATUS_ID != GLOBAL_STATUSES_V18.LICENSE_ACTIVE
15:21:31 737  	  AND l.ENTITLEMENT_END_DATE <= (current_timestamp)
15:21:31 738  	  AND l.ENTITLEMENT_END_DATE > (current_timestamp - var_time_interval)
15:21:31 739  	  AND s.subscription_status_id = GLOBAL_STATUSES_V18.SUBSCRIPTION_CLOSED
15:21:31 740  	  AND NOT EXISTS (
15:21:31 741  	    SELECT NULL
15:21:31 742  	    FROM PROCESS_RETRY_THROTTLE
15:21:31 743  	    WHERE PROCESS_NAME = in_process_name
15:21:31 744  	      AND GENERIC_ID = l.ID
15:21:31 745  	  )
15:21:31 746  	  AND ROWNUM <= in_num_rows*10
15:21:31 747  	  ORDER BY dbms_random.value
15:21:31 748  ) WHERE
15:21:31 749  	  ROWNUM <= in_num_rows
15:21:31 750  	  GROUP BY SUBSCRIPTION_ID;
15:21:31 751  EXCEPTION
15:21:31 752  WHEN OTHERS THEN
15:21:31 753  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 754  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 755  END GET_ENDED_GC_LICENSES;
15:21:31 756  
15:21:31 757  PROCEDURE GET_LICENSE_BY_ID (
15:21:31 758  	in_license_id  IN NUMBER,
15:21:31 759  	out_result_set OUT SYS_REFCURSOR
15:21:31 760  ) AS
15:21:31 761  SPROC_NAME CONSTANT VARCHAR2(17) := 'GET_LICENSE_BY_ID';
15:21:31 762  -- VARIABLES
15:21:31 763  temp_license_id NUMBER;
15:21:31 764  -- EXCEPTIONS
15:21:31 765  BAD_LICENSE_ID EXCEPTION;
15:21:31 766  BEGIN
15:21:31 767  
15:21:31 768  	BEGIN
15:21:31 769  	  SELECT
15:21:31 770  	    l.id into temp_license_id
15:21:31 771  	  FROM
15:21:31 772  	    license l
15:21:31 773  	  WHERE
15:21:31 774  	    l.id = in_license_id;
15:21:31 775  	  EXCEPTION
15:21:31 776  	    WHEN NO_DATA_FOUND THEN
15:21:31 777  	      RAISE BAD_LICENSE_ID;
15:21:31 778  	END;
15:21:31 779  
15:21:31 780  	OPEN out_result_set FOR
15:21:31 781  	SELECT
15:21:31 782  	  l.id,
15:21:31 783  	  l.license_status_id,
15:21:31 784  	  l.subscription_id,
15:21:31 785  	  l.invoice_id,
15:21:31 786  	  l.offer_id,
15:21:31 787  	  l.start_date,
15:21:31 788  	  l.end_date,
15:21:31 789  	  l.entitlement_end_date,
15:21:31 790  	  l.is_extension,
15:21:31 791  	  l.create_date,
15:21:31 792  	  l.created_by,
15:21:31 793  	  l.update_date,
15:21:31 794  	  l.updated_by,
15:21:31 795  	  l.current_offer_index,
15:21:31 796  	  l.current_offer_recurr_num,
15:21:31 797  	  l.needs_entitlements
15:21:31 798  	FROM
15:21:31 799  	  LICENSE l
15:21:31 800  	WHERE
15:21:31 801  	  l.id = in_license_id;
15:21:31 802  
15:21:31 803  EXCEPTION
15:21:31 804  WHEN BAD_LICENSE_ID THEN
15:21:31 805  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:31 806  	  SPROC_NAME, 'No such license');
15:21:31 807  WHEN OTHERS THEN
15:21:31 808  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 809  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 810  END GET_LICENSE_BY_ID;
15:21:31 811  
15:21:31 812  PROCEDURE UP_LATEST_LICE_END_BY_SUBID (
15:21:31 813  	in_subscription_id IN NUMBER,
15:21:31 814  	in_end_date IN DATE,
15:21:31 815  	in_updated_by IN VARCHAR2
15:21:31 816  ) AS
15:21:31 817  SPROC_NAME CONSTANT VARCHAR2(32) := 'UP_LATEST_LICE_END_BY_SUBID';
15:21:31 818  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:31 819  var_latest_lice NUMBER;
15:21:31 820  BEGIN
15:21:31 821  	SELECT max(id)
15:21:31 822  	INTO  var_latest_lice
15:21:31 823  	FROM LICENSE
15:21:31 824  	WHERE
15:21:31 825  	  subscription_id = in_subscription_id
15:21:31 826  	;
15:21:31 827  
15:21:31 828  	PROCS_LICENSE_CRU_V18.UPDATE_LICENSE(
15:21:31 829  	  in_license_id        => var_latest_lice,
15:21:31 830  	  in_updated_by        => in_updated_by,
15:21:31 831  	  in_needs_entitlements => GLOBAL_CONSTANTS_V18.TRUE,
15:21:31 832  	  in_end_date	       => in_end_date,
15:21:31 833  	  in_entitlement_end_date => in_end_date
15:21:31 834  	);
15:21:31 835  
15:21:31 836  EXCEPTION
15:21:31 837  WHEN NO_DATA_FOUND THEN
15:21:31 838  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 839  	  SPROC_NAME, 'No licenses from subscription', SQLERRM);
15:21:31 840  WHEN OTHERS THEN
15:21:31 841  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:31 842  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:31 843  END UP_LATEST_LICE_END_BY_SUBID;
15:21:31 844  
15:21:31 845  PROCEDURE GET_GRACE_LICE_FOR_FINAL_TRANS (
15:21:31 846  	in_days_before_close	 IN NUMBER,
15:21:31 847  	in_num_licenses_to_fetch IN NUMBER,
15:21:31 848  	out_result_set		 OUT SYS_REFCURSOR
15:21:31 849  ) AS
15:21:31 850  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GRACE_LICE_FOR_FINAL_TRANS';
15:21:31 851  BEGIN
15:21:31 852  	OPEN out_result_set FOR
15:21:31 853  	SELECT
15:21:31 854  	    *
15:21:31 855  	FROM
15:21:31 856  	    (
15:21:31 857  		SELECT
15:21:31 858  		    l.id
15:21:31 859  		FROM
15:21:31 860  		    license l
15:21:31 861  		JOIN
15:21:31 862  		    invoice i
15:21:31 863  		ON
15:21:31 864  		    l.invoice_id = i.id
15:21:31 865  		WHERE
15:21:31 866  		    i.invoice_status_id = GLOBAL_STATUSES_V18.INVOICE_OPEN
15:21:31 867  		AND l.license_status_id = GLOBAL_STATUSES_V18.LICENSE_IN_GRACE_PERIOD
15:21:31 868  		AND SYSDATE + in_days_before_close >= l.grace_end_date
15:21:31 869  		AND NOT EXISTS
15:21:31 870  		    (
15:21:31 871  			SELECT
15:21:31 872  			    1
15:21:31 873  			FROM
15:21:31 874  			    charge c
15:21:31 875  			WHERE
15:21:31 876  			    c.invoice_id = i.id
15:21:31 877  			AND c.charge_status_id = GLOBAL_STATUSES_V18.CHARGE_OPENED)
15:21:31 878  		AND rownum <= in_num_licenses_to_fetch * 10
15:21:31 879  		ORDER BY
15:21:31 880  		    dbms_random.value)
15:21:31 881  	WHERE
15:21:31 882  	    rownum <= in_num_licenses_to_fetch;
15:21:31 883  END GET_GRACE_LICE_FOR_FINAL_TRANS;
15:21:31 884  
15:21:31 885  END PROCS_LICENSE_V18;
15:21:31 886  .
15:21:31 SQL> /

Package body created.

Elapsed: 00:00:00.06
15:21:32 SQL> 
15:21:32 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_CHARGE_V18" AS
15:21:32   2  
15:21:32   3  PROCEDURE CREATE_CHARGE(
15:21:32   4  /*
15:21:32   5  Throws exceptions:
15:21:32   6  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32   7  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32   8  */
15:21:32   9  	in_invoice_id	      IN NUMBER,
15:21:32  10  	in_transaction_id     IN NUMBER,
15:21:32  11  	in_instrument_type_id IN NUMBER,
15:21:32  12  	in_instrument_id      IN NUMBER,
15:21:32  13  	in_charge_amount      IN NUMBER,
15:21:32  14  	in_created_by	      IN VARCHAR2,
15:21:32  15  	in_charge_status_id   IN NUMBER,
15:21:32  16  	out_charge_id	      OUT NUMBER
15:21:32  17  ) AS
15:21:32  18  PROCS_NAME	  CONSTANT VARCHAR2(13) := 'CREATE_CHARGE';
15:21:32  19  -- VARIABLES
15:21:32  20  temp_invoice_id	  NUMBER;
15:21:32  21  temp_transaction_id NUMBER;
15:21:32  22  var_new_charge_id   NUMBER;
15:21:32  23  -- EXCEPTIONS
15:21:32  24  BAD_INVOICE_ID	     EXCEPTION;
15:21:32  25  BAD_TRANSACTION_ID     EXCEPTION;
15:21:32  26  BAD_PAYPAL_ID	     EXCEPTION;
15:21:32  27  BAD_CREDIT_CARD_ID     EXCEPTION;
15:21:32  28  BAD_INSTRUMENT_TYPE    EXCEPTION;
15:21:32  29  BAD_CHARGE_STATUS_ID   EXCEPTION;
15:21:32  30  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:32  31  BEGIN
15:21:32  32  	-- Check that incoming data is correct
15:21:32  33  	IF in_instrument_type_id != GLOBAL_ENUMS_V18.INSTRUMENT_CREDIT_CARD
15:21:32  34  	  AND in_instrument_type_id != GLOBAL_ENUMS_V18.INSTRUMENT_PAYPAL THEN
15:21:32  35  	  RAISE BAD_INSTRUMENT_TYPE;
15:21:32  36  	END IF;
15:21:32  37  
15:21:32  38  	-- Check that status is correct
15:21:32  39  	IF in_charge_status_id != GLOBAL_STATUSES_V18.CHARGE_OPENED
15:21:32  40  	  AND in_charge_status_id != GLOBAL_STATUSES_V18.CHARGE_PROCESSED
15:21:32  41  	  AND in_charge_status_id != GLOBAL_STATUSES_V18.CHARGE_CANCELED THEN
15:21:32  42  	  RAISE BAD_CHARGE_STATUS_ID;
15:21:32  43  	END IF;
15:21:32  44  
15:21:32  45  	-- Check that invoice exists
15:21:32  46  	BEGIN
15:21:32  47  	  SELECT
15:21:32  48  	    INVOICE.ID into temp_invoice_id
15:21:32  49  	  FROM
15:21:32  50  	    INVOICE
15:21:32  51  	  WHERE
15:21:32  52  	    INVOICE.ID = in_invoice_id;
15:21:32  53  	  EXCEPTION
15:21:32  54  	    WHEN NO_DATA_FOUND THEN
15:21:32  55  	      RAISE BAD_INVOICE_ID;
15:21:32  56  	END;
15:21:32  57  
15:21:32  58  	-- Check that transaction exists
15:21:32  59  	BEGIN
15:21:32  60  	  SELECT
15:21:32  61  	    TRANSACTION.ID into temp_transaction_id
15:21:32  62  	  FROM
15:21:32  63  	    TRANSACTION
15:21:32  64  	  WHERE
15:21:32  65  	    TRANSACTION.ID = in_transaction_id;
15:21:32  66  	  EXCEPTION
15:21:32  67  	    WHEN NO_DATA_FOUND THEN
15:21:32  68  	      RAISE BAD_TRANSACTION_ID;
15:21:32  69  	END;
15:21:32  70  
15:21:32  71  	-- Check that instrument exists
15:21:32  72  	IF in_instrument_type_id = GLOBAL_ENUMS_V18.INSTRUMENT_CREDIT_CARD THEN
15:21:32  73  	  IF PROCS_FIN_INSTRUMENTS_V18.IS_CREDIT_CARD_EXISTS(in_instrument_id) = GLOBAL_CONSTANTS_V18.FALSE THEN
15:21:32  74  	    RAISE BAD_CREDIT_CARD_ID;
15:21:32  75  	  END IF;
15:21:32  76  	ELSIF in_instrument_type_id = GLOBAL_ENUMS_V18.INSTRUMENT_PAYPAL THEN
15:21:32  77  	  IF PROCS_FIN_INSTRUMENTS_V18.IS_PAYPAL_EXISTS(in_instrument_id) = GLOBAL_CONSTANTS_V18.FALSE THEN
15:21:32  78  	    RAISE BAD_PAYPAL_ID;
15:21:32  79  	  END IF;
15:21:32  80  	END IF;
15:21:32  81  
15:21:32  82  	-- Create new charge
15:21:32  83  	PROCS_CHARGE_CRU_V18.CREATE_CHARGE(
15:21:32  84  	  out_charge_id 	=> var_new_charge_id,
15:21:32  85  	  in_invoice_id 	=> in_invoice_id,
15:21:32  86  	  in_transaction_id	=> in_transaction_id,
15:21:32  87  	  in_instrument_type_id => in_instrument_type_id,
15:21:32  88  	  in_instrument_id	=> in_instrument_id,
15:21:32  89  	  in_charge_amount	=> in_charge_amount,
15:21:32  90  	  in_charge_status_id	=> in_charge_status_id,
15:21:32  91  	  in_created_by 	=> in_created_by
15:21:32  92  	);
15:21:32  93  
15:21:32  94  	out_charge_id := var_new_charge_id;
15:21:32  95  
15:21:32  96  EXCEPTION
15:21:32  97  WHEN BAD_CHARGE_STATUS_ID THEN
15:21:32  98  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32  99  	  PROCS_NAME, 'Bad charge status: '||in_charge_status_id);
15:21:32 100  WHEN BAD_INSTRUMENT_TYPE THEN
15:21:32 101  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 102  	  PROCS_NAME, 'Bad instrument type id');
15:21:32 103  WHEN BAD_INVOICE_ID THEN
15:21:32 104  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 105  	  PROCS_NAME, 'No such invoice');
15:21:32 106  WHEN BAD_TRANSACTION_ID THEN
15:21:32 107  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 108  	  PROCS_NAME, 'No such transaction');
15:21:32 109  WHEN BAD_PAYPAL_ID THEN
15:21:32 110  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 111  	  PROCS_NAME, 'No such paypal');
15:21:32 112  WHEN BAD_CREDIT_CARD_ID THEN
15:21:32 113  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 114  	  PROCS_NAME, 'No such credit card');
15:21:32 115  WHEN OTHERS THEN
15:21:32 116  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 117  	  PROCS_NAME, 'Unknown error', SQLERRM);
15:21:32 118  END CREATE_CHARGE;
15:21:32 119  
15:21:32 120  /********************************************************/
15:21:32 121  -- norlov #38562 :
15:21:32 122  PROCEDURE GET_PENDING_REFUND_CHARGES (
15:21:32 123  /*
15:21:32 124  Throws exceptions:
15:21:32 125  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 126  */
15:21:32 127  	out_result_set	    OUT SYS_REFCURSOR,
15:21:32 128  	in_row_number	    IN NUMBER DEFAULT NULL
15:21:32 129  ) AS
15:21:32 130  SPROC_NAME CONSTANT VARCHAR2(26) := 'GET_PENDING_REFUND_CHARGES';
15:21:32 131  -- COMSTANTS
15:21:32 132  DEFAULT_ROW_NUMBER CONSTANT NUMBER := 1;
15:21:32 133  -- VARIABLES
15:21:32 134  var_row_number NUMBER;
15:21:32 135  BEGIN
15:21:32 136  	IF in_row_number IS NULL THEN
15:21:32 137  	  var_row_number := DEFAULT_ROW_NUMBER;
15:21:32 138  	ELSE
15:21:32 139  	  var_row_number := in_row_number;
15:21:32 140  	END IF;
15:21:32 141  
15:21:32 142  	-- Select charges
15:21:32 143  	OPEN out_result_set FOR
15:21:32 144  SELECT * FROM
15:21:32 145  (
15:21:32 146  	SELECT
15:21:32 147  	  CHARGE.ID,
15:21:32 148  	  CHARGE.TRANSACTION_ID,
15:21:32 149  	  CHARGE.INSTRUMENT_ID,
15:21:32 150  	  CHARGE.INSTRUMENT_TYPE_ID,
15:21:32 151  	  CHARGE.CHARGE_AMOUNT,
15:21:32 152  	  CHARGE.CREATE_DATE,
15:21:32 153  	  CHARGE.CREATED_BY,
15:21:32 154  	  CHARGE.INVOICE_ID
15:21:32 155  	FROM
15:21:32 156  	  CHARGE
15:21:32 157  	  INNER JOIN TRANSACTION ON CHARGE.TRANSACTION_ID = TRANSACTION.ID
15:21:32 158  	WHERE
15:21:32 159  	  TRANSACTION.TRANSACTION_STATUS_ID = GLOBAL_STATUSES_V18.TRANSACTION_PENDING
15:21:32 160  	  AND TRANSACTION.IS_REFUND = GLOBAL_CONSTANTS_V18.TRUE
15:21:32 161  	  AND TRANSACTION.TRANSACTION_AMOUNT < 0
15:21:32 162  	  AND NOT EXISTS
15:21:32 163  	  (
15:21:32 164  	    SELECT NULL
15:21:32 165  	    FROM PROCESS_RETRY_THROTTLE
15:21:32 166  	    WHERE PROCESS_NAME = SPROC_NAME
15:21:32 167  	      AND GENERIC_ID = CHARGE.ID
15:21:32 168  	  )
15:21:32 169  	  AND ROWNUM <= var_row_number*10
15:21:32 170  	  ORDER BY dbms_random.value
15:21:32 171  ) WHERE
15:21:32 172  	  ROWNUM <= var_row_number;
15:21:32 173  
15:21:32 174  END GET_PENDING_REFUND_CHARGES;
15:21:32 175  /******************************************************************************/
15:21:32 176  
15:21:32 177  PROCEDURE GET_UNPROCESSED_CHARGES (
15:21:32 178  /*
15:21:32 179  Throws exceptions:
15:21:32 180  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 181  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 182  */
15:21:32 183  	in_invoice_id  IN NUMBER,
15:21:32 184  	out_result_set OUT SYS_REFCURSOR
15:21:32 185  ) AS
15:21:32 186  SPROC_NAME      CONSTANT VARCHAR2(24) := 'GET_UNPROCESSED_CHARGES';
15:21:32 187  -- VARIABLES
15:21:32 188  temp_invoice_id NUMBER;
15:21:32 189  -- EXCEPTIONS
15:21:32 190  BAD_INVOICE_ID EXCEPTION;
15:21:32 191  BEGIN
15:21:32 192  
15:21:32 193  	-- Check that invoice exists
15:21:32 194  	BEGIN
15:21:32 195  	  SELECT
15:21:32 196  	    INVOICE.ID into temp_invoice_id
15:21:32 197  	  FROM
15:21:32 198  	    INVOICE
15:21:32 199  	  WHERE
15:21:32 200  	    INVOICE.ID = in_invoice_id;
15:21:32 201  	  EXCEPTION
15:21:32 202  	    WHEN NO_DATA_FOUND THEN
15:21:32 203  	      RAISE BAD_INVOICE_ID;
15:21:32 204  	END;
15:21:32 205  
15:21:32 206  	-- Select charges
15:21:32 207  	OPEN out_result_set FOR
15:21:32 208  	SELECT
15:21:32 209  	  CHARGE.ID,
15:21:32 210  	  CHARGE.TRANSACTION_ID,
15:21:32 211  	  CHARGE.INSTRUMENT_ID,
15:21:32 212  	  CHARGE.INSTRUMENT_TYPE_ID,
15:21:32 213  	  CHARGE.CHARGE_AMOUNT,
15:21:32 214  	  CHARGE.CREATE_DATE,
15:21:32 215  	  CHARGE.CREATED_BY,
15:21:32 216  	  CHARGE.INVOICE_ID
15:21:32 217  	FROM
15:21:32 218  	  CHARGE
15:21:32 219  	  INNER JOIN TRANSACTION ON CHARGE.TRANSACTION_ID = TRANSACTION.ID
15:21:32 220  	WHERE
15:21:32 221  	  CHARGE.INVOICE_ID = in_invoice_id
15:21:32 222  	  AND CHARGE.CHARGE_STATUS_ID = GLOBAL_STATUSES_V18.CHARGE_OPENED
15:21:32 223  	  AND
15:21:32 224  	    TRANSACTION.TRANSACTION_STATUS_ID = GLOBAL_STATUSES_V18.TRANSACTION_PENDING;
15:21:32 225  
15:21:32 226  EXCEPTION
15:21:32 227  WHEN BAD_INVOICE_ID THEN
15:21:32 228  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 229  	  SPROC_NAME, 'No such invoice');
15:21:32 230  WHEN OTHERS THEN
15:21:32 231  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 232  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 233  END GET_UNPROCESSED_CHARGES;
15:21:32 234  
15:21:32 235  /******************************************************************************/
15:21:32 236  
15:21:32 237  PROCEDURE GET_PROCESSED_CHARGES (
15:21:32 238  /*
15:21:32 239  Throws exceptions:
15:21:32 240  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 241  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 242  */
15:21:32 243  	in_invoice_id  IN NUMBER,
15:21:32 244  	out_result_set OUT SYS_REFCURSOR
15:21:32 245  ) AS
15:21:32 246  SPROC_NAME      CONSTANT VARCHAR2(21) := 'GET_PROCESSED_CHARGES';
15:21:32 247  -- VARIABLES
15:21:32 248  temp_invoice_id NUMBER;
15:21:32 249  -- EXCEPTIONS
15:21:32 250  BAD_INVOICE_ID  EXCEPTION;
15:21:32 251  BEGIN
15:21:32 252  
15:21:32 253  	-- Check that invoice exists
15:21:32 254  	BEGIN
15:21:32 255  	  SELECT
15:21:32 256  	    INVOICE.ID into temp_invoice_id
15:21:32 257  	  FROM
15:21:32 258  	    INVOICE
15:21:32 259  	  WHERE
15:21:32 260  	    INVOICE.ID = in_invoice_id;
15:21:32 261  	  EXCEPTION
15:21:32 262  	    WHEN NO_DATA_FOUND THEN
15:21:32 263  	      RAISE BAD_INVOICE_ID;
15:21:32 264  	END;
15:21:32 265  
15:21:32 266  	-- Select charges
15:21:32 267  	OPEN out_result_set FOR
15:21:32 268  	SELECT /*+ STAR_TRANSFORMATION */
15:21:32 269  	  CHARGE.ID,
15:21:32 270  	  CHARGE.TRANSACTION_ID,
15:21:32 271  	  CHARGE.INSTRUMENT_ID,
15:21:32 272  	  CHARGE.INSTRUMENT_TYPE_ID,
15:21:32 273  	  CHARGE.CHARGE_AMOUNT,
15:21:32 274  	  CHARGE.CREATE_DATE,
15:21:32 275  	  CHARGE.CREATED_BY,
15:21:32 276  	  CHARGE.INVOICE_ID
15:21:32 277  	FROM
15:21:32 278  	  CHARGE
15:21:32 279  	  INNER JOIN TRANSACTION ON CHARGE.TRANSACTION_ID = TRANSACTION.ID
15:21:32 280  	WHERE
15:21:32 281  	  CHARGE.INVOICE_ID = in_invoice_id
15:21:32 282  	  AND CHARGE.CHARGE_STATUS_ID = GLOBAL_STATUSES_V18.CHARGE_PROCESSED
15:21:32 283  	  AND TRANSACTION.TRANSACTION_STATUS_ID = GLOBAL_STATUSES_V18.TRANSACTION_CLOSED;
15:21:32 284  
15:21:32 285  EXCEPTION
15:21:32 286  WHEN BAD_INVOICE_ID THEN
15:21:32 287  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 288  	  SPROC_NAME, 'No such invoice');
15:21:32 289  WHEN OTHERS THEN
15:21:32 290  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 291  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 292  END GET_PROCESSED_CHARGES;
15:21:32 293  
15:21:32 294  /******************************************************************************/
15:21:32 295  
15:21:32 296  PROCEDURE GET_SUBSCR_ID_BY_CHARGE_ID (
15:21:32 297  /*
15:21:32 298  Throws exceptions:
15:21:32 299  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 300  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 301  */
15:21:32 302  	in_charge_id	    IN NUMBER,
15:21:32 303  	out_subscription_id OUT NUMBER
15:21:32 304  ) AS
15:21:32 305  SPROC_NAME	  CONSTANT VARCHAR2(26) := 'GET_SUBSCR_ID_BY_CHARGE_ID';
15:21:32 306  -- VARIABLES
15:21:32 307  var_invoice_id	  NUMBER;
15:21:32 308  var_subscription_id NUMBER;
15:21:32 309  -- EXCEPTIONS
15:21:32 310  BAD_CHARGE_ID		EXCEPTION;
15:21:32 311  CAN_NOT_FIND_SUBSCRIPTION EXCEPTION;
15:21:32 312  BEGIN
15:21:32 313  
15:21:32 314  	BEGIN
15:21:32 315  	  SELECT
15:21:32 316  	    CHARGE.INVOICE_ID into var_invoice_id
15:21:32 317  	  FROM
15:21:32 318  	    CHARGE
15:21:32 319  	  WHERE
15:21:32 320  	    CHARGE.ID = in_charge_id;
15:21:32 321  	  EXCEPTION
15:21:32 322  	    WHEN NO_DATA_FOUND THEN
15:21:32 323  	      RAISE BAD_CHARGE_ID;
15:21:32 324  	END;
15:21:32 325  
15:21:32 326  	BEGIN
15:21:32 327  	  SELECT
15:21:32 328  	    LICENSE.SUBSCRIPTION_ID into var_subscription_id
15:21:32 329  	  FROM
15:21:32 330  	    LICENSE
15:21:32 331  	  WHERE
15:21:32 332  	    LICENSE.INVOICE_ID = var_invoice_id
15:21:32 333  	    AND ROWNUM <= 1; -- That's because many licenses could be pointed to the same invoice
15:21:32 334  	  EXCEPTION
15:21:32 335  	    WHEN NO_DATA_FOUND THEN
15:21:32 336  	      RAISE CAN_NOT_FIND_SUBSCRIPTION;
15:21:32 337  	END;
15:21:32 338  
15:21:32 339  	out_subscription_id := var_subscription_id;
15:21:32 340  
15:21:32 341  EXCEPTION
15:21:32 342  WHEN BAD_CHARGE_ID THEN
15:21:32 343  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 344  	  SPROC_NAME, 'No such charge');
15:21:32 345  WHEN CAN_NOT_FIND_SUBSCRIPTION THEN
15:21:32 346  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 347  	  SPROC_NAME, 'Could not find subscription for given charge');
15:21:32 348  WHEN OTHERS THEN
15:21:32 349  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 350  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 351  END GET_SUBSCR_ID_BY_CHARGE_ID;
15:21:32 352  
15:21:32 353  /******************************************************************************/
15:21:32 354  
15:21:32 355  PROCEDURE UPDATE_CHARGE_STATUS (
15:21:32 356  /*
15:21:32 357  Throws exceptions:
15:21:32 358  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 359  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 360  */
15:21:32 361  	in_charge_id	    IN CHARGE.ID%TYPE,
15:21:32 362  	in_charge_status_id IN CHARGE.CHARGE_STATUS_ID%TYPE,
15:21:32 363  	in_updated_by	    IN CHARGE.UPDATED_BY%TYPE
15:21:32 364  ) AS
15:21:32 365  SPROC_NAME CONSTANT VARCHAR2(20) := 'UPDATE_CHARGE_STATUS';
15:21:32 366  -- EXCEPTIONS
15:21:32 367  BAD_CHARGE_ID	     EXCEPTION;
15:21:32 368  BAD_STATUS_ID	     EXCEPTION;
15:21:32 369  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:32 370  BEGIN
15:21:32 371  
15:21:32 372  	IF in_charge_status_id != GLOBAL_STATUSES_V18.CHARGE_OPENED
15:21:32 373  	  AND in_charge_status_id != GLOBAL_STATUSES_V18.CHARGE_PROCESSED
15:21:32 374  	  AND in_charge_status_id != GLOBAL_STATUSES_V18.CHARGE_CANCELED THEN
15:21:32 375  	  RAISE BAD_STATUS_ID;
15:21:32 376  	END IF;
15:21:32 377  
15:21:32 378  	PROCS_CHARGE_CRU_V18.UPDATE_CHARGE(
15:21:32 379  	  in_charge_id	      => in_charge_id,
15:21:32 380  	  in_charge_status_id => in_charge_status_id,
15:21:32 381  	  in_updated_by       => in_updated_by
15:21:32 382  	);
15:21:32 383  
15:21:32 384  	IF SQL%ROWCOUNT = 0 THEN
15:21:32 385  	  RAISE BAD_CHARGE_ID;
15:21:32 386  	END IF;
15:21:32 387  
15:21:32 388  EXCEPTION
15:21:32 389  WHEN BAD_CHARGE_ID THEN
15:21:32 390  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 391  	  SPROC_NAME, 'No such charge');
15:21:32 392  WHEN BAD_STATUS_ID THEN
15:21:32 393  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 394  	  SPROC_NAME, 'Bad status id');
15:21:32 395  WHEN OTHERS THEN
15:21:32 396  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 397  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 398  END UPDATE_CHARGE_STATUS;
15:21:32 399  
15:21:32 400  FUNCTION IS_CHARGE_COLLECTED (
15:21:32 401  /*
15:21:32 402  Throws:
15:21:32 403  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 404  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 405  Returns:
15:21:32 406  GLOBAL_CONST.TRUE if transaction collected,
15:21:32 407  GLOBAL_CONST.FALSE else
15:21:32 408  */
15:21:32 409  	in_charge_id IN NUMBER
15:21:32 410  ) RETURN NUMBER AS
15:21:32 411  SPROC_NAME CONSTANT VARCHAR2(19) := 'IS_CHARGE_COLLECTED';
15:21:32 412  -- VARIABLES
15:21:32 413  var_transaction_id NUMBER;
15:21:32 414  is_transaction_collected NUMBER;
15:21:32 415  -- EXCEPTIONS
15:21:32 416  BAD_CHARGE_ID	       EXCEPTION;
15:21:32 417  CAN_NOT_CHECK_TRANSACTION EXCEPTION;
15:21:32 418  EXCEPTION_MESSAGE        VARCHAR2(1024);
15:21:32 419  BEGIN
15:21:32 420  
15:21:32 421  	BEGIN
15:21:32 422  	  SELECT
15:21:32 423  	    CHARGE.TRANSACTION_ID into var_transaction_id
15:21:32 424  	  FROM
15:21:32 425  	    CHARGE
15:21:32 426  	  WHERE
15:21:32 427  	    CHARGE.ID = in_charge_id;
15:21:32 428  	  EXCEPTION
15:21:32 429  	    WHEN NO_DATA_FOUND THEN
15:21:32 430  	      RAISE BAD_CHARGE_ID;
15:21:32 431  	END;
15:21:32 432  
15:21:32 433  	BEGIN
15:21:32 434  	  is_transaction_collected := PROCS_TRANSACTION_V18.IS_TRANSACTION_COLLECTED(var_transaction_id);
15:21:32 435  	  EXCEPTION
15:21:32 436  	    WHEN OTHERS THEN
15:21:32 437  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:32 438  	      RAISE CAN_NOT_CHECK_TRANSACTION;
15:21:32 439  	END;
15:21:32 440  
15:21:32 441  	RETURN is_transaction_collected;
15:21:32 442  
15:21:32 443  EXCEPTION
15:21:32 444  WHEN BAD_CHARGE_ID THEN
15:21:32 445  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 446  	  SPROC_NAME, 'No such charge');
15:21:32 447  WHEN CAN_NOT_CHECK_TRANSACTION THEN
15:21:32 448  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 449  	  SPROC_NAME, 'Could not check if transaction was collected', EXCEPTION_MESSAGE);
15:21:32 450  WHEN OTHERS THEN
15:21:32 451  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 452  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 453  END;
15:21:32 454  
15:21:32 455  PROCEDURE GET_COLLECTED_CHARGES (
15:21:32 456  /*
15:21:32 457  Throws exceptions:
15:21:32 458  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 459  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 460  */
15:21:32 461  	in_invoice_id  IN NUMBER,
15:21:32 462  	out_result_set OUT SYS_REFCURSOR
15:21:32 463  ) AS
15:21:32 464  SPROC_NAME      CONSTANT VARCHAR2(21) := 'GET_COLLECTED_CHARGES';
15:21:32 465  -- VARIABLES
15:21:32 466  temp_invoice_id NUMBER;
15:21:32 467  -- EXCEPTIONS
15:21:32 468  BAD_INVOICE_ID  EXCEPTION;
15:21:32 469  BEGIN
15:21:32 470  
15:21:32 471  	-- Check that invoice exists
15:21:32 472  	BEGIN
15:21:32 473  	  SELECT
15:21:32 474  	    INVOICE.ID into temp_invoice_id
15:21:32 475  	  FROM
15:21:32 476  	    INVOICE
15:21:32 477  	  WHERE
15:21:32 478  	    INVOICE.ID = in_invoice_id;
15:21:32 479  	  EXCEPTION
15:21:32 480  	    WHEN NO_DATA_FOUND THEN
15:21:32 481  	      RAISE BAD_INVOICE_ID;
15:21:32 482  	END;
15:21:32 483  
15:21:32 484  	-- Select charges
15:21:32 485  	OPEN out_result_set FOR
15:21:32 486  	SELECT
15:21:32 487  	  CHARGE.ID,
15:21:32 488  	  CHARGE.TRANSACTION_ID,
15:21:32 489  	  CHARGE.INSTRUMENT_ID,
15:21:32 490  	  CHARGE.INSTRUMENT_TYPE_ID,
15:21:32 491  	  CHARGE.CHARGE_AMOUNT,
15:21:32 492  	  CHARGE.CREATE_DATE,
15:21:32 493  	  CHARGE.CREATED_BY,
15:21:32 494  	  CHARGE.INVOICE_ID
15:21:32 495  	FROM
15:21:32 496  	  CHARGE
15:21:32 497  	  INNER JOIN TRANSACTION ON CHARGE.TRANSACTION_ID = TRANSACTION.ID
15:21:32 498  	WHERE
15:21:32 499  	  CHARGE.INVOICE_ID = in_invoice_id
15:21:32 500  	  AND CHARGE.CHARGE_STATUS_ID IN (SELECT GLOBAL_STATUSES_V18.CHARGE_PROCESSED FROM DUAL)
15:21:32 501  	  AND PROCS_CHARGE_V18.IS_CHARGE_COLLECTED(CHARGE.ID) = GLOBAL_CONSTANTS_V18.TRUE;
15:21:32 502  
15:21:32 503  EXCEPTION
15:21:32 504  WHEN BAD_INVOICE_ID THEN
15:21:32 505  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 506  	  SPROC_NAME, 'No such invoice');
15:21:32 507  WHEN OTHERS THEN
15:21:32 508  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 509  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 510  END GET_COLLECTED_CHARGES;
15:21:32 511  
15:21:32 512  END PROCS_CHARGE_V18;
15:21:32 513  .
15:21:32 SQL> /

Package body created.

Elapsed: 00:00:00.04
15:21:32 SQL> 
15:21:32 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_SUBSCRIPTION_V18" AS
15:21:32   2  
15:21:32   3  PROCEDURE START_GRACE_BY_INVOICE_ID(
15:21:32   4  	in_invoice_id	     IN LICENSE.INVOICE_ID%TYPE,
15:21:32   5  	in_updater	     IN VARCHAR2,
15:21:32   6  	in_duration_in_hours IN NUMBER
15:21:32   7  ) AS
15:21:32   8  SPROC_NAME CONSTANT VARCHAR2(32) := 'START_GRACE_BY_INVOICE_ID';
15:21:32   9  var_subs_id	  SUBSCRIPTION.ID%TYPE;
15:21:32  10  var_lic_id	  LICENSE.ID%TYPE;
15:21:32  11  var_grace_start	  DATE;
15:21:32  12  var_grace_end	  DATE;
15:21:32  13  BEGIN
15:21:32  14  	SELECT
15:21:32  15  	  ID,
15:21:32  16  	  SUBSCRIPTION_ID,
15:21:32  17  	  START_DATE,
15:21:32  18  	  START_DATE + (in_duration_in_hours / 24)
15:21:32  19  	INTO var_lic_id, var_subs_id, var_grace_start, var_grace_end
15:21:32  20  	FROM
15:21:32  21  	  LICENSE
15:21:32  22  	WHERE
15:21:32  23  	  INVOICE_ID = in_invoice_id
15:21:32  24  	  AND ROWNUM <= 1;
15:21:32  25  
15:21:32  26  	PROCS_LICENSE_CRU_V18.UPDATE_LICENSE(
15:21:32  27  	    in_license_id	    => var_lic_id,
15:21:32  28  	    in_updated_by	    => in_updater,
15:21:32  29  	    in_grace_start_date     => var_grace_start,
15:21:32  30  	    in_grace_end_date	    => var_grace_end,
15:21:32  31  	    in_entitlement_end_date => var_grace_end,
15:21:32  32  	    in_license_status_id    => GLOBAL_STATUSES_V18.LICENSE_IN_GRACE_PERIOD
15:21:32  33  	);
15:21:32  34  
15:21:32  35  	PROCS_SUBSCRIPTION_CRU_V18.UPDATE_SUBSCRIPTION(
15:21:32  36  	    in_subscription_id	      => var_subs_id,
15:21:32  37  	    in_updated_by	      => in_updater,
15:21:32  38  	    in_subscription_status_id => GLOBAL_STATUSES_V18.SUBSCRIPTION_IN_GRACE_PERIOD
15:21:32  39  	  );
15:21:32  40  END START_GRACE_BY_INVOICE_ID;
15:21:32  41  
15:21:32  42  PROCEDURE STOP_GRACE_BY_INVOICE_ID(
15:21:32  43  	in_invoice_id IN LICENSE.INVOICE_ID%TYPE,
15:21:32  44  	in_updater    IN VARCHAR2
15:21:32  45  ) AS
15:21:32  46  SPROC_NAME CONSTANT VARCHAR2(32) := 'START_GRACE_BY_INVOICE_ID';
15:21:32  47  var_subs_id	  SUBSCRIPTION.ID%TYPE;
15:21:32  48  var_lic_id	  LICENSE.ID%TYPE;
15:21:32  49  var_lic_end_date	  DATE;
15:21:32  50  BEGIN
15:21:32  51  	SELECT
15:21:32  52  	  ID,
15:21:32  53  	  SUBSCRIPTION_ID,
15:21:32  54  	  END_DATE
15:21:32  55  	INTO var_lic_id, var_subs_id, var_lic_end_date
15:21:32  56  	FROM
15:21:32  57  	  LICENSE
15:21:32  58  	WHERE
15:21:32  59  	  INVOICE_ID = in_invoice_id
15:21:32  60  	  AND ROWNUM <= 1;
15:21:32  61  
15:21:32  62  	PROCS_LICENSE_CRU_V18.UPDATE_LICENSE(
15:21:32  63  	    in_license_id	    => var_lic_id,
15:21:32  64  	    in_updated_by	    => in_updater,
15:21:32  65  	    in_grace_end_date	    => SYSDATE,
15:21:32  66  	    in_entitlement_end_date => var_lic_end_date,
15:21:32  67  	    in_license_status_id    => GLOBAL_STATUSES_V18.LICENSE_ACTIVE
15:21:32  68  	);
15:21:32  69  
15:21:32  70  	PROCS_SUBSCRIPTION_CRU_V18.UPDATE_SUBSCRIPTION(
15:21:32  71  	    in_subscription_id	      => var_subs_id,
15:21:32  72  	    in_updated_by	      => in_updater,
15:21:32  73  	    in_subscription_status_id => GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE
15:21:32  74  	);
15:21:32  75  END STOP_GRACE_BY_INVOICE_ID;
15:21:32  76  
15:21:32  77  
15:21:32  78  PROCEDURE START_SUBSCRIPTION_CREATION (
15:21:32  79  	in_group_id	      IN NUMBER,
15:21:32  80  	in_created_by	      IN VARCHAR2,
15:21:32  81  	in_offer_chain_id     IN NUMBER,
15:21:32  82  	in_instrument_type_id IN NUMBER,
15:21:32  83  	in_instrument_id      IN NUMBER,
15:21:32  84  	in_agent_id	      IN NUMBER,
15:21:32  85  	in_note 	      IN VARCHAR2,
15:21:32  86  	out_subscription_id   OUT NUMBER,
15:21:32  87  	out_invoice_id	      OUT NUMBER,
15:21:32  88  	out_new_license_id    OUT NUMBER,
15:21:32  89  	in_check_dupe_products	 IN NUMBER DEFAULT GLOBAL_CONSTANTS_V18.TRUE
15:21:32  90  ) AS
15:21:32  91  SPROC_NAME CONSTANT VARCHAR2(27) := 'START_SUBSCRIPTION_CREATION';
15:21:32  92  -- VARIABLES
15:21:32  93  var_account_id		 NUMBER;
15:21:32  94  var_account_status	 NUMBER;
15:21:32  95  var_offer_chain_status_id  NUMBER;
15:21:32  96  var_is_gift_certificate	 NUMBER;
15:21:32  97  var_is_for_redemption	 NUMBER;
15:21:32  98  var_same_offer_chains_num  NUMBER;
15:21:32  99  var_max_concurrent_subscrs NUMBER;
15:21:32 100  var_first_offer_id	 NUMBER;
15:21:32 101  var_new_invoice_id	 NUMBER;
15:21:32 102  var_new_subscription_id	 NUMBER;
15:21:32 103  var_date			 DATE := SYSDATE;
15:21:32 104  var_account_tax_exempt_id  VARCHAR2(255);
15:21:32 105  var_concur_subscription_id NUMBER;
15:21:32 106  -- EXCEPTIONS
15:21:32 107  BAD_GROUP_ID		    EXCEPTION;
15:21:32 108  CAN_NOT_CREATE_FOR_DISABLE    EXCEPTION;
15:21:32 109  BAD_OFFER_CHAIN		    EXCEPTION;
15:21:32 110  BAD_OFFER_CHAIN_STATUS	    EXCEPTION;
15:21:32 111  CAN_NOT_SUBSCRIBE_TO_GC	    EXCEPTION;
15:21:32 112  CAN_NOT_SUBSCRIBE_TO_RGC	    EXCEPTION;
15:21:32 113  LIMIT_REACHED		    EXCEPTION;
15:21:32 114  PRODUCT_ALREADY_PURCHASED     EXCEPTION;
15:21:32 115  CAN_NOT_GET_FIRST_OFFER_CHAIN EXCEPTION;
15:21:32 116  CAN_NOT_CREATE_INVOICE	    EXCEPTION;
15:21:32 117  CAN_NOT_CREATE_LINE_ITEMS     EXCEPTION;
15:21:32 118  CAN_NOT_CREATE_LICENSE	    EXCEPTION;
15:21:32 119  CAN_NOT_CREATE_NOTE	    EXCEPTION;
15:21:32 120  
15:21:32 121  EXCEPTION_MESSAGE VARCHAR2(1024);
15:21:32 122  BEGIN
15:21:32 123  
15:21:32 124  	-- Get account id and status
15:21:32 125  	BEGIN
15:21:32 126  	  SELECT
15:21:32 127  	    ACCOUNT.ID,
15:21:32 128  	    ACCOUNT.ACCOUNT_STATUS_ID,
15:21:32 129  	    ACCOUNT.TAX_EXEMPT_ID
15:21:32 130  	    into
15:21:32 131  	    var_account_id,
15:21:32 132  	    var_account_status,
15:21:32 133  	    var_account_tax_exempt_id
15:21:32 134  	  FROM
15:21:32 135  	    ACCOUNT
15:21:32 136  	  WHERE
15:21:32 137  	    ACCOUNT.GROUP_ID = in_group_id;
15:21:32 138  	  EXCEPTION
15:21:32 139  	  WHEN NO_DATA_FOUND THEN
15:21:32 140  	    RAISE BAD_GROUP_ID;
15:21:32 141  	END;
15:21:32 142  
15:21:32 143  	-- Could not create subscription for disabled account
15:21:32 144  	IF var_account_status = GLOBAL_STATUSES_V18.ACCOUNT_DISABLED THEN
15:21:32 145  	  RAISE CAN_NOT_CREATE_FOR_DISABLE;
15:21:32 146  	END IF;
15:21:32 147  
15:21:32 148  	-- Get offer chain status
15:21:32 149  	BEGIN
15:21:32 150  	  SELECT
15:21:32 151  	    OFFER_CHAIN.OFFER_CHAIN_STATUS_ID,
15:21:32 152  	    OFFER_CHAIN.IS_GIFT_CERTIFICATE
15:21:32 153  	    into
15:21:32 154  	    var_offer_chain_status_id,
15:21:32 155  	    var_is_gift_certificate
15:21:32 156  	  FROM
15:21:32 157  	    OFFER_CHAIN
15:21:32 158  	  WHERE
15:21:32 159  	    OFFER_CHAIN.ID = in_offer_chain_id;
15:21:32 160  
15:21:32 161  	  EXCEPTION
15:21:32 162  	    WHEN NO_DATA_FOUND THEN
15:21:32 163  	      RAISE BAD_OFFER_CHAIN;
15:21:32 164  	END;
15:21:32 165  
15:21:32 166  	-- Could not subscribe to inactive/disabled offer chain
15:21:32 167  	IF var_offer_chain_status_id != GLOBAL_STATUSES_V18.OFFER_CHAIN_ACTIVE THEN
15:21:32 168  	  RAISE BAD_OFFER_CHAIN_STATUS;
15:21:32 169  	END IF;
15:21:32 170  
15:21:32 171  	-- Can not subscribe to Offer Chain for a Gift Certfiicate
15:21:32 172  	IF var_is_gift_certificate = GLOBAL_CONSTANTS_V18.TRUE THEN
15:21:32 173  	  RAISE CAN_NOT_SUBSCRIBE_TO_GC;
15:21:32 174  	END IF;
15:21:32 175  
15:21:32 176  	-- check if the OC is for Redemption:
15:21:32 177  	SELECT
15:21:32 178  	  COUNT(*) into var_is_for_redemption
15:21:32 179  	FROM
15:21:32 180  	  OFFER_CHAIN_ELIGIBILITY
15:21:32 181  	WHERE
15:21:32 182  	  OFFER_CHAIN_ELIGIBILITY.OFFER_CHAIN_ID = in_offer_chain_id
15:21:32 183  	  AND OFFER_CHAIN_ELIGIBILITY.NAME = GLOBAL_CONSTANTS_V18.GIFT_CERTIFICATE_REQUIRED
15:21:32 184  	  AND OFFER_CHAIN_ELIGIBILITY.VALUE = GLOBAL_CONSTANTS_V18.ELIGIBILITY_FLAG_SET;
15:21:32 185  
15:21:32 186  	IF var_is_for_redemption > 0 THEN
15:21:32 187  	  RAISE CAN_NOT_SUBSCRIBE_TO_RGC;
15:21:32 188  	END IF;
15:21:32 189  
15:21:32 190  	SELECT
15:21:32 191  	  COUNT(*) into var_same_offer_chains_num
15:21:32 192  	FROM
15:21:32 193  	  SUBSCRIPTION
15:21:32 194  	WHERE
15:21:32 195  	  SUBSCRIPTION.ACCOUNT_ID = var_account_id
15:21:32 196  	  AND SUBSCRIPTION.OFFER_CHAIN_ID = in_offer_chain_id
15:21:32 197  	  AND (SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE
15:21:32 198  	       OR SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_IN_GRACE_PERIOD);
15:21:32 199  
15:21:32 200  	-- ELIGIBILITY LOGIC CHANGED TO:
15:21:32 201  	-- FOR EACH offer chain eligibility rule in OC:
15:21:32 202  	--   IF offer chain eligibility rule fails:
15:21:32 203  	--     deny purchase;
15:21:32 204  	--   END IF
15:21:32 205  	-- END FOR
15:21:32 206  	-- FOR EACH product eligibility rule in OC:
15:21:32 207  	--   IF product eligibilty rule fails:
15:21:32 208  	--     deny purchase;
15:21:32 209  	--   END IF
15:21:32 210  	-- END FOR
15:21:32 211  	-- allow purchase;
15:21:32 212  
15:21:32 213  	-- if user have any active existing subscriptions to the offer chain
15:21:32 214  	-- and if MAX_CONCURRENT_SUBS <= [user's subscription count for the offer chain]
15:21:32 215  	-- then deny purchase
15:21:32 216  	var_max_concurrent_subscrs := PROCS_OFFER_CHAIN_V18.GET_OFFER_CHAIN_MAX_CONC_SUBSC(in_offer_chain_id);
15:21:32 217  	IF var_max_concurrent_subscrs != GLOBAL_CONSTANTS_V18.INFINITY
15:21:32 218  	  AND var_max_concurrent_subscrs <= var_same_offer_chains_num THEN
15:21:32 219  	  -- Find first concurrent subscription id:
15:21:32 220  	  SELECT
15:21:32 221  	    ID into var_concur_subscription_id
15:21:32 222  	  FROM (
15:21:32 223  	    SELECT
15:21:32 224  	      ID
15:21:32 225  	    FROM
15:21:32 226  	      SUBSCRIPTION
15:21:32 227  	    WHERE
15:21:32 228  	      SUBSCRIPTION.ACCOUNT_ID = var_account_id
15:21:32 229  	      AND SUBSCRIPTION.OFFER_CHAIN_ID = in_offer_chain_id
15:21:32 230  	      AND (SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE
15:21:32 231  		   OR SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_IN_GRACE_PERIOD)
15:21:32 232  	    ORDER BY
15:21:32 233  	      ID
15:21:32 234  	  )
15:21:32 235  	  WHERE
15:21:32 236  	    ROWNUM <= 1;
15:21:32 237  	  RAISE LIMIT_REACHED;
15:21:32 238  	END IF;
15:21:32 239  
15:21:32 240  	-- if user does not have any active existing subscriptions to the offer chain
15:21:32 241  	-- and if product from the offer chain is already owned from another offer chain
15:21:32 242  	-- then deny purchase
15:21:32 243  	IF (in_check_dupe_products != GLOBAL_CONSTANTS_V18.FALSE) THEN
15:21:32 244  	  FOR f_account_offer_chains IN (
15:21:32 245  	    SELECT DISTINCT
15:21:32 246  	      OFFER_CHAIN_ID
15:21:32 247  	    FROM
15:21:32 248  	      SUBSCRIPTION
15:21:32 249  	    WHERE
15:21:32 250  	      ACCOUNT_ID = var_account_id
15:21:32 251  	      AND (
15:21:32 252  		SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE
15:21:32 253  		OR SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_SUSPENDED
15:21:32 254  		OR SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_IN_GRACE_PERIOD)
15:21:32 255  	  )
15:21:32 256  	  LOOP
15:21:32 257  	    IF PROCS_OFFER_CHAIN_V18.CHECK_FOR_SAME_PRODUCTS(
15:21:32 258  	      in_offer_chain_1	       => in_offer_chain_id,
15:21:32 259  	      in_offer_chain_2	       => f_account_offer_chains.OFFER_CHAIN_ID,
15:21:32 260  	      in_use_eligibility_rules => GLOBAL_CONSTANTS_V18.TRUE
15:21:32 261  	    ) = GLOBAL_CONSTANTS_V18.TRUE THEN
15:21:32 262  
15:21:32 263  	      -- Find first concurrent subscription id:
15:21:32 264  	      SELECT
15:21:32 265  		ID into var_concur_subscription_id
15:21:32 266  	      FROM (
15:21:32 267  		SELECT
15:21:32 268  		  ID
15:21:32 269  		FROM
15:21:32 270  		  SUBSCRIPTION
15:21:32 271  		WHERE
15:21:32 272  		  SUBSCRIPTION.ACCOUNT_ID = var_account_id
15:21:32 273  		  AND SUBSCRIPTION.OFFER_CHAIN_ID = f_account_offer_chains.OFFER_CHAIN_ID
15:21:32 274  		  AND (
15:21:32 275  		    SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE
15:21:32 276  		    OR SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_SUSPENDED
15:21:32 277  		    OR SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_IN_GRACE_PERIOD)
15:21:32 278  		ORDER BY
15:21:32 279  		  ID
15:21:32 280  	      )
15:21:32 281  	      WHERE
15:21:32 282  		ROWNUM <= 1;
15:21:32 283  
15:21:32 284  	      RAISE PRODUCT_ALREADY_PURCHASED;
15:21:32 285  	    END IF;
15:21:32 286  	  END LOOP;
15:21:32 287  	END IF;
15:21:32 288  
15:21:32 289  	BEGIN
15:21:32 290  	  PROCS_OFFER_CHAIN_V18.GET_FIRST_OFFER(in_offer_chain_id, var_first_offer_id);
15:21:32 291  	  EXCEPTION
15:21:32 292  	    WHEN OTHERS THEN
15:21:32 293  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:32 294  	      RAISE CAN_NOT_GET_FIRST_OFFER_CHAIN;
15:21:32 295  	END;
15:21:32 296  
15:21:32 297  	BEGIN
15:21:32 298  	  PROCS_INVOICE_V18.CREATE_INVOICE(
15:21:32 299  	    in_invoice_status => GLOBAL_STATUSES_V18.INVOICE_OPEN,
15:21:32 300  	    in_created_by     => in_created_by,
15:21:32 301  	    in_tax_exempt_id  => var_account_tax_exempt_id,
15:21:32 302  	    out_invoice_id    => var_new_invoice_id
15:21:32 303  	  );
15:21:32 304  	  EXCEPTION
15:21:32 305  	    WHEN OTHERS THEN
15:21:32 306  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:32 307  	      RAISE CAN_NOT_CREATE_INVOICE;
15:21:32 308  	END;
15:21:32 309  
15:21:32 310  	BEGIN
15:21:32 311  	  PROCS_LINE_ITEMS_V18.ADD_LINE_ITEMS(
15:21:32 312  	    in_invoice_id => var_new_invoice_id,
15:21:32 313  	    in_offer_id   => var_first_offer_id,
15:21:32 314  	    in_created_by => in_created_by
15:21:32 315  	  );
15:21:32 316  	  EXCEPTION
15:21:32 317  	    WHEN OTHERS THEN
15:21:32 318  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:32 319  	      RAISE CAN_NOT_CREATE_LINE_ITEMS;
15:21:32 320  	END;
15:21:32 321  
15:21:32 322  	PROCS_SUBSCRIPTION_CRU_V18.CREATE_SUBSCRIPTION(
15:21:32 323  	  out_subscription_id	    => var_new_subscription_id,
15:21:32 324  	  in_account_id 	    => var_account_id,
15:21:32 325  	  in_purchase_date	    => var_date,
15:21:32 326  	  in_offer_chain_id	    => in_offer_chain_id,
15:21:32 327  	  in_created_by 	    => in_created_by,
15:21:32 328  	  in_instrument_type_id     => in_instrument_type_id,
15:21:32 329  	  in_instrument_id	    => in_instrument_id,
15:21:32 330  	  in_subscription_status_id => GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE
15:21:32 331  	);
15:21:32 332  
15:21:32 333  	BEGIN
15:21:32 334  	  PROCS_SUBSCRIPTION_V18.ANNOTATE_SUBSCRIPTION(
15:21:32 335  	    in_subscription_id => var_new_subscription_id,
15:21:32 336  	    in_agent_id        => in_agent_id,
15:21:32 337  	    in_note	       => in_note,
15:21:32 338  	    in_created_by      => in_created_by
15:21:32 339  	  );
15:21:32 340  	  EXCEPTION
15:21:32 341  	   WHEN OTHERS THEN
15:21:32 342  	     EXCEPTION_MESSAGE := SQLERRM;
15:21:32 343  	     RAISE CAN_NOT_CREATE_NOTE;
15:21:32 344  	END;
15:21:32 345  
15:21:32 346  	BEGIN
15:21:32 347  	  PROCS_LICENSE_V18.CREATE_LICENSE(
15:21:32 348  	    in_status_id		=> GLOBAL_STATUSES_V18.LICENSE_ACTIVE,
15:21:32 349  	    in_needs_entitlements	=> GLOBAL_CONSTANTS_V18.TRUE,
15:21:32 350  	    in_start_date		=> var_date,
15:21:32 351  	    in_end_date 		=> NULL, -- Will be calculated automatically
15:21:32 352  	    in_offer_id 		=> var_first_offer_id,
15:21:32 353  	    in_subscription_id		=> var_new_subscription_id,
15:21:32 354  	    in_invoice_id		=> var_new_invoice_id,
15:21:32 355  	    in_created_by		=> in_created_by,
15:21:32 356  	    in_is_extension		=> GLOBAL_CONSTANTS_V18.FALSE,
15:21:32 357  	    in_current_offer_index	=> PROCS_OFFER_CHAIN_V18.GET_FIRST_OFFER_INDEX(in_offer_chain_id),
15:21:32 358  	    in_current_offer_recurr_num => 1,
15:21:32 359  	    out_license_id		=> out_new_license_id
15:21:32 360  	  );
15:21:32 361  	  EXCEPTION
15:21:32 362  	    WHEN OTHERS THEN
15:21:32 363  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:32 364  	      RAISE CAN_NOT_CREATE_LICENSE;
15:21:32 365  	END;
15:21:32 366  
15:21:32 367  	out_subscription_id := var_new_subscription_id;
15:21:32 368  	out_invoice_id := var_new_invoice_id;
15:21:32 369  
15:21:32 370  EXCEPTION
15:21:32 371  WHEN BAD_OFFER_CHAIN_STATUS THEN
15:21:32 372  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 373  	  SPROC_NAME, 'Offer chain is not active');
15:21:32 374  WHEN LIMIT_REACHED THEN
15:21:32 375  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.CONFLICT_ERROR,
15:21:32 376  	  SPROC_NAME, 'Limit reached for given offer chain. Concurrent subscription id: ' || var_concur_subscription_id);
15:21:32 377  WHEN CAN_NOT_CREATE_FOR_DISABLE THEN
15:21:32 378  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 379  	  SPROC_NAME, 'Can not create subsscription for disabled account');
15:21:32 380  WHEN CAN_NOT_SUBSCRIBE_TO_GC THEN
15:21:32 381  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 382  	  SPROC_NAME, 'Can not subscribe to Offer Chain for Gift Certificate');
15:21:32 383  WHEN CAN_NOT_SUBSCRIBE_TO_RGC THEN
15:21:32 384  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 385  	  SPROC_NAME, 'Can not subscribe to Offer Chain that is for redemption');
15:21:32 386  WHEN BAD_OFFER_CHAIN THEN
15:21:32 387  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 388  	  SPROC_NAME, 'No such offer chain');
15:21:32 389  WHEN PRODUCT_ALREADY_PURCHASED THEN
15:21:32 390  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.CONFLICT_ERROR,
15:21:32 391  	  SPROC_NAME, 'User already subscribed to some product in given offer chain. Concurrent subscription id: ' || var_concur_subscription_id);
15:21:32 392  WHEN CAN_NOT_GET_FIRST_OFFER_CHAIN THEN
15:21:32 393  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 394  	  SPROC_NAME, 'Could not find first offer in offer chain', EXCEPTION_MESSAGE);
15:21:32 395  WHEN CAN_NOT_CREATE_INVOICE THEN
15:21:32 396  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 397  	  SPROC_NAME, 'Could not create invoice', EXCEPTION_MESSAGE);
15:21:32 398  WHEN CAN_NOT_CREATE_LINE_ITEMS THEN
15:21:32 399  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 400  	  SPROC_NAME, 'Could not create line items', EXCEPTION_MESSAGE);
15:21:32 401  WHEN CAN_NOT_CREATE_LICENSE THEN
15:21:32 402  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 403  	  SPROC_NAME, 'Could not create new license', EXCEPTION_MESSAGE);
15:21:32 404  WHEN BAD_GROUP_ID THEN
15:21:32 405  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 406  	  SPROC_NAME, 'Bad group id');
15:21:32 407  WHEN CAN_NOT_CREATE_NOTE THEN
15:21:32 408  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 409  	  SPROC_NAME, 'Could not annotate subscription', EXCEPTION_MESSAGE);
15:21:32 410  WHEN OTHERS THEN
15:21:32 411  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 412  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 413  END START_SUBSCRIPTION_CREATION;
15:21:32 414  
15:21:32 415  /******************************************************************************/
15:21:32 416  
15:21:32 417  PROCEDURE FINALIZE_SUBSCRIPTION_CREATION (
15:21:32 418  	in_subscription_id    IN NUMBER,
15:21:32 419  	in_invoice_id	      IN NUMBER,
15:21:32 420  	in_instrument_type_id IN NUMBER,
15:21:32 421  	in_instrument_id      IN NUMBER,
15:21:32 422  	in_created_by	      IN VARCHAR2
15:21:32 423  ) AS
15:21:32 424  SPROC_NAME CONSTANT VARCHAR2(30) := 'FINALIZE_SUBSCRIPTION_CREATION';
15:21:32 425  -- VARIABLES
15:21:32 426  var_invoice_amount     NUMBER(10, 2);
15:21:32 427  var_new_transaction_id NUMBER;
15:21:32 428  var_new_charge_id      NUMBER;
15:21:32 429  -- EXCEPTIONS
15:21:32 430  CAN_NOT_USE_FCINSTR	  EXCEPTION;
15:21:32 431  CAN_NOT_CALC_INVOICE_AMOUNT EXCEPTION;
15:21:32 432  CAN_NOT_CREATE_TRANSACTION  EXCEPTION;
15:21:32 433  CAN_NOT_CREATE_CHARGE	  EXCEPTION;
15:21:32 434  
15:21:32 435  EXCEPTION_MESSAGE VARCHAR2(1024);
15:21:32 436  BEGIN
15:21:32 437  
15:21:32 438  	-- Calculate invoice amount ( + discounts, taxes)
15:21:32 439  	BEGIN
15:21:32 440  	  PROCS_INVOICE_V18.CALCULATE_INVOICE_AMOUNT(
15:21:32 441  	    in_invoice_id => in_invoice_id,
15:21:32 442  	    out_amount	  => var_invoice_amount
15:21:32 443  	  );
15:21:32 444  	  EXCEPTION
15:21:32 445  	   WHEN OTHERS THEN
15:21:32 446  	     EXCEPTION_MESSAGE := SQLERRM;
15:21:32 447  	     RAISE CAN_NOT_CALC_INVOICE_AMOUNT;
15:21:32 448  	END;
15:21:32 449  
15:21:32 450  	IF in_instrument_type_id = GLOBAL_ENUMS_V18.INSTRUMENT_ZCI_INSTRUMENT
15:21:32 451  	  AND var_invoice_amount > 0 THEN
15:21:32 452  	  RAISE CAN_NOT_USE_FCINSTR;
15:21:32 453  	END IF;
15:21:32 454  
15:21:32 455  	IF var_invoice_amount = 0 THEN
15:21:32 456  	  -- UPDATE INVOICE. SET STATUS TO PROCESSED
15:21:32 457  	  PROCS_INVOICE_CRU_V18.UPDATE_INVOICE(
15:21:32 458  	    in_invoice_id		   => in_invoice_id,
15:21:32 459  	    in_updated_by		   => in_created_by,
15:21:32 460  	    in_invoice_status_id	   => GLOBAL_STATUSES_V18.INVOICE_CLOSED
15:21:32 461  	  );
15:21:32 462  	ELSE
15:21:32 463  	  -- Create transaction and charge
15:21:32 464  	  BEGIN
15:21:32 465  	    PROCS_TRANSACTION_V18.CREATE_TRANSACTION(
15:21:32 466  	      in_transaction_id 	=> NULL,
15:21:32 467  	      in_status_id		=> GLOBAL_STATUSES_V18.TRANSACTION_PENDING,
15:21:32 468  	      in_amount 		=> var_invoice_amount,
15:21:32 469  	      in_created_by		=> in_created_by,
15:21:32 470  	      in_order_id		=> NULL,
15:21:32 471  	      in_transaction_type_code	=> 'START_SUBSCRIPTION',
15:21:32 472  	      out_transaction_id	=> var_new_transaction_id
15:21:32 473  	    );
15:21:32 474  	    EXCEPTION
15:21:32 475  	      WHEN OTHERS THEN
15:21:32 476  		EXCEPTION_MESSAGE := SQLERRM;
15:21:32 477  		RAISE CAN_NOT_CREATE_TRANSACTION;
15:21:32 478  	  END;
15:21:32 479  
15:21:32 480  	  BEGIN
15:21:32 481  	    PROCS_CHARGE_V18.CREATE_CHARGE(
15:21:32 482  	      in_invoice_id	    => in_invoice_id,
15:21:32 483  	      in_transaction_id     => var_new_transaction_id,
15:21:32 484  	      in_instrument_type_id => in_instrument_type_id,
15:21:32 485  	      in_instrument_id	    => in_instrument_id,
15:21:32 486  	      in_charge_amount	    => var_invoice_amount,
15:21:32 487  	      in_created_by	    => in_created_by,
15:21:32 488  	      in_charge_status_id   => GLOBAL_STATUSES_V18.CHARGE_OPENED,
15:21:32 489  	      out_charge_id	    => var_new_charge_id
15:21:32 490  	    );
15:21:32 491  	    EXCEPTION
15:21:32 492  	      WHEN OTHERS THEN
15:21:32 493  		EXCEPTION_MESSAGE := SQLERRM;
15:21:32 494  		RAISE CAN_NOT_CREATE_CHARGE;
15:21:32 495  	  END;
15:21:32 496  	END IF;
15:21:32 497  
15:21:32 498  EXCEPTION
15:21:32 499  WHEN CAN_NOT_USE_FCINSTR THEN
15:21:32 500  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 501  	  SPROC_NAME, 'Could not use "free charge instrument" for non-zero invoice');
15:21:32 502  WHEN CAN_NOT_CALC_INVOICE_AMOUNT THEN
15:21:32 503  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 504  	  SPROC_NAME, 'Could not calculate invoice amount', EXCEPTION_MESSAGE);
15:21:32 505  WHEN CAN_NOT_CREATE_TRANSACTION THEN
15:21:32 506  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 507  	  SPROC_NAME, 'Could not create transaction', EXCEPTION_MESSAGE);
15:21:32 508  WHEN CAN_NOT_CREATE_CHARGE THEN
15:21:32 509  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 510  	  SPROC_NAME, 'Could not create charge', EXCEPTION_MESSAGE);
15:21:32 511  WHEN OTHERS THEN
15:21:32 512  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 513  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 514  END FINALIZE_SUBSCRIPTION_CREATION;
15:21:32 515  
15:21:32 516  /******************************************************************************/
15:21:32 517  
15:21:32 518  PROCEDURE SUSPEND_SUBSCRIPTION(
15:21:32 519  /*
15:21:32 520  Throws exceptions:
15:21:32 521  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 522  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:32 523  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 524  */
15:21:32 525  	  in_subs_id	IN NUMBER,
15:21:32 526  	  in_updated_by IN VARCHAR2
15:21:32 527  ) AS
15:21:32 528  SPROC_NAME		  CONSTANT VARCHAR2(20) := 'SUSPEND_SUBSCRIPTION';
15:21:32 529  var_subscription_status_id  NUMBER;
15:21:32 530  var_license_id		  NUMBER;
15:21:32 531  var_offer_id		  NUMBER;
15:21:32 532  var_license_start_date	  DATE;
15:21:32 533  var_license_end_date	  DATE;
15:21:32 534  
15:21:32 535  var_entitlement_dupration   VARCHAR2(30);
15:21:32 536  var_d_entitlement_dupration NUMBER;
15:21:32 537  
15:21:32 538  var_ym_interval INTERVAL YEAR TO MONTH;
15:21:32 539  var_ds_interval INTERVAL DAY(3) TO SECOND;
15:21:32 540  
15:21:32 541  -- EXCEPTIONS
15:21:32 542  BAD_SUBSCRIPTION_ID     EXCEPTION;
15:21:32 543  BAD_SUBSCRIPTION_STATUS EXCEPTION;
15:21:32 544  NO_LICENSE_FOUND	      EXCEPTION;
15:21:32 545  NO_OFFER_FOUND	      EXCEPTION;
15:21:32 546  EXCEPTION_MESSAGE       VARCHAR2(1024);
15:21:32 547  BEGIN
15:21:32 548  	-- TODO: Finish this prcedure (in Phase II)
15:21:32 549  
15:21:32 550  	-- Get subscription by id. FAULT if no such subscription.
15:21:32 551  	-- begin TX
15:21:32 552  	--   Get for update associated license (subscription.license_id). FAULT if not found.
15:21:32 553  	--   Set status to PROCESSED.
15:21:32 554  	--   updated record.
15:21:32 555  	--   compute days remaining in the subscription: original end_date - today = days_remaining_adjustment
15:21:32 556  	--   new subscription status is SUSPENDED.
15:21:32 557  	--   suspend_date is now.
15:21:32 558  	--   update subscription record.
15:21:32 559  	-- end TX
15:21:32 560  
15:21:32 561  	BEGIN
15:21:32 562  	  SELECT
15:21:32 563  	    SUBSCRIPTION.SUBSCRIPTION_STATUS_ID into var_subscription_status_id
15:21:32 564  	  FROM
15:21:32 565  	    SUBSCRIPTION
15:21:32 566  	  WHERE
15:21:32 567  	    SUBSCRIPTION.ID = in_subs_id;
15:21:32 568  	  EXCEPTION
15:21:32 569  	  WHEN NO_DATA_FOUND THEN
15:21:32 570  	    RAISE BAD_SUBSCRIPTION_ID;
15:21:32 571  	END;
15:21:32 572  
15:21:32 573  	IF var_subscription_status_id != GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE THEN
15:21:32 574  	  RAISE BAD_SUBSCRIPTION_STATUS;
15:21:32 575  	END IF;
15:21:32 576  
15:21:32 577  	BEGIN
15:21:32 578  	  SELECT
15:21:32 579  	    LICENSE.ID,
15:21:32 580  	    LICENSE.OFFER_ID,
15:21:32 581  	    LICENSE.START_DATE
15:21:32 582  	    into
15:21:32 583  	    var_license_id,
15:21:32 584  	    var_offer_id,
15:21:32 585  	    var_license_start_date
15:21:32 586  	  FROM
15:21:32 587  	    LICENSE
15:21:32 588  	  WHERE
15:21:32 589  	    LICENSE.SUBSCRIPTION_ID = in_subs_id
15:21:32 590  	      AND LICENSE.LICENSE_STATUS_ID = GLOBAL_STATUSES_V18.LICENSE_ACTIVE;
15:21:32 591  	  EXCEPTION
15:21:32 592  	  WHEN NO_DATA_FOUND THEN
15:21:32 593  	    RAISE NO_LICENSE_FOUND;
15:21:32 594  	END;
15:21:32 595  
15:21:32 596  	PROCS_LICENSE_CRU_V18.UPDATE_LICENSE(
15:21:32 597  	  in_license_id        => var_license_id,
15:21:32 598  	  in_updated_by        => in_updated_by,
15:21:32 599  	  in_license_status_id => GLOBAL_STATUSES_V18.LICENSE_CLOSED
15:21:32 600  	);
15:21:32 601  
15:21:32 602  	BEGIN
15:21:32 603  	  SELECT
15:21:32 604  	    OFFER.ENTITLEMENT_DURATION into var_entitlement_dupration
15:21:32 605  	  FROM
15:21:32 606  	    OFFER
15:21:32 607  	  WHERE
15:21:32 608  	    OFFER.ID = var_offer_id;
15:21:32 609  	  EXCEPTION
15:21:32 610  	  WHEN NO_DATA_FOUND THEN
15:21:32 611  	    RAISE NO_OFFER_FOUND;
15:21:32 612  	END;
15:21:32 613  
15:21:32 614  	var_ym_interval := substr(var_entitlement_dupration, 0, 4);
15:21:32 615  	var_ds_interval := substr(var_entitlement_dupration, 4);
15:21:32 616  
15:21:32 617  	var_license_end_date := var_license_start_date + var_ym_interval + var_ds_interval;
15:21:32 618  
15:21:32 619  	var_d_entitlement_dupration := var_license_end_date - current_date;
15:21:32 620  
15:21:32 621  	PROCS_SUBSCRIPTION_CRU_V18.UPDATE_SUBSCRIPTION(
15:21:32 622  	  in_subscription_id	       => in_subs_id,
15:21:32 623  	  in_updated_by 	       => in_updated_by,
15:21:32 624  	  in_suspend_date	       => SYSDATE,
15:21:32 625  	  in_subscription_status_id    => GLOBAL_STATUSES_V18.SUBSCRIPTION_SUSPENDED,
15:21:32 626  	  in_days_remainning_ajustment => var_d_entitlement_dupration
15:21:32 627  	);
15:21:32 628  
15:21:32 629  EXCEPTION
15:21:32 630  WHEN BAD_SUBSCRIPTION_ID THEN
15:21:32 631  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 632  	  SPROC_NAME, 'No such subscription');
15:21:32 633  WHEN BAD_SUBSCRIPTION_STATUS THEN
15:21:32 634  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 635  	  SPROC_NAME, 'Subscription is not active');
15:21:32 636  WHEN NO_LICENSE_FOUND THEN
15:21:32 637  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 638  	  SPROC_NAME, 'Can not find license associated with given subscription ID');
15:21:32 639  WHEN NO_OFFER_FOUND THEN
15:21:32 640  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 641  	  SPROC_NAME, 'Can not find offer associated with given subscription ID');
15:21:32 642  WHEN OTHERS THEN
15:21:32 643  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 644  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 645  END SUSPEND_SUBSCRIPTION;
15:21:32 646  
15:21:32 647  /******************************************************************************/
15:21:32 648  
15:21:32 649  PROCEDURE REACTIVATE_SUBSCRIPTION (
15:21:32 650  	in_subscription_id IN  NUMBER,
15:21:32 651  	in_updated_by	   IN  VARCHAR2
15:21:32 652  ) AS
15:21:32 653  BEGIN
15:21:32 654  	-- TODO: finish this function (in Phase II)
15:21:32 655  	NULL;
15:21:32 656  END REACTIVATE_SUBSCRIPTION;
15:21:32 657  
15:21:32 658  /******************************************************************************/
15:21:32 659  
15:21:32 660  PROCEDURE GET_SUBSCRIPTION_INFO (
15:21:32 661  /*
15:21:32 662  Throws exceptions:
15:21:32 663  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 664  */
15:21:32 665  	  in_subscription_id  IN  NUMBER,
15:21:32 666  	  out_result_set      OUT SYS_REFCURSOR
15:21:32 667  ) AS
15:21:32 668  SPROC_NAME CONSTANT VARCHAR2(21) := 'GET_SUBSCRIPTION_INFO';
15:21:32 669  -- VARIABLES
15:21:32 670  temp_subscription_id NUMBER;
15:21:32 671  -- EXCEPTIONS
15:21:32 672  BAD_SUBSCRIPTION_ID EXCEPTION;
15:21:32 673  BEGIN
15:21:32 674  	-- Find subscription by id
15:21:32 675  	-- Return its details
15:21:32 676  
15:21:32 677  	BEGIN
15:21:32 678  	  SELECT
15:21:32 679  	    SUBSCRIPTION.ID into temp_subscription_id
15:21:32 680  	  FROM
15:21:32 681  	    SUBSCRIPTION
15:21:32 682  	  WHERE
15:21:32 683  	    SUBSCRIPTION.ID = in_subscription_id;
15:21:32 684  	  EXCEPTION
15:21:32 685  	    WHEN NO_DATA_FOUND THEN
15:21:32 686  	      RAISE BAD_SUBSCRIPTION_ID;
15:21:32 687  	END;
15:21:32 688  
15:21:32 689  	OPEN out_result_set FOR
15:21:32 690  	SELECT
15:21:32 691  	  SUBSCRIPTION.ID AS "SUBSCRIPTION_ID",
15:21:32 692  	  SUBSCRIPTION.SUBSCRIPTION_STATUS_ID,
15:21:32 693  	  SUBSCRIPTION.PURCHASE_DATE,
15:21:32 694  	  SUBSCRIPTION.SUSPEND_DATE,
15:21:32 695  	  SUBSCRIPTION.REACTIVATION_DATE,
15:21:32 696  	  SUBSCRIPTION.CANCELLATION_DATE,
15:21:32 697  	  SUBSCRIPTION_CANCEL_REASON.VALUE as "CANCEL_TYPE",
15:21:32 698  	  OFFER_CHAIN.ID AS "OFFER_CHAIN_ID",
15:21:32 699  	  OFFER_CHAIN.NAME,
15:21:32 700  	  OFFER_CHAIN.DESCRIPTION,
15:21:32 701  	  OFFER_CHAIN.PRODUCT_URI,
15:21:32 702  	  SUBSCRIPTION.INSTRUMENT_ID,
15:21:32 703  	  SUBSCRIPTION.INSTRUMENT_TYPE_ID,
15:21:32 704  	  PROCS_SUBSCRIPTION_V18.CALC_SUBSCRIPTION_END_DATE(SUBSCRIPTION.ID) as "END_DATE",
15:21:32 705  	  PROCS_SUBSCRIPTION_V18.GET_RECENT_CHARGE(SUBSCRIPTION.ID) AS "RECENT_CHARGE",
15:21:32 706  	  PROCS_SUBSCRIPTION_V18.GET_RENEWAL_DATE(SUBSCRIPTION.ID) AS "RENEWAL_DATE",
15:21:32 707  	  PROCS_SUBSCRIPTION_V18.GET_BILLING_CYCLE(SUBSCRIPTION.ID) AS "BILLING_CYCLE",
15:21:32 708  	  (
15:21:32 709  	    SELECT
15:21:32 710  	      ACCOUNT.GROUP_ID
15:21:32 711  	      FROM ACCOUNT
15:21:32 712  	      WHERE ACCOUNT.ID = SUBSCRIPTION.ACCOUNT_ID
15:21:32 713  	  ) as "GROUP_ID",
15:21:32 714  	  (
15:21:32 715  	    SELECT
15:21:32 716  	      MAX(ENTITLEMENT_END_DATE)
15:21:32 717  	      FROM LICENSE
15:21:32 718  	      WHERE LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
15:21:32 719  	  )
15:21:32 720  	  as "ENT_END_DATE",
15:21:32 721  	  (
15:21:32 722  	    SELECT
15:21:32 723  	      MIN(START_DATE)
15:21:32 724  	      FROM LICENSE
15:21:32 725  	      WHERE LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
15:21:32 726  	  )
15:21:32 727  	  as "ENT_START_DATE",
15:21:32 728  	  PROCS_SUBSCRIPTION_V18.IS_SUBSCRIPTION_CANCELABLE(SUBSCRIPTION.ID) AS "IS_CANCELABLE",
15:21:32 729  	  ITUNES_RECEIPT.ID AS "ITUNES_RECEIPT_ID",
15:21:32 730  	  GROUP_ACCOUNT.ID GA_ID,
15:21:32 731  	  GROUP_ACCOUNT.SUBSCRIPTION_ID GA_SUBSCRIPTION_ID,
15:21:32 732  	  GROUP_ACCOUNT.GROUP_NAME GA_GROUP_NAME,
15:21:32 733  	  GROUP_ACCOUNT.FIRST_NAME GA_FIRST_NAME,
15:21:32 734  	  GROUP_ACCOUNT.LAST_NAME GA_LAST_NAME,
15:21:32 735  	  GROUP_ACCOUNT.EMAIL GA_EMAIL,
15:21:32 736  	  GROUP_ACCOUNT.PHONE GA_PHONE,
15:21:32 737  	  GROUP_ACCOUNT.ORGANIZATION_TYPE GA_ORGANIZATION_TYPE,
15:21:32 738  	  GROUP_ACCOUNT.SEATS GA_SEATS,
15:21:32 739  	  PROCS_GROUP_ACCOUNT_V18.F_GET_NUM_OCCUPIED_GROUP_SEATS(GROUP_ACCOUNT.ID) GA_SEATS_USED,
15:21:32 740  	  GROUP_ACCOUNT.IP GA_IP,
15:21:32 741  	  PROCS_SUBSCRIPTION_V18.GET_GIFT_CERT_CODE_BY_SUB_ID(SUBSCRIPTION.ID) gift_certificate_code,
15:21:32 742  	  PROCS_ACCOUNT_V18.GET_GRACE_START_DATE(SUBSCRIPTION.ID) GRACE_START_DATE,
15:21:32 743  	  PROCS_ACCOUNT_V18.GET_GRACE_END_DATE(SUBSCRIPTION.ID) GRACE_END_DATE
15:21:32 744  	FROM
15:21:32 745  	  SUBSCRIPTION
15:21:32 746  	  INNER JOIN OFFER_CHAIN ON SUBSCRIPTION.OFFER_CHAIN_ID = OFFER_CHAIN.ID
15:21:32 747  	  LEFT JOIN SUBSCRIPTION_CANCEL_REASON ON SUBSCRIPTION.SCT_ID = SUBSCRIPTION_CANCEL_REASON.ID
15:21:32 748  	  LEFT JOIN ITUNES_RECEIPT ON SUBSCRIPTION.ID = ITUNES_RECEIPT.SUBSCRIPTION_ID
15:21:32 749  	  LEFT JOIN GROUP_ACCOUNT ON SUBSCRIPTION.ID = GROUP_ACCOUNT.SUBSCRIPTION_ID
15:21:32 750  	WHERE
15:21:32 751  	  SUBSCRIPTION.ID = in_subscription_id;
15:21:32 752  
15:21:32 753  EXCEPTION
15:21:32 754  WHEN BAD_SUBSCRIPTION_ID THEN
15:21:32 755  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 756  	  SPROC_NAME, 'No such subscription');
15:21:32 757  WHEN OTHERS THEN
15:21:32 758  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 759  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 760  END GET_SUBSCRIPTION_INFO;
15:21:32 761  
15:21:32 762  /******************************************************************************/
15:21:32 763  
15:21:32 764  PROCEDURE GET_SUBSCRIPTION_INVOICES (
15:21:32 765  /*
15:21:32 766  Throws exceptions:
15:21:32 767  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 768  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 769  */
15:21:32 770  	in_subscription_id  IN	NUMBER,
15:21:32 771  	out_result_set	    OUT SYS_REFCURSOR
15:21:32 772  ) AS
15:21:32 773  SPROC_NAME	   CONSTANT VARCHAR2(25) := 'GET_SUBSCRIPTION_INVOICES';
15:21:32 774  temp_subscription_id NUMBER;
15:21:32 775  BEGIN
15:21:32 776  	-- Note: A subscription has one or more associated licenses, each of which has an associated invoice.
15:21:32 777  	-- Find associated LICENSES for the subscription by "LICENSE.subscription_id"
15:21:32 778  	--   for each license
15:21:32 779  	--     get associated invoice
15:21:32 780  	--     add to results list
15:21:32 781  	--   end loop
15:21:32 782  	-- end
15:21:32 783  
15:21:32 784  	SELECT
15:21:32 785  	  SUBSCRIPTION.ID into temp_subscription_id
15:21:32 786  	FROM
15:21:32 787  	  SUBSCRIPTION
15:21:32 788  	WHERE
15:21:32 789  	  SUBSCRIPTION.ID = in_subscription_id;
15:21:32 790  
15:21:32 791  	OPEN out_result_set FOR
15:21:32 792  	SELECT
15:21:32 793  	  INVOICE.ID,
15:21:32 794  	  INVOICE.INVOICE_STATUS_ID,
15:21:32 795  	  INVOICE.CREATE_DATE,
15:21:32 796  	  INVOICE.CREATED_BY,
15:21:32 797  	  INVOICE.UPDATE_DATE,
15:21:32 798  	  INVOICE.UPDATED_BY,
15:21:32 799  	  INVOICE.TAX_EXEMPT_ID
15:21:32 800  	FROM
15:21:32 801  	  LICENSE
15:21:32 802  	    INNER JOIN INVOICE ON LICENSE.INVOICE_ID = INVOICE.ID
15:21:32 803  	WHERE
15:21:32 804  	  LICENSE.SUBSCRIPTION_ID = in_subscription_id;
15:21:32 805  
15:21:32 806  EXCEPTION
15:21:32 807  WHEN NO_DATA_FOUND THEN
15:21:32 808  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 809  	  SPROC_NAME, 'Could not find subscription with given ID');
15:21:32 810  WHEN OTHERS THEN
15:21:32 811  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 812  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 813  END GET_SUBSCRIPTION_INVOICES;
15:21:32 814  
15:21:32 815  /******************************************************************************/
15:21:32 816  
15:21:32 817  PROCEDURE GET_SUBSCRIPTION_NOTES (
15:21:32 818  /*
15:21:32 819  Throws exceptions:
15:21:32 820  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 821  */
15:21:32 822  	in_subscription_id  IN	NUMBER,
15:21:32 823  	out_result_set	    OUT SYS_REFCURSOR
15:21:32 824  ) AS
15:21:32 825  -- VARIABLES
15:21:32 826  SPROC_NAME	   CONSTANT VARCHAR2(22) := 'GET_SUBSCRIPTION_NOTES';
15:21:32 827  temp_subscription_id NUMBER;
15:21:32 828  -- EXCEPTIONS
15:21:32 829  BAD_SUBSCRIPTION_ID EXCEPTION;
15:21:32 830  BEGIN
15:21:32 831  
15:21:32 832  	-- Check that subscription exists
15:21:32 833  	BEGIN
15:21:32 834  	  SELECT
15:21:32 835  	    SUBSCRIPTION.ID into temp_subscription_id
15:21:32 836  	  FROM
15:21:32 837  	    SUBSCRIPTION
15:21:32 838  	  WHERE
15:21:32 839  	    SUBSCRIPTION.ID = in_subscription_id;
15:21:32 840  	  EXCEPTION
15:21:32 841  	    WHEN NO_DATA_FOUND THEN
15:21:32 842  	      RAISE BAD_SUBSCRIPTION_ID;
15:21:32 843  	END;
15:21:32 844  
15:21:32 845  	OPEN out_result_set FOR
15:21:32 846  	SELECT
15:21:32 847  	  SUBSCRIPTION_NOTE.NOTE,
15:21:32 848  	  SUBSCRIPTION_NOTE.CREATED_BY,
15:21:32 849  	  SUBSCRIPTION_NOTE.CREATE_DATE
15:21:32 850  	FROM
15:21:32 851  	  SUBSCRIPTION_NOTE
15:21:32 852  	WHERE
15:21:32 853  	  SUBSCRIPTION_NOTE.SUBSCRIPTION_ID = in_subscription_id
15:21:32 854  	ORDER BY
15:21:32 855  	  SUBSCRIPTION_NOTE.CREATE_DATE ASC;
15:21:32 856  
15:21:32 857  EXCEPTION
15:21:32 858  WHEN BAD_SUBSCRIPTION_ID THEN
15:21:32 859  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 860  	  SPROC_NAME, 'No such subscription');
15:21:32 861  WHEN OTHERS THEN
15:21:32 862  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 863  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 864  END GET_SUBSCRIPTION_NOTES;
15:21:32 865  
15:21:32 866  /******************************************************************************/
15:21:32 867  
15:21:32 868  PROCEDURE ANNOTATE_SUBSCRIPTION (
15:21:32 869  /*
15:21:32 870  Throws exceptions:
15:21:32 871  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 872  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 873  */
15:21:32 874  	in_subscription_id IN  NUMBER,
15:21:32 875  	in_agent_id	   IN  NUMBER,
15:21:32 876  	in_note 	   IN  VARCHAR2,
15:21:32 877  	in_created_by	   IN  VARCHAR2
15:21:32 878  ) AS
15:21:32 879  -- VARIABLES
15:21:32 880  SPROC_NAME	       CONSTANT VARCHAR2(21) := 'ANNOTATE_SUBSCRIPTION';
15:21:32 881  temp_subscription_id     NUMBER;
15:21:32 882  var_subscription_note_id NUMBER;
15:21:32 883  -- EXCEPTIONS
15:21:32 884  BAD_SUBSCRIPTION_ID EXCEPTION;
15:21:32 885  BEGIN
15:21:32 886  
15:21:32 887  	-- Check that subscription exists
15:21:32 888  	BEGIN
15:21:32 889  	  SELECT
15:21:32 890  	    SUBSCRIPTION.ID into temp_subscription_id
15:21:32 891  	  FROM
15:21:32 892  	    SUBSCRIPTION
15:21:32 893  	  WHERE
15:21:32 894  	    SUBSCRIPTION.ID = in_subscription_id;
15:21:32 895  	  EXCEPTION
15:21:32 896  	    WHEN NO_DATA_FOUND THEN
15:21:32 897  	      RAISE BAD_SUBSCRIPTION_ID;
15:21:32 898  	END;
15:21:32 899  
15:21:32 900  	PROCS_SUBSCRIPTION_CRU_V18.CREATE_SUBSCRIPTION_NOTE(
15:21:32 901  	  inout_subscription_note_id => var_subscription_note_id,
15:21:32 902  	  in_agent_id		     => in_agent_id,
15:21:32 903  	  in_subscription_id	     => in_subscription_id,
15:21:32 904  	  in_note		     => in_note,
15:21:32 905  	  in_created_by 	     => in_created_by
15:21:32 906  	);
15:21:32 907  
15:21:32 908  EXCEPTION
15:21:32 909  WHEN BAD_SUBSCRIPTION_ID THEN
15:21:32 910  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 911  	  SPROC_NAME, 'No such subscription');
15:21:32 912  WHEN OTHERS THEN
15:21:32 913  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 914  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 915  END ANNOTATE_SUBSCRIPTION;
15:21:32 916  
15:21:32 917  /******************************************************************************/
15:21:32 918  
15:21:32 919  PROCEDURE GET_CANCEL_REASONS (
15:21:32 920  	out_result_set	  OUT SYS_REFCURSOR
15:21:32 921  ) AS
15:21:32 922  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_CANCEL_REASONS';
15:21:32 923  BEGIN
15:21:32 924  	OPEN out_result_set FOR
15:21:32 925  	SELECT
15:21:32 926  	  SUBSCRIPTION_CANCEL_REASON.ID,
15:21:32 927  	  SUBSCRIPTION_CANCEL_REASON.VALUE,
15:21:32 928  	  SUBSCRIPTION_CANCEL_REASON.DESCRIPTION,
15:21:32 929  	  SUBSCRIPTION_CANCEL_REASON.CANCELATION_STATUS_ID AS STATUS_ID
15:21:32 930  	FROM
15:21:32 931  	  SUBSCRIPTION_CANCEL_REASON;
15:21:32 932  
15:21:32 933  END GET_CANCEL_REASONS;
15:21:32 934  
15:21:32 935  /******************************************************************************/
15:21:32 936  
15:21:32 937  FUNCTION GET_RENEWAL_DATE (
15:21:32 938  /*
15:21:32 939  Throws exceptions:
15:21:32 940  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 941  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 942  */
15:21:32 943  	in_subscription_id in NUMBER
15:21:32 944  ) RETURN DATE AS
15:21:32 945  -- VARIABLES
15:21:32 946  SPROC_NAME	      CONSTANT VARCHAR2(16) := 'GET_RENEWAL_DATE';
15:21:32 947  var_subscription_status NUMBER;
15:21:32 948  var_licenses_count      NUMBER;
15:21:32 949  var_license_end_date    DATE;
15:21:32 950  var_last_offer_id       NUMBER;
15:21:32 951  var_offer_chain_id      NUMBER;
15:21:32 952  var_last_license_id     NUMBER;
15:21:32 953  var_current_offer_index NUMBER;
15:21:32 954  var_current_offer_recurr_num NUMBER;
15:21:32 955  var_offer_recurr_num    NUMBER;
15:21:32 956  -- EXCEPTIONS
15:21:32 957  BAD_SUBSCRIPTION_ID EXCEPTION;
15:21:32 958  NO_LICENSES_FOUND EXCEPTION;
15:21:32 959  BEGIN
15:21:32 960  
15:21:32 961  	-- Get subscription id and offer chain id
15:21:32 962  	BEGIN
15:21:32 963  	  SELECT
15:21:32 964  	    SUBSCRIPTION.SUBSCRIPTION_STATUS_ID,
15:21:32 965  	    SUBSCRIPTION.OFFER_CHAIN_ID
15:21:32 966  	    into
15:21:32 967  	    var_subscription_status,
15:21:32 968  	    var_offer_chain_id
15:21:32 969  	  FROM
15:21:32 970  	    SUBSCRIPTION
15:21:32 971  	  WHERE
15:21:32 972  	    SUBSCRIPTION.ID = in_subscription_id;
15:21:32 973  	  EXCEPTION
15:21:32 974  	    WHEN NO_DATA_FOUND THEN
15:21:32 975  	      RAISE BAD_SUBSCRIPTION_ID;
15:21:32 976  	END;
15:21:32 977  
15:21:32 978  	IF var_subscription_status != GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE THEN
15:21:32 979  	  -- TODO: Is suspended subscription has renewal date? (For the phase II)
15:21:32 980  	  -- AND var_subscription_status != GLOBAL_STATUSES_V18.SUBSCRIPTION_SUSPENDED THEN
15:21:32 981  	  RETURN NULL;
15:21:32 982  	END IF;
15:21:32 983  
15:21:32 984  	BEGIN
15:21:32 985  	  SELECT
15:21:32 986  	    LICENSE_ID,
15:21:32 987  	    END_DATE,
15:21:32 988  	    OFFER_ID,
15:21:32 989  	    CURRENT_OFFER_INDEX,
15:21:32 990  	    CURRENT_OFFER_RECURR_NUM
15:21:32 991  	    into
15:21:32 992  	    var_last_license_id,
15:21:32 993  	    var_license_end_date,
15:21:32 994  	    var_last_offer_id,
15:21:32 995  	    var_current_offer_index,
15:21:32 996  	    var_current_offer_recurr_num
15:21:32 997  	  FROM
15:21:32 998  	    (
15:21:32 999  	      SELECT
15:21:32 1000  		 LICENSE.ID as "LICENSE_ID",
15:21:32 1001  		 LICENSE.END_DATE,
15:21:32 1002  		 LICENSE.OFFER_ID,
15:21:32 1003  		 LICENSE.CURRENT_OFFER_INDEX,
15:21:32 1004  		 LICENSE.CURRENT_OFFER_RECURR_NUM
15:21:32 1005  	       FROM
15:21:32 1006  		 LICENSE
15:21:32 1007  	       WHERE
15:21:32 1008  		 LICENSE.LICENSE_STATUS_ID = GLOBAL_STATUSES_V18.LICENSE_ACTIVE
15:21:32 1009  		 AND LICENSE.SUBSCRIPTION_ID = in_subscription_id
15:21:32 1010  	       ORDER BY END_DATE DESC
15:21:32 1011  	     )
15:21:32 1012  	     INNER JOIN OFFER ON OFFER_ID = OFFER.ID
15:21:32 1013  	   WHERE
15:21:32 1014  	     ROWNUM <= 1;
15:21:32 1015  
15:21:32 1016  	   EXCEPTION
15:21:32 1017  	     WHEN NO_DATA_FOUND THEN
15:21:32 1018  	       -- RAISE NO_LICENSES_FOUND;
15:21:32 1019  	       RETURN NULL;
15:21:32 1020  	 END;
15:21:32 1021  
15:21:32 1022  	 SELECT
15:21:32 1023  	   OFFER_OFFER_CHAIN.NUM_RECURRENCES into var_offer_recurr_num
15:21:32 1024  	 FROM
15:21:32 1025  	   OFFER_OFFER_CHAIN
15:21:32 1026  	 WHERE
15:21:32 1027  	   OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = var_offer_chain_id
15:21:32 1028  	   AND OFFER_OFFER_CHAIN.OFFER_ID = var_last_offer_id;
15:21:32 1029  
15:21:32 1030  	 IF PROCS_OFFER_CHAIN_V18.GET_NEXT_OFFER_INDEX(var_offer_chain_id, var_current_offer_index) IS NULL
15:21:32 1031  	   AND var_offer_recurr_num = var_current_offer_recurr_num THEN
15:21:32 1032  	   -- There is no next offer for this subscription
15:21:32 1033  	   RETURN NULL;
15:21:32 1034  	 END IF;
15:21:32 1035  
15:21:32 1036  	 RETURN var_license_end_date;
15:21:32 1037  
15:21:32 1038  EXCEPTION
15:21:32 1039  WHEN BAD_SUBSCRIPTION_ID THEN
15:21:32 1040  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1041  	   SPROC_NAME, 'No such subscription');
15:21:32 1042  WHEN NO_LICENSES_FOUND THEN
15:21:32 1043  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1044  	   SPROC_NAME, 'No licenses found');
15:21:32 1045  WHEN OTHERS THEN
15:21:32 1046  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1047  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1048  END GET_RENEWAL_DATE;
15:21:32 1049  
15:21:32 1050  /******************************************************************************/
15:21:32 1051  
15:21:32 1052  FUNCTION GET_RECENT_CHARGE (
15:21:32 1053  /*
15:21:32 1054  Throws exceptions:
15:21:32 1055  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 1056  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 1057  */
15:21:32 1058  	 in_subscription_id IN NUMBER
15:21:32 1059  ) RETURN NUMBER AS
15:21:32 1060  -- VARIABLES
15:21:32 1061  SPROC_NAME	    CONSTANT VARCHAR2(17) := 'GET_RECENT_CHARGE';
15:21:32 1062  temp_subscription_id NUMBER;
15:21:32 1063  var_recent_charge    NUMBER(10,2);
15:21:32 1064  
15:21:32 1065  -- EXCEPTIONS
15:21:32 1066  BAD_SUBSCRIPTION_ID EXCEPTION;
15:21:32 1067  BEGIN
15:21:32 1068  
15:21:32 1069  	 BEGIN
15:21:32 1070  	   SELECT
15:21:32 1071  	     SUBSCRIPTION.ID into temp_subscription_id
15:21:32 1072  	   FROM
15:21:32 1073  	     SUBSCRIPTION
15:21:32 1074  	   WHERE
15:21:32 1075  	     SUBSCRIPTION.ID = in_subscription_id;
15:21:32 1076  	   EXCEPTION
15:21:32 1077  	     WHEN NO_DATA_FOUND THEN
15:21:32 1078  	       RAISE BAD_SUBSCRIPTION_ID;
15:21:32 1079  	 END;
15:21:32 1080  
15:21:32 1081  	 BEGIN
15:21:32 1082  	   SELECT
15:21:32 1083  	     CHARGE.CHARGE_AMOUNT into var_recent_charge
15:21:32 1084  	   FROM
15:21:32 1085  	     LICENSE
15:21:32 1086  	     INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
15:21:32 1087  	     INNER JOIN INVOICE ON LICENSE.INVOICE_ID = INVOICE.ID
15:21:32 1088  	     INNER JOIN CHARGE ON CHARGE.INVOICE_ID = INVOICE.ID
15:21:32 1089  	   WHERE
15:21:32 1090  	     -- TODO: Review
15:21:32 1091  	     -- LICENSE.LICENSE_STATUS_ID = GLOBAL_STATUSES_V18.LICENSE_PROCESSED
15:21:32 1092  	     -- AND
15:21:32 1093  	     SUBSCRIPTION.ID = in_subscription_id
15:21:32 1094  	     AND CHARGE.CHARGE_AMOUNT >= 0
15:21:32 1095  	     AND ROWNUM <= 1
15:21:32 1096  	   ORDER BY
15:21:32 1097  	     LICENSE.ID ASC, CHARGE.ID DESC;
15:21:32 1098  	   EXCEPTION
15:21:32 1099  	     WHEN NO_DATA_FOUND THEN
15:21:32 1100  	       var_recent_charge := 0;
15:21:32 1101  	 END;
15:21:32 1102  
15:21:32 1103  	 RETURN var_recent_charge;
15:21:32 1104  
15:21:32 1105  EXCEPTION
15:21:32 1106  WHEN BAD_SUBSCRIPTION_ID THEN
15:21:32 1107  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1108  	   SPROC_NAME, 'No such subscription');
15:21:32 1109  WHEN OTHERS THEN
15:21:32 1110  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1111  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1112  END GET_RECENT_CHARGE;
15:21:32 1113  
15:21:32 1114  /******************************************************************************/
15:21:32 1115  
15:21:32 1116  FUNCTION GET_BILLING_CYCLE (
15:21:32 1117  	 in_subscription_id IN NUMBER
15:21:32 1118  ) RETURN VARCHAR2 AS
15:21:32 1119  -- VARIABLES
15:21:32 1120  SPROC_NAME	    CONSTANT VARCHAR2(17) := 'GET_BILLING_CYCLE';
15:21:32 1121  temp_subscription_id NUMBER;
15:21:32 1122  var_offer_duration   VARCHAR2(30);
15:21:32 1123  
15:21:32 1124  -- EXCEPTIONS
15:21:32 1125  BAD_SUBSCRIPTION_ID EXCEPTION;
15:21:32 1126  BEGIN
15:21:32 1127  
15:21:32 1128  	 BEGIN
15:21:32 1129  	   SELECT
15:21:32 1130  	     SUBSCRIPTION.ID into temp_subscription_id
15:21:32 1131  	   FROM
15:21:32 1132  	     SUBSCRIPTION
15:21:32 1133  	   WHERE
15:21:32 1134  	     SUBSCRIPTION.ID = in_subscription_id;
15:21:32 1135  	   EXCEPTION
15:21:32 1136  	     WHEN NO_DATA_FOUND THEN
15:21:32 1137  	       RAISE BAD_SUBSCRIPTION_ID;
15:21:32 1138  	 END;
15:21:32 1139  
15:21:32 1140  	 SELECT
15:21:32 1141  	   OFFER.ENTITLEMENT_DURATION into var_offer_duration
15:21:32 1142  	 FROM
15:21:32 1143  	   LICENSE
15:21:32 1144  	   INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
15:21:32 1145  	   INNER JOIN OFFER ON LICENSE.OFFER_ID = OFFER.ID
15:21:32 1146  	 WHERE
15:21:32 1147  	   --LICENSE.LICENSE_STATUS_ID = GLOBAL_STATUSES_V18.LICENSE_PROCESSED
15:21:32 1148  	   --AND
15:21:32 1149  	   SUBSCRIPTION.ID = in_subscription_id
15:21:32 1150  	   AND ROWNUM <= 1
15:21:32 1151  	 ORDER BY
15:21:32 1152  	   LICENSE.ID ASC;
15:21:32 1153  
15:21:32 1154  	 RETURN var_offer_duration;
15:21:32 1155  
15:21:32 1156  EXCEPTION
15:21:32 1157  WHEN BAD_SUBSCRIPTION_ID THEN
15:21:32 1158  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1159  	   SPROC_NAME, 'No such subscription');
15:21:32 1160  WHEN OTHERS THEN
15:21:32 1161  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1162  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1163  END GET_BILLING_CYCLE;
15:21:32 1164  
15:21:32 1165  /******************************************************************************/
15:21:32 1166  
15:21:32 1167  PROCEDURE REFUND_SUBSCRIPTION (
15:21:32 1168  /*
15:21:32 1169  Throws exceptions:
15:21:32 1170  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 1171  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 1172  */
15:21:32 1173  	 in_subscription_id IN NUMBER,
15:21:32 1174  	 in_invoice_id	    IN NUMBER,
15:21:32 1175  	 in_refund_amount   IN NUMBER,
15:21:32 1176  	 in_note	    IN VARCHAR2,
15:21:32 1177  	 in_created_by	    IN VARCHAR2,
15:21:32 1178  	 out_charge_id	    OUT NUMBER
15:21:32 1179  ) AS
15:21:32 1180  -- VARIABLES
15:21:32 1181  SPROC_NAME	      CONSTANT VARCHAR2(19) := 'REFUND_SUBSCRIPTION';
15:21:32 1182  var_invoice_status_id  NUMBER;
15:21:32 1183  var_account_id	      NUMBER;
15:21:32 1184  var_account_status_id  NUMBER;
15:21:32 1185  var_new_transaction_id NUMBER;
15:21:32 1186  var_instrument_type_id NUMBER;
15:21:32 1187  var_instrument_id      NUMBER;
15:21:32 1188  var_new_charge_id      NUMBER;
15:21:32 1189  var_invoice_amount     NUMBER(10,2);
15:21:32 1190  var_refunds_before     NUMBER(10,2);
15:21:32 1191  var_charges_amount     NUMBER(10,2);
15:21:32 1192  -- EXCEPTIONS
15:21:32 1193  BAD_SUBSCRIPTION_ID	     EXCEPTION;
15:21:32 1194  ACCOUNT_IS_FROZEN	     EXCEPTION;
15:21:32 1195  BAD_INVOICE_ID		     EXCEPTION;
15:21:32 1196  CAN_NOT_CREATE_TRANSACTION    EXCEPTION;
15:21:32 1197  CAN_NOT_CREATE_CHARGE	     EXCEPTION;
15:21:32 1198  CAN_NOT_CALC_INVOICE_AMOUNT   EXCEPTION;
15:21:32 1199  REFUND_IS_GREATER_THAN_ANOUNT EXCEPTION;
15:21:32 1200  CAN_NOT_ANNOTATE_SUBSCRIPTION EXCEPTION;
15:21:32 1201  TOT_REF_IS_GREATER_THAN_ANOUNT EXCEPTION;
15:21:32 1202  INVOICE_IS_NOT_CLOSED	     EXCEPTION;
15:21:32 1203  TOT_REF_IS_GRATER_THAN_CHARGES EXCEPTION;
15:21:32 1204  EXCEPTION_MESSAGE	      VARCHAR2(1024);
15:21:32 1205  BEGIN
15:21:32 1206  
15:21:32 1207  	 BEGIN
15:21:32 1208  	   SELECT
15:21:32 1209  	     SUBSCRIPTION.INSTRUMENT_ID,
15:21:32 1210  	     SUBSCRIPTION.INSTRUMENT_TYPE_ID,
15:21:32 1211  	     SUBSCRIPTION.ACCOUNT_ID
15:21:32 1212  	     into
15:21:32 1213  	     var_instrument_id,
15:21:32 1214  	     var_instrument_type_id,
15:21:32 1215  	     var_account_id
15:21:32 1216  	   FROM
15:21:32 1217  	     SUBSCRIPTION
15:21:32 1218  	   WHERE
15:21:32 1219  	     SUBSCRIPTION.ID = in_subscription_id;
15:21:32 1220  	   EXCEPTION
15:21:32 1221  	     WHEN NO_DATA_FOUND THEN
15:21:32 1222  	       RAISE BAD_SUBSCRIPTION_ID;
15:21:32 1223  	 END;
15:21:32 1224  
15:21:32 1225  	 -- Check account status. It should not to be frozen
15:21:32 1226  	 SELECT
15:21:32 1227  	   ACCOUNT.ACCOUNT_STATUS_ID into var_account_status_id
15:21:32 1228  	 FROM
15:21:32 1229  	   ACCOUNT
15:21:32 1230  	 WHERE
15:21:32 1231  	   ACCOUNT.ID = var_account_id;
15:21:32 1232  
15:21:32 1233  	 IF var_account_status_id = GLOBAL_STATUSES_V18.ACCOUNT_FROZEN THEN
15:21:32 1234  	   RAISE ACCOUNT_IS_FROZEN;
15:21:32 1235  	 END IF;
15:21:32 1236  
15:21:32 1237  	 BEGIN
15:21:32 1238  	   SELECT
15:21:32 1239  	     INVOICE.INVOICE_STATUS_ID into var_invoice_status_id
15:21:32 1240  	   FROM
15:21:32 1241  	     INVOICE
15:21:32 1242  	   WHERE
15:21:32 1243  	     INVOICE.ID = in_invoice_id;
15:21:32 1244  	   EXCEPTION
15:21:32 1245  	     WHEN NO_DATA_FOUND THEN
15:21:32 1246  	       RAISE BAD_INVOICE_ID;
15:21:32 1247  	 END;
15:21:32 1248  
15:21:32 1249  	 IF var_invoice_status_id != GLOBAL_STATUSES_V18.INVOICE_CLOSED THEN
15:21:32 1250  	   RAISE INVOICE_IS_NOT_CLOSED;
15:21:32 1251  	 END IF;
15:21:32 1252  
15:21:32 1253  	 BEGIN
15:21:32 1254  	   PROCS_INVOICE_V18.CALCULATE_INVOICE_AMOUNT (
15:21:32 1255  	     in_invoice_id => in_invoice_id,
15:21:32 1256  	     out_amount    => var_invoice_amount
15:21:32 1257  	   );
15:21:32 1258  	   EXCEPTION
15:21:32 1259  	     WHEN OTHERS THEN
15:21:32 1260  	       EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1261  	       RAISE CAN_NOT_CALC_INVOICE_AMOUNT;
15:21:32 1262  	 END;
15:21:32 1263  
15:21:32 1264  	 IF ( in_refund_amount > var_invoice_amount ) THEN
15:21:32 1265  	   RAISE REFUND_IS_GREATER_THAN_ANOUNT;
15:21:32 1266  	 END IF;
15:21:32 1267  
15:21:32 1268  	 SELECT /*+ STAR_TRANSFORMATION */
15:21:32 1269  	   SUM(CHARGE.CHARGE_AMOUNT) into var_refunds_before
15:21:32 1270  	 FROM
15:21:32 1271  	   CHARGE
15:21:32 1272  	 WHERE
15:21:32 1273  	   CHARGE.INVOICE_ID = in_invoice_id
15:21:32 1274  	   AND (
15:21:32 1275  	     CHARGE.CHARGE_STATUS_ID = GLOBAL_STATUSES_V18.CHARGE_OPENED
15:21:32 1276  	     OR CHARGE.CHARGE_STATUS_ID = GLOBAL_STATUSES_V18.CHARGE_PROCESSED
15:21:32 1277  	   )
15:21:32 1278  	   AND CHARGE.CHARGE_AMOUNT < 0;
15:21:32 1279  
15:21:32 1280  	 -- Refunds are negative
15:21:32 1281  	 var_refunds_before := -var_refunds_before;
15:21:32 1282  
15:21:32 1283  	 var_charges_amount := 0;
15:21:32 1284  
15:21:32 1285  	 FOR f_processed_charges IN (
15:21:32 1286  	   SELECT
15:21:32 1287  	     CHARGE.CHARGE_AMOUNT
15:21:32 1288  	   FROM
15:21:32 1289  	     CHARGE
15:21:32 1290  	   WHERE
15:21:32 1291  	     CHARGE.INVOICE_ID = in_invoice_id
15:21:32 1292  	     AND CHARGE.CHARGE_STATUS_ID IN (SELECT GLOBAL_STATUSES_V18.CHARGE_PROCESSED FROM DUAL)
15:21:32 1293  	 )
15:21:32 1294  	 LOOP
15:21:32 1295  	   IF f_processed_charges.CHARGE_AMOUNT > 0 THEN
15:21:32 1296  	     var_charges_amount := var_charges_amount + f_processed_charges.CHARGE_AMOUNT;
15:21:32 1297  	   END IF;
15:21:32 1298  	 END LOOP;
15:21:32 1299  
15:21:32 1300  	 IF (in_refund_amount + var_refunds_before > var_invoice_amount) THEN
15:21:32 1301  	   RAISE TOT_REF_IS_GREATER_THAN_ANOUNT;
15:21:32 1302  	 END IF;
15:21:32 1303  
15:21:32 1304  	 IF (in_refund_amount + var_refunds_before > var_charges_amount) THEN
15:21:32 1305  	   RAISE TOT_REF_IS_GRATER_THAN_CHARGES;
15:21:32 1306  	 END IF;
15:21:32 1307  
15:21:32 1308  	 BEGIN
15:21:32 1309  	   PROCS_TRANSACTION_V18.CREATE_TRANSACTION(
15:21:32 1310  	     in_transaction_id	       => NULL,
15:21:32 1311  	     in_status_id	       => GLOBAL_STATUSES_V18.TRANSACTION_PREPARE,
15:21:32 1312  	     in_amount		       => -in_refund_amount,
15:21:32 1313  	     in_created_by	       => in_created_by,
15:21:32 1314  	     in_order_id	       => NULL,
15:21:32 1315  	     in_is_refund	       => GLOBAL_CONSTANTS_V18.TRUE,
15:21:32 1316  	     in_transaction_type_code  => 'REFUND',
15:21:32 1317  	     out_transaction_id        => var_new_transaction_id
15:21:32 1318  	   );
15:21:32 1319  	   EXCEPTION
15:21:32 1320  	     WHEN OTHERS THEN
15:21:32 1321  	       EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1322  	       RAISE CAN_NOT_CREATE_TRANSACTION;
15:21:32 1323  	 END;
15:21:32 1324  
15:21:32 1325  	 BEGIN
15:21:32 1326  	   PROCS_CHARGE_V18.CREATE_CHARGE(
15:21:32 1327  	     in_invoice_id	   => in_invoice_id,
15:21:32 1328  	     in_transaction_id	   => var_new_transaction_id,
15:21:32 1329  	     in_instrument_type_id => var_instrument_type_id,
15:21:32 1330  	     in_instrument_id	   => var_instrument_id,
15:21:32 1331  	     in_charge_amount	   => -in_refund_amount,
15:21:32 1332  	     in_created_by	   => in_created_by,
15:21:32 1333  	     in_charge_status_id   => GLOBAL_STATUSES_V18.CHARGE_OPENED,
15:21:32 1334  	     out_charge_id	   => var_new_charge_id
15:21:32 1335  	   );
15:21:32 1336  	   EXCEPTION
15:21:32 1337  	     WHEN OTHERS THEN
15:21:32 1338  	       EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1339  	       RAISE CAN_NOT_CREATE_CHARGE;
15:21:32 1340  	 END;
15:21:32 1341  
15:21:32 1342  	 IF in_note IS NOT NULL THEN
15:21:32 1343  	   BEGIN
15:21:32 1344  	     PROCS_SUBSCRIPTION_V18.ANNOTATE_SUBSCRIPTION(
15:21:32 1345  	       in_subscription_id => in_subscription_id,
15:21:32 1346  	       in_agent_id	  => 0, -- AGENT_ID??
15:21:32 1347  	       in_note		  => in_note,
15:21:32 1348  	       in_created_by	  => in_created_by
15:21:32 1349  	     );
15:21:32 1350  	     EXCEPTION
15:21:32 1351  	       WHEN OTHERS THEN
15:21:32 1352  		 EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1353  		 RAISE CAN_NOT_ANNOTATE_SUBSCRIPTION;
15:21:32 1354  	   END;
15:21:32 1355  	 END IF;
15:21:32 1356  
15:21:32 1357  	 out_charge_id := var_new_charge_id;
15:21:32 1358  
15:21:32 1359  EXCEPTION
15:21:32 1360  WHEN INVOICE_IS_NOT_CLOSED THEN
15:21:32 1361  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 1362  	   SPROC_NAME, 'Invoice is not closed');
15:21:32 1363  WHEN BAD_SUBSCRIPTION_ID THEN
15:21:32 1364  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1365  	   SPROC_NAME, 'No such subscription');
15:21:32 1366  WHEN ACCOUNT_IS_FROZEN THEN
15:21:32 1367  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 1368  	   SPROC_NAME, 'Could not refund subscription for frozen account');
15:21:32 1369  WHEN BAD_INVOICE_ID THEN
15:21:32 1370  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1371  	   SPROC_NAME, 'No such invoice');
15:21:32 1372  WHEN CAN_NOT_CALC_INVOICE_AMOUNT THEN
15:21:32 1373  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1374  	   SPROC_NAME, 'Could not calculate invoice amount', EXCEPTION_MESSAGE);
15:21:32 1375  WHEN REFUND_IS_GREATER_THAN_ANOUNT THEN
15:21:32 1376  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 1377  	   SPROC_NAME, 'Refund is greater than amount');
15:21:32 1378  WHEN TOT_REF_IS_GREATER_THAN_ANOUNT THEN
15:21:32 1379  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 1380  	   SPROC_NAME, 'There were refunds before and sum of all refunds and new refund more than invoice amount');
15:21:32 1381  WHEN TOT_REF_IS_GRATER_THAN_CHARGES THEN
15:21:32 1382  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 1383  	   SPROC_NAME, 'Total refund amount is greater than sum of processed charges');
15:21:32 1384  WHEN CAN_NOT_CREATE_TRANSACTION THEN
15:21:32 1385  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1386  	   SPROC_NAME, 'Could not create transaction', EXCEPTION_MESSAGE);
15:21:32 1387  WHEN CAN_NOT_CREATE_CHARGE THEN
15:21:32 1388  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1389  	   SPROC_NAME, 'Could not create charge', EXCEPTION_MESSAGE);
15:21:32 1390  WHEN CAN_NOT_ANNOTATE_SUBSCRIPTION THEN
15:21:32 1391  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1392  	   SPROC_NAME, 'Could not annotate subscription', EXCEPTION_MESSAGE);
15:21:32 1393  WHEN OTHERS THEN
15:21:32 1394  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1395  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1396  END REFUND_SUBSCRIPTION;
15:21:32 1397  
15:21:32 1398  /******************************************************************************/
15:21:32 1399  
15:21:32 1400  PROCEDURE ADD_SUBSCRIPTION_EXTENSION (
15:21:32 1401  /*
15:21:32 1402  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 1403  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:32 1404  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 1405  */
15:21:32 1406  	 in_subscription_id	 IN NUMBER,
15:21:32 1407  	 in_effective_start_date IN DATE,
15:21:32 1408  	 in_effective_end_date	 IN DATE,
15:21:32 1409  	 in_note		 IN VARCHAR2,
15:21:32 1410  	 in_updated_by		 IN VARCHAR2
15:21:32 1411  ) AS
15:21:32 1412  -- VARIABLES
15:21:32 1413  SPROC_NAME		    CONSTANT VARCHAR2(26) := 'ADD_SUBSCRIPTION_EXTENSION';
15:21:32 1414  temp_subscription_id	    NUMBER;
15:21:32 1415  var_current_license_id	    NUMBER;
15:21:32 1416  var_current_license_start_date DATE;
15:21:32 1417  var_current_license_end_date DATE;
15:21:32 1418  var_current_offer_id	    NUMBER;
15:21:32 1419  var_current_invoice_id	    NUMBER;
15:21:32 1420  var_current_date 	    DATE;
15:21:32 1421  var_current_offer_index	    NUMBER;
15:21:32 1422  var_current_offer_recurr_num NUMBER;
15:21:32 1423  var_account_tax_exempt_id    VARCHAR2(255);
15:21:32 1424  
15:21:32 1425  var_free_invoice_id NUMBER;
15:21:32 1426  var_free_license_id NUMBER;
15:21:32 1427  var_new_license_id  NUMBER;
15:21:32 1428  var_ext_license_id  NUMBER;
15:21:32 1429  -- EXCEPTIONS
15:21:32 1430  BAD_SUBSCRIPTION_ID	     EXCEPTION;
15:21:32 1431  CAN_NOT_FIND_OFFER_OR_LICENSE EXCEPTION;
15:21:32 1432  CAN_NOT_CHANGE_LICENSE_STATUS EXCEPTION;
15:21:32 1433  CAN_NOT_CREATE_INVOICE	     EXCEPTION;
15:21:32 1434  CAN_NOT_CREATE_NEW_LICENSE    EXCEPTION;
15:21:32 1435  CAN_NOT_CREATE_END_LICENSE    EXCEPTION;
15:21:32 1436  CAN_NOT_ANNOTATE_SUBSCRIPTION EXCEPTION;
15:21:32 1437  EXTENS_START_DATE_IS_TOO_FAR  EXCEPTION;
15:21:32 1438  EXT_START_DATE_LATER_THEN_END EXCEPTION;
15:21:32 1439  EXTENS_START_DATE_IS_TOO_SMALL EXCEPTION;
15:21:32 1440  EXCEPTION_MESSAGE	     VARCHAR2(1024);
15:21:32 1441  BEGIN
15:21:32 1442  
15:21:32 1443  	 var_current_date := PROCS_COMMON_V18.NORMALIZE_DATE(SYSDATE);
15:21:32 1444  
15:21:32 1445  	 -- Check that subscription exists
15:21:32 1446  	 BEGIN
15:21:32 1447  	   SELECT
15:21:32 1448  	     SUBSCRIPTION.ID into temp_subscription_id
15:21:32 1449  	   FROM
15:21:32 1450  	     SUBSCRIPTION
15:21:32 1451  	   WHERE
15:21:32 1452  	     SUBSCRIPTION.ID = in_subscription_id;
15:21:32 1453  	   EXCEPTION
15:21:32 1454  	     WHEN NO_DATA_FOUND THEN
15:21:32 1455  	       RAISE BAD_SUBSCRIPTION_ID;
15:21:32 1456  	 END;
15:21:32 1457  
15:21:32 1458  	 -- Get account tax exempt id
15:21:32 1459  	 SELECT DISTINCT
15:21:32 1460  	   ACCOUNT.TAX_EXEMPT_ID into var_account_tax_exempt_id
15:21:32 1461  	 FROM
15:21:32 1462  	   ACCOUNT
15:21:32 1463  	   INNER JOIN SUBSCRIPTION ON SUBSCRIPTION.ACCOUNT_ID = ACCOUNT.ID
15:21:32 1464  	 WHERE
15:21:32 1465  	   SUBSCRIPTION.ID = in_subscription_id;
15:21:32 1466  
15:21:32 1467  	 -- Select current data
15:21:32 1468  	 BEGIN
15:21:32 1469  	   SELECT
15:21:32 1470  	     LICENSE.ID,
15:21:32 1471  	     LICENSE.START_DATE,
15:21:32 1472  	     LICENSE.END_DATE,
15:21:32 1473  	     LICENSE.CURRENT_OFFER_INDEX,
15:21:32 1474  	     LICENSE.CURRENT_OFFER_RECURR_NUM,
15:21:32 1475  	     OFFER.ID,
15:21:32 1476  	     INVOICE.ID
15:21:32 1477  	   INTO
15:21:32 1478  	     var_current_license_id,
15:21:32 1479  	     var_current_license_start_date,
15:21:32 1480  	     var_current_license_end_date,
15:21:32 1481  	     var_current_offer_index,
15:21:32 1482  	     var_current_offer_recurr_num,
15:21:32 1483  	     var_current_offer_id,
15:21:32 1484  	     var_current_invoice_id
15:21:32 1485  	   FROM
15:21:32 1486  	     LICENSE
15:21:32 1487  	     INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
15:21:32 1488  	     INNER JOIN OFFER ON LICENSE.OFFER_ID = OFFER.ID
15:21:32 1489  	     INNER JOIN INVOICE ON LICENSE.INVOICE_ID = INVOICE.ID
15:21:32 1490  	   WHERE
15:21:32 1491  	     SUBSCRIPTION.ID = in_subscription_id
15:21:32 1492  	     AND PROCS_COMMON_V18.NORMALIZE_DATE(LICENSE.END_DATE) > var_current_date
15:21:32 1493  	     AND PROCS_COMMON_V18.NORMALIZE_DATE(LICENSE.START_DATE) <= var_current_date
15:21:32 1494  	     AND ROWNUM <= 1
15:21:32 1495  	   ORDER BY
15:21:32 1496  	     LICENSE.ID DESC;
15:21:32 1497  	   EXCEPTION
15:21:32 1498  	     WHEN NO_DATA_FOUND THEN
15:21:32 1499  	       RAISE CAN_NOT_FIND_OFFER_OR_LICENSE;
15:21:32 1500  	 END;
15:21:32 1501  
15:21:32 1502  	 IF var_current_license_end_date < in_effective_start_date THEN
15:21:32 1503  	   RAISE EXTENS_START_DATE_IS_TOO_FAR;
15:21:32 1504  	 END IF;
15:21:32 1505  
15:21:32 1506  	 IF var_current_license_start_date > in_effective_start_date THEN
15:21:32 1507  	   RAISE EXTENS_START_DATE_IS_TOO_SMALL;
15:21:32 1508  	 END IF;
15:21:32 1509  
15:21:32 1510  	 IF in_effective_start_date > in_effective_end_date THEN
15:21:32 1511  	   RAISE EXT_START_DATE_LATER_THEN_END;
15:21:32 1512  	 END IF;
15:21:32 1513  
15:21:32 1514  	 -- Closing curent license
15:21:32 1515  	 BEGIN
15:21:32 1516  	   PROCS_LICENSE_CRU_V18.UPDATE_LICENSE(
15:21:32 1517  	     in_license_id	   => var_current_license_id,
15:21:32 1518  	     in_updated_by	   => in_updated_by,
15:21:32 1519  	     in_license_status_id  => GLOBAL_STATUSES_V18.LICENSE_CLOSED,
15:21:32 1520  	     in_end_date	   => in_effective_start_date,
15:21:32 1521  	     in_needs_entitlements => GLOBAL_CONSTANTS_V18.TRUE
15:21:32 1522  	   );
15:21:32 1523  	   EXCEPTION
15:21:32 1524  	     WHEN OTHERS THEN
15:21:32 1525  	       EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1526  	       RAISE CAN_NOT_CHANGE_LICENSE_STATUS;
15:21:32 1527  	 END;
15:21:32 1528  
15:21:32 1529  	 -- Creating new "free" invoice
15:21:32 1530  	 BEGIN
15:21:32 1531  	   PROCS_INVOICE_V18.CREATE_INVOICE(
15:21:32 1532  	     in_invoice_status => GLOBAL_STATUSES_V18.INVOICE_CLOSED,
15:21:32 1533  	     in_created_by     => in_updated_by,
15:21:32 1534  	     in_tax_exempt_id  => var_account_tax_exempt_id,
15:21:32 1535  	     out_invoice_id    => var_free_invoice_id
15:21:32 1536  	   );
15:21:32 1537  	   EXCEPTION
15:21:32 1538  	     WHEN OTHERS THEN
15:21:32 1539  	       EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1540  	       RAISE CAN_NOT_CREATE_INVOICE;
15:21:32 1541  	 END;
15:21:32 1542  
15:21:32 1543  	 -- Creating new "free" license
15:21:32 1544  	 BEGIN
15:21:32 1545  	   PROCS_LICENSE_V18.CREATE_LICENSE (
15:21:32 1546  	     in_status_id		 => GLOBAL_STATUSES_V18.LICENSE_ACTIVE,
15:21:32 1547  	     in_needs_entitlements	 => GLOBAL_CONSTANTS_V18.TRUE,
15:21:32 1548  	     in_start_date		 => in_effective_start_date,
15:21:32 1549  	     in_end_date		 => in_effective_end_date,
15:21:32 1550  	     in_offer_id		 => var_current_offer_id,
15:21:32 1551  	     in_subscription_id 	 => in_subscription_id,
15:21:32 1552  	     in_invoice_id		 => var_free_invoice_id,
15:21:32 1553  	     in_created_by		 => in_updated_by,
15:21:32 1554  	     in_is_extension		 => GLOBAL_CONSTANTS_V18.TRUE,
15:21:32 1555  	     in_current_offer_index	 => var_current_offer_index,
15:21:32 1556  	     in_current_offer_recurr_num => var_current_offer_recurr_num,
15:21:32 1557  	     out_license_id		 => var_free_license_id
15:21:32 1558  	   );
15:21:32 1559  	   EXCEPTION
15:21:32 1560  	     WHEN OTHERS THEN
15:21:32 1561  	       EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1562  	       RAISE CAN_NOT_CREATE_NEW_LICENSE;
15:21:32 1563  	 END;
15:21:32 1564  
15:21:32 1565  	 -- Creating new license
15:21:32 1566  	 IF PROCS_COMMON_V18.NORMALIZE_DATE(var_current_license_end_date) >
15:21:32 1567  	    PROCS_COMMON_V18.NORMALIZE_DATE(in_effective_start_date) THEN
15:21:32 1568  	   BEGIN
15:21:32 1569  	     PROCS_LICENSE_V18.CREATE_LICENSE (
15:21:32 1570  	       in_status_id		   => GLOBAL_STATUSES_V18.LICENSE_ACTIVE,
15:21:32 1571  	       in_needs_entitlements	   => GLOBAL_CONSTANTS_V18.TRUE,
15:21:32 1572  	       in_start_date		   => in_effective_end_date,
15:21:32 1573  	       in_end_date		   => var_current_license_end_date + (in_effective_end_date - in_effective_start_date),
15:21:32 1574  	       in_offer_id		   => var_current_offer_id,
15:21:32 1575  	       in_subscription_id	   => in_subscription_id,
15:21:32 1576  	       in_invoice_id		   => var_current_invoice_id,
15:21:32 1577  	       in_created_by		   => in_updated_by,
15:21:32 1578  	       in_is_extension		   => GLOBAL_CONSTANTS_V18.FALSE,
15:21:32 1579  	       in_current_offer_index	   => var_current_offer_index,
15:21:32 1580  	       in_current_offer_recurr_num => var_current_offer_recurr_num,
15:21:32 1581  	       out_license_id		   => var_ext_license_id
15:21:32 1582  	     );
15:21:32 1583  	     EXCEPTION
15:21:32 1584  	       WHEN OTHERS THEN
15:21:32 1585  		 EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1586  		 RAISE CAN_NOT_CREATE_END_LICENSE;
15:21:32 1587  	   END;
15:21:32 1588  	 END IF;
15:21:32 1589  
15:21:32 1590  	 -- Create new note for subscription
15:21:32 1591  	 BEGIN
15:21:32 1592  	   PROCS_SUBSCRIPTION_V18.ANNOTATE_SUBSCRIPTION (
15:21:32 1593  	     in_subscription_id => in_subscription_id,
15:21:32 1594  	     in_agent_id	=> 0, -- FIXME: What should to be here (agent id)?
15:21:32 1595  	     in_note		=> in_note,
15:21:32 1596  	     in_created_by	=> in_updated_by
15:21:32 1597  	   );
15:21:32 1598  	   EXCEPTION
15:21:32 1599  	     WHEN OTHERS THEN
15:21:32 1600  	       EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1601  	       RAISE CAN_NOT_ANNOTATE_SUBSCRIPTION;
15:21:32 1602  	 END;
15:21:32 1603  
15:21:32 1604  EXCEPTION
15:21:32 1605  WHEN EXT_START_DATE_LATER_THEN_END THEN
15:21:32 1606  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 1607  	   SPROC_NAME, 'Extension start date is bigger then end date');
15:21:32 1608  WHEN EXTENS_START_DATE_IS_TOO_FAR THEN
15:21:32 1609  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 1610  	   SPROC_NAME, 'Extension start date is too far');
15:21:32 1611  WHEN EXTENS_START_DATE_IS_TOO_SMALL THEN
15:21:32 1612  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 1613  	   SPROC_NAME, 'Extension start date is too small');
15:21:32 1614  WHEN BAD_SUBSCRIPTION_ID THEN
15:21:32 1615  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1616  	   SPROC_NAME, 'No such subscription');
15:21:32 1617  WHEN CAN_NOT_FIND_OFFER_OR_LICENSE THEN
15:21:32 1618  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1619  	   SPROC_NAME, 'Could not find license and/or offer for given subscription');
15:21:32 1620  WHEN CAN_NOT_CHANGE_LICENSE_STATUS THEN
15:21:32 1621  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1622  	   SPROC_NAME, 'Could not change license status', EXCEPTION_MESSAGE);
15:21:32 1623  WHEN CAN_NOT_CREATE_INVOICE THEN
15:21:32 1624  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1625  	   SPROC_NAME, 'Could not create new invoice', EXCEPTION_MESSAGE);
15:21:32 1626  WHEN CAN_NOT_CREATE_NEW_LICENSE THEN
15:21:32 1627  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1628  	   SPROC_NAME, 'Could not create new license', EXCEPTION_MESSAGE);
15:21:32 1629  WHEN CAN_NOT_CREATE_END_LICENSE THEN
15:21:32 1630  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1631  	   SPROC_NAME, 'Could not create last license', EXCEPTION_MESSAGE);
15:21:32 1632  WHEN CAN_NOT_ANNOTATE_SUBSCRIPTION THEN
15:21:32 1633  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1634  	   SPROC_NAME, 'Could not create new note for subscription', EXCEPTION_MESSAGE);
15:21:32 1635  WHEN OTHERS THEN
15:21:32 1636  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1637  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1638  END ADD_SUBSCRIPTION_EXTENSION;
15:21:32 1639  
15:21:32 1640  /******************************************************************************/
15:21:32 1641  
15:21:32 1642  FUNCTION CALC_SUBSCRIPTION_END_DATE (
15:21:32 1643  /*
15:21:32 1644  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 1645  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:32 1646  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 1647  Returns:
15:21:32 1648  NULL if it is impossible to calculate end date (for example,
15:21:32 1649  	 offer chain includes offer with infinity recurrences number)
15:21:32 1650  DATE else
15:21:32 1651  */
15:21:32 1652  	 in_subscription_id IN NUMBER
15:21:32 1653  ) RETURN DATE AS
15:21:32 1654  -- VARIABLES
15:21:32 1655  SPROC_NAME		     CONSTANT VARCHAR2(26) := 'CALC_SUBSCRIPTION_END_DATE';
15:21:32 1656  last_license_id		     NUMBER;
15:21:32 1657  last_license_end_date	     DATE;
15:21:32 1658  last_license_offer_id	     NUMBER;
15:21:32 1659  last_license_offer_index      NUMBER;
15:21:32 1660  last_license_offer_recurr_num NUMBER;
15:21:32 1661  var_last_license_id	     NUMBER;
15:21:32 1662  var_offer_chain_id	     NUMBER;
15:21:32 1663  var_current_offer_rec_number  NUMBER;
15:21:32 1664  var_next_offers_set	     SYS_REFCURSOR;
15:21:32 1665  var_next_offer_duration	     VARCHAR2(30);
15:21:32 1666  var_next_offer_recur	     NUMBER;
15:21:32 1667  var_infinity_offers_number    NUMBER;
15:21:32 1668  
15:21:32 1669  var_result_date DATE;
15:21:32 1670  
15:21:32 1671  var_ym_interval	INTERVAL YEAR TO MONTH;
15:21:32 1672  var_ds_interval	INTERVAL DAY(3) TO SECOND;
15:21:32 1673  var_offer_years	NUMBER;
15:21:32 1674  var_offer_months NUMBER;
15:21:32 1675  var_offer_days	NUMBER;
15:21:32 1676  
15:21:32 1677  -- EXCEPTIONS
15:21:32 1678  BAD_SUBSCRIPTION_ID	  EXCEPTION;
15:21:32 1679  CAN_NOT_FIND_LAST_LICENSE  EXCEPTION;
15:21:32 1680  CAN_NOT_CALC_OFFER_LENGTH  EXCEPTION;
15:21:32 1681  CAN_NOT_CALC_OFFER_LENGTH2 EXCEPTION;
15:21:32 1682  EXCEPTION_MESSAGE	  VARCHAR2(1024);
15:21:32 1683  BEGIN
15:21:32 1684  
15:21:32 1685  	 BEGIN
15:21:32 1686  	   SELECT
15:21:32 1687  	     SUBSCRIPTION.OFFER_CHAIN_ID into var_offer_chain_id
15:21:32 1688  	   FROM
15:21:32 1689  	     SUBSCRIPTION
15:21:32 1690  	   WHERE
15:21:32 1691  	     SUBSCRIPTION.ID = in_subscription_id;
15:21:32 1692  	   EXCEPTION
15:21:32 1693  	     WHEN NO_DATA_FOUND THEN
15:21:32 1694  	       RAISE BAD_SUBSCRIPTION_ID;
15:21:32 1695  	 END;
15:21:32 1696  
15:21:32 1697  	 BEGIN
15:21:32 1698  	   SELECT
15:21:32 1699  	     ID into var_last_license_id
15:21:32 1700  	   FROM
15:21:32 1701  	     (
15:21:32 1702  	       SELECT
15:21:32 1703  		 LICENSE.ID
15:21:32 1704  	       FROM
15:21:32 1705  		 LICENSE
15:21:32 1706  	       WHERE
15:21:32 1707  		 LICENSE.SUBSCRIPTION_ID = in_subscription_id
15:21:32 1708  	       ORDER BY
15:21:32 1709  		 LICENSE.END_DATE DESC
15:21:32 1710  	     )
15:21:32 1711  	   WHERE
15:21:32 1712  	     ROWNUM <= 1;
15:21:32 1713  	   EXCEPTION
15:21:32 1714  	     WHEN NO_DATA_FOUND THEN
15:21:32 1715  	       RAISE CAN_NOT_FIND_LAST_LICENSE;
15:21:32 1716  	 END;
15:21:32 1717  
15:21:32 1718  	 SELECT
15:21:32 1719  	   COUNT(*) into var_infinity_offers_number
15:21:32 1720  	 FROM
15:21:32 1721  	   OFFER_OFFER_CHAIN
15:21:32 1722  	 WHERE
15:21:32 1723  	   OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = var_offer_chain_id
15:21:32 1724  	   AND OFFER_OFFER_CHAIN.NUM_RECURRENCES = GLOBAL_ENUMS_V18.OFFER_REC_INFINITY;
15:21:32 1725  
15:21:32 1726  	 IF var_infinity_offers_number > 0 THEN
15:21:32 1727  	   RETURN NULL;
15:21:32 1728  	 END IF;
15:21:32 1729  
15:21:32 1730  	 BEGIN
15:21:32 1731  	   SELECT
15:21:32 1732  	     LICENSE.ID,
15:21:32 1733  	     LICENSE.END_DATE,
15:21:32 1734  	     LICENSE.CURRENT_OFFER_INDEX,
15:21:32 1735  	     LICENSE.CURRENT_OFFER_RECURR_NUM,
15:21:32 1736  	     LICENSE.OFFER_ID
15:21:32 1737  	     into
15:21:32 1738  	     last_license_id,
15:21:32 1739  	     last_license_end_date,
15:21:32 1740  	     last_license_offer_index,
15:21:32 1741  	     last_license_offer_recurr_num,
15:21:32 1742  	     last_license_offer_id
15:21:32 1743  	   FROM
15:21:32 1744  	     LICENSE
15:21:32 1745  	   WHERE
15:21:32 1746  	     LICENSE.ID = var_last_license_id;
15:21:32 1747  	   EXCEPTION
15:21:32 1748  	     WHEN NO_DATA_FOUND THEN
15:21:32 1749  	       RAISE CAN_NOT_FIND_LAST_LICENSE;
15:21:32 1750  	 END;
15:21:32 1751  
15:21:32 1752  	 var_result_date := last_license_end_date;
15:21:32 1753  
15:21:32 1754  	 -- Find current recurrence number
15:21:32 1755  	 SELECT
15:21:32 1756  	   OFFER_OFFER_CHAIN.NUM_RECURRENCES into var_current_offer_rec_number
15:21:32 1757  	 FROM
15:21:32 1758  	   OFFER_OFFER_CHAIN
15:21:32 1759  	 WHERE
15:21:32 1760  	   OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = var_offer_chain_id
15:21:32 1761  	   AND OFFER_OFFER_CHAIN.OFFER_ID = last_license_offer_id
15:21:32 1762  	   AND OFFER_OFFER_CHAIN.INDEX_VALUE = last_license_offer_index;
15:21:32 1763  
15:21:32 1764  	 IF var_current_offer_rec_number > last_license_offer_recurr_num THEN
15:21:32 1765  	   BEGIN
15:21:32 1766  	     PROCS_OFFER_CHAIN_V18.GET_OFFER_LENGTH(
15:21:32 1767  	       last_license_offer_id,
15:21:32 1768  	       var_offer_years,
15:21:32 1769  	       var_offer_months,
15:21:32 1770  	       var_offer_days
15:21:32 1771  	     );
15:21:32 1772  
15:21:32 1773  	     var_ym_interval := var_offer_years||'-'||var_offer_months;
15:21:32 1774  	     var_ds_interval := var_offer_days||' 0:0:0';
15:21:32 1775  
15:21:32 1776  	     var_result_date := var_result_date
15:21:32 1777  	       + ( var_ym_interval * ( var_current_offer_rec_number - last_license_offer_recurr_num ) )
15:21:32 1778  	       + ( var_ds_interval * ( var_current_offer_rec_number - last_license_offer_recurr_num ) );
15:21:32 1779  	     EXCEPTION
15:21:32 1780  	       WHEN OTHERS THEN
15:21:32 1781  		 EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1782  		 RAISE CAN_NOT_CALC_OFFER_LENGTH;
15:21:32 1783  	   END;
15:21:32 1784  	 END IF;
15:21:32 1785  
15:21:32 1786  	 OPEN var_next_offers_set FOR
15:21:32 1787  	 SELECT
15:21:32 1788  	   OFFER.ENTITLEMENT_DURATION,
15:21:32 1789  	   OFFER_OFFER_CHAIN.NUM_RECURRENCES
15:21:32 1790  	 FROM
15:21:32 1791  	   OFFER_OFFER_CHAIN
15:21:32 1792  	   INNER JOIN OFFER ON OFFER_OFFER_CHAIN.OFFER_ID = OFFER.ID
15:21:32 1793  	 WHERE
15:21:32 1794  	   OFFER_OFFER_CHAIN.INDEX_VALUE > last_license_offer_index
15:21:32 1795  	   AND OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = var_offer_chain_id;
15:21:32 1796  
15:21:32 1797  	 LOOP
15:21:32 1798  	   FETCH var_next_offers_set into var_next_offer_duration, var_next_offer_recur;
15:21:32 1799  	   EXIT WHEN var_next_offers_set%NOTFOUND;
15:21:32 1800  	   BEGIN
15:21:32 1801  	     PROCS_COMMON_V18.ISO8601DURATION_TO_INTERVALS(
15:21:32 1802  	       var_next_offer_duration,
15:21:32 1803  	       var_offer_years,
15:21:32 1804  	       var_offer_months,
15:21:32 1805  	       var_offer_days
15:21:32 1806  	     );
15:21:32 1807  
15:21:32 1808  	     var_ym_interval := var_offer_years||'-'||var_offer_months;
15:21:32 1809  	     var_ds_interval := var_offer_days||' 0:0:0';
15:21:32 1810  
15:21:32 1811  	     var_result_date := var_result_date
15:21:32 1812  	       + ( var_ym_interval * var_next_offer_recur )
15:21:32 1813  	       + ( var_ds_interval * var_next_offer_recur );
15:21:32 1814  	     EXCEPTION
15:21:32 1815  	       WHEN OTHERS THEN
15:21:32 1816  		 EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1817  		 RAISE CAN_NOT_CALC_OFFER_LENGTH2;
15:21:32 1818  	   END;
15:21:32 1819  	 END LOOP;
15:21:32 1820  
15:21:32 1821  	 RETURN var_result_date;
15:21:32 1822  
15:21:32 1823  EXCEPTION
15:21:32 1824  WHEN BAD_SUBSCRIPTION_ID THEN
15:21:32 1825  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1826  	   SPROC_NAME, 'No such subscription');
15:21:32 1827  WHEN CAN_NOT_FIND_LAST_LICENSE THEN
15:21:32 1828  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1829  	   SPROC_NAME, 'Could not find last license for given subscription');
15:21:32 1830  WHEN CAN_NOT_CALC_OFFER_LENGTH THEN
15:21:32 1831  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1832  	   SPROC_NAME, 'Could not calculate offer length', EXCEPTION_MESSAGE);
15:21:32 1833  WHEN CAN_NOT_CALC_OFFER_LENGTH2 THEN
15:21:32 1834  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1835  	   SPROC_NAME, 'Could not calculate last offer length', EXCEPTION_MESSAGE);
15:21:32 1836  WHEN OTHERS THEN
15:21:32 1837  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1838  	   SPROC_NAME, 'Unkown error', SQLERRM);
15:21:32 1839  END CALC_SUBSCRIPTION_END_DATE;
15:21:32 1840  
15:21:32 1841  /******************************************************************************/
15:21:32 1842  
15:21:32 1843  PROCEDURE HAS_FUTURE_LICENSE (
15:21:32 1844  /*
15:21:32 1845  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 1846  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 1847  --
15:21:32 1848  RETURNS:
15:21:32 1849  GLOBAL_CONSTANTS_V18.TRUE - if has,
15:21:32 1850  GLOBAL_CONSTANTS_V18.FALSE - else
15:21:32 1851  */
15:21:32 1852  	 in_license_id IN  NUMBER,
15:21:32 1853  	 out_result    OUT NUMBER
15:21:32 1854  ) AS
15:21:32 1855  -- VARIABLES
15:21:32 1856  SPROC_NAME		 CONSTANT VARCHAR2(18) := 'HAS_FUTURE_LICENSE';
15:21:32 1857  var_subscription_id	 NUMBER;
15:21:32 1858  var_future_licenses_count NUMBER;
15:21:32 1859  -- EXCEPTIONS
15:21:32 1860  BAD_LICENSE_ID	    EXCEPTION;
15:21:32 1861  BEGIN
15:21:32 1862  
15:21:32 1863  	 BEGIN
15:21:32 1864  	   SELECT
15:21:32 1865  	     LICENSE.SUBSCRIPTION_ID into var_subscription_id
15:21:32 1866  	   FROM
15:21:32 1867  	     LICENSE
15:21:32 1868  	   WHERE
15:21:32 1869  	     LICENSE.ID = in_license_id;
15:21:32 1870  	   EXCEPTION
15:21:32 1871  	     WHEN NO_DATA_FOUND THEN
15:21:32 1872  	       RAISE BAD_LICENSE_ID;
15:21:32 1873  	 END;
15:21:32 1874  
15:21:32 1875  	 SELECT
15:21:32 1876  	   COUNT(*) into var_future_licenses_count
15:21:32 1877  	 FROM
15:21:32 1878  	   LICENSE
15:21:32 1879  	 WHERE
15:21:32 1880  	   LICENSE.ID != in_license_id
15:21:32 1881  	   AND LICENSE.SUBSCRIPTION_ID = var_subscription_id
15:21:32 1882  	   AND LICENSE.END_DATE > sysdate;
15:21:32 1883  
15:21:32 1884  	 IF var_future_licenses_count > 0 THEN
15:21:32 1885  	   out_result := GLOBAL_CONSTANTS_V18.TRUE;
15:21:32 1886  	 ELSE
15:21:32 1887  	   out_result := GLOBAL_CONSTANTS_V18.FALSE;
15:21:32 1888  	 END IF;
15:21:32 1889  
15:21:32 1890  EXCEPTION
15:21:32 1891  WHEN BAD_LICENSE_ID THEN
15:21:32 1892  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1893  	   SPROC_NAME, 'No such license');
15:21:32 1894  WHEN OTHERS THEN
15:21:32 1895  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1896  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1897  END HAS_FUTURE_LICENSE;
15:21:32 1898  
15:21:32 1899  /******************************************************************************/
15:21:32 1900  
15:21:32 1901  PROCEDURE CLOSE_SUBSCRIPTION (
15:21:32 1902  	 in_subscription_id IN NUMBER,
15:21:32 1903  	 in_updated_by	    IN VARCHAR2
15:21:32 1904  ) AS
15:21:32 1905  -- VARIABLES
15:21:32 1906  SPROC_NAME	    CONSTANT VARCHAR2(18) := 'CLOSE_SUBSCRIPTION';
15:21:32 1907  temp_subscription_id NUMBER;
15:21:32 1908  var_licenses_count   NUMBER;
15:21:32 1909  -- EXCEPTIONS
15:21:32 1910  BAD_SUBSCRIPTION_ID    EXCEPTION;
15:21:32 1911  ACTIVE_LICENSES_FOUND  EXCEPTION;
15:21:32 1912  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:32 1913  BEGIN
15:21:32 1914  
15:21:32 1915  	 BEGIN
15:21:32 1916  	   SELECT
15:21:32 1917  	     SUBSCRIPTION.ID into temp_subscription_id
15:21:32 1918  	   FROM
15:21:32 1919  	     SUBSCRIPTION
15:21:32 1920  	   WHERE
15:21:32 1921  	     SUBSCRIPTION.ID = in_subscription_id;
15:21:32 1922  	   EXCEPTION
15:21:32 1923  	     WHEN NO_DATA_FOUND THEN
15:21:32 1924  	       RAISE BAD_SUBSCRIPTION_ID;
15:21:32 1925  	 END;
15:21:32 1926  
15:21:32 1927  	 SELECT
15:21:32 1928  	   COUNT(*) into var_licenses_count
15:21:32 1929  	 FROM
15:21:32 1930  	   LICENSE
15:21:32 1931  	 WHERE
15:21:32 1932  	   LICENSE.SUBSCRIPTION_ID = in_subscription_id
15:21:32 1933  	   AND LICENSE.LICENSE_STATUS_ID = GLOBAL_STATUSES_V18.LICENSE_ACTIVE;
15:21:32 1934  
15:21:32 1935  	 IF var_licenses_count > 0 THEN
15:21:32 1936  	   RAISE ACTIVE_LICENSES_FOUND;
15:21:32 1937  	 END IF;
15:21:32 1938  
15:21:32 1939  	 PROCS_SUBSCRIPTION_V18.UPDATE_SUBSCRIPTION_STATUS(
15:21:32 1940  	   in_subscription_id	     => in_subscription_id,
15:21:32 1941  	   in_updated_by	     => in_updated_by,
15:21:32 1942  	   in_subscription_status_id => GLOBAL_STATUSES_V18.SUBSCRIPTION_CLOSED
15:21:32 1943  	 );
15:21:32 1944  
15:21:32 1945  EXCEPTION
15:21:32 1946  WHEN BAD_SUBSCRIPTION_ID THEN
15:21:32 1947  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1948  	   SPROC_NAME, 'No such subscription');
15:21:32 1949  WHEN ACTIVE_LICENSES_FOUND THEN
15:21:32 1950  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 1951  	   SPROC_NAME, 'Active licenses found');
15:21:32 1952  WHEN OTHERS THEN
15:21:32 1953  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1954  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1955  END CLOSE_SUBSCRIPTION;
15:21:32 1956  
15:21:32 1957  /******************************************************************************/
15:21:32 1958  
15:21:32 1959  PROCEDURE GET_GROUP_ID_BY_SBSCRPTN_ID (
15:21:32 1960  	 in_subscription_id IN NUMBER,
15:21:32 1961  	 out_group_id	    OUT NUMBER
15:21:32 1962  ) AS
15:21:32 1963  SPROC_NAME CONSTANT VARCHAR2(27) := 'GET_GROUP_ID_BY_SBSCRPTN_ID';
15:21:32 1964  BEGIN
15:21:32 1965  	 SELECT
15:21:32 1966  	   ACCOUNT.GROUP_ID into out_group_id
15:21:32 1967  	 FROM
15:21:32 1968  	   SUBSCRIPTION
15:21:32 1969  	   INNER JOIN ACCOUNT ON SUBSCRIPTION.ACCOUNT_ID = ACCOUNT.ID
15:21:32 1970  	 WHERE
15:21:32 1971  	   SUBSCRIPTION.ID = in_subscription_id;
15:21:32 1972  EXCEPTION
15:21:32 1973  WHEN NO_DATA_FOUND THEN
15:21:32 1974  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1975  	   SPROC_NAME, 'No such subscription');
15:21:32 1976  WHEN OTHERS THEN
15:21:32 1977  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1978  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1979  END GET_GROUP_ID_BY_SBSCRPTN_ID;
15:21:32 1980  
15:21:32 1981  /******************************************************************************/
15:21:32 1982  
15:21:32 1983  PROCEDURE GET_SUBSCRIPTION_PRODUCTS (
15:21:32 1984  /*
15:21:32 1985  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 1986  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 1987  */
15:21:32 1988  	 in_subscription_id IN NUMBER,
15:21:32 1989  	 out_result_set     OUT SYS_REFCURSOR
15:21:32 1990  ) AS
15:21:32 1991  SPROC_NAME CONSTANT VARCHAR2(25) := 'GET_SUBSCRIPTION_PRODUCTS';
15:21:32 1992  -- VARIABLES
15:21:32 1993  var_offer_chain NUMBER;
15:21:32 1994  -- EXCEPTIONS
15:21:32 1995  BAD_SUBSCRIPTION_ID EXCEPTION;
15:21:32 1996  BEGIN
15:21:32 1997  	 BEGIN
15:21:32 1998  	   SELECT
15:21:32 1999  	     SUBSCRIPTION.OFFER_CHAIN_ID into var_offer_chain
15:21:32 2000  	   FROM
15:21:32 2001  	     SUBSCRIPTION
15:21:32 2002  	   WHERE
15:21:32 2003  	     SUBSCRIPTION.ID = in_subscription_id;
15:21:32 2004  	   EXCEPTION
15:21:32 2005  	     WHEN NO_DATA_FOUND THEN
15:21:32 2006  	       RAISE BAD_SUBSCRIPTION_ID;
15:21:32 2007  	 END;
15:21:32 2008  
15:21:32 2009  	 OPEN out_result_set FOR
15:21:32 2010  	 SELECT DISTINCT
15:21:32 2011  	   PRODUCT.ID,
15:21:32 2012  	   PRODUCT.NAME
15:21:32 2013  	 FROM
15:21:32 2014  	   PRODUCT
15:21:32 2015  	 WHERE
15:21:32 2016  	   PRODUCT.ID IN (
15:21:32 2017  	     SELECT DISTINCT
15:21:32 2018  	       PRODUCT_OFFERING.PRODUCT_ID
15:21:32 2019  	     FROM
15:21:32 2020  	       PRODUCT_OFFERING
15:21:32 2021  	     WHERE
15:21:32 2022  	       PRODUCT_OFFERING.ID IN (
15:21:32 2023  		 SELECT DISTINCT
15:21:32 2024  		   OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID
15:21:32 2025  		 FROM
15:21:32 2026  		   OFFER_PRODUCT_OFFERING
15:21:32 2027  		 WHERE
15:21:32 2028  		   OFFER_PRODUCT_OFFERING.OFFER_ID IN (
15:21:32 2029  		     SELECT DISTINCT
15:21:32 2030  		       OFFER_OFFER_CHAIN.OFFER_ID
15:21:32 2031  		     FROM
15:21:32 2032  		       OFFER_OFFER_CHAIN
15:21:32 2033  		     WHERE
15:21:32 2034  		       OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = var_offer_chain
15:21:32 2035  		   )
15:21:32 2036  	       )
15:21:32 2037  	   );
15:21:32 2038  
15:21:32 2039  EXCEPTION
15:21:32 2040  WHEN BAD_SUBSCRIPTION_ID THEN
15:21:32 2041  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2042  	   SPROC_NAME, 'No such subscription');
15:21:32 2043  WHEN OTHERS THEN
15:21:32 2044  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2045  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2046  END GET_SUBSCRIPTION_PRODUCTS;
15:21:32 2047  
15:21:32 2048  /******************************************************************************/
15:21:32 2049  
15:21:32 2050  PROCEDURE UPDATE_SUBSCRIPTION_STATUS (
15:21:32 2051  	 in_subscription_id	   IN SUBSCRIPTION.ID%TYPE,
15:21:32 2052  	 in_subscription_status_id IN SUBSCRIPTION.SUBSCRIPTION_STATUS_ID%TYPE,
15:21:32 2053  	 in_updated_by		   IN SUBSCRIPTION.UPDATED_BY%TYPE
15:21:32 2054  ) AS
15:21:32 2055  SPROC_NAME CONSTANT VARCHAR2(26) := 'UPDATE_SUBSCRIPTION_STATUS';
15:21:32 2056  BEGIN
15:21:32 2057  	 PROCS_SUBSCRIPTION_CRU_V18.UPDATE_SUBSCRIPTION(
15:21:32 2058  	   in_subscription_id	     => in_subscription_id,
15:21:32 2059  	   in_subscription_status_id => in_subscription_status_id,
15:21:32 2060  	   in_updated_by	     => in_updated_by
15:21:32 2061  	 );
15:21:32 2062  END UPDATE_SUBSCRIPTION_STATUS;
15:21:32 2063  
15:21:32 2064  /******************************************************************************/
15:21:32 2065  
15:21:32 2066  PROCEDURE GET_ACTIVE_INVOICES_IDS (
15:21:32 2067  /*
15:21:32 2068  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 2069  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 2070  */
15:21:32 2071  --  in_subscription_id IN SUBSCRIPTION.ID%TYPE,
15:21:32 2072  	 in_subscription_id IN NUMBER,
15:21:32 2073  	 out_result_set     OUT SYS_REFCURSOR
15:21:32 2074  ) AS
15:21:32 2075  SPROC_NAME CONSTANT VARCHAR2(23) := 'GET_ACTIVE_INVOICES_IDS';
15:21:32 2076  -- VARIABLES
15:21:32 2077  temp_subscription_id SUBSCRIPTION.ID%TYPE;
15:21:32 2078  -- EXCEPTIONS
15:21:32 2079  BAD_SUBSCRIPTION_ID EXCEPTION;
15:21:32 2080  BEGIN
15:21:32 2081  
15:21:32 2082  	 BEGIN
15:21:32 2083  	   SELECT
15:21:32 2084  	     SUBSCRIPTION.ID into temp_subscription_id
15:21:32 2085  	   FROM
15:21:32 2086  	     SUBSCRIPTION
15:21:32 2087  	   WHERE
15:21:32 2088  	     SUBSCRIPTION.ID = in_subscription_id;
15:21:32 2089  	   EXCEPTION
15:21:32 2090  	     WHEN NO_DATA_FOUND THEN
15:21:32 2091  	       RAISE BAD_SUBSCRIPTION_ID;
15:21:32 2092  	 END;
15:21:32 2093  
15:21:32 2094  	 OPEN out_result_set FOR
15:21:32 2095  	 SELECT DISTINCT
15:21:32 2096  	   LICENSE.INVOICE_ID as "ID"
15:21:32 2097  	 FROM
15:21:32 2098  	   LICENSE
15:21:32 2099  	 WHERE
15:21:32 2100  	   LICENSE.LICENSE_STATUS_ID in (GLOBAL_STATUSES_V18.LICENSE_ACTIVE, GLOBAL_STATUSES_V18.LICENSE_IN_GRACE_PERIOD)
15:21:32 2101  	   AND LICENSE.SUBSCRIPTION_ID = in_subscription_id;
15:21:32 2102  
15:21:32 2103  EXCEPTION
15:21:32 2104  WHEN BAD_SUBSCRIPTION_ID THEN
15:21:32 2105  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2106  	   SPROC_NAME, 'No such subscription');
15:21:32 2107  WHEN OTHERS THEN
15:21:32 2108  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2109  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2110  END GET_ACTIVE_INVOICES_IDS;
15:21:32 2111  
15:21:32 2112  /******************************************************************************/
15:21:32 2113  
15:21:32 2114  PROCEDURE CANCEL_SUBSCRIPTION_INVOICE (
15:21:32 2115  /*
15:21:32 2116  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 2117  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 2118  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:32 2119  */
15:21:32 2120  	 in_invoice_id	      IN NUMBER,
15:21:32 2121  	 in_updated_by	      IN VARCHAR2,
15:21:32 2122  	 in_refundable	      IN NUMBER DEFAULT GLOBAL_CONSTANTS_V18.FALSE
15:21:32 2123  ) AS
15:21:32 2124  SPROC_NAME CONSTANT VARCHAR2(27) := 'CANCEL_SUBSCRIPTION_INVOICE';
15:21:32 2125  -- VARIABLES
15:21:32 2126  temp_invoice_id	      INVOICE.ID%TYPE;
15:21:32 2127  var_chargeback_amount  NUMBER(10,2);
15:21:32 2128  ver_refund_charge_id   NUMBER;
15:21:32 2129  -- EXCEPTIONS
15:21:32 2130  BAD_INVOICE_ID		    EXCEPTION;
15:21:32 2131  CAN_NOT_CALCULATE_CHARGEBACK EXCEPTION;
15:21:32 2132  CAN_NOT_APPLY_CHARGEBACK     EXCEPTION;
15:21:32 2133  EXCEPTION_MESSAGE	    VARCHAR2(1024);
15:21:32 2134  -- STUB
15:21:32 2135  var_now DATE;
15:21:32 2136  var_revoke NUMBER;
15:21:32 2137  var_refund NUMBER;
15:21:32 2138  var_billed NUMBER;
15:21:32 2139  var_subscription_in_grace NUMBER;
15:21:32 2140  BEGIN
15:21:32 2141  
15:21:32 2142  	 var_now := sysdate;
15:21:32 2143  
15:21:32 2144  	 -- Check that invoice exists
15:21:32 2145  	 BEGIN
15:21:32 2146  	   SELECT
15:21:32 2147  	     INVOICE.ID into temp_invoice_id
15:21:32 2148  	   FROM
15:21:32 2149  	     INVOICE
15:21:32 2150  	   WHERE
15:21:32 2151  	     INVOICE.ID = in_invoice_id;
15:21:32 2152  	   EXCEPTION
15:21:32 2153  	     WHEN NO_DATA_FOUND THEN
15:21:32 2154  	       RAISE BAD_INVOICE_ID;
15:21:32 2155  	 END;
15:21:32 2156  
15:21:32 2157  	 select decode(count(1), 0, GLOBAL_CONSTANTS_V18.FALSE, GLOBAL_CONSTANTS_V18.TRUE) into var_revoke
15:21:32 2158  	 from license l, subscription s, offer_chain oc
15:21:32 2159  	 where
15:21:32 2160  	   l.subscription_id = s.id and
15:21:32 2161  	   s.offer_chain_id = oc.id and
15:21:32 2162  	   l.invoice_id = in_invoice_id and
15:21:32 2163  	   oc.revoke_entitlements = GLOBAL_CONSTANTS_V18.TRUE and
15:21:32 2164  	   rownum < 2;
15:21:32 2165  
15:21:32 2166  	 select
15:21:32 2167  	   decode(s.subscription_status_id, GLOBAL_STATUSES_V18.SUBSCRIPTION_IN_GRACE_PERIOD, 1, 0)
15:21:32 2168  	 into
15:21:32 2169  	   var_subscription_in_grace
15:21:32 2170  	 from license l, subscription s
15:21:32 2171  	 where
15:21:32 2172  	   l.subscription_id = s.id and
15:21:32 2173  	   l.invoice_id = in_invoice_id and
15:21:32 2174  	   rownum < 2;
15:21:32 2175  
15:21:32 2176  	 var_billed := PROCS_INVOICE_V18.IS_INVOICE_PAYING_STARTED(in_invoice_id);
15:21:32 2177  	 var_refund := GLOBAL_CONSTANTS_V18.FALSE;
15:21:32 2178  
15:21:32 2179  	 -- Check that transaction for given invoice not started
15:21:32 2180  	 -- if refund enabled calculate and apply chargeback
15:21:32 2181  	 IF (
15:21:32 2182  	     var_billed = GLOBAL_CONSTANTS_V18.TRUE
15:21:32 2183  	   )THEN
15:21:32 2184  	   if (in_refundable = GLOBAL_CONSTANTS_V18.TRUE) then
15:21:32 2185  	     -- If started then we need to calculate refund
15:21:32 2186  	     BEGIN
15:21:32 2187  	       PROCS_INVOICE_V18.CALCULATE_INVOICE_CHARGEBACK(
15:21:32 2188  		 in_invoice_id,
15:21:32 2189  		 var_now,
15:21:32 2190  		 var_chargeback_amount
15:21:32 2191  	       );
15:21:32 2192  	       EXCEPTION
15:21:32 2193  		 WHEN OTHERS THEN
15:21:32 2194  		   EXCEPTION_MESSAGE := SQLERRM;
15:21:32 2195  		   RAISE CAN_NOT_CALCULATE_CHARGEBACK;
15:21:32 2196  	     END;
15:21:32 2197  	     IF var_chargeback_amount > 0 THEN
15:21:32 2198  	       BEGIN
15:21:32 2199  		 PROCS_INVOICE_V18.APPLY_REFUND(
15:21:32 2200  		   in_invoice_id,
15:21:32 2201  		   var_chargeback_amount,
15:21:32 2202  		   in_updated_by,
15:21:32 2203  		   ver_refund_charge_id
15:21:32 2204  		 );
15:21:32 2205  		 EXCEPTION
15:21:32 2206  		   WHEN OTHERS THEN
15:21:32 2207  		     EXCEPTION_MESSAGE := SQLERRM;
15:21:32 2208  		     RAISE CAN_NOT_APPLY_CHARGEBACK;
15:21:32 2209  	       END;
15:21:32 2210  	       var_refund := GLOBAL_CONSTANTS_V18.TRUE;
15:21:32 2211  	     END IF;
15:21:32 2212  	   end if;
15:21:32 2213  	 ELSE
15:21:32 2214  
15:21:32 2215  	   FOR f_transaction_to_close IN (
15:21:32 2216  	     SELECT DISTINCT CHARGE.TRANSACTION_ID AS "ID" FROM CHARGE WHERE CHARGE.INVOICE_ID = in_invoice_id and CHARGE.CHARGE_STATUS_ID = GLOBAL_STATUSES_V18.CHARGE_OPENED
15:21:32 2217  	   )
15:21:32 2218  	   LOOP
15:21:32 2219  	     PROCS_TRANSACTION_V18.UPDATE_TRANSACTION_STATUS(
15:21:32 2220  	       in_transaction_id	=> f_transaction_to_close.ID,
15:21:32 2221  	       in_updated_by		=> in_updated_by,
15:21:32 2222  	       in_transaction_status_id => GLOBAL_STATUSES_V18.TRANSACTION_CLOSED
15:21:32 2223  	     );
15:21:32 2224  	   END LOOP;
15:21:32 2225  	   -- Needs to close charges. No refund.
15:21:32 2226  	   FOR f_charge_to_close IN (
15:21:32 2227  	     SELECT CHARGE.ID FROM CHARGE WHERE CHARGE.INVOICE_ID = in_invoice_id and CHARGE.CHARGE_STATUS_ID = GLOBAL_STATUSES_V18.CHARGE_OPENED
15:21:32 2228  	   )
15:21:32 2229  	   LOOP
15:21:32 2230  	     PROCS_CHARGE_V18.UPDATE_CHARGE_STATUS(
15:21:32 2231  	       in_charge_id	   => f_charge_to_close.ID,
15:21:32 2232  	       in_updated_by	   => in_updated_by,
15:21:32 2233  	       in_charge_status_id => GLOBAL_STATUSES_V18.CHARGE_CANCELED
15:21:32 2234  	     );
15:21:32 2235  	   END LOOP;
15:21:32 2236  
15:21:32 2237  	   PROCS_INVOICE_V18.UPDATE_INVOICE_STATUS(
15:21:32 2238  	     in_invoice_id		    => in_invoice_id,
15:21:32 2239  	     in_updated_by		    => in_updated_by,
15:21:32 2240  	     in_invoice_status_id	    => GLOBAL_STATUSES_V18.INVOICE_CLOSED
15:21:32 2241  	   );
15:21:32 2242  
15:21:32 2243  	 END IF;
15:21:32 2244  	 -- update licenses
15:21:32 2245  	 IF(var_revoke = GLOBAL_CONSTANTS_V18.TRUE OR var_chargeback_amount > 0 OR (var_subscription_in_grace = GLOBAL_CONSTANTS_V18.FALSE AND var_billed = GLOBAL_CONSTANTS_V18.FALSE)) THEN
15:21:32 2246  	   FOR f_license_to_cancel IN (
15:21:32 2247  	     SELECT LICENSE.ID FROM LICENSE WHERE LICENSE.INVOICE_ID = in_invoice_id AND LICENSE.LICENSE_STATUS_ID = GLOBAL_STATUSES_V18.LICENSE_ACTIVE
15:21:32 2248  	   )
15:21:32 2249  	   LOOP
15:21:32 2250  	     PROCS_LICENSE_CRU_V18.UPDATE_LICENSE(
15:21:32 2251  	       in_license_id	     => f_license_to_cancel.ID,
15:21:32 2252  	       in_license_status_id  => GLOBAL_STATUSES_V18.LICENSE_CLOSED,
15:21:32 2253  	       in_needs_entitlements => GLOBAL_CONSTANTS_V18.TRUE,
15:21:32 2254  	       in_updated_by	     => in_updated_by,
15:21:32 2255  	       in_entitlement_end_date => var_now
15:21:32 2256  	     );
15:21:32 2257  	   END LOOP;
15:21:32 2258  	 ELSE
15:21:32 2259  	   FOR f_license_to_cancel IN (
15:21:32 2260  	     SELECT LICENSE.ID FROM LICENSE WHERE LICENSE.INVOICE_ID = in_invoice_id AND LICENSE.LICENSE_STATUS_ID in (GLOBAL_STATUSES_V18.LICENSE_ACTIVE, GLOBAL_STATUSES_V18.LICENSE_IN_GRACE_PERIOD)
15:21:32 2261  	   )
15:21:32 2262  	   LOOP
15:21:32 2263  	     PROCS_LICENSE_CRU_V18.UPDATE_LICENSE(
15:21:32 2264  	       in_license_id	     => f_license_to_cancel.ID,
15:21:32 2265  	       in_license_status_id  => GLOBAL_STATUSES_V18.LICENSE_CLOSED,
15:21:32 2266  	       in_updated_by	     => in_updated_by
15:21:32 2267  	     );
15:21:32 2268  	   END LOOP;
15:21:32 2269  	 END IF;
15:21:32 2270  
15:21:32 2271  
15:21:32 2272  EXCEPTION
15:21:32 2273  WHEN BAD_INVOICE_ID THEN
15:21:32 2274  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2275  	   SPROC_NAME, 'No such invoice');
15:21:32 2276  WHEN CAN_NOT_CALCULATE_CHARGEBACK THEN
15:21:32 2277  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 2278  	   SPROC_NAME, 'Could not calculate invoice refund', EXCEPTION_MESSAGE);
15:21:32 2279  WHEN CAN_NOT_APPLY_CHARGEBACK THEN
15:21:32 2280  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 2281  	   SPROC_NAME, 'Could not apply chargeback', EXCEPTION_MESSAGE);
15:21:32 2282  WHEN OTHERS THEN
15:21:32 2283  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2284  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2285  END CANCEL_SUBSCRIPTION_INVOICE;
15:21:32 2286  
15:21:32 2287  /******************************************************************************/
15:21:32 2288  
15:21:32 2289  PROCEDURE FINALIZE_CANCELATION (
15:21:32 2290  /*
15:21:32 2291  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 2292  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 2293  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:32 2294  */
15:21:32 2295  --  in_subscription_id	 IN SUBSCRIPTION.ID%TYPE,
15:21:32 2296  --  in_cancelation_reason IN SUBSCRIPTION_CANCEL_REASON.VALUE%TYPE,
15:21:32 2297  --  in_cancelation_date	 IN SUBSCRIPTION.CANCELLATION_DATE%TYPE,
15:21:32 2298  --  in_note		 IN SUBSCRIPTION_NOTE.NOTE%TYPE,
15:21:32 2299  --  in_agent_id		 IN SUBSCRIPTION_NOTE.AGENT_ID%TYPE,
15:21:32 2300  --  in_updated_by	 IN SUBSCRIPTION.UPDATED_BY%TYPE
15:21:32 2301  	 in_subscription_id    IN NUMBER,
15:21:32 2302  	 in_cancelation_reason IN VARCHAR2,
15:21:32 2303  	 in_cancelation_date   IN DATE,
15:21:32 2304  	 in_note	       IN VARCHAR2,
15:21:32 2305  	 in_agent_id	       IN NUMBER,
15:21:32 2306  	 in_updated_by	       IN VARCHAR2
15:21:32 2307  ) AS
15:21:32 2308  SPROC_NAME CONSTANT VARCHAR2(20) := 'FINALIZE_CANCELATION';
15:21:32 2309  -- VARIABLES
15:21:32 2310  var_current_subscr_status SUBSCRIPTION.SUBSCRIPTION_STATUS_ID%TYPE;
15:21:32 2311  var_sct_id		 SUBSCRIPTION.SCT_ID%TYPE;
15:21:32 2312  var_active_invoices_count NUMBER;
15:21:32 2313  var_license_to_disgrace	 LICENSE.ID%TYPE;
15:21:32 2314  var_now			 DATE := SYSDATE;
15:21:32 2315  -- EXCEPTIONS
15:21:32 2316  BAD_SUBSCRIPTION_ID	   EXCEPTION;
15:21:32 2317  BAD_SUBSCRIPTION_STATUS	   EXCEPTION;
15:21:32 2318  BAD_CANCELATION_REASON	   EXCEPTION;
15:21:32 2319  CAN_NOT_UPDATE_SUBSCRIPTION EXCEPTION;
15:21:32 2320  ACTIVE_INVOICES_FOUND	   EXCEPTION;
15:21:32 2321  CAN_NOT_CREATE_NOTE	   EXCEPTION;
15:21:32 2322  EXCEPTION_MESSAGE	   VARCHAR2(1024);
15:21:32 2323  BEGIN
15:21:32 2324  
15:21:32 2325  	 -- Get current subscription status
15:21:32 2326  	 BEGIN
15:21:32 2327  	   SELECT
15:21:32 2328  	     SUBSCRIPTION.SUBSCRIPTION_STATUS_ID into var_current_subscr_status
15:21:32 2329  	   FROM
15:21:32 2330  	     SUBSCRIPTION
15:21:32 2331  	   WHERE
15:21:32 2332  	     SUBSCRIPTION.ID = in_subscription_id;
15:21:32 2333  	   EXCEPTION
15:21:32 2334  	     WHEN NO_DATA_FOUND THEN
15:21:32 2335  	       RAISE BAD_SUBSCRIPTION_ID;
15:21:32 2336  	 END;
15:21:32 2337  
15:21:32 2338  	 -- Check that subscription reason is correct
15:21:32 2339  	 BEGIN
15:21:32 2340  	   SELECT
15:21:32 2341  	     SUBSCRIPTION_CANCEL_REASON.ID into var_sct_id
15:21:32 2342  	   FROM
15:21:32 2343  	     SUBSCRIPTION_CANCEL_REASON
15:21:32 2344  	   WHERE
15:21:32 2345  	     SUBSCRIPTION_CANCEL_REASON.VALUE LIKE in_cancelation_reason
15:21:32 2346  	     AND ROWNUM <= 1;
15:21:32 2347  	   EXCEPTION
15:21:32 2348  	     WHEN NO_DATA_FOUND THEN
15:21:32 2349  	       RAISE BAD_CANCELATION_REASON;
15:21:32 2350  	 END;
15:21:32 2351  
15:21:32 2352  	 -- Check for invoices with active licenses
15:21:32 2353  	 SELECT
15:21:32 2354  	   COUNT(*) into var_active_invoices_count
15:21:32 2355  	 FROM
15:21:32 2356  	   LICENSE
15:21:32 2357  	   INNER JOIN INVOICE ON LICENSE.INVOICE_ID = INVOICE.ID
15:21:32 2358  	 WHERE
15:21:32 2359  	   LICENSE.LICENSE_STATUS_ID in (GLOBAL_STATUSES_V18.LICENSE_ACTIVE, GLOBAL_STATUSES_V18.LICENSE_IN_GRACE_PERIOD)
15:21:32 2360  	   AND LICENSE.SUBSCRIPTION_ID = in_subscription_id;
15:21:32 2361  
15:21:32 2362  	 IF var_active_invoices_count > 0 THEN
15:21:32 2363  	   RAISE ACTIVE_INVOICES_FOUND;
15:21:32 2364  	 END IF;
15:21:32 2365  
15:21:32 2366  	 -- Check that subscription is active
15:21:32 2367  	 IF var_current_subscr_status != GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE AND
15:21:32 2368  	    var_current_subscr_status != GLOBAL_STATUSES_V18.SUBSCRIPTION_SUSPENDED AND
15:21:32 2369  	    var_current_subscr_status != GLOBAL_STATUSES_V18.SUBSCRIPTION_IN_GRACE_PERIOD THEN
15:21:32 2370  	   RAISE BAD_SUBSCRIPTION_STATUS;
15:21:32 2371  	 END IF;
15:21:32 2372  
15:21:32 2373  	 -- Update subscription data
15:21:32 2374  	 BEGIN
15:21:32 2375  	   PROCS_SUBSCRIPTION_CRU_V18.UPDATE_SUBSCRIPTION(
15:21:32 2376  	     in_subscription_id        => in_subscription_id,
15:21:32 2377  	     in_subscription_status_id => GLOBAL_STATUSES_V18.SUBSCRIPTION_CANCELED,
15:21:32 2378  	     in_cancelation_date       => in_cancelation_date,
15:21:32 2379  	     in_updated_by	       => in_updated_by,
15:21:32 2380  	     in_sct_id		       => var_sct_id
15:21:32 2381  	   );
15:21:32 2382  	   EXCEPTION
15:21:32 2383  	     WHEN OTHERS THEN
15:21:32 2384  	       EXCEPTION_MESSAGE := SQLERRM;
15:21:32 2385  	       RAISE CAN_NOT_UPDATE_SUBSCRIPTION;
15:21:32 2386  	 END;
15:21:32 2387  
15:21:32 2388  	 -- Terminate grace period for licenses in grace [SAR-31]
15:21:32 2389  	 BEGIN
15:21:32 2390  	   SELECT
15:21:32 2391  	     LICENSE.ID into var_license_to_disgrace
15:21:32 2392  	   FROM
15:21:32 2393  	     LICENSE
15:21:32 2394  	   WHERE
15:21:32 2395  	     LICENSE.SUBSCRIPTION_ID = in_subscription_id
15:21:32 2396  	     AND LICENSE.LICENSE_STATUS_ID = GLOBAL_STATUSES_V18.LICENSE_IN_GRACE_PERIOD
15:21:32 2397  	     AND ROWNUM <= 1
15:21:32 2398  	   ORDER BY
15:21:32 2399  	     CREATE_DATE DESC;
15:21:32 2400  	 EXCEPTION
15:21:32 2401  	   WHEN NO_DATA_FOUND THEN
15:21:32 2402  	     var_license_to_disgrace := NULL;
15:21:32 2403  	 END;
15:21:32 2404  
15:21:32 2405  	 IF var_license_to_disgrace IS NOT NULL THEN
15:21:32 2406  	   PROCS_LICENSE_CRU_V18.UPDATE_LICENSE(
15:21:32 2407  	     in_license_id	     => var_license_to_disgrace,
15:21:32 2408  	     in_license_status_id    => GLOBAL_STATUSES_V18.LICENSE_CLOSED,
15:21:32 2409  	     in_updated_by	     => in_updated_by
15:21:32 2410  	   );
15:21:32 2411  	 END IF;
15:21:32 2412  
15:21:32 2413  	 -- Annotate subscription
15:21:32 2414  	 IF in_note IS NOT NULL THEN
15:21:32 2415  	   BEGIN
15:21:32 2416  	     PROCS_SUBSCRIPTION_V18.ANNOTATE_SUBSCRIPTION(
15:21:32 2417  	       in_subscription_id,
15:21:32 2418  	       in_agent_id,
15:21:32 2419  	       in_note,
15:21:32 2420  	       in_updated_by
15:21:32 2421  	     );
15:21:32 2422  	     EXCEPTION
15:21:32 2423  	      WHEN OTHERS THEN
15:21:32 2424  		EXCEPTION_MESSAGE := SQLERRM;
15:21:32 2425  		RAISE CAN_NOT_CREATE_NOTE;
15:21:32 2426  	   END;
15:21:32 2427  	 END IF;
15:21:32 2428  
15:21:32 2429  EXCEPTION
15:21:32 2430  WHEN BAD_SUBSCRIPTION_ID THEN
15:21:32 2431  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2432  	   SPROC_NAME, 'No such subscription');
15:21:32 2433  WHEN BAD_SUBSCRIPTION_STATUS THEN
15:21:32 2434  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 2435  	   SPROC_NAME, 'Bad current subscription status');
15:21:32 2436  WHEN BAD_CANCELATION_REASON THEN
15:21:32 2437  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 2438  	   SPROC_NAME, 'Bad cancellation reason');
15:21:32 2439  WHEN CAN_NOT_UPDATE_SUBSCRIPTION THEN
15:21:32 2440  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 2441  	   SPROC_NAME, 'Could not update subscription data', EXCEPTION_MESSAGE);
15:21:32 2442  WHEN ACTIVE_INVOICES_FOUND THEN
15:21:32 2443  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 2444  	   SPROC_NAME, 'Invoices with active licenses found');
15:21:32 2445  WHEN CAN_NOT_CREATE_NOTE THEN
15:21:32 2446  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 2447  	   SPROC_NAME, 'Could not annotate subscription', EXCEPTION_MESSAGE);
15:21:32 2448  --WHEN OTHERS THEN
15:21:32 2449  --  PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2450  --    SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2451  END FINALIZE_CANCELATION;
15:21:32 2452  
15:21:32 2453  /******************************************************************************/
15:21:32 2454  
15:21:32 2455  PROCEDURE FINALIZE_FALSE_START (
15:21:32 2456  /*
15:21:32 2457  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 2458  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 2459  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:32 2460  */
15:21:32 2461  --  in_subscription_id	 IN SUBSCRIPTION.ID%TYPE,
15:21:32 2462  --  in_cancelation_date	 IN SUBSCRIPTION.CANCELLATION_DATE%TYPE,
15:21:32 2463  --  in_note		 IN SUBSCRIPTION_NOTE.NOTE%TYPE,
15:21:32 2464  --  in_agent_id		 IN SUBSCRIPTION_NOTE.AGENT_ID%TYPE,
15:21:32 2465  --  in_updated_by	 IN SUBSCRIPTION.UPDATED_BY%TYPE
15:21:32 2466  	 in_subscription_id    IN NUMBER,
15:21:32 2467  	 in_cancelation_date   IN DATE,
15:21:32 2468  	 in_note	       IN VARCHAR2,
15:21:32 2469  	 in_agent_id	       IN NUMBER,
15:21:32 2470  	 in_updated_by	       IN VARCHAR2
15:21:32 2471  ) AS
15:21:32 2472  SPROC_NAME CONSTANT VARCHAR2(20) := 'FINALIZE_FALSE_START';
15:21:32 2473  FALSE_START_REASON CONSTANT NUMBER := 41;
15:21:32 2474  -- VARIABLES
15:21:32 2475  var_current_subscr_status SUBSCRIPTION.SUBSCRIPTION_STATUS_ID%TYPE;
15:21:32 2476  var_active_invoices_count NUMBER;
15:21:32 2477  -- EXCEPTIONS
15:21:32 2478  BAD_SUBSCRIPTION_ID	   EXCEPTION;
15:21:32 2479  BAD_SUBSCRIPTION_STATUS	   EXCEPTION;
15:21:32 2480  CAN_NOT_UPDATE_SUBSCRIPTION EXCEPTION;
15:21:32 2481  ACTIVE_INVOICES_FOUND	   EXCEPTION;
15:21:32 2482  CAN_NOT_CREATE_NOTE	   EXCEPTION;
15:21:32 2483  EXCEPTION_MESSAGE	   VARCHAR2(1024);
15:21:32 2484  BEGIN
15:21:32 2485  
15:21:32 2486  	 -- Get current subscription status
15:21:32 2487  	 BEGIN
15:21:32 2488  	   SELECT
15:21:32 2489  	     SUBSCRIPTION.SUBSCRIPTION_STATUS_ID into var_current_subscr_status
15:21:32 2490  	   FROM
15:21:32 2491  	     SUBSCRIPTION
15:21:32 2492  	   WHERE
15:21:32 2493  	     SUBSCRIPTION.ID = in_subscription_id;
15:21:32 2494  	   EXCEPTION
15:21:32 2495  	     WHEN NO_DATA_FOUND THEN
15:21:32 2496  	       RAISE BAD_SUBSCRIPTION_ID;
15:21:32 2497  	 END;
15:21:32 2498  
15:21:32 2499  	 -- Check for invoices with active licenses
15:21:32 2500  	 SELECT
15:21:32 2501  	   COUNT(*) into var_active_invoices_count
15:21:32 2502  	 FROM
15:21:32 2503  	   LICENSE
15:21:32 2504  	   INNER JOIN INVOICE ON LICENSE.INVOICE_ID = INVOICE.ID
15:21:32 2505  	 WHERE
15:21:32 2506  	   LICENSE.LICENSE_STATUS_ID = GLOBAL_STATUSES_V18.LICENSE_ACTIVE
15:21:32 2507  	   AND LICENSE.SUBSCRIPTION_ID = in_subscription_id;
15:21:32 2508  
15:21:32 2509  	 IF var_active_invoices_count > 0 THEN
15:21:32 2510  	   RAISE ACTIVE_INVOICES_FOUND;
15:21:32 2511  	 END IF;
15:21:32 2512  
15:21:32 2513  	 -- Check that subscription is active
15:21:32 2514  	 IF var_current_subscr_status != GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE
15:21:32 2515  	    AND var_current_subscr_status != GLOBAL_STATUSES_V18.SUBSCRIPTION_SUSPENDED THEN
15:21:32 2516  	   RAISE BAD_SUBSCRIPTION_STATUS;
15:21:32 2517  	 END IF;
15:21:32 2518  
15:21:32 2519  	 -- Update subscription data
15:21:32 2520  	 BEGIN
15:21:32 2521  	   PROCS_SUBSCRIPTION_CRU_V18.UPDATE_SUBSCRIPTION(
15:21:32 2522  	     in_subscription_id        => in_subscription_id,
15:21:32 2523  	     in_subscription_status_id => GLOBAL_STATUSES_V18.SUBSCRIPTION_FALSE_START,
15:21:32 2524  	     in_cancelation_date       => in_cancelation_date,
15:21:32 2525  	     in_updated_by	       => in_updated_by,
15:21:32 2526  	     in_sct_id		       => FALSE_START_REASON
15:21:32 2527  	   );
15:21:32 2528  	   EXCEPTION
15:21:32 2529  	     WHEN OTHERS THEN
15:21:32 2530  	       EXCEPTION_MESSAGE := SQLERRM;
15:21:32 2531  	       RAISE CAN_NOT_UPDATE_SUBSCRIPTION;
15:21:32 2532  	 END;
15:21:32 2533  
15:21:32 2534  	 -- Annotate subscription
15:21:32 2535  	 IF in_note IS NOT NULL THEN
15:21:32 2536  	   BEGIN
15:21:32 2537  	     PROCS_SUBSCRIPTION_V18.ANNOTATE_SUBSCRIPTION(
15:21:32 2538  	       in_subscription_id,
15:21:32 2539  	       in_agent_id,
15:21:32 2540  	       in_note,
15:21:32 2541  	       in_updated_by
15:21:32 2542  	     );
15:21:32 2543  	     EXCEPTION
15:21:32 2544  	      WHEN OTHERS THEN
15:21:32 2545  		EXCEPTION_MESSAGE := SQLERRM;
15:21:32 2546  		RAISE CAN_NOT_CREATE_NOTE;
15:21:32 2547  	   END;
15:21:32 2548  	 END IF;
15:21:32 2549  
15:21:32 2550  EXCEPTION
15:21:32 2551  WHEN BAD_SUBSCRIPTION_ID THEN
15:21:32 2552  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2553  	   SPROC_NAME, 'No such subscription');
15:21:32 2554  WHEN BAD_SUBSCRIPTION_STATUS THEN
15:21:32 2555  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 2556  	   SPROC_NAME, 'Bad current subscription status');
15:21:32 2557  WHEN CAN_NOT_UPDATE_SUBSCRIPTION THEN
15:21:32 2558  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 2559  	   SPROC_NAME, 'Could not update subscription data', EXCEPTION_MESSAGE);
15:21:32 2560  WHEN ACTIVE_INVOICES_FOUND THEN
15:21:32 2561  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 2562  	   SPROC_NAME, 'Invoices with active licenses found');
15:21:32 2563  WHEN CAN_NOT_CREATE_NOTE THEN
15:21:32 2564  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 2565  	   SPROC_NAME, 'Could not annotate subscription', EXCEPTION_MESSAGE);
15:21:32 2566  WHEN OTHERS THEN
15:21:32 2567  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2568  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2569  END FINALIZE_FALSE_START;
15:21:32 2570  
15:21:32 2571  /******************************************************************************/
15:21:32 2572  
15:21:32 2573  FUNCTION IS_SUBSCRIPTION_CANCELABLE (
15:21:32 2574  	 in_subscription_id IN NUMBER
15:21:32 2575  ) RETURN NUMBER AS
15:21:32 2576  SPROC_NAME CONSTANT VARCHAR2(26) := 'IS_SUBSCRIPTION_CANCELABLE';
15:21:32 2577  -- VARIABLES
15:21:32 2578  var_is_offer_chain_cancelable NUMBER;
15:21:32 2579  --64603
15:21:32 2580  var_end_date date;
15:21:32 2581  today_date date := current_date;
15:21:32 2582  offer_id number;
15:21:32 2583  -- EXCEPTIONS
15:21:32 2584  COULD_NOT_CHECK	   EXCEPTION;
15:21:32 2585  BAD_SUBSCRIPTION_ID EXCEPTION;
15:21:32 2586  EXCEPTION_MESSAGE   VARCHAR2(1024);
15:21:32 2587  BEGIN
15:21:32 2588  
15:21:32 2589  	 BEGIN
15:21:32 2590  	   -- find offer_chain_id for given in_subscription_id
15:21:32 2591  	   SELECT OFFER_CHAIN_ID into offer_id
15:21:32 2592  	   FROM SUBSCRIPTION
15:21:32 2593  	   WHERE ID = in_subscription_id;
15:21:32 2594  	   EXCEPTION
15:21:32 2595  	     WHEN NO_DATA_FOUND THEN
15:21:32 2596  	       RAISE BAD_SUBSCRIPTION_ID;
15:21:32 2597  	     WHEN OTHERS THEN
15:21:32 2598  	       EXCEPTION_MESSAGE := SQLERRM;
15:21:32 2599  	       RAISE COULD_NOT_CHECK;
15:21:32 2600  	 END;
15:21:32 2601  
15:21:32 2602  	 -- find if it was redeemed from a gift certificate
15:21:32 2603  	 BEGIN
15:21:32 2604  	   SELECT l.end_date INTO var_end_date
15:21:32 2605  	   FROM LICENSE l, GIFT_CERTIFICATE g
15:21:32 2606  	   WHERE l.invoice_id = g.finalized_invoice_id
15:21:32 2607  	   AND l.subscription_id = in_subscription_id;
15:21:32 2608  
15:21:32 2609  	   -- if the license end_date is bigger than today, we are in the
15:21:32 2610  	   -- first period, so we cannot cancel; otherwise can cancel
15:21:32 2611  	   IF var_end_date > today_date THEN
15:21:32 2612  	       RETURN GLOBAL_CONSTANTS_V18.FALSE;
15:21:32 2613  	   ELSE
15:21:32 2614  	       RETURN GLOBAL_CONSTANTS_V18.TRUE;
15:21:32 2615  	   END IF;
15:21:32 2616  
15:21:32 2617  	   EXCEPTION
15:21:32 2618  	       -- not coming from a gift certificate,
15:21:32 2619  	       -- use old logic
15:21:32 2620  	       WHEN NO_DATA_FOUND THEN
15:21:32 2621  		   SELECT
15:21:32 2622  		       PROCS_OFFER_CHAIN_V18.IS_OFFER_CHAIN_CANCELABLE(offer_id)
15:21:32 2623  		       INTO var_is_offer_chain_cancelable
15:21:32 2624  		   FROM DUAL;
15:21:32 2625  		   RETURN var_is_offer_chain_cancelable;
15:21:32 2626  	 END;
15:21:32 2627  
15:21:32 2628  EXCEPTION
15:21:32 2629  WHEN BAD_SUBSCRIPTION_ID THEN
15:21:32 2630  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2631  	   SPROC_NAME, 'No such subscription');
15:21:32 2632  WHEN COULD_NOT_CHECK THEN
15:21:32 2633  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 2634  	   SPROC_NAME, 'Could not check if offer chain calcelable', EXCEPTION_MESSAGE);
15:21:32 2635  WHEN OTHERS THEN
15:21:32 2636  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2637  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2638  
15:21:32 2639  END IS_SUBSCRIPTION_CANCELABLE;
15:21:32 2640  /******************************************************************************/
15:21:32 2641  
15:21:32 2642  PROCEDURE GET_SUBSCR_PROD_OFFERRINGS (
15:21:32 2643  /*
15:21:32 2644  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 2645  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 2646  */
15:21:32 2647  	 in_subscription_id IN NUMBER,
15:21:32 2648  	 out_result_set     OUT SYS_REFCURSOR
15:21:32 2649  ) AS
15:21:32 2650  SPROC_NAME CONSTANT VARCHAR2(26) := 'GET_SUBSCR_PROD_OFFERRINGS';
15:21:32 2651  -- VARIABLES
15:21:32 2652  var_offer NUMBER;
15:21:32 2653  -- EXCEPTIONS
15:21:32 2654  BAD_SUBSCRIPTION_ID EXCEPTION;
15:21:32 2655  BEGIN
15:21:32 2656  
15:21:32 2657  	 OPEN out_result_set FOR
15:21:32 2658  	 SELECT DISTINCT
15:21:32 2659  	   PRODUCT_OFFERING.ID,
15:21:32 2660  	   PRODUCT_OFFERING.PRODUCT_ID,
15:21:32 2661  	   PRODUCT_OFFERING.TAX_CATEGORY_ID,
15:21:32 2662  	   PRODUCT_OFFERING.UNIT_PRICE,
15:21:32 2663  	   PRODUCT_OFFERING.QUANTITY,
15:21:32 2664  	   PRODUCT_OFFERING.CREATE_DATE,
15:21:32 2665  	   PRODUCT_OFFERING.CREATED_BY,
15:21:32 2666  	   CAPABILITY.ID CAP_ID,
15:21:32 2667  	   CAPABILITY.CODE CAP_CODE,
15:21:32 2668  	   CAPABILITY.DESCRIPTION CAP_DESCRIPTION,
15:21:32 2669  	   CAPABILITY.SHAREABLE CAP_SHAREABLE
15:21:32 2670  	 FROM
15:21:32 2671  	   OFFER_PRODUCT_OFFERING
15:21:32 2672  	   INNER JOIN PRODUCT_OFFERING ON PRODUCT_OFFERING.ID = OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID
15:21:32 2673  	   INNER JOIN CAPABILITY ON PRODUCT_OFFERING.CAPABILITY_ID = CAPABILITY.ID
15:21:32 2674  	 WHERE
15:21:32 2675  	   OFFER_PRODUCT_OFFERING.OFFER_ID IN (
15:21:32 2676  	     SELECT
15:21:32 2677  	       LICENSE.OFFER_ID
15:21:32 2678  	     FROM
15:21:32 2679  	       SUBSCRIPTION
15:21:32 2680  	       JOIN LICENSE ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID AND LICENSE.NEEDS_ENTITLEMENTS = GLOBAL_CONSTANTS_V18.TRUE
15:21:32 2681  	     WHERE
15:21:32 2682  	       SUBSCRIPTION.ID = in_subscription_id
15:21:32 2683  	   );
15:21:32 2684  
15:21:32 2685  EXCEPTION
15:21:32 2686  WHEN BAD_SUBSCRIPTION_ID THEN
15:21:32 2687  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2688  	   SPROC_NAME, 'No such subscription');
15:21:32 2689  WHEN OTHERS THEN
15:21:32 2690  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2691  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2692  END GET_SUBSCR_PROD_OFFERRINGS;
15:21:32 2693  
15:21:32 2694  
15:21:32 2695  PROCEDURE RETRIEVE_SUB_PROD_OFFER (
15:21:32 2696  /*
15:21:32 2697  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 2698  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 2699  */
15:21:32 2700  	 in_subscription_id IN NUMBER,
15:21:32 2701  	 out_result_set     OUT SYS_REFCURSOR
15:21:32 2702  ) AS
15:21:32 2703  SPROC_NAME CONSTANT VARCHAR2(27) := 'RETRIEVE_SUB_PROD_OFFER';
15:21:32 2704  -- VARIABLES
15:21:32 2705  var_offer NUMBER;
15:21:32 2706  -- EXCEPTIONS
15:21:32 2707  BAD_SUBSCRIPTION_ID EXCEPTION;
15:21:32 2708  BEGIN
15:21:32 2709  
15:21:32 2710  	 OPEN out_result_set FOR
15:21:32 2711  	 SELECT DISTINCT
15:21:32 2712  	   PRODUCT_OFFERING.ID,
15:21:32 2713  	   PRODUCT_OFFERING.PRODUCT_ID,
15:21:32 2714  	   PRODUCT_OFFERING.TAX_CATEGORY_ID,
15:21:32 2715  	   PRODUCT_OFFERING.UNIT_PRICE,
15:21:32 2716  	   PRODUCT_OFFERING.QUANTITY,
15:21:32 2717  	   PRODUCT_OFFERING.CREATE_DATE,
15:21:32 2718  	   PRODUCT_OFFERING.CREATED_BY,
15:21:32 2719  	   CAPABILITY.ID CAP_ID,
15:21:32 2720  	   CAPABILITY.CODE CAP_CODE,
15:21:32 2721  	   CAPABILITY.DESCRIPTION CAP_DESCRIPTION,
15:21:32 2722  	   CAPABILITY.SHAREABLE CAP_SHAREABLE
15:21:32 2723  	 FROM
15:21:32 2724  	   OFFER_PRODUCT_OFFERING
15:21:32 2725  	   INNER JOIN PRODUCT_OFFERING ON PRODUCT_OFFERING.ID = OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID
15:21:32 2726  	   INNER JOIN CAPABILITY ON PRODUCT_OFFERING.CAPABILITY_ID = CAPABILITY.ID
15:21:32 2727  	 WHERE
15:21:32 2728  	   OFFER_PRODUCT_OFFERING.OFFER_ID IN (
15:21:32 2729  	     SELECT
15:21:32 2730  	       LICENSE.OFFER_ID
15:21:32 2731  	     FROM
15:21:32 2732  	       SUBSCRIPTION
15:21:32 2733  	       JOIN LICENSE ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
15:21:32 2734  	     WHERE
15:21:32 2735  	       SUBSCRIPTION.ID = in_subscription_id
15:21:32 2736  	   );
15:21:32 2737  
15:21:32 2738  EXCEPTION
15:21:32 2739  WHEN BAD_SUBSCRIPTION_ID THEN
15:21:32 2740  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2741  	   SPROC_NAME, 'No such subscription');
15:21:32 2742  WHEN OTHERS THEN
15:21:32 2743  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2744  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2745  END RETRIEVE_SUB_PROD_OFFER;
15:21:32 2746  /******************************************************************************/
15:21:32 2747  
15:21:32 2748  
15:21:32 2749  
15:21:32 2750  
15:21:32 2751  PROCEDURE GET_SUBSCR_LIC_OFFER(
15:21:32 2752  /*
15:21:32 2753  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 2754  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 2755  */
15:21:32 2756  	 in_subscription_id IN NUMBER,
15:21:32 2757  	 out_result_set     OUT SYS_REFCURSOR
15:21:32 2758  ) AS
15:21:32 2759  SPROC_NAME CONSTANT VARCHAR2(26) := 'GET_SUBSCR_LIC_OFFER';
15:21:32 2760  -- VARIABLES
15:21:32 2761  var_offer_chain NUMBER;
15:21:32 2762  -- EXCEPTIONS
15:21:32 2763  BAD_SUBSCRIPTION_ID EXCEPTION;
15:21:32 2764  BEGIN
15:21:32 2765  	 BEGIN
15:21:32 2766  	   SELECT
15:21:32 2767  	     SUBSCRIPTION.OFFER_CHAIN_ID into var_offer_chain
15:21:32 2768  	   FROM
15:21:32 2769  	     SUBSCRIPTION
15:21:32 2770  	   WHERE
15:21:32 2771  	     SUBSCRIPTION.ID = in_subscription_id;
15:21:32 2772  	   EXCEPTION
15:21:32 2773  	     WHEN NO_DATA_FOUND THEN
15:21:32 2774  	       RAISE BAD_SUBSCRIPTION_ID;
15:21:32 2775  	 END;
15:21:32 2776  
15:21:32 2777  	 OPEN out_result_set FOR
15:21:32 2778  	 SELECT DISTINCT
15:21:32 2779  	   po.ID po_id,
15:21:32 2780  	   po.PRODUCT_ID po_product_id,
15:21:32 2781  	   po.TAX_CATEGORY_ID po_tax_category_id,
15:21:32 2782  	   po.UNIT_PRICE po_unit_price,
15:21:32 2783  	   po.QUANTITY po_quantity,
15:21:32 2784  	   po.CREATE_DATE po_create_date,
15:21:32 2785  	   po.CREATED_BY po_created_by,
15:21:32 2786  	   l.ID l_id,
15:21:32 2787  	   l.license_status_id l_license_status_id,
15:21:32 2788  	   l.start_date l_start_date,
15:21:32 2789  	   l.offer_id l_offer_id,
15:21:32 2790  	   l.subscription_id l_subscription_id,
15:21:32 2791  	   l.invoice_id l_invoice_id,
15:21:32 2792  	   l.end_date l_end_date,
15:21:32 2793  	   l.entitlement_end_date l_entitlement_end_date,
15:21:32 2794  	   l.create_date l_create_date,
15:21:32 2795  	   l.created_by l_created_by,
15:21:32 2796  	   l.is_extension l_is_extension,
15:21:32 2797  	   l.current_offer_index l_current_offer_index,
15:21:32 2798  	   l.current_offer_recurr_num l_current_offer_recurr_num,
15:21:32 2799  	   l.needs_entitlements l_needs_entitlements
15:21:32 2800  	 FROM
15:21:32 2801  	   OFFER_PRODUCT_OFFERING opo,
15:21:32 2802  	   PRODUCT_OFFERING po,
15:21:32 2803  	   SUBSCRIPTION s,
15:21:32 2804  	   LICENSE l
15:21:32 2805  	 WHERE
15:21:32 2806  	   opo.product_offering_id = po.id
15:21:32 2807  	   and po.id = l.offer_id
15:21:32 2808  	   and l.subscription_id = s.id
15:21:32 2809  	   and l.license_status_id = GLOBAL_STATUSES_V18.LICENSE_ACTIVE
15:21:32 2810  	   and s.id = in_subscription_id
15:21:32 2811  	 ;
15:21:32 2812  EXCEPTION
15:21:32 2813  WHEN BAD_SUBSCRIPTION_ID THEN
15:21:32 2814  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2815  	   SPROC_NAME, 'No such subscription');
15:21:32 2816  WHEN OTHERS THEN
15:21:32 2817  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2818  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2819  END GET_SUBSCR_LIC_OFFER;
15:21:32 2820  
15:21:32 2821  /******************************************************************************/
15:21:32 2822  
15:21:32 2823  PROCEDURE ARE_REFUNDS_PENDING_FOR_SUBSCR (
15:21:32 2824  /*
15:21:32 2825  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 2826  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 2827  */
15:21:32 2828  	 in_subscription_id IN NUMBER,
15:21:32 2829  	 out_result	    OUT NUMBER
15:21:32 2830  ) AS
15:21:32 2831  SPROC_NAME CONSTANT VARCHAR2(30) := 'ARE_REFUNDS_PENDING_FOR_SUBSCR';
15:21:32 2832  -- VARIABLES
15:21:32 2833  temp_subscription_id NUMBER;
15:21:32 2834  var_local_result     NUMBER;
15:21:32 2835  -- EXCEPTIONS
15:21:32 2836  BAD_SUBSCRIPTION_ID EXCEPTION;
15:21:32 2837  BEGIN
15:21:32 2838  
15:21:32 2839  	 -- Check that subscription exists
15:21:32 2840  	 BEGIN
15:21:32 2841  	   SELECT
15:21:32 2842  	     SUBSCRIPTION.ID into temp_subscription_id
15:21:32 2843  	   FROM
15:21:32 2844  	     SUBSCRIPTION
15:21:32 2845  	   WHERE
15:21:32 2846  	     SUBSCRIPTION.ID = in_subscription_id;
15:21:32 2847  	   EXCEPTION
15:21:32 2848  	     WHEN NO_DATA_FOUND THEN
15:21:32 2849  	       RAISE BAD_SUBSCRIPTION_ID;
15:21:32 2850  	 END;
15:21:32 2851  
15:21:32 2852  	 var_local_result := NULL;
15:21:32 2853  
15:21:32 2854  	 -- Check charges for each invoice associated with gived subscription
15:21:32 2855  	 FOR f_invoice IN (
15:21:32 2856  	   SELECT DISTINCT
15:21:32 2857  	     LICENSE.INVOICE_ID as "ID"
15:21:32 2858  	   FROM
15:21:32 2859  	     LICENSE
15:21:32 2860  	   WHERE
15:21:32 2861  	     LICENSE.SUBSCRIPTION_ID = in_subscription_id
15:21:32 2862  	     AND LICENSE.LICENSE_STATUS_ID IN ( SELECT GLOBAL_STATUSES_V18.LICENSE_ACTIVE FROM DUAL )
15:21:32 2863  	 )
15:21:32 2864  	 LOOP
15:21:32 2865  
15:21:32 2866  	   -- Check each charge in invoice
15:21:32 2867  	   FOR f_charge IN (
15:21:32 2868  	     SELECT
15:21:32 2869  	       CHARGE.ID,
15:21:32 2870  	       CHARGE.CHARGE_STATUS_ID,
15:21:32 2871  	       CHARGE.CHARGE_AMOUNT
15:21:32 2872  	     FROM
15:21:32 2873  	       CHARGE
15:21:32 2874  	     WHERE
15:21:32 2875  	       CHARGE.INVOICE_ID = f_invoice.ID
15:21:32 2876  	   )
15:21:32 2877  	   LOOP
15:21:32 2878  
15:21:32 2879  	     -- Charge amount < 0     => it is a refund
15:21:32 2880  	     -- Charge status is OPEN => means that it is not processed yet
15:21:32 2881  	     IF f_charge.CHARGE_AMOUNT < 0
15:21:32 2882  		AND f_charge.CHARGE_STATUS_ID = GLOBAL_STATUSES_V18.CHARGE_OPENED THEN
15:21:32 2883  	       var_local_result := GLOBAL_CONSTANTS_V18.TRUE;
15:21:32 2884  	     END IF;
15:21:32 2885  
15:21:32 2886  	   END LOOP;
15:21:32 2887  
15:21:32 2888  	 END LOOP;
15:21:32 2889  
15:21:32 2890  	 IF var_local_result IS NULL THEN
15:21:32 2891  	   out_result := GLOBAL_CONSTANTS_V18.FALSE;
15:21:32 2892  	 ELSE
15:21:32 2893  	   out_result := GLOBAL_CONSTANTS_V18.TRUE;
15:21:32 2894  	 END IF;
15:21:32 2895  
15:21:32 2896  EXCEPTION
15:21:32 2897  WHEN BAD_SUBSCRIPTION_ID THEN
15:21:32 2898  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2899  	   SPROC_NAME, 'No such transaction id');
15:21:32 2900  WHEN OTHERS THEN
15:21:32 2901  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2902  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2903  END ARE_REFUNDS_PENDING_FOR_SUBSCR;
15:21:32 2904  
15:21:32 2905  PROCEDURE GET_EXISTING_SUBSCR_NUMBER (
15:21:32 2906  /*
15:21:32 2907  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 2908  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 2909  */
15:21:32 2910  	 in_group_id	    IN NUMBER,
15:21:32 2911  	 in_offer_chain_id  IN NUMBER,
15:21:32 2912  	 out_result	    OUT NUMBER
15:21:32 2913  ) AS
15:21:32 2914  SPROC_NAME CONSTANT VARCHAR2(28) := 'GET_EXISTING_SUBSCR_NUMBER';
15:21:32 2915  -- VARIABLES
15:21:32 2916  temp_acct_id	    NUMBER;
15:21:32 2917  temp_oc_id	    NUMBER;
15:21:32 2918  -- EXCEPTIONS
15:21:32 2919  BAD_GROUP_ID EXCEPTION;
15:21:32 2920  BAD_OFFER_CHAIN_ID EXCEPTION;
15:21:32 2921  BEGIN
15:21:32 2922  	 -- Check that group id exists
15:21:32 2923  	 BEGIN
15:21:32 2924  	   SELECT
15:21:32 2925  	     ACCOUNT.ID into temp_acct_id
15:21:32 2926  	   FROM
15:21:32 2927  	     ACCOUNT
15:21:32 2928  	   WHERE
15:21:32 2929  	     ACCOUNT.GROUP_ID = in_group_id;
15:21:32 2930  	   EXCEPTION
15:21:32 2931  	     WHEN NO_DATA_FOUND THEN
15:21:32 2932  	       RAISE BAD_GROUP_ID;
15:21:32 2933  	 END;
15:21:32 2934  	 -- Check that offer chain id exists
15:21:32 2935  	 BEGIN
15:21:32 2936  	   SELECT
15:21:32 2937  	     OFFER_CHAIN.ID into temp_oc_id
15:21:32 2938  	   FROM
15:21:32 2939  	     OFFER_CHAIN
15:21:32 2940  	   WHERE
15:21:32 2941  	     OFFER_CHAIN.ID = in_offer_chain_id;
15:21:32 2942  	   EXCEPTION
15:21:32 2943  	     WHEN NO_DATA_FOUND THEN
15:21:32 2944  	       RAISE BAD_OFFER_CHAIN_ID;
15:21:32 2945  	 END;
15:21:32 2946  	 SELECT
15:21:32 2947  	   COUNT(*) into out_result
15:21:32 2948  	 FROM
15:21:32 2949  	   SUBSCRIPTION
15:21:32 2950  	     INNER JOIN ACCOUNT ON SUBSCRIPTION.ACCOUNT_ID = ACCOUNT.ID
15:21:32 2951  	 WHERE
15:21:32 2952  	   ACCOUNT.GROUP_ID = in_group_id
15:21:32 2953  	   AND SUBSCRIPTION.OFFER_CHAIN_ID = in_offer_chain_id
15:21:32 2954  	   AND (
15:21:32 2955  	     SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE
15:21:32 2956  	     OR SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_IN_GRACE_PERIOD);
15:21:32 2957  
15:21:32 2958  EXCEPTION
15:21:32 2959  WHEN BAD_GROUP_ID THEN
15:21:32 2960  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2961  	   SPROC_NAME, 'No such transaction id');
15:21:32 2962  WHEN BAD_OFFER_CHAIN_ID THEN
15:21:32 2963  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2964  	   SPROC_NAME, 'No such offer chain id');
15:21:32 2965  WHEN OTHERS THEN
15:21:32 2966  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2967  	   sproc_name, 'Unknown error', sqlerrm);
15:21:32 2968  END GET_EXISTING_SUBSCR_NUMBER;
15:21:32 2969  
15:21:32 2970  PROCEDURE GET_EXISTING_SUBSCR_IDS (
15:21:32 2971  /*
15:21:32 2972  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 2973  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 2974  */
15:21:32 2975  	 in_group_id	    IN NUMBER,
15:21:32 2976  	 in_offer_chain_id  IN NUMBER,
15:21:32 2977  	 out_result_set     OUT SYS_REFCURSOR
15:21:32 2978  ) AS
15:21:32 2979  SPROC_NAME CONSTANT VARCHAR2(26) := 'GET_EXISTING_SUBSCR_NUMBER';
15:21:32 2980  -- VARIABLES
15:21:32 2981  temp_acct_id	    NUMBER;
15:21:32 2982  temp_oc_id	    NUMBER;
15:21:32 2983  -- EXCEPTIONS
15:21:32 2984  BAD_GROUP_ID EXCEPTION;
15:21:32 2985  BAD_OFFER_CHAIN_ID EXCEPTION;
15:21:32 2986  BEGIN
15:21:32 2987  
15:21:32 2988  	 -- Check that group id exists
15:21:32 2989  	 BEGIN
15:21:32 2990  	   SELECT
15:21:32 2991  	     ACCOUNT.ID into temp_acct_id
15:21:32 2992  	   FROM
15:21:32 2993  	     ACCOUNT
15:21:32 2994  	   WHERE
15:21:32 2995  	     ACCOUNT.GROUP_ID = in_group_id;
15:21:32 2996  	   EXCEPTION
15:21:32 2997  	     WHEN NO_DATA_FOUND THEN
15:21:32 2998  	       RAISE BAD_GROUP_ID;
15:21:32 2999  	 END;
15:21:32 3000  	 -- Check that offer chain id exists
15:21:32 3001  	 BEGIN
15:21:32 3002  	   SELECT
15:21:32 3003  	     OFFER_CHAIN.ID into temp_oc_id
15:21:32 3004  	   FROM
15:21:32 3005  	     OFFER_CHAIN
15:21:32 3006  	   WHERE
15:21:32 3007  	     OFFER_CHAIN.ID = in_offer_chain_id;
15:21:32 3008  	   EXCEPTION
15:21:32 3009  	     WHEN NO_DATA_FOUND THEN
15:21:32 3010  	       RAISE BAD_OFFER_CHAIN_ID;
15:21:32 3011  	 END;
15:21:32 3012  
15:21:32 3013  	 OPEN out_result_set FOR
15:21:32 3014  	 SELECT
15:21:32 3015  	   SUBSCRIPTION.ID
15:21:32 3016  	 FROM
15:21:32 3017  	   SUBSCRIPTION
15:21:32 3018  	   INNER JOIN ACCOUNT ON SUBSCRIPTION.ACCOUNT_ID = ACCOUNT.ID
15:21:32 3019  	 WHERE
15:21:32 3020  	   ACCOUNT.GROUP_ID = in_group_id
15:21:32 3021  	   AND SUBSCRIPTION.OFFER_CHAIN_ID = in_offer_chain_id
15:21:32 3022  	   AND (
15:21:32 3023  	     SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE
15:21:32 3024  	     OR SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_IN_GRACE_PERIOD);
15:21:32 3025  
15:21:32 3026  EXCEPTION
15:21:32 3027  WHEN BAD_GROUP_ID THEN
15:21:32 3028  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 3029  	   SPROC_NAME, 'No such transaction id');
15:21:32 3030  WHEN BAD_OFFER_CHAIN_ID THEN
15:21:32 3031  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 3032  	   SPROC_NAME, 'No such offer chain id');
15:21:32 3033  WHEN OTHERS THEN
15:21:32 3034  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 3035  	   sproc_name, 'Unknown error', sqlerrm);
15:21:32 3036  END GET_EXISTING_SUBSCR_IDS;
15:21:32 3037  
15:21:32 3038  PROCEDURE ADD_META_DATA (
15:21:32 3039  /*
15:21:32 3040  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 3041  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 3042  */
15:21:32 3043  	 in_subscription_id IN NUMBER,
15:21:32 3044  	 in_name	    IN VARCHAR2,
15:21:32 3045  	 in_value	    IN VARCHAR2,
15:21:32 3046  	 in_created_by	    IN VARCHAR2
15:21:32 3047  ) AS
15:21:32 3048  SPROC_NAME CONSTANT VARCHAR2(13) := 'ADD_META_DATA';
15:21:32 3049  BEGIN
15:21:32 3050  
15:21:32 3051  	 INSERT INTO SUBSCRIPTION_META_DATA (
15:21:32 3052  	   ID,
15:21:32 3053  	   SUBSCRIPTION_ID,
15:21:32 3054  	   NAME,
15:21:32 3055  	   VALUE,
15:21:32 3056  	   CREATE_DATE,
15:21:32 3057  	   CREATED_BY
15:21:32 3058  	 ) VALUES (
15:21:32 3059  	   SUBMD_ID_SEQ.nextVal,
15:21:32 3060  	   in_subscription_id,
15:21:32 3061  	   in_name,
15:21:32 3062  	   in_value,
15:21:32 3063  	   sysdate,
15:21:32 3064  	   in_created_by
15:21:32 3065  	 );
15:21:32 3066  
15:21:32 3067  EXCEPTION
15:21:32 3068  WHEN OTHERS THEN
15:21:32 3069  	 IF SQLCODE = -2291 THEN
15:21:32 3070  	   PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 3071  	     SPROC_NAME, 'No such subscription');
15:21:32 3072  	 ELSE
15:21:32 3073  	   PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 3074  	     SPROC_NAME, 'Unknown error', sqlerrm);
15:21:32 3075  	 END IF;
15:21:32 3076  END ADD_META_DATA;
15:21:32 3077  
15:21:32 3078  /******************************************************************************/
15:21:32 3079  
15:21:32 3080  PROCEDURE GET_SUBSCRIPTIONS_META_DATA (
15:21:32 3081  /*
15:21:32 3082  APP_EXCEPTION_CODES_V18.INVALID_PARAMETER
15:21:32 3083  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 3084  */
15:21:32 3085  	 in_subscriptions_ids IN core_owner.NUMBER_TABLE,
15:21:32 3086  	 out_result_set       OUT SYS_REFCURSOR
15:21:32 3087  ) AS
15:21:32 3088  SPROC_NAME CONSTANT VARCHAR2(27) := 'GET_SUBSCRIPTIONS_META_DATA';
15:21:32 3089  -- Exceptions
15:21:32 3090  SUBSCRIPTION_IDS_IS_NULL EXCEPTION;
15:21:32 3091  BEGIN
15:21:32 3092  
15:21:32 3093  	 IF in_subscriptions_ids IS NULL THEN
15:21:32 3094  	   RAISE SUBSCRIPTION_IDS_IS_NULL;
15:21:32 3095  	 END IF;
15:21:32 3096  
15:21:32 3097  	 OPEN out_result_set FOR
15:21:32 3098  	 SELECT
15:21:32 3099  	   SMD.SUBSCRIPTION_ID,
15:21:32 3100  	   SMD.NAME,
15:21:32 3101  	   SMD.VALUE
15:21:32 3102  	 FROM
15:21:32 3103  	   SUBSCRIPTION_META_DATA SMD
15:21:32 3104  	 WHERE
15:21:32 3105  	   SMD.SUBSCRIPTION_ID IN (SELECT * FROM TABLE(in_subscriptions_ids));
15:21:32 3106  
15:21:32 3107  EXCEPTION
15:21:32 3108  WHEN SUBSCRIPTION_IDS_IS_NULL THEN
15:21:32 3109  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 3110  	   SPROC_NAME, 'Bad subscription ids parameter');
15:21:32 3111  WHEN OTHERS THEN
15:21:32 3112  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 3113  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 3114  END GET_SUBSCRIPTIONS_META_DATA;
15:21:32 3115  
15:21:32 3116  PROCEDURE GET_SUBS_BY_TRNS_ORDER_ID (
15:21:32 3117  /*
15:21:32 3118  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 3119  */
15:21:32 3120  	 in_order_id	    IN TRANSACTION.ORDER_ID%TYPE,
15:21:32 3121  	 out_result_set     OUT SYS_REFCURSOR
15:21:32 3122  ) AS
15:21:32 3123  SPROC_NAME CONSTANT VARCHAR2(25) := 'GET_SUBS_BY_TRNS_ORDER_ID';
15:21:32 3124  BEGIN
15:21:32 3125  	 OPEN out_result_set FOR
15:21:32 3126  	 SELECT subscription.id FROM
15:21:32 3127  	   subscription
15:21:32 3128  	 INNER JOIN license ON license.subscription_id = subscription.id
15:21:32 3129  	 INNER JOIN invoice ON invoice.id = license.invoice_id
15:21:32 3130  	 INNER JOIN charge ON invoice.id = charge.invoice_id
15:21:32 3131  	 INNER JOIN transaction ON charge.transaction_id = transaction.id
15:21:32 3132  	 WHERE transaction.order_id = in_order_id;
15:21:32 3133  EXCEPTION
15:21:32 3134  WHEN OTHERS THEN
15:21:32 3135  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 3136  	   SPROC_NAME, 'Unknown error', sqlerrm);
15:21:32 3137  END GET_SUBS_BY_TRNS_ORDER_ID;
15:21:32 3138  
15:21:32 3139  PROCEDURE GET_OPEN_CHARGES_BY_SUBID
15:21:32 3140  	(
15:21:32 3141  /*
15:21:32 3142  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 3143  */
15:21:32 3144  	 in_subscription_id  IN SUBSCRIPTION.ID%TYPE,
15:21:32 3145  	 out_result_set      OUT SYS_REFCURSOR
15:21:32 3146  )
15:21:32 3147  AS
15:21:32 3148  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_OPEN_CHARGES_BY_SUBID';
15:21:32 3149  BEGIN
15:21:32 3150  	 OPEN out_result_set FOR
15:21:32 3151  	 SELECT
15:21:32 3152  	   c.ID,
15:21:32 3153  	   c.TRANSACTION_ID,
15:21:32 3154  	   c.INSTRUMENT_ID,
15:21:32 3155  	   c.INSTRUMENT_TYPE_ID,
15:21:32 3156  	   c.CHARGE_AMOUNT,
15:21:32 3157  	   c.CREATE_DATE,
15:21:32 3158  	   c.CREATED_BY,
15:21:32 3159  	   c.INVOICE_ID
15:21:32 3160  	  FROM
15:21:32 3161  	   subscription s,
15:21:32 3162  	   license l,
15:21:32 3163  	   charge c
15:21:32 3164  	 WHERE
15:21:32 3165  	   s.id = l.subscription_id and
15:21:32 3166  	   l.invoice_id = c.invoice_id and
15:21:32 3167  	   c.charge_status_id = GLOBAL_STATUSES_V18.CHARGE_OPENED and
15:21:32 3168  	   exists (
15:21:32 3169  	     select null
15:21:32 3170  	     from transaction t
15:21:32 3171  	     where
15:21:32 3172  	       t.id = c.transaction_id
15:21:32 3173  	   ) and
15:21:32 3174  	   s.id = in_subscription_id;
15:21:32 3175  EXCEPTION
15:21:32 3176  WHEN OTHERS THEN
15:21:32 3177  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 3178  	   SPROC_NAME, 'Unknown error', sqlerrm);
15:21:32 3179  END GET_OPEN_CHARGES_BY_SUBID;
15:21:32 3180  
15:21:32 3181  FUNCTION GET_GIFT_CERT_ID_BY_SUB_ID (
15:21:32 3182  	 in_subscription_id IN SUBSCRIPTION.ID%TYPE
15:21:32 3183  ) RETURN NUMBER
15:21:32 3184  AS
15:21:32 3185  var_gift_certificate_id NUMBER;
15:21:32 3186  BEGIN
15:21:32 3187  	     SELECT id INTO var_gift_certificate_id
15:21:32 3188  	     FROM
15:21:32 3189  	       gift_certificate gc
15:21:32 3190  	     WHERE
15:21:32 3191  	       gc.finalized_invoice_id in (
15:21:32 3192  		 SELECT invoice_id
15:21:32 3193  		 FROM (
15:21:32 3194  		   SELECT l.invoice_id
15:21:32 3195  		   FROM
15:21:32 3196  		     license l
15:21:32 3197  		   WHERE
15:21:32 3198  		     l.subscription_id = in_subscription_id
15:21:32 3199  		   ORDER BY l.create_date asc
15:21:32 3200  		 )
15:21:32 3201  	       )
15:21:32 3202  	       and rownum <= 1;
15:21:32 3203  	     return var_gift_certificate_id;
15:21:32 3204  END GET_GIFT_CERT_ID_BY_SUB_ID;
15:21:32 3205  
15:21:32 3206  FUNCTION GET_GIFT_CERT_CODE_BY_SUB_ID (
15:21:32 3207  	 in_subscription_id IN SUBSCRIPTION.ID%TYPE
15:21:32 3208  ) RETURN VARCHAR2
15:21:32 3209  AS
15:21:32 3210  var_gift_certificate_code VARCHAR2(255 BYTE);
15:21:32 3211  BEGIN
15:21:32 3212  	     SELECT code INTO var_gift_certificate_code
15:21:32 3213  	     FROM
15:21:32 3214  	       gift_certificate gc
15:21:32 3215  	     WHERE
15:21:32 3216  	       gc.finalized_invoice_id in (
15:21:32 3217  		 SELECT invoice_id
15:21:32 3218  		 FROM (
15:21:32 3219  		   SELECT l.invoice_id
15:21:32 3220  		   FROM
15:21:32 3221  		     license l
15:21:32 3222  		   WHERE
15:21:32 3223  		     l.subscription_id = in_subscription_id
15:21:32 3224  		 )
15:21:32 3225  	       )
15:21:32 3226  	       and rownum <= 1;
15:21:32 3227  	     return var_gift_certificate_code;
15:21:32 3228  END GET_GIFT_CERT_CODE_BY_SUB_ID;
15:21:32 3229  
15:21:32 3230  PROCEDURE GET_ACTIVE_MEU_SUBS (
15:21:32 3231  	 out_result_set      OUT SYS_REFCURSOR
15:21:32 3232  )
15:21:32 3233  AS
15:21:32 3234  SPROC_NAME     CONSTANT VARCHAR2(19) := 'GET_ACTIVE_MEU_SUBS';
15:21:32 3235  BEGIN
15:21:32 3236  	 OPEN out_result_set FOR
15:21:32 3237  	       SELECT
15:21:32 3238  		   s.id,
15:21:32 3239  		   s.instrument_type_id,
15:21:32 3240  		   s.instrument_id,
15:21:32 3241  		   a.group_id,
15:21:32 3242  		   s.offer_chain_id
15:21:32 3243  	       FROM
15:21:32 3244  		   core_owner.subscription s,
15:21:32 3245  		   core_owner.account a
15:21:32 3246  	       WHERE
15:21:32 3247  		   a.id = s.account_id AND(
15:21:32 3248  		       s.offer_chain_id = 1745992781 OR
15:21:32 3249  		       s.offer_chain_id = 3902149773 OR
15:21:32 3250  		       s.offer_chain_id = 2240201337) AND
15:21:32 3251  		   NOT EXISTS
15:21:32 3252  		   (
15:21:32 3253  		       SELECT
15:21:32 3254  			   1
15:21:32 3255  		       FROM
15:21:32 3256  			   core_owner.subscription ss
15:21:32 3257  		       WHERE
15:21:32 3258  			   ss.account_id = a.id AND(
15:21:32 3259  			       ss.offer_chain_id = 2794122734 OR
15:21:32 3260  			       ss.offer_chain_id = 3564368005 OR
15:21:32 3261  			       ss.offer_chain_id = 757934392)) AND
15:21:32 3262  		   rownum < 5000;
15:21:32 3263  END GET_ACTIVE_MEU_SUBS;
15:21:32 3264  
15:21:32 3265  PROCEDURE GET_EARLIEST_ACTIVE_OFFER_ID (
15:21:32 3266  	 in_subscription_id  IN SUBSCRIPTION.ID%TYPE,
15:21:32 3267  	 out_offer_id	     OUT LICENSE.ID%TYPE
15:21:32 3268  )
15:21:32 3269  AS
15:21:32 3270  SPROC_NAME     CONSTANT VARCHAR2(28) := 'GET_EARLIEST_ACTIVE_OFFER_ID';
15:21:32 3271  BEGIN
15:21:32 3272  	 SELECT OFFER_ID INTO out_offer_id
15:21:32 3273  	 FROM LICENSE L,
15:21:32 3274  	 (
15:21:32 3275  	   SELECT MIN(ID) ID FROM LICENSE
15:21:32 3276  	   WHERE SUBSCRIPTION_ID = in_subscription_id
15:21:32 3277  	   AND LICENSE_STATUS_ID = 2
15:21:32 3278  	   AND SYSDATE BETWEEN START_DATE AND END_DATE
15:21:32 3279  	 ) EARLIEST_ACTIVE_LICENSE
15:21:32 3280  	 WHERE L.ID = EARLIEST_ACTIVE_LICENSE.ID;
15:21:32 3281  END GET_EARLIEST_ACTIVE_OFFER_ID;
15:21:32 3282  
15:21:32 3283  PROCEDURE GET_EARLIEST_ACTIVE_LICENSE_ID (
15:21:32 3284  	 in_subscription_id  IN SUBSCRIPTION.ID%TYPE,
15:21:32 3285  	 out_license_id      OUT LICENSE.ID%TYPE
15:21:32 3286  )
15:21:32 3287  AS
15:21:32 3288  SPROC_NAME     CONSTANT VARCHAR2(30) := 'GET_EARLIEST_ACTIVE_LICENSE_ID';
15:21:32 3289  BEGIN
15:21:32 3290  	 SELECT MIN(ID) into out_license_id
15:21:32 3291  	 FROM LICENSE
15:21:32 3292  	 WHERE SUBSCRIPTION_ID = in_subscription_id
15:21:32 3293  	   AND LICENSE_STATUS_ID = 2
15:21:32 3294  	 AND SYSDATE BETWEEN START_DATE AND END_DATE;
15:21:32 3295  END GET_EARLIEST_ACTIVE_LICENSE_ID;
15:21:32 3296  
15:21:32 3297  PROCEDURE GET_ACT_SUBS_W_CPT_CHARGEBACKS (
15:21:32 3298  	 out_result_set      OUT SYS_REFCURSOR
15:21:32 3299  )
15:21:32 3300  AS
15:21:32 3301  SPROC_NAME     CONSTANT VARCHAR2(30) := 'GET_ACT_SUBS_W_CPT_CHARGEBACKS';
15:21:32 3302  BEGIN
15:21:32 3303  	 OPEN out_result_set FOR
15:21:32 3304  	   SELECT
15:21:32 3305  	     s.id
15:21:32 3306  	   FROM
15:21:32 3307  	     core_owner.transaction t
15:21:32 3308  	   INNER JOIN
15:21:32 3309  	     core_owner.charge c
15:21:32 3310  	   ON
15:21:32 3311  	     c.transaction_id = t.id
15:21:32 3312  	   INNER JOIN
15:21:32 3313  	     core_owner.invoice i
15:21:32 3314  	   ON
15:21:32 3315  	     i.id = c.invoice_id
15:21:32 3316  	   INNER JOIN
15:21:32 3317  	     core_owner.license l
15:21:32 3318  	   ON
15:21:32 3319  	     i.id = l.invoice_id
15:21:32 3320  	   INNER JOIN
15:21:32 3321  	     core_owner.subscription s
15:21:32 3322  	   ON
15:21:32 3323  	     l.subscription_id = s.id
15:21:32 3324  	   INNER JOIN
15:21:32 3325  	     core_owner.account a
15:21:32 3326  	   ON
15:21:32 3327  	     s.account_id = a.id
15:21:32 3328  	   JOIN
15:21:32 3329  	     core_owner.rcn_cpt_chargeback_act_detail ccad
15:21:32 3330  	   ON
15:21:32 3331  	     t.order_id = ccad.merchant_order_number
15:21:32 3332  	   WHERE
15:21:32 3333  	     ccad.chargeback_category = 'RECD'
15:21:32 3334  	   AND s.subscription_status_id in (GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE, GLOBAL_STATUSES_V18.SUBSCRIPTION_IN_GRACE_PERIOD);
15:21:32 3335  END GET_ACT_SUBS_W_CPT_CHARGEBACKS;
15:21:32 3336  
15:21:32 3337  PROCEDURE GET_ACT_SUBS_W_PP_CHARGEBACKS (
15:21:32 3338  	 out_result_set      OUT SYS_REFCURSOR
15:21:32 3339  )
15:21:32 3340  AS
15:21:32 3341  SPROC_NAME     CONSTANT VARCHAR2(29) := 'GET_ACT_SUBS_W_PP_CHARGEBACKS';
15:21:32 3342  BEGIN
15:21:32 3343  	 OPEN out_result_set FOR
15:21:32 3344  	   SELECT
15:21:32 3345  	     s.id
15:21:32 3346  	   FROM
15:21:32 3347  	     core_owner.transaction t
15:21:32 3348  	   INNER JOIN
15:21:32 3349  	     core_owner.charge c
15:21:32 3350  	   ON
15:21:32 3351  	     c.transaction_id = t.id
15:21:32 3352  	   INNER JOIN
15:21:32 3353  	     core_owner.invoice i
15:21:32 3354  	   ON
15:21:32 3355  	     i.id = c.invoice_id
15:21:32 3356  	   INNER JOIN
15:21:32 3357  	     core_owner.license l
15:21:32 3358  	   ON
15:21:32 3359  	     i.id = l.invoice_id
15:21:32 3360  	   INNER JOIN
15:21:32 3361  	     core_owner.subscription s
15:21:32 3362  	   ON
15:21:32 3363  	     l.subscription_id = s.id
15:21:32 3364  	   INNER JOIN
15:21:32 3365  	     core_owner.account a
15:21:32 3366  	   ON
15:21:32 3367  	     s.account_id = a.id
15:21:32 3368  	   INNER JOIN
15:21:32 3369  	     core_owner.rcn_pp_trans_detail ptd
15:21:32 3370  	   ON
15:21:32 3371  	     t.order_id = ptd.invoice_id
15:21:32 3372  	   WHERE
15:21:32 3373  	     ptd.trans_status = 'D'
15:21:32 3374  	   AND s.subscription_status_id in (GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE, GLOBAL_STATUSES_V18.SUBSCRIPTION_IN_GRACE_PERIOD);
15:21:32 3375  END GET_ACT_SUBS_W_PP_CHARGEBACKS;
15:21:32 3376  
15:21:32 3377  PROCEDURE GET_GRACE_PERIOD_SUB_REGIS (
15:21:32 3378  	 in_max_days_until_close IN NUMBER,
15:21:32 3379  	 in_num_subs_to_fetch	 IN NUMBER,
15:21:32 3380  	 out_result_set 	 OUT SYS_REFCURSOR
15:21:32 3381  )
15:21:32 3382  AS
15:21:32 3383  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_GRACE_PERIOD_SUB_REGIS';
15:21:32 3384  BEGIN
15:21:32 3385  	 OPEN out_result_set FOR
15:21:32 3386  	 SELECT
15:21:32 3387  	     *
15:21:32 3388  	 FROM
15:21:32 3389  	     (
15:21:32 3390  		 SELECT
15:21:32 3391  		     a.group_id group_id,
15:21:32 3392  		     l.grace_end_date grace_end_date
15:21:32 3393  		 FROM
15:21:32 3394  		     license l
15:21:32 3395  		 JOIN
15:21:32 3396  		     subscription s
15:21:32 3397  		 ON
15:21:32 3398  		     s.id = l.subscription_id
15:21:32 3399  		 JOIN
15:21:32 3400  		     account a
15:21:32 3401  		 ON
15:21:32 3402  		     a.id = s.account_id
15:21:32 3403  		 WHERE
15:21:32 3404  		     l.license_status_id = GLOBAL_STATUSES_V18.LICENSE_IN_GRACE_PERIOD
15:21:32 3405  		 AND l.grace_end_date - SYSDATE <= in_max_days_until_close
15:21:32 3406  		 AND NOT EXISTS
15:21:32 3407  		     (
15:21:32 3408  			 SELECT
15:21:32 3409  			     NULL
15:21:32 3410  			 FROM
15:21:32 3411  			     process_retry_throttle
15:21:32 3412  			 WHERE
15:21:32 3413  			     process_name = sproc_name
15:21:32 3414  			 AND generic_id = a.group_id)
15:21:32 3415  		 AND rownum <= in_num_subs_to_fetch * 10
15:21:32 3416  		 ORDER BY
15:21:32 3417  		     dbms_random.value)
15:21:32 3418  	 WHERE
15:21:32 3419  	     rownum <= in_num_subs_to_fetch;
15:21:32 3420  END GET_GRACE_PERIOD_SUB_REGIS;
15:21:32 3421  
15:21:32 3422  PROCEDURE GET_ACT_SUBS_W_AMEX_CB (
15:21:32 3423  	 out_result_set      OUT SYS_REFCURSOR
15:21:32 3424  )
15:21:32 3425  AS
15:21:32 3426  SPROC_NAME     CONSTANT VARCHAR2(29) := 'GET_ACT_SUBS_W_AMEX_CB';
15:21:32 3427  BEGIN
15:21:32 3428  	 OPEN out_result_set FOR
15:21:32 3429  	   SELECT
15:21:32 3430  	     s.id
15:21:32 3431  	   FROM
15:21:32 3432  	     core_owner.transaction t
15:21:32 3433  	   INNER JOIN
15:21:32 3434  	     core_owner.charge c
15:21:32 3435  	   ON
15:21:32 3436  	     c.transaction_id = t.id
15:21:32 3437  	   INNER JOIN
15:21:32 3438  	     core_owner.invoice i
15:21:32 3439  	   ON
15:21:32 3440  	     i.id = c.invoice_id
15:21:32 3441  	   INNER JOIN
15:21:32 3442  	     core_owner.license l
15:21:32 3443  	   ON
15:21:32 3444  	     i.id = l.invoice_id
15:21:32 3445  	   INNER JOIN
15:21:32 3446  	     core_owner.subscription s
15:21:32 3447  	   ON
15:21:32 3448  	     l.subscription_id = s.id
15:21:32 3449  	   INNER JOIN
15:21:32 3450  	     core_owner.account a
15:21:32 3451  	   ON
15:21:32 3452  	     s.account_id = a.id
15:21:32 3453  	   INNER JOIN
15:21:32 3454  	     core_owner.rcn_amex_chargeback ac
15:21:32 3455  	   ON
15:21:32 3456  	     t.order_id = lower(ac.ind_ref_number)
15:21:32 3457  	   WHERE
15:21:32 3458  	     s.subscription_status_id in (GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE, GLOBAL_STATUSES_V18.SUBSCRIPTION_IN_GRACE_PERIOD);
15:21:32 3459  END GET_ACT_SUBS_W_AMEX_CB;
15:21:32 3460  
15:21:32 3461  END PROCS_SUBSCRIPTION_V18;
15:21:32 3462  .
15:21:32 SQL> /

Package body created.

Elapsed: 00:00:00.25
15:21:32 SQL> 
15:21:32 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_INVOICE_V18" AS
15:21:32   2  
15:21:32   3  PROCEDURE GET_INVOICE_IDS(
15:21:32   4  	in_group_id    IN ACCOUNT.GROUP_ID%TYPE,
15:21:32   5  	in_fin_id      IN SUBSCRIPTION.INSTRUMENT_ID%TYPE,
15:21:32   6  	out_result_set OUT SYS_REFCURSOR
15:21:32   7  ) AS
15:21:32   8  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_INVOICE_IDS';
15:21:32   9  BEGIN
15:21:32  10  	OPEN out_result_set FOR
15:21:32  11  	  SELECT
15:21:32  12  	    Invoice.ID
15:21:32  13  	  FROM
15:21:32  14  	      Invoice
15:21:32  15  	      INNER JOIN License
15:21:32  16  		ON
15:21:32  17  		  License.Invoice_Id = Invoice.Id
15:21:32  18  	      INNER JOIN Subscription
15:21:32  19  		ON
15:21:32  20  		  License.Subscription_Id = Subscription.Id
15:21:32  21  	      INNER JOIN account
15:21:32  22  		ON
15:21:32  23  		  Subscription.Account_Id = account.id
15:21:32  24  	  WHERE
15:21:32  25  	    Account.Group_Id = in_group_id
15:21:32  26  	    AND SUBSCRIPTION.INSTRUMENT_ID = in_fin_id
15:21:32  27  	    AND Invoice.Invoice_Status_Id = GLOBAL_STATUSES_V18.INVOICE_OPEN;
15:21:32  28  END GET_INVOICE_IDS;
15:21:32  29  
15:21:32  30  
15:21:32  31  PROCEDURE IS_INVOICE_FOR_GC (
15:21:32  32  	in_invoice_id IN NUMBER,
15:21:32  33  	out_result    OUT NUMBER
15:21:32  34  ) AS
15:21:32  35  SPROC_NAME CONSTANT VARCHAR2(32) := 'IS_INVOICE_FOR_GC';
15:21:32  36  var_is_for_gc NUMBER;
15:21:32  37  BEGIN
15:21:32  38  	SELECT
15:21:32  39  	  count(1) into var_is_for_gc
15:21:32  40  	FROM GIFT_CERTIFICATE GC
15:21:32  41  	WHERE GC.PURCHASE_INVOICE_ID = in_invoice_id;
15:21:32  42  
15:21:32  43  	IF var_is_for_gc > 0 THEN
15:21:32  44  	  out_result := 1;
15:21:32  45  	ELSE
15:21:32  46  	  out_result := 0;
15:21:32  47  	END IF;
15:21:32  48  END IS_INVOICE_FOR_GC;
15:21:32  49  
15:21:32  50  PROCEDURE CREATE_INVOICE(
15:21:32  51  /*
15:21:32  52  Throws exceptions:
15:21:32  53  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32  54  */
15:21:32  55  	  in_invoice_status IN NUMBER,
15:21:32  56  	  in_created_by     IN VARCHAR2,
15:21:32  57  	  in_tax_exempt_id  IN VARCHAR2,
15:21:32  58  	  out_invoice_id    OUT NUMBER
15:21:32  59  ) AS
15:21:32  60  -- VARIABLES
15:21:32  61  SPROC_NAME	 CONSTANT VARCHAR2(14) := 'CREATE_INVOICE';
15:21:32  62  var_new_invoice_id NUMBER;
15:21:32  63  -- EXCEPTIONS
15:21:32  64  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:32  65  BEGIN
15:21:32  66  
15:21:32  67  	PROCS_INVOICE_CRU_V18.CREATE_INVOICE(
15:21:32  68  	  out_invoice_id		 => var_new_invoice_id,
15:21:32  69  	  in_created_by 		 => in_created_by,
15:21:32  70  	  in_invoice_status_id		 => in_invoice_status,
15:21:32  71  	  in_tax_exempt_id		 => in_tax_exempt_id
15:21:32  72  	);
15:21:32  73  
15:21:32  74  	out_invoice_id := var_new_invoice_id;
15:21:32  75  
15:21:32  76  EXCEPTION
15:21:32  77  WHEN OTHERS THEN
15:21:32  78  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32  79  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32  80  END CREATE_INVOICE;
15:21:32  81  
15:21:32  82  /************************************************************/
15:21:32  83  
15:21:32  84  PROCEDURE GET_PENDING_INVOICES (
15:21:32  85  /*
15:21:32  86  Throws exceptions:
15:21:32  87  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32  88  */
15:21:32  89  	out_result_set1      OUT SYS_REFCURSOR,
15:21:32  90  	out_result_set2      OUT SYS_REFCURSOR,
15:21:32  91  	out_result_set3      OUT SYS_REFCURSOR,
15:21:32  92  	in_row_number	     IN NUMBER DEFAULT NULL
15:21:32  93  ) AS
15:21:32  94  SPROC_NAME CONSTANT VARCHAR2(20) := 'GET_PENDING_INVOICES';
15:21:32  95  -- COMSTANTS
15:21:32  96  DEFAULT_ROW_NUMBER CONSTANT NUMBER := 1;
15:21:32  97  -- VARIABLES
15:21:32  98  var_row_number NUMBER;
15:21:32  99  BEGIN
15:21:32 100  
15:21:32 101  	IF in_row_number IS NULL THEN
15:21:32 102  	  var_row_number := DEFAULT_ROW_NUMBER;
15:21:32 103  	ELSE
15:21:32 104  	  var_row_number := in_row_number;
15:21:32 105  	END IF;
15:21:32 106  
15:21:32 107  	-- Invoices with one or more payments(charges) with transaction status PENDING
15:21:32 108  	OPEN out_result_set1 FOR
15:21:32 109  SELECT * FROM
15:21:32 110  (
15:21:32 111  	SELECT
15:21:32 112  	  INVOICE.ID
15:21:32 113  	FROM
15:21:32 114  	  CHARGE
15:21:32 115  	  INNER JOIN INVOICE ON CHARGE.INVOICE_ID = INVOICE.ID
15:21:32 116  	WHERE
15:21:32 117  	  EXISTS(
15:21:32 118  	    SELECT NULL
15:21:32 119  	    FROM TRANSACTION
15:21:32 120  	    WHERE
15:21:32 121  	      TRANSACTION.TRANSACTION_STATUS_ID = GLOBAL_STATUSES_V18.TRANSACTION_PENDING
15:21:32 122  	      AND TRANSACTION.ID = CHARGE.TRANSACTION_ID
15:21:32 123  	      AND TRANSACTION.IS_REFUND != GLOBAL_CONSTANTS_V18.TRUE
15:21:32 124  	      AND TRANSACTION.TRANSACTION_AMOUNT >= 0
15:21:32 125  	  )
15:21:32 126  	  AND
15:21:32 127  	  NOT EXISTS(
15:21:32 128  	    SELECT NULL
15:21:32 129  	    FROM PROCESS_RETRY_THROTTLE
15:21:32 130  	    WHERE PROCESS_NAME = SPROC_NAME
15:21:32 131  	      AND GENERIC_ID = INVOICE.ID
15:21:32 132  	  )
15:21:32 133  	  AND ROWNUM <= var_row_number*10
15:21:32 134  	  ORDER BY dbms_random.value
15:21:32 135  ) WHERE
15:21:32 136  	  ROWNUM <= var_row_number;
15:21:32 137  
15:21:32 138  	-- Invoices not marked as CLOSED but are fully paid (shouldn't happen).
15:21:32 139  	OPEN out_result_set2 FOR
15:21:32 140  	SELECT
15:21:32 141  	  INVOICE.ID
15:21:32 142  	FROM
15:21:32 143  	  INVOICE
15:21:32 144  	WHERE
15:21:32 145  	  1 = 2 AND
15:21:32 146  	  (
15:21:32 147  	    INVOICE.INVOICE_STATUS_ID = GLOBAL_STATUSES_V18.INVOICE_OPEN
15:21:32 148  	  )
15:21:32 149  	  AND NOT EXISTS(
15:21:32 150  	    SELECT 1 FROM CHARGE WHERE INVOICE_ID=INVOICE.ID AND CHARGE_STATUS_ID = GLOBAL_STATUSES_V18.CHARGE_OPENED AND ROWNUM <= 1
15:21:32 151  	  )
15:21:32 152  	  AND EXISTS (
15:21:32 153  	    SELECT 1 FROM CHARGE WHERE INVOICE_ID=INVOICE.ID AND CHARGE_STATUS_ID != GLOBAL_STATUSES_V18.CHARGE_OPENED AND ROWNUM <= 1
15:21:32 154  	  )
15:21:32 155  	  AND INVOICE.ID NOT IN
15:21:32 156  	    (
15:21:32 157  	      SELECT GENERIC_ID
15:21:32 158  	      FROM PROCESS_RETRY_THROTTLE
15:21:32 159  	      WHERE
15:21:32 160  		PROCESS_NAME = SPROC_NAME
15:21:32 161  	    )
15:21:32 162  	  AND ROWNUM <= var_row_number;
15:21:32 163  
15:21:32 164  	-- Invoices not marked as CLOSED with no payments(charges).
15:21:32 165  	OPEN out_result_set3 FOR
15:21:32 166  	SELECT
15:21:32 167  	  INVOICE.ID
15:21:32 168  	FROM
15:21:32 169  	  INVOICE
15:21:32 170  	WHERE
15:21:32 171  	  1 = 2 AND
15:21:32 172  	  (
15:21:32 173  	    INVOICE.INVOICE_STATUS_ID = GLOBAL_STATUSES_V18.INVOICE_OPEN
15:21:32 174  	  )
15:21:32 175  	  AND NOT EXISTS (
15:21:32 176  	    SELECT 1 FROM CHARGE WHERE CHARGE.INVOICE_ID = INVOICE.ID AND ROWNUM <= 1
15:21:32 177  	  )
15:21:32 178  	  AND INVOICE.ID NOT IN
15:21:32 179  	    (
15:21:32 180  	      SELECT GENERIC_ID
15:21:32 181  	      FROM PROCESS_RETRY_THROTTLE
15:21:32 182  	      WHERE
15:21:32 183  		PROCESS_NAME = SPROC_NAME
15:21:32 184  	    )
15:21:32 185  	  AND ROWNUM <= var_row_number;
15:21:32 186  
15:21:32 187  EXCEPTION
15:21:32 188  WHEN OTHERS THEN
15:21:32 189  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 190  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 191  END GET_PENDING_INVOICES;
15:21:32 192  
15:21:32 193  /************************************************************/
15:21:32 194  
15:21:32 195  FUNCTION F_CALCULATE_INVOICE_AMOUNT(
15:21:32 196  	in_invoice_id IN  NUMBER
15:21:32 197  ) RETURN NUMBER AS
15:21:32 198  var_amount NUMBER;
15:21:32 199  BEGIN
15:21:32 200  
15:21:32 201  	CALCULATE_INVOICE_AMOUNT(in_invoice_id, var_amount);
15:21:32 202  	RETURN var_amount;
15:21:32 203  
15:21:32 204  END;
15:21:32 205  
15:21:32 206  PROCEDURE CALCULATE_INVOICE_AMOUNT (
15:21:32 207  /*
15:21:32 208  Throws exceptions:
15:21:32 209  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 210  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 211  */
15:21:32 212  	in_invoice_id IN  NUMBER,
15:21:32 213  	out_amount    OUT NUMBER
15:21:32 214  ) AS
15:21:32 215  -- VARIABLES
15:21:32 216  SPROC_NAME	     CONSTANT VARCHAR2(24) := 'CALCULATE_INVOICE_AMOUNT';
15:21:32 217  temp_invoice_id	     NUMBER;
15:21:32 218  var_total_amount	     NUMBER(10,6);
15:21:32 219  var_final_amount	     NUMBER(10,2);
15:21:32 220  var_line_item_amount   NUMBER(10,6);
15:21:32 221  
15:21:32 222  var_line_items_set     SYS_REFCURSOR;
15:21:32 223  var_line_item_id	     NUMBER;
15:21:32 224  var_line_item_quantity NUMBER;
15:21:32 225  var_line_item_price    NUMBER (10,2);
15:21:32 226  
15:21:32 227  var_discount_fixed_amount NUMBER (10,2);
15:21:32 228  var_discount_percent_amount NUMBER (10,2);
15:21:32 229  
15:21:32 230  -- EXCEPTIONS
15:21:32 231  BAD_INVOICE_ID		    EXCEPTION;
15:21:32 232  CAN_NOT_CALC_LINE_ITEM_AMOUNT EXCEPTION;
15:21:32 233  EXCEPTION_MESSAGE VARCHAR2(1024);
15:21:32 234  BEGIN
15:21:32 235  
15:21:32 236  	var_total_amount := 0;
15:21:32 237  
15:21:32 238  	-- Check that given invoice exists
15:21:32 239  	BEGIN
15:21:32 240  	  SELECT
15:21:32 241  	    INVOICE.ID into temp_invoice_id
15:21:32 242  	  FROM
15:21:32 243  	    INVOICE
15:21:32 244  	  WHERE
15:21:32 245  	    INVOICE.ID = in_invoice_id
15:21:32 246  	    AND ROWNUM <= 1;
15:21:32 247  	  EXCEPTION
15:21:32 248  	    WHEN NO_DATA_FOUND THEN
15:21:32 249  	      RAISE BAD_INVOICE_ID;
15:21:32 250  	END;
15:21:32 251  
15:21:32 252  	-- Calculate amount for each line item in invoice
15:21:32 253  	FOR f_line_item IN (
15:21:32 254  	  SELECT
15:21:32 255  	    LINE_ITEM.ID
15:21:32 256  	  FROM
15:21:32 257  	    LINE_ITEM
15:21:32 258  	  WHERE
15:21:32 259  	    LINE_ITEM.INVOICE_ID = in_invoice_id
15:21:32 260  	)
15:21:32 261  	LOOP
15:21:32 262  	  BEGIN
15:21:32 263  	    PROCS_LINE_ITEMS_V18.CALCULATE_LINE_ITEM_AMOUNT(
15:21:32 264  	      in_line_item_id => f_line_item.ID,
15:21:32 265  	      out_amount      => var_line_item_amount
15:21:32 266  	    );
15:21:32 267  	    var_total_amount := var_total_amount + var_line_item_amount;
15:21:32 268  	    EXCEPTION
15:21:32 269  	      WHEN OTHERS THEN
15:21:32 270  		EXCEPTION_MESSAGE := SQLERRM;
15:21:32 271  		RAISE CAN_NOT_CALC_LINE_ITEM_AMOUNT;
15:21:32 272  	  END;
15:21:32 273  	END LOOP;
15:21:32 274  	var_final_amount := var_total_amount;
15:21:32 275  	out_amount := var_final_amount;
15:21:32 276  
15:21:32 277  EXCEPTION
15:21:32 278  WHEN BAD_INVOICE_ID THEN
15:21:32 279  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 280  	  SPROC_NAME, 'No such invoice');
15:21:32 281  WHEN CAN_NOT_CALC_LINE_ITEM_AMOUNT THEN
15:21:32 282  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 283  	  SPROC_NAME, 'Could not calculate line item amount', EXCEPTION_MESSAGE);
15:21:32 284  WHEN OTHERS THEN
15:21:32 285  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 286  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 287  END;
15:21:32 288  
15:21:32 289  PROCEDURE GET_ACCOUNT_BY_INVOICE_ID (
15:21:32 290  /*
15:21:32 291  Throws exceptions:
15:21:32 292  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 293  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 294  */
15:21:32 295  	in_invoice_id  IN  NUMBER,
15:21:32 296  	out_account_id OUT NUMBER
15:21:32 297  ) AS
15:21:32 298  -- VARIABLES
15:21:32 299  SPROC_NAME	 CONSTANT VARCHAR2(25) := 'GET_ACCOUNT_BY_INVOICE_ID';
15:21:32 300  temp_gc_account_id NUMBER;
15:21:32 301  temp_ss_account_id NUMBER;
15:21:32 302  temp_invoice_id	 NUMBER;
15:21:32 303  -- EXCEPTIONS
15:21:32 304  BAD_INVOICE_ID	   EXCEPTION;
15:21:32 305  CAN_NOT_FIND_ACCOUNT EXCEPTION;
15:21:32 306  BEGIN
15:21:32 307  
15:21:32 308  	-- Check that given invoice exists
15:21:32 309  	BEGIN
15:21:32 310  	  SELECT
15:21:32 311  	    INVOICE.ID into temp_invoice_id
15:21:32 312  	  FROM
15:21:32 313  	    INVOICE
15:21:32 314  	  WHERE
15:21:32 315  	    INVOICE.ID = in_invoice_id;
15:21:32 316  	  EXCEPTION
15:21:32 317  	    WHEN NO_DATA_FOUND THEN
15:21:32 318  	      RAISE BAD_INVOICE_ID;
15:21:32 319  	END;
15:21:32 320  
15:21:32 321  	-- Try to find gift certificate with given invoice
15:21:32 322  	BEGIN
15:21:32 323  	  SELECT
15:21:32 324  	    ACCOUNT.GROUP_ID into temp_gc_account_id
15:21:32 325  	  FROM
15:21:32 326  	    GIFT_CERTIFICATE
15:21:32 327  	    INNER JOIN ACCOUNT ON GIFT_CERTIFICATE.PURCHASER_GROUP_ID = ACCOUNT.GROUP_ID
15:21:32 328  	  WHERE
15:21:32 329  	    GIFT_CERTIFICATE.PURCHASE_INVOICE_ID = in_invoice_id
15:21:32 330  	    AND ROWNUM <= 1;
15:21:32 331  	  EXCEPTION
15:21:32 332  	    WHEN NO_DATA_FOUND THEN
15:21:32 333  	      temp_gc_account_id := NULL;
15:21:32 334  	END;
15:21:32 335  
15:21:32 336  	-- check subscriptions for given invoice
15:21:32 337  	IF temp_gc_account_id IS NOT NULL THEN
15:21:32 338  	  out_account_id := temp_gc_account_id;
15:21:32 339  	ELSE
15:21:32 340  	  BEGIN
15:21:32 341  	    SELECT
15:21:32 342  	      ACCOUNT.GROUP_ID into temp_ss_account_id
15:21:32 343  	    FROM
15:21:32 344  	      LICENSE
15:21:32 345  	      INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
15:21:32 346  	      INNER JOIN ACCOUNT ON SUBSCRIPTION.ACCOUNT_ID = ACCOUNT.ID
15:21:32 347  	    WHERE
15:21:32 348  	      LICENSE.INVOICE_ID = in_invoice_id
15:21:32 349  	      AND ROWNUM <= 1;
15:21:32 350  	    EXCEPTION
15:21:32 351  	      WHEN NO_DATA_FOUND THEN
15:21:32 352  		temp_ss_account_id := NULL;
15:21:32 353  	  END;
15:21:32 354  	  IF temp_ss_account_id IS NULL THEN
15:21:32 355  	    RAISE CAN_NOT_FIND_ACCOUNT;
15:21:32 356  	  ELSE
15:21:32 357  	    out_account_id := temp_ss_account_id;
15:21:32 358  	  END IF;
15:21:32 359  	END IF;
15:21:32 360  
15:21:32 361  EXCEPTION
15:21:32 362  WHEN BAD_INVOICE_ID THEN
15:21:32 363  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 364  	  SPROC_NAME, 'No such invoice');
15:21:32 365  WHEN CAN_NOT_FIND_ACCOUNT THEN
15:21:32 366  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 367  	  SPROC_NAME, 'Could not find account by given invoice id');
15:21:32 368  WHEN OTHERS THEN
15:21:32 369  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 370  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 371  END GET_ACCOUNT_BY_INVOICE_ID;
15:21:32 372  
15:21:32 373  /*****************************************************************/
15:21:32 374  
15:21:32 375  PROCEDURE GET_INVOICE_DETAILS (
15:21:32 376  /*
15:21:32 377  Throws exceptions:
15:21:32 378  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 379  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 380  */
15:21:32 381  	in_invoice_id	   IN  NUMBER,
15:21:32 382  	out_group_id	   OUT NUMBER,
15:21:32 383  	out_status_id	   OUT NUMBER,
15:21:32 384  	out_line_items_set OUT SYS_REFCURSOR,
15:21:32 385  	out_pp_charges_set OUT SYS_REFCURSOR,
15:21:32 386  	out_cc_charges_set OUT SYS_REFCURSOR,
15:21:32 387  	out_gc_charges_set OUT SYS_REFCURSOR
15:21:32 388  ) AS
15:21:32 389  -- VARIABLES
15:21:32 390  SPROC_NAME CONSTANT VARCHAR2(19) := 'GET_INVOICE_DETAILS';
15:21:32 391  
15:21:32 392  -- EXCEPTIONS
15:21:32 393  BAD_INVOICE_ID	     EXCEPTION;
15:21:32 394  CAN_NOT_FIND_ACCOUNT   EXCEPTION;
15:21:32 395  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:32 396  BEGIN
15:21:32 397  
15:21:32 398  	-- get invoice status
15:21:32 399  	BEGIN
15:21:32 400  	  SELECT
15:21:32 401  	    INVOICE.INVOICE_STATUS_ID into out_status_id
15:21:32 402  	  FROM
15:21:32 403  	    INVOICE
15:21:32 404  	  WHERE
15:21:32 405  	    INVOICE.ID = in_invoice_id;
15:21:32 406  	  EXCEPTION
15:21:32 407  	    WHEN NO_DATA_FOUND THEN
15:21:32 408  	      RAISE BAD_INVOICE_ID;
15:21:32 409  	END;
15:21:32 410  
15:21:32 411  	-- get group id
15:21:32 412  	BEGIN
15:21:32 413  	  PROCS_INVOICE_V18.GET_ACCOUNT_BY_INVOICE_ID(in_invoice_id, out_group_id);
15:21:32 414  	  EXCEPTION
15:21:32 415  	    WHEN OTHERS THEN
15:21:32 416  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:32 417  	      RAISE CAN_NOT_FIND_ACCOUNT;
15:21:32 418  	END;
15:21:32 419  
15:21:32 420  	-- get all line items for given invoice
15:21:32 421  	OPEN out_line_items_set FOR
15:21:32 422  	SELECT
15:21:32 423  	  LINE_ITEM.AMOUNT,
15:21:32 424  	  LINE_ITEM.ID,
15:21:32 425  	  LINE_ITEM.CREATED_BY,
15:21:32 426  	  LINE_ITEM.CREATE_DATE,
15:21:32 427  	  LINE_ITEM.DISCOUNT_AMOUNT,
15:21:32 428  	  LINE_ITEM.TAXES_AMOUNT,
15:21:32 429  	  LINE_ITEM.PRODUCT_OFFER_ID,
15:21:32 430  	  LINE_ITEM.INVOICE_ID
15:21:32 431  	FROM
15:21:32 432  	  LINE_ITEM
15:21:32 433  	WHERE
15:21:32 434  	  LINE_ITEM.INVOICE_ID = in_invoice_id;
15:21:32 435  
15:21:32 436  	-- get all pp charges for given invoice
15:21:32 437  	OPEN out_pp_charges_set FOR
15:21:32 438  	SELECT
15:21:32 439  	  CHARGE.ID as "CHARGE_ID",
15:21:32 440  	  CHARGE_AMOUNT,
15:21:32 441  	  CHARGE.INSTRUMENT_ID,
15:21:32 442  	  CHARGE.CHARGE_STATUS_ID
15:21:32 443  	FROM
15:21:32 444  	  CHARGE
15:21:32 445  	WHERE
15:21:32 446  	  CHARGE.INVOICE_ID = in_invoice_id
15:21:32 447  	  AND CHARGE.INSTRUMENT_TYPE_ID = GLOBAL_ENUMS_V18.INSTRUMENT_PAYPAL;
15:21:32 448  
15:21:32 449  	-- get all credir cards for given invoice
15:21:32 450  	OPEN out_cc_charges_set FOR
15:21:32 451  	SELECT
15:21:32 452  	  CHARGE.ID as "CHARGE_ID",
15:21:32 453  	  CHARGE.CHARGE_AMOUNT,
15:21:32 454  	  CHARGE.INSTRUMENT_ID,
15:21:32 455  	  CHARGE.CHARGE_STATUS_ID
15:21:32 456  	FROM
15:21:32 457  	  CHARGE
15:21:32 458  	WHERE
15:21:32 459  	  CHARGE.INVOICE_ID = in_invoice_id
15:21:32 460  	  AND CHARGE.INSTRUMENT_TYPE_ID = GLOBAL_ENUMS_V18.INSTRUMENT_CREDIT_CARD;
15:21:32 461  
15:21:32 462  	OPEN out_gc_charges_set FOR
15:21:32 463  	SELECT
15:21:32 464  	  CHARGE.ID as "CHARGE_ID",
15:21:32 465  	  CHARGE.CHARGE_AMOUNT,
15:21:32 466  	  CHARGE.INSTRUMENT_ID,
15:21:32 467  	  CHARGE.CHARGE_STATUS_ID
15:21:32 468  	FROM
15:21:32 469  	  CHARGE
15:21:32 470  	WHERE
15:21:32 471  	  CHARGE.INVOICE_ID = in_invoice_id
15:21:32 472  	  AND CHARGE.INSTRUMENT_TYPE_ID = GLOBAL_ENUMS_V18.INSTRUMENT_GIFT_CERTIFICATE;
15:21:32 473  
15:21:32 474  EXCEPTION
15:21:32 475  WHEN BAD_INVOICE_ID THEN
15:21:32 476  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 477  	  SPROC_NAME, 'No such invoice');
15:21:32 478  WHEN CAN_NOT_FIND_ACCOUNT THEN
15:21:32 479  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 480  	  SPROC_NAME, 'Could not find account for given invoice id', EXCEPTION_MESSAGE);
15:21:32 481  WHEN OTHERS THEN
15:21:32 482  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 483  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 484  END GET_INVOICE_DETAILS;
15:21:32 485  
15:21:32 486  /******************************************************/
15:21:32 487  -- norlov: #38796
15:21:32 488  PROCEDURE GET_TRANSACTION_INVOICE (
15:21:32 489  /*
15:21:32 490  Throws exceptions:
15:21:32 491  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 492  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 493  */
15:21:32 494  	in_transaction_id  IN  NUMBER,
15:21:32 495  	out_result_set	      OUT SYS_REFCURSOR
15:21:32 496  ) AS
15:21:32 497  SPROC_NAME CONSTANT  VARCHAR2(23) := 'GET_TRANSACTION_INVOICE';
15:21:32 498  -- VARIABLES
15:21:32 499  temp_transaction_id  NUMBER;
15:21:32 500  var_invoice_id	   NUMBER;
15:21:32 501  var_subscription_id  NUMBER;
15:21:32 502  var_offer_chain_id   NUMBER;
15:21:32 503  var_offer_chain_name VARCHAR2(255);
15:21:32 504  -- EXCEPTIONS
15:21:32 505  BAD_TRANSACTION_ID     EXCEPTION;
15:21:32 506  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:32 507  BEGIN
15:21:32 508   -- check if there is the transaction
15:21:32 509  	BEGIN
15:21:32 510  	  SELECT
15:21:32 511  	    TRANSACTION.ID into temp_transaction_id
15:21:32 512  	  FROM
15:21:32 513  	    TRANSACTION
15:21:32 514  	  WHERE
15:21:32 515  	    TRANSACTION.ID = in_transaction_id;
15:21:32 516  	  EXCEPTION
15:21:32 517  	    WHEN NO_DATA_FOUND THEN
15:21:32 518  	      RAISE BAD_TRANSACTION_ID;
15:21:32 519  	END;
15:21:32 520  
15:21:32 521  	-- Get invoice id
15:21:32 522  	SELECT DISTINCT
15:21:32 523  	  CHARGE.INVOICE_ID into var_invoice_id
15:21:32 524  	FROM
15:21:32 525  	  CHARGE
15:21:32 526  	WHERE
15:21:32 527  	  CHARGE.TRANSACTION_ID = in_transaction_id;
15:21:32 528  
15:21:32 529  	-- Get subscription id if exists
15:21:32 530  	BEGIN
15:21:32 531  	  SELECT DISTINCT
15:21:32 532  	    LICENSE.SUBSCRIPTION_ID into var_subscription_id
15:21:32 533  	  FROM
15:21:32 534  	    LICENSE
15:21:32 535  	  WHERE
15:21:32 536  	    LICENSE.INVOICE_ID = var_invoice_id;
15:21:32 537  	  EXCEPTION
15:21:32 538  	    WHEN NO_DATA_FOUND THEN
15:21:32 539  	      var_subscription_id := NULL;
15:21:32 540  	END;
15:21:32 541  
15:21:32 542  	IF var_subscription_id IS NOT NULL THEN
15:21:32 543  	  -- Fetch offer chain from subscription
15:21:32 544  	  SELECT
15:21:32 545  	    OFFER_CHAIN.ID,
15:21:32 546  	    OFFER_CHAIN.NAME
15:21:32 547  	    into
15:21:32 548  	    var_offer_chain_id,
15:21:32 549  	    var_offer_chain_name
15:21:32 550  	  FROM
15:21:32 551  	    OFFER_CHAIN
15:21:32 552  	    INNER JOIN SUBSCRIPTION ON SUBSCRIPTION.OFFER_CHAIN_ID = OFFER_CHAIN.ID
15:21:32 553  	  WHERE
15:21:32 554  	    SUBSCRIPTION.ID = var_subscription_id;
15:21:32 555  	ELSE
15:21:32 556  	  -- Fetch offer chain from GC
15:21:32 557  	  SELECT
15:21:32 558  	    OFFER_CHAIN.ID,
15:21:32 559  	    OFFER_CHAIN.NAME
15:21:32 560  	    into
15:21:32 561  	    var_offer_chain_id,
15:21:32 562  	    var_offer_chain_name
15:21:32 563  	  FROM
15:21:32 564  	    OFFER_CHAIN
15:21:32 565  	    INNER JOIN GIFT_CERTIFICATE ON GIFT_CERTIFICATE.OFFER_CHAIN_ID = OFFER_CHAIN.ID
15:21:32 566  	  WHERE
15:21:32 567  	    GIFT_CERTIFICATE.PURCHASE_INVOICE_ID = var_invoice_id;
15:21:32 568  	END IF;
15:21:32 569  
15:21:32 570  	OPEN out_result_set FOR
15:21:32 571  	SELECT DISTINCT
15:21:32 572  	  var_invoice_id       AS "INVOICE_ID",
15:21:32 573  	  var_subscription_id  AS "SUBSCRIPTION_ID",
15:21:32 574  	  var_offer_chain_id   AS "OFFER_CHAIN_ID",
15:21:32 575  	  var_offer_chain_name AS "OFFER_CHAIN_NAME"
15:21:32 576  	FROM
15:21:32 577  	  DUAL;
15:21:32 578  
15:21:32 579  EXCEPTION
15:21:32 580  WHEN BAD_TRANSACTION_ID THEN
15:21:32 581  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 582  	  SPROC_NAME, 'No such transaction');
15:21:32 583  WHEN OTHERS THEN
15:21:32 584  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 585  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 586  END GET_TRANSACTION_INVOICE;
15:21:32 587  
15:21:32 588  /******************************************************/
15:21:32 589  
15:21:32 590  PROCEDURE UPDATE_INVOICE_STATUS (
15:21:32 591  /*
15:21:32 592  Throws exceptions:
15:21:32 593  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 594  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 595  */
15:21:32 596  	in_invoice_id		       IN NUMBER,
15:21:32 597  	in_invoice_status_id	       IN NUMBER,
15:21:32 598  	in_updated_by		       IN VARCHAR2
15:21:32 599  ) AS
15:21:32 600  SPROC_NAME CONSTANT VARCHAR2(21) := 'UPDATE_INVOICE_STATUS';
15:21:32 601  -- VARIABLES
15:21:32 602  temp_invoice_id NUMBER;
15:21:32 603  -- EXCEPTIONS
15:21:32 604  BAD_INVOICE_ID		      EXCEPTION;
15:21:32 605  BAD_INVOICE_STATUS_ID	      EXCEPTION;
15:21:32 606  EXCEPTION_MESSAGE 	      VARCHAR2(1024);
15:21:32 607  BEGIN
15:21:32 608  
15:21:32 609  	-- Check if invoice exists
15:21:32 610  	BEGIN
15:21:32 611  	  SELECT
15:21:32 612  	    INVOICE.ID into temp_invoice_id
15:21:32 613  	  FROM
15:21:32 614  	    INVOICE
15:21:32 615  	  WHERE
15:21:32 616  	    INVOICE.ID = in_invoice_id;
15:21:32 617  	  EXCEPTION
15:21:32 618  	    WHEN NO_DATA_FOUND THEN
15:21:32 619  	      RAISE BAD_INVOICE_ID;
15:21:32 620  	END;
15:21:32 621  
15:21:32 622  	IF in_invoice_status_id != GLOBAL_STATUSES_V18.INVOICE_OPEN
15:21:32 623  	  AND in_invoice_status_id != GLOBAL_STATUSES_V18.INVOICE_CLOSED THEN
15:21:32 624  	  RAISE BAD_INVOICE_STATUS_ID;
15:21:32 625  	END IF;
15:21:32 626  
15:21:32 627  	PROCS_INVOICE_CRU_V18.UPDATE_INVOICE(
15:21:32 628  	  in_invoice_id 		 => in_invoice_id,
15:21:32 629  	  in_invoice_status_id		 => in_invoice_status_id,
15:21:32 630  	  in_updated_by 		 => in_updated_by
15:21:32 631  	);
15:21:32 632  
15:21:32 633  EXCEPTION
15:21:32 634  WHEN BAD_INVOICE_STATUS_ID THEN
15:21:32 635  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 636  	  SPROC_NAME, 'Bad invoice status id');
15:21:32 637  WHEN BAD_INVOICE_ID THEN
15:21:32 638  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 639  	  SPROC_NAME, 'No such invoice');
15:21:32 640  WHEN OTHERS THEN
15:21:32 641  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 642  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 643  END UPDATE_INVOICE_STATUS;
15:21:32 644  
15:21:32 645  /****************************************************************/
15:21:32 646  
15:21:32 647  FUNCTION IS_INVOICE_PAYING_STARTED (
15:21:32 648  /*
15:21:32 649  Throws exceptions:
15:21:32 650  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 651  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 652  */
15:21:32 653  	in_invoice_id IN NUMBER
15:21:32 654  ) RETURN NUMBER AS
15:21:32 655  -- VARIABLES
15:21:32 656  SPROC_NAME		 CONSTANT VARCHAR2(30) := 'IS_INVOICE_PAYING_STARTED';
15:21:32 657  temp_invoice_id		 NUMBER;
15:21:32 658  var_processed_charges_num  NUMBER;
15:21:32 659  var_processed_transac_num  NUMBER;
15:21:32 660  var_success_attempts_num	 NUMBER;
15:21:32 661  var_is_gc 		 NUMBER;
15:21:32 662  -- EXCEPTIONS
15:21:32 663  BAD_INVOICE_ID EXCEPTION;
15:21:32 664  BEGIN
15:21:32 665  
15:21:32 666  	-- Check that invoice exists
15:21:32 667  	BEGIN
15:21:32 668  	  SELECT
15:21:32 669  	    INVOICE.ID into temp_invoice_id
15:21:32 670  	  FROM
15:21:32 671  	    INVOICE
15:21:32 672  	  WHERE
15:21:32 673  	    INVOICE.ID = in_invoice_id;
15:21:32 674  	  EXCEPTION
15:21:32 675  	   WHEN NO_DATA_FOUND THEN
15:21:32 676  	     RAISE BAD_INVOICE_ID;
15:21:32 677  	END;
15:21:32 678  
15:21:32 679  	-- Check that there are tansaction attempts with status success
15:21:32 680  	SELECT
15:21:32 681  	  COUNT(1) into var_success_attempts_num
15:21:32 682  	FROM
15:21:32 683  	  TRANSACTION_ATTEMPT ta,
15:21:32 684  	  TRANSACTION t,
15:21:32 685  	  CHARGE c
15:21:32 686  	WHERE
15:21:32 687  	  ta.TRANSACTION_ATTEMPT_STATUS_ID = GLOBAL_STATUSES_V18.TRANS_ATTEMPT_SUCCESS and
15:21:32 688  	  ta.transaction_id = t.id and
15:21:32 689  	  c.transaction_id = t.id and
15:21:32 690  	  t.is_refund = GLOBAL_CONSTANTS_V18.FALSE and
15:21:32 691  	  c.invoice_id = in_invoice_id
15:21:32 692  	;
15:21:32 693  
15:21:32 694  	IF var_success_attempts_num > 0 THEN
15:21:32 695  	  RETURN GLOBAL_CONSTANTS_V18.TRUE;
15:21:32 696  	END IF;
15:21:32 697  
15:21:32 698  	SELECT
15:21:32 699  	  COUNT(1) into var_success_attempts_num
15:21:32 700  	FROM
15:21:32 701  	  TRANSACTION t,
15:21:32 702  	  CHARGE c
15:21:32 703  	WHERE
15:21:32 704  	  c.transaction_id = t.id and
15:21:32 705  	  t.is_refund = GLOBAL_CONSTANTS_V18.FALSE and
15:21:32 706  	  t.is_settled = GLOBAL_CONSTANTS_V18.TRUE and
15:21:32 707  	  c.invoice_id = in_invoice_id
15:21:32 708  	;
15:21:32 709  
15:21:32 710  	IF var_success_attempts_num > 0 THEN
15:21:32 711  	  RETURN GLOBAL_CONSTANTS_V18.TRUE;
15:21:32 712  	END IF;
15:21:32 713  
15:21:32 714  	SELECT
15:21:32 715  	  COUNT(1) into var_is_gc
15:21:32 716  	FROM
15:21:32 717  	  gift_certificate gc
15:21:32 718  	WHERE
15:21:32 719  	  gc.finalized_invoice_id = in_invoice_id
15:21:32 720  	;
15:21:32 721  
15:21:32 722  	IF var_is_gc > 0 THEN
15:21:32 723  	  RETURN GLOBAL_CONSTANTS_V18.TRUE;
15:21:32 724  	END IF;
15:21:32 725  
15:21:32 726  	RETURN GLOBAL_CONSTANTS_V18.FALSE;
15:21:32 727  
15:21:32 728  EXCEPTION
15:21:32 729  WHEN BAD_INVOICE_ID THEN
15:21:32 730  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 731  	  SPROC_NAME, 'No such invoice');
15:21:32 732  WHEN OTHERS THEN
15:21:32 733  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 734  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 735  END IS_INVOICE_PAYING_STARTED;
15:21:32 736  
15:21:32 737  /******************************************************************************/
15:21:32 738  
15:21:32 739  PROCEDURE P_IS_INVOICE_PAYING_STARTED (
15:21:32 740  	in_invoice_id  IN NUMBER,
15:21:32 741  	out_is_started OUT NUMBER
15:21:32 742  ) AS
15:21:32 743  BEGIN
15:21:32 744  	-- Just a wrapper
15:21:32 745  	out_is_started := PROCS_INVOICE_V18.IS_INVOICE_PAYING_STARTED(in_invoice_id);
15:21:32 746  END P_IS_INVOICE_PAYING_STARTED;
15:21:32 747  
15:21:32 748  /******************************************************************************/
15:21:32 749  
15:21:32 750  PROCEDURE CALCULATE_INVOICE_CHARGEBACK (
15:21:32 751  	in_invoice_id	      IN NUMBER,
15:21:32 752  	in_chargeback_date    IN DATE,
15:21:32 753  	out_chargeback_amount OUT NUMBER
15:21:32 754  ) AS
15:21:32 755  -- VARIABLES
15:21:32 756  SPROC_NAME	     CONSTANT VARCHAR2(28) := 'CALCULATE_INVOICE_CHARGEBACK';
15:21:32 757  var_chargeback_date    DATE;
15:21:32 758  temp_invoice_id	     NUMBER;
15:21:32 759  var_licenses_number    NUMBER;
15:21:32 760  var_invoice_start_date DATE;
15:21:32 761  var_invoice_end_date   DATE;
15:21:32 762  var_offer_id	     NUMBER;
15:21:32 763  var_offer_days_interval NUMBER;
15:21:32 764  var_license_days_used  NUMBER;
15:21:32 765  var_invoice_amount     NUMBER(10,2);
15:21:32 766  var_offer_chain_id     NUMBER;
15:21:32 767  var_offer_chain_meta_data_val VARCHAR2(1024);
15:21:32 768  var_offer_chain_full_refund   NUMBER;
15:21:32 769  var_offer_chain_prorated_ref  NUMBER;
15:21:32 770  var_chargeback_calculated NUMBER;
15:21:32 771  var_max_invoice_refund	NUMBER;
15:21:32 772  -- EXCEPTIONS
15:21:32 773  BAD_INVOICE_ID		  EXCEPTION;
15:21:32 774  NO_LICENSES_FOUND_EXCEPTION EXCEPTION;
15:21:32 775  OFFER_LENGTH_IS_ZERO	  EXCEPTION;
15:21:32 776  BEGIN
15:21:32 777  
15:21:32 778  	IF in_chargeback_date IS NULL THEN
15:21:32 779  	  var_chargeback_date := PROCS_COMMON_V18.NORMALIZE_DATE(current_date);
15:21:32 780  	ELSE
15:21:32 781  	  var_chargeback_date := PROCS_COMMON_V18.NORMALIZE_DATE(in_chargeback_date);
15:21:32 782  	END IF;
15:21:32 783  
15:21:32 784  	-- Check that invoice exists
15:21:32 785  	BEGIN
15:21:32 786  	  SELECT
15:21:32 787  	    INVOICE.ID into temp_invoice_id
15:21:32 788  	  FROM
15:21:32 789  	    INVOICE
15:21:32 790  	  WHERE
15:21:32 791  	    INVOICE.ID = in_invoice_id;
15:21:32 792  	  EXCEPTION
15:21:32 793  	    WHEN NO_DATA_FOUND THEN
15:21:32 794  	      RAISE BAD_INVOICE_ID;
15:21:32 795  	END;
15:21:32 796  
15:21:32 797  	-- Check that invoice has at least one license
15:21:32 798  	SELECT
15:21:32 799  	  COUNT(*) into var_licenses_number
15:21:32 800  	FROM
15:21:32 801  	  LICENSE
15:21:32 802  	WHERE
15:21:32 803  	  LICENSE.INVOICE_ID = in_invoice_id;
15:21:32 804  
15:21:32 805  	IF var_licenses_number = 0 THEN
15:21:32 806  	  RAISE NO_LICENSES_FOUND_EXCEPTION;
15:21:32 807  	END IF;
15:21:32 808  
15:21:32 809  	SELECT
15:21:32 810  	  MIN(LICENSE.START_DATE) into var_invoice_start_date
15:21:32 811  	FROM
15:21:32 812  	  LICENSE
15:21:32 813  	WHERE
15:21:32 814  	  LICENSE.INVOICE_ID = in_invoice_id;
15:21:32 815  
15:21:32 816  	var_invoice_start_date := PROCS_COMMON_V18.NORMALIZE_DATE(var_invoice_start_date);
15:21:32 817  
15:21:32 818  	SELECT DISTINCT
15:21:32 819  	  LICENSE.OFFER_ID into var_offer_id
15:21:32 820  	FROM
15:21:32 821  	  LICENSE
15:21:32 822  	WHERE
15:21:32 823  	  LICENSE.INVOICE_ID = in_invoice_id;
15:21:32 824  
15:21:32 825  	SELECT
15:21:32 826  	  MAX (LICENSE.END_DATE) into var_invoice_end_date
15:21:32 827  	FROM
15:21:32 828  	  LICENSE
15:21:32 829  	WHERE
15:21:32 830  	  LICENSE.INVOICE_ID = in_invoice_id;
15:21:32 831  
15:21:32 832  	-- All licenses for given invoice should point into the same offer
15:21:32 833  
15:21:32 834  	PROCS_OFFER_CHAIN_V18.GET_OFFER_LENGTH_IN_DAYS(
15:21:32 835  	  in_offer_id	=> var_offer_id,
15:21:32 836  	  in_start_date => var_invoice_start_date,
15:21:32 837  	  out_days	=> var_offer_days_interval
15:21:32 838  	);
15:21:32 839  
15:21:32 840  	IF var_offer_days_interval = 0 THEN
15:21:32 841  	  RAISE OFFER_LENGTH_IS_ZERO;
15:21:32 842  	END IF;
15:21:32 843  
15:21:32 844  	PROCS_INVOICE_V18.GET_INVOICE_DAYS_USED_NUMBER(
15:21:32 845  	  in_invoice_id      => in_invoice_id,
15:21:32 846  	  in_chargeback_date => var_chargeback_date,
15:21:32 847  	  out_days_num	     => var_license_days_used
15:21:32 848  	);
15:21:32 849  
15:21:32 850  	PROCS_INVOICE_V18.CALCULATE_INVOICE_AMOUNT(
15:21:32 851  	  in_invoice_id => in_invoice_id,
15:21:32 852  	  out_amount	=> var_invoice_amount
15:21:32 853  	);
15:21:32 854  
15:21:32 855  	-- 39437
15:21:32 856  	-- Get offer chain id by invoice id
15:21:32 857  	SELECT DISTINCT
15:21:32 858  	  SUBSCRIPTION.OFFER_CHAIN_ID into var_offer_chain_id
15:21:32 859  	FROM
15:21:32 860  	  SUBSCRIPTION
15:21:32 861  	  INNER JOIN LICENSE ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
15:21:32 862  	WHERE
15:21:32 863  	  LICENSE.INVOICE_ID = in_invoice_id;
15:21:32 864  
15:21:32 865  	-- Get offer chain's meta data full amount value
15:21:32 866  	PROCS_OFFER_CHAIN_V18.GET_OFFER_CHAIN_MD_VALUE(
15:21:32 867  	  in_offer_chain_id => var_offer_chain_id,
15:21:32 868  	  in_meta_data_name => GLOBAL_CONSTANTS_V18.OFFER_CHAIN_FULL_REFUND,
15:21:32 869  	  out_value	    => var_offer_chain_meta_data_val
15:21:32 870  	);
15:21:32 871  	IF var_offer_chain_meta_data_val IS NULL THEN
15:21:32 872  	  var_offer_chain_full_refund := NULL;
15:21:32 873  	ELSE
15:21:32 874  	  var_offer_chain_full_refund := TO_NUMBER(var_offer_chain_meta_data_val);
15:21:32 875  	END IF;
15:21:32 876  
15:21:32 877  	-- Get offer chain's meta data prorated amount value
15:21:32 878  	PROCS_OFFER_CHAIN_V18.GET_OFFER_CHAIN_MD_VALUE(
15:21:32 879  	  in_offer_chain_id => var_offer_chain_id,
15:21:32 880  	  in_meta_data_name => GLOBAL_CONSTANTS_V18.OFFER_CHAIN_PRORATED_REFUND,
15:21:32 881  	  out_value	    => var_offer_chain_meta_data_val
15:21:32 882  	);
15:21:32 883  	IF var_offer_chain_meta_data_val IS NULL THEN
15:21:32 884  	  var_offer_chain_prorated_ref := NULL;
15:21:32 885  	ELSE
15:21:32 886  	  var_offer_chain_prorated_ref := TO_NUMBER(var_offer_chain_meta_data_val);
15:21:32 887  	END IF;
15:21:32 888  
15:21:32 889  	var_chargeback_calculated := GLOBAL_CONSTANTS_V18.FALSE;
15:21:32 890  
15:21:32 891  	IF var_offer_chain_full_refund IS NOT NULL
15:21:32 892  	   AND var_chargeback_calculated = GLOBAL_CONSTANTS_V18.FALSE THEN
15:21:32 893  	  IF var_license_days_used < var_offer_chain_full_refund THEN
15:21:32 894  	    out_chargeback_amount := var_invoice_amount;
15:21:32 895  	    var_chargeback_calculated := GLOBAL_CONSTANTS_V18.TRUE;
15:21:32 896  	  END IF;
15:21:32 897  	END IF;
15:21:32 898  
15:21:32 899  	IF var_offer_chain_prorated_ref IS NOT NULL
15:21:32 900  	   AND var_chargeback_calculated = GLOBAL_CONSTANTS_V18.FALSE THEN
15:21:32 901  	  IF var_license_days_used < var_offer_chain_prorated_ref THEN
15:21:32 902  	    out_chargeback_amount := ( var_invoice_amount * (var_offer_days_interval - var_license_days_used) ) / var_offer_days_interval;
15:21:32 903  	    var_chargeback_calculated := GLOBAL_CONSTANTS_V18.TRUE;
15:21:32 904  	  END IF;
15:21:32 905  	END IF;
15:21:32 906  
15:21:32 907  	IF var_chargeback_calculated = GLOBAL_CONSTANTS_V18.TRUE THEN
15:21:32 908  	  PROCS_INVOICE_V18.GET_MAX_REFUND(
15:21:32 909  	    in_invoice_id => in_invoice_id,
15:21:32 910  	    out_amount	  => var_max_invoice_refund
15:21:32 911  	  );
15:21:32 912  	  IF var_max_invoice_refund < out_chargeback_amount THEN
15:21:32 913  	    out_chargeback_amount := var_max_invoice_refund;
15:21:32 914  	  END IF;
15:21:32 915  	END IF;
15:21:32 916  
15:21:32 917  	IF var_chargeback_calculated = GLOBAL_CONSTANTS_V18.FALSE THEN
15:21:32 918  	  out_chargeback_amount := 0;
15:21:32 919  	END IF;
15:21:32 920  
15:21:32 921  EXCEPTION
15:21:32 922  WHEN BAD_INVOICE_ID THEN
15:21:32 923  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 924  	  SPROC_NAME, 'No such invoice');
15:21:32 925  WHEN NO_LICENSES_FOUND_EXCEPTION THEN
15:21:32 926  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 927  	  SPROC_NAME, 'No licenses found');
15:21:32 928  WHEN OFFER_LENGTH_IS_ZERO THEN
15:21:32 929  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 930  	  SPROC_NAME, 'Offer length is zero');
15:21:32 931  WHEN OTHERS THEN
15:21:32 932  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 933  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 934  END CALCULATE_INVOICE_CHARGEBACK;
15:21:32 935  
15:21:32 936  /********************************************************************/
15:21:32 937  
15:21:32 938  PROCEDURE APPLY_REFUND (
15:21:32 939  	in_invoice_id	     IN NUMBER,
15:21:32 940  	in_chargeback_amount IN NUMBER,
15:21:32 941  	in_created_by	     IN VARCHAR2,
15:21:32 942  	out_charge_id	     OUT NUMBER
15:21:32 943  ) AS
15:21:32 944  -- VARIABLES
15:21:32 945  SPROC_NAME		 CONSTANT VARCHAR2(16) := 'APPLY_CHARGEBACK';
15:21:32 946  temp_invoice_id		 NUMBER;
15:21:32 947  var_total_charges_amount	 NUMBER(10,2);
15:21:32 948  var_charge_amount_to_apply NUMBER(10,2);
15:21:32 949  var_transaction_id	 NUMBER;
15:21:32 950  var_instrument_type_id	 NUMBER;
15:21:32 951  var_instrument_id 	 NUMBER;
15:21:32 952  var_charge_id		 NUMBER;
15:21:32 953  -- EXCEPTIONS
15:21:32 954  BAD_INVOICE_ID		 EXCEPTION;
15:21:32 955  CAN_NOT_CREATE_TRANSACTION EXCEPTION;
15:21:32 956  CAN_NOT_FIND_INSTRUMENT	 EXCEPTION;
15:21:32 957  CAN_NOT_CREATE_CHARGE	 EXCEPTION;
15:21:32 958  EXCEPTION_MESSAGE 	 VARCHAR2(1024);
15:21:32 959  BEGIN
15:21:32 960  
15:21:32 961  	BEGIN
15:21:32 962  	  SELECT
15:21:32 963  	    INVOICE.ID into temp_invoice_id
15:21:32 964  	  FROM
15:21:32 965  	    INVOICE
15:21:32 966  	  WHERE
15:21:32 967  	    INVOICE.ID = in_invoice_id;
15:21:32 968  	  EXCEPTION
15:21:32 969  	    WHEN NO_DATA_FOUND THEN
15:21:32 970  	      RAISE BAD_INVOICE_ID;
15:21:32 971  	END;
15:21:32 972  
15:21:32 973  	SELECT
15:21:32 974  	  SUM (CHARGE.CHARGE_AMOUNT) into var_total_charges_amount
15:21:32 975  	FROM
15:21:32 976  	  CHARGE
15:21:32 977  	WHERE
15:21:32 978  	  CHARGE.INVOICE_ID = in_invoice_id
15:21:32 979  	  AND CHARGE.CHARGE_STATUS_ID = GLOBAL_STATUSES_V18.CHARGE_PROCESSED
15:21:32 980  	  AND CHARGE.INSTRUMENT_TYPE_ID != GLOBAL_ENUMS_V18.INSTRUMENT_GIFT_CERTIFICATE;
15:21:32 981  
15:21:32 982  	-- FIXME: Maybe whe should throw exception here?
15:21:32 983  	IF var_total_charges_amount < in_chargeback_amount THEN
15:21:32 984  	  var_charge_amount_to_apply := var_total_charges_amount;
15:21:32 985  	ELSE
15:21:32 986  	  var_charge_amount_to_apply := in_chargeback_amount;
15:21:32 987  	END IF;
15:21:32 988  
15:21:32 989  	BEGIN
15:21:32 990  	  PROCS_TRANSACTION_V18.CREATE_TRANSACTION(
15:21:32 991  	    in_transaction_id	      => NULL,
15:21:32 992  	    in_status_id	      => GLOBAL_STATUSES_V18.TRANSACTION_PREPARE,
15:21:32 993  	    in_amount		      => -var_charge_amount_to_apply,
15:21:32 994  	    in_created_by	      => in_created_by,
15:21:32 995  	    in_order_id 	      => NULL,
15:21:32 996  	    in_is_refund	      => GLOBAL_CONSTANTS_V18.TRUE,
15:21:32 997  	    in_transaction_type_code  => 'REFUND',
15:21:32 998  	    out_transaction_id	      => var_transaction_id
15:21:32 999  	  );
15:21:32 1000  	   EXCEPTION
15:21:32 1001  	     WHEN OTHERS THEN
15:21:32 1002  	       EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1003  	       RAISE CAN_NOT_CREATE_TRANSACTION;
15:21:32 1004  	 END;
15:21:32 1005  
15:21:32 1006  	 BEGIN
15:21:32 1007  	   SELECT
15:21:32 1008  	     C.INSTRUMENT_TYPE_ID,
15:21:32 1009  	     C.INSTRUMENT_ID
15:21:32 1010  	     into
15:21:32 1011  	     var_instrument_type_id,
15:21:32 1012  	     var_instrument_id
15:21:32 1013  	   FROM
15:21:32 1014  	     CHARGE C,
15:21:32 1015  	     TRANSACTION_ATTEMPT TA,
15:21:32 1016  	     TRANSACTION T
15:21:32 1017  	   WHERE
15:21:32 1018  	     C.INVOICE_ID = in_invoice_id and
15:21:32 1019  	     C.TRANSACTION_ID = T.ID and
15:21:32 1020  	     TA.TRANSACTION_ID = T.ID and
15:21:32 1021  	     TA.TRANSACTION_ATTEMPT_STATUS_ID = GLOBAL_STATUSES_V18.TRANS_ATTEMPT_SUCCESS and
15:21:32 1022  	     T.IS_REFUND = GLOBAL_CONSTANTS_V18.FALSE and
15:21:32 1023  	     T.TRANSACTION_AMOUNT >= 0 and
15:21:32 1024  	     rownum < 2;
15:21:32 1025  	 EXCEPTION
15:21:32 1026  	     WHEN NO_DATA_FOUND THEN
15:21:32 1027  	       RAISE CAN_NOT_FIND_INSTRUMENT;
15:21:32 1028  	 END;
15:21:32 1029  	 BEGIN
15:21:32 1030  	   PROCS_CHARGE_V18.CREATE_CHARGE(
15:21:32 1031  	     in_invoice_id	   => in_invoice_id,
15:21:32 1032  	     in_transaction_id	   => var_transaction_id,
15:21:32 1033  	     in_instrument_type_id => var_instrument_type_id,
15:21:32 1034  	     in_instrument_id	   => var_instrument_id,
15:21:32 1035  	     in_charge_amount	   => -var_charge_amount_to_apply,
15:21:32 1036  	     in_created_by	   => in_created_by,
15:21:32 1037  	     in_charge_status_id   => GLOBAL_STATUSES_V18.CHARGE_OPENED,
15:21:32 1038  	     out_charge_id	   => var_charge_id
15:21:32 1039  	   );
15:21:32 1040  	   EXCEPTION
15:21:32 1041  	     WHEN OTHERS THEN
15:21:32 1042  	       EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1043  	       RAISE CAN_NOT_CREATE_CHARGE;
15:21:32 1044  	 END;
15:21:32 1045  
15:21:32 1046  	 out_charge_id := var_charge_id;
15:21:32 1047  
15:21:32 1048  EXCEPTION
15:21:32 1049  WHEN BAD_INVOICE_ID THEN
15:21:32 1050  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1051  	   SPROC_NAME, 'No such invoice');
15:21:32 1052  WHEN CAN_NOT_CREATE_TRANSACTION THEN
15:21:32 1053  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1054  	   SPROC_NAME, 'Could not create transaction', EXCEPTION_MESSAGE);
15:21:32 1055  WHEN CAN_NOT_FIND_INSTRUMENT THEN
15:21:32 1056  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1057  	   SPROC_NAME, 'Could not find financial instrument');
15:21:32 1058  WHEN CAN_NOT_CREATE_CHARGE THEN
15:21:32 1059  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1060  	   SPROC_NAME, 'Could not create charge', EXCEPTION_MESSAGE);
15:21:32 1061  WHEN OTHERS THEN
15:21:32 1062  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1063  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1064  END APPLY_REFUND;
15:21:32 1065  
15:21:32 1066  /******************************************************************************/
15:21:32 1067  
15:21:32 1068  PROCEDURE GET_MAX_REFUND (
15:21:32 1069  	 in_invoice_id IN NUMBER,
15:21:32 1070  	 out_amount    OUT NUMBER
15:21:32 1071  ) AS
15:21:32 1072  SPROC_NAME CONSTANT VARCHAR2(14) := 'GET_MAX_REFUND';
15:21:32 1073  -- VARIABLES
15:21:32 1074  temp_invoice_id	       NUMBER;
15:21:32 1075  var_invoice_refunds_sum NUMBER(10,2);
15:21:32 1076  var_invoice_charges_sum NUMBER(10,2);
15:21:32 1077  -- EXCEPTIONS
15:21:32 1078  BAD_INVOICE_ID EXCEPTION;
15:21:32 1079  BEGIN
15:21:32 1080  
15:21:32 1081  	 BEGIN
15:21:32 1082  	   SELECT
15:21:32 1083  	     INVOICE.ID into temp_invoice_id
15:21:32 1084  	   FROM
15:21:32 1085  	     INVOICE
15:21:32 1086  	   WHERE
15:21:32 1087  	     INVOICE.ID = in_invoice_id;
15:21:32 1088  	   EXCEPTION
15:21:32 1089  	     WHEN NO_DATA_FOUND THEN
15:21:32 1090  	       RAISE BAD_INVOICE_ID;
15:21:32 1091  	 END;
15:21:32 1092  
15:21:32 1093  	 var_invoice_refunds_sum := 0;
15:21:32 1094  	 var_invoice_charges_sum := 0;
15:21:32 1095  
15:21:32 1096  	 FOR f_charge IN (
15:21:32 1097  	   SELECT
15:21:32 1098  	     CHARGE.ID,
15:21:32 1099  	     CHARGE.CHARGE_STATUS_ID,
15:21:32 1100  	     CHARGE.CHARGE_AMOUNT,
15:21:32 1101  	     CHARGE.TRANSACTION_ID
15:21:32 1102  	   FROM
15:21:32 1103  	     CHARGE
15:21:32 1104  	   WHERE
15:21:32 1105  	     CHARGE.INVOICE_ID = in_invoice_id
15:21:32 1106  	 )
15:21:32 1107  	 LOOP
15:21:32 1108  	   -- If charge.status = canceled then continue
15:21:32 1109  	   IF f_charge.CHARGE_STATUS_ID != GLOBAL_STATUSES_V18.CHARGE_CANCELED THEN
15:21:32 1110  
15:21:32 1111  	     IF f_charge.CHARGE_AMOUNT > 0 THEN
15:21:32 1112  	       IF f_charge.CHARGE_STATUS_ID = GLOBAL_STATUSES_V18.CHARGE_PROCESSED
15:21:32 1113  		  AND PROCS_TRANSACTION_V18.IS_TRANSACTION_COLLECTED(f_charge.TRANSACTION_ID) = GLOBAL_CONSTANTS_V18.TRUE THEN
15:21:32 1114  		 -- Transaction collected
15:21:32 1115  		 var_invoice_charges_sum := var_invoice_charges_sum + f_charge.CHARGE_AMOUNT;
15:21:32 1116  	       ELSE
15:21:32 1117  		 -- Transaction is not collected. Do nothing
15:21:32 1118  		 NULL;
15:21:32 1119  	       END IF;
15:21:32 1120  	     ELSE
15:21:32 1121  	       IF f_charge.CHARGE_STATUS_ID = GLOBAL_STATUSES_V18.CHARGE_PROCESSED
15:21:32 1122  		  AND PROCS_TRANSACTION_V18.IS_TRANSACTION_COLLECTED(f_charge.TRANSACTION_ID) = GLOBAL_CONSTANTS_V18.FALSE THEN
15:21:32 1123  		 -- If charge is processed transaction is not collected then do nothing
15:21:32 1124  		 NULL;
15:21:32 1125  	       ELSE
15:21:32 1126  		 var_invoice_refunds_sum := var_invoice_refunds_sum + f_charge.CHARGE_AMOUNT;
15:21:32 1127  	       END IF;
15:21:32 1128  	     END IF;
15:21:32 1129  
15:21:32 1130  	   END IF;
15:21:32 1131  	 END LOOP;
15:21:32 1132  
15:21:32 1133  	 -- Refunds are negative
15:21:32 1134  	 var_invoice_refunds_sum := 0 - var_invoice_refunds_sum;
15:21:32 1135  
15:21:32 1136  	 out_amount := var_invoice_charges_sum - var_invoice_refunds_sum;
15:21:32 1137  
15:21:32 1138  EXCEPTION
15:21:32 1139  WHEN BAD_INVOICE_ID THEN
15:21:32 1140  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1141  	   SPROC_NAME, 'No such invoice');
15:21:32 1142  WHEN OTHERS THEN
15:21:32 1143  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1144  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1145  END GET_MAX_REFUND;
15:21:32 1146  
15:21:32 1147  /******************************************************************************/
15:21:32 1148  
15:21:32 1149  PROCEDURE GET_INVOICE_DAYS_USED_NUMBER (
15:21:32 1150  	 in_invoice_id	     IN NUMBER,
15:21:32 1151  	 in_chargeback_date  IN DATE DEFAULT SYSDATE,
15:21:32 1152  	 out_days_num	     OUT NUMBER
15:21:32 1153  ) AS
15:21:32 1154  SPROC_NAME CONSTANT VARCHAR2(28) := 'GET_INVOICE_DAYS_USED_NUMBER';
15:21:32 1155  -- VARIABLES
15:21:32 1156  temp_invoice_id	      NUMBER;
15:21:32 1157  var_license_start_date DATE;
15:21:32 1158  var_license_end_date   DATE;
15:21:32 1159  var_chargeback_date    DATE;
15:21:32 1160  var_invoice_days_used  NUMBER;
15:21:32 1161  -- EXCEPTIONS
15:21:32 1162  BAD_INVOICE_ID EXCEPTION;
15:21:32 1163  BEGIN
15:21:32 1164  
15:21:32 1165  	 var_chargeback_date := NVL(in_chargeback_date, SYSDATE);
15:21:32 1166  
15:21:32 1167  	 BEGIN
15:21:32 1168  	   SELECT
15:21:32 1169  	     INVOICE.ID into temp_invoice_id
15:21:32 1170  	   FROM
15:21:32 1171  	     INVOICE
15:21:32 1172  	   WHERE
15:21:32 1173  	     INVOICE.ID = in_invoice_id;
15:21:32 1174  	   EXCEPTION
15:21:32 1175  	     WHEN NO_DATA_FOUND THEN
15:21:32 1176  	       RAISE BAD_INVOICE_ID;
15:21:32 1177  	 END;
15:21:32 1178  
15:21:32 1179  	 var_invoice_days_used := 0;
15:21:32 1180  
15:21:32 1181  	 FOR f_license IN (
15:21:32 1182  	   SELECT
15:21:32 1183  	     LICENSE.START_DATE,
15:21:32 1184  	     LICENSE.END_DATE
15:21:32 1185  	   FROM
15:21:32 1186  	     LICENSE
15:21:32 1187  	   WHERE
15:21:32 1188  	     LICENSE.INVOICE_ID = in_invoice_id
15:21:32 1189  	     AND LICENSE.IS_EXTENSION = GLOBAL_CONSTANTS_V18.FALSE
15:21:32 1190  	 )
15:21:32 1191  	 LOOP
15:21:32 1192  	   var_license_start_date := PROCS_COMMON_V18.NORMALIZE_DATE(f_license.START_DATE);
15:21:32 1193  	   var_license_end_date := PROCS_COMMON_V18.NORMALIZE_DATE(f_license.END_DATE);
15:21:32 1194  
15:21:32 1195  	   IF var_license_start_date <= var_chargeback_date THEN
15:21:32 1196  	     IF var_license_end_date <= var_chargeback_date THEN
15:21:32 1197  	       -- License is passed
15:21:32 1198  	       var_invoice_days_used := var_invoice_days_used + (var_license_end_date - var_license_start_date);
15:21:32 1199  	     ELSE
15:21:32 1200  	       -- This is current license
15:21:32 1201  	       var_invoice_days_used := var_invoice_days_used + (var_chargeback_date - var_license_start_date);
15:21:32 1202  	     END IF;
15:21:32 1203  	   ELSE
15:21:32 1204  	     -- if var_license_start_date > in_chargeback_date then do nothing
15:21:32 1205  	     NULL;
15:21:32 1206  	   END IF;
15:21:32 1207  	 END LOOP;
15:21:32 1208  
15:21:32 1209  	 out_days_num := var_invoice_days_used;
15:21:32 1210  
15:21:32 1211  EXCEPTION
15:21:32 1212  WHEN BAD_INVOICE_ID THEN
15:21:32 1213  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1214  	   SPROC_NAME, 'No such invoice');
15:21:32 1215  WHEN OTHERS THEN
15:21:32 1216  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1217  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1218  END GET_INVOICE_DAYS_USED_NUMBER;
15:21:32 1219  
15:21:32 1220  /******************************************************************************/
15:21:32 1221  
15:21:32 1222  PROCEDURE GET_INVOICE_LINE_ITEMS (
15:21:32 1223  	 in_invoice_id	IN NUMBER,
15:21:32 1224  	 out_result_set OUT SYS_REFCURSOR
15:21:32 1225  ) AS
15:21:32 1226  SPROC_NAME CONSTANT VARCHAR2(22) := 'GET_INVOICE_LINE_ITEMS';
15:21:32 1227  -- VARIABLES
15:21:32 1228  temp_invoice_id NUMBER;
15:21:32 1229  -- EXCEPTIONS
15:21:32 1230  BAD_INVOICE_ID EXCEPTION;
15:21:32 1231  BEGIN
15:21:32 1232  
15:21:32 1233  	 BEGIN
15:21:32 1234  	   SELECT
15:21:32 1235  	     INVOICE.ID into temp_invoice_id
15:21:32 1236  	   FROM
15:21:32 1237  	     INVOICE
15:21:32 1238  	   WHERE
15:21:32 1239  	     INVOICE.ID = in_invoice_id;
15:21:32 1240  	   EXCEPTION
15:21:32 1241  	     WHEN NO_DATA_FOUND THEN
15:21:32 1242  	       RAISE BAD_INVOICE_ID;
15:21:32 1243  	 END;
15:21:32 1244  
15:21:32 1245  	 OPEN out_result_set FOR
15:21:32 1246  	 SELECT
15:21:32 1247  	   LINE_ITEM.ID,
15:21:32 1248  	   LINE_ITEM.PRODUCT_OFFER_ID,
15:21:32 1249  	   LINE_ITEM.INVOICE_ID,
15:21:32 1250  	   LINE_ITEM.AMOUNT,
15:21:32 1251  	   LINE_ITEM.DISCOUNT_AMOUNT,
15:21:32 1252  	   LINE_ITEM.TAXES_AMOUNT,
15:21:32 1253  	   LINE_ITEM.CREATE_DATE,
15:21:32 1254  	   LINE_ITEM.CREATED_BY
15:21:32 1255  	 FROM
15:21:32 1256  	   LINE_ITEM
15:21:32 1257  	 WHERE
15:21:32 1258  	   LINE_ITEM.INVOICE_ID = in_invoice_id;
15:21:32 1259  
15:21:32 1260  EXCEPTION
15:21:32 1261  WHEN BAD_INVOICE_ID THEN
15:21:32 1262  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1263  	   SPROC_NAME, 'No such invoice');
15:21:32 1264  WHEN OTHERS THEN
15:21:32 1265  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1266  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1267  END GET_INVOICE_LINE_ITEMS;
15:21:32 1268  
15:21:32 1269  /******************************************************************************/
15:21:32 1270  
15:21:32 1271  PROCEDURE GET_INVOICE_LICENSES (
15:21:32 1272  	 in_invoice_id	IN NUMBER,
15:21:32 1273  	 out_result_set OUT SYS_REFCURSOR
15:21:32 1274  ) AS
15:21:32 1275  SPROC_NAME CONSTANT VARCHAR2(20) := 'GET_INVOICE_LICENSES';
15:21:32 1276  -- VARIABLES
15:21:32 1277  temp_invoice_id NUMBER;
15:21:32 1278  -- EXCEPTIONS
15:21:32 1279  BAD_INVOICE_ID EXCEPTION;
15:21:32 1280  BEGIN
15:21:32 1281  
15:21:32 1282  	 BEGIN
15:21:32 1283  	   SELECT
15:21:32 1284  	     INVOICE.ID into temp_invoice_id
15:21:32 1285  	   FROM
15:21:32 1286  	     INVOICE
15:21:32 1287  	   WHERE
15:21:32 1288  	     INVOICE.ID = in_invoice_id;
15:21:32 1289  	   EXCEPTION
15:21:32 1290  	     WHEN NO_DATA_FOUND THEN
15:21:32 1291  	       RAISE BAD_INVOICE_ID;
15:21:32 1292  	 END;
15:21:32 1293  
15:21:32 1294  	 OPEN out_result_set FOR
15:21:32 1295  	 SELECT
15:21:32 1296  	   LICENSE.ID,
15:21:32 1297  	   LICENSE.INVOICE_ID,
15:21:32 1298  	   LICENSE.CREATE_DATE,
15:21:32 1299  	   LICENSE.CREATED_BY,
15:21:32 1300  	   LICENSE.CURRENT_OFFER_INDEX,
15:21:32 1301  	   LICENSE.CURRENT_OFFER_RECURR_NUM,
15:21:32 1302  	   LICENSE.END_DATE,
15:21:32 1303  	   LICENSE.ENTITLEMENT_END_DATE,
15:21:32 1304  	   LICENSE.IS_EXTENSION,
15:21:32 1305  	   LICENSE.LICENSE_STATUS_ID,
15:21:32 1306  	   LICENSE.NEEDS_ENTITLEMENTS,
15:21:32 1307  	   LICENSE.OFFER_ID,
15:21:32 1308  	   LICENSE.START_DATE,
15:21:32 1309  	   LICENSE.SUBSCRIPTION_ID,
15:21:32 1310  	   LICENSE.UPDATE_DATE,
15:21:32 1311  	   LICENSE.UPDATED_BY
15:21:32 1312  	 FROM
15:21:32 1313  	   LICENSE
15:21:32 1314  	 WHERE
15:21:32 1315  	   LICENSE.INVOICE_ID = in_invoice_id;
15:21:32 1316  
15:21:32 1317  EXCEPTION
15:21:32 1318  WHEN BAD_INVOICE_ID THEN
15:21:32 1319  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1320  	   SPROC_NAME, 'No such invoice');
15:21:32 1321  WHEN OTHERS THEN
15:21:32 1322  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1323  	   SPROC_NAME, 'Unknown error');
15:21:32 1324  END GET_INVOICE_LICENSES;
15:21:32 1325  
15:21:32 1326  /******************************************************************************/
15:21:32 1327  
15:21:32 1328  PROCEDURE GET_OFFER_CH_ID_BY_INVOICE_ID (
15:21:32 1329  	 in_invoice_id	    IN NUMBER,
15:21:32 1330  	 out_offer_chain_id OUT NUMBER
15:21:32 1331  ) AS
15:21:32 1332  SPROC_NAME CONSTANT VARCHAR2(29) := 'GET_OFFER_CH_ID_BY_INVOICE_ID';
15:21:32 1333  -- VARIABLES
15:21:32 1334  temp_invoice_id NUMBER;
15:21:32 1335  -- EXCEPTIONS
15:21:32 1336  BAD_INVOICE_ID EXCEPTION;
15:21:32 1337  BEGIN
15:21:32 1338  
15:21:32 1339  	 BEGIN
15:21:32 1340  	   SELECT
15:21:32 1341  	     INVOICE.ID into temp_invoice_id
15:21:32 1342  	   FROM
15:21:32 1343  	     INVOICE
15:21:32 1344  	   WHERE
15:21:32 1345  	     INVOICE.ID = in_invoice_id;
15:21:32 1346  	   EXCEPTION
15:21:32 1347  	     WHEN NO_DATA_FOUND THEN
15:21:32 1348  	       RAISE BAD_INVOICE_ID;
15:21:32 1349  	 END;
15:21:32 1350  
15:21:32 1351  	 BEGIN
15:21:32 1352  	   SELECT DISTINCT
15:21:32 1353  	     SUBSCRIPTION.OFFER_CHAIN_ID into out_offer_chain_id
15:21:32 1354  	   FROM
15:21:32 1355  	     LICENSE
15:21:32 1356  	     INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
15:21:32 1357  	   WHERE
15:21:32 1358  	     LICENSE.INVOICE_ID = in_invoice_id;
15:21:32 1359  	   EXCEPTION
15:21:32 1360  	     WHEN NO_DATA_FOUND THEN
15:21:32 1361  	       out_offer_chain_id := NULL;
15:21:32 1362  	 END;
15:21:32 1363  
15:21:32 1364  EXCEPTION
15:21:32 1365  WHEN BAD_INVOICE_ID THEN
15:21:32 1366  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1367  	   SPROC_NAME, 'No such invoice');
15:21:32 1368  WHEN OTHERS THEN
15:21:32 1369  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1370  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1371  END GET_OFFER_CH_ID_BY_INVOICE_ID;
15:21:32 1372  
15:21:32 1373  /******************************************************************************/
15:21:32 1374  
15:21:32 1375  PROCEDURE CLOSE_INVOICE_AS_NOT_COLLECTED (
15:21:32 1376  -- Closing invoice without refund
15:21:32 1377  	 in_invoice_id IN NUMBER,
15:21:32 1378  	 in_updated_by IN VARCHAR2
15:21:32 1379  ) AS
15:21:32 1380  SPROC_NAME CONSTANT VARCHAR2(30) := 'CLOSE_INVOICE_AS_NOT_COLLECTED';
15:21:32 1381  -- VARIABLES
15:21:32 1382  temp_invoice_id NUMBER;
15:21:32 1383  -- EXCEPTIONS
15:21:32 1384  BAD_INVOICE_ID EXCEPTION;
15:21:32 1385  BEGIN
15:21:32 1386  
15:21:32 1387  	 BEGIN
15:21:32 1388  	   SELECT
15:21:32 1389  	     INVOICE.ID into temp_invoice_id
15:21:32 1390  	   FROM
15:21:32 1391  	     INVOICE
15:21:32 1392  	   WHERE
15:21:32 1393  	     INVOICE.ID = in_invoice_id;
15:21:32 1394  	   EXCEPTION
15:21:32 1395  	     WHEN NO_DATA_FOUND THEN
15:21:32 1396  	       RAISE BAD_INVOICE_ID;
15:21:32 1397  	 END;
15:21:32 1398  
15:21:32 1399  	 -- Needs to close charges. No refund.
15:21:32 1400  	 FOR f_charge_to_close IN (
15:21:32 1401  	   SELECT CHARGE.ID FROM CHARGE WHERE CHARGE.INVOICE_ID = in_invoice_id
15:21:32 1402  	 )
15:21:32 1403  	 LOOP
15:21:32 1404  	   PROCS_CHARGE_V18.UPDATE_CHARGE_STATUS(
15:21:32 1405  	     in_charge_id	 => f_charge_to_close.ID,
15:21:32 1406  	     in_updated_by	 => in_updated_by,
15:21:32 1407  	     in_charge_status_id => GLOBAL_STATUSES_V18.CHARGE_CANCELED
15:21:32 1408  	   );
15:21:32 1409  	 END LOOP;
15:21:32 1410  
15:21:32 1411  	 --FOR f_license_to_cancel IN (
15:21:32 1412  	 --  SELECT LICENSE.ID FROM LICENSE WHERE LICENSE.INVOICE_ID = in_invoice_id AND LICENSE.LICENSE_STATUS_ID = GLOBAL_STATUSES_V18.LICENSE_ACTIVE
15:21:32 1413  	 --)
15:21:32 1414  	 --LOOP
15:21:32 1415  	 --  PROCS_LICENSE_CRU_V18.UPDATE_LICENSE(
15:21:32 1416  	 --    in_license_id	     => f_license_to_cancel.ID,
15:21:32 1417  	 --    in_license_status_id  => GLOBAL_STATUSES_V18.LICENSE_CLOSED,
15:21:32 1418  	 --    in_needs_entitlements => GLOBAL_CONSTANTS_V18.FALSE,
15:21:32 1419  	 --    in_updated_by	     => in_updated_by
15:21:32 1420  	 --  );
15:21:32 1421  	 --END LOOP;
15:21:32 1422  
15:21:32 1423  	 PROCS_INVOICE_V18.UPDATE_INVOICE_STATUS(
15:21:32 1424  	   in_invoice_id		  => in_invoice_id,
15:21:32 1425  	   in_updated_by		  => in_updated_by,
15:21:32 1426  	   in_invoice_status_id 	  => GLOBAL_STATUSES_V18.INVOICE_CLOSED
15:21:32 1427  	 );
15:21:32 1428  
15:21:32 1429  	 FOR f_transaction_to_close IN (
15:21:32 1430  	   SELECT DISTINCT CHARGE.TRANSACTION_ID AS "ID" FROM CHARGE WHERE CHARGE.INVOICE_ID = in_invoice_id
15:21:32 1431  	 )
15:21:32 1432  	 LOOP
15:21:32 1433  	   PROCS_TRANSACTION_V18.UPDATE_TRANSACTION_STATUS(
15:21:32 1434  	     in_transaction_id	      => f_transaction_to_close.ID,
15:21:32 1435  	     in_updated_by	      => in_updated_by,
15:21:32 1436  	     in_transaction_status_id => GLOBAL_STATUSES_V18.TRANSACTION_CLOSED
15:21:32 1437  	   );
15:21:32 1438  	 END LOOP;
15:21:32 1439  
15:21:32 1440  EXCEPTION
15:21:32 1441  WHEN BAD_INVOICE_ID THEN
15:21:32 1442  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1443  	   SPROC_NAME, 'No such invoice');
15:21:32 1444  WHEN OTHERS THEN
15:21:32 1445  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1446  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1447  END CLOSE_INVOICE_AS_NOT_COLLECTED;
15:21:32 1448  
15:21:32 1449  /******************************************************************************/
15:21:32 1450  
15:21:32 1451  PROCEDURE GET_SUBSCR_ID_BY_INVOICE_ID (
15:21:32 1452  	 in_invoice_id	     IN NUMBER,
15:21:32 1453  	 out_subscription_id OUT NUMBER
15:21:32 1454  ) AS
15:21:32 1455  SPROC_NAME CONSTANT VARCHAR2(27) := 'GET_SUBSCR_ID_BY_INVOICE_ID';
15:21:32 1456  -- VARIABLES
15:21:32 1457  temp_invoice_id NUMBER;
15:21:32 1458  -- EXCEPTIONS
15:21:32 1459  BAD_INVOICE_ID		 EXCEPTION;
15:21:32 1460  CAN_NOT_FIND_SUBSCRIPTION EXCEPTION;
15:21:32 1461  BEGIN
15:21:32 1462  
15:21:32 1463  	 BEGIN
15:21:32 1464  	   SELECT
15:21:32 1465  	     INVOICE.ID into temp_invoice_id
15:21:32 1466  	   FROM
15:21:32 1467  	     INVOICE
15:21:32 1468  	   WHERE
15:21:32 1469  	     INVOICE.ID = in_invoice_id;
15:21:32 1470  	   EXCEPTION
15:21:32 1471  	     WHEN NO_DATA_FOUND THEN
15:21:32 1472  	       RAISE BAD_INVOICE_ID;
15:21:32 1473  	 END;
15:21:32 1474  
15:21:32 1475  	 BEGIN
15:21:32 1476  	   SELECT DISTINCT
15:21:32 1477  	     LICENSE.SUBSCRIPTION_ID into out_subscription_id
15:21:32 1478  	   FROM
15:21:32 1479  	     LICENSE
15:21:32 1480  	   WHERE
15:21:32 1481  	     LICENSE.INVOICE_ID = in_invoice_id;
15:21:32 1482  	   EXCEPTION
15:21:32 1483  	     WHEN NO_DATA_FOUND THEN
15:21:32 1484  	       RAISE CAN_NOT_FIND_SUBSCRIPTION;
15:21:32 1485  	 END;
15:21:32 1486  
15:21:32 1487  EXCEPTION
15:21:32 1488  WHEN BAD_INVOICE_ID THEN
15:21:32 1489  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1490  	   SPROC_NAME, 'No such invoice');
15:21:32 1491  WHEN CAN_NOT_FIND_SUBSCRIPTION THEN
15:21:32 1492  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1493  	   SPROC_NAME, 'Could not find subscription for given invoice');
15:21:32 1494  WHEN OTHERS THEN
15:21:32 1495  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1496  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1497  END GET_SUBSCR_ID_BY_INVOICE_ID;
15:21:32 1498  
15:21:32 1499  /******************************************************************************/
15:21:32 1500  
15:21:32 1501  PROCEDURE IS_INVOICE_TAX_EXEMPT (
15:21:32 1502  /*
15:21:32 1503  Throws exceptions:
15:21:32 1504  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1505  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 1506  Return:
15:21:32 1507  	 GLOBAL_CONSTANTS_V18.TRUE if ACCOUNT.EXEMPT_ID is not null
15:21:32 1508  	 GLOBAL_CONSTANTS_V18.FALSE else
15:21:32 1509  */
15:21:32 1510  	 in_invoice_id	   IN NUMBER,
15:21:32 1511  	 out_is_tax_exempt OUT NUMBER
15:21:32 1512  ) AS
15:21:32 1513  SPROC_NAME CONSTANT VARCHAR2(21) := 'IS_INVOICE_TAX_EXEMPT';
15:21:32 1514  -- VARIABLES
15:21:32 1515  var_is_tax_exempt INVOICE.TAX_EXEMPT_ID%TYPE;
15:21:32 1516  -- EXCEPTIONS
15:21:32 1517  BAD_INVOICE_ID EXCEPTION;
15:21:32 1518  BEGIN
15:21:32 1519  
15:21:32 1520  	 BEGIN
15:21:32 1521  	   SELECT
15:21:32 1522  	     INVOICE.TAX_EXEMPT_ID into var_is_tax_exempt
15:21:32 1523  	   FROM
15:21:32 1524  	     INVOICE
15:21:32 1525  	   WHERE
15:21:32 1526  	     INVOICE.ID = in_invoice_id;
15:21:32 1527  	   EXCEPTION
15:21:32 1528  	     WHEN NO_DATA_FOUND THEN
15:21:32 1529  	       RAISE BAD_INVOICE_ID;
15:21:32 1530  	 END;
15:21:32 1531  
15:21:32 1532  	 IF var_is_tax_exempt IS NULL THEN
15:21:32 1533  	   out_is_tax_exempt := GLOBAL_CONSTANTS_V18.FALSE;
15:21:32 1534  	 ELSE
15:21:32 1535  	   out_is_tax_exempt := GLOBAL_CONSTANTS_V18.TRUE;
15:21:32 1536  	 END IF;
15:21:32 1537  
15:21:32 1538  EXCEPTION
15:21:32 1539  WHEN BAD_INVOICE_ID THEN
15:21:32 1540  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1541  	   SPROC_NAME, 'No such invoice');
15:21:32 1542  WHEN OTHERS THEN
15:21:32 1543  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1544  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1545  END IS_INVOICE_TAX_EXEMPT;
15:21:32 1546  
15:21:32 1547  /******************************************************************************/
15:21:32 1548  
15:21:32 1549  PROCEDURE GET_INVOICE_BY_TRNS_ORDER_ID (
15:21:32 1550  	 in_order_id  IN TRANSACTION.ORDER_ID%TYPE,
15:21:32 1551  	 out_result_set OUT SYS_REFCURSOR
15:21:32 1552  ) AS
15:21:32 1553  SPROC_NAME CONSTANT VARCHAR2(28) := 'GET_INVOICE_BY_TRNS_ORDER_ID';
15:21:32 1554  -- VARIABLE
15:21:32 1555  temp_order_id TRANSACTION.ORDER_ID%TYPE;
15:21:32 1556  -- EXCEPTIONS
15:21:32 1557  BAD_ORDER_ID EXCEPTION;
15:21:32 1558  CAN_NOT_FIND_INVOICE EXCEPTION;
15:21:32 1559  BEGIN
15:21:32 1560  
15:21:32 1561  	 OPEN out_result_set FOR
15:21:32 1562  	   SELECT DISTINCT
15:21:32 1563  	     CHARGE.INVOICE_ID
15:21:32 1564  	   FROM
15:21:32 1565  	     CHARGE
15:21:32 1566  	   INNER JOIN
15:21:32 1567  	     TRANSACTION ON TRANSACTION.ID = CHARGE.TRANSACTION_ID
15:21:32 1568  	   WHERE
15:21:32 1569  	     TRANSACTION.ORDER_ID = in_order_id;
15:21:32 1570  
15:21:32 1571  EXCEPTION
15:21:32 1572  WHEN BAD_ORDER_ID THEN
15:21:32 1573  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1574  	   SPROC_NAME, 'No such transaction');
15:21:32 1575  WHEN CAN_NOT_FIND_INVOICE THEN
15:21:32 1576  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1577  	   SPROC_NAME, 'Could not find invoice for given order id');
15:21:32 1578  WHEN OTHERS THEN
15:21:32 1579  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1580  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1581  END GET_INVOICE_BY_TRNS_ORDER_ID;
15:21:32 1582  
15:21:32 1583  /******************************************************************************/
15:21:32 1584  
15:21:32 1585  PROCEDURE GET_INVOICE_BY_ID (
15:21:32 1586  	 in_invoice_id	IN NUMBER,
15:21:32 1587  	 out_result_set OUT SYS_REFCURSOR
15:21:32 1588  ) AS
15:21:32 1589  SPROC_NAME CONSTANT VARCHAR2(17) := 'GET_INVOICE_BY_ID';
15:21:32 1590  -- VARIABLE
15:21:32 1591  temp_invoice_id NUMBER;
15:21:32 1592  -- EXCEPTIONS
15:21:32 1593  BAD_INVOCIE_ID EXCEPTION;
15:21:32 1594  BEGIN
15:21:32 1595  
15:21:32 1596  	 BEGIN
15:21:32 1597  	   SELECT
15:21:32 1598  	     INVOICE.ID into temp_invoice_id
15:21:32 1599  	   FROM
15:21:32 1600  	     INVOICE
15:21:32 1601  	   WHERE
15:21:32 1602  	     INVOICE.ID = in_invoice_id;
15:21:32 1603  	   EXCEPTION
15:21:32 1604  	     WHEN NO_DATA_FOUND THEN
15:21:32 1605  	       RAISE BAD_INVOCIE_ID;
15:21:32 1606  	 END;
15:21:32 1607  
15:21:32 1608  	 OPEN out_result_set FOR
15:21:32 1609  	 SELECT
15:21:32 1610  	   INVOICE.ID,
15:21:32 1611  	   INVOICE.INVOICE_STATUS_ID,
15:21:32 1612  	   INVOICE.TAX_EXEMPT_ID,
15:21:32 1613  	   INVOICE.UPDATE_DATE,
15:21:32 1614  	   INVOICE.UPDATED_BY,
15:21:32 1615  	   INVOICE.CREATE_DATE,
15:21:32 1616  	   INVOICE.CREATED_BY
15:21:32 1617  	 FROM
15:21:32 1618  	   INVOICE
15:21:32 1619  	 WHERE
15:21:32 1620  	   INVOICE.ID = in_invoice_id;
15:21:32 1621  
15:21:32 1622  EXCEPTION
15:21:32 1623  WHEN BAD_INVOCIE_ID THEN
15:21:32 1624  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1625  	   SPROC_NAME, 'No such invoice');
15:21:32 1626  WHEN OTHERS THEN
15:21:32 1627  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1628  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1629  END GET_INVOICE_BY_ID;
15:21:32 1630  
15:21:32 1631  /******************************************************************************/
15:21:32 1632  
15:21:32 1633  PROCEDURE GET_IS_TAX_CALCULATION_NEEDED (
15:21:32 1634  	 in_invoice_id		       IN NUMBER,
15:21:32 1635  	 out_is_tax_calculation_needed OUT NUMBER
15:21:32 1636  ) AS
15:21:32 1637  SPROC_NAME CONSTANT VARCHAR2(29) := 'GET_IS_TAX_CALCULATION_NEEDED';
15:21:32 1638  BEGIN
15:21:32 1639  
15:21:32 1640  	 SELECT
15:21:32 1641  	   I.IS_TAX_CALCULATION_NEEDED into out_is_tax_calculation_needed
15:21:32 1642  	 FROM
15:21:32 1643  	   INVOICE I
15:21:32 1644  	 WHERE
15:21:32 1645  	   I.ID = in_invoice_id;
15:21:32 1646  
15:21:32 1647  EXCEPTION
15:21:32 1648  WHEN NO_DATA_FOUND THEN
15:21:32 1649  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1650  	   SPROC_NAME, 'No such invoice');
15:21:32 1651  WHEN OTHERS THEN
15:21:32 1652  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1653  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1654  END GET_IS_TAX_CALCULATION_NEEDED;
15:21:32 1655  
15:21:32 1656  /******************************************************************************/
15:21:32 1657  
15:21:32 1658  PROCEDURE SET_IS_TAX_CALCULATION_NEEDED (
15:21:32 1659  	 in_invoice_id		      IN NUMBER,
15:21:32 1660  	 in_updated_by		      IN VARCHAR2,
15:21:32 1661  	 in_is_tax_calculation_needed IN NUMBER
15:21:32 1662  ) AS
15:21:32 1663  SPROC_NAME CONSTANT VARCHAR2(29) := 'SET_IS_TAX_CALCULATION_NEEDED';
15:21:32 1664  -- VARIABLES
15:21:32 1665  temp_invoice_id	      NUMBER;
15:21:32 1666  -- EXCEPTIONS
15:21:32 1667  BAD_INVOICE_ID	      EXCEPTION;
15:21:32 1668  CAN_NOT_UPDATE_INVOCIE EXCEPTION;
15:21:32 1669  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:32 1670  BEGIN
15:21:32 1671  
15:21:32 1672  	 BEGIN
15:21:32 1673  	   SELECT
15:21:32 1674  	     i.id into temp_invoice_id
15:21:32 1675  	   FROM
15:21:32 1676  	     invoice i
15:21:32 1677  	   WHERE
15:21:32 1678  	     i.id = in_invoice_id;
15:21:32 1679  	   EXCEPTION
15:21:32 1680  	     WHEN NO_DATA_FOUND THEN
15:21:32 1681  	       RAISE BAD_INVOICE_ID;
15:21:32 1682  	 END;
15:21:32 1683  
15:21:32 1684  	 BEGIN
15:21:32 1685  	   PROCS_INVOICE_CRU_V18.UPDATE_INVOICE(
15:21:32 1686  	     in_invoice_id => in_invoice_id,
15:21:32 1687  	     in_updated_by => in_updated_by,
15:21:32 1688  	     in_is_tax_calculation_needed => in_is_tax_calculation_needed
15:21:32 1689  	   );
15:21:32 1690  	   EXCEPTION
15:21:32 1691  	     WHEN OTHERS THEN
15:21:32 1692  	       EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1693  	       RAISE CAN_NOT_UPDATE_INVOCIE;
15:21:32 1694  	 END;
15:21:32 1695  
15:21:32 1696  EXCEPTION
15:21:32 1697  WHEN BAD_INVOICE_ID THEN
15:21:32 1698  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1699  	   SPROC_NAME, 'No such invoice');
15:21:32 1700  WHEN CAN_NOT_UPDATE_INVOCIE THEN
15:21:32 1701  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1702  	   SPROC_NAME, 'Could not update invoice', EXCEPTION_MESSAGE);
15:21:32 1703  WHEN OTHERS THEN
15:21:32 1704  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1705  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1706  END SET_IS_TAX_CALCULATION_NEEDED;
15:21:32 1707  
15:21:32 1708  /******************************************************************************/
15:21:32 1709  
15:21:32 1710  PROCEDURE REFUND_INVOICE (
15:21:32 1711  	 in_invoice_id	    IN NUMBER,
15:21:32 1712  	 in_refund_amount   IN NUMBER,
15:21:32 1713  	 in_note	    IN VARCHAR2,
15:21:32 1714  	 in_created_by	    IN VARCHAR2,
15:21:32 1715  	 out_charge_id	    OUT NUMBER
15:21:32 1716  ) AS
15:21:32 1717  SPROC_NAME CONSTANT VARCHAR2(14) := 'REFUND_INVOICE';
15:21:32 1718  -- VARIABLES
15:21:32 1719  var_invoice_status_id  NUMBER;
15:21:32 1720  var_subscription_id    NUMBER;
15:21:32 1721  var_account_id	      NUMBER;
15:21:32 1722  var_group_id	      NUMBER;
15:21:32 1723  var_account_status_id  NUMBER;
15:21:32 1724  var_new_transaction_id NUMBER;
15:21:32 1725  var_instrument_type_id NUMBER;
15:21:32 1726  var_instrument_id      NUMBER;
15:21:32 1727  var_new_charge_id      NUMBER;
15:21:32 1728  var_invoice_amount     NUMBER(10,2);
15:21:32 1729  var_refunds_before     NUMBER(10,2);
15:21:32 1730  var_charges_amount     NUMBER(10,2);
15:21:32 1731  -- EXCEPTIONS
15:21:32 1732  CAN_NOT_FIND_SUBSCR_OR_GC     EXCEPTION;
15:21:32 1733  ACCOUNT_IS_FROZEN	     EXCEPTION;
15:21:32 1734  BAD_INVOICE_ID		     EXCEPTION;
15:21:32 1735  CAN_NOT_CREATE_TRANSACTION    EXCEPTION;
15:21:32 1736  CAN_NOT_CREATE_CHARGE	     EXCEPTION;
15:21:32 1737  CAN_NOT_CALC_INVOICE_AMOUNT   EXCEPTION;
15:21:32 1738  REFUND_IS_GREATER_THAN_ANOUNT EXCEPTION;
15:21:32 1739  CAN_NOT_ANNOTATE_SUBSCRIPTION EXCEPTION;
15:21:32 1740  TOT_REF_IS_GREATER_THAN_ANOUNT EXCEPTION;
15:21:32 1741  INVOICE_IS_NOT_CLOSED	     EXCEPTION;
15:21:32 1742  TOT_REF_IS_GRATER_THAN_CHARGES EXCEPTION;
15:21:32 1743  EXCEPTION_MESSAGE	      VARCHAR2(1024);
15:21:32 1744  BEGIN
15:21:32 1745  
15:21:32 1746  	 BEGIN
15:21:32 1747  	   SELECT
15:21:32 1748  	     INVOICE.INVOICE_STATUS_ID into var_invoice_status_id
15:21:32 1749  	   FROM
15:21:32 1750  	     INVOICE
15:21:32 1751  	   WHERE
15:21:32 1752  	     INVOICE.ID = in_invoice_id;
15:21:32 1753  	   EXCEPTION
15:21:32 1754  	     WHEN NO_DATA_FOUND THEN
15:21:32 1755  	       RAISE BAD_INVOICE_ID;
15:21:32 1756  	 END;
15:21:32 1757  
15:21:32 1758  	 -- Get instrument and subscription id if exists
15:21:32 1759  	 BEGIN
15:21:32 1760  	   SELECT
15:21:32 1761  	     SUBSCRIPTION.INSTRUMENT_ID,
15:21:32 1762  	     SUBSCRIPTION.INSTRUMENT_TYPE_ID,
15:21:32 1763  	     SUBSCRIPTION.ACCOUNT_ID,
15:21:32 1764  	     SUBSCRIPTION.ID
15:21:32 1765  	     into
15:21:32 1766  	     var_instrument_id,
15:21:32 1767  	     var_instrument_type_id,
15:21:32 1768  	     var_account_id,
15:21:32 1769  	     var_subscription_id
15:21:32 1770  	   FROM
15:21:32 1771  	     SUBSCRIPTION
15:21:32 1772  	     INNER JOIN LICENSE ON SUBSCRIPTION.ID = LICENSE.SUBSCRIPTION_ID
15:21:32 1773  	   WHERE
15:21:32 1774  	     LICENSE.INVOICE_ID = in_invoice_id
15:21:32 1775  	     AND ROWNUM <= 1;
15:21:32 1776  	   EXCEPTION
15:21:32 1777  	     WHEN NO_DATA_FOUND THEN
15:21:32 1778  	       BEGIN
15:21:32 1779  
15:21:32 1780  		 var_subscription_id := NULL;
15:21:32 1781  
15:21:32 1782  		 SELECT
15:21:32 1783  		   CHARGE.INSTRUMENT_ID,
15:21:32 1784  		   CHARGE.INSTRUMENT_TYPE_ID,
15:21:32 1785  		   GIFT_CERTIFICATE.PURCHASER_GROUP_ID
15:21:32 1786  		   into
15:21:32 1787  		   var_instrument_id,
15:21:32 1788  		   var_instrument_type_id,
15:21:32 1789  		   var_group_id
15:21:32 1790  		 FROM
15:21:32 1791  		   INVOICE
15:21:32 1792  		   INNER JOIN CHARGE ON INVOICE.ID = CHARGE.INVOICE_ID
15:21:32 1793  		   INNER JOIN GIFT_CERTIFICATE ON GIFT_CERTIFICATE.PURCHASE_INVOICE_ID = INVOICE.ID
15:21:32 1794  		 WHERE
15:21:32 1795  		   INVOICE.ID = in_invoice_id
15:21:32 1796  		   AND ROWNUM <= 1;
15:21:32 1797  
15:21:32 1798  		 SELECT
15:21:32 1799  		   ACCOUNT.ID into var_account_id
15:21:32 1800  		 FROM
15:21:32 1801  		   ACCOUNT
15:21:32 1802  		 WHERE
15:21:32 1803  		   ACCOUNT.GROUP_ID = var_group_id;
15:21:32 1804  
15:21:32 1805  		 EXCEPTION
15:21:32 1806  		   WHEN NO_DATA_FOUND THEN
15:21:32 1807  		     RAISE CAN_NOT_FIND_SUBSCR_OR_GC;
15:21:32 1808  	       END;
15:21:32 1809  	 END;
15:21:32 1810  
15:21:32 1811  	 -- Check account status. It should not to be frozen
15:21:32 1812  	 SELECT
15:21:32 1813  	   ACCOUNT.ACCOUNT_STATUS_ID into var_account_status_id
15:21:32 1814  	 FROM
15:21:32 1815  	   ACCOUNT
15:21:32 1816  	 WHERE
15:21:32 1817  	   ACCOUNT.ID = var_account_id;
15:21:32 1818  
15:21:32 1819  	 IF var_account_status_id = GLOBAL_STATUSES_V18.ACCOUNT_FROZEN THEN
15:21:32 1820  	   RAISE ACCOUNT_IS_FROZEN;
15:21:32 1821  	 END IF;
15:21:32 1822  
15:21:32 1823  	 IF var_invoice_status_id != GLOBAL_STATUSES_V18.INVOICE_CLOSED THEN
15:21:32 1824  	   RAISE INVOICE_IS_NOT_CLOSED;
15:21:32 1825  	 END IF;
15:21:32 1826  
15:21:32 1827  	 BEGIN
15:21:32 1828  	   PROCS_INVOICE_V18.CALCULATE_INVOICE_AMOUNT (
15:21:32 1829  	     in_invoice_id => in_invoice_id,
15:21:32 1830  	     out_amount    => var_invoice_amount
15:21:32 1831  	   );
15:21:32 1832  	   EXCEPTION
15:21:32 1833  	     WHEN OTHERS THEN
15:21:32 1834  	       EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1835  	       RAISE CAN_NOT_CALC_INVOICE_AMOUNT;
15:21:32 1836  	 END;
15:21:32 1837  
15:21:32 1838  	 IF ( in_refund_amount > var_invoice_amount ) THEN
15:21:32 1839  	   RAISE REFUND_IS_GREATER_THAN_ANOUNT;
15:21:32 1840  	 END IF;
15:21:32 1841  
15:21:32 1842  	 SELECT /*+ STAR_TRANSFORMATION */
15:21:32 1843  	   SUM(CHARGE.CHARGE_AMOUNT) into var_refunds_before
15:21:32 1844  	 FROM
15:21:32 1845  	   CHARGE
15:21:32 1846  	 WHERE
15:21:32 1847  	   CHARGE.INVOICE_ID = in_invoice_id
15:21:32 1848  	   AND (
15:21:32 1849  	     CHARGE.CHARGE_STATUS_ID = GLOBAL_STATUSES_V18.CHARGE_OPENED
15:21:32 1850  	     OR (
15:21:32 1851  	       CHARGE.CHARGE_STATUS_ID = GLOBAL_STATUSES_V18.CHARGE_PROCESSED
15:21:32 1852  	       AND EXISTS (
15:21:32 1853  		 SELECT 1 FROM TRANSACTION_ATTEMPT ta where ta.transaction_id = CHARGE.TRANSACTION_ID and ta.transaction_attempt_status_id = GLOBAL_STATUSES_V18.TRANS_ATTEMPT_SUCCESS
15:21:32 1854  	       )
15:21:32 1855  	     )
15:21:32 1856  	   )
15:21:32 1857  	   AND CHARGE.CHARGE_AMOUNT < 0;
15:21:32 1858  
15:21:32 1859  	 -- Refunds are negative
15:21:32 1860  	 IF var_refunds_before IS NULL THEN var_refunds_before := 0; END IF;
15:21:32 1861  	 var_refunds_before := 0 - var_refunds_before;
15:21:32 1862  
15:21:32 1863  	 var_charges_amount := 0;
15:21:32 1864  
15:21:32 1865  	 FOR f_processed_charges IN (
15:21:32 1866  	   SELECT
15:21:32 1867  	     CHARGE.CHARGE_AMOUNT
15:21:32 1868  	   FROM
15:21:32 1869  	     CHARGE
15:21:32 1870  	   WHERE
15:21:32 1871  	     CHARGE.INVOICE_ID = in_invoice_id
15:21:32 1872  	     AND CHARGE.CHARGE_AMOUNT > 0
15:21:32 1873  	     AND CHARGE.CHARGE_STATUS_ID IN (SELECT GLOBAL_STATUSES_V18.CHARGE_PROCESSED FROM DUAL)
15:21:32 1874  	     AND EXISTS (SELECT 1 FROM TRANSACTION_ATTEMPT ta where ta.transaction_id = CHARGE.TRANSACTION_ID and ta.transaction_attempt_status_id = GLOBAL_STATUSES_V18.TRANS_ATTEMPT_SUCCESS)
15:21:32 1875  	 )
15:21:32 1876  	 LOOP
15:21:32 1877  	   var_charges_amount := var_charges_amount + f_processed_charges.CHARGE_AMOUNT;
15:21:32 1878  	 END LOOP;
15:21:32 1879  
15:21:32 1880  	 IF (in_refund_amount + var_refunds_before > var_invoice_amount) THEN
15:21:32 1881  	   RAISE TOT_REF_IS_GREATER_THAN_ANOUNT;
15:21:32 1882  	 END IF;
15:21:32 1883  
15:21:32 1884  	 IF (in_refund_amount + var_refunds_before > var_charges_amount) THEN
15:21:32 1885  	   RAISE TOT_REF_IS_GRATER_THAN_CHARGES;
15:21:32 1886  	 END IF;
15:21:32 1887  
15:21:32 1888  	 BEGIN
15:21:32 1889  	   PROCS_TRANSACTION_V18.CREATE_TRANSACTION(
15:21:32 1890  	     in_transaction_id	       => NULL,
15:21:32 1891  	     in_status_id	       => GLOBAL_STATUSES_V18.TRANSACTION_PREPARE,
15:21:32 1892  	     in_amount		       => -in_refund_amount,
15:21:32 1893  	     in_created_by	       => in_created_by,
15:21:32 1894  	     in_order_id	       => NULL,
15:21:32 1895  	     in_is_refund	       => GLOBAL_CONSTANTS_V18.TRUE,
15:21:32 1896  	     in_transaction_type_code  => 'REFUND',
15:21:32 1897  	     out_transaction_id        => var_new_transaction_id
15:21:32 1898  	   );
15:21:32 1899  	   EXCEPTION
15:21:32 1900  	     WHEN OTHERS THEN
15:21:32 1901  	       EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1902  	       RAISE CAN_NOT_CREATE_TRANSACTION;
15:21:32 1903  	 END;
15:21:32 1904  
15:21:32 1905  	 BEGIN
15:21:32 1906  	   PROCS_CHARGE_V18.CREATE_CHARGE(
15:21:32 1907  	     in_invoice_id	   => in_invoice_id,
15:21:32 1908  	     in_transaction_id	   => var_new_transaction_id,
15:21:32 1909  	     in_instrument_type_id => var_instrument_type_id,
15:21:32 1910  	     in_instrument_id	   => var_instrument_id,
15:21:32 1911  	     in_charge_amount	   => -in_refund_amount,
15:21:32 1912  	     in_created_by	   => in_created_by,
15:21:32 1913  	     in_charge_status_id   => GLOBAL_STATUSES_V18.CHARGE_OPENED,
15:21:32 1914  	     out_charge_id	   => var_new_charge_id
15:21:32 1915  	   );
15:21:32 1916  	   EXCEPTION
15:21:32 1917  	     WHEN OTHERS THEN
15:21:32 1918  	       EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1919  	       RAISE CAN_NOT_CREATE_CHARGE;
15:21:32 1920  	 END;
15:21:32 1921  
15:21:32 1922  	 out_charge_id := var_new_charge_id;
15:21:32 1923  
15:21:32 1924  	 IF in_note IS NOT NULL AND var_subscription_id IS NOT NULL THEN
15:21:32 1925  	   BEGIN
15:21:32 1926  	     PROCS_SUBSCRIPTION_V18.ANNOTATE_SUBSCRIPTION(
15:21:32 1927  	       in_subscription_id => var_subscription_id,
15:21:32 1928  	       in_agent_id	  => 0, -- AGENT_ID??
15:21:32 1929  	       in_note		  => in_note,
15:21:32 1930  	       in_created_by	  => in_created_by
15:21:32 1931  	     );
15:21:32 1932  	     EXCEPTION
15:21:32 1933  	       WHEN OTHERS THEN
15:21:32 1934  		 EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1935  		 RAISE CAN_NOT_ANNOTATE_SUBSCRIPTION;
15:21:32 1936  	   END;
15:21:32 1937  	 END IF;
15:21:32 1938  
15:21:32 1939  EXCEPTION
15:21:32 1940  WHEN CAN_NOT_FIND_SUBSCR_OR_GC THEN
15:21:32 1941  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1942  	   SPROC_NAME, 'Could not find subscription or GC for the inovice');
15:21:32 1943  WHEN INVOICE_IS_NOT_CLOSED THEN
15:21:32 1944  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 1945  	   SPROC_NAME, 'Invoice is not closed');
15:21:32 1946  WHEN ACCOUNT_IS_FROZEN THEN
15:21:32 1947  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 1948  	   SPROC_NAME, 'Could not refund subscription for frozen account');
15:21:32 1949  WHEN BAD_INVOICE_ID THEN
15:21:32 1950  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1951  	   SPROC_NAME, 'No such invoice');
15:21:32 1952  WHEN CAN_NOT_CALC_INVOICE_AMOUNT THEN
15:21:32 1953  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1954  	   SPROC_NAME, 'Could not calculate invoice amount', EXCEPTION_MESSAGE);
15:21:32 1955  WHEN REFUND_IS_GREATER_THAN_ANOUNT THEN
15:21:32 1956  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 1957  	   SPROC_NAME, 'Refund is greater than amount');
15:21:32 1958  WHEN TOT_REF_IS_GREATER_THAN_ANOUNT THEN
15:21:32 1959  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 1960  	   SPROC_NAME, 'There were refunds before and sum of all refunds and new refund more than invoice amount');
15:21:32 1961  WHEN TOT_REF_IS_GRATER_THAN_CHARGES THEN
15:21:32 1962  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 1963  	   SPROC_NAME, 'Total refund amount is greater than sum of processed charges');
15:21:32 1964  WHEN CAN_NOT_CREATE_TRANSACTION THEN
15:21:32 1965  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1966  	   SPROC_NAME, 'Could not create transaction', EXCEPTION_MESSAGE);
15:21:32 1967  WHEN CAN_NOT_CREATE_CHARGE THEN
15:21:32 1968  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1969  	   SPROC_NAME, 'Could not create charge', EXCEPTION_MESSAGE);
15:21:32 1970  WHEN CAN_NOT_ANNOTATE_SUBSCRIPTION THEN
15:21:32 1971  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1972  	   SPROC_NAME, 'Could not annotate subscription', EXCEPTION_MESSAGE);
15:21:32 1973  WHEN OTHERS THEN
15:21:32 1974  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1975  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1976  END REFUND_INVOICE;
15:21:32 1977  
15:21:32 1978  /******************************************************************************/
15:21:32 1979  
15:21:32 1980  PROCEDURE GET_PAYMENT_INFO_BY_INVOICE_ID (
15:21:32 1981  	 in_invoice_id		     IN NUMBER,
15:21:32 1982  	 out_order_id		     OUT VARCHAR2,
15:21:32 1983  	 out_external_transaction_id OUT VARCHAR2
15:21:32 1984  ) AS
15:21:32 1985  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_PEYMENT_INFO_BY_INVOICE_ID';
15:21:32 1986  -- VARIABLES
15:21:32 1987  temp_invoice_id number;
15:21:32 1988  cnt_matched_instr number := 0;
15:21:32 1989  -- EXCEPTIONS
15:21:32 1990  BAD_INVOICE_ID EXCEPTION;
15:21:32 1991  BEGIN
15:21:32 1992  
15:21:32 1993  	 BEGIN
15:21:32 1994  	   SELECT
15:21:32 1995  	     i.id into temp_invoice_id
15:21:32 1996  	   from
15:21:32 1997  	     invoice i
15:21:32 1998  	   where
15:21:32 1999  	     i.id = in_invoice_id;
15:21:32 2000  	   EXCEPTION
15:21:32 2001  	     WHEN NO_DATA_FOUND THEN
15:21:32 2002  	       RAISE BAD_INVOICE_ID;
15:21:32 2003  	 END;
15:21:32 2004  
15:21:32 2005  	 select
15:21:32 2006  	   count(1) into cnt_matched_instr
15:21:32 2007  	 from
15:21:32 2008  	   charge ch
15:21:32 2009  	 inner join
15:21:32 2010  	   subscription s
15:21:32 2011  	 on
15:21:32 2012  	   s.instrument_id = ch.instrument_id
15:21:32 2013  	 where
15:21:32 2014  	   ch.invoice_id = in_invoice_id;
15:21:32 2015  
15:21:32 2016  	 if cnt_matched_instr = 0 then
15:21:32 2017  	   out_external_transaction_id := null;
15:21:32 2018  	   out_order_id := null;
15:21:32 2019  	   return;
15:21:32 2020  	 end if;
15:21:32 2021  
15:21:32 2022  	 SELECT
15:21:32 2023  	   t.order_id,
15:21:32 2024  	   ta.external_transaction_id
15:21:32 2025  	   into
15:21:32 2026  	   out_order_id,
15:21:32 2027  	   out_external_transaction_id
15:21:32 2028  	 from
15:21:32 2029  	   charge ch
15:21:32 2030  	   inner join transaction t on ch.transaction_id = t.id
15:21:32 2031  	   inner join transaction_attempt ta on ta.transaction_id = t.id
15:21:32 2032  	 where
15:21:32 2033  	   ch.invoice_id = in_invoice_id
15:21:32 2034  	   and ta.transaction_attempt_status_id = GLOBAL_STATUSES_V18.TRANS_ATTEMPT_SUCCESS
15:21:32 2035  	   and ch.charge_amount > 0; -- We are not creating charges for the 0-amount invoices
15:21:32 2036  
15:21:32 2037  EXCEPTION
15:21:32 2038  WHEN BAD_INVOICE_ID THEN
15:21:32 2039  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2040  	   SPROC_NAME, 'No such invoice');
15:21:32 2041  WHEN NO_DATA_FOUND THEN
15:21:32 2042  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2043  	   SPROC_NAME, 'No payment data found');
15:21:32 2044  WHEN OTHERS THEN
15:21:32 2045  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2046  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2047  END GET_PAYMENT_INFO_BY_INVOICE_ID;
15:21:32 2048  
15:21:32 2049  PROCEDURE IS_REVOKE_ENTITLEMENTS(
15:21:32 2050  	 in_invoice_id IN NUMBER,
15:21:32 2051  	 out_is_revoke OUT NUMBER
15:21:32 2052  ) AS
15:21:32 2053  BEGIN
15:21:32 2054  	 SELECT DECODE(COUNT(1), 0, GLOBAL_CONSTANTS_V18.FALSE, GLOBAL_CONSTANTS_V18.TRUE)
15:21:32 2055  	   into out_is_revoke
15:21:32 2056  	 FROM
15:21:32 2057  	   offer_chain oc,
15:21:32 2058  	   subscription s,
15:21:32 2059  	   license l,
15:21:32 2060  	   invoice i
15:21:32 2061  	 where
15:21:32 2062  	   oc.id = s.offer_chain_id and
15:21:32 2063  	   s.id = l.subscription_id and
15:21:32 2064  	   l.invoice_id = i.id and
15:21:32 2065  	   oc.revoke_entitlements = GLOBAL_CONSTANTS_V18.TRUE and
15:21:32 2066  	   i.id = in_invoice_id and
15:21:32 2067  	   rownum < 2
15:21:32 2068  	 ;
15:21:32 2069  END IS_REVOKE_ENTITLEMENTS;
15:21:32 2070  
15:21:32 2071  END PROCS_INVOICE_V18;
15:21:32 2072  .
15:21:32 SQL> /

Package body created.

Elapsed: 00:00:00.14
15:21:32 SQL> 
15:21:32 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_FIN_INSTRUMENTS_V18" AS
15:21:32   2  
15:21:32   3  PROCEDURE UPDATE_GC_STATUS_BY_INVOICE(
15:21:32   4  	  in_invoice_id IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
15:21:32   5  	  in_status_id	IN GIFT_CERTIFICATE_STATUS.ID%TYPE,
15:21:32   6  	  in_updater	IN GIFT_CERTIFICATE.UPDATED_BY%TYPE)
15:21:32   7  AS
15:21:32   8  SPROC_NAME CONSTANT VARCHAR2(32) := 'UPDATE_GC_STATUS_BY_INVOICE';
15:21:32   9  BEGIN
15:21:32  10  	FOR rec IN (SELECT id FROM Gift_Certificate WHERE Purchase_Invoice_Id = in_invoice_id) LOOP
15:21:32  11  	  PROCS_FIN_INSTRUMENTS_CRU_V18.UPDATE_GIFT_CERTIFICATE (
15:21:32  12  	    in_gift_certificate_id	  => rec.Id,
15:21:32  13  	    in_gift_certificate_status_id => in_status_id,
15:21:32  14  	    in_updated_by		  => in_updater
15:21:32  15  	  );
15:21:32  16  	END LOOP;
15:21:32  17  END UPDATE_GC_STATUS_BY_INVOICE;
15:21:32  18  
15:21:32  19  PROCEDURE IS_INVOICE_FOR_REDEEMED_GC (
15:21:32  20  	in_invoice_id		     IN NUMBER,
15:21:32  21  	out_is_invoice_for_redeem_gc OUT NUMBER
15:21:32  22  ) AS
15:21:32  23  SPROC_NAME CONSTANT VARCHAR2(32) := 'IS_INVOICE_FOR_REDEEMED_GC';
15:21:32  24  var_is_for_gc NUMBER;
15:21:32  25  BEGIN
15:21:32  26  	SELECT
15:21:32  27  	  count(1) into var_is_for_gc
15:21:32  28  	FROM GIFT_CERTIFICATE GC
15:21:32  29  	WHERE GC.PURCHASE_INVOICE_ID = in_invoice_id AND
15:21:32  30  	      GC.GIFT_CERTIFICATE_STATUS_ID = 2;
15:21:32  31  
15:21:32  32  	IF var_is_for_gc > 0 THEN
15:21:32  33  	  out_is_invoice_for_redeem_gc := 1;
15:21:32  34  	ELSE
15:21:32  35  	  out_is_invoice_for_redeem_gc := 0;
15:21:32  36  	END IF;
15:21:32  37  END IS_INVOICE_FOR_REDEEMED_GC;
15:21:32  38  
15:21:32  39  PROCEDURE GET_UNREDEEMED_GCS (
15:21:32  40  	out_result_set		OUT SYS_REFCURSOR,
15:21:32  41  	in_hours_number 	IN NUMBER DEFAULT 14*24,
15:21:32  42  	in_num_rows		IN NUMBER DEFAULT 10000,
15:21:32  43  	in_process_name IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE
15:21:32  44  ) AS
15:21:32  45  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_UNREDEEMED_GCS';
15:21:32  46  BEGIN
15:21:32  47  	OPEN out_result_set FOR
15:21:32  48  SELECT * FROM
15:21:32  49  (
15:21:32  50  	SELECT
15:21:32  51  	  gc.EXPIRATION_DATE,
15:21:32  52  	  ch.name,
15:21:32  53  	  ch.id offer_chain_id,
15:21:32  54  	  gc.sender_email,
15:21:32  55  	  gc.sender_name,
15:21:32  56  	  gc.recipient_email,
15:21:32  57  	  gc.recipient_name,
15:21:32  58  	  gc.purchase_date,
15:21:32  59  	  gc.redemption_date,
15:21:32  60  	  gc.purchaser_group_id,
15:21:32  61  	  gc.redeemer_group_id,
15:21:32  62  	  gc.code,
15:21:32  63  	  gc.gift_message,
15:21:32  64  	  gc.recipient_notify_date,
15:21:32  65  	  gc.id
15:21:32  66  	FROM
15:21:32  67  	  GIFT_CERTIFICATE gc,
15:21:32  68  	  OFFER_CHAIN ch
15:21:32  69  	WHERE
15:21:32  70  	  ch.id = gc.offer_chain_id
15:21:32  71  	  AND gc.RECIPIENT_NOTIFY_DATE is not null
15:21:32  72  	  AND gc.RECIPIENT_NOTIFY_DATE >= (sysdate - in_hours_number/24)
15:21:32  73  	  AND gc.RECIPIENT_NOTIFY_DATE < (sysdate - (in_hours_number-72)/24)
15:21:32  74  	  AND gc.redeemer_group_id is null
15:21:32  75  	  AND NOT EXISTS(
15:21:32  76  	    SELECT NULL
15:21:32  77  	    FROM PROCESS_RETRY_THROTTLE
15:21:32  78  	    WHERE PROCESS_NAME = in_process_name
15:21:32  79  	      AND GENERIC_ID = gc.id
15:21:32  80  	  ) AND EXISTS(
15:21:32  81  	    SELECT NULL
15:21:32  82  	    FROM
15:21:32  83  	      charge c,
15:21:32  84  	      transaction_attempt ta,
15:21:32  85  	      transaction t
15:21:32  86  	    WHERE
15:21:32  87  	      c.invoice_id = gc.purchase_invoice_id and
15:21:32  88  	      c.transaction_id = t.id and
15:21:32  89  	      t.id = ta.transaction_id and
15:21:32  90  	      ta.transaction_attempt_status_id = GLOBAL_STATUSES_V18.TRANS_ATTEMPT_SUCCESS
15:21:32  91  	  ) AND NOT EXISTS (
15:21:32  92  	    SELECT NULL
15:21:32  93  	    FROM
15:21:32  94  	      charge c,
15:21:32  95  	      transaction t
15:21:32  96  	    WHERE
15:21:32  97  	      c.invoice_id = gc.purchase_invoice_id and
15:21:32  98  	      c.transaction_id = t.id and
15:21:32  99  	      t.is_refund = GLOBAL_CONSTANTS_V18.TRUE
15:21:32 100  	  )
15:21:32 101  	  AND ROWNUM <= in_num_rows*10
15:21:32 102  	  ORDER BY dbms_random.value
15:21:32 103  ) WHERE
15:21:32 104  	  ROWNUM <= in_num_rows;
15:21:32 105  EXCEPTION
15:21:32 106  WHEN OTHERS THEN
15:21:32 107  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 108  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 109  END GET_UNREDEEMED_GCS;
15:21:32 110  
15:21:32 111  PROCEDURE ADD_CREDIT_CARD (
15:21:32 112  /*
15:21:32 113  Throws exceptions:
15:21:32 114  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 115  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 116  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:32 117  */
15:21:32 118  	in_group_id		  IN NUMBER,
15:21:32 119  	in_updated_by		  IN VARCHAR2,
15:21:32 120  	in_instrument_name	  IN VARCHAR2,
15:21:32 121  	in_card_holder_name	  IN VARCHAR2,
15:21:32 122  	in_street_address	  IN VARCHAR2,
15:21:32 123  	in_street_address2	  IN VARCHAR2,
15:21:32 124  	in_state		  IN VARCHAR2,
15:21:32 125  	in_city 		  IN VARCHAR2,
15:21:32 126  	in_postal_code		  IN VARCHAR2,
15:21:32 127  	in_country		  IN CHAR,
15:21:32 128  	in_last_four_cc 	  IN VARCHAR2,
15:21:32 129  	in_expiration_date	  IN DATE,
15:21:32 130  	in_credit_card_type_id	  IN NUMBER,
15:21:32 131  	in_token		  IN VARCHAR2,
15:21:32 132  	in_chase_profile_id	  IN VARCHAR2,
15:21:32 133  	in_credit_card_status_id  IN NUMBER,
15:21:32 134  	in_private_first_name	  IN VARCHAR2,
15:21:32 135  	in_private_last_name	  IN VARCHAR2,
15:21:32 136  	out_credit_card_id	  OUT NUMBER
15:21:32 137  ) AS
15:21:32 138  SPROC_NAME	     CONSTANT VARCHAR2(15) := 'ADD_CREDIT_CARD';
15:21:32 139  -- VARIABLES
15:21:32 140  var_account_id	      NUMBER;
15:21:32 141  var_account_status      NUMBER;
15:21:32 142  var_credit_card_id      NUMBER;
15:21:32 143  temp_old_credit_card_id NUMBER;
15:21:32 144  -- EXCEPTIONS
15:21:32 145  BAD_ACCOUNT_STATUS	 EXCEPTION;
15:21:32 146  CAN_NOT_SET_DEF_FINANCIAL  EXCEPTION;
15:21:32 147  BAD_IS_DEFAULT_VALUE	 EXCEPTION;
15:21:32 148  BAD_OLD_CREDIT_CARD	 EXCEPTION;
15:21:32 149  EXCEPTION_MESSAGE 	 VARCHAR2(1024);
15:21:32 150  ----- DELETE NEXT LINES WHEN UI WILL SUPPORT MANY CC PER ACCOUNT
15:21:32 151  var_charges_set		SYS_REFCURSOR;
15:21:32 152  var_charge_id		NUMBER;
15:21:32 153  var_charge_invoice_id	NUMBER;
15:21:32 154  var_charge_transaction_id NUMBER;
15:21:32 155  var_charge_amount 	NUMBER(10,2);
15:21:32 156  temp_out_charge_id	NUMBER;
15:21:32 157  temp_out_transaction_id	NUMBER;
15:21:32 158  var_order_id			VARCHAR2(1024);
15:21:32 159  BEGIN
15:21:32 160  
15:21:32 161  	-- Get account id
15:21:32 162  	-- Get account status
15:21:32 163  	SELECT
15:21:32 164  	  ACCOUNT.ID,
15:21:32 165  	  ACCOUNT.ACCOUNT_STATUS_ID
15:21:32 166  	  into
15:21:32 167  	  var_account_id,
15:21:32 168  	  var_account_status
15:21:32 169  	FROM
15:21:32 170  	  ACCOUNT
15:21:32 171  	WHERE
15:21:32 172  	  ACCOUNT.GROUP_ID = in_group_id;
15:21:32 173  
15:21:32 174  	SELECT
15:21:32 175  	  CC_ID_SEQ.nextVal into var_credit_card_id
15:21:32 176  	FROM DUAL;
15:21:32 177  
15:21:32 178  	-- Insert new row in CREDIT_CARD table
15:21:32 179  	PROCS_FIN_INSTRUMENTS_CRU_V18.CREATE_CREDIT_CARD(
15:21:32 180  	  out_credit_card_id	      => var_credit_card_id,
15:21:32 181  	  in_account_id 	      => var_account_id,
15:21:32 182  	  in_instrument_name	      => in_instrument_name,
15:21:32 183  	  in_private_card_holder_name => in_card_holder_name,
15:21:32 184  	  in_private_street_address   => in_street_address,
15:21:32 185  	  in_private_street_address2  => in_street_address2,
15:21:32 186  	  in_state		      => in_state,
15:21:32 187  	  in_city		      => in_city,
15:21:32 188  	  in_postal_code	      => in_postal_code,
15:21:32 189  	  in_country		      => in_country,
15:21:32 190  	  in_last_four_cc	      => in_last_four_cc,
15:21:32 191  	  in_expiration_date	      => in_expiration_date,
15:21:32 192  	  in_credit_card_type_id      => in_credit_card_type_id,
15:21:32 193  	  in_secret_token	      => in_token,
15:21:32 194  	  in_chase_profile_id	      => in_chase_profile_id,
15:21:32 195  	  in_created_by 	      => in_updated_by,
15:21:32 196  	  in_credit_card_status_id    => in_credit_card_status_id,
15:21:32 197  	  in_private_first_name       => in_private_first_name,
15:21:32 198  	  in_private_last_name	      => in_private_last_name
15:21:32 199  	);
15:21:32 200  
15:21:32 201  	out_credit_card_id := var_credit_card_id;
15:21:32 202  
15:21:32 203  EXCEPTION
15:21:32 204  WHEN NO_DATA_FOUND THEN
15:21:32 205  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 206  	  SPROC_NAME, 'No such account');
15:21:32 207  WHEN BAD_OLD_CREDIT_CARD THEN
15:21:32 208  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 209  	  SPROC_NAME, 'Bad old credit card id');
15:21:32 210  WHEN BAD_IS_DEFAULT_VALUE THEN
15:21:32 211  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 212  	  SPROC_NAME, 'Bad is_default value');
15:21:32 213  WHEN CAN_NOT_SET_DEF_FINANCIAL THEN
15:21:32 214  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 215  	  SPROC_NAME, 'Can not set default finansial instrument', EXCEPTION_MESSAGE);
15:21:32 216  WHEN BAD_ACCOUNT_STATUS THEN
15:21:32 217  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 218  	  SPROC_NAME, 'Account is not active');
15:21:32 219  WHEN OTHERS THEN
15:21:32 220  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 221  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 222  END ADD_CREDIT_CARD;
15:21:32 223  
15:21:32 224  /******************************************************************************/
15:21:32 225  
15:21:32 226  PROCEDURE ADD_PAYPAL (
15:21:32 227  /*
15:21:32 228  Throws exceptions:
15:21:32 229  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 230  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 231  */
15:21:32 232  	in_group_id			IN NUMBER,
15:21:32 233  	in_instrument_name		IN VARCHAR2,
15:21:32 234  	in_private_email_address	IN VARCHAR2,
15:21:32 235  	in_created_by			IN VARCHAR2,
15:21:32 236  	in_paypal_status_id		IN NUMBER,
15:21:32 237  	in_paypal_prvt_street_address	IN VARCHAR2,
15:21:32 238  	in_paypal_prvt_street_address2	IN VARCHAR2,
15:21:32 239  	in_state			IN VARCHAR2,
15:21:32 240  	in_city 			IN VARCHAR2,
15:21:32 241  	in_postal_code			IN VARCHAR2,
15:21:32 242  	in_country			IN CHAR,
15:21:32 243  	in_expiration_date		IN DATE,
15:21:32 244  	in_secret_token 		IN VARCHAR2,
15:21:32 245  	out_paypal_id			OUT NUMBER
15:21:32 246  ) AS
15:21:32 247  SPROC_NAME CONSTANT VARCHAR2(10) := 'ADD_PAYPAL';
15:21:32 248  var_paypal_id NUMBER;
15:21:32 249  var_account_id  NUMBER;
15:21:32 250  -- EXCEPTIONS
15:21:32 251  BAD_GROUP_ID	    EXCEPTION;
15:21:32 252  CAN_NOT_CREATE_PAYPAL EXCEPTION;
15:21:32 253  BAD_PAYPAL_STATUS     EXCEPTION;
15:21:32 254  EXCEPTION_MESSAGE VARCHAR2(1024);
15:21:32 255  BEGIN
15:21:32 256  
15:21:32 257  	IF in_paypal_status_id != GLOBAL_STATUSES_V18.PAYPAL_ACTIVE
15:21:32 258  	  AND in_paypal_status_id != GLOBAL_STATUSES_V18.PAYPAL_INACTIVE
15:21:32 259  	  AND in_paypal_status_id != GLOBAL_STATUSES_V18.PAYPAL_FROZEN THEN
15:21:32 260  	  RAISE BAD_PAYPAL_STATUS;
15:21:32 261  	END IF;
15:21:32 262  
15:21:32 263  	BEGIN
15:21:32 264  	  SELECT
15:21:32 265  	    a.id into var_account_id
15:21:32 266  	  from
15:21:32 267  	    account a
15:21:32 268  	  where
15:21:32 269  	    a.group_id = in_group_id;
15:21:32 270  	  EXCEPTION
15:21:32 271  	    WHEN NO_DATA_FOUND THEN
15:21:32 272  	      RAISE BAD_GROUP_ID;
15:21:32 273  	END;
15:21:32 274  
15:21:32 275  	BEGIN
15:21:32 276  	  PROCS_FIN_INSTRUMENTS_CRU_V18.CREATE_PAYPAL(
15:21:32 277  	    out_paypal_id		   => var_paypal_id,
15:21:32 278  	    in_paypal_id		   => NULL,
15:21:32 279  	    in_account_id		   => var_account_id,
15:21:32 280  	    in_instrument_name		   => in_instrument_name,
15:21:32 281  	    in_private_email_address	   => in_private_email_address,
15:21:32 282  	    in_created_by		   => in_created_by,
15:21:32 283  	    in_paypal_status_id 	   => in_paypal_status_id,
15:21:32 284  	    in_paypal_prvt_street_address  => in_paypal_prvt_street_address,
15:21:32 285  	    in_paypal_prvt_street_address2 => in_paypal_prvt_street_address2,
15:21:32 286  	    in_state			   => in_state,
15:21:32 287  	    in_city			   => in_city,
15:21:32 288  	    in_postal_code		   => in_postal_code,
15:21:32 289  	    in_country			   => in_country,
15:21:32 290  	    in_expiration_date		   => in_expiration_date,
15:21:32 291  	    in_secret_token		   => in_secret_token
15:21:32 292  	  );
15:21:32 293  	  EXCEPTION
15:21:32 294  	    WHEN OTHERS THEN
15:21:32 295  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:32 296  	      RAISE CAN_NOT_CREATE_PAYPAL;
15:21:32 297  	END;
15:21:32 298  
15:21:32 299  	out_paypal_id := var_paypal_id;
15:21:32 300  
15:21:32 301  EXCEPTION
15:21:32 302  WHEN BAD_GROUP_ID THEN
15:21:32 303  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 304  	  SPROC_NAME, 'No such group id');
15:21:32 305  WHEN BAD_PAYPAL_STATUS THEN
15:21:32 306  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 307  	  SPROC_NAME, 'Bad paypal status');
15:21:32 308  WHEN CAN_NOT_CREATE_PAYPAL THEN
15:21:32 309  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 310  	  SPROC_NAME, 'Could not create paypal', EXCEPTION_MESSAGE);
15:21:32 311  WHEN OTHERS THEN
15:21:32 312  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 313  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 314  END ADD_PAYPAL;
15:21:32 315  
15:21:32 316  /******************************************************************************/
15:21:32 317  
15:21:32 318  PROCEDURE DISABLE_CREDIT_CARD (
15:21:32 319  /*
15:21:32 320  Throws exceptions:
15:21:32 321  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 322  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 323  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:32 324  */
15:21:32 325  	in_credit_card_id IN NUMBER,
15:21:32 326  	in_updated_by	  IN VARCHAR2
15:21:32 327  ) AS
15:21:32 328  SPROC_NAME		   CONSTANT VARCHAR2(19) := 'DISABLE_CREDIT_CARD';
15:21:32 329  -- VARIBLES
15:21:32 330  var_account_id		     NUMBER;
15:21:32 331  var_group_id		     NUMBER;
15:21:32 332  var_credit_card_status	     NUMBER;
15:21:32 333  var_pending_transactions_num   NUMBER;
15:21:32 334  var_pending_invoices_num	     NUMBER;
15:21:32 335  current_def_instrument_type_id NUMBER;
15:21:32 336  current_def_instrument_id      NUMBER;
15:21:32 337  -- EXCEPTIONS
15:21:32 338  BAD_CC_STATUS		   EXCEPTION;
15:21:32 339  PENDING_TRANSACTIONS_FOUNDED EXCEPTION;
15:21:32 340  CAN_NOT_GET_DEF_FINANCIAL    EXCEPTION;
15:21:32 341  CAN_NOT_DEL_DEF_FINANCIAL    EXCEPTION;
15:21:32 342  CAN_NOT_DISABLE_CREDIT_CARD  EXCEPTION;
15:21:32 343  EXCEPTION_MESSAGE 	   VARCHAR2(1024);
15:21:32 344  BEGIN
15:21:32 345  
15:21:32 346  	-- Get credit card status
15:21:32 347  	-- Get account id
15:21:32 348  	SELECT
15:21:32 349  	  CREDIT_CARD.CREDIT_CARD_STATUS_ID,
15:21:32 350  	  CREDIT_CARD.ACCOUNT_ID
15:21:32 351  	  into
15:21:32 352  	  var_credit_card_status,
15:21:32 353  	  var_account_id
15:21:32 354  	FROM
15:21:32 355  	  CREDIT_CARD
15:21:32 356  	WHERE
15:21:32 357  	  CREDIT_CARD.ID = in_credit_card_id;
15:21:32 358  
15:21:32 359  	-- Check that we can disable this credit card (STUB)
15:21:32 360  	IF F_CAN_DISABLE_CREDIT_CARD(in_credit_card_id) = GLOBAL_CONSTANTS_V18.FALSE THEN
15:21:32 361  	  RAISE CAN_NOT_DISABLE_CREDIT_CARD;
15:21:32 362  	END IF;
15:21:32 363  
15:21:32 364  	-- Get account id
15:21:32 365  	SELECT
15:21:32 366  	  ACCOUNT.GROUP_ID into var_group_id
15:21:32 367  	FROM
15:21:32 368  	  ACCOUNT
15:21:32 369  	WHERE
15:21:32 370  	  ACCOUNT.ID = var_account_id;
15:21:32 371  
15:21:32 372  	-- Card should to be active
15:21:32 373  	IF var_credit_card_status != GLOBAL_STATUSES_V18.CREDIT_CARD_ACTIVE THEN
15:21:32 374  	  RAISE BAD_CC_STATUS;
15:21:32 375  	END IF;
15:21:32 376  
15:21:32 377  	-- Looking for pending transactions associated with given credit card
15:21:32 378  	SELECT
15:21:32 379  	  COUNT(*) into var_pending_invoices_num
15:21:32 380  	FROM
15:21:32 381  	  CHARGE
15:21:32 382  	  INNER JOIN TRANSACTION ON CHARGE.TRANSACTION_ID = TRANSACTION.ID
15:21:32 383  	WHERE
15:21:32 384  	  CHARGE.INSTRUMENT_TYPE_ID = GLOBAL_ENUMS_V18.INSTRUMENT_CREDIT_CARD
15:21:32 385  	  AND CHARGE.INSTRUMENT_ID = in_credit_card_id
15:21:32 386  	  AND TRANSACTION.TRANSACTION_STATUS_ID = GLOBAL_STATUSES_V18.TRANSACTION_PENDING;
15:21:32 387  
15:21:32 388  	IF var_pending_invoices_num > 0 THEN
15:21:32 389  	  RAISE PENDING_TRANSACTIONS_FOUNDED;
15:21:32 390  	END IF;
15:21:32 391  
15:21:32 392  	-- Getting current default financial instrument
15:21:32 393  	BEGIN
15:21:32 394  	  GET_DEF_FINANCIAL_INSTRUMENT(
15:21:32 395  	    in_group_id 	   => var_group_id,
15:21:32 396  	    out_instrument_type_id => current_def_instrument_type_id,
15:21:32 397  	    out_instrument_id	   => current_def_instrument_id
15:21:32 398  	  );
15:21:32 399  	  EXCEPTION
15:21:32 400  	    WHEN OTHERS THEN
15:21:32 401  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:32 402  	      RAISE CAN_NOT_GET_DEF_FINANCIAL;
15:21:32 403  	END;
15:21:32 404  
15:21:32 405  	-- Checking that credit card is not default
15:21:32 406  	IF current_def_instrument_type_id = GLOBAL_ENUMS_V18.INSTRUMENT_CREDIT_CARD
15:21:32 407  	  AND current_def_instrument_id = in_credit_card_id THEN
15:21:32 408  	  BEGIN
15:21:32 409  	    DEL_DEF_FINANCIAL_INSTRUMENT(
15:21:32 410  	      in_group_id => var_group_id
15:21:32 411  	    );
15:21:32 412  	  EXCEPTION
15:21:32 413  	    WHEN OTHERS THEN
15:21:32 414  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:32 415  	      RAISE CAN_NOT_DEL_DEF_FINANCIAL;
15:21:32 416  	  END;
15:21:32 417  	END IF;
15:21:32 418  
15:21:32 419  	-- Update credit card status
15:21:32 420  	PROCS_FIN_INSTRUMENTS_V18.UPDATE_CREDIT_CARD_STATUS(
15:21:32 421  	  in_credit_card_id	   => in_credit_card_id,
15:21:32 422  	  in_updated_by 	   => in_updated_by,
15:21:32 423  	  in_credit_card_status_id => GLOBAL_STATUSES_V18.CREDIT_CARD_DISABLED
15:21:32 424  	);
15:21:32 425  
15:21:32 426  EXCEPTION
15:21:32 427  WHEN NO_DATA_FOUND THEN
15:21:32 428  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 429  	  SPROC_NAME, 'No such credit card');
15:21:32 430  WHEN CAN_NOT_GET_DEF_FINANCIAL THEN
15:21:32 431  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 432  	  SPROC_NAME, 'Could not get current default financial instrument', EXCEPTION_MESSAGE);
15:21:32 433  WHEN CAN_NOT_DEL_DEF_FINANCIAL THEN
15:21:32 434  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 435  	  SPROC_NAME, 'Could not delete information about default financial instrument from account', EXCEPTION_MESSAGE);
15:21:32 436  WHEN BAD_CC_STATUS THEN
15:21:32 437  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 438  	  SPROC_NAME, 'Credit card is not active');
15:21:32 439  WHEN PENDING_TRANSACTIONS_FOUNDED THEN
15:21:32 440  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 441  	  SPROC_NAME, 'Account has pending charge which is using this card');
15:21:32 442  WHEN CAN_NOT_DISABLE_CREDIT_CARD THEN
15:21:32 443  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 444  	  SPROC_NAME, 'Could not disable this credit card', EXCEPTION_MESSAGE);
15:21:32 445  WHEN OTHERS THEN
15:21:32 446  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 447  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 448  END DISABLE_CREDIT_CARD;
15:21:32 449  
15:21:32 450  /******************************************************************************/
15:21:32 451  
15:21:32 452  PROCEDURE DISABLE_PAYPAL (
15:21:32 453  /*
15:21:32 454  Throws exceptions:
15:21:32 455  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 456  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 457  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:32 458  */
15:21:32 459  	in_paypal_id  IN NUMBER,
15:21:32 460  	in_updated_by IN VARCHAR2
15:21:32 461  ) AS
15:21:32 462  SPROC_NAME CONSTANT VARCHAR2(14) := 'DISABLE_PAYPAL';
15:21:32 463  -- VARIABLES
15:21:32 464  var_paypal_status_id NUMBER;
15:21:32 465  var_account_id	   NUMBER;
15:21:32 466  var_group_id	   NUMBER;
15:21:32 467  var_pending_invoices_num NUMBER;
15:21:32 468  current_def_instrument_type_id NUMBER;
15:21:32 469  current_def_instrument_id NUMBER;
15:21:32 470  -- EXCEPTIONS
15:21:32 471  BAD_PAYPAL_ID EXCEPTION;
15:21:32 472  PAYPAL_ALREADY_INACTIVE EXCEPTION;
15:21:32 473  PENDING_TRANSACTIONS_FOUND EXCEPTION;
15:21:32 474  CAN_NOT_GET_DEF_FINANCIAL EXCEPTION;
15:21:32 475  CAN_NOT_DEL_DEF_FINANCIAL EXCEPTION;
15:21:32 476  EXCEPTION_MESSAGE VARCHAR2(1024);
15:21:32 477  BEGIN
15:21:32 478  
15:21:32 479  	-- Get Paypal status
15:21:32 480  	-- Get account
15:21:32 481  	BEGIN
15:21:32 482  	  SELECT
15:21:32 483  	    PAYPAL.PAYPAL_STATUS_ID,
15:21:32 484  	    PAYPAL.ACCOUNT_ID
15:21:32 485  	    into
15:21:32 486  	    var_paypal_status_id,
15:21:32 487  	    var_account_id
15:21:32 488  	  FROM
15:21:32 489  	    PAYPAL
15:21:32 490  	  WHERE
15:21:32 491  	    PAYPAL.ID = in_paypal_id;
15:21:32 492  	  EXCEPTION
15:21:32 493  	    WHEN NO_DATA_FOUND THEN
15:21:32 494  	      RAISE BAD_PAYPAL_ID;
15:21:32 495  	END;
15:21:32 496  
15:21:32 497  	-- Get group id
15:21:32 498  	SELECT
15:21:32 499  	  ACCOUNT.GROUP_ID into var_group_id
15:21:32 500  	FROM
15:21:32 501  	  ACCOUNT
15:21:32 502  	WHERE
15:21:32 503  	  ACCOUNT.ID = var_account_id;
15:21:32 504  
15:21:32 505  	-- Card should not be disabled
15:21:32 506  	IF var_paypal_status_id = GLOBAL_STATUSES_V18.PAYPAL_INACTIVE THEN
15:21:32 507  	  RAISE PAYPAL_ALREADY_INACTIVE;
15:21:32 508  	END IF;
15:21:32 509  
15:21:32 510  	-- Looking for pending transactions associated with given credit card
15:21:32 511  	SELECT
15:21:32 512  	  COUNT(*) into var_pending_invoices_num
15:21:32 513  	FROM
15:21:32 514  	  CHARGE
15:21:32 515  	  INNER JOIN TRANSACTION ON CHARGE.TRANSACTION_ID = TRANSACTION.ID
15:21:32 516  	WHERE
15:21:32 517  	  CHARGE.INSTRUMENT_TYPE_ID = GLOBAL_ENUMS_V18.INSTRUMENT_PAYPAL
15:21:32 518  	  AND CHARGE.INSTRUMENT_ID = in_paypal_id
15:21:32 519  	  AND TRANSACTION.TRANSACTION_STATUS_ID = GLOBAL_STATUSES_V18.TRANSACTION_PENDING;
15:21:32 520  
15:21:32 521  	IF var_pending_invoices_num > 0 THEN
15:21:32 522  	  RAISE PENDING_TRANSACTIONS_FOUND;
15:21:32 523  	END IF;
15:21:32 524  
15:21:32 525  	-- Getting current default financial instrument
15:21:32 526  	BEGIN
15:21:32 527  	  GET_DEF_FINANCIAL_INSTRUMENT(
15:21:32 528  	    in_group_id 	   => var_group_id,
15:21:32 529  	    out_instrument_type_id => current_def_instrument_type_id,
15:21:32 530  	    out_instrument_id	   => current_def_instrument_id
15:21:32 531  	  );
15:21:32 532  	  EXCEPTION
15:21:32 533  	    WHEN OTHERS THEN
15:21:32 534  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:32 535  	      RAISE CAN_NOT_GET_DEF_FINANCIAL;
15:21:32 536  	END;
15:21:32 537  
15:21:32 538  	-- Checking that credit card is not default
15:21:32 539  	IF current_def_instrument_type_id = GLOBAL_ENUMS_V18.INSTRUMENT_PAYPAL
15:21:32 540  	  AND current_def_instrument_id = in_paypal_id THEN
15:21:32 541  	  BEGIN
15:21:32 542  	    DEL_DEF_FINANCIAL_INSTRUMENT(
15:21:32 543  	      in_group_id => var_group_id
15:21:32 544  	    );
15:21:32 545  	  EXCEPTION
15:21:32 546  	    WHEN OTHERS THEN
15:21:32 547  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:32 548  	      RAISE CAN_NOT_DEL_DEF_FINANCIAL;
15:21:32 549  	  END;
15:21:32 550  	END IF;
15:21:32 551  
15:21:32 552  	PROCS_FIN_INSTRUMENTS_V18.UPDATE_PAYPAL_STATUS(
15:21:32 553  	  in_paypal_id	      => in_paypal_id,
15:21:32 554  	  in_updated_by       => in_updated_by,
15:21:32 555  	  in_paypal_status_id => GLOBAL_STATUSES_V18.PAYPAL_INACTIVE
15:21:32 556  	);
15:21:32 557  
15:21:32 558  EXCEPTION
15:21:32 559  WHEN BAD_PAYPAL_ID THEN
15:21:32 560  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 561  	  SPROC_NAME, 'No such paypal');
15:21:32 562  WHEN PAYPAL_ALREADY_INACTIVE THEN
15:21:32 563  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 564  	  SPROC_NAME, 'Paypal already inactive');
15:21:32 565  WHEN PENDING_TRANSACTIONS_FOUND THEN
15:21:32 566  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 567  	  SPROC_NAME, 'Account has pending charge which are using this paypal');
15:21:32 568  WHEN CAN_NOT_GET_DEF_FINANCIAL THEN
15:21:32 569  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 570  	  SPROC_NAME, 'Could not get current default financial instrument', EXCEPTION_MESSAGE);
15:21:32 571  WHEN CAN_NOT_DEL_DEF_FINANCIAL THEN
15:21:32 572  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 573  	  SPROC_NAME, 'Could not delete information about default financial instrument from account', EXCEPTION_MESSAGE);
15:21:32 574  WHEN OTHERS THEN
15:21:32 575  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 576  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 577  END DISABLE_PAYPAL;
15:21:32 578  
15:21:32 579  /******************************************************************************/
15:21:32 580  
15:21:32 581  PROCEDURE UPDATE_CREDIT_CARD (
15:21:32 582  /*
15:21:32 583  Throws exceptions:
15:21:32 584  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 585  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 586  */
15:21:32 587  	in_credit_card_id	  IN NUMBER,
15:21:32 588  	in_updated_by		  IN VARCHAR2,
15:21:32 589  	in_instrument_name	  IN VARCHAR2,
15:21:32 590  	in_is_default		  IN NUMBER
15:21:32 591  ) AS
15:21:32 592  SPROC_NAME CONSTANT VARCHAR2(18) := 'UPDATE_CREDIT_CARD';
15:21:32 593  -- VARIABLES
15:21:32 594  var_account_id NUMBER;
15:21:32 595  var_group_id   NUMBER;
15:21:32 596  temp_cc_rownum NUMBER;
15:21:32 597  current_def_instrument_type_id NUMBER;
15:21:32 598  current_def_instrument_id      NUMBER;
15:21:32 599  -- EXCEPTION
15:21:32 600  CAN_NOT_SET_DEF_FINANCIAL  EXCEPTION;
15:21:32 601  BAD_IS_DEFAULT_VALUE	 EXCEPTION;
15:21:32 602  CAN_NOT_GET_DEF_FINANCIAL  EXCEPTION;
15:21:32 603  CAN_NOT_DEL_DEF_FINANCIAL  EXCEPTION;
15:21:32 604  EXCEPTION_MESSAGE 	 VARCHAR2(1024);
15:21:32 605  BEGIN
15:21:32 606  
15:21:32 607  	-- Get account id
15:21:32 608  	SELECT
15:21:32 609  	  CREDIT_CARD.ACCOUNT_ID
15:21:32 610  	  into
15:21:32 611  	  var_account_id
15:21:32 612  	FROM
15:21:32 613  	  CREDIT_CARD
15:21:32 614  	WHERE
15:21:32 615  	  CREDIT_CARD.ID = in_credit_card_id;
15:21:32 616  
15:21:32 617  	-- Get group id
15:21:32 618  	SELECT
15:21:32 619  	  ACCOUNT.GROUP_ID into var_group_id
15:21:32 620  	FROM
15:21:32 621  	  ACCOUNT
15:21:32 622  	WHERE
15:21:32 623  	  ACCOUNT.ID = var_account_id;
15:21:32 624  
15:21:32 625  	-- Check that passed data is correct
15:21:32 626  	IF in_is_default != GLOBAL_CONSTANTS_V18.TRUE
15:21:32 627  	  AND in_is_default != GLOBAL_CONSTANTS_V18.FALSE
15:21:32 628  	  AND in_is_default IS NOT NULL THEN
15:21:32 629  	  RAISE BAD_IS_DEFAULT_VALUE;
15:21:32 630  	END IF;
15:21:32 631  
15:21:32 632  	-- Update credit card
15:21:32 633  	IF in_instrument_name IS NOT NULL THEN
15:21:32 634  	  PROCS_FIN_INSTRUMENTS_CRU_V18.UPDATE_CREDIT_CARD(
15:21:32 635  	    in_credit_card_id  => in_credit_card_id,
15:21:32 636  	    in_updated_by      => in_updated_by,
15:21:32 637  	    in_instrument_name => in_instrument_name
15:21:32 638  	  );
15:21:32 639  	END IF;
15:21:32 640  
15:21:32 641  	-- Set default financial instrument
15:21:32 642  	IF in_is_default = GLOBAL_CONSTANTS_V18.TRUE THEN
15:21:32 643  	  BEGIN
15:21:32 644  	    PROCS_FIN_INSTRUMENTS_V18.SET_DEF_FINANCIAL_INSTRUMENT(
15:21:32 645  	      in_group_id	    => var_group_id,
15:21:32 646  	      in_instrument_type_id => GLOBAL_ENUMS_V18.INSTRUMENT_CREDIT_CARD,
15:21:32 647  	      in_instrument_id	    => in_credit_card_id,
15:21:32 648  	      in_updated_by	    => in_updated_by
15:21:32 649  	    );
15:21:32 650  	    EXCEPTION
15:21:32 651  	      WHEN OTHERS THEN
15:21:32 652  		EXCEPTION_MESSAGE := SQLERRM;
15:21:32 653  		RAISE CAN_NOT_SET_DEF_FINANCIAL;
15:21:32 654  	  END;
15:21:32 655  	END IF;
15:21:32 656  
15:21:32 657  	-- Set default financial instrument
15:21:32 658  	IF in_is_default = GLOBAL_CONSTANTS_V18.FALSE THEN
15:21:32 659  	  BEGIN
15:21:32 660  	    GET_DEF_FINANCIAL_INSTRUMENT(
15:21:32 661  	      in_group_id	     => var_group_id,
15:21:32 662  	      out_instrument_type_id => current_def_instrument_type_id,
15:21:32 663  	      out_instrument_id      => current_def_instrument_id
15:21:32 664  	    );
15:21:32 665  	  EXCEPTION
15:21:32 666  	    WHEN OTHERS THEN
15:21:32 667  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:32 668  	      RAISE CAN_NOT_GET_DEF_FINANCIAL;
15:21:32 669  	  END;
15:21:32 670  	  IF current_def_instrument_type_id = GLOBAL_ENUMS_V18.INSTRUMENT_CREDIT_CARD
15:21:32 671  	    AND current_def_instrument_id = in_credit_card_id THEN
15:21:32 672  	    BEGIN
15:21:32 673  	      DEL_DEF_FINANCIAL_INSTRUMENT(
15:21:32 674  		in_group_id => var_group_id
15:21:32 675  	      );
15:21:32 676  	      EXCEPTION
15:21:32 677  		WHEN OTHERS THEN
15:21:32 678  		  EXCEPTION_MESSAGE := SQLERRM;
15:21:32 679  		  RAISE CAN_NOT_DEL_DEF_FINANCIAL;
15:21:32 680  	    END;
15:21:32 681  	  END IF;
15:21:32 682  	END IF;
15:21:32 683  
15:21:32 684  EXCEPTION
15:21:32 685  WHEN NO_DATA_FOUND THEN
15:21:32 686  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 687  	  SPROC_NAME, 'No such credit card');
15:21:32 688  WHEN CAN_NOT_SET_DEF_FINANCIAL THEN
15:21:32 689  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 690  	  SPROC_NAME, 'Could not set default financial instrument for account', EXCEPTION_MESSAGE);
15:21:32 691  WHEN CAN_NOT_GET_DEF_FINANCIAL THEN
15:21:32 692  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 693  	  SPROC_NAME, 'Could not get default financial instrument for account', EXCEPTION_MESSAGE);
15:21:32 694  WHEN CAN_NOT_DEL_DEF_FINANCIAL THEN
15:21:32 695  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 696  	  SPROC_NAME, 'Could not delete information about default financial instrument', EXCEPTION_MESSAGE);
15:21:32 697  WHEN OTHERS THEN
15:21:32 698  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 699  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 700  END UPDATE_CREDIT_CARD;
15:21:32 701  
15:21:32 702  /******************************************************************************/
15:21:32 703  
15:21:32 704  PROCEDURE START_GC_PURCHASING (
15:21:32 705  	in_group_id		  IN NUMBER,
15:21:32 706  	in_offer_chain_id	  IN VARCHAR2,
15:21:32 707  	in_gift_certificate_code  IN  VARCHAR2,
15:21:32 708  	in_created_by		  IN  VARCHAR2,
15:21:32 709  	in_recipient_name	  IN  VARCHAR2,
15:21:32 710  	in_recipient_email	  IN  VARCHAR2,
15:21:32 711  	in_recipient_address_id   IN NUMBER,
15:21:32 712  	in_recipient_notify_date  IN DATE,
15:21:32 713  	in_sender_name		  IN VARCHAR2,
15:21:32 714  	in_sender_email 	  IN VARCHAR2,
15:21:32 715  	in_gift_message 	  IN  VARCHAR2,
15:21:32 716  	in_expiration_date	  IN DATE,
15:21:32 717  	out_gift_certificate_id   OUT NUMBER,
15:21:32 718  	out_invoice_id		  OUT NUMBER
15:21:32 719  ) AS
15:21:32 720  SPROC_NAME CONSTANT VARCHAR2(19) := 'START_GC_PURCHASING';
15:21:32 721  -- VARIABLES
15:21:32 722  var_account_id		NUMBER;
15:21:32 723  temp_gc_code		GIFT_CERTIFICATE.CODE%TYPE;
15:21:32 724  var_och_is_gc		NUMBER;
15:21:32 725  var_offer_chain_status_id NUMBER;
15:21:32 726  var_is_for_redemption	NUMBER;
15:21:32 727  var_new_invoice_id	NUMBER;
15:21:32 728  var_gift_cert_id		NUMBER;
15:21:32 729  var_account_tax_exempt_id VARCHAR2(255);
15:21:32 730  -- EXCEPTIONS
15:21:32 731  BAD_GROUP_ID		    EXCEPTION;
15:21:32 732  GC_CODE_ALREADY_EXISTS	    EXCEPTION;
15:21:32 733  BAD_OFFER_CHAIN_ID	    EXCEPTION;
15:21:32 734  OCH_IS_NOT_GIFT_CERTIFICATE   EXCEPTION;
15:21:32 735  BAD_OFFER_CHAIN_STATUS	    EXCEPTION;
15:21:32 736  CAN_NOT_PURCHASE_GC_FOR_RDMPN EXCEPTION;
15:21:32 737  CAN_NOT_CREATE_INVOICE	    EXCEPTION;
15:21:32 738  OFFER_REC_NUM_LESS_THAN_ONE   EXCEPTION;
15:21:32 739  CAN_NOT_CREATE_LINE_ITEMS     EXCEPTION;
15:21:32 740  
15:21:32 741  EXCEPTION_MESSAGE VARCHAR2(1024);
15:21:32 742  BEGIN
15:21:32 743  	-- Get account id
15:21:32 744  	BEGIN
15:21:32 745  	  SELECT
15:21:32 746  	    ACCOUNT.ID,
15:21:32 747  	    ACCOUNT.TAX_EXEMPT_ID
15:21:32 748  	    into
15:21:32 749  	    var_account_id,
15:21:32 750  	    var_account_tax_exempt_id
15:21:32 751  	  FROM
15:21:32 752  	    ACCOUNT
15:21:32 753  	  WHERE
15:21:32 754  	    ACCOUNT.GROUP_ID = in_group_id;
15:21:32 755  	  EXCEPTION
15:21:32 756  	  WHEN NO_DATA_FOUND THEN
15:21:32 757  	    RAISE BAD_GROUP_ID;
15:21:32 758  	END;
15:21:32 759  
15:21:32 760  	-- Check for the same code
15:21:32 761  	BEGIN
15:21:32 762  	  SELECT
15:21:32 763  	    GIFT_CERTIFICATE.CODE into temp_gc_code
15:21:32 764  	  FROM
15:21:32 765  	    GIFT_CERTIFICATE
15:21:32 766  	  WHERE
15:21:32 767  	    GIFT_CERTIFICATE.CODE = in_gift_certificate_code;
15:21:32 768  
15:21:32 769  	  RAISE GC_CODE_ALREADY_EXISTS;
15:21:32 770  
15:21:32 771  	  EXCEPTION
15:21:32 772  	    WHEN NO_DATA_FOUND THEN
15:21:32 773  	      NULL;
15:21:32 774  	END;
15:21:32 775  
15:21:32 776  	-- Get offer chain flag "is_gift_certificate"
15:21:32 777  	BEGIN
15:21:32 778  	  SELECT
15:21:32 779  	    OFFER_CHAIN.IS_GIFT_CERTIFICATE,
15:21:32 780  	    OFFER_CHAIN.OFFER_CHAIN_STATUS_ID
15:21:32 781  	    into
15:21:32 782  	    var_och_is_gc,
15:21:32 783  	    var_offer_chain_status_id
15:21:32 784  	  FROM
15:21:32 785  	    OFFER_CHAIN
15:21:32 786  	  WHERE
15:21:32 787  	    OFFER_CHAIN.ID = in_offer_chain_id;
15:21:32 788  	  EXCEPTION
15:21:32 789  	  WHEN NO_DATA_FOUND THEN
15:21:32 790  	    RAISE BAD_OFFER_CHAIN_ID;
15:21:32 791  	END;
15:21:32 792  
15:21:32 793  	IF var_och_is_gc != GLOBAL_CONSTANTS_V18.TRUE
15:21:32 794  	  OR var_och_is_gc IS NULL THEN
15:21:32 795  	  RAISE OCH_IS_NOT_GIFT_CERTIFICATE;
15:21:32 796  	END IF;
15:21:32 797  
15:21:32 798  	IF var_offer_chain_status_id != GLOBAL_STATUSES_V18.OFFER_CHAIN_ACTIVE THEN
15:21:32 799  	  RAISE BAD_OFFER_CHAIN_STATUS;
15:21:32 800  	END IF;
15:21:32 801  
15:21:32 802  	-- norlov: #38151 check if the OC is for Redemption:
15:21:32 803  	SELECT
15:21:32 804  	  COUNT(*) into var_is_for_redemption
15:21:32 805  	FROM
15:21:32 806  	  OFFER_CHAIN_ELIGIBILITY
15:21:32 807  	WHERE
15:21:32 808  	  OFFER_CHAIN_ELIGIBILITY.OFFER_CHAIN_ID = in_offer_chain_id
15:21:32 809  	  AND OFFER_CHAIN_ELIGIBILITY.NAME = GLOBAL_CONSTANTS_V18.GIFT_CERTIFICATE_REQUIRED
15:21:32 810  	  AND OFFER_CHAIN_ELIGIBILITY.VALUE = GLOBAL_CONSTANTS_V18.ELIGIBILITY_FLAG_SET;
15:21:32 811  
15:21:32 812  	IF var_is_for_redemption > 0 THEN
15:21:32 813  	  RAISE CAN_NOT_PURCHASE_GC_FOR_RDMPN;
15:21:32 814  	END IF;
15:21:32 815  
15:21:32 816  	-- Create new invoice
15:21:32 817  	BEGIN
15:21:32 818  	  PROCS_INVOICE_V18.CREATE_INVOICE(
15:21:32 819  	    in_invoice_status => GLOBAL_STATUSES_V18.INVOICE_OPEN,
15:21:32 820  	    in_created_by     => in_created_by,
15:21:32 821  	    in_tax_exempt_id  => var_account_tax_exempt_id,
15:21:32 822  	    out_invoice_id    => var_new_invoice_id
15:21:32 823  	  );
15:21:32 824  	  EXCEPTION
15:21:32 825  	    WHEN OTHERS THEN
15:21:32 826  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:32 827  	      RAISE CAN_NOT_CREATE_INVOICE;
15:21:32 828  	END;
15:21:32 829  
15:21:32 830  	-- Add line items for new invoice
15:21:32 831  	BEGIN
15:21:32 832  	  FOR f_offer_data IN (
15:21:32 833  	    SELECT
15:21:32 834  	      OFFER_ID,
15:21:32 835  	      NUM_RECURRENCES
15:21:32 836  	    FROM
15:21:32 837  	      OFFER_OFFER_CHAIN
15:21:32 838  	    WHERE
15:21:32 839  	      OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_id
15:21:32 840  	  )
15:21:32 841  	  LOOP
15:21:32 842  	    IF f_offer_data.NUM_RECURRENCES < 1 THEN
15:21:32 843  	      RAISE OFFER_REC_NUM_LESS_THAN_ONE;
15:21:32 844  	    END IF;
15:21:32 845  	    FOR i_offer_recurrences_iterator IN 1..f_offer_data.NUM_RECURRENCES
15:21:32 846  	    LOOP
15:21:32 847  	      PROCS_LINE_ITEMS_V18.ADD_LINE_ITEMS(
15:21:32 848  		in_invoice_id => var_new_invoice_id,
15:21:32 849  		in_offer_id   => f_offer_data.OFFER_ID,
15:21:32 850  		in_created_by => in_created_by
15:21:32 851  	      );
15:21:32 852  	    END LOOP;
15:21:32 853  	  END LOOP;
15:21:32 854  
15:21:32 855  	  EXCEPTION
15:21:32 856  	    WHEN OTHERS THEN
15:21:32 857  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:32 858  	      RAISE CAN_NOT_CREATE_LINE_ITEMS;
15:21:32 859  	END;
15:21:32 860  
15:21:32 861  	PROCS_FIN_INSTRUMENTS_CRU_V18.CREATE_GIFT_CERTIFICATE(
15:21:32 862  	  out_gift_certificate_id	=> var_gift_cert_id,
15:21:32 863  	  in_purchaser_group_id 	=> in_group_id,
15:21:32 864  	  in_purchaser_invoice_id	=> var_new_invoice_id,
15:21:32 865  	  in_offer_chain_id		=> in_offer_chain_id,
15:21:32 866  	  in_expiration_date		=> in_expiration_date,
15:21:32 867  	  in_purchase_date		=> SYSDATE,
15:21:32 868  	  in_gift_certificate_status_id => GLOBAL_STATUSES_V18.GIFT_CERTIFICATE_ACTIVE,
15:21:32 869  	  in_code			=> in_gift_certificate_code,
15:21:32 870  	  in_created_by 		=> in_created_by,
15:21:32 871  	  in_recipient_name		=> in_recipient_name,
15:21:32 872  	  in_gift_message		=> in_gift_message,
15:21:32 873  	  in_recipient_email		=> in_recipient_email,
15:21:32 874  	  in_sender_email		=> in_sender_email,
15:21:32 875  	  in_sender_name		=> in_sender_name,
15:21:32 876  	  in_recipient_address_id	=> in_recipient_address_id,
15:21:32 877  	  in_recipient_notify_date	=> in_recipient_notify_date
15:21:32 878  	);
15:21:32 879  
15:21:32 880  	out_gift_certificate_id := var_gift_cert_id;
15:21:32 881  	out_invoice_id := var_new_invoice_id;
15:21:32 882  
15:21:32 883  EXCEPTION
15:21:32 884  WHEN BAD_OFFER_CHAIN_STATUS THEN
15:21:32 885  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 886  	  SPROC_NAME, 'Offer chain is not active');
15:21:32 887  WHEN GC_CODE_ALREADY_EXISTS THEN
15:21:32 888  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.DUPLICATE_ERROR,
15:21:32 889  	  SPROC_NAME, 'Gift certificate with same code already exists');
15:21:32 890  WHEN OCH_IS_NOT_GIFT_CERTIFICATE THEN
15:21:32 891  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 892  	  SPROC_NAME, 'This offer chain can not be used for gift certificate');
15:21:32 893  WHEN CAN_NOT_PURCHASE_GC_FOR_RDMPN THEN
15:21:32 894  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 895  	  SPROC_NAME, 'This offer chain can not be purchased for gift certificate since it is for redemption');
15:21:32 896  WHEN CAN_NOT_CREATE_INVOICE THEN
15:21:32 897  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 898  	  SPROC_NAME, 'Could not create new invoice', EXCEPTION_MESSAGE);
15:21:32 899  WHEN CAN_NOT_CREATE_LINE_ITEMS THEN
15:21:32 900  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 901  	  SPROC_NAME, 'Could not create line items', EXCEPTION_MESSAGE);
15:21:32 902  WHEN BAD_GROUP_ID THEN
15:21:32 903  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 904  	  SPROC_NAME, 'No such group id');
15:21:32 905  WHEN BAD_OFFER_CHAIN_ID THEN
15:21:32 906  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 907  	  SPROC_NAME, 'No such offer chain');
15:21:32 908  WHEN OFFER_REC_NUM_LESS_THAN_ONE THEN
15:21:32 909  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 910  	  SPROC_NAME, 'Some offer has recurrences number less than 1');
15:21:32 911  WHEN OTHERS THEN
15:21:32 912  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 913  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 914  END START_GC_PURCHASING;
15:21:32 915  
15:21:32 916  /******************************************************************************/
15:21:32 917  
15:21:32 918  PROCEDURE FINALIZE_GC_PURCHASING (
15:21:32 919  	in_invoice_id	      IN NUMBER,
15:21:32 920  	in_created_by	      IN VARCHAR2,
15:21:32 921  	in_instrument_id      IN NUMBER,
15:21:32 922  	in_instrument_type_id IN NUMBER,
15:21:32 923  	in_order_id	      IN VARCHAR2,
15:21:32 924  	in_transaction_id     IN NUMBER,
15:21:32 925  	out_charge_amount     OUT NUMBER
15:21:32 926  ) AS
15:21:32 927  SPROC_NAME CONSTANT VARCHAR2(22) := 'FINALIZE_GC_PURCHASING';
15:21:32 928  -- VARIABLES
15:21:32 929  temp_transaction_id_count NUMBER;
15:21:32 930  var_invoice_amount	NUMBER(10,2);
15:21:32 931  var_transaction_id	NUMBER;
15:21:32 932  var_new_charge_id 	NUMBER;
15:21:32 933  -- EXCEPTIONS
15:21:32 934  BAD_CREDIT_CARD_ID	  EXCEPTION;
15:21:32 935  BAD_PAYPAL_ID		  EXCEPTION;
15:21:32 936  BAD_INSTRUMENT_TYPE	  EXCEPTION;
15:21:32 937  TRANSACTION_EXISTS	  EXCEPTION;
15:21:32 938  CAN_NOT_CALC_INVOICE_AMOUNT EXCEPTION;
15:21:32 939  CAN_NOT_USE_FCINSTR	  EXCEPTION;
15:21:32 940  CAN_NOT_CREATE_TRANSACTION  EXCEPTION;
15:21:32 941  CAN_NOT_CREATE_CHARGE	  EXCEPTION;
15:21:32 942  EXCEPTION_MESSAGE   VARCHAR2(1024);
15:21:32 943  BEGIN
15:21:32 944  
15:21:32 945  	-- Check that instrument exists
15:21:32 946  	IF in_instrument_type_id = GLOBAL_ENUMS_V18.INSTRUMENT_CREDIT_CARD THEN
15:21:32 947  	  IF IS_CREDIT_CARD_EXISTS(in_instrument_id) = GLOBAL_CONSTANTS_V18.FALSE THEN
15:21:32 948  	    RAISE BAD_CREDIT_CARD_ID;
15:21:32 949  	  END IF;
15:21:32 950  	ELSIF in_instrument_type_id = GLOBAL_ENUMS_V18.INSTRUMENT_PAYPAL THEN
15:21:32 951  	  IF IS_PAYPAL_EXISTS(in_instrument_id) = GLOBAL_CONSTANTS_V18.FALSE THEN
15:21:32 952  	    RAISE BAD_PAYPAL_ID;
15:21:32 953  	  END IF;
15:21:32 954  	ELSIF in_instrument_type_id = GLOBAL_ENUMS_V18.INSTRUMENT_ZCI_INSTRUMENT THEN
15:21:32 955  	  NULL;
15:21:32 956  	ELSE
15:21:32 957  	  RAISE BAD_INSTRUMENT_TYPE;
15:21:32 958  	END IF;
15:21:32 959  
15:21:32 960  	-- Check that transaction with given id do not exists
15:21:32 961  	SELECT
15:21:32 962  	  COUNT(*) into temp_transaction_id_count
15:21:32 963  	FROM
15:21:32 964  	  TRANSACTION
15:21:32 965  	WHERE
15:21:32 966  	  TRANSACTION.ID = in_transaction_id;
15:21:32 967  
15:21:32 968  	IF temp_transaction_id_count > 0 THEN
15:21:32 969  	  RAISE TRANSACTION_EXISTS;
15:21:32 970  	END IF;
15:21:32 971  
15:21:32 972  	-- Calculate new invoice amount
15:21:32 973  	BEGIN
15:21:32 974  	  PROCS_INVOICE_V18.CALCULATE_INVOICE_AMOUNT(in_invoice_id, var_invoice_amount);
15:21:32 975  	  EXCEPTION
15:21:32 976  	    WHEN OTHERS THEN
15:21:32 977  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:32 978  	      RAISE CAN_NOT_CALC_INVOICE_AMOUNT;
15:21:32 979  	END;
15:21:32 980  
15:21:32 981  	IF var_invoice_amount > 0
15:21:32 982  	  AND in_instrument_type_id = GLOBAL_ENUMS_V18.INSTRUMENT_ZCI_INSTRUMENT THEN
15:21:32 983  	  RAISE CAN_NOT_USE_FCINSTR;
15:21:32 984  	END IF;
15:21:32 985  
15:21:32 986  	-- If invoice amount iz 0 then we need to set status for this invoice to PROCCESSED
15:21:32 987  	IF var_invoice_amount = 0 THEN
15:21:32 988  	  PROCS_INVOICE_CRU_V18.UPDATE_INVOICE(
15:21:32 989  	    in_invoice_id		   => in_invoice_id,
15:21:32 990  	    in_updated_by		   => in_created_by,
15:21:32 991  	    in_invoice_status_id	   => GLOBAL_STATUSES_V18.INVOICE_CLOSED
15:21:32 992  	  );
15:21:32 993  	END IF;
15:21:32 994  
15:21:32 995  	IF var_invoice_amount > 0 THEN
15:21:32 996  	  -- Create transaction
15:21:32 997  	  BEGIN
15:21:32 998  	    PROCS_TRANSACTION_V18.CREATE_TRANSACTION(
15:21:32 999  	      in_transaction_id        => in_transaction_id,
15:21:32 1000  	       in_status_id		=> GLOBAL_STATUSES_V18.TRANSACTION_PENDING,
15:21:32 1001  	       in_amount		=> var_invoice_amount,
15:21:32 1002  	       in_created_by		=> in_created_by,
15:21:32 1003  	       in_order_id		=> in_order_id,
15:21:32 1004  	       in_transaction_type_code => 'GIFT_CERTIFICATE_PURCHASE',
15:21:32 1005  	       out_transaction_id	=> var_transaction_id
15:21:32 1006  	     );
15:21:32 1007  	     EXCEPTION
15:21:32 1008  	       WHEN OTHERS THEN
15:21:32 1009  		 EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1010  		 RAISE CAN_NOT_CREATE_TRANSACTION;
15:21:32 1011  	   END;
15:21:32 1012  
15:21:32 1013  	   -- Create charge
15:21:32 1014  	   BEGIN
15:21:32 1015  	     PROCS_CHARGE_V18.CREATE_CHARGE(
15:21:32 1016  	       in_invoice_id	     => in_invoice_id,
15:21:32 1017  	       in_transaction_id     => var_transaction_id,
15:21:32 1018  	       in_instrument_type_id => in_instrument_type_id,
15:21:32 1019  	       in_instrument_id      => in_instrument_id,
15:21:32 1020  	       in_charge_amount      => var_invoice_amount,
15:21:32 1021  	       in_created_by	     => in_created_by,
15:21:32 1022  	       in_charge_status_id   => GLOBAL_STATUSES_V18.CHARGE_OPENED,
15:21:32 1023  	       out_charge_id	     => var_new_charge_id
15:21:32 1024  	     );
15:21:32 1025  	     out_charge_amount := var_invoice_amount;
15:21:32 1026  	     EXCEPTION
15:21:32 1027  	       WHEN OTHERS THEN
15:21:32 1028  		 EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1029  		 RAISE CAN_NOT_CREATE_CHARGE;
15:21:32 1030  	   END;
15:21:32 1031  	 ELSE
15:21:32 1032  	   out_charge_amount := 0;
15:21:32 1033  	 END IF;
15:21:32 1034  
15:21:32 1035  EXCEPTION
15:21:32 1036  WHEN CAN_NOT_USE_FCINSTR THEN
15:21:32 1037  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 1038  	   SPROC_NAME, 'Could not use "free charge instrument" for non-zero invoice');
15:21:32 1039  WHEN BAD_CREDIT_CARD_ID THEN
15:21:32 1040  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1041  	   SPROC_NAME, 'Bad credit card id');
15:21:32 1042  WHEN BAD_PAYPAL_ID THEN
15:21:32 1043  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1044  	   SPROC_NAME, 'Bad paypal id');
15:21:32 1045  WHEN BAD_INSTRUMENT_TYPE THEN
15:21:32 1046  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 1047  	   SPROC_NAME, 'Bad instrument type');
15:21:32 1048  WHEN TRANSACTION_EXISTS THEN
15:21:32 1049  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.DUPLICATE_ERROR,
15:21:32 1050  	   SPROC_NAME, 'Transaction with given id already exists');
15:21:32 1051  WHEN CAN_NOT_CREATE_TRANSACTION THEN
15:21:32 1052  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1053  	   SPROC_NAME, 'Could not create transaction', EXCEPTION_MESSAGE);
15:21:32 1054  WHEN CAN_NOT_CREATE_CHARGE THEN
15:21:32 1055  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1056  	   SPROC_NAME, 'Could not create charge', EXCEPTION_MESSAGE);
15:21:32 1057  WHEN CAN_NOT_CALC_INVOICE_AMOUNT THEN
15:21:32 1058  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1059  	   SPROC_NAME, 'Could not calculate amount for new invoice', EXCEPTION_MESSAGE);
15:21:32 1060  WHEN OTHERS THEN
15:21:32 1061  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1062  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1063  END FINALIZE_GC_PURCHASING;
15:21:32 1064  
15:21:32 1065  /******************************************************************************/
15:21:32 1066  
15:21:32 1067  PROCEDURE PURCHASE_GIFT_CERTIFICATE (
15:21:32 1068  	 in_group_id		   IN NUMBER,
15:21:32 1069  	 in_offer_chain_id	   IN VARCHAR2,
15:21:32 1070  	 in_gift_certificate_code  IN VARCHAR2,
15:21:32 1071  	 in_created_by		   IN VARCHAR2,
15:21:32 1072  	 in_recipient_name	   IN VARCHAR2,
15:21:32 1073  	 in_recipient_email	   IN VARCHAR2,
15:21:32 1074  	 in_sender_name 	   IN VARCHAR2,
15:21:32 1075  	 in_sender_email	   IN VARCHAR2,
15:21:32 1076  	 in_gift_message	   IN VARCHAR2,
15:21:32 1077  	 in_instrument_id	   IN NUMBER,
15:21:32 1078  	 in_instrument_type_id	   IN NUMBER,
15:21:32 1079  	 in_expiration_date	   IN DATE,
15:21:32 1080  	 in_order_id		   IN VARCHAR2,
15:21:32 1081  	 in_transaction_id	   IN NUMBER
15:21:32 1082  ) AS
15:21:32 1083  SPROC_NAME	  CONSTANT VARCHAR2(25) := 'PURCHASE_GIFT_CERTIFICATE';
15:21:32 1084  -- VARIABLES
15:21:32 1085  var_gift_cert_id   NUMBER;
15:21:32 1086  var_account_id	  NUMBER;
15:21:32 1087  var_invoice_amount NUMBER (10,2);
15:21:32 1088  var_new_invoice_id NUMBER;
15:21:32 1089  var_new_charge_id  NUMBER;
15:21:32 1090  var_och_is_gc	  NUMBER;
15:21:32 1091  var_offer_chain_status_id NUMBER;
15:21:32 1092  var_is_for_redemption	 NUMBER;
15:21:32 1093  var_account_tax_exempt_id VARCHAR2(255);
15:21:32 1094  
15:21:32 1095  temp_transaction_id_count NUMBER;
15:21:32 1096  var_transaction_id	 NUMBER;
15:21:32 1097  temp_gc_code VARCHAR2(255);
15:21:32 1098  
15:21:32 1099  var_invoice_status_id NUMBER;
15:21:32 1100  -- EXCEPTIONS
15:21:32 1101  CAN_NOT_CREATE_INVOICE		   EXCEPTION;
15:21:32 1102  CAN_NOT_CREATE_TRANSACTION	   EXCEPTION;
15:21:32 1103  CAN_NOT_CREATE_CHARGE		   EXCEPTION;
15:21:32 1104  CAN_NOT_CREATE_LINE_ITEMS	   EXCEPTION;
15:21:32 1105  BAD_GROUP_ID			   EXCEPTION;
15:21:32 1106  BAD_OFFER_CHAIN_ID		   EXCEPTION;
15:21:32 1107  OCH_IS_NOT_GIFT_CERTIFICATE	   EXCEPTION;
15:21:32 1108  TRANSACTION_EXISTS		   EXCEPTION;
15:21:32 1109  GC_CODE_ALREADY_EXISTS		   EXCEPTION;
15:21:32 1110  BAD_INSTRUMENT_TYPE		   EXCEPTION;
15:21:32 1111  BAD_CREDIT_CARD_ID		   EXCEPTION;
15:21:32 1112  BAD_PAYPAL_ID			   EXCEPTION;
15:21:32 1113  CAN_NOT_CALCULATE_OCH_AMOUNT	   EXCEPTION;
15:21:32 1114  BAD_OFFER_CHAIN_STATUS		   EXCEPTION;
15:21:32 1115  OFFER_REC_NUM_LESS_THAN_ONE	   EXCEPTION;
15:21:32 1116  CAN_NOT_CALC_INVOICE_AMOUNT	   EXCEPTION;
15:21:32 1117  CAN_NOT_USE_FCINSTR		   EXCEPTION;
15:21:32 1118  CAN_NOT_PURCHASE_GC_FOR_RDMPN	   EXCEPTION;
15:21:32 1119  EXCEPTION_MESSAGE		   VARCHAR2(1024);
15:21:32 1120  BEGIN
15:21:32 1121  
15:21:32 1122  	 -- Get account id
15:21:32 1123  	 BEGIN
15:21:32 1124  	   SELECT
15:21:32 1125  	     ACCOUNT.ID,
15:21:32 1126  	     ACCOUNT.TAX_EXEMPT_ID
15:21:32 1127  	     into
15:21:32 1128  	     var_account_id,
15:21:32 1129  	     var_account_tax_exempt_id
15:21:32 1130  	   FROM
15:21:32 1131  	     ACCOUNT
15:21:32 1132  	   WHERE
15:21:32 1133  	     ACCOUNT.GROUP_ID = in_group_id;
15:21:32 1134  	   EXCEPTION
15:21:32 1135  	   WHEN NO_DATA_FOUND THEN
15:21:32 1136  	     RAISE BAD_GROUP_ID;
15:21:32 1137  	 END;
15:21:32 1138  
15:21:32 1139  	 -- Check that instrument exists
15:21:32 1140  	 IF in_instrument_type_id = GLOBAL_ENUMS_V18.INSTRUMENT_CREDIT_CARD THEN
15:21:32 1141  	   IF IS_CREDIT_CARD_EXISTS(in_instrument_id) = GLOBAL_CONSTANTS_V18.FALSE THEN
15:21:32 1142  	     RAISE BAD_CREDIT_CARD_ID;
15:21:32 1143  	   END IF;
15:21:32 1144  	 ELSIF in_instrument_type_id = GLOBAL_ENUMS_V18.INSTRUMENT_PAYPAL THEN
15:21:32 1145  	   IF IS_PAYPAL_EXISTS(in_instrument_id) = GLOBAL_CONSTANTS_V18.FALSE THEN
15:21:32 1146  	     RAISE BAD_PAYPAL_ID;
15:21:32 1147  	   END IF;
15:21:32 1148  	 ELSIF in_instrument_type_id = GLOBAL_ENUMS_V18.INSTRUMENT_ZCI_INSTRUMENT THEN
15:21:32 1149  	   NULL;
15:21:32 1150  	 ELSE
15:21:32 1151  	   RAISE BAD_INSTRUMENT_TYPE;
15:21:32 1152  	 END IF;
15:21:32 1153  
15:21:32 1154  	 -- Check for the same code
15:21:32 1155  	 BEGIN
15:21:32 1156  	   SELECT
15:21:32 1157  	     GIFT_CERTIFICATE.CODE into temp_gc_code
15:21:32 1158  	   FROM
15:21:32 1159  	     GIFT_CERTIFICATE
15:21:32 1160  	   WHERE
15:21:32 1161  	     GIFT_CERTIFICATE.CODE = in_gift_certificate_code;
15:21:32 1162  
15:21:32 1163  	   RAISE GC_CODE_ALREADY_EXISTS;
15:21:32 1164  
15:21:32 1165  	   EXCEPTION
15:21:32 1166  	     WHEN NO_DATA_FOUND THEN
15:21:32 1167  	       NULL;
15:21:32 1168  	 END;
15:21:32 1169  
15:21:32 1170  	 -- Get offer chain flag "is_gift_certificate"
15:21:32 1171  	 BEGIN
15:21:32 1172  	   SELECT
15:21:32 1173  	     OFFER_CHAIN.IS_GIFT_CERTIFICATE,
15:21:32 1174  	     OFFER_CHAIN.OFFER_CHAIN_STATUS_ID
15:21:32 1175  	     into
15:21:32 1176  	     var_och_is_gc,
15:21:32 1177  	     var_offer_chain_status_id
15:21:32 1178  	   FROM
15:21:32 1179  	     OFFER_CHAIN
15:21:32 1180  	   WHERE
15:21:32 1181  	     OFFER_CHAIN.ID = in_offer_chain_id;
15:21:32 1182  	   EXCEPTION
15:21:32 1183  	   WHEN NO_DATA_FOUND THEN
15:21:32 1184  	     RAISE BAD_OFFER_CHAIN_ID;
15:21:32 1185  	 END;
15:21:32 1186  
15:21:32 1187  	 IF var_och_is_gc != GLOBAL_CONSTANTS_V18.TRUE
15:21:32 1188  	   OR var_och_is_gc IS NULL THEN
15:21:32 1189  	   RAISE OCH_IS_NOT_GIFT_CERTIFICATE;
15:21:32 1190  	 END IF;
15:21:32 1191  
15:21:32 1192  	 IF var_offer_chain_status_id != GLOBAL_STATUSES_V18.OFFER_CHAIN_ACTIVE THEN
15:21:32 1193  	   RAISE BAD_OFFER_CHAIN_STATUS;
15:21:32 1194  	 END IF;
15:21:32 1195  
15:21:32 1196  	 -- norlov: #38151 check if the OC is for Redemption:
15:21:32 1197  	 SELECT
15:21:32 1198  	   COUNT(*) into var_is_for_redemption
15:21:32 1199  	 FROM
15:21:32 1200  	   OFFER_CHAIN_ELIGIBILITY
15:21:32 1201  	 WHERE
15:21:32 1202  	   OFFER_CHAIN_ELIGIBILITY.OFFER_CHAIN_ID = in_offer_chain_id
15:21:32 1203  	   AND OFFER_CHAIN_ELIGIBILITY.NAME = GLOBAL_CONSTANTS_V18.GIFT_CERTIFICATE_REQUIRED
15:21:32 1204  	   AND OFFER_CHAIN_ELIGIBILITY.VALUE = GLOBAL_CONSTANTS_V18.ELIGIBILITY_FLAG_SET;
15:21:32 1205  
15:21:32 1206  	 IF var_is_for_redemption > 0 THEN
15:21:32 1207  	   RAISE CAN_NOT_PURCHASE_GC_FOR_RDMPN;
15:21:32 1208  	 END IF;
15:21:32 1209  
15:21:32 1210  	 -- Check that transaction with given id do not exists
15:21:32 1211  	 SELECT
15:21:32 1212  	   COUNT(*) into temp_transaction_id_count
15:21:32 1213  	 FROM
15:21:32 1214  	   TRANSACTION
15:21:32 1215  	 WHERE
15:21:32 1216  	   TRANSACTION.ID = in_transaction_id;
15:21:32 1217  
15:21:32 1218  	 IF temp_transaction_id_count > 0 THEN
15:21:32 1219  	   RAISE TRANSACTION_EXISTS;
15:21:32 1220  	 END IF;
15:21:32 1221  
15:21:32 1222  	 -- Create new invoice
15:21:32 1223  	 BEGIN
15:21:32 1224  	   PROCS_INVOICE_V18.CREATE_INVOICE(
15:21:32 1225  	     in_invoice_status => GLOBAL_STATUSES_V18.INVOICE_OPEN,
15:21:32 1226  	     in_created_by     => in_created_by,
15:21:32 1227  	     in_tax_exempt_id  => var_account_tax_exempt_id,
15:21:32 1228  	     out_invoice_id    => var_new_invoice_id
15:21:32 1229  	   );
15:21:32 1230  	   EXCEPTION
15:21:32 1231  	     WHEN OTHERS THEN
15:21:32 1232  	       EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1233  	       RAISE CAN_NOT_CREATE_INVOICE;
15:21:32 1234  	 END;
15:21:32 1235  
15:21:32 1236  	 -- Add line items for new invoice
15:21:32 1237  	 BEGIN
15:21:32 1238  	   FOR f_offer_data IN (
15:21:32 1239  	     SELECT
15:21:32 1240  	       OFFER_ID,
15:21:32 1241  	       NUM_RECURRENCES
15:21:32 1242  	     FROM
15:21:32 1243  	       OFFER_OFFER_CHAIN
15:21:32 1244  	     WHERE
15:21:32 1245  	       OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_id
15:21:32 1246  	   )
15:21:32 1247  	   LOOP
15:21:32 1248  	     IF f_offer_data.NUM_RECURRENCES < 1 THEN
15:21:32 1249  	       RAISE OFFER_REC_NUM_LESS_THAN_ONE;
15:21:32 1250  	     END IF;
15:21:32 1251  	     FOR i_offer_recurrences_iterator IN 1..f_offer_data.NUM_RECURRENCES
15:21:32 1252  	     LOOP
15:21:32 1253  	       PROCS_LINE_ITEMS_V18.ADD_LINE_ITEMS(
15:21:32 1254  		 in_invoice_id => var_new_invoice_id,
15:21:32 1255  		 in_offer_id   => f_offer_data.OFFER_ID,
15:21:32 1256  		 in_created_by => in_created_by
15:21:32 1257  	       );
15:21:32 1258  	     END LOOP;
15:21:32 1259  	   END LOOP;
15:21:32 1260  
15:21:32 1261  	   EXCEPTION
15:21:32 1262  	     WHEN OTHERS THEN
15:21:32 1263  	       EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1264  	       RAISE CAN_NOT_CREATE_LINE_ITEMS;
15:21:32 1265  	 END;
15:21:32 1266  
15:21:32 1267  	 -- Calculate new invoice amount
15:21:32 1268  	 BEGIN
15:21:32 1269  	   PROCS_INVOICE_V18.CALCULATE_INVOICE_AMOUNT(var_new_invoice_id, var_invoice_amount);
15:21:32 1270  	   EXCEPTION
15:21:32 1271  	     WHEN OTHERS THEN
15:21:32 1272  	       EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1273  	       RAISE CAN_NOT_CALC_INVOICE_AMOUNT;
15:21:32 1274  	 END;
15:21:32 1275  
15:21:32 1276  	 IF var_invoice_amount > 0
15:21:32 1277  	   AND in_instrument_type_id = GLOBAL_ENUMS_V18.INSTRUMENT_ZCI_INSTRUMENT THEN
15:21:32 1278  	   RAISE CAN_NOT_USE_FCINSTR;
15:21:32 1279  	 END IF;
15:21:32 1280  
15:21:32 1281  	 -- If invoice amount iz 0 then we need to set status for this invoice to PROCCESSED
15:21:32 1282  	 IF var_invoice_amount = 0 THEN
15:21:32 1283  	   PROCS_INVOICE_CRU_V18.UPDATE_INVOICE(
15:21:32 1284  	     in_invoice_id		    => var_new_invoice_id,
15:21:32 1285  	     in_updated_by		    => in_created_by,
15:21:32 1286  	     in_invoice_status_id	    => GLOBAL_STATUSES_V18.INVOICE_CLOSED
15:21:32 1287  	   );
15:21:32 1288  	 END IF;
15:21:32 1289  
15:21:32 1290  	 IF var_invoice_amount > 0 THEN
15:21:32 1291  	   -- Create transaction
15:21:32 1292  	   BEGIN
15:21:32 1293  	     PROCS_TRANSACTION_V18.CREATE_TRANSACTION(
15:21:32 1294  	       in_transaction_id  => in_transaction_id,
15:21:32 1295  	       in_status_id	  => GLOBAL_STATUSES_V18.TRANSACTION_PENDING,
15:21:32 1296  	       in_amount	  => var_invoice_amount,
15:21:32 1297  	       in_created_by	  => in_created_by,
15:21:32 1298  	       in_order_id	  => in_order_id,
15:21:32 1299  	       out_transaction_id => var_transaction_id
15:21:32 1300  	     );
15:21:32 1301  	     EXCEPTION
15:21:32 1302  	       WHEN OTHERS THEN
15:21:32 1303  		 EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1304  		 RAISE CAN_NOT_CREATE_TRANSACTION;
15:21:32 1305  	   END;
15:21:32 1306  
15:21:32 1307  	   -- Create charge
15:21:32 1308  	   BEGIN
15:21:32 1309  	     PROCS_CHARGE_V18.CREATE_CHARGE(
15:21:32 1310  	       in_invoice_id	     => var_new_invoice_id,
15:21:32 1311  	       in_transaction_id     => var_transaction_id,
15:21:32 1312  	       in_instrument_type_id => in_instrument_type_id,
15:21:32 1313  	       in_instrument_id      => in_instrument_id,
15:21:32 1314  	       in_charge_amount      => var_invoice_amount,
15:21:32 1315  	       in_created_by	     => in_created_by,
15:21:32 1316  	       in_charge_status_id   => GLOBAL_STATUSES_V18.CHARGE_OPENED,
15:21:32 1317  	       out_charge_id	     => var_new_charge_id
15:21:32 1318  	     );
15:21:32 1319  	     EXCEPTION
15:21:32 1320  	       WHEN OTHERS THEN
15:21:32 1321  		 EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1322  		 RAISE CAN_NOT_CREATE_CHARGE;
15:21:32 1323  	   END;
15:21:32 1324  	 END IF;
15:21:32 1325  
15:21:32 1326  	 -- Create new row in GIFT_CERTIFICATE table
15:21:32 1327  	 PROCS_FIN_INSTRUMENTS_CRU_V18.CREATE_GIFT_CERTIFICATE(
15:21:32 1328  	   out_gift_certificate_id	 => var_gift_cert_id,
15:21:32 1329  	   in_purchaser_group_id	 => in_group_id,
15:21:32 1330  	   in_purchaser_invoice_id	 => var_new_invoice_id,
15:21:32 1331  	   in_offer_chain_id		 => in_offer_chain_id,
15:21:32 1332  	   in_expiration_date		 => in_expiration_date,
15:21:32 1333  	   in_purchase_date		 => SYSDATE,
15:21:32 1334  	   in_gift_certificate_status_id => GLOBAL_STATUSES_V18.GIFT_CERTIFICATE_ACTIVE,
15:21:32 1335  	   in_code			 => in_gift_certificate_code,
15:21:32 1336  	   in_created_by		 => in_created_by,
15:21:32 1337  	   in_recipient_name		 => in_recipient_name,
15:21:32 1338  	   in_gift_message		 => in_gift_message,
15:21:32 1339  	   in_recipient_email		 => in_recipient_email,
15:21:32 1340  	   in_sender_email		 => in_sender_email,
15:21:32 1341  	   in_sender_name		 => in_sender_name
15:21:32 1342  	 );
15:21:32 1343  
15:21:32 1344  EXCEPTION
15:21:32 1345  WHEN CAN_NOT_USE_FCINSTR THEN
15:21:32 1346  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 1347  	   SPROC_NAME, 'Could not use "free charge instrument" for non-zero invoice');
15:21:32 1348  WHEN BAD_OFFER_CHAIN_STATUS THEN
15:21:32 1349  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 1350  	   SPROC_NAME, 'Offer chain is not active');
15:21:32 1351  WHEN CAN_NOT_CALCULATE_OCH_AMOUNT THEN
15:21:32 1352  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1353  	   SPROC_NAME, 'Could not calculate offer chain amount', EXCEPTION_MESSAGE);
15:21:32 1354  WHEN BAD_CREDIT_CARD_ID THEN
15:21:32 1355  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1356  	   SPROC_NAME, 'Bad credit card id');
15:21:32 1357  WHEN BAD_PAYPAL_ID THEN
15:21:32 1358  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1359  	   SPROC_NAME, 'Bad paypal id');
15:21:32 1360  WHEN BAD_INSTRUMENT_TYPE THEN
15:21:32 1361  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 1362  	   SPROC_NAME, 'Bad instrument type');
15:21:32 1363  WHEN GC_CODE_ALREADY_EXISTS THEN
15:21:32 1364  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.DUPLICATE_ERROR,
15:21:32 1365  	   SPROC_NAME, 'Gift certificate with same code already exists');
15:21:32 1366  WHEN OCH_IS_NOT_GIFT_CERTIFICATE THEN
15:21:32 1367  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 1368  	   SPROC_NAME, 'This offer chain can not be used for gift certificate');
15:21:32 1369  WHEN CAN_NOT_PURCHASE_GC_FOR_RDMPN THEN
15:21:32 1370  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 1371  	   SPROC_NAME, 'This offer chain can not be purchased for gift certificate since it is for redemption');
15:21:32 1372  WHEN TRANSACTION_EXISTS THEN
15:21:32 1373  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.DUPLICATE_ERROR,
15:21:32 1374  	   SPROC_NAME, 'Transaction with given id already exists');
15:21:32 1375  WHEN CAN_NOT_CREATE_INVOICE THEN
15:21:32 1376  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1377  	   SPROC_NAME, 'Could not create new invoice', EXCEPTION_MESSAGE);
15:21:32 1378  WHEN CAN_NOT_CREATE_TRANSACTION THEN
15:21:32 1379  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1380  	   SPROC_NAME, 'Could not create transaction', EXCEPTION_MESSAGE);
15:21:32 1381  WHEN CAN_NOT_CREATE_CHARGE THEN
15:21:32 1382  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1383  	   SPROC_NAME, 'Could not create charge', EXCEPTION_MESSAGE);
15:21:32 1384  WHEN CAN_NOT_CREATE_LINE_ITEMS THEN
15:21:32 1385  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1386  	   SPROC_NAME, 'Could not create line items', EXCEPTION_MESSAGE);
15:21:32 1387  WHEN BAD_GROUP_ID THEN
15:21:32 1388  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1389  	   SPROC_NAME, 'No such group id');
15:21:32 1390  WHEN BAD_OFFER_CHAIN_ID THEN
15:21:32 1391  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1392  	   SPROC_NAME, 'No such offer chain');
15:21:32 1393  WHEN OFFER_REC_NUM_LESS_THAN_ONE THEN
15:21:32 1394  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1395  	   SPROC_NAME, 'Some offer has recurrences number less than 1');
15:21:32 1396  WHEN CAN_NOT_CALC_INVOICE_AMOUNT THEN
15:21:32 1397  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1398  	   SPROC_NAME, 'COuold not calculate amount for new invoice', EXCEPTION_MESSAGE);
15:21:32 1399  WHEN OTHERS THEN
15:21:32 1400  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1401  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1402  END PURCHASE_GIFT_CERTIFICATE;
15:21:32 1403  
15:21:32 1404  /******************************************************************************/
15:21:32 1405  
15:21:32 1406  PROCEDURE REDEEM_GIFT_CERTIFICATE (
15:21:32 1407  	 in_group_id			 IN NUMBER,
15:21:32 1408  	 in_gift_certificate_code	 IN VARCHAR2,
15:21:32 1409  	 in_created_by			 IN VARCHAR2,
15:21:32 1410  	 in_redeemer_address_id 	 IN NUMBER,
15:21:32 1411  	 in_fin_instrument_id		 IN NUMBER,
15:21:32 1412  	 in_fin_instrument_type_id	 IN NUMBER,
15:21:32 1413  	 in_redemption_offer_chain_id	 IN NUMBER,
15:21:32 1414  	 out_subscription_id		 OUT NUMBER,
15:21:32 1415  	 out_license_id 		 OUT NUMBER
15:21:32 1416  ) AS
15:21:32 1417  SPROC_NAME	       CONSTANT VARCHAR2(23) := 'REDEEM_GIFT_CERTIFICATE';
15:21:32 1418  -- VARIABLES
15:21:32 1419  var_gift_certificate_id NUMBER;
15:21:32 1420  -- norlov: #38151 var_offer_chain_id replaced by var_purchased_oc_id and var_oc_id_to_redeem
15:21:32 1421  var_purchased_oc_id     NUMBER;
15:21:32 1422  var_oc_id_to_redeem     NUMBER := in_redemption_offer_chain_id;
15:21:32 1423  var_offer_duration      VARCHAR2(30);
15:21:32 1424  var_invoice_id	       NUMBER;
15:21:32 1425  var_succ_purch_attempts_num NUMBER;
15:21:32 1426  var_subscription_id     NUMBER;
15:21:32 1427  var_license_id	       NUMBER;
15:21:32 1428  var_account_id	       NUMBER;
15:21:32 1429  var_gc_status_id        NUMBER;
15:21:32 1430  var_gc_charges_amount   NUMBER;
15:21:32 1431  var_gc_expiration_date  DATE;
15:21:32 1432  var_gc_redeemer_group_id NUMBER;
15:21:32 1433  var_gc_purchase_invoice_id NUMBER;
15:21:32 1434  var_gc_purchase_inv_status_id NUMBER;
15:21:32 1435  var_offer_index		     NUMBER;
15:21:32 1436  var_purchaser_group_id	     NUMBER;
15:21:32 1437  temp_license_id		     NUMBER;
15:21:32 1438  var_same_offer_chains_num     NUMBER;
15:21:32 1439  var_max_concurrent_subscrs    NUMBER;
15:21:32 1440  var_account_tax_exempt_id     VARCHAR2(255);
15:21:32 1441  var_fin_instrument_type_id    NUMBER := in_fin_instrument_type_id;
15:21:32 1442  var_fin_instrument_id	     NUMBER := in_fin_instrument_id;
15:21:32 1443  var_first_offer_id	  NUMBER;
15:21:32 1444  var_date 	     DATE := SYSDATE;
15:21:32 1445  
15:21:32 1446  var_offers SYS_REFCURSOR;
15:21:32 1447  
15:21:32 1448  -- EXCEPTIONS
15:21:32 1449  BAD_GIFT_CERTIFICATE_CODE      EXCEPTION;
15:21:32 1450  BAD_GROUP_ID		      EXCEPTION;
15:21:32 1451  CAN_NOT_CREATE_LICENSE	      EXCEPTION;
15:21:32 1452  GIFT_CERT_IS_FINALIZED	      EXCEPTION;
15:21:32 1453  GIFT_CERT_IS_REFUNDED	      EXCEPTION;
15:21:32 1454  CAN_NOT_UPDATE_CERTIFICATE     EXCEPTION;
15:21:32 1455  GIFT_CERTIFICATE_EXPIRED       EXCEPTION;
15:21:32 1456  GIFT_CERTIFICATE_REDEEMED      EXCEPTION;
15:21:32 1457  USER_ALREADY_SUBSCRIBED_TO_PRD EXCEPTION;
15:21:32 1458  LIMIT_REACHED		      EXCEPTION;
15:21:32 1459  GC_PURCHASE_INVOICE_NOT_CLOSED EXCEPTION;
15:21:32 1460  PURCHASE_INVOICES_NOT_PAID     EXCEPTION;
15:21:32 1461  OC_TO_REDEEM_NOT_FOUND	      EXCEPTION;
15:21:32 1462  CAN_NOT_GET_FIRST_OFFER_CHAIN  EXCEPTION;
15:21:32 1463  EXCEPTION_MESSAGE	      VARCHAR2(1024);
15:21:32 1464  BEGIN
15:21:32 1465  
15:21:32 1466  	 -- Get account id
15:21:32 1467  	 BEGIN
15:21:32 1468  	   SELECT
15:21:32 1469  	     ACCOUNT.ID,
15:21:32 1470  	     ACCOUNT.TAX_EXEMPT_ID
15:21:32 1471  	     into
15:21:32 1472  	     var_account_id,
15:21:32 1473  	     var_account_tax_exempt_id
15:21:32 1474  	   FROM
15:21:32 1475  	     ACCOUNT
15:21:32 1476  	   WHERE
15:21:32 1477  	     ACCOUNT.GROUP_ID = in_group_id
15:21:32 1478  	     AND ROWNUM <= 1;
15:21:32 1479  
15:21:32 1480  	   EXCEPTION
15:21:32 1481  	   WHEN NO_DATA_FOUND THEN
15:21:32 1482  	     RAISE BAD_GROUP_ID;
15:21:32 1483  	 END;
15:21:32 1484  
15:21:32 1485  	 -- Get gift certificate data
15:21:32 1486  	 BEGIN
15:21:32 1487  	   SELECT
15:21:32 1488  	     GIFT_CERTIFICATE.ID,
15:21:32 1489  	     GIFT_CERTIFICATE.OFFER_CHAIN_ID,
15:21:32 1490  	     GIFT_CERTIFICATE.GIFT_CERTIFICATE_STATUS_ID,
15:21:32 1491  	     GIFT_CERTIFICATE.PURCHASER_GROUP_ID,
15:21:32 1492  	     GIFT_CERTIFICATE.EXPIRATION_DATE,
15:21:32 1493  	     GIFT_CERTIFICATE.REDEEMER_GROUP_ID,
15:21:32 1494  	     GIFT_CERTIFICATE.PURCHASE_INVOICE_ID
15:21:32 1495  	     into
15:21:32 1496  	     var_gift_certificate_id,
15:21:32 1497  	     var_purchased_oc_id,
15:21:32 1498  	     var_gc_status_id,
15:21:32 1499  	     var_purchaser_group_id,
15:21:32 1500  	     var_gc_expiration_date,
15:21:32 1501  	     var_gc_redeemer_group_id,
15:21:32 1502  	     var_gc_purchase_invoice_id
15:21:32 1503  	   FROM
15:21:32 1504  	     GIFT_CERTIFICATE
15:21:32 1505  	   WHERE
15:21:32 1506  	     GIFT_CERTIFICATE.CODE = in_gift_certificate_code
15:21:32 1507  	     AND ROWNUM <= 1;
15:21:32 1508  
15:21:32 1509  	   EXCEPTION
15:21:32 1510  	   WHEN NO_DATA_FOUND THEN
15:21:32 1511  	     RAISE BAD_GIFT_CERTIFICATE_CODE;
15:21:32 1512  	 END;
15:21:32 1513  
15:21:32 1514  	 -- get redemption oc id from meta data if it wasn't passed in, parsing will fail for gcs with multiple redemption offer chains,
15:21:32 1515  	 -- but in that case a redemption offer chain id should always be passed in
15:21:32 1516  	 IF var_oc_id_to_redeem IS NULL THEN
15:21:32 1517  	   BEGIN
15:21:32 1518  	     SELECT
15:21:32 1519  	       to_number(OFFER_CHAIN_META_DATA.VALUE)
15:21:32 1520  	       into
15:21:32 1521  	       var_oc_id_to_redeem
15:21:32 1522  	     FROM
15:21:32 1523  	       OFFER_CHAIN_META_DATA
15:21:32 1524  	     WHERE
15:21:32 1525  	       OFFER_CHAIN_META_DATA.OFFER_CHAIN_ID = var_purchased_oc_id
15:21:32 1526  	       AND OFFER_CHAIN_META_DATA.NAME = GLOBAL_CONSTANTS_V18.REDEMPTION_OC_ID
15:21:32 1527  	       AND ROWNUM = 1;
15:21:32 1528  -- requested by ticket so (but above is correct for the actual migrated data):
15:21:32 1529  --  SELECT
15:21:32 1530  --      OFFER_CHAIN.ID
15:21:32 1531  --      into
15:21:32 1532  --      var_oc_id_to_redeem
15:21:32 1533  --    FROM
15:21:32 1534  --      OFFER_CHAIN
15:21:32 1535  --	 INNER JOIN ELIGIBILITY ON OFFER_CHAIN.ID = ELIGIBILITY.OFFER_CHAIN_ID
15:21:32 1536  --	 INNER JOIN OFFER_CHAIN_META_DATA ON OFFER_CHAIN.ID = OFFER_CHAIN_META_DATA.OFFER_CHAIN_ID
15:21:32 1537  --    WHERE
15:21:32 1538  --      ELIGIBILITY.OFFER_CHAIN_ID = OFFER_CHAIN.ID
15:21:32 1539  --      AND ELIGIBILITY.NAME = GLOBAL_CONSTANTS_V18.GIFT_CERTIFICATE_REQUIRED
15:21:32 1540  --      AND ELIGIBILITY.VALUE = GLOBAL_CONSTANTS_V18.ELIGIBILITY_FLAG_SET
15:21:32 1541  --      AND OFFER_CHAIN_META_DATA.OFFER_CHAIN_ID = OFFER_CHAIN.ID
15:21:32 1542  --      AND OFFER_CHAIN_META_DATA.NAME = GLOBAL_CONSTANTS_V18.REDEMPTION_OC_ID
15:21:32 1543  --      AND to_number(OFFER_CHAIN_META_DATA.VALUE) = var_purchased_oc_id
15:21:32 1544  --      AND ROWNUM = 1;
15:21:32 1545  
15:21:32 1546  	     EXCEPTION
15:21:32 1547  	     WHEN NO_DATA_FOUND THEN
15:21:32 1548  	       RAISE OC_TO_REDEEM_NOT_FOUND;
15:21:32 1549  	   END;
15:21:32 1550  	 END IF;
15:21:32 1551  
15:21:32 1552  	 -- Check that purchase invoice for this GC was closed
15:21:32 1553  	 SELECT
15:21:32 1554  	   INVOICE.INVOICE_STATUS_ID into var_gc_purchase_inv_status_id
15:21:32 1555  	 FROM
15:21:32 1556  	   INVOICE
15:21:32 1557  	 WHERE
15:21:32 1558  	   INVOICE.ID = var_gc_purchase_invoice_id;
15:21:32 1559  
15:21:32 1560  	 IF var_gc_purchase_inv_status_id != GLOBAL_STATUSES_V18.INVOICE_CLOSED THEN
15:21:32 1561  	   RAISE GC_PURCHASE_INVOICE_NOT_CLOSED;
15:21:32 1562  	 END IF;
15:21:32 1563  
15:21:32 1564  	 -- Check that this invoice was successfully processed by billing
15:21:32 1565  	 SELECT
15:21:32 1566  	   COUNT(1) into var_succ_purch_attempts_num
15:21:32 1567  	 FROM
15:21:32 1568  	   TRANSACTION_ATTEMPT TA
15:21:32 1569  	   INNER JOIN TRANSACTION T ON T.ID = TA.TRANSACTION_ID
15:21:32 1570  	   INNER JOIN CHARGE CH ON CH.TRANSACTION_ID = T.ID
15:21:32 1571  	 WHERE
15:21:32 1572  	   CH.INVOICE_ID = var_gc_purchase_invoice_id
15:21:32 1573  	   AND TA.TRANSACTION_ATTEMPT_STATUS_ID = GLOBAL_STATUSES_V18.TRANS_ATTEMPT_SUCCESS;
15:21:32 1574  
15:21:32 1575  	 IF var_succ_purch_attempts_num = 0 THEN
15:21:32 1576  	   SELECT
15:21:32 1577  	     COUNT(1) into var_succ_purch_attempts_num
15:21:32 1578  	   FROM
15:21:32 1579  	     DUAL
15:21:32 1580  	   WHERE
15:21:32 1581  	     PROCS_INVOICE_V18.F_CALCULATE_INVOICE_AMOUNT(var_gc_purchase_invoice_id) = 0;
15:21:32 1582  	 END IF;
15:21:32 1583  
15:21:32 1584  	 IF var_succ_purch_attempts_num = 0 THEN
15:21:32 1585  	   RAISE PURCHASE_INVOICES_NOT_PAID;
15:21:32 1586  	 END IF;
15:21:32 1587  
15:21:32 1588  	 -- Check limit for gc's offer chain
15:21:32 1589  	 SELECT
15:21:32 1590  	   COUNT(*) into var_same_offer_chains_num
15:21:32 1591  	 FROM
15:21:32 1592  	   SUBSCRIPTION
15:21:32 1593  	 WHERE
15:21:32 1594  	   SUBSCRIPTION.ACCOUNT_ID = var_account_id
15:21:32 1595  	   AND SUBSCRIPTION.OFFER_CHAIN_ID = var_oc_id_to_redeem
15:21:32 1596  	   AND (
15:21:32 1597  	     SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE
15:21:32 1598  	     OR SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_IN_GRACE_PERIOD);
15:21:32 1599  IF var_same_offer_chains_num = 0 THEN
15:21:32 1600  	   -- if user does not have any active existing subscriptions to the offer chain
15:21:32 1601  	   -- and if product from the offer chain is already owned from another offer chain
15:21:32 1602  	   -- then deny purchase
15:21:32 1603  	   FOR f_account_offer_chains IN (
15:21:32 1604  	     SELECT DISTINCT
15:21:32 1605  	       OFFER_CHAIN_ID
15:21:32 1606  	     FROM
15:21:32 1607  	       SUBSCRIPTION
15:21:32 1608  	     WHERE
15:21:32 1609  	       ACCOUNT_ID = var_account_id
15:21:32 1610  	       AND (
15:21:32 1611  		 SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE
15:21:32 1612  		 OR SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_SUSPENDED
15:21:32 1613  		 OR SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_IN_GRACE_PERIOD)
15:21:32 1614  	   )
15:21:32 1615  	   LOOP
15:21:32 1616  	     IF PROCS_OFFER_CHAIN_V18.CHECK_FOR_SAME_PRODUCTS(var_oc_id_to_redeem, f_account_offer_chains.OFFER_CHAIN_ID) = GLOBAL_CONSTANTS_V18.TRUE THEN
15:21:32 1617  	       RAISE USER_ALREADY_SUBSCRIBED_TO_PRD;
15:21:32 1618  	     END IF;
15:21:32 1619  	   END LOOP;
15:21:32 1620  	 ELSE
15:21:32 1621  
15:21:32 1622  	   -- if user have any active existing subscriptions to the offer chain
15:21:32 1623  	   -- and if MAX_CONCURRENT_SUBS <= [user's subscription count for the offer chain]
15:21:32 1624  	   -- then deny purchase
15:21:32 1625  	   var_max_concurrent_subscrs := PROCS_OFFER_CHAIN_V18.GET_OFFER_CHAIN_MAX_CONC_SUBSC(var_oc_id_to_redeem);
15:21:32 1626  	   IF var_max_concurrent_subscrs != GLOBAL_CONSTANTS_V18.INFINITY
15:21:32 1627  	     AND var_max_concurrent_subscrs <= var_same_offer_chains_num THEN
15:21:32 1628  	     RAISE LIMIT_REACHED;
15:21:32 1629  	   END IF;
15:21:32 1630  	 END IF;
15:21:32 1631  -- norlov: END OF TODO
15:21:32 1632  
15:21:32 1633  
15:21:32 1634  	 IF var_gc_redeemer_group_id IS NOT NULL THEN
15:21:32 1635  	   RAISE GIFT_CERTIFICATE_REDEEMED;
15:21:32 1636  	 END IF;
15:21:32 1637  
15:21:32 1638  	 IF var_gc_expiration_date < sysdate THEN
15:21:32 1639  	   RAISE GIFT_CERTIFICATE_EXPIRED;
15:21:32 1640  	 END IF;
15:21:32 1641  
15:21:32 1642  	  IF var_gc_status_id = GLOBAL_STATUSES_V18.GIFT_CERTIFICATE_REFUNDED THEN
15:21:32 1643  	   RAISE GIFT_CERT_IS_REFUNDED;
15:21:32 1644  	 END IF;
15:21:32 1645  
15:21:32 1646  	 IF var_gc_status_id = GLOBAL_STATUSES_V18.GIFT_CERTIFICATE_FINALIZED THEN
15:21:32 1647  	   RAISE GIFT_CERT_IS_FINALIZED;
15:21:32 1648  	 END IF;
15:21:32 1649  
15:21:32 1650  	 -- Check that user did not subscribed to same product already
15:21:32 1651  	 -- norlov: get rid of this since there is already the check?
15:21:32 1652  	 FOR f_user_offer_chain IN (
15:21:32 1653  	   SELECT DISTINCT
15:21:32 1654  	     OFFER_CHAIN_ID
15:21:32 1655  	   FROM
15:21:32 1656  	     SUBSCRIPTION
15:21:32 1657  	   WHERE
15:21:32 1658  	     ACCOUNT_ID=var_account_id
15:21:32 1659  	     AND (
15:21:32 1660  	       SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE
15:21:32 1661  	       OR SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_SUSPENDED
15:21:32 1662  	       OR SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_IN_GRACE_PERIOD)
15:21:32 1663  	 )
15:21:32 1664  	 LOOP
15:21:32 1665  	   IF PROCS_OFFER_CHAIN_V18.CHECK_FOR_SAME_PRODUCTS(var_oc_id_to_redeem, f_user_offer_chain.OFFER_CHAIN_ID)=GLOBAL_CONSTANTS_V18.TRUE THEN
15:21:32 1666  	     RAISE USER_ALREADY_SUBSCRIBED_TO_PRD;
15:21:32 1667  	   END IF;
15:21:32 1668  	 END LOOP;
15:21:32 1669  
15:21:32 1670  	 -- Check for gift certificate amount
15:21:32 1671  	 SELECT
15:21:32 1672  	   SUM(CHARGE.CHARGE_AMOUNT) into var_gc_charges_amount
15:21:32 1673  	 FROM
15:21:32 1674  	   CHARGE
15:21:32 1675  	 WHERE
15:21:32 1676  	   CHARGE.INSTRUMENT_ID = var_gift_certificate_id
15:21:32 1677  	   AND CHARGE.INSTRUMENT_TYPE_ID = GLOBAL_ENUMS_V18.INSTRUMENT_GIFT_CERTIFICATE;
15:21:32 1678  
15:21:32 1679  	 -- Create new invoice
15:21:32 1680  	 PROCS_INVOICE_V18.CREATE_INVOICE(
15:21:32 1681  	   out_invoice_id    => var_invoice_id,
15:21:32 1682  	   in_invoice_status => GLOBAL_STATUSES_V18.INVOICE_CLOSED,
15:21:32 1683  	   in_tax_exempt_id  => var_account_tax_exempt_id,
15:21:32 1684  	   in_created_by     => in_created_by
15:21:32 1685  	 );
15:21:32 1686  
15:21:32 1687  	 -- If a financial instrument wasn't passed in, use the gift certificate id
15:21:32 1688  	 -- Real financial instrument is required for upsell/till forbid gift subscriptions
15:21:32 1689  	 IF var_fin_instrument_id is null THEN
15:21:32 1690  	   var_fin_instrument_id := var_gift_certificate_id;
15:21:32 1691  	   var_fin_instrument_type_id := GLOBAL_ENUMS_V18.INSTRUMENT_GIFT_CERTIFICATE;
15:21:32 1692  	 END IF;
15:21:32 1693  
15:21:32 1694  	 -- Insert new row into subscription table
15:21:32 1695  	 PROCS_SUBSCRIPTION_CRU_V18.CREATE_SUBSCRIPTION(
15:21:32 1696  	   out_subscription_id	     => var_subscription_id,
15:21:32 1697  	   in_account_id	     => var_account_id,
15:21:32 1698  	   in_purchase_date	     => var_date,
15:21:32 1699  	   in_offer_chain_id	     => var_oc_id_to_redeem,
15:21:32 1700  	   in_created_by	     => in_created_by,
15:21:32 1701  	   in_instrument_type_id     => var_fin_instrument_type_id,
15:21:32 1702  	   in_instrument_id	     => var_fin_instrument_id,
15:21:32 1703  	   in_subscription_status_id => GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE
15:21:32 1704  	 );
15:21:32 1705  
15:21:32 1706  	 out_subscription_id := var_subscription_id;
15:21:32 1707  
15:21:32 1708  	 BEGIN
15:21:32 1709  	   PROCS_OFFER_CHAIN_V18.GET_FIRST_OFFER(var_oc_id_to_redeem, var_first_offer_id);
15:21:32 1710  	   EXCEPTION
15:21:32 1711  	     WHEN OTHERS THEN
15:21:32 1712  	       EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1713  	       RAISE CAN_NOT_GET_FIRST_OFFER_CHAIN;
15:21:32 1714  	 END;
15:21:32 1715  
15:21:32 1716  	 BEGIN
15:21:32 1717  	   PROCS_LICENSE_V18.CREATE_LICENSE (
15:21:32 1718  	     out_license_id		 => out_license_id,
15:21:32 1719  	     in_status_id		 => GLOBAL_STATUSES_V18.LICENSE_ACTIVE,
15:21:32 1720  	     in_needs_entitlements	 => GLOBAL_CONSTANTS_V18.TRUE,
15:21:32 1721  	     in_start_date		 => var_date,
15:21:32 1722  	     in_offer_id		 => var_first_offer_id,
15:21:32 1723  	     in_subscription_id 	 => var_subscription_id,
15:21:32 1724  	     in_invoice_id		 => var_invoice_id,
15:21:32 1725  	     in_created_by		 => in_created_by,
15:21:32 1726  	     in_end_date		 => NULL, -- Will be calculated automatically
15:21:32 1727  	     in_is_extension		 => GLOBAL_CONSTANTS_V18.FALSE,
15:21:32 1728  	     in_current_offer_index	 => PROCS_OFFER_CHAIN_V18.GET_FIRST_OFFER_INDEX(var_oc_id_to_redeem),
15:21:32 1729  	     in_current_offer_recurr_num => 1
15:21:32 1730  	   );
15:21:32 1731  
15:21:32 1732  	   EXCEPTION
15:21:32 1733  	     WHEN OTHERS THEN
15:21:32 1734  	       EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1735  	       RAISE CAN_NOT_CREATE_LICENSE;
15:21:32 1736  	 END;
15:21:32 1737  
15:21:32 1738  	 -- Update original gift certificate
15:21:32 1739  	 BEGIN
15:21:32 1740  	   PROCS_FIN_INSTRUMENTS_CRU_V18.UPDATE_GIFT_CERTIFICATE(
15:21:32 1741  	     in_gift_certificate_id	   => var_gift_certificate_id,
15:21:32 1742  	     in_updated_by		   => in_created_by,
15:21:32 1743  	     in_redeemer_group_id	   => in_group_id,
15:21:32 1744  	     in_finalized_invoice_id	   => var_invoice_id,
15:21:32 1745  	     in_redemption_date 	   => var_date,
15:21:32 1746  	     in_redeemer_address_id	   => in_redeemer_address_id,
15:21:32 1747  	     in_gift_certificate_status_id => GLOBAL_STATUSES_V18.GIFT_CERTIFICATE_FINALIZED
15:21:32 1748  	   );
15:21:32 1749  	   EXCEPTION
15:21:32 1750  	     WHEN OTHERS THEN
15:21:32 1751  	       EXCEPTION_MESSAGE := SQLERRM;
15:21:32 1752  	       RAISE CAN_NOT_UPDATE_CERTIFICATE;
15:21:32 1753  	 END;
15:21:32 1754  
15:21:32 1755  EXCEPTION
15:21:32 1756  WHEN LIMIT_REACHED THEN
15:21:32 1757  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.CONFLICT_ERROR,
15:21:32 1758  	   SPROC_NAME, 'Limit reached for given offer chain');
15:21:32 1759  WHEN USER_ALREADY_SUBSCRIBED_TO_PRD THEN
15:21:32 1760  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.CONFLICT_ERROR,
15:21:32 1761  	   SPROC_NAME, 'User already subscribed to some product in given gift certificate');
15:21:32 1762  WHEN GIFT_CERTIFICATE_REDEEMED THEN
15:21:32 1763  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 1764  	   SPROC_NAME, 'Gift certificate already redeemed');
15:21:32 1765  WHEN GIFT_CERTIFICATE_EXPIRED THEN
15:21:32 1766  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 1767  	   SPROC_NAME, 'Gift certificate expired');
15:21:32 1768  WHEN GIFT_CERT_IS_FINALIZED THEN
15:21:32 1769  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 1770  	   SPROC_NAME, 'Gift certificate is finalized');
15:21:32 1771  WHEN GIFT_CERT_IS_REFUNDED THEN
15:21:32 1772  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 1773  	   SPROC_NAME, 'Gift certificate has been refunded');
15:21:32 1774  WHEN BAD_GROUP_ID THEN
15:21:32 1775  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1776  	   SPROC_NAME, 'No such account with given group id');
15:21:32 1777  WHEN OC_TO_REDEEM_NOT_FOUND THEN
15:21:32 1778  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1779  	   SPROC_NAME, 'Offer chain to redeem not found');
15:21:32 1780  WHEN BAD_GIFT_CERTIFICATE_CODE THEN
15:21:32 1781  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1782  	   SPROC_NAME, 'No such gift certificate code');
15:21:32 1783  WHEN CAN_NOT_CREATE_LICENSE THEN
15:21:32 1784  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1785  	   SPROC_NAME, 'Could not create new license', EXCEPTION_MESSAGE);
15:21:32 1786  WHEN CAN_NOT_UPDATE_CERTIFICATE THEN
15:21:32 1787  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 1788  	   SPROC_NAME, 'Could not update gift certificate', EXCEPTION_MESSAGE);
15:21:32 1789  WHEN GC_PURCHASE_INVOICE_NOT_CLOSED THEN
15:21:32 1790  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 1791  	   SPROC_NAME, 'Purchase invoice is not closed');
15:21:32 1792  WHEN PURCHASE_INVOICES_NOT_PAID THEN
15:21:32 1793  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 1794  	   SPROC_NAME, 'Purchase invoice is not successfully processed by billing');
15:21:32 1795  WHEN OTHERS THEN
15:21:32 1796  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1797  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1798  END;
15:21:32 1799  
15:21:32 1800  /******************************************************************************/
15:21:32 1801  
15:21:32 1802  PROCEDURE GET_GIFT_CERTIFICATE_BY_CODE (
15:21:32 1803  /*
15:21:32 1804  Throws exceptions:
15:21:32 1805  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1806  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 1807  */
15:21:32 1808  	 in_code	IN VARCHAR,
15:21:32 1809  	 out_result_set OUT SYS_REFCURSOR
15:21:32 1810  ) AS
15:21:32 1811  -- VARIABLES
15:21:32 1812  SPROC_NAME		CONSTANT VARCHAR2(28) := 'GET_GIFT_CERTIFICATE_BY_CODE';
15:21:32 1813  temp_gift_certificate_id NUMBER;
15:21:32 1814  -- EXCEPTIONS
15:21:32 1815  BAD_GIFT_CERTIFICATE_CODE EXCEPTION;
15:21:32 1816  BEGIN
15:21:32 1817  
15:21:32 1818  	 BEGIN
15:21:32 1819  	   SELECT
15:21:32 1820  	     GIFT_CERTIFICATE.ID into temp_gift_certificate_id
15:21:32 1821  	   FROM
15:21:32 1822  	     GIFT_CERTIFICATE
15:21:32 1823  	   WHERE
15:21:32 1824  	     GIFT_CERTIFICATE.CODE = in_code;
15:21:32 1825  	   EXCEPTION
15:21:32 1826  	     WHEN NO_DATA_FOUND THEN
15:21:32 1827  	       RAISE BAD_GIFT_CERTIFICATE_CODE;
15:21:32 1828  	 END;
15:21:32 1829  
15:21:32 1830  	 -- Select all gift certificates with given code
15:21:32 1831  	 OPEN out_result_set FOR
15:21:32 1832  	 SELECT
15:21:32 1833  	   gc.EXPIRATION_DATE,
15:21:32 1834  	   ch.name,
15:21:32 1835  	   ch.id,
15:21:32 1836  	   gc.sender_email,
15:21:32 1837  	   gc.sender_name,
15:21:32 1838  	   gc.recipient_email,
15:21:32 1839  	   gc.recipient_name,
15:21:32 1840  	   gc.purchase_date,
15:21:32 1841  	   gc.redemption_date,
15:21:32 1842  	   gc.purchaser_group_id,
15:21:32 1843  	   gc.redeemer_group_id,
15:21:32 1844  	   gc.gift_message,
15:21:32 1845  	   ocmd.value redemption_offer_chain_ids,
15:21:32 1846  	   s.offer_chain_id redeemed_offer_chain_id,
15:21:32 1847  	   gc.recipient_notify_date,
15:21:32 1848  	   gc.gift_certificate_status_id,
15:21:32 1849  	   gc.purchase_invoice_id,
15:21:32 1850  	   gc.finalized_invoice_id
15:21:32 1851  	 FROM
15:21:32 1852  	   GIFT_CERTIFICATE gc
15:21:32 1853  	 INNER JOIN OFFER_CHAIN ch ON ch.id = gc.offer_chain_id
15:21:32 1854  	 INNER JOIN OFFER_CHAIN_META_DATA ocmd ON gc.offer_chain_id = ocmd.offer_chain_id AND ocmd.name = 'redemption offer chain id'
15:21:32 1855  	 LEFT JOIN LICENSE l ON l.invoice_id = gc.finalized_invoice_id
15:21:32 1856  	 LEFT JOIN SUBSCRIPTION s ON l.subscription_id = s.id
15:21:32 1857  	 WHERE
15:21:32 1858  	   gc.code = in_code;
15:21:32 1859  
15:21:32 1860  EXCEPTION
15:21:32 1861  WHEN BAD_GIFT_CERTIFICATE_CODE THEN
15:21:32 1862  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1863  	   SPROC_NAME, 'No such gift certificate');
15:21:32 1864  WHEN OTHERS THEN
15:21:32 1865  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1866  	   SPROC_NAME, 'Unknown Error', SQLERRM);
15:21:32 1867  END;
15:21:32 1868  
15:21:32 1869  /******************************************************************************/
15:21:32 1870  
15:21:32 1871  PROCEDURE GET_GIFT_CERTIFICATE_BY_ID (
15:21:32 1872  /*
15:21:32 1873  Throws exceptions:
15:21:32 1874  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1875  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 1876  */
15:21:32 1877  	 in_gift_certificate_id IN NUMBER,
15:21:32 1878  	 out_result_set 	OUT SYS_REFCURSOR
15:21:32 1879  ) AS
15:21:32 1880  -- VARIABLES
15:21:32 1881  SPROC_NAME		CONSTANT VARCHAR2(26) := 'GET_GIFT_CERTIFICATE_BY_ID';
15:21:32 1882  temp_gift_certificate_id NUMBER;
15:21:32 1883  -- EXCEPTIONS
15:21:32 1884  BAD_GIFT_CERTIFICATE_ID EXCEPTION;
15:21:32 1885  BEGIN
15:21:32 1886  
15:21:32 1887  	 BEGIN
15:21:32 1888  	   SELECT
15:21:32 1889  	     GIFT_CERTIFICATE.ID into temp_gift_certificate_id
15:21:32 1890  	   FROM
15:21:32 1891  	     GIFT_CERTIFICATE
15:21:32 1892  	   WHERE
15:21:32 1893  	     GIFT_CERTIFICATE.ID = in_gift_certificate_id;
15:21:32 1894  	   EXCEPTION
15:21:32 1895  	     WHEN NO_DATA_FOUND THEN
15:21:32 1896  	       RAISE BAD_GIFT_CERTIFICATE_ID;
15:21:32 1897  	 END;
15:21:32 1898  
15:21:32 1899  	 -- Select all gift certificates with given code
15:21:32 1900  	 OPEN out_result_set FOR
15:21:32 1901  	 SELECT
15:21:32 1902  	   gc.EXPIRATION_DATE,
15:21:32 1903  	   ch.name,
15:21:32 1904  	   ch.id,
15:21:32 1905  	   gc.sender_email,
15:21:32 1906  	   gc.sender_name,
15:21:32 1907  	   gc.recipient_email,
15:21:32 1908  	   gc.recipient_name,
15:21:32 1909  	   gc.purchase_date,
15:21:32 1910  	   gc.redemption_date,
15:21:32 1911  	   gc.purchaser_group_id,
15:21:32 1912  	   gc.redeemer_group_id,
15:21:32 1913  	   gc.code,
15:21:32 1914  	   gc.gift_message,
15:21:32 1915  	   gc.recipient_notify_date
15:21:32 1916  	 FROM
15:21:32 1917  	   GIFT_CERTIFICATE gc
15:21:32 1918  	 INNER JOIN OFFER_CHAIN ch ON ch.id = gc.offer_chain_id
15:21:32 1919  	 WHERE
15:21:32 1920  	   gc.id = in_gift_certificate_id;
15:21:32 1921  
15:21:32 1922  EXCEPTION
15:21:32 1923  WHEN BAD_GIFT_CERTIFICATE_ID THEN
15:21:32 1924  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1925  	   SPROC_NAME, 'No such gift certificate');
15:21:32 1926  WHEN OTHERS THEN
15:21:32 1927  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1928  	   SPROC_NAME, 'Unknown Error', SQLERRM);
15:21:32 1929  END GET_GIFT_CERTIFICATE_BY_ID;
15:21:32 1930  
15:21:32 1931  /******************************************************************************/
15:21:32 1932  
15:21:32 1933  PROCEDURE GET_DEF_FINANCIAL_INSTRUMENT (
15:21:32 1934  	 in_group_id		IN  NUMBER,
15:21:32 1935  	 out_instrument_type_id OUT NUMBER,
15:21:32 1936  	 out_instrument_id	OUT NUMBER
15:21:32 1937  ) AS
15:21:32 1938  SPROC_NAME CONSTANT VARCHAR2(28) := 'GET_DEF_FINANCIAL_INSTRUMENT';
15:21:32 1939  BEGIN
15:21:32 1940  
15:21:32 1941  	 SELECT
15:21:32 1942  	   ACCOUNT.INSTRUMENT_TYPE_ID,
15:21:32 1943  	   ACCOUNT.INSTRUMENT_ID
15:21:32 1944  	   into
15:21:32 1945  	   out_instrument_type_id,
15:21:32 1946  	   out_instrument_id
15:21:32 1947  	 FROM
15:21:32 1948  	   ACCOUNT
15:21:32 1949  	 WHERE
15:21:32 1950  	   ACCOUNT.GROUP_ID = in_group_id;
15:21:32 1951  
15:21:32 1952  EXCEPTION
15:21:32 1953  WHEN NO_DATA_FOUND THEN
15:21:32 1954  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1955  	   SPROC_NAME, 'Bad group id');
15:21:32 1956  WHEN OTHERS THEN
15:21:32 1957  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1958  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1959  END GET_DEF_FINANCIAL_INSTRUMENT;
15:21:32 1960  
15:21:32 1961  /******************************************************************************/
15:21:32 1962  
15:21:32 1963  PROCEDURE SET_DEF_FINANCIAL_INSTRUMENT (
15:21:32 1964  	 in_group_id	       IN NUMBER,
15:21:32 1965  	 in_instrument_type_id IN NUMBER,
15:21:32 1966  	 in_instrument_id      IN NUMBER,
15:21:32 1967  	 in_updated_by	       IN VARCHAR2
15:21:32 1968  ) AS
15:21:32 1969  -- VARIABLES
15:21:32 1970  SPROC_NAME	      CONSTANT VARCHAR2(28) := 'SET_DEF_FINANCIAL_INSTRUMENT';
15:21:32 1971  var_account_id	      NUMBER;
15:21:32 1972  -- EXCEPTIONS
15:21:32 1973  BAD_GROUP_ID	      EXCEPTION;
15:21:32 1974  BAD_CREDIT_CARD	      EXCEPTION;
15:21:32 1975  BAD_PAYPAL	      EXCEPTION;
15:21:32 1976  BAD_INSTRUMENT_TYPE    EXCEPTION;
15:21:32 1977  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:32 1978  BEGIN
15:21:32 1979  
15:21:32 1980  	 -- get account id
15:21:32 1981  	 BEGIN
15:21:32 1982  	   SELECT
15:21:32 1983  	     ACCOUNT.ID into var_account_id
15:21:32 1984  	   FROM
15:21:32 1985  	     ACCOUNT
15:21:32 1986  	   WHERE
15:21:32 1987  	     ACCOUNT.GROUP_ID = in_group_id;
15:21:32 1988  	   EXCEPTION
15:21:32 1989  	     WHEN NO_DATA_FOUND THEN
15:21:32 1990  	       RAISE BAD_GROUP_ID;
15:21:32 1991  	 END;
15:21:32 1992  
15:21:32 1993  	 -- Chech that given instrument exists
15:21:32 1994  	 IF in_instrument_type_id = GLOBAL_ENUMS_V18.INSTRUMENT_CREDIT_CARD THEN
15:21:32 1995  	   IF IS_CREDIT_CARD_EXISTS(in_instrument_id) = GLOBAL_CONSTANTS_V18.FALSE THEN
15:21:32 1996  	     RAISE BAD_CREDIT_CARD;
15:21:32 1997  	   END IF;
15:21:32 1998  	 ELSIF in_instrument_type_id = GLOBAL_ENUMS_V18.INSTRUMENT_PAYPAL THEN
15:21:32 1999  	   IF IS_PAYPAL_EXISTS(in_instrument_id) = GLOBAL_CONSTANTS_V18.FALSE THEN
15:21:32 2000  	     RAISE BAD_PAYPAL;
15:21:32 2001  	   END IF;
15:21:32 2002  	 ELSE
15:21:32 2003  	   RAISE BAD_INSTRUMENT_TYPE;
15:21:32 2004  	 END IF;
15:21:32 2005  
15:21:32 2006  	 -- update account information
15:21:32 2007  	 PROCS_ACCOUNT_CRU_V18.UPDATE_ACCOUNT(
15:21:32 2008  	   in_account_id	 => var_account_id,
15:21:32 2009  	   in_updated_by	 => in_updated_by,
15:21:32 2010  	   in_instrument_type_id => in_instrument_type_id,
15:21:32 2011  	   in_instrument_id	 => in_instrument_id
15:21:32 2012  	 );
15:21:32 2013  
15:21:32 2014  EXCEPTION
15:21:32 2015  WHEN BAD_GROUP_ID THEN
15:21:32 2016  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2017  	   SPROC_NAME, 'No such account');
15:21:32 2018  WHEN BAD_CREDIT_CARD THEN
15:21:32 2019  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2020  	   SPROC_NAME, 'Could not find credit card with given ID');
15:21:32 2021  WHEN BAD_PAYPAL THEN
15:21:32 2022  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2023  	   SPROC_NAME, 'Could not find paypal with given ID');
15:21:32 2024  WHEN BAD_INSTRUMENT_TYPE THEN
15:21:32 2025  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 2026  	   SPROC_NAME, 'Bad instrument type id');
15:21:32 2027  WHEN OTHERS THEN
15:21:32 2028  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2029  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2030  END SET_DEF_FINANCIAL_INSTRUMENT;
15:21:32 2031  
15:21:32 2032  /******************************************************************************/
15:21:32 2033  
15:21:32 2034  PROCEDURE DEL_DEF_FINANCIAL_INSTRUMENT (
15:21:32 2035  	 in_group_id IN NUMBER
15:21:32 2036  ) AS
15:21:32 2037  SPROC_NAME CONSTANT VARCHAR2(28) := 'DEL_DEF_FINANCIAL_INSTRUMENT';
15:21:32 2038  -- VARIABLES
15:21:32 2039  var_account_id NUMBER;
15:21:32 2040  -- EXCEPTIONS
15:21:32 2041  BAD_GROUP_ID	 EXCEPTION;
15:21:32 2042  EXCEPTION_MESSAGE VARCHAR2(1024);
15:21:32 2043  BEGIN
15:21:32 2044  
15:21:32 2045  	 BEGIN
15:21:32 2046  	   SELECT
15:21:32 2047  	     ACCOUNT.ID into var_account_id
15:21:32 2048  	   FROM
15:21:32 2049  	     ACCOUNT
15:21:32 2050  	   WHERE
15:21:32 2051  	     ACCOUNT.GROUP_ID = in_group_id;
15:21:32 2052  	   EXCEPTION
15:21:32 2053  	     WHEN NO_DATA_FOUND THEN
15:21:32 2054  	       RAISE BAD_GROUP_ID;
15:21:32 2055  	 END;
15:21:32 2056  
15:21:32 2057  	 PROCS_ACCOUNT_CRU_V18.UPDATE_DEF_FIN_INSTRUMENT(
15:21:32 2058  	   in_account_id => var_account_id,
15:21:32 2059  	   in_instrument_type_id => NULL,
15:21:32 2060  	   in_instrument_id => NULL,
15:21:32 2061  	   in_updated_by => 'in_updated_by' -- TODO: add in_updated_by field
15:21:32 2062  	 );
15:21:32 2063  
15:21:32 2064  EXCEPTION
15:21:32 2065  WHEN BAD_GROUP_ID THEN
15:21:32 2066  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2067  	   SPROC_NAME, 'No such group id');
15:21:32 2068  WHEN OTHERS THEN
15:21:32 2069  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2070  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2071  END DEL_DEF_FINANCIAL_INSTRUMENT;
15:21:32 2072  
15:21:32 2073  /******************************************************************************/
15:21:32 2074  
15:21:32 2075  PROCEDURE GET_CREDIT_CARD_BY_ID (
15:21:32 2076  	 in_credit_card_id IN  NUMBER,
15:21:32 2077  	 out_result_set    OUT SYS_REFCURSOR
15:21:32 2078  ) AS
15:21:32 2079  -- VARIABLES
15:21:32 2080  SPROC_NAME    CONSTANT VARCHAR2(21) := 'GET_CREDIT_CARD_BY_ID';
15:21:32 2081  temp_cc_count NUMBER;
15:21:32 2082  
15:21:32 2083  -- EXCEPTIONS
15:21:32 2084  BAD_CREDIT_CARD_ID EXCEPTION;
15:21:32 2085  BEGIN
15:21:32 2086  
15:21:32 2087  	 -- Check that credit card exists
15:21:32 2088  	 SELECT
15:21:32 2089  	   COUNT(*) into temp_cc_count
15:21:32 2090  	 FROM
15:21:32 2091  	   CREDIT_CARD
15:21:32 2092  	 WHERE
15:21:32 2093  	   CREDIT_CARD.ID = in_credit_card_id;
15:21:32 2094  	 IF temp_cc_count = 0 THEN
15:21:32 2095  	   RAISE BAD_CREDIT_CARD_ID;
15:21:32 2096  	 END IF;
15:21:32 2097  
15:21:32 2098  	 -- Get data
15:21:32 2099  	 OPEN out_result_set FOR
15:21:32 2100  	 SELECT
15:21:32 2101  	   CREDIT_CARD.ID,
15:21:32 2102  	   CREDIT_CARD.ACCOUNT_ID,
15:21:32 2103  	   CREDIT_CARD.INSTRUMENT_NAME,
15:21:32 2104  	   CREDIT_CARD.PRIVATE_CARD_HOLDER_NAME,
15:21:32 2105  	   CREDIT_CARD.PRIVATE_STREET_ADDRESS,
15:21:32 2106  	   CREDIT_CARD.PRIVATE_STREET_ADDRESS2,
15:21:32 2107  	   CREDIT_CARD.STATE,
15:21:32 2108  	   CREDIT_CARD.CITY,
15:21:32 2109  	   CREDIT_CARD.POSTAL_CODE,
15:21:32 2110  	   CREDIT_CARD.COUNTRY,
15:21:32 2111  	   CREDIT_CARD.LAST_FOUR_CC,
15:21:32 2112  	   CREDIT_CARD.EXPIRATION_DATE,
15:21:32 2113  	   CREDIT_CARD.CREDIT_CARD_TYPE_ID,
15:21:32 2114  	   CREDIT_CARD.SECRET_TOKEN,
15:21:32 2115  	   CREDIT_CARD.CREATE_DATE,
15:21:32 2116  	   CREDIT_CARD.CREATED_BY,
15:21:32 2117  	   CREDIT_CARD.UPDATE_DATE,
15:21:32 2118  	   CREDIT_CARD.UPDATED_BY,
15:21:32 2119  	   CREDIT_CARD.CREDIT_CARD_STATUS_ID,
15:21:32 2120  	   CREDIT_CARD.PRIVATE_FIRST_NAME,
15:21:32 2121  	   CREDIT_CARD.PRIVATE_LAST_NAME,
15:21:32 2122  	       CREDIT_CARD.CHASE_PROFILE_ID
15:21:32 2123  	 FROM
15:21:32 2124  	   CREDIT_CARD
15:21:32 2125  	 WHERE
15:21:32 2126  	   CREDIT_CARD.ID = in_credit_card_id;
15:21:32 2127  
15:21:32 2128  EXCEPTION
15:21:32 2129  WHEN BAD_CREDIT_CARD_ID THEN
15:21:32 2130  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2131  	   SPROC_NAME, 'No such credit card');
15:21:32 2132  WHEN OTHERS THEN
15:21:32 2133  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2134  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2135  END GET_CREDIT_CARD_BY_ID;
15:21:32 2136  
15:21:32 2137  /******************************************************************************/
15:21:32 2138  
15:21:32 2139  PROCEDURE GET_PAYPAL_BY_ID (
15:21:32 2140  	 in_paypal_id	IN  NUMBER,
15:21:32 2141  	 out_result_set OUT SYS_REFCURSOR
15:21:32 2142  ) AS
15:21:32 2143  SPROC_NAME CONSTANT VARCHAR2(16) := 'GET_PAYPAL_BY_ID';
15:21:32 2144  -- VARIABLES
15:21:32 2145  temp_pp_count NUMBER;
15:21:32 2146  -- EXCEPTIONS
15:21:32 2147  BAD_PAYPAL_ID EXCEPTION;
15:21:32 2148  BEGIN
15:21:32 2149  
15:21:32 2150  	 -- Check that credit card exists
15:21:32 2151  	 SELECT
15:21:32 2152  	   COUNT(*) into temp_pp_count
15:21:32 2153  	 FROM
15:21:32 2154  	   PAYPAL
15:21:32 2155  	 WHERE
15:21:32 2156  	   PAYPAL.ID = in_paypal_id;
15:21:32 2157  	 IF temp_pp_count = 0 THEN
15:21:32 2158  	   RAISE BAD_PAYPAL_ID;
15:21:32 2159  	 END IF;
15:21:32 2160  
15:21:32 2161  	 OPEN out_result_set FOR
15:21:32 2162  	 SELECT
15:21:32 2163  	   ID,
15:21:32 2164  	   ACCOUNT_ID,
15:21:32 2165  	   INSTRUMENT_NAME,
15:21:32 2166  	   PRIVATE_EMAIL_ADDRESS,
15:21:32 2167  	   CREATE_DATE,
15:21:32 2168  	   CREATED_BY,
15:21:32 2169  	   UPDATE_DATE,
15:21:32 2170  	   UPDATED_BY,
15:21:32 2171  	   PAYPAL_STATUS_ID,
15:21:32 2172  	   PRIVATE_STREET_ADDRESS,
15:21:32 2173  	   PRIVATE_STREET_ADDRESS2,
15:21:32 2174  	   STATE,
15:21:32 2175  	   CITY,
15:21:32 2176  	   POSTAL_CODE,
15:21:32 2177  	   COUNTRY,
15:21:32 2178  	   EXPIRATION_DATE,
15:21:32 2179  	   SECRET_TOKEN
15:21:32 2180  	 FROM
15:21:32 2181  	   PAYPAL
15:21:32 2182  	 WHERE
15:21:32 2183  	   ID = in_paypal_id;
15:21:32 2184  
15:21:32 2185  EXCEPTION
15:21:32 2186  WHEN BAD_PAYPAL_ID THEN
15:21:32 2187  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2188  	   SPROC_NAME, 'No such paypal');
15:21:32 2189  WHEN OTHERS THEN
15:21:32 2190  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2191  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2192  END GET_PAYPAL_BY_ID;
15:21:32 2193  
15:21:32 2194  /******************************************************************************/
15:21:32 2195  
15:21:32 2196  FUNCTION F_CAN_DISABLE_CREDIT_CARD (
15:21:32 2197  /*
15:21:32 2198  	 Returns GLOBAL_CONSTANTS_V18.TRUE if system can disable credit card
15:21:32 2199  	 GLOBAL_CONSTANTS_V18.FALSE else
15:21:32 2200  */
15:21:32 2201  	 in_credit_card_id NUMBER
15:21:32 2202  ) RETURN NUMBER AS
15:21:32 2203  BEGIN
15:21:32 2204  	 -- STUB
15:21:32 2205  	 RETURN GLOBAL_CONSTANTS_V18.TRUE;
15:21:32 2206  END F_CAN_DISABLE_CREDIT_CARD;
15:21:32 2207  
15:21:32 2208  /******************************************************************************/
15:21:32 2209  
15:21:32 2210  PROCEDURE GET_PURCHASED_GCERTIFICATES (
15:21:32 2211  	 in_group_id	IN NUMBER,
15:21:32 2212  	 out_result_set OUT SYS_REFCURSOR
15:21:32 2213  ) AS
15:21:32 2214  -- VARIABLES
15:21:32 2215  SPROC_NAME     CONSTANT VARCHAR2(27) := 'GET_PURCHASED_GCERTIFICATES';
15:21:32 2216  var_account_id NUMBER;
15:21:32 2217  -- EXCEPTIONS
15:21:32 2218  BAD_GROUP_ID EXCEPTION;
15:21:32 2219  BEGIN
15:21:32 2220  
15:21:32 2221  	 BEGIN
15:21:32 2222  	   SELECT
15:21:32 2223  	     ACCOUNT.ID into var_account_id
15:21:32 2224  	   FROM
15:21:32 2225  	     ACCOUNT
15:21:32 2226  	   WHERE
15:21:32 2227  	     ACCOUNT.GROUP_ID = in_group_id;
15:21:32 2228  	   EXCEPTION
15:21:32 2229  	     WHEN NO_DATA_FOUND THEN
15:21:32 2230  	       RAISE BAD_GROUP_ID;
15:21:32 2231  	 END;
15:21:32 2232  
15:21:32 2233  	 OPEN out_result_set FOR
15:21:32 2234  	 SELECT
15:21:32 2235  	   GIFT_CERTIFICATE.CODE,
15:21:32 2236  	   GIFT_CERTIFICATE.EXPIRATION_DATE,
15:21:32 2237  	   OFFER_CHAIN.NAME AS "OFFER_CHAIN_NAME",
15:21:32 2238  	   OFFER_CHAIN.ID AS "OFFER_CHAIN_ID",
15:21:32 2239  	   GIFT_CERTIFICATE.SENDER_EMAIL,
15:21:32 2240  	   GIFT_CERTIFICATE.SENDER_NAME,
15:21:32 2241  	   GIFT_CERTIFICATE.RECIPIENT_EMAIL,
15:21:32 2242  	   GIFT_CERTIFICATE.RECIPIENT_NAME,
15:21:32 2243  	   GIFT_CERTIFICATE.PURCHASE_DATE,
15:21:32 2244  	   GIFT_CERTIFICATE.REDEMPTION_DATE,
15:21:32 2245  	   GIFT_CERTIFICATE.REDEEMER_GROUP_ID
15:21:32 2246  	 FROM
15:21:32 2247  	   GIFT_CERTIFICATE
15:21:32 2248  	   INNER JOIN OFFER_CHAIN ON GIFT_CERTIFICATE.OFFER_CHAIN_ID = OFFER_CHAIN.ID
15:21:32 2249  	 WHERE
15:21:32 2250  	   ROWNUM <= 100 AND
15:21:32 2251  	   GIFT_CERTIFICATE.PURCHASER_GROUP_ID = in_group_id;
15:21:32 2252  
15:21:32 2253  EXCEPTION
15:21:32 2254  WHEN BAD_GROUP_ID THEN
15:21:32 2255  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2256  	   SPROC_NAME, 'No such group id');
15:21:32 2257  WHEN OTHERS THEN
15:21:32 2258  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2259  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2260  END GET_PURCHASED_GCERTIFICATES;
15:21:32 2261  
15:21:32 2262  /******************************************************************************/
15:21:32 2263  
15:21:32 2264  PROCEDURE IS_GCERT_FOR_PROPER_OFFER (
15:21:32 2265  	 in_gift_certificate_id IN NUMBER,
15:21:32 2266  	 in_charge_id		IN NUMBER,
15:21:32 2267  	 out_result		OUT NUMBER
15:21:32 2268  ) AS
15:21:32 2269  -- VARIABLES
15:21:32 2270  SPROC_NAME	    CONSTANT VARCHAR2(25) := 'IS_GCERT_FOR_PROPER_OFFER';
15:21:32 2271  var_invoice_id	    NUMBER;
15:21:32 2272  var_offer_chain_id   NUMBER;
15:21:32 2273  var_offer_chain_s_id NUMBER;
15:21:32 2274  -- EXCEPTIONS
15:21:32 2275  BAD_CHARGE_ID		 EXCEPTION;
15:21:32 2276  BAD_GIFT_CERTIFICATE_ID	 EXCEPTION;
15:21:32 2277  CAN_NOT_FIND_SUBSCRIPTION EXCEPTION;
15:21:32 2278  BEGIN
15:21:32 2279  
15:21:32 2280  	 BEGIN
15:21:32 2281  	   SELECT
15:21:32 2282  	     CHARGE.INVOICE_ID into var_invoice_id
15:21:32 2283  	   FROM
15:21:32 2284  	     CHARGE
15:21:32 2285  	   WHERE
15:21:32 2286  	     CHARGE.ID = in_charge_id;
15:21:32 2287  	   EXCEPTION
15:21:32 2288  	     WHEN NO_DATA_FOUND THEN
15:21:32 2289  	       RAISE BAD_CHARGE_ID;
15:21:32 2290  	 END;
15:21:32 2291  
15:21:32 2292  	 BEGIN
15:21:32 2293  	   SELECT
15:21:32 2294  	     GIFT_CERTIFICATE.OFFER_CHAIN_ID into var_offer_chain_id
15:21:32 2295  	   FROM
15:21:32 2296  	     GIFT_CERTIFICATE
15:21:32 2297  	   WHERE
15:21:32 2298  	     GIFT_CERTIFICATE.ID = in_gift_certificate_id;
15:21:32 2299  	   EXCEPTION
15:21:32 2300  	     WHEN NO_DATA_FOUND THEN
15:21:32 2301  	       RAISE BAD_GIFT_CERTIFICATE_ID;
15:21:32 2302  	 END;
15:21:32 2303  
15:21:32 2304  	 BEGIN
15:21:32 2305  	   SELECT
15:21:32 2306  	     SUBSCRIPTION.OFFER_CHAIN_ID into var_offer_chain_s_id
15:21:32 2307  	   FROM
15:21:32 2308  	     SUBSCRIPTION
15:21:32 2309  	   WHERE
15:21:32 2310  	     SUBSCRIPTION.ID IN (
15:21:32 2311  	       SELECT DISTINCT
15:21:32 2312  		 LICENSE.SUBSCRIPTION_ID
15:21:32 2313  	       FROM
15:21:32 2314  		 LICENSE
15:21:32 2315  	       WHERE
15:21:32 2316  		 LICENSE.INVOICE_ID = var_invoice_id
15:21:32 2317  	     );
15:21:32 2318  	   EXCEPTION
15:21:32 2319  	     WHEN NO_DATA_FOUND THEN
15:21:32 2320  	       RAISE CAN_NOT_FIND_SUBSCRIPTION;
15:21:32 2321  	 END;
15:21:32 2322  
15:21:32 2323  	 IF var_offer_chain_s_id = var_offer_chain_id THEN
15:21:32 2324  	   out_result := GLOBAL_CONSTANTS_V18.TRUE;
15:21:32 2325  	 ELSE
15:21:32 2326  	   out_result := GLOBAL_CONSTANTS_V18.FALSE;
15:21:32 2327  	 END IF;
15:21:32 2328  
15:21:32 2329  EXCEPTION
15:21:32 2330  WHEN BAD_CHARGE_ID THEN
15:21:32 2331  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2332  	   SPROC_NAME, 'No such charge');
15:21:32 2333  WHEN BAD_GIFT_CERTIFICATE_ID THEN
15:21:32 2334  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2335  	   SPROC_NAME, 'No such gift certificate');
15:21:32 2336  WHEN CAN_NOT_FIND_SUBSCRIPTION THEN
15:21:32 2337  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2338  	   SPROC_NAME, 'Could not find subscription for given charge');
15:21:32 2339  WHEN OTHERS THEN
15:21:32 2340  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2341  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2342  END IS_GCERT_FOR_PROPER_OFFER;
15:21:32 2343  
15:21:32 2344  /******************************************************************************/
15:21:32 2345  
15:21:32 2346  FUNCTION IS_CREDIT_CARD_EXISTS (
15:21:32 2347  /*
15:21:32 2348  GLOBAL_CONSTANTS_V18.TRUE - if instrument exists
15:21:32 2349  GLOBAL_CONSTANTS_V18.FALSE - else
15:21:32 2350  */
15:21:32 2351  	 in_credit_card_id IN NUMBER
15:21:32 2352  ) RETURN NUMBER AS
15:21:32 2353  -- VARIABLES
15:21:32 2354  var_cc_count NUMBER;
15:21:32 2355  BEGIN
15:21:32 2356  	 SELECT
15:21:32 2357  	   COUNT(*) into var_cc_count
15:21:32 2358  	 FROM
15:21:32 2359  	   CREDIT_CARD
15:21:32 2360  	 WHERE
15:21:32 2361  	   CREDIT_CARD.ID = in_credit_card_id;
15:21:32 2362  
15:21:32 2363  	 IF var_cc_count = 0 THEN
15:21:32 2364  	   RETURN GLOBAL_CONSTANTS_V18.FALSE;
15:21:32 2365  	 ELSE
15:21:32 2366  	   RETURN GLOBAL_CONSTANTS_V18.TRUE;
15:21:32 2367  	 END IF;
15:21:32 2368  
15:21:32 2369  END IS_CREDIT_CARD_EXISTS;
15:21:32 2370  
15:21:32 2371  /******************************************************************************/
15:21:32 2372  
15:21:32 2373  FUNCTION IS_PAYPAL_EXISTS (
15:21:32 2374  /*
15:21:32 2375  GLOBAL_CONSTANTS_V18.TRUE - if instrument exists
15:21:32 2376  GLOBAL_CONSTANTS_V18.FALSE - else
15:21:32 2377  */
15:21:32 2378  	 in_paypal_id IN NUMBER
15:21:32 2379  ) RETURN NUMBER AS
15:21:32 2380  -- VARIABLES
15:21:32 2381  var_pp_count NUMBER;
15:21:32 2382  BEGIN
15:21:32 2383  	 SELECT
15:21:32 2384  	   COUNT(*) into var_pp_count
15:21:32 2385  	 FROM
15:21:32 2386  	   PAYPAL
15:21:32 2387  	 WHERE
15:21:32 2388  	   PAYPAL.ID = in_paypal_id;
15:21:32 2389  
15:21:32 2390  	 IF var_pp_count = 0 THEN
15:21:32 2391  	   RETURN GLOBAL_CONSTANTS_V18.FALSE;
15:21:32 2392  	 ELSE
15:21:32 2393  	   RETURN GLOBAL_CONSTANTS_V18.TRUE;
15:21:32 2394  	 END IF;
15:21:32 2395  
15:21:32 2396  END IS_PAYPAL_EXISTS;
15:21:32 2397  
15:21:32 2398  /******************************************************************************/
15:21:32 2399  
15:21:32 2400  FUNCTION IS_GIFT_CERTIFICATE_EXISTS (
15:21:32 2401  /*
15:21:32 2402  GLOBAL_CONSTANTS_V18.TRUE - if instrument exists
15:21:32 2403  GLOBAL_CONSTANTS_V18.FALSE - else
15:21:32 2404  */
15:21:32 2405  	 in_gift_certificate_id IN NUMBER
15:21:32 2406  ) RETURN NUMBER AS
15:21:32 2407  -- VARIABLES
15:21:32 2408  var_gc_count NUMBER;
15:21:32 2409  BEGIN
15:21:32 2410  	 SELECT
15:21:32 2411  	   COUNT(*) into var_gc_count
15:21:32 2412  	 FROM
15:21:32 2413  	   GIFT_CERTIFICATE
15:21:32 2414  	 WHERE
15:21:32 2415  	   GIFT_CERTIFICATE.ID = in_gift_certificate_id;
15:21:32 2416  
15:21:32 2417  	 IF var_gc_count = 0 THEN
15:21:32 2418  	   RETURN GLOBAL_CONSTANTS_V18.FALSE;
15:21:32 2419  	 ELSE
15:21:32 2420  	   RETURN GLOBAL_CONSTANTS_V18.TRUE;
15:21:32 2421  	 END IF;
15:21:32 2422  
15:21:32 2423  END IS_GIFT_CERTIFICATE_EXISTS;
15:21:32 2424  
15:21:32 2425  /******************************************************************************/
15:21:32 2426  
15:21:32 2427  PROCEDURE GET_GROUP_ID_BY_CREDIT_CARD_ID (
15:21:32 2428  	 in_credit_card_id IN NUMBER,
15:21:32 2429  	 out_group_id	   OUT NUMBER
15:21:32 2430  ) AS
15:21:32 2431  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_GROUP_ID_BY_CREDIT_CARD_ID';
15:21:32 2432  BEGIN
15:21:32 2433  	 SELECT
15:21:32 2434  	   ACCOUNT.GROUP_ID into out_group_id
15:21:32 2435  	 FROM
15:21:32 2436  	   CREDIT_CARD
15:21:32 2437  	   INNER JOIN ACCOUNT ON CREDIT_CARD.ACCOUNT_ID = ACCOUNT.ID
15:21:32 2438  	 WHERE
15:21:32 2439  	   CREDIT_CARD.ID = in_credit_card_id;
15:21:32 2440  EXCEPTION
15:21:32 2441  WHEN NO_DATA_FOUND THEN
15:21:32 2442  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2443  	   SPROC_NAME, 'No such credit card');
15:21:32 2444  WHEN OTHERS THEN
15:21:32 2445  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2446  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2447  END GET_GROUP_ID_BY_CREDIT_CARD_ID;
15:21:32 2448  
15:21:32 2449  /******************************************************************************/
15:21:32 2450  
15:21:32 2451  PROCEDURE GET_GROUP_ID_BY_PAYPAL_ID (
15:21:32 2452  	 in_paypal_id IN NUMBER,
15:21:32 2453  	 out_group_id OUT NUMBER
15:21:32 2454  ) AS
15:21:32 2455  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GROUP_ID_BY_PAYPAL_ID';
15:21:32 2456  BEGIN
15:21:32 2457  	 SELECT
15:21:32 2458  	   ACCOUNT.GROUP_ID into out_group_id
15:21:32 2459  	 FROM
15:21:32 2460  	   PAYPAL
15:21:32 2461  	   INNER JOIN ACCOUNT ON PAYPAL.ACCOUNT_ID = ACCOUNT.ID
15:21:32 2462  	 WHERE
15:21:32 2463  	   PAYPAL.ID = in_paypal_id;
15:21:32 2464  EXCEPTION
15:21:32 2465  WHEN NO_DATA_FOUND THEN
15:21:32 2466  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2467  	   SPROC_NAME, 'No such paypal');
15:21:32 2468  WHEN OTHERS THEN
15:21:32 2469  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2470  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2471  END GET_GROUP_ID_BY_PAYPAL_ID;
15:21:32 2472  
15:21:32 2473  /******************************************************************************/
15:21:32 2474  
15:21:32 2475  PROCEDURE UPDATE_CREDIT_CARD_STATUS (
15:21:32 2476  	 in_credit_card_id	  IN CREDIT_CARD.ID%TYPE,
15:21:32 2477  	 in_credit_card_status_id IN CREDIT_CARD.CREDIT_CARD_STATUS_ID%TYPE,
15:21:32 2478  	 in_updated_by		  IN CREDIT_CARD.UPDATED_BY%TYPE
15:21:32 2479  ) AS
15:21:32 2480  SPROC_NAME CONSTANT VARCHAR2(25) := 'UPDATE_CREDIT_CARD_STATUS';
15:21:32 2481  -- EXCEPTIONS
15:21:32 2482  BAD_CREDIT_CARD_ID     EXCEPTION;
15:21:32 2483  BAD_STATUS_ID	      EXCEPTION;
15:21:32 2484  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:32 2485  BEGIN
15:21:32 2486  
15:21:32 2487  	 IF in_credit_card_status_id != GLOBAL_STATUSES_V18.CREDIT_CARD_ACTIVE
15:21:32 2488  	   AND in_credit_card_status_id != GLOBAL_STATUSES_V18.CREDIT_CARD_INVALID
15:21:32 2489  	   AND in_credit_card_status_id != GLOBAL_STATUSES_V18.CREDIT_CARD_DISABLED
15:21:32 2490  	   AND in_credit_card_status_id != GLOBAL_STATUSES_V18.CREDIT_CARD_EXPIRED THEN
15:21:32 2491  	   RAISE BAD_STATUS_ID;
15:21:32 2492  	 END IF;
15:21:32 2493  
15:21:32 2494  	 PROCS_FIN_INSTRUMENTS_CRU_V18.UPDATE_CREDIT_CARD(
15:21:32 2495  	   in_credit_card_id	    => in_credit_card_id,
15:21:32 2496  	   in_updated_by	    => in_updated_by,
15:21:32 2497  	   in_credit_card_status_id => in_credit_card_status_id
15:21:32 2498  	 );
15:21:32 2499  
15:21:32 2500  	 IF SQL%ROWCOUNT = 0 THEN
15:21:32 2501  	   RAISE BAD_CREDIT_CARD_ID;
15:21:32 2502  	 END IF;
15:21:32 2503  
15:21:32 2504  EXCEPTION
15:21:32 2505  WHEN BAD_CREDIT_CARD_ID THEN
15:21:32 2506  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2507  	   SPROC_NAME, 'No such credit card');
15:21:32 2508  WHEN BAD_STATUS_ID THEN
15:21:32 2509  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 2510  	   SPROC_NAME, 'Bad credit card status id');
15:21:32 2511  WHEN OTHERS THEN
15:21:32 2512  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2513  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2514  END UPDATE_CREDIT_CARD_STATUS;
15:21:32 2515  
15:21:32 2516  /******************************************************************************/
15:21:32 2517  
15:21:32 2518  PROCEDURE UPDATE_PAYPAL_STATUS (
15:21:32 2519  	 in_paypal_id	     IN PAYPAL.ID%TYPE,
15:21:32 2520  	 in_paypal_status_id IN PAYPAL.PAYPAL_STATUS_ID%TYPE,
15:21:32 2521  	 in_updated_by	     IN PAYPAL.UPDATED_BY%TYPE
15:21:32 2522  ) AS
15:21:32 2523  SPROC_NAME CONSTANT VARCHAR2(20) := 'UPDATE_PAYPAL_STATUS';
15:21:32 2524  -- EXCEPTIONS
15:21:32 2525  BAD_PAYPAL_ID	      EXCEPTION;
15:21:32 2526  BAD_STATUS_ID	      EXCEPTION;
15:21:32 2527  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:32 2528  BEGIN
15:21:32 2529  
15:21:32 2530  	 IF in_paypal_status_id != GLOBAL_STATUSES_V18.PAYPAL_ACTIVE
15:21:32 2531  	   AND in_paypal_status_id != GLOBAL_STATUSES_V18.PAYPAL_INACTIVE
15:21:32 2532  	   AND in_paypal_status_id != GLOBAL_STATUSES_V18.PAYPAL_FROZEN THEN
15:21:32 2533  	   RAISE BAD_STATUS_ID;
15:21:32 2534  	 END IF;
15:21:32 2535  
15:21:32 2536  	 PROCS_FIN_INSTRUMENTS_CRU_V18.UPDATE_PAYPAL(
15:21:32 2537  	   in_paypal_id        => in_paypal_id,
15:21:32 2538  	   in_paypal_status_id => in_paypal_status_id,
15:21:32 2539  	   in_updated_by       => in_updated_by
15:21:32 2540  	 );
15:21:32 2541  
15:21:32 2542  	 IF SQL%ROWCOUNT = 0 THEN
15:21:32 2543  	   RAISE BAD_PAYPAL_ID;
15:21:32 2544  	 END IF;
15:21:32 2545  
15:21:32 2546  EXCEPTION
15:21:32 2547  WHEN BAD_PAYPAL_ID THEN
15:21:32 2548  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2549  	   SPROC_NAME, 'No such paypal');
15:21:32 2550  WHEN BAD_STATUS_ID THEN
15:21:32 2551  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 2552  	   SPROC_NAME, 'Bad paypal status id');
15:21:32 2553  WHEN OTHERS THEN
15:21:32 2554  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2555  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2556  END UPDATE_PAYPAL_STATUS;
15:21:32 2557  
15:21:32 2558  /******************************************************************************/
15:21:32 2559  
15:21:32 2560  PROCEDURE UPDATE_GIFT_CERTIFICATE_STATUS (
15:21:32 2561  	 in_gift_certificate_id        IN GIFT_CERTIFICATE.ID%TYPE,
15:21:32 2562  	 in_gift_certificate_status_id IN GIFT_CERTIFICATE.GIFT_CERTIFICATE_STATUS_ID%TYPE,
15:21:32 2563  	 in_updated_by		       IN GIFT_CERTIFICATE.UPDATED_BY%TYPE
15:21:32 2564  ) AS
15:21:32 2565  SPROC_NAME CONSTANT VARCHAR2(30) := 'UPDATE_GIFT_CERTIFICATE_STATUS';
15:21:32 2566  -- EXCEPTIONS
15:21:32 2567  BAD_GIFT_CERTIFICATE_ID EXCEPTION;
15:21:32 2568  BAD_STATUS_ID	       EXCEPTION;
15:21:32 2569  EXCEPTION_MESSAGE       VARCHAR2(1024);
15:21:32 2570  BEGIN
15:21:32 2571  
15:21:32 2572  	 IF in_gift_certificate_status_id != GLOBAL_STATUSES_V18.GIFT_CERTIFICATE_ACTIVE
15:21:32 2573  	   AND in_gift_certificate_status_id != GLOBAL_STATUSES_V18.GIFT_CERTIFICATE_FINALIZED THEN
15:21:32 2574  	   RAISE BAD_STATUS_ID;
15:21:32 2575  	 END IF;
15:21:32 2576  
15:21:32 2577  	 PROCS_FIN_INSTRUMENTS_CRU_V18.UPDATE_GIFT_CERTIFICATE(
15:21:32 2578  	   in_gift_certificate_id	 => in_gift_certificate_id,
15:21:32 2579  	   in_gift_certificate_status_id => in_gift_certificate_status_id,
15:21:32 2580  	   in_updated_by		 => in_updated_by
15:21:32 2581  	 );
15:21:32 2582  
15:21:32 2583  	 IF SQL%ROWCOUNT = 0 THEN
15:21:32 2584  	   RAISE BAD_GIFT_CERTIFICATE_ID;
15:21:32 2585  	 END IF;
15:21:32 2586  
15:21:32 2587  EXCEPTION
15:21:32 2588  WHEN BAD_GIFT_CERTIFICATE_ID THEN
15:21:32 2589  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2590  	   SPROC_NAME, 'No such gift certificate');
15:21:32 2591  WHEN BAD_STATUS_ID THEN
15:21:32 2592  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 2593  	   SPROC_NAME, 'Bad paypal status id');
15:21:32 2594  WHEN OTHERS THEN
15:21:32 2595  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2596  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2597  END UPDATE_GIFT_CERTIFICATE_STATUS;
15:21:32 2598  
15:21:32 2599  /******************************************************************************/
15:21:32 2600  
15:21:32 2601  PROCEDURE GET_GC_BY_PURCH_INVOICE_ID (
15:21:32 2602  	 in_invoice_id		 IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
15:21:32 2603  	 out_result_set OUT SYS_REFCURSOR
15:21:32 2604  ) AS
15:21:32 2605  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GC_BY_PURCHASE_INVOICE_ID';
15:21:32 2606  -- VARIABLES
15:21:32 2607  temp_invoice_id NUMBER;
15:21:32 2608  -- EXCEPTIONS
15:21:32 2609  BAD_INVOICE_ID EXCEPTION;
15:21:32 2610  BEGIN
15:21:32 2611  
15:21:32 2612  	 BEGIN
15:21:32 2613  	   SELECT
15:21:32 2614  	     I.ID into temp_invoice_id
15:21:32 2615  	   FROM
15:21:32 2616  	     INVOICE I
15:21:32 2617  	   WHERE
15:21:32 2618  	     I.ID = in_invoice_id;
15:21:32 2619  	   EXCEPTION
15:21:32 2620  	     WHEN NO_DATA_FOUND THEN
15:21:32 2621  	       RAISE BAD_INVOICE_ID;
15:21:32 2622  	 END;
15:21:32 2623  
15:21:32 2624  	 OPEN out_result_set FOR
15:21:32 2625  	   SELECT
15:21:32 2626  	     gc.EXPIRATION_DATE,
15:21:32 2627  	     ch.name,
15:21:32 2628  	     ch.id offer_chain_id,
15:21:32 2629  	     gc.sender_email,
15:21:32 2630  	     gc.sender_name,
15:21:32 2631  	     gc.recipient_email,
15:21:32 2632  	     gc.recipient_name,
15:21:32 2633  	     gc.purchase_date,
15:21:32 2634  	     gc.redemption_date,
15:21:32 2635  	     gc.purchaser_group_id,
15:21:32 2636  	     gc.redeemer_group_id,
15:21:32 2637  	     gc.code,
15:21:32 2638  	     gc.gift_message,
15:21:32 2639  	     gc.recipient_notify_date,
15:21:32 2640  	     gc.id
15:21:32 2641  	   FROM
15:21:32 2642  	     GIFT_CERTIFICATE gc
15:21:32 2643  	     INNER JOIN OFFER_CHAIN ch ON ch.id = gc.offer_chain_id
15:21:32 2644  	   WHERE
15:21:32 2645  	     gc.PURCHASE_INVOICE_ID = in_invoice_id;
15:21:32 2646  
15:21:32 2647  EXCEPTION
15:21:32 2648  WHEN BAD_INVOICE_ID THEN
15:21:32 2649  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2650  	   SPROC_NAME, 'No such invoice');
15:21:32 2651  WHEN OTHERS THEN
15:21:32 2652  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2653  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2654  END GET_GC_BY_PURCH_INVOICE_ID;
15:21:32 2655  
15:21:32 2656  
15:21:32 2657  PROCEDURE GET_GC_ID_BY_PURCH_INVOICE_ID (
15:21:32 2658  	 in_invoice_id		 IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
15:21:32 2659  	 out_gift_certificate_id OUT GIFT_CERTIFICATE.ID%TYPE
15:21:32 2660  ) AS
15:21:32 2661  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GC_ID_BY_PURCHASE_INVOICE_ID';
15:21:32 2662  -- VARIABLES
15:21:32 2663  temp_invoice_id NUMBER;
15:21:32 2664  -- EXCEPTIONS
15:21:32 2665  BAD_INVOICE_ID EXCEPTION;
15:21:32 2666  BEGIN
15:21:32 2667  
15:21:32 2668  	 BEGIN
15:21:32 2669  	   SELECT
15:21:32 2670  	     I.ID into temp_invoice_id
15:21:32 2671  	   FROM
15:21:32 2672  	     INVOICE I
15:21:32 2673  	   WHERE
15:21:32 2674  	     I.ID = in_invoice_id;
15:21:32 2675  	   EXCEPTION
15:21:32 2676  	     WHEN NO_DATA_FOUND THEN
15:21:32 2677  	       RAISE BAD_INVOICE_ID;
15:21:32 2678  	 END;
15:21:32 2679  
15:21:32 2680  	 BEGIN
15:21:32 2681  	   SELECT
15:21:32 2682  	     GIFT_CERTIFICATE.ID into out_gift_certificate_id
15:21:32 2683  	   FROM
15:21:32 2684  	     GIFT_CERTIFICATE
15:21:32 2685  	   WHERE
15:21:32 2686  	     GIFT_CERTIFICATE.PURCHASE_INVOICE_ID = in_invoice_id;
15:21:32 2687  	   EXCEPTION
15:21:32 2688  	     WHEN NO_DATA_FOUND THEN
15:21:32 2689  	       out_gift_certificate_id := NULL;
15:21:32 2690  	 END;
15:21:32 2691  
15:21:32 2692  EXCEPTION
15:21:32 2693  WHEN BAD_INVOICE_ID THEN
15:21:32 2694  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2695  	   SPROC_NAME, 'No such invoice');
15:21:32 2696  WHEN OTHERS THEN
15:21:32 2697  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2698  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2699  END GET_GC_ID_BY_PURCH_INVOICE_ID;
15:21:32 2700  
15:21:32 2701  /******************************************************************************/
15:21:32 2702  
15:21:32 2703  PROCEDURE SWITCH_FINANCIAL_INSTRUMENT (
15:21:32 2704  	 in_old_fin_instrument_id   IN NUMBER,
15:21:32 2705  	 in_old_fin_instrument_type IN NUMBER,
15:21:32 2706  	 in_new_fin_instrument_id   IN NUMBER,
15:21:32 2707  	 in_new_fin_instrument_type IN NUMBER,
15:21:32 2708  	 in_updated_by		    IN VARCHAR2
15:21:32 2709  ) AS
15:21:32 2710  SPROC_NAME CONSTANT VARCHAR2(27) := 'SWITCH_FINANCIAL_INSTRUMENT';
15:21:32 2711  -- variables
15:21:32 2712  temp_out_transaction_id NUMBER;
15:21:32 2713  temp_out_charge_id      NUMBER;
15:21:32 2714  var_accounts_count      NUMBER;
15:21:32 2715  var_transaction_type_old  "TRANSACTION".TRANSACTION_TYPE_CODE%TYPE;
15:21:32 2716  var_transaction_type	 "TRANSACTION".TRANSACTION_TYPE_CODE%TYPE;
15:21:32 2717  -- EXCEPTIONS
15:21:32 2718  BAD_OLD_CC   EXCEPTION;
15:21:32 2719  BAD_OLD_PP   EXCEPTION;
15:21:32 2720  BAD_OLD_TYPE EXCEPTION;
15:21:32 2721  BAD_NEW_CC   EXCEPTION;
15:21:32 2722  BAD_NEW_PP   EXCEPTION;
15:21:32 2723  BAD_NEW_TYPE EXCEPTION;
15:21:32 2724  DIFFERENT_OWNERS EXCEPTION;
15:21:32 2725  BEGIN
15:21:32 2726  
15:21:32 2727  	 IF in_old_fin_instrument_type = GLOBAL_ENUMS_V18.INSTRUMENT_CREDIT_CARD THEN
15:21:32 2728  	   IF PROCS_FIN_INSTRUMENTS_V18.IS_CREDIT_CARD_EXISTS(in_old_fin_instrument_id) = GLOBAL_CONSTANTS_V18.FALSE THEN
15:21:32 2729  	     -- throw exception: bad old credit card
15:21:32 2730  	     RAISE BAD_OLD_CC;
15:21:32 2731  	   END IF;
15:21:32 2732  	 ELSIF in_old_fin_instrument_type = GLOBAL_ENUMS_V18.INSTRUMENT_PAYPAL THEN
15:21:32 2733  	   IF PROCS_FIN_INSTRUMENTS_V18.IS_PAYPAL_EXISTS(in_old_fin_instrument_id) = GLOBAL_CONSTANTS_V18.FALSE THEN
15:21:32 2734  	     -- throw exception: bad old paypal
15:21:32 2735  	     RAISE BAD_OLD_PP;
15:21:32 2736  	   END IF;
15:21:32 2737  	 ELSE
15:21:32 2738  	   -- throw exception: bad instrument type
15:21:32 2739  	   RAISE BAD_OLD_TYPE;
15:21:32 2740  	 END IF;
15:21:32 2741  
15:21:32 2742  	 IF in_new_fin_instrument_type = GLOBAL_ENUMS_V18.INSTRUMENT_CREDIT_CARD THEN
15:21:32 2743  	   IF PROCS_FIN_INSTRUMENTS_V18.IS_CREDIT_CARD_EXISTS(in_new_fin_instrument_id) = GLOBAL_CONSTANTS_V18.FALSE THEN
15:21:32 2744  	     -- throw exception: bad new credit card
15:21:32 2745  	     RAISE BAD_NEW_CC;
15:21:32 2746  	   END IF;
15:21:32 2747  	 ELSIF in_new_fin_instrument_type = GLOBAL_ENUMS_V18.INSTRUMENT_PAYPAL THEN
15:21:32 2748  	   IF PROCS_FIN_INSTRUMENTS_V18.IS_PAYPAL_EXISTS(in_new_fin_instrument_id) = GLOBAL_CONSTANTS_V18.FALSE THEN
15:21:32 2749  	     -- throw exception: bad new paypal
15:21:32 2750  	     RAISE BAD_NEW_PP;
15:21:32 2751  	   END IF;
15:21:32 2752  	 ELSE
15:21:32 2753  	   -- throw exception: bad new instrument type
15:21:32 2754  	   RAISE BAD_NEW_TYPE;
15:21:32 2755  	 END IF;
15:21:32 2756  
15:21:32 2757  	 -- Check that owner of both instruments - same man
15:21:32 2758  
15:21:32 2759  	 SELECT count(1) into var_accounts_count FROM (
15:21:32 2760  	   SELECT
15:21:32 2761  	     CC.ACCOUNT_ID
15:21:32 2762  	   FROM
15:21:32 2763  	     CREDIT_CARD CC
15:21:32 2764  	   WHERE
15:21:32 2765  	     (
15:21:32 2766  	       CC.ID = in_old_fin_instrument_id
15:21:32 2767  	       AND in_old_fin_instrument_type = GLOBAL_ENUMS_V18.INSTRUMENT_CREDIT_CARD
15:21:32 2768  	     )
15:21:32 2769  	     OR
15:21:32 2770  	     (
15:21:32 2771  	       CC.ID = in_new_fin_instrument_id
15:21:32 2772  	       AND in_new_fin_instrument_type = GLOBAL_ENUMS_V18.INSTRUMENT_CREDIT_CARD
15:21:32 2773  	     )
15:21:32 2774  	   UNION
15:21:32 2775  	   SELECT
15:21:32 2776  	     PP.ACCOUNT_ID
15:21:32 2777  	   FROM
15:21:32 2778  	     PAYPAL PP
15:21:32 2779  	   WHERE
15:21:32 2780  	     (
15:21:32 2781  	       PP.ID = in_old_fin_instrument_id
15:21:32 2782  	       AND in_old_fin_instrument_type = GLOBAL_ENUMS_V18.INSTRUMENT_PAYPAL
15:21:32 2783  	     )
15:21:32 2784  	     OR
15:21:32 2785  	     (
15:21:32 2786  	       PP.ID = in_new_fin_instrument_id
15:21:32 2787  	       AND in_new_fin_instrument_type = GLOBAL_ENUMS_V18.INSTRUMENT_PAYPAL
15:21:32 2788  	     )
15:21:32 2789  	 )
15:21:32 2790  	 WHERE
15:21:32 2791  	   account_id IS NOT NULL;
15:21:32 2792  
15:21:32 2793  	 IF (var_accounts_count > 1) THEN
15:21:32 2794  	   -- Throw exception: different owners of instruments
15:21:32 2795  	   RAISE DIFFERENT_OWNERS;
15:21:32 2796  	 END IF;
15:21:32 2797  
15:21:32 2798  	 FOR f_sub IN (
15:21:32 2799  	   select
15:21:32 2800  	     s.id
15:21:32 2801  	   FROM
15:21:32 2802  	     subscription s
15:21:32 2803  	   WHERE
15:21:32 2804  	     (
15:21:32 2805  	       s.subscription_status_id = GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE OR
15:21:32 2806  	       s.subscription_status_id = GLOBAL_STATUSES_V18.SUBSCRIPTION_SUSPENDED OR
15:21:32 2807  	       s.subscription_status_id = GLOBAL_STATUSES_V18.SUBSCRIPTION_IN_GRACE_PERIOD
15:21:32 2808  	     )
15:21:32 2809  	     AND
15:21:32 2810  	     s.instrument_type_id = in_old_fin_instrument_type AND
15:21:32 2811  	     s.instrument_id = in_old_fin_instrument_id
15:21:32 2812  	 ) LOOP
15:21:32 2813  	   PROCS_SUBSCRIPTION_CRU_V18.UPDATE_SUBSCRIPTION(
15:21:32 2814  	     in_subscription_id => f_sub.id,
15:21:32 2815  	     in_instrument_type_id => in_new_fin_instrument_type,
15:21:32 2816  	     in_instrument_id => in_new_fin_instrument_id,
15:21:32 2817  	     in_updated_by => in_updated_by
15:21:32 2818  	   );
15:21:32 2819  	 END LOOP;
15:21:32 2820  
15:21:32 2821  	 FOR f_open_charge IN (
15:21:32 2822  	   select
15:21:32 2823  	     ch.id,
15:21:32 2824  	     ch.invoice_id,
15:21:32 2825  	     ch.transaction_id,
15:21:32 2826  	     ch.charge_amount
15:21:32 2827  	   FROM
15:21:32 2828  	     charge ch
15:21:32 2829  	   WHERE
15:21:32 2830  	     ch.instrument_type_id = in_old_fin_instrument_type
15:21:32 2831  	     AND ch.instrument_id = in_old_fin_instrument_id
15:21:32 2832  	     AND ch.charge_status_id = GLOBAL_STATUSES_V18.CHARGE_OPENED
15:21:32 2833  	 ) LOOP
15:21:32 2834  
15:21:32 2835  	   FOR f_pending_transaction IN (
15:21:32 2836  	     select
15:21:32 2837  	       id, transaction_amount, order_id, is_refund
15:21:32 2838  	     from
15:21:32 2839  	       transaction
15:21:32 2840  	     where
15:21:32 2841  	       id = f_open_charge.transaction_id
15:21:32 2842  	       and transaction_status_id = GLOBAL_STATUSES_V18.TRANSACTION_PENDING
15:21:32 2843  	   ) LOOP
15:21:32 2844  
15:21:32 2845  	     SELECT
15:21:32 2846  	       DECODE(TRANSACTION_TYPE_CODE, 'RECURRING_BILLING', 'RECURRING_BILLING_USER_UPDATE',
15:21:32 2847  					     'GRACE_PERIOD_FINAL', 'GRACE_PERIOD_USER_UPDATE',
15:21:32 2848  					     TRANSACTION_TYPE_CODE)
15:21:32 2849  	     INTO var_transaction_type
15:21:32 2850  	     FROM
15:21:32 2851  	       Transaction
15:21:32 2852  	     WHERE
15:21:32 2853  	       id = f_pending_transaction.id
15:21:32 2854  	       AND ROWNUM <= 1;
15:21:32 2855  
15:21:32 2856  	     PROCS_TRANSACTION_V18.CREATE_TRANSACTION (
15:21:32 2857  	       in_transaction_id => NULL,
15:21:32 2858  	       in_status_id  => GLOBAL_STATUSES_V18.TRANSACTION_PENDING,
15:21:32 2859  	       in_amount     => f_pending_transaction.transaction_amount,
15:21:32 2860  	       in_created_by => in_updated_by,
15:21:32 2861  	       in_order_id   => null,
15:21:32 2862  	       in_is_refund  => f_pending_transaction.is_refund,
15:21:32 2863  	       in_transaction_type_code => var_transaction_type,
15:21:32 2864  	       out_transaction_id => temp_out_transaction_id
15:21:32 2865  	     );
15:21:32 2866  
15:21:32 2867  	     PROCS_TRANSACTION_V18.UPDATE_TRANSACTION_STATUS(
15:21:32 2868  	       in_transaction_id => f_pending_transaction.id,
15:21:32 2869  	       in_updated_by	 => in_updated_by,
15:21:32 2870  	       in_transaction_status_id  => GLOBAL_STATUSES_V18.TRANSACTION_CLOSED
15:21:32 2871  	     );
15:21:32 2872  
15:21:32 2873  	     -- Create new charge
15:21:32 2874  	     PROCS_CHARGE_V18.CREATE_CHARGE (
15:21:32 2875  	       in_invoice_id	     => f_open_charge.invoice_id,
15:21:32 2876  	       in_transaction_id     => temp_out_transaction_id,
15:21:32 2877  	       in_instrument_type_id => in_new_fin_instrument_type,
15:21:32 2878  	       in_instrument_id      => in_new_fin_instrument_id,
15:21:32 2879  	       in_charge_amount      => f_open_charge.charge_amount,
15:21:32 2880  	       in_created_by	     => in_updated_by,
15:21:32 2881  	       in_charge_status_id   => GLOBAL_STATUSES_V18.CHARGE_OPENED,
15:21:32 2882  	       out_charge_id	     => temp_out_charge_id
15:21:32 2883  	     );
15:21:32 2884  	     -- Cancel old charge
15:21:32 2885  	     PROCS_CHARGE_V18.UPDATE_CHARGE_STATUS(
15:21:32 2886  	       in_charge_id	   => f_open_charge.id,
15:21:32 2887  	       in_updated_by	   => in_updated_by,
15:21:32 2888  	       in_charge_status_id => GLOBAL_STATUSES_V18.CHARGE_CANCELED
15:21:32 2889  	     );
15:21:32 2890  
15:21:32 2891  	     PROCS_ADJUSTMENTS_V18.UPDATE_INVOICE_ADJUSTMENT(
15:21:32 2892  	       IN_INVOICE_ID => f_open_charge.invoice_id,
15:21:32 2893  	       IN_ORIGINAL_CHARGE_ID => f_open_charge.id,
15:21:32 2894  	       IN_CHARGE_ID => temp_out_charge_id,
15:21:32 2895  	       IN_UPDATED_BY => in_updated_by
15:21:32 2896  	     );
15:21:32 2897  
15:21:32 2898  	   END LOOP;
15:21:32 2899  	 END LOOP;
15:21:32 2900  
15:21:32 2901  EXCEPTION
15:21:32 2902  WHEN BAD_OLD_CC THEN
15:21:32 2903  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2904  	   SPROC_NAME, 'Trying to switch from non existing credit card');
15:21:32 2905  WHEN BAD_OLD_PP THEN
15:21:32 2906  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2907  	   SPROC_NAME, 'Trying to switch from non existing paypal');
15:21:32 2908  WHEN BAD_OLD_TYPE THEN
15:21:32 2909  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2910  	   SPROC_NAME, 'Trying to switch from unknown/unsupported financial instrument');
15:21:32 2911  WHEN BAD_NEW_CC THEN
15:21:32 2912  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2913  	   SPROC_NAME, 'Trying to switch to non existing credit card');
15:21:32 2914  WHEN BAD_NEW_PP THEN
15:21:32 2915  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2916  	   SPROC_NAME, 'Trying to switch to non existing paypal');
15:21:32 2917  WHEN BAD_NEW_TYPE THEN
15:21:32 2918  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 2919  	   SPROC_NAME, 'Trying to switch to unknown/unsupported financial instrument');
15:21:32 2920  WHEN DIFFERENT_OWNERS THEN
15:21:32 2921  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 2922  	   SPROC_NAME, 'Could not switch instrument, because owners are different');
15:21:32 2923  WHEN OTHERS THEN
15:21:32 2924  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 2925  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 2926  END SWITCH_FINANCIAL_INSTRUMENT;
15:21:32 2927  
15:21:32 2928  END PROCS_FIN_INSTRUMENTS_V18;
15:21:32 2929  .
15:21:32 SQL> /

Package body created.

Elapsed: 00:00:00.25
15:21:32 SQL> 
15:21:32 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_GROUP_ACCOUNT_V18" AS
15:21:32   2  
15:21:32   3  PROCEDURE UPDATE_SS_NEED_ENTITLEMENTS (
15:21:32   4  	in_sub_share_id      IN SUBSCRIPTION_SHARE.ID%TYPE,
15:21:32   5  	in_need_entitlements IN SUBSCRIPTION_SHARE.NEEDS_ENTITLEMENTS%TYPE,
15:21:32   6  	in_updater	     IN SUBSCRIPTION_SHARE.UPDATED_BY%TYPE
15:21:32   7  ) AS
15:21:32   8  SPROC_NAME CONSTANT VARCHAR2(32) := 'UPDATE_SS_NEED_ENTITLEMENTS';
15:21:32   9  BEGIN
15:21:32  10  	CORE_OWNER.PROCS_GROUP_ACCOUNT_CRU_V18.UPDATE_SUBSCRIPTION_SHARE (
15:21:32  11  	  in_id 		=> in_sub_share_id,
15:21:32  12  	  in_needs_entitlements => in_need_entitlements,
15:21:32  13  	  in_updated_by 	=> in_updater
15:21:32  14  	);
15:21:32  15  END UPDATE_SS_NEED_ENTITLEMENTS;
15:21:32  16  
15:21:32  17  PROCEDURE SUB_EXPIRES_NEED_ENTITLEMENTS (
15:21:32  18  	out_result_set OUT SYS_REFCURSOR
15:21:32  19  ) AS
15:21:32  20  SPROC_NAME CONSTANT VARCHAR2(32) := 'SUB_EXPIRES_NEED_ENTITLEMENTS';
15:21:32  21  BEGIN
15:21:32  22  	OPEN out_result_set FOR
15:21:32  23  	SELECT * FROM (
15:21:32  24  	  SELECT DISTINCT
15:21:32  25  	    ga.Subscription_Id,
15:21:32  26  	    A.Group_Id Borrower_Group_Id,
15:21:32  27  	    L.Offer_Id,
15:21:32  28  	    ss.id Subscription_Share_id
15:21:32  29  	  FROM
15:21:32  30  	    Subscription_Share Ss,
15:21:32  31  	    Group_Account Ga,
15:21:32  32  	    Account A,
15:21:32  33  	    License l
15:21:32  34  	  WHERE
15:21:32  35  	    Ss.Group_Account_Id        = ga.id
15:21:32  36  	    AND Ss.Needs_Entitlements  = GLOBAL_CONSTANTS_V18.TRUE
15:21:32  37  	    AND Ss.Borrower_Account_Id = A.Id
15:21:32  38  	    AND L.Subscription_Id      = Ga.Subscription_Id
15:21:32  39  	    AND ROWNUM <= 5000
15:21:32  40  	  ORDER BY dbms_random.value
15:21:32  41  ) WHERE
15:21:32  42  	ROWNUM <= 1000;
15:21:32  43  END SUB_EXPIRES_NEED_ENTITLEMENTS;
15:21:32  44  
15:21:32  45  PROCEDURE EXPIRE_SUB_SHARE(
15:21:32  46  	in_sub_share_id IN SUBSCRIPTION_SHARE.ID%TYPE,
15:21:32  47  	in_updater	IN SUBSCRIPTION_SHARE.UPDATED_BY%TYPE
15:21:32  48  ) AS
15:21:32  49  SPROC_NAME CONSTANT VARCHAR2(32) := 'EXPIRE_SUB_SHARE';
15:21:32  50  BEGIN
15:21:32  51  	CORE_OWNER.PROCS_GROUP_ACCOUNT_CRU_V18.UPDATE_SUBSCRIPTION_SHARE (
15:21:32  52  	  in_id 	=> in_sub_share_id,
15:21:32  53  	  in_end_date	=> SYSDATE,
15:21:32  54  	  in_updated_by => in_updater,
15:21:32  55  	  in_needs_entitlements => 1
15:21:32  56  	);
15:21:32  57  END EXPIRE_SUB_SHARE;
15:21:32  58  
15:21:32  59  PROCEDURE EXPIRE_ALL_SHARES (
15:21:32  60  	in_group_account_id IN SUBSCRIPTION_SHARE.GROUP_ACCOUNT_ID%TYPE,
15:21:32  61  	in_updated_by	    IN SUBSCRIPTION_SHARE.UPDATED_BY%TYPE
15:21:32  62  ) AS
15:21:32  63  SPROC_NAME CONSTANT VARCHAR2(28) := 'EXPIRE_ALL_SHARES';
15:21:32  64  BEGIN
15:21:32  65  	UPDATE SUBSCRIPTION_SHARE SET
15:21:32  66  	  END_DATE = SYSDATE,
15:21:32  67  	  UPDATED_BY = in_updated_by,
15:21:32  68  	  UPDATE_DATE = SYSDATE
15:21:32  69  	WHERE
15:21:32  70  	  GROUP_ACCOUNT_ID = in_group_account_id
15:21:32  71  	AND
15:21:32  72  	  SYSDATE < END_DATE;
15:21:32  73  EXCEPTION
15:21:32  74  	WHEN OTHERS THEN
15:21:32  75  	  PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32  76  	      SPROC_NAME, 'Unknown error while expiring subscription shares', SQLERRM);
15:21:32  77  END EXPIRE_ALL_SHARES;
15:21:32  78  
15:21:32  79  PROCEDURE SUB_SHARE_BY_GROUP_ID (
15:21:32  80  	in_group_id	 IN  ACCOUNT.GROUP_ID%TYPE,
15:21:32  81  	in_start	 IN  NUMBER,
15:21:32  82  	in_end		 IN  NUMBER,
15:21:32  83  	in_expired	 IN  NUMBER,
15:21:32  84  	out_result_set	 OUT SYS_REFCURSOR,
15:21:32  85  	out_shares_count OUT NUMBER
15:21:32  86  ) AS
15:21:32  87  SPROC_NAME CONSTANT VARCHAR2(32) := 'SUB_SHARE_BY_GROUP_ID';
15:21:32  88  range_diff NUMBER := 0;
15:21:32  89  upper_bond_diff NUMBER := 0;
15:21:32  90  l_start NUMBER := 0;
15:21:32  91  l_end   NUMBER := 0;
15:21:32  92  BEGIN
15:21:32  93  	--Normalize the end points [START]
15:21:32  94  	IF (in_start IS NULL OR in_start < 0) Then
15:21:32  95  	  l_start := 0;
15:21:32  96  	ELSE
15:21:32  97  	  l_start := in_start;
15:21:32  98  	END IF;
15:21:32  99  
15:21:32 100  	IF (in_end IS NULL) Then
15:21:32 101  	  l_end := 11;
15:21:32 102  	ELSE
15:21:32 103  	  l_end := in_end;
15:21:32 104  	END IF;
15:21:32 105  
15:21:32 106  	l_start := l_start + 1;
15:21:32 107  	l_end	:= l_end   + 1;
15:21:32 108  
15:21:32 109  	range_diff := l_end - l_start;
15:21:32 110  	upper_bond_diff :=  range_diff - GLOBAL_CONSTANTS_V18.MAX_RETURN_COUNT;
15:21:32 111  
15:21:32 112  	IF (upper_bond_diff > 0) Then
15:21:32 113  	  l_end := l_end - upper_bond_diff;
15:21:32 114  	END IF;
15:21:32 115  	--Normalize the end points [END]
15:21:32 116  
15:21:32 117  	BEGIN
15:21:32 118  	  SELECT
15:21:32 119  	    COUNT(1) INTO out_shares_count
15:21:32 120  	  FROM
15:21:32 121  	    GROUP_ACCOUNT ga,
15:21:32 122  	    SUBSCRIPTION_SHARE ss,
15:21:32 123  	    ACCOUNT a
15:21:32 124  	  WHERE
15:21:32 125  	    a.GROUP_ID		= in_group_id AND
15:21:32 126  	    a.Id		= ss.borrower_account_id And
15:21:32 127  	    ss.GROUP_ACCOUNT_ID = ga.ID;
15:21:32 128  	END;
15:21:32 129  
15:21:32 130  	IF in_expired > 0 THEN
15:21:32 131  	BEGIN
15:21:32 132  	    OPEN out_result_set FOR
15:21:32 133  	    SELECT
15:21:32 134  	      *
15:21:32 135  	    FROM
15:21:32 136  	      (SELECT rownum rnum, q.*
15:21:32 137  	       FROM
15:21:32 138  		(SELECT
15:21:32 139  		   ga.SUBSCRIPTION_ID,
15:21:32 140  		   ss.START_DATE,
15:21:32 141  		   ss.END_DATE,
15:21:32 142  		   a2.GROUP_ID AS PARENT_GROUP_ID
15:21:32 143  		 FROM
15:21:32 144  		   GROUP_ACCOUNT ga,
15:21:32 145  		   SUBSCRIPTION_SHARE ss,
15:21:32 146  		   ACCOUNT a,
15:21:32 147  		   SUBSCRIPTION s,
15:21:32 148  		   ACCOUNT a2
15:21:32 149  		 WHERE
15:21:32 150  		   a.GROUP_ID	       = in_group_id AND
15:21:32 151  		   a.ID 	       = ss.BORROWER_ACCOUNT_ID AND
15:21:32 152  		   ss.GROUP_ACCOUNT_ID = ga.ID	AND
15:21:32 153  		   ga.SUBSCRIPTION_ID  = s.ID AND
15:21:32 154  		   s.ACCOUNT_ID        = a2.ID
15:21:32 155  		) Q
15:21:32 156  	      WHERE rownum <= l_end)
15:21:32 157  	    WHERE rnum >= l_Start;
15:21:32 158  	END;
15:21:32 159  	ELSE
15:21:32 160  	BEGIN
15:21:32 161  	    OPEN out_result_set FOR
15:21:32 162  	    SELECT
15:21:32 163  	      *
15:21:32 164  	    FROM
15:21:32 165  	      (SELECT rownum rnum, q.*
15:21:32 166  	       FROM
15:21:32 167  		(SELECT
15:21:32 168  		   ga.SUBSCRIPTION_ID,
15:21:32 169  		   ss.START_DATE,
15:21:32 170  		   ss.END_DATE,
15:21:32 171  		   a2.GROUP_ID AS PARENT_GROUP_ID
15:21:32 172  		 FROM
15:21:32 173  		   GROUP_ACCOUNT ga,
15:21:32 174  		   SUBSCRIPTION_SHARE ss,
15:21:32 175  		   ACCOUNT a,
15:21:32 176  		   SUBSCRIPTION s,
15:21:32 177  		   ACCOUNT a2
15:21:32 178  		 WHERE
15:21:32 179  		   a.GROUP_ID	       = in_group_id AND
15:21:32 180  		   a.ID 	       = ss.BORROWER_ACCOUNT_ID AND
15:21:32 181  		   SYSDATE BETWEEN START_DATE AND END_DATE AND
15:21:32 182  		   ss.GROUP_ACCOUNT_ID = ga.ID AND
15:21:32 183  		   ga.SUBSCRIPTION_ID  = s.ID  AND
15:21:32 184  		   s.ACCOUNT_ID        = a2.ID
15:21:32 185  		) Q
15:21:32 186  	      WHERE rownum <= l_end)
15:21:32 187  	    WHERE rnum >= l_start;
15:21:32 188  	  END;
15:21:32 189  	END IF;
15:21:32 190  EXCEPTION
15:21:32 191  WHEN NO_DATA_FOUND THEN
15:21:32 192  	NULL;
15:21:32 193  WHEN OTHERS THEN
15:21:32 194  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 195  	  SPROC_NAME, 'Unknow error while retrieving subscription share info by group id', SQLERRM);
15:21:32 196  END SUB_SHARE_BY_GROUP_ID;
15:21:32 197  
15:21:32 198  PROCEDURE IS_VALID_IP_ADDRESS (
15:21:32 199  	in_group_account_id IN GROUP_ACCOUNT_IP_RANGE.GROUP_ACCOUNT_ID%TYPE,
15:21:32 200  	in_ip_low IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_LOW%TYPE,
15:21:32 201  	in_ip_high IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_HIGH%TYPE,
15:21:32 202  	out_is_valid	    OUT NUMBER
15:21:32 203  ) AS
15:21:32 204  SPROC_NAME CONSTANT VARCHAR2(32) := 'IS_VALID_IP_ADDRESS';
15:21:32 205  BEGIN
15:21:32 206  	SELECT
15:21:32 207  	  COUNT(1) INTO out_is_valid
15:21:32 208  	FROM
15:21:32 209  	  GROUP_ACCOUNT_IP_RANGE,
15:21:32 210  	  GROUP_ACCOUNT,
15:21:32 211  	  SUBSCRIPTION,
15:21:32 212  	  OFFER_CHAIN
15:21:32 213  	WHERE
15:21:32 214  	  GROUP_ACCOUNT.ID = GROUP_ACCOUNT_ID AND
15:21:32 215  	  GROUP_ACCOUNT.SUBSCRIPTION_ID = SUBSCRIPTION.ID AND
15:21:32 216  	  SUBSCRIPTION.OFFER_CHAIN_ID = OFFER_CHAIN.ID AND
15:21:32 217  	  OFFER_CHAIN.GROUP_ACCOUNT_TYPE_ID = 'GL' AND
15:21:32 218  	 GROUP_ACCOUNT_ID = in_group_account_id AND
15:21:32 219  	 (
15:21:32 220  	  (in_ip_high > minimum_ip_high and in_ip_high < maximum_ip_high) or
15:21:32 221  	  (in_ip_high = minimum_ip_high and (in_ip_low >= minimum_ip_low and in_ip_low <= maximum_ip_low)) or
15:21:32 222  	  (in_ip_high = maximum_ip_high and (in_ip_low >= minimum_ip_low and in_ip_low <= maximum_ip_low))
15:21:32 223  	 ) AND
15:21:32 224  	 GROUP_ACC_IP_RNG_STATUS_ID = GLOBAL_STATUSES_V18.GROUP_ACC_IP_RNG_ACTIVE;
15:21:32 225  EXCEPTION
15:21:32 226  WHEN OTHERS THEN
15:21:32 227  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 228  	  SPROC_NAME, 'Error while checking IP', SQLERRM);
15:21:32 229  END IS_VALID_IP_ADDRESS;
15:21:32 230  
15:21:32 231  PROCEDURE IS_VALID_EMAIL_DOMAIN (
15:21:32 232  	in_group_account_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
15:21:32 233  	in_email_domain     IN GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE,
15:21:32 234  	out_is_valid	    OUT NUMBER
15:21:32 235  ) AS
15:21:32 236  SPROC_NAME CONSTANT VARCHAR2(32) := 'IS_VALID_EMAIL_DOMAIN';
15:21:32 237  var_second_level_domain GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE;
15:21:32 238  var_third_level_domain GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE;
15:21:32 239  BEGIN
15:21:32 240  	var_second_level_domain := REGEXP_REPLACE(in_email_domain, '.*?([^\.]+\.[^\.]+)$', '\1');
15:21:32 241  	var_third_level_domain := REGEXP_REPLACE(in_email_domain, '.*?(([^\.]+\.){2}[^\.]+)$', '\1');
15:21:32 242  
15:21:32 243  	SELECT
15:21:32 244  	  COUNT(1) INTO out_is_valid
15:21:32 245  	FROM
15:21:32 246  	  GROUP_ACCOUNT_EMAIL_DOMAIN gaed,
15:21:32 247  	  GROUP_ACCOUNT ga,
15:21:32 248  	  SUBSCRIPTION s,
15:21:32 249  	  OFFER_CHAIN oc
15:21:32 250  	WHERE
15:21:32 251  	  ga.ID = gaed.GROUP_ACCOUNT_ID AND
15:21:32 252  	  ga.SUBSCRIPTION_ID = s.ID AND
15:21:32 253  	  s.OFFER_CHAIN_ID = oc.ID AND
15:21:32 254  	  oc.GROUP_ACCOUNT_TYPE_ID IN ('GL', 'KL') AND
15:21:32 255  	  gaed.GROUP_ACCOUNT_ID = in_group_account_id AND
15:21:32 256  	  (gaed.EMAIL_DOMAIN = var_third_level_domain OR gaed.EMAIL_DOMAIN = var_second_level_domain) AND
15:21:32 257  	  gaed.IS_ACTIVE = 1;
15:21:32 258  EXCEPTION
15:21:32 259  WHEN OTHERS THEN
15:21:32 260  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 261  	  SPROC_NAME, 'Error while checking email domain', SQLERRM);
15:21:32 262  END IS_VALID_EMAIL_DOMAIN;
15:21:32 263  
15:21:32 264  PROCEDURE GET_SUBSCRIPTION_SHARE (
15:21:32 265  	in_group_account_id    IN SUBSCRIPTION_SHARE.GROUP_ACCOUNT_ID%TYPE,
15:21:32 266  	In_Borrower_Account_Id In SUBSCRIPTION_SHARE.BORROWER_ACCOUNT_ID%Type,
15:21:32 267  	out_Result_Set	       OUT Sys_Refcursor
15:21:32 268  ) AS
15:21:32 269  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_SUBSCRIPTION_SHARE';
15:21:32 270  BEGIN
15:21:32 271  	BEGIN
15:21:32 272  	   OPEN out_result_set FOR
15:21:32 273  	   SELECT
15:21:32 274  	      ss.ID,
15:21:32 275  	      ss.GROUP_ACCOUNT_ID,
15:21:32 276  	      ss.BORROWER_ACCOUNT_ID,
15:21:32 277  	      ss.IP_ADDRESS,
15:21:32 278  	      ss.START_DATE,
15:21:32 279  	      ss.END_DATE,
15:21:32 280  	      ss.CREATED_BY,
15:21:32 281  	      ss.CREATE_DATE,
15:21:32 282  	      ss.UPDATED_BY,
15:21:32 283  	      ss.UPDATE_DATE,
15:21:32 284  	      a.GROUP_ID AS BORROWER_GROUP_ID
15:21:32 285  	   FROM
15:21:32 286  	     SUBSCRIPTION_SHARE ss,
15:21:32 287  	     ACCOUNT a
15:21:32 288  	   WHERE
15:21:32 289  	     ss.GROUP_ACCOUNT_ID    = in_group_account_id AND
15:21:32 290  	     ss.BORROWER_ACCOUNT_ID = in_borrower_account_id AND
15:21:32 291  	     SYSDATE BETWEEN ss.START_DATE AND END_DATE AND
15:21:32 292  	     ss.BORROWER_ACCOUNT_ID  = a.ID;
15:21:32 293  	END;
15:21:32 294  EXCEPTION
15:21:32 295  WHEN OTHERS THEN
15:21:32 296  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 297  	  Sproc_Name, 'Error while getting subscription share', Sqlerrm);
15:21:32 298  END GET_SUBSCRIPTION_SHARE;
15:21:32 299  
15:21:32 300  PROCEDURE GET_GROUP_ACCOUNT_BY_SUB_ID (
15:21:32 301  	in_subscription_id IN Group_Account.SUBSCRIPTION_ID%TYPE,
15:21:32 302  	out_result_set	   OUT SYS_REFCURSOR
15:21:32 303  ) As
15:21:32 304  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GROUP_ACCOUNT_BY_SUB_ID';
15:21:32 305  BEGIN
15:21:32 306  OPEN out_result_set FOR
15:21:32 307  	SELECT
15:21:32 308  	  ID,
15:21:32 309  	  SUBSCRIPTION_ID,
15:21:32 310  	  GROUP_NAME,
15:21:32 311  	  FIRST_NAME,
15:21:32 312  	  LAST_NAME,
15:21:32 313  	  EMAIL,
15:21:32 314  	  PHONE,
15:21:32 315  	  ORGANIZATION_TYPE,
15:21:32 316  	  SEATS,
15:21:32 317  	  SEAT_TTL_IN_HOURS,
15:21:32 318  	  CREATE_DATE,
15:21:32 319  	  CREATED_BY,
15:21:32 320  	  UPDATE_DATE,
15:21:32 321  	  UPDATED_BY
15:21:32 322  	FROM
15:21:32 323  	  GROUP_ACCOUNT
15:21:32 324  	Where
15:21:32 325  	  Subscription_Id = in_subscription_id;
15:21:32 326  EXCEPTION
15:21:32 327  WHEN OTHERS THEN
15:21:32 328  	Procs_Common_V18.Throw_Exception(APP_EXCEPTION_CODES_V18.Unknown_Error,
15:21:32 329  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 330  
15:21:32 331  END GET_GROUP_ACCOUNT_BY_SUB_ID;
15:21:32 332  
15:21:32 333  PROCEDURE CREATE_GROUP_ACCOUNT (
15:21:32 334  	in_subscription_id	 IN NUMBER,
15:21:32 335  	in_group_name		 IN VARCHAR2,
15:21:32 336  	in_first_name		 IN VARCHAR2,
15:21:32 337  	in_last_name		 IN VARCHAR2,
15:21:32 338  	in_email		 IN VARCHAR2,
15:21:32 339  	in_phone		 IN VARCHAR2,
15:21:32 340  	in_organization_type	 IN VARCHAR2,
15:21:32 341  	in_seats		 IN NUMBER,
15:21:32 342  	in_seat_ttl_in_hours	 IN NUMBER,
15:21:32 343  	in_ip			 IN NUMBER,
15:21:32 344  	in_created_by		 IN VARCHAR2
15:21:32 345  ) AS
15:21:32 346  SPROC_NAME CONSTANT VARCHAR2(32) := 'CREATE_GROUP_ACCOUNT';
15:21:32 347  BEGIN
15:21:32 348  
15:21:32 349  	CORE_OWNER.PROCS_GROUP_ACCOUNT_CRU_V18.CREATE_GROUP_ACCOUNT(
15:21:32 350  	  in_subscription_id => in_subscription_id,
15:21:32 351  	  in_group_name => in_group_name,
15:21:32 352  	  in_first_name => in_first_name,
15:21:32 353  	  in_last_name => in_last_name,
15:21:32 354  	  in_email => in_email,
15:21:32 355  	  in_phone => in_phone,
15:21:32 356  	  in_organization_type => in_organization_type,
15:21:32 357  	  in_seats => in_seats,
15:21:32 358  	  in_seat_ttl_in_hours => in_seat_ttl_in_hours,
15:21:32 359  	  in_ip => in_ip,
15:21:32 360  	  in_created_by => in_created_by
15:21:32 361  	);
15:21:32 362  
15:21:32 363  END CREATE_GROUP_ACCOUNT;
15:21:32 364  
15:21:32 365  PROCEDURE GET_SUBSCRIPTION_SHARES (
15:21:32 366  	in_group_account_id IN NUMBER,
15:21:32 367  	in_start	    IN NUMBER,
15:21:32 368  	in_end		    IN NUMBER,
15:21:32 369  	out_Result_Set	    OUT Sys_Refcursor
15:21:32 370  ) AS
15:21:32 371  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_SUBSCRIPTION_SHARES';
15:21:32 372  range_diff NUMBER := 0;
15:21:32 373  upper_bond_diff NUMBER := 0;
15:21:32 374  l_start NUMBER := 0;
15:21:32 375  l_end   NUMBER := 0;
15:21:32 376  BEGIN
15:21:32 377  	-- Normalize the end points [START]
15:21:32 378  	IF (in_start IS NULL OR in_start < 0) Then
15:21:32 379  	  l_start := 0;
15:21:32 380  	ELSE
15:21:32 381  	  l_start := in_start;
15:21:32 382  	END IF;
15:21:32 383  
15:21:32 384  	IF (in_end IS NULL) Then
15:21:32 385  	  l_end := 11;
15:21:32 386  	ELSE
15:21:32 387  	  l_end := in_end;
15:21:32 388  	END IF;
15:21:32 389  
15:21:32 390  	l_start := l_start + 1;
15:21:32 391  	l_end	:= l_end   + 1;
15:21:32 392  
15:21:32 393  	range_diff := l_end - l_start;
15:21:32 394  	upper_bond_diff :=  range_diff - GLOBAL_CONSTANTS_V18.MAX_RETURN_COUNT;
15:21:32 395  
15:21:32 396  	IF (upper_bond_diff > 0) Then
15:21:32 397  	  l_end := l_end - upper_bond_diff;
15:21:32 398  	END IF;
15:21:32 399  	-- Normalize the end points [END]
15:21:32 400  
15:21:32 401  	BEGIN
15:21:32 402  	   OPEN out_result_set FOR
15:21:32 403  	   SELECT *
15:21:32 404  	   FROM
15:21:32 405  	     (SELECT rownum rnum, Q.*
15:21:32 406  	      FROM
15:21:32 407  	       (SELECT
15:21:32 408  		  ss.ID,
15:21:32 409  		  ss.GROUP_ACCOUNT_ID,
15:21:32 410  		  ss.BORROWER_ACCOUNT_ID,
15:21:32 411  		  ss.IP_ADDRESS,
15:21:32 412  		  ss.START_DATE,
15:21:32 413  		  ss.END_DATE,
15:21:32 414  		  ss.CREATED_BY,
15:21:32 415  		  ss.CREATE_DATE,
15:21:32 416  		  ss.UPDATED_BY,
15:21:32 417  		  ss.UPDATE_DATE,
15:21:32 418  		  a.GROUP_ID AS BORROWER_GROUP_ID
15:21:32 419  		FROM
15:21:32 420  		  SUBSCRIPTION_SHARE ss,
15:21:32 421  		  ACCOUNT a,
15:21:32 422  		  LICENSE l,
15:21:32 423  		  GROUP_ACCOUNT ga
15:21:32 424  		WHERE
15:21:32 425  		  ss.GROUP_ACCOUNT_ID = in_group_account_id AND
15:21:32 426  		  ss.GROUP_ACCOUNT_ID = ga.ID AND
15:21:32 427  		  GA.SUBSCRIPTION_ID = l.SUBSCRIPTION_ID AND
15:21:32 428  		  SYSDATE BETWEEN l.START_DATE AND l.ENTITLEMENT_END_DATE AND
15:21:32 429  		  SYSDATE BETWEEN ss.START_DATE AND ss.END_DATE AND
15:21:32 430  		  ss.BORROWER_ACCOUNT_ID  = a.ID
15:21:32 431  	      ) Q
15:21:32 432  	    WHERE rownum <= l_end)
15:21:32 433  	  WHERE rnum >= l_start;
15:21:32 434  	END;
15:21:32 435  EXCEPTION
15:21:32 436  WHEN OTHERS THEN
15:21:32 437  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 438  	  SPROC_NAME, 'Unknown error while retrieving subscription shares', SQLERRM);
15:21:32 439  END GET_SUBSCRIPTION_SHARES;
15:21:32 440  
15:21:32 441  PROCEDURE GET_GROUP_ACCOUNT_BY_IP (
15:21:32 442  	in_ip_low	    IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_LOW%TYPE,
15:21:32 443  	in_ip_high	    IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_HIGH%TYPE,
15:21:32 444  	out_result_set	      OUT SYS_REFCURSOR
15:21:32 445  ) AS
15:21:32 446  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GROUP_ACCOUNT_BY_IP';
15:21:32 447  BEGIN
15:21:32 448  	BEGIN
15:21:32 449  	  OPEN out_result_set FOR
15:21:32 450  	  SELECT
15:21:32 451  	    ID,
15:21:32 452  	    SUBSCRIPTION_ID,
15:21:32 453  	    GROUP_NAME,
15:21:32 454  	    FIRST_NAME,
15:21:32 455  	    LAST_NAME,
15:21:32 456  	    EMAIL,
15:21:32 457  	    PHONE,
15:21:32 458  	    ORGANIZATION_TYPE,
15:21:32 459  	    SEATS,
15:21:32 460  	    SEAT_TTL_IN_HOURS,
15:21:32 461  	    CREATE_DATE,
15:21:32 462  	    CREATED_BY,
15:21:32 463  	    UPDATE_DATE,
15:21:32 464  	    UPDATED_BY
15:21:32 465  	  FROM
15:21:32 466  	    GROUP_ACCOUNT
15:21:32 467  	  WHERE
15:21:32 468  	    ID IN (
15:21:32 469  	      SELECT
15:21:32 470  		GROUP_ACCOUNT_ID
15:21:32 471  	      FROM
15:21:32 472  		GROUP_ACCOUNT_IP_RANGE,
15:21:32 473  		GROUP_ACCOUNT,
15:21:32 474  		SUBSCRIPTION,
15:21:32 475  		OFFER_CHAIN
15:21:32 476  	      WHERE
15:21:32 477  		GROUP_ACCOUNT.ID = GROUP_ACCOUNT_ID
15:21:32 478  	      AND
15:21:32 479  		GROUP_ACCOUNT.SUBSCRIPTION_ID = SUBSCRIPTION.ID AND
15:21:32 480  		SUBSCRIPTION.OFFER_CHAIN_ID = OFFER_CHAIN.ID AND
15:21:32 481  		OFFER_CHAIN.GROUP_ACCOUNT_TYPE_ID = 'GL'
15:21:32 482  	      AND
15:21:32 483  		(
15:21:32 484  		  (in_ip_high > minimum_ip_high and in_ip_high < maximum_ip_high) or
15:21:32 485  		  (in_ip_high = minimum_ip_high and (in_ip_low >= minimum_ip_low and in_ip_low <= maximum_ip_low)) or
15:21:32 486  		  (in_ip_high = maximum_ip_high and (in_ip_low >= minimum_ip_low and in_ip_low <= maximum_ip_low))
15:21:32 487  		)
15:21:32 488  	      AND
15:21:32 489  		GROUP_ACC_IP_RNG_STATUS_ID = GLOBAL_STATUSES_V18.GROUP_ACC_IP_RNG_ACTIVE
15:21:32 490  	    );
15:21:32 491  	  END;
15:21:32 492  EXCEPTION
15:21:32 493  WHEN OTHERS THEN
15:21:32 494  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 495  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 496  END GET_GROUP_ACCOUNT_BY_IP;
15:21:32 497  
15:21:32 498  PROCEDURE GET_GROUP_ACCOUNT_BY_EMAIL (
15:21:32 499  	in_email_domain     IN GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE,
15:21:32 500  	out_result_set	    OUT SYS_REFCURSOR
15:21:32 501  ) AS
15:21:32 502  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GROUP_ACCOUNT_BY_EMAIL';
15:21:32 503  var_second_level_domain GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE;
15:21:32 504  var_third_level_domain GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE;
15:21:32 505  BEGIN
15:21:32 506  	var_second_level_domain := REGEXP_REPLACE(in_email_domain, '.*?([^\.]+\.[^\.]+)$', '\1');
15:21:32 507  	var_third_level_domain := REGEXP_REPLACE(in_email_domain, '.*?(([^\.]+\.){2}[^\.]+)$', '\1');
15:21:32 508  	BEGIN
15:21:32 509  	  OPEN out_result_set FOR
15:21:32 510  	  SELECT
15:21:32 511  	    ID,
15:21:32 512  	    SUBSCRIPTION_ID,
15:21:32 513  	    GROUP_NAME,
15:21:32 514  	    FIRST_NAME,
15:21:32 515  	    LAST_NAME,
15:21:32 516  	    EMAIL,
15:21:32 517  	    PHONE,
15:21:32 518  	    ORGANIZATION_TYPE,
15:21:32 519  	    SEATS,
15:21:32 520  	    SEAT_TTL_IN_HOURS,
15:21:32 521  	    CREATE_DATE,
15:21:32 522  	    CREATED_BY,
15:21:32 523  	    UPDATE_DATE,
15:21:32 524  	    UPDATED_BY
15:21:32 525  	  FROM
15:21:32 526  	    GROUP_ACCOUNT
15:21:32 527  	  WHERE
15:21:32 528  	    ID IN (
15:21:32 529  	      SELECT
15:21:32 530  		GROUP_ACCOUNT_ID
15:21:32 531  	      FROM
15:21:32 532  		GROUP_ACCOUNT_EMAIL_DOMAIN gaed,
15:21:32 533  		GROUP_ACCOUNT ga,
15:21:32 534  		SUBSCRIPTION s,
15:21:32 535  		OFFER_CHAIN oc
15:21:32 536  	      WHERE
15:21:32 537  		ga.ID = gaed.GROUP_ACCOUNT_ID AND
15:21:32 538  		ga.SUBSCRIPTION_ID = s.ID AND
15:21:32 539  		s.OFFER_CHAIN_ID = oc.ID AND
15:21:32 540  		oc.GROUP_ACCOUNT_TYPE_ID in ('GL', 'KL') AND
15:21:32 541  		(gaed.EMAIL_DOMAIN = var_third_level_domain OR gaed.EMAIL_DOMAIN = var_second_level_domain) AND
15:21:32 542  		gaed.IS_ACTIVE = 1
15:21:32 543  	    );
15:21:32 544  	  END;
15:21:32 545  EXCEPTION
15:21:32 546  WHEN OTHERS THEN
15:21:32 547  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 548  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 549  END GET_GROUP_ACCOUNT_BY_EMAIL;
15:21:32 550  
15:21:32 551  PROCEDURE GET_GROUP_ACCOUNT_IP_RANGES (
15:21:32 552  	in_group_account_id   IN NUMBER,
15:21:32 553  	in_start	      IN NUMBER,
15:21:32 554  	in_end		      IN NUMBER,
15:21:32 555  	in_status	      IN NUMBER,
15:21:32 556  	out_record_count      OUT NUMBER,
15:21:32 557  	out_result_set	      OUT SYS_REFCURSOR
15:21:32 558  ) AS
15:21:32 559  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GROUP_ACCOUNT_IP_RANGES';
15:21:32 560  range_diff NUMBER := 0;
15:21:32 561  upper_bond_diff NUMBER := 0;
15:21:32 562  l_start NUMBER := 0;
15:21:32 563  l_end   NUMBER := 0;
15:21:32 564  BEGIN
15:21:32 565  	--Normalize the end points [START]
15:21:32 566  	IF (in_start IS NULL OR in_start < 0) Then
15:21:32 567  	  l_start := 0;
15:21:32 568  	ELSE
15:21:32 569  	  l_start := in_start;
15:21:32 570  	END IF;
15:21:32 571  
15:21:32 572  	IF (in_end IS NULL) Then
15:21:32 573  	  l_end := 11;
15:21:32 574  	ELSE
15:21:32 575  	  l_end := in_end;
15:21:32 576  	END IF;
15:21:32 577  
15:21:32 578  	l_start := l_start + 1;
15:21:32 579  	l_end	:= l_end   + 1;
15:21:32 580  
15:21:32 581  	range_diff := l_end - l_start;
15:21:32 582  	upper_bond_diff :=  range_diff - GLOBAL_CONSTANTS_V18.MAX_RETURN_COUNT;
15:21:32 583  
15:21:32 584  	IF (upper_bond_diff > 0) Then
15:21:32 585  	  l_end := l_end - upper_bond_diff;
15:21:32 586  	END IF;
15:21:32 587  	--Normalize the end points [END]
15:21:32 588  
15:21:32 589  	--Total count of records [START]
15:21:32 590  	SELECT
15:21:32 591  	  COUNT(1) INTO out_record_count
15:21:32 592  	FROM
15:21:32 593  	  GROUP_ACCOUNT_IP_RANGE
15:21:32 594  	WHERE
15:21:32 595  	  GROUP_ACCOUNT_ID = in_group_account_id AND
15:21:32 596  	  (in_status IS NULL OR GROUP_ACC_IP_RNG_STATUS_ID = in_status);
15:21:32 597  	--Total count of records [END]
15:21:32 598  
15:21:32 599  	OPEN out_result_set FOR
15:21:32 600  	SELECT
15:21:32 601  	  *
15:21:32 602  	FROM
15:21:32 603  	  (SELECT rownum rnum, q.*
15:21:32 604  	   FROM
15:21:32 605  	    (SELECT
15:21:32 606  	       ID,
15:21:32 607  	       GROUP_ACCOUNT_ID,
15:21:32 608  	       MINIMUM_IP_STRING,
15:21:32 609  	       MAXIMUM_IP_STRING,
15:21:32 610  	       GROUP_ACC_IP_RNG_STATUS_ID
15:21:32 611  	     FROM
15:21:32 612  	       GROUP_ACCOUNT_IP_RANGE
15:21:32 613  	     WHERE
15:21:32 614  	       GROUP_ACCOUNT_ID = in_group_account_id AND
15:21:32 615  	       (in_status IS NULL OR
15:21:32 616  		GROUP_ACC_IP_RNG_STATUS_ID = in_status)
15:21:32 617  	    ) Q
15:21:32 618  	  WHERE rownum <= l_end)
15:21:32 619  	WHERE rnum >= l_Start;
15:21:32 620  EXCEPTION
15:21:32 621  WHEN OTHERS THEN
15:21:32 622  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 623  	  SPROC_NAME, 'Unknown error while retrieving IP ranges ', SQLERRM);
15:21:32 624  END GET_GROUP_ACCOUNT_IP_RANGES;
15:21:32 625  
15:21:32 626  PROCEDURE GET_GRP_ACCNT_EMAIL_DOMAINS (
15:21:32 627  	in_group_account_id   IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
15:21:32 628  	in_start	      IN NUMBER,
15:21:32 629  	in_end		      IN NUMBER,
15:21:32 630  	in_status	      IN GROUP_ACCOUNT_EMAIL_DOMAIN.IS_ACTIVE%TYPE,
15:21:32 631  	out_record_count      OUT NUMBER,
15:21:32 632  	out_result_set	      OUT SYS_REFCURSOR
15:21:32 633  ) AS
15:21:32 634  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GRP_ACCNT_EMAIL_DOMAINS';
15:21:32 635  range_diff NUMBER := 0;
15:21:32 636  upper_bond_diff NUMBER := 0;
15:21:32 637  l_start NUMBER := 0;
15:21:32 638  l_end   NUMBER := 0;
15:21:32 639  BEGIN
15:21:32 640  	--Normalize the end points [START]
15:21:32 641  	IF (in_start IS NULL OR in_start < 0) Then
15:21:32 642  	  l_start := 0;
15:21:32 643  	ELSE
15:21:32 644  	  l_start := in_start;
15:21:32 645  	END IF;
15:21:32 646  
15:21:32 647  	IF (in_end IS NULL) Then
15:21:32 648  	  l_end := 11;
15:21:32 649  	ELSE
15:21:32 650  	  l_end := in_end;
15:21:32 651  	END IF;
15:21:32 652  
15:21:32 653  	l_start := l_start + 1;
15:21:32 654  	l_end	:= l_end   + 1;
15:21:32 655  
15:21:32 656  	range_diff := l_end - l_start;
15:21:32 657  	upper_bond_diff :=  range_diff - GLOBAL_CONSTANTS_V18.MAX_RETURN_COUNT;
15:21:32 658  
15:21:32 659  	IF (upper_bond_diff > 0) Then
15:21:32 660  	  l_end := l_end - upper_bond_diff;
15:21:32 661  	END IF;
15:21:32 662  	--Normalize the end points [END]
15:21:32 663  
15:21:32 664  	--Total count of records [START]
15:21:32 665  	SELECT
15:21:32 666  	  COUNT(1) INTO out_record_count
15:21:32 667  	FROM
15:21:32 668  	  GROUP_ACCOUNT_EMAIL_DOMAIN
15:21:32 669  	WHERE
15:21:32 670  	  GROUP_ACCOUNT_ID = in_group_account_id AND
15:21:32 671  	  (IS_ACTIVE IS NULL OR IS_ACTIVE = in_status);
15:21:32 672  	--Total count of records [END]
15:21:32 673  
15:21:32 674  	OPEN out_result_set FOR
15:21:32 675  	SELECT
15:21:32 676  	  *
15:21:32 677  	FROM
15:21:32 678  	  (SELECT rownum rnum, q.*
15:21:32 679  	   FROM
15:21:32 680  	    (SELECT
15:21:32 681  	      ID,
15:21:32 682  	      GROUP_ACCOUNT_ID,
15:21:32 683  	      EMAIL_DOMAIN,
15:21:32 684  	      IS_ACTIVE
15:21:32 685  	     FROM
15:21:32 686  	       GROUP_ACCOUNT_EMAIL_DOMAIN
15:21:32 687  	     WHERE
15:21:32 688  	       GROUP_ACCOUNT_ID = in_group_account_id AND
15:21:32 689  	       (in_status IS NULL OR
15:21:32 690  		IS_ACTIVE = in_status)
15:21:32 691  	    ) Q
15:21:32 692  	  WHERE rownum <= l_end)
15:21:32 693  	WHERE rnum >= l_Start;
15:21:32 694  
15:21:32 695  EXCEPTION
15:21:32 696  WHEN OTHERS THEN
15:21:32 697  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 698  	  SPROC_NAME, 'Unknown error while retrieving Email Domains ', SQLERRM);
15:21:32 699  END GET_GRP_ACCNT_EMAIL_DOMAINS;
15:21:32 700  
15:21:32 701  PROCEDURE DISABLE_EMAIL_DOMAIN_BY_GA_ID (
15:21:32 702  	in_group_account_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
15:21:32 703  	in_updated_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.UPDATED_BY%TYPE
15:21:32 704  ) AS
15:21:32 705  SPROC_NAME CONSTANT VARCHAR2(32) := 'DISABLE_EMAIL_DOMAIN_BY_GA_ID';
15:21:32 706  BEGIN
15:21:32 707  	  PROCS_GROUP_ACCOUNT_CRU_V18.DISABLE_EMAIL_DOMAIN_BY_GA_ID(
15:21:32 708  	    in_group_account_id => in_group_account_id,
15:21:32 709  	    in_updated_by => in_updated_by
15:21:32 710  	  );
15:21:32 711  EXCEPTION
15:21:32 712  WHEN OTHERS THEN
15:21:32 713  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 714  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 715  END DISABLE_EMAIL_DOMAIN_BY_GA_ID;
15:21:32 716  
15:21:32 717  PROCEDURE DISABLE_EMAIL_DOMAIN_BY_ID (
15:21:32 718  	in_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.ID%TYPE,
15:21:32 719  	in_updated_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.UPDATED_BY%TYPE
15:21:32 720  ) AS
15:21:32 721  SPROC_NAME CONSTANT VARCHAR2(32) := 'DISABLE_EMAIL_DOMAIN_BY_ID';
15:21:32 722  BEGIN
15:21:32 723  	  PROCS_GROUP_ACCOUNT_CRU_V18.DISABLE_EMAIL_DOMAIN_BY_ID(
15:21:32 724  	    in_id => in_id,
15:21:32 725  	    in_updated_by => in_updated_by
15:21:32 726  	  );
15:21:32 727  EXCEPTION
15:21:32 728  WHEN OTHERS THEN
15:21:32 729  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 730  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 731  END DISABLE_EMAIL_DOMAIN_BY_ID;
15:21:32 732  
15:21:32 733  PROCEDURE ADD_EMAIL_DOMAIN (
15:21:32 734  	in_group_account_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
15:21:32 735  	in_email_domain IN GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE,
15:21:32 736  	in_created_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.CREATED_BY%TYPE
15:21:32 737  ) AS
15:21:32 738  SPROC_NAME CONSTANT VARCHAR2(32) := 'ADD_EMAIL_DOMAIN';
15:21:32 739  var_ga_type OFFER_CHAIN.GROUP_ACCOUNT_TYPE_ID%TYPE;
15:21:32 740  var_is_dupe NUMBER(1);
15:21:32 741  var_group_account_count NUMBER := 0;
15:21:32 742  var_id  GROUP_ACCOUNT_EMAIL_DOMAIN.ID%TYPE;
15:21:32 743  NOT_GL EXCEPTION;
15:21:32 744  DUPE EXCEPTION;
15:21:32 745  BEGIN
15:21:32 746  	  SELECT OFFER_CHAIN.GROUP_ACCOUNT_TYPE_ID into var_ga_type
15:21:32 747  	  FROM
15:21:32 748  	    GROUP_ACCOUNT,
15:21:32 749  	    SUBSCRIPTION,
15:21:32 750  	    OFFER_CHAIN
15:21:32 751  	  WHERE
15:21:32 752  	    GROUP_ACCOUNT.ID = in_group_account_id AND
15:21:32 753  	    GROUP_ACCOUNT.SUBSCRIPTION_ID = SUBSCRIPTION.ID AND
15:21:32 754  	    SUBSCRIPTION.OFFER_CHAIN_ID = OFFER_CHAIN.ID
15:21:32 755  	  ;
15:21:32 756  	  IF(var_ga_type != 'GL' and var_ga_type != 'KL' ) THEN
15:21:32 757  	    RAISE NOT_GL;
15:21:32 758  	  END IF;
15:21:32 759  
15:21:32 760  	  --check if email domain already exists
15:21:32 761  	  SELECT count(1) into var_group_account_count
15:21:32 762  	  FROM
15:21:32 763  	      GROUP_ACCOUNT_EMAIL_DOMAIN
15:21:32 764  	  WHERE
15:21:32 765  	      GROUP_ACCOUNT_ID= in_group_account_id AND
15:21:32 766  	      EMAIL_DOMAIN = in_email_domain
15:21:32 767  	  ;
15:21:32 768  
15:21:32 769  	  IF(var_group_account_count > 0) THEN
15:21:32 770  	      SELECT ID into var_id
15:21:32 771  	      FROM
15:21:32 772  		  GROUP_ACCOUNT_EMAIL_DOMAIN
15:21:32 773  	      WHERE
15:21:32 774  		  GROUP_ACCOUNT_ID= in_group_account_id AND
15:21:32 775  		  EMAIL_DOMAIN = in_email_domain AND
15:21:32 776  		  rownum <= 1;
15:21:32 777  	      PROCS_GROUP_ACCOUNT_CRU_V18.ENABLE_EMAIL_DOMAIN_BY_ID(
15:21:32 778  		  in_id => var_id,
15:21:32 779  		  in_updated_by => in_created_by
15:21:32 780  		  );
15:21:32 781  	  ELSE
15:21:32 782  	      PROCS_GROUP_ACCOUNT_CRU_V18.ADD_EMAIL_DOMAIN(
15:21:32 783  		  in_group_account_id => in_group_account_id,
15:21:32 784  		  in_email_domain => in_email_domain,
15:21:32 785  		      in_is_active => GLOBAL_STATUSES_V18.GROUP_ACC_EMAIL_DOMAIN_ACT,
15:21:32 786  		  in_created_by => in_created_by
15:21:32 787  	      );
15:21:32 788  	  END IF;
15:21:32 789  
15:21:32 790  EXCEPTION
15:21:32 791  WHEN NOT_GL THEN
15:21:32 792  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 793  	  SPROC_NAME, 'Group account type does not support Email Domains', SQLERRM);
15:21:32 794  WHEN OTHERS THEN
15:21:32 795  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 796  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 797  END ADD_EMAIL_DOMAIN;
15:21:32 798  
15:21:32 799  PROCEDURE CREATE_SUBSCRIPTION_SHARE (
15:21:32 800  	in_group_account_id    IN NUMBER,
15:21:32 801  	in_borrower_account_id IN NUMBER,
15:21:32 802  	in_ip_address	       IN VARCHAR2,
15:21:32 803  	in_email_domain        IN VARCHAR2,
15:21:32 804  	in_created_by	       IN VARCHAR2
15:21:32 805  ) AS
15:21:32 806  SPROC_NAME CONSTANT VARCHAR2(32) := 'CREATE_SUBSCRIPTION_SHARE';
15:21:32 807  ga_ttl_in_hours NUMBER := NULL;
15:21:32 808  start_date DATE := NULL;
15:21:32 809  end_date DATE := NULL;
15:21:32 810  BEGIN
15:21:32 811  	start_date := sysdate;
15:21:32 812  	end_date   := GLOBAL_CONSTANTS_V18.MAX_DATE;
15:21:32 813  
15:21:32 814  	BEGIN
15:21:32 815  	  SELECT SEAT_TTL_IN_HOURS into ga_ttl_in_hours
15:21:32 816  	  FROM GROUP_ACCOUNT, SUBSCRIPTION, OFFER_CHAIN
15:21:32 817  	  WHERE GROUP_ACCOUNT.ID = in_group_account_id AND
15:21:32 818  		GROUP_ACCOUNT.SUBSCRIPTION_ID = SUBSCRIPTION.ID AND
15:21:32 819  		SUBSCRIPTION.OFFER_CHAIN_ID = OFFER_CHAIN.ID AND
15:21:32 820  		OFFER_CHAIN.GROUP_ACCOUNT_TYPE_ID in ('GL', 'KL');
15:21:32 821  	EXCEPTION
15:21:32 822  	  WHEN no_data_found THEN
15:21:32 823  	    ga_ttl_in_hours := NULL;
15:21:32 824  	END;
15:21:32 825  
15:21:32 826  	IF (ga_ttl_in_hours IS NOT NULL) THEN
15:21:32 827  	  end_date := (start_date + (1/24 * ga_ttl_in_hours));
15:21:32 828  	END IF;
15:21:32 829  
15:21:32 830  	CORE_OWNER.PROCS_GROUP_ACCOUNT_CRU_V18.CREATE_SUBSCRIPTION_SHARE(
15:21:32 831  	  in_group_account_id => in_group_account_id,
15:21:32 832  	  in_borrower_account_id => in_borrower_account_id,
15:21:32 833  	  in_ip_address => in_ip_address,
15:21:32 834  	  in_email_domain => in_email_domain,
15:21:32 835  	  in_start_date => start_date,
15:21:32 836  	  in_end_date => end_date,
15:21:32 837  	  in_created_by => in_created_by
15:21:32 838  	);
15:21:32 839  END CREATE_SUBSCRIPTION_SHARE;
15:21:32 840  
15:21:32 841  
15:21:32 842  PROCEDURE GET_NUM_OCCUPIED_GROUP_SEATS (
15:21:32 843  	in_group_account_id   IN NUMBER,
15:21:32 844  	out_occupied_seats   OUT NUMBER
15:21:32 845  ) AS
15:21:32 846  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_NUM_OCCUPIED_GROUP_SEATS';
15:21:32 847  BEGIN
15:21:32 848  	SELECT
15:21:32 849  	  PROCS_GROUP_ACCOUNT_V18.F_GET_NUM_OCCUPIED_GROUP_SEATS(in_group_account_id) INTO out_occupied_seats
15:21:32 850  	FROM dual;
15:21:32 851  EXCEPTION
15:21:32 852  WHEN OTHERS THEN
15:21:32 853  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 854  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 855  END GET_NUM_OCCUPIED_GROUP_SEATS;
15:21:32 856  
15:21:32 857  
15:21:32 858  FUNCTION F_GET_NUM_OCCUPIED_GROUP_SEATS (
15:21:32 859  	in_group_account_id   IN NUMBER
15:21:32 860  ) RETURN NUMBER IS
15:21:32 861  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_NUM_OCCUPIED_GROUP_SEATS';
15:21:32 862  num_seats NUMBER;
15:21:32 863  BEGIN
15:21:32 864  	SELECT
15:21:32 865  	  COUNT(1) INTO num_seats
15:21:32 866  	FROM
15:21:32 867  	  SUBSCRIPTION_SHARE
15:21:32 868  	WHERE
15:21:32 869  	  GROUP_ACCOUNT_ID = in_group_account_id AND
15:21:32 870  	  SYSDATE BETWEEN START_DATE AND END_DATE;
15:21:32 871  	RETURN num_seats;
15:21:32 872  EXCEPTION
15:21:32 873  WHEN OTHERS THEN
15:21:32 874  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 875  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 876  END F_GET_NUM_OCCUPIED_GROUP_SEATS;
15:21:32 877  
15:21:32 878  -- *********************************************************************
15:21:32 879  -- *************** GROUP ACCOUNT IP RANGE JUNK *************************
15:21:32 880  -- *********************************************************************
15:21:32 881  -- I'm debating if this should be in a different package, but right now
15:21:32 882  -- I'm too lazy to move this else where.
15:21:32 883  -- *********************************************************************
15:21:32 884  
15:21:32 885  PROCEDURE DISABLE_IP_RANGES_BY_GA_ID (
15:21:32 886  	in_group_account_id IN GROUP_ACCOUNT_IP_RANGE.GROUP_ACCOUNT_ID%TYPE,
15:21:32 887  	in_updated_by IN GROUP_ACCOUNT_IP_RANGE.UPDATED_BY%TYPE
15:21:32 888  ) AS
15:21:32 889  SPROC_NAME CONSTANT VARCHAR2(32) := 'DISABLE_IP_RANGES_BY_GA_ID';
15:21:32 890  BEGIN
15:21:32 891  	  PROCS_GROUP_ACCOUNT_CRU_V18.DISABLE_IP_RANGES_BY_GA_ID(
15:21:32 892  	    in_group_account_id => in_group_account_id,
15:21:32 893  	    in_updated_by => in_updated_by
15:21:32 894  	  );
15:21:32 895  EXCEPTION
15:21:32 896  WHEN OTHERS THEN
15:21:32 897  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 898  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 899  END DISABLE_IP_RANGES_BY_GA_ID;
15:21:32 900  
15:21:32 901  PROCEDURE DISABLE_IP_RANGE_BY_ID (
15:21:32 902  	in_id IN GROUP_ACCOUNT_IP_RANGE.ID%TYPE,
15:21:32 903  	in_updated_by IN GROUP_ACCOUNT_IP_RANGE.UPDATED_BY%TYPE
15:21:32 904  ) AS
15:21:32 905  SPROC_NAME CONSTANT VARCHAR2(32) := 'DISABLE_IP_RANGE_BY_ID';
15:21:32 906  BEGIN
15:21:32 907  	  PROCS_GROUP_ACCOUNT_CRU_V18.DISABLE_IP_RANGE_BY_ID(
15:21:32 908  	    in_id => in_id,
15:21:32 909  	    in_updated_by => in_updated_by
15:21:32 910  	  );
15:21:32 911  EXCEPTION
15:21:32 912  WHEN OTHERS THEN
15:21:32 913  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 914  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 915  END DISABLE_IP_RANGE_BY_ID;
15:21:32 916  
15:21:32 917  PROCEDURE ADD_IP_RANGE (
15:21:32 918  	in_group_account_id IN GROUP_ACCOUNT_IP_RANGE.GROUP_ACCOUNT_ID%TYPE,
15:21:32 919  	in_minimum_ip_string IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_STRING%TYPE,
15:21:32 920  	in_minimum_ip_low IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_LOW%TYPE,
15:21:32 921  	in_minimum_ip_high IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_HIGH%TYPE,
15:21:32 922  	in_maximum_ip_string IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_STRING%TYPE,
15:21:32 923  	in_maximum_ip_low IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_LOW%TYPE,
15:21:32 924  	in_maximum_ip_high IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_HIGH%TYPE,
15:21:32 925  	in_created_by IN GROUP_ACCOUNT_IP_RANGE.CREATED_BY%TYPE
15:21:32 926  ) AS
15:21:32 927  SPROC_NAME CONSTANT VARCHAR2(32) := 'ADD_IP_RANGE';
15:21:32 928  var_ga_type OFFER_CHAIN.GROUP_ACCOUNT_TYPE_ID%TYPE;
15:21:32 929  var_is_dupe NUMBER(1);
15:21:32 930  NOT_GL EXCEPTION;
15:21:32 931  DUPE EXCEPTION;
15:21:32 932  BEGIN
15:21:32 933  	  SELECT OFFER_CHAIN.GROUP_ACCOUNT_TYPE_ID into var_ga_type
15:21:32 934  	  FROM
15:21:32 935  	    GROUP_ACCOUNT,
15:21:32 936  	    SUBSCRIPTION,
15:21:32 937  	    OFFER_CHAIN
15:21:32 938  	  WHERE
15:21:32 939  	    GROUP_ACCOUNT.ID = in_group_account_id AND
15:21:32 940  	    GROUP_ACCOUNT.SUBSCRIPTION_ID = SUBSCRIPTION.ID AND
15:21:32 941  	    SUBSCRIPTION.OFFER_CHAIN_ID = OFFER_CHAIN.ID
15:21:32 942  	  ;
15:21:32 943  	  IF(var_ga_type != 'GL') THEN
15:21:32 944  	    RAISE NOT_GL;
15:21:32 945  	  END IF;
15:21:32 946  
15:21:32 947  	  PROCS_GROUP_ACCOUNT_CRU_V18.ADD_IP_RANGE(
15:21:32 948  	    in_group_account_id => in_group_account_id,
15:21:32 949  	    in_minimum_ip_string => in_minimum_ip_string,
15:21:32 950  	    in_minimum_ip_low => in_minimum_ip_low,
15:21:32 951  	    in_minimum_ip_high => in_minimum_ip_high,
15:21:32 952  	    in_maximum_ip_string => in_maximum_ip_string,
15:21:32 953  	    in_maximum_ip_low => in_maximum_ip_low,
15:21:32 954  	    in_maximum_ip_high => in_maximum_ip_high,
15:21:32 955  	    in_created_by => in_created_by
15:21:32 956  	  );
15:21:32 957  
15:21:32 958  	  -- Check for overlapping ip address range after insert.  Note that if another
15:21:32 959  	  -- call to add_ip_range has not completed, overlapping ip entries can occur.
15:21:32 960  	  SELECT count(1) into var_is_dupe
15:21:32 961  	  FROM
15:21:32 962  	    GROUP_ACCOUNT_IP_RANGE
15:21:32 963  	  WHERE
15:21:32 964  	    GROUP_ACC_IP_RNG_STATUS_ID = GLOBAL_STATUSES_V18.GROUP_ACC_IP_RNG_ACTIVE AND
15:21:32 965  		((
15:21:32 966  		  (in_minimum_ip_high > minimum_ip_high and in_minimum_ip_high < maximum_ip_high) or
15:21:32 967  		  (in_minimum_ip_high = minimum_ip_high and (in_minimum_ip_low >= minimum_ip_low and in_minimum_ip_low <= maximum_ip_low)) or
15:21:32 968  		  (in_minimum_ip_high = maximum_ip_high and (in_minimum_ip_low >= minimum_ip_low and in_minimum_ip_low <= maximum_ip_low))
15:21:32 969  		) OR
15:21:32 970  
15:21:32 971  		(
15:21:32 972  		  (in_maximum_ip_high > minimum_ip_high and in_maximum_ip_high < maximum_ip_high) or
15:21:32 973  		  (in_maximum_ip_high = minimum_ip_high and (in_maximum_ip_low >= minimum_ip_low and in_maximum_ip_low <= maximum_ip_low)) or
15:21:32 974  		  (in_maximum_ip_high = maximum_ip_high and (in_maximum_ip_low >= minimum_ip_low and in_maximum_ip_low <= maximum_ip_low))
15:21:32 975  		)) AND
15:21:32 976  	    ROWNUM < 3;
15:21:32 977  
15:21:32 978  	  If(var_is_dupe > 1) THEN
15:21:32 979  	    RAISE DUPE;
15:21:32 980  	  END IF;
15:21:32 981  EXCEPTION
15:21:32 982  WHEN NOT_GL THEN
15:21:32 983  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 984  	  SPROC_NAME, 'Group account type does not support IPs', SQLERRM);
15:21:32 985  WHEN DUPE THEN
15:21:32 986  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 987  	  SPROC_NAME, 'The IP address range is already in use', SQLERRM);
15:21:32 988  WHEN OTHERS THEN
15:21:32 989  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 990  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 991  END ADD_IP_RANGE;
15:21:32 992  
15:21:32 993  PROCEDURE GET_GRP_ID_BY_GRP_ACCOUNT_ID (
15:21:32 994  	in_group_account_id IN NUMBER,
15:21:32 995  	out_group_id OUT NUMBER
15:21:32 996  ) AS
15:21:32 997  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GRP_ID_BY_GRP_ACCOUNT_ID';
15:21:32 998  BEGIN
15:21:32 999  	SELECT
15:21:32 1000  	   a.group_id into out_group_id
15:21:32 1001  	 FROM
15:21:32 1002  	   account a,
15:21:32 1003  	   subscription s,
15:21:32 1004  	   group_account ga
15:21:32 1005  	 WHERE
15:21:32 1006  	   a.id = s.account_id and
15:21:32 1007  	   s.id = ga.subscription_id and
15:21:32 1008  	   ga.id = in_group_account_id and
15:21:32 1009  	   rownum < 2
15:21:32 1010  	 ;
15:21:32 1011  EXCEPTION
15:21:32 1012  WHEN NO_DATA_FOUND THEN
15:21:32 1013  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1014  	   SPROC_NAME, 'Bad group_account_id');
15:21:32 1015  WHEN OTHERS THEN
15:21:32 1016  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1017  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1018  END GET_GRP_ID_BY_GRP_ACCOUNT_ID;
15:21:32 1019  
15:21:32 1020  PROCEDURE GET_GRP_ID_BY_GRPACCIPRNG_ID (
15:21:32 1021  	 in_group_account_ip_range_id IN NUMBER,
15:21:32 1022  	 out_group_id OUT NUMBER
15:21:32 1023  ) AS
15:21:32 1024  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GRP_ID_BY_GRPACCIPRNG_ID';
15:21:32 1025  BEGIN
15:21:32 1026  	 SELECT
15:21:32 1027  	   a.group_id into out_group_id
15:21:32 1028  	 FROM
15:21:32 1029  	   account a,
15:21:32 1030  	   subscription s,
15:21:32 1031  	   group_account ga,
15:21:32 1032  	   group_account_ip_range ir
15:21:32 1033  	 WHERE
15:21:32 1034  	   a.id = s.account_id and
15:21:32 1035  	   s.id = ga.subscription_id and
15:21:32 1036  	   ga.id = ir.group_account_id and
15:21:32 1037  	   ir.id = in_group_account_ip_range_id and
15:21:32 1038  	   rownum < 2
15:21:32 1039  	 ;
15:21:32 1040  EXCEPTION
15:21:32 1041  WHEN NO_DATA_FOUND THEN
15:21:32 1042  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1043  	   SPROC_NAME, 'Bad group_account_ip_range_id');
15:21:32 1044  WHEN OTHERS THEN
15:21:32 1045  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1046  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1047  END GET_GRP_ID_BY_GRPACCIPRNG_ID;
15:21:32 1048  
15:21:32 1049  PROCEDURE GET_GRP_ID_BY_EMAIL_DOM_ID (
15:21:32 1050  	 in_group_account_email_dom_id IN NUMBER,
15:21:32 1051  	 out_group_id OUT NUMBER
15:21:32 1052  ) AS
15:21:32 1053  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GRP_ID_BY_EMAIL_DOM_ID';
15:21:32 1054  BEGIN
15:21:32 1055  	 SELECT
15:21:32 1056  	   a.group_id into out_group_id
15:21:32 1057  	 FROM
15:21:32 1058  	   account a,
15:21:32 1059  	   subscription s,
15:21:32 1060  	   group_account ga,
15:21:32 1061  	   group_account_email_domain ir
15:21:32 1062  	 WHERE
15:21:32 1063  	   a.id = s.account_id and
15:21:32 1064  	   s.id = ga.subscription_id and
15:21:32 1065  	   ga.id = ir.group_account_id and
15:21:32 1066  	   ir.id = in_group_account_email_dom_id and
15:21:32 1067  	   rownum < 2
15:21:32 1068  	 ;
15:21:32 1069  EXCEPTION
15:21:32 1070  WHEN NO_DATA_FOUND THEN
15:21:32 1071  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1072  	   SPROC_NAME, 'Bad group_account_ip_range_id');
15:21:32 1073  WHEN OTHERS THEN
15:21:32 1074  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1075  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1076  END GET_GRP_ID_BY_EMAIL_DOM_ID;
15:21:32 1077  
15:21:32 1078  PROCEDURE UPDATE_GROUP_ACCOUNT (
15:21:32 1079  	 in_group_account_id	  IN GROUP_ACCOUNT.ID%TYPE,
15:21:32 1080  	 in_group_name		  IN GROUP_ACCOUNT.GROUP_NAME%TYPE,
15:21:32 1081  	 in_first_name		  IN GROUP_ACCOUNT.FIRST_NAME%TYPE,
15:21:32 1082  	 in_last_name		  IN GROUP_ACCOUNT.LAST_NAME%TYPE,
15:21:32 1083  	 in_email		  IN GROUP_ACCOUNT.EMAIL%TYPE,
15:21:32 1084  	 in_phone		  IN GROUP_ACCOUNT.PHONE%TYPE,
15:21:32 1085  	 in_updated_by		  IN GROUP_ACCOUNT.UPDATED_BY%TYPE
15:21:32 1086  ) AS
15:21:32 1087  BEGIN
15:21:32 1088  	 PROCS_GROUP_ACCOUNT_CRU_V18.UPDATE_GROUP_ACCOUNT(
15:21:32 1089  	   in_group_account_id => in_group_account_id,
15:21:32 1090  	   in_group_name => in_group_name,
15:21:32 1091  	   in_first_name => in_first_name,
15:21:32 1092  	   in_last_name => in_last_name,
15:21:32 1093  	   in_email => in_email,
15:21:32 1094  	   in_phone => in_phone,
15:21:32 1095  	   in_updated_by => in_updated_by
15:21:32 1096  	 );
15:21:32 1097  END UPDATE_GROUP_ACCOUNT;
15:21:32 1098  
15:21:32 1099  PROCEDURE UPDATE_GROUP_ACCOUNT_SEATS (
15:21:32 1100  	 in_group_account_id	  IN GROUP_ACCOUNT.ID%TYPE,
15:21:32 1101  	 in_seats		  IN GROUP_ACCOUNT.SEATS%TYPE,
15:21:32 1102  	 in_updated_by		  IN GROUP_ACCOUNT.UPDATED_BY%TYPE
15:21:32 1103  ) AS
15:21:32 1104  BEGIN
15:21:32 1105  	 PROCS_GROUP_ACCOUNT_CRU_V18.UPDATE_GROUP_ACCOUNT_SEATS(
15:21:32 1106  	   in_group_account_id => in_group_account_id,
15:21:32 1107  	   in_seats => in_seats,
15:21:32 1108  	   in_updated_by => in_updated_by
15:21:32 1109  	 );
15:21:32 1110  END UPDATE_GROUP_ACCOUNT_SEATS;
15:21:32 1111  
15:21:32 1112  END PROCS_GROUP_ACCOUNT_V18;
15:21:32 1113  .
15:21:32 SQL> /

Package body created.

Elapsed: 00:00:00.08
15:21:32 SQL> 
15:21:32 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_TEST_V18" AS
15:21:32   2  
15:21:32   3  PROCEDURE TEST_CLEAR_ALL IS
15:21:32   4  BEGIN
15:21:32   5  	DELETE FROM TAX_ADJUSTMENT;
15:21:32   6  	DELETE FROM LINE_ITEM_ADJUSTMENT;
15:21:32   7  	DELETE FROM INVOICE_ADJUSTMENT;
15:21:32   8  	DELETE FROM LICENSE;
15:21:32   9  	DELETE FROM OFFER_OFFER_CHAIN;
15:21:32  10  	delete from offer_product_offering;
15:21:32  11  	delete from tax;
15:21:32  12  	delete from discount_lineitem_adjustment; -- ? JUnitTests don't clear db in the moment of clear sproc corrections
15:21:32  13  	delete from discount_line_item; -- ?
15:21:32  14  	delete from discount; -- ?
15:21:32  15  	DELETE FROM LINE_ITEM;
15:21:32  16  	DELETE FROM PRODUCT_OFFERING_META_DATA;
15:21:32  17  	DELETE FROM PRODUCT_OFFERING;
15:21:32  18  	DELETE FROM PRODUCT;
15:21:32  19  	DELETE FROM INVOICE_NOTE;
15:21:32  20  	DELETE FROM GIFT_CERTIFICATE;
15:21:32  21  	DELETE FROM OFFER;
15:21:32  22  	DELETE FROM OFFER_CHAIN_META_DATA;
15:21:32  23  	DELETE FROM SUBSCRIPTION_NOTE;
15:21:32  24  	DELETE FROM SUBSCRIPTION_META_DATA;
15:21:32  25  	DELETE FROM SUBSCRIPTION;
15:21:32  26  	DELETE FROM CREDIT_CARD;
15:21:32  27  	DELETE FROM FLAGGED_ACCOUNTS;
15:21:32  28  	DELETE FROM ACCOUNT_NOTE;
15:21:32  29  	DELETE FROM ACCOUNT_LOCK;
15:21:32  30  	DELETE FROM ACCOUNT;
15:21:32  31  	DELETE FROM CHARGE;
15:21:32  32  	DELETE FROM TRANSACTION_ATTEMPT;
15:21:32  33  	DELETE FROM CHARGEBACK;
15:21:32  34  	DELETE FROM TRANSACTION;
15:21:32  35  	DELETE FROM INVOICE_NOTE;
15:21:32  36  	DELETE FROM INVOICE;
15:21:32  37  	DELETE FROM OFFER_CHAIN_ELIGIBILITY;
15:21:32  38  	DELETE FROM OFFER_CHAIN;
15:21:32  39  END TEST_CLEAR_ALL;
15:21:32  40  
15:21:32  41  PROCEDURE TEST_CLEAR_PRODUCTS AS
15:21:32  42  BEGIN
15:21:32  43  	DELETE FROM OFFER_OFFER_CHAIN;
15:21:32  44  	DELETE FROM OFFER_PRODUCT_OFFERING;
15:21:32  45  	DELETE FROM TAX;
15:21:32  46  	DELETE FROM PRODUCT_OFFERING;
15:21:32  47  	DELETE FROM PRODUCT;
15:21:32  48  	DELETE FROM OFFER;
15:21:32  49  	DELETE FROM OFFER_CHAIN_META_DATA;
15:21:32  50  	DELETE FROM OFFER_CHAIN;
15:21:32  51  	DELETE FROM OFFER_CHAIN_ELIGIBILITY;
15:21:32  52  END;
15:21:32  53  
15:21:32  54  /******************************************/
15:21:32  55  
15:21:32  56  PROCEDURE TEST_GET_ACCOUNT (
15:21:32  57  	in_group_id	IN NUMBER,
15:21:32  58  	out_result_set	OUT SYS_REFCURSOR
15:21:32  59  ) AS
15:21:32  60  BEGIN
15:21:32  61  
15:21:32  62  	OPEN out_result_set FOR
15:21:32  63  	SELECT *
15:21:32  64  	FROM
15:21:32  65  	  ACCOUNT
15:21:32  66  	WHERE
15:21:32  67  	  ACCOUNT.GROUP_ID = in_group_id;
15:21:32  68  
15:21:32  69  END TEST_GET_ACCOUNT;
15:21:32  70  
15:21:32  71  /*******************************************/
15:21:32  72  
15:21:32  73  PROCEDURE TEST_GET_SUBSCRIPTION (
15:21:32  74  	in_subscription_id IN NUMBER,
15:21:32  75  	out_result_set	   OUT SYS_REFCURSOR
15:21:32  76  ) AS
15:21:32  77  BEGIN
15:21:32  78  	OPEN out_result_set FOR
15:21:32  79  	SELECT *
15:21:32  80  	FROM
15:21:32  81  	  SUBSCRIPTION
15:21:32  82  	WHERE
15:21:32  83  	  SUBSCRIPTION.ID = in_subscription_id;
15:21:32  84  
15:21:32  85  END TEST_GET_SUBSCRIPTION;
15:21:32  86  
15:21:32  87  /***************************************************/
15:21:32  88  
15:21:32  89  PROCEDURE TEST_DELETE_INVOICE (
15:21:32  90  	in_invoice_id IN NUMBER
15:21:32  91  ) AS
15:21:32  92  var_line_item_id_set SYS_REFCURSOR;
15:21:32  93  var_line_item_id	   NUMBER;
15:21:32  94  
15:21:32  95  var_charge_id_set  SYS_REFCURSOR;
15:21:32  96  var_charge_id	 NUMBER;
15:21:32  97  var_transaction_id NUMBER;
15:21:32  98  BEGIN
15:21:32  99  	-- GET ACCOUNT'S LINE_ITEMS
15:21:32 100  	OPEN var_line_item_id_set FOR
15:21:32 101  	SELECT LINE_ITEM.ID FROM LINE_ITEM WHERE LINE_ITEM.INVOICE_ID = in_invoice_id;
15:21:32 102  	LOOP
15:21:32 103  	  FETCH var_line_item_id_set into var_line_item_id;
15:21:32 104  	  EXIT WHEN var_line_item_id_set%NOTFOUND;
15:21:32 105  
15:21:32 106  	  -- DELETE ADJUSTMENTS
15:21:32 107  	  FOR f_line_item_adjustments IN (SELECT * FROM LINE_ITEM_ADJUSTMENT WHERE LINE_ITEM_ID = var_line_item_id)
15:21:32 108  	  LOOP
15:21:32 109  
15:21:32 110  	    -- DELETE DISCOUNT ADJUSTMENTS
15:21:32 111  	    DELETE FROM DISCOUNT_LINEITEM_ADJUSTMENT WHERE LINE_ITEM_ADJUSTMENT_ID = f_line_item_adjustments.ID;
15:21:32 112  
15:21:32 113  	    -- DELETE TAX ADJUSTMENTS
15:21:32 114  	    DELETE FROM TAX_ADJUSTMENT WHERE LINE_ITEM_ADJUSTMENT_ID = f_line_item_adjustments.ID;
15:21:32 115  	  END LOOP;
15:21:32 116  
15:21:32 117  	  -- DELETE LINE ITEM ADJUSTMENTS
15:21:32 118  	  DELETE FROM LINE_ITEM_ADJUSTMENT WHERE LINE_ITEM_ID = var_line_item_id;
15:21:32 119  
15:21:32 120  	  -- DELETE DISCOUNT_LINE_ITEM
15:21:32 121  	  DELETE FROM DISCOUNT_LINE_ITEM WHERE DISCOUNT_LINE_ITEM.LINE_ITEM_ID = var_line_item_id;
15:21:32 122  
15:21:32 123  	  DELETE FROM TAX WHERE LINE_ITEM_ID = var_line_item_id;
15:21:32 124  
15:21:32 125  	  -- DELETE LINE ITEM
15:21:32 126  	  DELETE FROM LINE_ITEM WHERE LINE_ITEM.ID = var_line_item_id;
15:21:32 127  
15:21:32 128  	END LOOP;
15:21:32 129  
15:21:32 130  	-- DELETE INVOICE ADJUSTMENTS
15:21:32 131  	DELETE FROM INVOICE_ADJUSTMENT WHERE INVOICE_ID = in_invoice_id;
15:21:32 132  
15:21:32 133  	-- GET ACCOUNT'S CHARGES AND TRANSACTIONS
15:21:32 134  	OPEN var_charge_id_set FOR
15:21:32 135  	SELECT CHARGE.ID, CHARGE.TRANSACTION_ID FROM CHARGE WHERE CHARGE.INVOICE_ID = in_invoice_id;
15:21:32 136  	LOOP
15:21:32 137  	  FETCH var_charge_id_set into var_charge_id, var_transaction_id;
15:21:32 138  	  EXIT WHEN var_charge_id_set%NOTFOUND;
15:21:32 139  	  -- DELETE CHARGEBACK
15:21:32 140  	  DELETE FROM CHARGEBACK WHERE CHARGEBACK.TRANSACTION_ID = var_transaction_id;
15:21:32 141  
15:21:32 142  	  -- DELETE TRANSACTION ATTEMP
15:21:32 143  	  DELETE FROM TRANSACTION_ATTEMPT WHERE TRANSACTION_ATTEMPT.TRANSACTION_ID = var_transaction_id;
15:21:32 144  
15:21:32 145  	  -- DELETE CHARGE
15:21:32 146  	  DELETE FROM CHARGE WHERE CHARGE.ID = var_charge_id;
15:21:32 147  
15:21:32 148  	  -- DELETE TRANSACTION
15:21:32 149  	  DELETE FROM TRANSACTION WHERE TRANSACTION.ID = var_transaction_id;
15:21:32 150  	END LOOP;
15:21:32 151  
15:21:32 152  	-- DELETE INVOICE NOTES
15:21:32 153  	DELETE FROM INVOICE_NOTE WHERE INVOICE_NOTE.INVOICE_ID = in_invoice_id;
15:21:32 154  
15:21:32 155  	-- DELETE INVOICE
15:21:32 156  	DELETE FROM INVOICE WHERE INVOICE.ID = in_invoice_id;
15:21:32 157  END;
15:21:32 158  
15:21:32 159  PROCEDURE TEST_DELETE_USER_ACCOUNT (
15:21:32 160  	in_group_id IN NUMBER
15:21:32 161  ) AS
15:21:32 162  -- VARIABLES
15:21:32 163  var_account_id NUMBER;
15:21:32 164  
15:21:32 165  -- CURSORS
15:21:32 166  var_subscription_id_set SYS_REFCURSOR;
15:21:32 167  var_subscription_id     NUMBER;
15:21:32 168  
15:21:32 169  var_license_id_set SYS_REFCURSOR;
15:21:32 170  var_license_id	 NUMBER;
15:21:32 171  var_invoice_id	 NUMBER;
15:21:32 172  
15:21:32 173  var_gift_certificate_id_set SYS_REFCURSOR;
15:21:32 174  var_gift_certificate_id	  NUMBER;
15:21:32 175  var_gc_purchase_invoice_id  NUMBER;
15:21:32 176  BEGIN
15:21:32 177  
15:21:32 178   /*FOR f_account in (
15:21:32 179  	  select id from account where group_id = in_group_id
15:21:32 180  	)
15:21:32 181  	loop
15:21:32 182  
15:21:32 183  	  -- delete account
15:21:32 184  	  delete from account where id = f_account.id;
15:21:32 185  
15:21:32 186  	end loop;*/
15:21:32 187  
15:21:32 188  	BEGIN
15:21:32 189  	  SELECT
15:21:32 190  	    ACCOUNT.ID into var_account_id
15:21:32 191  	  FROM
15:21:32 192  	    ACCOUNT
15:21:32 193  	  WHERE
15:21:32 194  	    ACCOUNT.GROUP_ID = in_group_id;
15:21:32 195  	  EXCEPTION
15:21:32 196  	    WHEN NO_DATA_FOUND THEN
15:21:32 197  	      -- Nothing to do
15:21:32 198  	      RETURN;
15:21:32 199  	END;
15:21:32 200  
15:21:32 201  	-- GET ACCOUNT'S SUBSCRIPTIONS
15:21:32 202  	OPEN var_subscription_id_set FOR
15:21:32 203  	SELECT SUBSCRIPTION.ID FROM SUBSCRIPTION WHERE SUBSCRIPTION.ACCOUNT_ID = var_account_id;
15:21:32 204  	LOOP
15:21:32 205  	  FETCH var_subscription_id_set into var_subscription_id;
15:21:32 206  	  EXIT WHEN var_subscription_id_set%NOTFOUND;
15:21:32 207  
15:21:32 208  	  -- GET ACCOUNT'S LICENSES AND INVOICES
15:21:32 209  	  OPEN var_license_id_set FOR
15:21:32 210  	  SELECT LICENSE.ID, LICENSE.INVOICE_ID FROM LICENSE WHERE LICENSE.SUBSCRIPTION_ID = var_subscription_id;
15:21:32 211  	  LOOP
15:21:32 212  	    FETCH var_license_id_set into var_license_id, var_invoice_id;
15:21:32 213  	    EXIT WHEN var_license_id_set%NOTFOUND;
15:21:32 214  
15:21:32 215  
15:21:32 216  	    -- GET GC WHERE PURCHASE_INVOICE_ID = invoice
15:21:32 217  	    OPEN var_gift_certificate_id_set FOR
15:21:32 218  	    SELECT GIFT_CERTIFICATE.ID, GIFT_CERTIFICATE.PURCHASE_INVOICE_ID FROM GIFT_CERTIFICATE WHERE GIFT_CERTIFICATE.FINALIZED_INVOICE_ID = var_invoice_id;
15:21:32 219  	    LOOP
15:21:32 220  	      FETCH var_gift_certificate_id_set into var_gift_certificate_id, var_gc_purchase_invoice_id;
15:21:32 221  	      EXIT WHEN var_gift_certificate_id_set%NOTFOUND;
15:21:32 222  
15:21:32 223  	      -- DELETE GIFT_CERTIFICATE
15:21:32 224  	      DELETE FROM GIFT_CERTIFICATE WHERE GIFT_CERTIFICATE.ID = var_gift_certificate_id;
15:21:32 225  
15:21:32 226  	      -- DELETE LICENSE
15:21:32 227  	      IF TEST_IS_INVOICE_EXISTS(var_gc_purchase_invoice_id) = 1 THEN
15:21:32 228  		TEST_DELETE_INVOICE(var_gc_purchase_invoice_id);
15:21:32 229  	      END IF;
15:21:32 230  
15:21:32 231  	    END LOOP;
15:21:32 232  
15:21:32 233  	    -- DELETE GIFT_CERTIFICATE WHERE GC.REDEEMER_GROUP_ID = out group_id
15:21:32 234  	    DELETE FROM GIFT_CERTIFICATE WHERE GIFT_CERTIFICATE.REDEEMER_GROUP_ID = in_group_id;
15:21:32 235  
15:21:32 236  	    -- DELETE LICENSE
15:21:32 237  	    DELETE FROM LICENSE WHERE LICENSE.ID = var_license_id;
15:21:32 238  
15:21:32 239  	    -- DELETE INVOICE
15:21:32 240  	    IF TEST_IS_INVOICE_EXISTS(var_invoice_id) = 1 THEN
15:21:32 241  	      TEST_DELETE_INVOICE(var_invoice_id);
15:21:32 242  	    END IF;
15:21:32 243  	  END LOOP;
15:21:32 244  
15:21:32 245  	  -- DELETE SUBSCRIPTION_NOTE
15:21:32 246  	  DELETE FROM SUBSCRIPTION_NOTE WHERE SUBSCRIPTION_NOTE.SUBSCRIPTION_ID = var_subscription_id;
15:21:32 247  
15:21:32 248  	  -- DELETE SUBSCRIPTION META_DATA
15:21:32 249  	  DELETE FROM SUBSCRIPTION_META_DATA WHERE SUBSCRIPTION_META_DATA.SUBSCRIPTION_ID = var_subscription_id;
15:21:32 250  
15:21:32 251  	  -- DELETE SUBSCRIPTION
15:21:32 252  	  DELETE FROM SUBSCRIPTION WHERE SUBSCRIPTION.ID = var_subscription_id;
15:21:32 253  	END LOOP;
15:21:32 254  
15:21:32 255  	-- DELETE CREDIT_CARDS
15:21:32 256  	DELETE FROM CREDIT_CARD WHERE CREDIT_CARD.ACCOUNT_ID = var_account_id;
15:21:32 257  
15:21:32 258  	-- DELETE PAYPAL
15:21:32 259  	DELETE FROM PAYPAL WHERE PAYPAL.ACCOUNT_ID = var_account_id;
15:21:32 260  
15:21:32 261  	-- DELETE FLAGS
15:21:32 262  	DELETE FROM FLAGGED_ACCOUNTS WHERE FLAGGED_ACCOUNTS.ACCOUNT_ID = var_account_id;
15:21:32 263  
15:21:32 264  	-- DELETE ACCOUNT NOTES
15:21:32 265  	DELETE FROM ACCOUNT_NOTE WHERE ACCOUNT_NOTE.ACCOUNT_ID = var_account_id;
15:21:32 266  
15:21:32 267  	-- DELETE INVOICES AND GC'S WHERE USER IS PURCHASER
15:21:32 268  	OPEN var_gift_certificate_id_set FOR
15:21:32 269  	SELECT GIFT_CERTIFICATE.ID, GIFT_CERTIFICATE.PURCHASE_INVOICE_ID FROM GIFT_CERTIFICATE WHERE GIFT_CERTIFICATE.PURCHASER_GROUP_ID = in_group_id;
15:21:32 270  	LOOP
15:21:32 271  	  FETCH var_gift_certificate_id_set into var_gift_certificate_id, var_gc_purchase_invoice_id;
15:21:32 272  	  EXIT WHEN var_gift_certificate_id_set%NOTFOUND;
15:21:32 273  
15:21:32 274  	  -- DELETE GIFT CERTIFICATE
15:21:32 275  	  DELETE FROM GIFT_CERTIFICATE WHERE GIFT_CERTIFICATE.ID = var_gift_certificate_id;
15:21:32 276  
15:21:32 277  	  -- DELETE INVOICE
15:21:32 278  	  IF TEST_IS_INVOICE_EXISTS(var_gc_purchase_invoice_id) = 1 THEN
15:21:32 279  	    TEST_DELETE_INVOICE(var_gc_purchase_invoice_id);
15:21:32 280  	  END IF;
15:21:32 281  	END LOOP;
15:21:32 282  
15:21:32 283  	-- DELETE LOCKS
15:21:32 284  	DELETE FROM ACCOUNT_LOCK WHERE ACCOUNT_ID = var_account_id;
15:21:32 285  
15:21:32 286  	-- DELETE ACCOUNT
15:21:32 287  	DELETE FROM ACCOUNT WHERE ACCOUNT.ID = var_account_id;
15:21:32 288  
15:21:32 289  END TEST_DELETE_USER_ACCOUNT;
15:21:32 290  
15:21:32 291  PROCEDURE TEST_DELETE_USER_ACCOUNTS  (
15:21:32 292  	in_start_group_id IN NUMBER,
15:21:32 293  	in_end_group_id   IN NUMBER
15:21:32 294  ) IS
15:21:32 295   gid ACCOUNT.GROUP_ID%TYPE;
15:21:32 296   CURSOR c (v_from NUMBER, v_to NUMBER) IS SELECT ACCOUNT.GROUP_ID FROM ACCOUNT WHERE GROUP_ID BETWEEN v_from AND v_to;
15:21:32 297  BEGIN
15:21:32 298  -- arosolovskiy refactoring: call delete_user_account only "COUNT(group_id) WHERE ...." times instead of "in_end_group_id - in_start_group_id" times;
15:21:32 299  	/*
15:21:32 300  	FOR var_group_id IN in_start_group_id..in_end_group_id
15:21:32 301  	LOOP
15:21:32 302  	  TEST_DELETE_USER_ACCOUNT(var_group_id);
15:21:32 303  	END LOOP;*/
15:21:32 304  	OPEN c(in_start_group_id, in_end_group_id);
15:21:32 305  	WHILE c%ISOPEN LOOP
15:21:32 306  	  FETCH c INTO gid;
15:21:32 307  	  IF c%NOTFOUND THEN
15:21:32 308  	   CLOSE c;
15:21:32 309  	  END IF;
15:21:32 310  	  TEST_DELETE_USER_ACCOUNT(gid);
15:21:32 311  	END LOOP;
15:21:32 312  END;
15:21:32 313  
15:21:32 314  /**********************************************************/
15:21:32 315  
15:21:32 316  FUNCTION TEST_IS_INVOICE_EXISTS(
15:21:32 317  /*
15:21:32 318  1 - exists
15:21:32 319  0 - not exists
15:21:32 320  */
15:21:32 321  	in_invoice_id IN NUMBER
15:21:32 322  ) RETURN NUMBER AS
15:21:32 323  var_invoice_count NUMBER;
15:21:32 324  BEGIN
15:21:32 325  	SELECT
15:21:32 326  	  COUNT(*) into var_invoice_count
15:21:32 327  	FROM
15:21:32 328  	  INVOICE
15:21:32 329  	WHERE
15:21:32 330  	  INVOICE.ID = in_invoice_id;
15:21:32 331  	IF var_invoice_count = 0 THEN
15:21:32 332  	  RETURN 0;
15:21:32 333  	ELSE
15:21:32 334  	  RETURN 1;
15:21:32 335  	END IF;
15:21:32 336  END;
15:21:32 337  
15:21:32 338  PROCEDURE TEST_GET_INVOICE_INFO (
15:21:32 339  	in_invoice_id  IN NUMBER,
15:21:32 340  	out_result_set OUT SYS_REFCURSOR
15:21:32 341  ) AS
15:21:32 342  SPROC_NAME      CONSTANT VARCHAR2(21) := 'TEST_GET_INVOICE_INFO';
15:21:32 343  BEGIN
15:21:32 344  
15:21:32 345  	 OPEN out_result_set FOR SELECT
15:21:32 346  	    in_invoice_id AS "INVOICE_ID",
15:21:32 347  	    INVOICE.INVOICE_STATUS_ID,
15:21:32 348  	    PROCS_INVOICE_V18.F_CALCULATE_INVOICE_AMOUNT(in_invoice_id) AS "INVOICE_AMOUNT",
15:21:32 349  	    CHARGE.ID AS "CHARGE_ID",
15:21:32 350  	    CHARGE.CHARGE_AMOUNT,
15:21:32 351  	    CHARGE.TRANSACTION_ID,
15:21:32 352  	    TRANSACTION.TRANSACTION_STATUS_ID
15:21:32 353  	  FROM CHARGE INNER JOIN INVOICE ON INVOICE.ID = CHARGE.INVOICE_ID INNER JOIN TRANSACTION ON TRANSACTION.ID = CHARGE.TRANSACTION_ID WHERE CHARGE.INVOICE_ID = in_invoice_id ORDER BY INVOICE.ID, CHARGE.ID, TRANSACTION.ID;
15:21:32 354  
15:21:32 355  END TEST_GET_INVOICE_INFO;
15:21:32 356  
15:21:32 357  /******************************************************************************/
15:21:32 358  
15:21:32 359  PROCEDURE TEST_DELETE_OFFER_CHAIN(
15:21:32 360  	in_offer_chain_id in number
15:21:32 361  ) as
15:21:32 362  begin
15:21:32 363  
15:21:32 364  	for v_offer_chain in (
15:21:32 365  	  select och.id from offer_chain och where och.id = in_offer_chain_id
15:21:32 366  	)
15:21:32 367  	loop
15:21:32 368  
15:21:32 369  	  for v_offer in (
15:21:32 370  	    select offer_id as id from offer_offer_chain where offer_chain_id = v_offer_chain.id
15:21:32 371  	  )
15:21:32 372  	  loop
15:21:32 373  
15:21:32 374  	    for v_product_offering in (
15:21:32 375  	      select
15:21:32 376  		product_offering.id,
15:21:32 377  		product_offering.product_id
15:21:32 378  	      from
15:21:32 379  		offer_product_offering
15:21:32 380  		inner join product_offering on offer_product_offering.product_offering_id = product_offering.id
15:21:32 381  	      where offer_product_offering.offer_id = v_offer.id
15:21:32 382  	    )
15:21:32 383  	    loop
15:21:32 384  
15:21:32 385  	      -- delete product eligibility
15:21:32 386  	      delete from product_eligibility where product_id = v_product_offering.product_id;
15:21:32 387  
15:21:32 388  	      -- delete meta data
15:21:32 389  	      delete from product_offering_meta_data where product_offering_id = v_product_offering.id;
15:21:32 390  
15:21:32 391  	      -- delete product
15:21:32 392  	      delete from product where id = v_product_offering.product_id;
15:21:32 393  
15:21:32 394  	      -- delete product_offering
15:21:32 395  	      delete from product_offering where id = v_product_offering.id;
15:21:32 396  
15:21:32 397  	    end loop;
15:21:32 398  
15:21:32 399  	    -- delete data from offer_product_offering table
15:21:32 400  	    delete from offer_product_offering where offer_id = v_offer.id;
15:21:32 401  
15:21:32 402  	    -- delete data from offer_offer_chain table
15:21:32 403  	    delete from offer_offer_chain where offer_chain_id = v_offer_chain.id;
15:21:32 404  
15:21:32 405  	    -- delete offer
15:21:32 406  	    delete from offer where id = v_offer.id;
15:21:32 407  
15:21:32 408  	  end loop;
15:21:32 409  
15:21:32 410  	  -- delete offer_chain_eligibility
15:21:32 411  	  delete from offer_chain_eligibility where offer_chain_id = v_offer_chain.id;
15:21:32 412  
15:21:32 413  	  -- delete metadata
15:21:32 414  	  delete from offer_chain_meta_data where offer_chain_id = v_offer_chain.id;
15:21:32 415  
15:21:32 416  	  -- delete offer chain
15:21:32 417  	  delete from offer_chain where id = v_offer_chain.id;
15:21:32 418  
15:21:32 419  	end loop;
15:21:32 420  
15:21:32 421  end;
15:21:32 422  
15:21:32 423  END PROCS_TEST_V18;
15:21:32 424  .
15:21:32 SQL> /

Package body created.

Elapsed: 00:00:00.06
15:21:32 SQL> 
15:21:32 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_ACCOUNT_V18" AS
15:21:32   2  
15:21:32   3  PROCEDURE INVOICE_IDS_BY_GROUP_ID (
15:21:32   4  	in_group_id    IN  NUMBER,
15:21:32   5  	out_result_set OUT SYS_REFCURSOR
15:21:32   6  ) AS
15:21:32   7  SPROC_NAME CONSTANT VARCHAR2(32) := 'INVOICE_IDS_BY_GROUP_ID';
15:21:32   8  BEGIN
15:21:32   9  	OPEN out_result_set FOR
15:21:32  10  	SELECT
15:21:32  11  	  Invoice.Id
15:21:32  12  	FROM
15:21:32  13  	  LICENSE
15:21:32  14  	  INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
15:21:32  15  	  INNER JOIN INVOICE ON LICENSE.INVOICE_ID = INVOICE.ID
15:21:32  16  	  INNER JOIN OFFER_CHAIN ON SUBSCRIPTION.OFFER_CHAIN_ID = OFFER_CHAIN.ID
15:21:32  17  	  INNER JOIN INVOICE_STATUS ON INVOICE.INVOICE_STATUS_ID = INVOICE_STATUS.ID
15:21:32  18  	Where
15:21:32  19  	  SUBSCRIPTION.ACCOUNT_ID IN (SELECT ID FROM ACCOUNT WHERE GROUP_ID = in_group_id) AND
15:21:32  20  	  INVOICE.INVOICE_STATUS_ID = GLOBAL_STATUSES_V18.INVOICE_OPEN;
15:21:32  21  END INVOICE_IDS_BY_GROUP_ID;
15:21:32  22  
15:21:32  23  FUNCTION GET_GRACE_START_DATE(
15:21:32  24  	in_subscription_id IN NUMBER
15:21:32  25  ) RETURN DATE AS
15:21:32  26  SPROC_NAME	   CONSTANT VARCHAR2(32) := 'GET_GRACE_START_DATE';
15:21:32  27  grace_start_date_var DATE;
15:21:32  28  BEGIN
15:21:32  29  	SELECT GRACE_START_DATE into grace_start_date_var
15:21:32  30  	FROM
15:21:32  31  	  (
15:21:32  32  	    SELECT
15:21:32  33  	      GRACE_START_DATE
15:21:32  34  	    FROM
15:21:32  35  	      LICENSE
15:21:32  36  	    WHERE
15:21:32  37  	      LICENSE.SUBSCRIPTION_ID = in_subscription_id
15:21:32  38  	    ORDER BY
15:21:32  39  	      LICENSE.END_DATE DESC
15:21:32  40  	  )
15:21:32  41  	WHERE
15:21:32  42  	  ROWNUM <= 1;
15:21:32  43  
15:21:32  44  	RETURN grace_start_date_var;
15:21:32  45  END GET_GRACE_START_DATE;
15:21:32  46  
15:21:32  47  FUNCTION GET_GRACE_END_DATE(
15:21:32  48  	in_subscription_id IN NUMBER
15:21:32  49  ) RETURN DATE AS
15:21:32  50  SPROC_NAME	 CONSTANT VARCHAR2(32) := 'GET_GRACE_END_DATE';
15:21:32  51  grace_end_date_var DATE;
15:21:32  52  BEGIN
15:21:32  53  	SELECT GRACE_END_DATE into grace_end_date_var
15:21:32  54  	FROM
15:21:32  55  	  (
15:21:32  56  	    SELECT
15:21:32  57  	      GRACE_END_DATE
15:21:32  58  	    FROM
15:21:32  59  	      LICENSE
15:21:32  60  	    WHERE
15:21:32  61  	      LICENSE.SUBSCRIPTION_ID = in_subscription_id
15:21:32  62  	    ORDER BY
15:21:32  63  	      LICENSE.END_DATE DESC
15:21:32  64  	  )
15:21:32  65  	WHERE ROWNUM <= 1;
15:21:32  66  
15:21:32  67  	RETURN grace_end_date_var;
15:21:32  68  END GET_GRACE_END_DATE;
15:21:32  69  
15:21:32  70  
15:21:32  71  
15:21:32  72  PROCEDURE ANNOTATE_ACCOUNT (
15:21:32  73  /*
15:21:32  74  Throws exceptions:
15:21:32  75  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32  76  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32  77  */
15:21:32  78  	in_group_id   IN  NUMBER,
15:21:32  79  	in_agent_id   IN  NUMBER,
15:21:32  80  	in_note       IN  VARCHAR2,
15:21:32  81  	in_created_by IN  VARCHAR2
15:21:32  82  ) AS
15:21:32  83  SPROC_NAME  CONSTANT VARCHAR2(16) := 'ANNOTATE_ACCOUNT';
15:21:32  84  -- VARIABLES
15:21:32  85  var_account_id	  NUMBER;
15:21:32  86  var_account_note_id NUMBER;
15:21:32  87  -- EXCEPTIONS
15:21:32  88  BAD_ACCOUNT_ID EXCEPTION;
15:21:32  89  BEGIN
15:21:32  90  
15:21:32  91  	-- Get account id
15:21:32  92  	BEGIN
15:21:32  93  	  SELECT
15:21:32  94  	    ACCOUNT.ID into var_account_id
15:21:32  95  	  FROM
15:21:32  96  	    ACCOUNT
15:21:32  97  	  WHERE
15:21:32  98  	    ACCOUNT.GROUP_ID = in_group_id;
15:21:32  99  	  EXCEPTION
15:21:32 100  	    WHEN NO_DATA_FOUND THEN
15:21:32 101  	      RAISE BAD_ACCOUNT_ID;
15:21:32 102  	END;
15:21:32 103  
15:21:32 104  	-- Insert new row into ACCOUNT_NOTE table
15:21:32 105  	PROCS_ACCOUNT_CRU_V18.CREATE_ACCOUNT_NOTE(
15:21:32 106  	  inout_account_note_id => var_account_note_id,
15:21:32 107  	  in_agent_id		=> in_agent_id,
15:21:32 108  	  in_account_id 	=> var_account_id,
15:21:32 109  	  in_note		=> in_note,
15:21:32 110  	  in_created_by 	=> in_created_by
15:21:32 111  	);
15:21:32 112  
15:21:32 113  EXCEPTION
15:21:32 114  WHEN BAD_ACCOUNT_ID THEN
15:21:32 115  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 116  	  SPROC_NAME, 'No such group id');
15:21:32 117  WHEN OTHERS THEN
15:21:32 118  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 119  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 120  END ANNOTATE_ACCOUNT;
15:21:32 121  
15:21:32 122  /******************************************************************************/
15:21:32 123  
15:21:32 124  PROCEDURE ASSERT_ACCOUNT_EXISTS (
15:21:32 125  /*
15:21:32 126  Throws exceptions:
15:21:32 127  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 128  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 129  */
15:21:32 130  	in_group_id IN	NUMBER,
15:21:32 131  	out_exists  OUT NUMBER
15:21:32 132  ) AS
15:21:32 133  -- VARIABLES
15:21:32 134  var_found_id  NUMBER;
15:21:32 135  SPROC_NAME    CONSTANT VARCHAR2(21) := 'ASSERT_ACCOUNT_EXISTS';
15:21:32 136  BEGIN
15:21:32 137  	SELECT ACCOUNT.ID INTO var_found_id FROM ACCOUNT WHERE ACCOUNT.GROUP_ID = in_group_id;
15:21:32 138  	out_exists := GLOBAL_CONSTANTS_V18.TRUE;
15:21:32 139  EXCEPTION
15:21:32 140  WHEN NO_DATA_FOUND THEN
15:21:32 141  	out_exists := GLOBAL_CONSTANTS_V18.FALSE;
15:21:32 142  WHEN OTHERS THEN
15:21:32 143  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 144  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 145  END ASSERT_ACCOUNT_EXISTS;
15:21:32 146  
15:21:32 147  /******************************************************************************/
15:21:32 148  
15:21:32 149  PROCEDURE DISABLE_ACCOUNT (
15:21:32 150  /*
15:21:32 151  Throws exceptions:
15:21:32 152  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 153  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 154  */
15:21:32 155  	in_group_id   IN NUMBER,
15:21:32 156  	in_updated_by IN VARCHAR2,
15:21:32 157  	in_note       IN VARCHAR2,
15:21:32 158  	in_agent_id   IN NUMBER
15:21:32 159  ) AS
15:21:32 160  SPROC_NAME	      CONSTANT VARCHAR2(15) := 'DISABLE_ACCOUNT';
15:21:32 161  var_account_id	      NUMBER;
15:21:32 162  current_account_status  NUMBER;
15:21:32 163  
15:21:32 164  var_active_subscriptions_num NUMBER;
15:21:32 165  var_pending_invoices_num	   NUMBER;
15:21:32 166  
15:21:32 167  -- EXCEPTIONS
15:21:32 168  BAD_ACOUNT_ID		EXCEPTION;
15:21:32 169  BAD_CURRENT_ACC_STATUS	EXCEPTION;
15:21:32 170  PENDING_INVOICES_FOUND	EXCEPTION;
15:21:32 171  ACCOUNT_HAS_ACIVE_SUBSCRS EXCEPTION;
15:21:32 172  CAN_NOT_ANNOTATE_ACCOUNT	EXCEPTION;
15:21:32 173  EXCEPTION_MESSAGE 	VARCHAR2(1024);
15:21:32 174  BEGIN
15:21:32 175  
15:21:32 176  	-- Get account's status and id
15:21:32 177  	BEGIN
15:21:32 178  	  SELECT
15:21:32 179  	    ACCOUNT.ACCOUNT_STATUS_ID,
15:21:32 180  	    ACCOUNT.ID
15:21:32 181  	  INTO
15:21:32 182  	    current_account_status,
15:21:32 183  	    var_account_id
15:21:32 184  	  FROM ACCOUNT
15:21:32 185  	  WHERE
15:21:32 186  	    ACCOUNT.GROUP_ID = in_group_id;
15:21:32 187  	  EXCEPTION
15:21:32 188  	    WHEN NO_DATA_FOUND THEN
15:21:32 189  	      RAISE BAD_ACOUNT_ID;
15:21:32 190  	END;
15:21:32 191  
15:21:32 192  	-- For now, we can disable account whenever
15:21:32 193  	IF current_account_status = GLOBAL_STATUSES_V18.ACCOUNT_DISABLED THEN
15:21:32 194  	  RAISE BAD_CURRENT_ACC_STATUS;
15:21:32 195  	END IF;
15:21:32 196  
15:21:32 197  	-- Checks for out outstanding balances
15:21:32 198  	-- CHECK: No outstanding balances. If monies are due, then we can not cancel account. Return ERROR.
15:21:32 199  	SELECT
15:21:32 200  	  COUNT(*) into var_pending_invoices_num
15:21:32 201  	FROM
15:21:32 202  	  LICENSE
15:21:32 203  	    INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
15:21:32 204  	    INNER JOIN INVOICE ON LICENSE.INVOICE_ID = INVOICE.ID
15:21:32 205  	WHERE
15:21:32 206  	  SUBSCRIPTION.ACCOUNT_ID = var_account_id
15:21:32 207  	  AND INVOICE.INVOICE_STATUS_ID IN ( SELECT GLOBAL_STATUSES_V18.INVOICE_OPEN FROM DUAL );
15:21:32 208  
15:21:32 209  	IF var_pending_invoices_num > 0 THEN
15:21:32 210  	  RAISE PENDING_INVOICES_FOUND;
15:21:32 211  	END IF;
15:21:32 212  
15:21:32 213  	SELECT
15:21:32 214  	  COUNT(*) into var_active_subscriptions_num
15:21:32 215  	FROM
15:21:32 216  	  SUBSCRIPTION
15:21:32 217  	WHERE
15:21:32 218  	  SUBSCRIPTION.ACCOUNT_ID = var_account_id
15:21:32 219  	  AND (
15:21:32 220  	    SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE
15:21:32 221  	    OR SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_SUSPENDED
15:21:32 222  	    OR SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_IN_GRACE_PERIOD);
15:21:32 223  
15:21:32 224  	IF var_active_subscriptions_num > 0 THEN
15:21:32 225  	  RAISE ACCOUNT_HAS_ACIVE_SUBSCRS;
15:21:32 226  	END IF;
15:21:32 227  
15:21:32 228  	PROCS_ACCOUNT_V18.UPDATE_ACCOUNT_STATUS(
15:21:32 229  	  in_account_id        => var_account_id,
15:21:32 230  	  in_account_status_id => GLOBAL_STATUSES_V18.ACCOUNT_DISABLED,
15:21:32 231  	  in_updated_by        => in_updated_by
15:21:32 232  	);
15:21:32 233  
15:21:32 234  	-- Annotate account
15:21:32 235  	IF in_note IS NOT NULL THEN
15:21:32 236  	  BEGIN
15:21:32 237  	    PROCS_ACCOUNT_V18.ANNOTATE_ACCOUNT(
15:21:32 238  	      in_group_id   => in_group_id,
15:21:32 239  	      in_agent_id   => in_agent_id,
15:21:32 240  	      in_note	    => in_note,
15:21:32 241  	      in_created_by => in_updated_by
15:21:32 242  	    );
15:21:32 243  	    EXCEPTION
15:21:32 244  	      WHEN OTHERS THEN
15:21:32 245  		EXCEPTION_MESSAGE := SQLERRM;
15:21:32 246  		RAISE CAN_NOT_ANNOTATE_ACCOUNT;
15:21:32 247  	  END;
15:21:32 248  	END IF;
15:21:32 249  
15:21:32 250  EXCEPTION
15:21:32 251  WHEN ACCOUNT_HAS_ACIVE_SUBSCRS THEN
15:21:32 252  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 253  	  SPROC_NAME, 'Account has active or suspended subsciptions');
15:21:32 254  WHEN BAD_CURRENT_ACC_STATUS THEN
15:21:32 255  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 256  	  SPROC_NAME, 'Current account status is "disabled". Can not disable it one more time.');
15:21:32 257  WHEN PENDING_INVOICES_FOUND THEN
15:21:32 258  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 259  	  SPROC_NAME, 'Opened/Pending invoices founded');
15:21:32 260  WHEN BAD_ACOUNT_ID THEN
15:21:32 261  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 262  	  SPROC_NAME, 'No such account');
15:21:32 263  WHEN CAN_NOT_ANNOTATE_ACCOUNT THEN
15:21:32 264  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 265  	  SPROC_NAME, 'Could not annotate account', EXCEPTION_MESSAGE);
15:21:32 266  WHEN OTHERS THEN
15:21:32 267  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 268  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 269  END DISABLE_ACCOUNT;
15:21:32 270  
15:21:32 271  /******************************************************************************/
15:21:32 272  
15:21:32 273  PROCEDURE CREATE_ACTIVE_ACCOUNT(
15:21:32 274  /*
15:21:32 275  Throws exceptions:
15:21:32 276  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 277  APP_EXCEPTION_CODES_V18.DUPLICATE_ERROR
15:21:32 278  */
15:21:32 279  	  in_created_by IN VARCHAR2,
15:21:32 280  	  in_group_id	IN NUMBER
15:21:32 281  ) AS
15:21:32 282  -- VARIABLES
15:21:32 283  SPROC_NAME      CONSTANT VARCHAR2(21) := 'CREATE_ACTIVE_ACCOUNT';
15:21:32 284  new_account_id  NUMBER;
15:21:32 285  temp_group_id   NUMBER;
15:21:32 286  -- EXCEPTIONS
15:21:32 287  GROUP_EXISTS_EXCEPTION EXCEPTION;
15:21:32 288  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:32 289  BEGIN
15:21:32 290  	-- Check if account already exists
15:21:32 291  	BEGIN
15:21:32 292  	  SELECT
15:21:32 293  	    ACCOUNT.GROUP_ID into temp_group_id
15:21:32 294  	  FROM
15:21:32 295  	    ACCOUNT
15:21:32 296  	  WHERE
15:21:32 297  	    ACCOUNT.GROUP_ID = in_group_id
15:21:32 298  	    AND ROWNUM <= 1;
15:21:32 299  
15:21:32 300  	  IF SQL%ROWCOUNT = 1 THEN
15:21:32 301  	    RAISE GROUP_EXISTS_EXCEPTION;
15:21:32 302  	  END IF;
15:21:32 303  
15:21:32 304  	  EXCEPTION
15:21:32 305  	    WHEN NO_DATA_FOUND THEN
15:21:32 306  	      NULL;
15:21:32 307  	END;
15:21:32 308  
15:21:32 309  	-- Insert new row into ACCOUNT table
15:21:32 310  	PROCS_ACCOUNT_CRU_V18.CREATE_ACCOUNT(
15:21:32 311  	  out_account_id	=> new_account_id,
15:21:32 312  	  in_account_status_id	=> GLOBAL_STATUSES_V18.ACCOUNT_ACTIVE,
15:21:32 313  	  in_group_id		=> in_group_id,
15:21:32 314  	  in_created_by 	=> in_created_by,
15:21:32 315  	  in_system_category_id => GLOBAL_ENUMS_V18.SYSTEM_CATEGORY_LIVE
15:21:32 316  	);
15:21:32 317  
15:21:32 318  EXCEPTION
15:21:32 319  WHEN GROUP_EXISTS_EXCEPTION THEN
15:21:32 320  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.DUPLICATE_ERROR,
15:21:32 321  	  SPROC_NAME, 'Group already exists');
15:21:32 322  WHEN OTHERS THEN
15:21:32 323  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 324  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 325  END CREATE_ACTIVE_ACCOUNT;
15:21:32 326  
15:21:32 327  /******************************************************************************/
15:21:32 328  
15:21:32 329  PROCEDURE REACTIVATE_ACCOUNT (
15:21:32 330  /*
15:21:32 331  Throws exceptions:
15:21:32 332  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 333  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 334  */
15:21:32 335  	in_group_id   IN NUMBER,
15:21:32 336  	in_updated_by IN VARCHAR2,
15:21:32 337  	in_note       IN VARCHAR2,
15:21:32 338  	in_agent_id   IN NUMBER
15:21:32 339  ) AS
15:21:32 340  -- VARIABLES
15:21:32 341  SPROC_NAME	      CONSTANT VARCHAR2(18) := 'REACTIVATE_ACCOUNT';
15:21:32 342  var_account_id	      NUMBER;
15:21:32 343  current_account_status  NUMBER;
15:21:32 344  
15:21:32 345  -- EXCEPTIONS
15:21:32 346  BAD_CURRENT_ACC_STATUS EXCEPTION;
15:21:32 347  CAN_NOT_CREATE_NOTE    EXCEPTION;
15:21:32 348  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:32 349  BEGIN
15:21:32 350  	-- Get account id, status
15:21:32 351  	SELECT
15:21:32 352  	  ACCOUNT.ACCOUNT_STATUS_ID,
15:21:32 353  	  ACCOUNT.ID
15:21:32 354  	INTO
15:21:32 355  	  current_account_status,
15:21:32 356  	  var_account_id
15:21:32 357  	FROM ACCOUNT
15:21:32 358  	WHERE
15:21:32 359  	  ACCOUNT.GROUP_ID = in_group_id;
15:21:32 360  
15:21:32 361  	IF current_account_status != GLOBAL_STATUSES_V18.ACCOUNT_FROZEN THEN
15:21:32 362  	  RAISE BAD_CURRENT_ACC_STATUS;
15:21:32 363  	END IF;
15:21:32 364  
15:21:32 365  	-- Change account status
15:21:32 366  	PROCS_ACCOUNT_V18.UPDATE_ACCOUNT_STATUS(
15:21:32 367  	  in_account_id        => var_account_id,
15:21:32 368  	  in_updated_by        => in_updated_by,
15:21:32 369  	  in_account_status_id => GLOBAL_STATUSES_V18.ACCOUNT_ACTIVE
15:21:32 370  	);
15:21:32 371  
15:21:32 372  	-- Add note
15:21:32 373  	BEGIN
15:21:32 374  	  PROCS_ACCOUNT_V18.ANNOTATE_ACCOUNT(
15:21:32 375  	    in_group_id   => in_group_id,
15:21:32 376  	    in_agent_id   => in_agent_id,
15:21:32 377  	    in_note	  => in_note,
15:21:32 378  	    in_created_by => in_updated_by
15:21:32 379  	  );
15:21:32 380  	  EXCEPTION
15:21:32 381  	    WHEN OTHERS THEN
15:21:32 382  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:32 383  	      RAISE CAN_NOT_CREATE_NOTE;
15:21:32 384  	END;
15:21:32 385  
15:21:32 386  EXCEPTION
15:21:32 387  WHEN BAD_CURRENT_ACC_STATUS THEN
15:21:32 388  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 389  	  SPROC_NAME, 'Current account status is not "frozen"');
15:21:32 390  WHEN NO_DATA_FOUND THEN
15:21:32 391  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 392  	  SPROC_NAME, 'Could not find account with given group ID');
15:21:32 393  WHEN CAN_NOT_CREATE_NOTE THEN
15:21:32 394  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 395  	  SPROC_NAME, 'Could not annotate account');
15:21:32 396  WHEN OTHERS THEN
15:21:32 397  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 398  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 399  END REACTIVATE_ACCOUNT;
15:21:32 400  
15:21:32 401  /******************************************************************************/
15:21:32 402  
15:21:32 403  PROCEDURE GET_ACCOUNT_CREDIT_CARDS (
15:21:32 404  	in_group_id    IN ACCOUNT.GROUP_ID%TYPE,
15:21:32 405  	in_status_id   IN CREDIT_CARD.CREDIT_CARD_STATUS_ID%TYPE DEFAULT GLOBAL_STATUSES_V18.CREDIT_CARD_ACTIVE,
15:21:32 406  	out_result_set OUT SYS_REFCURSOR
15:21:32 407  ) AS
15:21:32 408  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_ACCOUNT_CREDIT_CARDS';
15:21:32 409  BEGIN
15:21:32 410  	OPEN out_result_set FOR
15:21:32 411  	  SELECT
15:21:32 412  	    CREDIT_CARD.ID,
15:21:32 413  	    CREDIT_CARD.ACCOUNT_ID,
15:21:32 414  	    CREDIT_CARD.INSTRUMENT_NAME,
15:21:32 415  	    CREDIT_CARD.PRIVATE_CARD_HOLDER_NAME,
15:21:32 416  	    CREDIT_CARD.PRIVATE_STREET_ADDRESS,
15:21:32 417  	    CREDIT_CARD.PRIVATE_STREET_ADDRESS2,
15:21:32 418  	    CREDIT_CARD.STATE,
15:21:32 419  	    CREDIT_CARD.CITY,
15:21:32 420  	    CREDIT_CARD.POSTAL_CODE,
15:21:32 421  	    CREDIT_CARD.COUNTRY,
15:21:32 422  	    CREDIT_CARD.LAST_FOUR_CC,
15:21:32 423  	    CREDIT_CARD.EXPIRATION_DATE,
15:21:32 424  	    CREDIT_CARD.CREDIT_CARD_TYPE_ID,
15:21:32 425  	    CREDIT_CARD.SECRET_TOKEN,
15:21:32 426  	    CREDIT_CARD.CREATE_DATE,
15:21:32 427  	    CREDIT_CARD.CREATED_BY,
15:21:32 428  	    CREDIT_CARD.UPDATE_DATE,
15:21:32 429  	    CREDIT_CARD.UPDATED_BY,
15:21:32 430  	    CREDIT_CARD.CREDIT_CARD_STATUS_ID,
15:21:32 431  	    CREDIT_CARD.PRIVATE_FIRST_NAME,
15:21:32 432  	    Credit_Card.Private_Last_Name,
15:21:32 433  	    decode((SELECT Instrument_Id FROM ACCOUNT WHERE group_id = in_group_id and Instrument_Id = CREDIT_CARD.ID),null,'false', 'true') is_default
15:21:32 434  	  From
15:21:32 435  	      CREDIT_CARD left join account on account.id = CREDIT_CARD.Account_Id
15:21:32 436  	  Where
15:21:32 437  	    Account.Group_Id = in_group_id
15:21:32 438  	    AND CREDIT_CARD.CREDIT_CARD_STATUS_ID = in_status_id;
15:21:32 439  END GET_ACCOUNT_CREDIT_CARDS;
15:21:32 440  
15:21:32 441  /******************************************************************************/
15:21:32 442  
15:21:32 443  PROCEDURE GET_ACCOUNT_GIFT_CERTIFICATES (
15:21:32 444  /*
15:21:32 445  IN:
15:21:32 446  instr_status:
15:21:32 447  GLOBAL_CONSTANTS_V18.TRUE - get active instruments only (default)
15:21:32 448  GLOBAL_CONSTANTS_V18.FALSE - get inactive instruments only
15:21:32 449  
15:21:32 450  Throws exceptions:
15:21:32 451  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 452  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 453  */
15:21:32 454  	in_group_id	  IN NUMBER,
15:21:32 455  	out_result_gc_set OUT SYS_REFCURSOR,
15:21:32 456  	in_instr_status   IN NUMBER DEFAULT GLOBAL_CONSTANTS_V18.TRUE
15:21:32 457  ) AS
15:21:32 458  SPROC_NAME     CONSTANT VARCHAR2(29) := 'GET_ACCOUNT_GIFT_CERTIFICATES';
15:21:32 459  var_account_id NUMBER;
15:21:32 460  
15:21:32 461  -- Exceptions
15:21:32 462  WRONG_INSTR_EXCEPTION	 EXCEPTION;
15:21:32 463  BEGIN
15:21:32 464  
15:21:32 465  	-- Get account id
15:21:32 466  	SELECT
15:21:32 467  	  ACCOUNT.ID INTO var_account_id
15:21:32 468  	FROM
15:21:32 469  	  ACCOUNT
15:21:32 470  	WHERE
15:21:32 471  	  ACCOUNT.GROUP_ID = in_group_id;
15:21:32 472  
15:21:32 473  	-- Check that incoming data is correct
15:21:32 474  	IF in_instr_status != GLOBAL_CONSTANTS_V18.TRUE AND in_instr_status != GLOBAL_CONSTANTS_V18.FALSE THEN
15:21:32 475  	  RAISE WRONG_INSTR_EXCEPTION;
15:21:32 476  	END IF;
15:21:32 477  
15:21:32 478  	OPEN out_result_gc_set FOR
15:21:32 479  	SELECT
15:21:32 480  	  GIFT_CERTIFICATE.ID,
15:21:32 481  	  GIFT_CERTIFICATE.PURCHASER_GROUP_ID,
15:21:32 482  	  GIFT_CERTIFICATE.PURCHASE_INVOICE_ID,
15:21:32 483  	  GIFT_CERTIFICATE.PURCHASE_DATE,
15:21:32 484  	  GIFT_CERTIFICATE.OFFER_CHAIN_ID,
15:21:32 485  	  GIFT_CERTIFICATE.EXPIRATION_DATE,
15:21:32 486  	  GIFT_CERTIFICATE.GIFT_CERTIFICATE_STATUS_ID,
15:21:32 487  	  GIFT_CERTIFICATE.CODE,
15:21:32 488  	  GIFT_CERTIFICATE.CREATE_DATE,
15:21:32 489  	  GIFT_CERTIFICATE.CREATED_BY,
15:21:32 490  	  GIFT_CERTIFICATE.UPDATE_DATE,
15:21:32 491  	  GIFT_CERTIFICATE.UPDATED_BY,
15:21:32 492  	  GIFT_CERTIFICATE.RECIPIENT_NAME,
15:21:32 493  	  GIFT_CERTIFICATE.RECIPIENT_EMAIL,
15:21:32 494  	  GIFT_CERTIFICATE.SENDER_NAME,
15:21:32 495  	  GIFT_CERTIFICATE.SENDER_EMAIL,
15:21:32 496  	  GIFT_CERTIFICATE.REDEEMER_GROUP_ID,
15:21:32 497  	  GIFT_CERTIFICATE.REDEMPTION_DATE,
15:21:32 498  	  GIFT_CERTIFICATE.FINALIZED_INVOICE_ID,
15:21:32 499  	  GIFT_CERTIFICATE.GIFT_MESSAGE
15:21:32 500  	FROM
15:21:32 501  	  GIFT_CERTIFICATE
15:21:32 502  	WHERE
15:21:32 503  	  GIFT_CERTIFICATE.PURCHASER_GROUP_ID = in_group_id
15:21:32 504  	  AND (
15:21:32 505  		( in_instr_status = GLOBAL_CONSTANTS_V18.TRUE AND
15:21:32 506  		  (
15:21:32 507  		    GIFT_CERTIFICATE.EXPIRATION_DATE >= current_date
15:21:32 508  		    AND GIFT_CERTIFICATE.GIFT_CERTIFICATE_STATUS_ID = GLOBAL_STATUSES_V18.GIFT_CERTIFICATE_ACTIVE
15:21:32 509  		  )
15:21:32 510  		)
15:21:32 511  		OR
15:21:32 512  		(
15:21:32 513  		  in_instr_status = GLOBAL_CONSTANTS_V18.FALSE AND
15:21:32 514  		  (
15:21:32 515  		    GIFT_CERTIFICATE.EXPIRATION_DATE < current_date
15:21:32 516  		    OR GIFT_CERTIFICATE.GIFT_CERTIFICATE_STATUS_ID != GLOBAL_STATUSES_V18.GIFT_CERTIFICATE_ACTIVE
15:21:32 517  		  )
15:21:32 518  		)
15:21:32 519  	      );
15:21:32 520  
15:21:32 521  EXCEPTION
15:21:32 522  WHEN NO_DATA_FOUND THEN
15:21:32 523  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 524  	  SPROC_NAME, 'Can not find account with given group id');
15:21:32 525  WHEN WRONG_INSTR_EXCEPTION THEN
15:21:32 526  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 527  	  SPROC_NAME, 'Wrong gift certificate type');
15:21:32 528  WHEN OTHERS THEN
15:21:32 529  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 530  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 531  END GET_ACCOUNT_GIFT_CERTIFICATES;
15:21:32 532  
15:21:32 533  /******************************************************************************/
15:21:32 534  
15:21:32 535  PROCEDURE GET_ACCOUNT_INFO  (
15:21:32 536  /*
15:21:32 537  Throws exceptions:
15:21:32 538  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 539  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 540  */
15:21:32 541  	  in_group_id	    IN	NUMBER,
15:21:32 542  	  out_account_info  OUT SYS_REFCURSOR
15:21:32 543  ) AS
15:21:32 544  SPROC_NAME      CONSTANT VARCHAR2(16) := 'GET_ACCOUNT_INFO';
15:21:32 545  var_account_id  NUMBER;
15:21:32 546  BEGIN
15:21:32 547  
15:21:32 548  	-- Get account id
15:21:32 549  	SELECT
15:21:32 550  	  ACCOUNT.ID INTO var_account_id
15:21:32 551  	FROM
15:21:32 552  	  ACCOUNT
15:21:32 553  	WHERE
15:21:32 554  	  ACCOUNT.GROUP_ID = in_group_id;
15:21:32 555  
15:21:32 556  	-- Get account info
15:21:32 557  	OPEN out_account_info FOR
15:21:32 558  	  SELECT
15:21:32 559  	    ACCOUNT.ACCOUNT_STATUS_ID
15:21:32 560  	  FROM ACCOUNT
15:21:32 561  	  WHERE
15:21:32 562  	    ACCOUNT.GROUP_ID = in_group_id;
15:21:32 563  
15:21:32 564  EXCEPTION
15:21:32 565  WHEN NO_DATA_FOUND THEN
15:21:32 566  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 567  	  SPROC_NAME, 'No such account');
15:21:32 568  WHEN OTHERS THEN
15:21:32 569  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 570  	  SPROC_NAME, 'Unknown Error', SQLERRM);
15:21:32 571  END GET_ACCOUNT_INFO;
15:21:32 572  
15:21:32 573  /******************************************************************************/
15:21:32 574  
15:21:32 575  PROCEDURE GET_ACCOUNT_NOTES (
15:21:32 576  /*
15:21:32 577  Throws exceptions:
15:21:32 578  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 579  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 580  */
15:21:32 581  	  in_group_id	 IN  NUMBER,
15:21:32 582  	  out_result_set OUT SYS_REFCURSOR
15:21:32 583  ) AS
15:21:32 584  -- VARIABLES
15:21:32 585  SPROC_NAME      CONSTANT VARCHAR2(17) := 'GET_ACCOUNT_NOTES';
15:21:32 586  var_account_id NUMBER;
15:21:32 587  -- EXCEPTIONS
15:21:32 588  BAD_ACCOUNT_ID EXCEPTION;
15:21:32 589  BEGIN
15:21:32 590  
15:21:32 591  	-- Check that account is exists
15:21:32 592  	BEGIN
15:21:32 593  	  SELECT
15:21:32 594  	    ACCOUNT.ID into var_account_id
15:21:32 595  	  FROM
15:21:32 596  	    ACCOUNT
15:21:32 597  	  WHERE
15:21:32 598  	    ACCOUNT.GROUP_ID = in_group_id;
15:21:32 599  	  EXCEPTION
15:21:32 600  	    WHEN NO_DATA_FOUND THEN
15:21:32 601  	      RAISE BAD_ACCOUNT_ID;
15:21:32 602  	END;
15:21:32 603  
15:21:32 604  	-- Get account notes
15:21:32 605  	OPEN out_result_set FOR
15:21:32 606  	SELECT
15:21:32 607  	  ACCOUNT_NOTE.ACCOUNT_ID,
15:21:32 608  	  ACCOUNT_NOTE.AGENT_ID,
15:21:32 609  	  ACCOUNT_NOTE.CREATE_DATE,
15:21:32 610  	  ACCOUNT_NOTE.CREATED_BY,
15:21:32 611  	  ACCOUNT_NOTE.ID,
15:21:32 612  	  ACCOUNT_NOTE.NOTE
15:21:32 613  	FROM
15:21:32 614  	  ACCOUNT_NOTE
15:21:32 615  	WHERE
15:21:32 616  	  ACCOUNT_NOTE.ACCOUNT_ID = var_account_id
15:21:32 617  	ORDER BY
15:21:32 618  	  ACCOUNT_NOTE.CREATE_DATE ASC;
15:21:32 619  
15:21:32 620  EXCEPTION
15:21:32 621  WHEN BAD_ACCOUNT_ID THEN
15:21:32 622  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 623  	  SPROC_NAME, 'No such account');
15:21:32 624  WHEN OTHERS THEN
15:21:32 625  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 626  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 627  END GET_ACCOUNT_NOTES;
15:21:32 628  
15:21:32 629  /******************************************************************************/
15:21:32 630  
15:21:32 631  PROCEDURE GET_ACCOUNT_PAYPALS(
15:21:32 632  	in_group_id    IN  ACCOUNT.GROUP_ID%TYPE,
15:21:32 633  	in_status_id   IN  PAYPAL.PAYPAL_STATUS_ID%TYPE DEFAULT GLOBAL_STATUSES_V18.PAYPAL_ACTIVE,
15:21:32 634  	out_result_set OUT SYS_REFCURSOR
15:21:32 635  ) AS
15:21:32 636  SPROC_NAME     CONSTANT VARCHAR2(32) := 'GET_ACCOUNT_PAYPALS';
15:21:32 637  BEGIN
15:21:32 638  	OPEN out_result_set FOR
15:21:32 639  	  SELECT
15:21:32 640  	    DISTINCT
15:21:32 641  	    PAYPAL.ID,
15:21:32 642  	    PAYPAL.ACCOUNT_ID,
15:21:32 643  	    PAYPAL.INSTRUMENT_NAME,
15:21:32 644  	    PAYPAL.PRIVATE_EMAIL_ADDRESS,
15:21:32 645  	    PAYPAL.CREATE_DATE,
15:21:32 646  	    PAYPAL.CREATED_BY,
15:21:32 647  	    PAYPAL.UPDATE_DATE,
15:21:32 648  	    PAYPAL.UPDATED_BY,
15:21:32 649  	    PAYPAL.PAYPAL_STATUS_ID,
15:21:32 650  	    PAYPAL.PRIVATE_STREET_ADDRESS,
15:21:32 651  	    PAYPAL.PRIVATE_STREET_ADDRESS2,
15:21:32 652  	    PAYPAL.STATE,
15:21:32 653  	    PAYPAL.CITY,
15:21:32 654  	    PAYPAL.POSTAL_CODE,
15:21:32 655  	    PAYPAL.COUNTRY,
15:21:32 656  	    Paypal.Expiration_Date,
15:21:32 657  	    Paypal.Secret_Token,
15:21:32 658  	    decode((SELECT
15:21:32 659  	    Instrument_Id
15:21:32 660  		    FROM ACCOUNT
15:21:32 661  		    WHERE group_id = in_group_id AND Instrument_Id = PAYPAL.ID), null, 'false', 'true') is_default
15:21:32 662  	  FROM
15:21:32 663  	      PAYPAL
15:21:32 664  	      LEFT JOIN ACCOUNT ON ACCOUNT.id = PAYPAL.ACCOUNT_ID
15:21:32 665  	  WHERE
15:21:32 666  	    ACCOUNT.GROUP_ID = in_group_id
15:21:32 667  	    AND PAYPAL.PAYPAL_STATUS_ID = in_status_id;
15:21:32 668  END GET_ACCOUNT_PAYPALS;
15:21:32 669  
15:21:32 670  /******************************************************************************/
15:21:32 671  
15:21:32 672  PROCEDURE GET_ACCOUNT_SUBSCRIPTIONS (
15:21:32 673  	  in_group_id	 IN  NUMBER,
15:21:32 674  	  in_start_date  IN DATE,
15:21:32 675  	  in_end_date	 IN DATE,
15:21:32 676  	  in_status	 IN NUMBER,
15:21:32 677  	  in_group_account_type IN VARCHAR2,
15:21:32 678  	  out_result_set OUT SYS_REFCURSOR
15:21:32 679  ) AS
15:21:32 680  -- VARIABLES
15:21:32 681  SPROC_NAME     CONSTANT VARCHAR2(25) := 'GET_ACCOUNT_SUBSCRIPTIONS';
15:21:32 682  var_account_id NUMBER;
15:21:32 683  -- EXCEPTIONS
15:21:32 684  BAD_GROUP_ID	      EXCEPTION;
15:21:32 685  BEGIN
15:21:32 686  	-- Get account id
15:21:32 687  	BEGIN
15:21:32 688  	  SELECT
15:21:32 689  	    ACCOUNT.ID INTO var_account_id
15:21:32 690  	  FROM
15:21:32 691  	    ACCOUNT
15:21:32 692  	  WHERE
15:21:32 693  	    ACCOUNT.GROUP_ID = in_group_id;
15:21:32 694  	  EXCEPTION
15:21:32 695  	    WHEN NO_DATA_FOUND THEN
15:21:32 696  	      RAISE BAD_GROUP_ID;
15:21:32 697  	END;
15:21:32 698  
15:21:32 699  	-- Get information about account subscriptions
15:21:32 700  	OPEN out_result_set FOR
15:21:32 701  	SELECT
15:21:32 702  	  in_group_id AS "GROUP_ID",
15:21:32 703  	  SUBSCRIPTION.ID AS "SUBSCRIPTION_ID",
15:21:32 704  	  SUBSCRIPTION.SUBSCRIPTION_STATUS_ID,
15:21:32 705  	  SUBSCRIPTION.PURCHASE_DATE,
15:21:32 706  	  SUBSCRIPTION.SUSPEND_DATE,
15:21:32 707  	  SUBSCRIPTION.REACTIVATION_DATE,
15:21:32 708  	  SUBSCRIPTION.CANCELLATION_DATE,
15:21:32 709  	  SUBSCRIPTION_CANCEL_REASON.VALUE as "CANCEL_TYPE",
15:21:32 710  	  SUBSCRIPTION.INSTRUMENT_ID,
15:21:32 711  	  SUBSCRIPTION.INSTRUMENT_TYPE_ID,
15:21:32 712  	  OFFER_CHAIN.ID AS "OFFER_CHAIN_ID",
15:21:32 713  	  OFFER_CHAIN.NAME,
15:21:32 714  	  OFFER_CHAIN.DESCRIPTION,
15:21:32 715  	  OFFER_CHAIN.PRODUCT_URI,
15:21:32 716  	  PROCS_SUBSCRIPTION_V18.CALC_SUBSCRIPTION_END_DATE(SUBSCRIPTION.ID) as "END_DATE",
15:21:32 717  	  PROCS_SUBSCRIPTION_V18.GET_RECENT_CHARGE(SUBSCRIPTION.ID) AS "RECENT_CHARGE",
15:21:32 718  	  PROCS_SUBSCRIPTION_V18.GET_RENEWAL_DATE(SUBSCRIPTION.ID) AS "RENEWAL_DATE",
15:21:32 719  	  PROCS_SUBSCRIPTION_V18.GET_BILLING_CYCLE(SUBSCRIPTION.ID) AS "BILLING_CYCLE",
15:21:32 720  	  PROCS_SUBSCRIPTION_V18.IS_SUBSCRIPTION_CANCELABLE(SUBSCRIPTION.ID) AS "IS_CANCELABLE",
15:21:32 721  	  ITUNES_RECEIPT.ID AS "ITUNES_RECEIPT_ID",
15:21:32 722  	  (
15:21:32 723  	    SELECT
15:21:32 724  	      MAX(ENTITLEMENT_END_DATE)
15:21:32 725  	      FROM LICENSE
15:21:32 726  	      WHERE LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
15:21:32 727  	  )
15:21:32 728  	  as "ENT_END_DATE",
15:21:32 729  	  (
15:21:32 730  	    SELECT
15:21:32 731  	      MIN(START_DATE)
15:21:32 732  	      FROM LICENSE
15:21:32 733  	      WHERE LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
15:21:32 734  	  )
15:21:32 735  	  as "ENT_START_DATE",
15:21:32 736  	  GROUP_ACCOUNT.SUBSCRIPTION_ID GA_SUBSCRIPTION_ID,
15:21:32 737  	  GROUP_ACCOUNT.ID GA_ID,
15:21:32 738  	  GROUP_ACCOUNT.GROUP_NAME GA_GROUP_NAME,
15:21:32 739  	  GROUP_ACCOUNT.FIRST_NAME GA_FIRST_NAME,
15:21:32 740  	  GROUP_ACCOUNT.LAST_NAME GA_LAST_NAME,
15:21:32 741  	  GROUP_ACCOUNT.EMAIL GA_EMAIL,
15:21:32 742  	  GROUP_ACCOUNT.PHONE GA_PHONE,
15:21:32 743  	  GROUP_ACCOUNT.ORGANIZATION_TYPE GA_ORGANIZATION_TYPE,
15:21:32 744  	  GROUP_ACCOUNT.SEATS GA_SEATS,
15:21:32 745  	  PROCS_GROUP_ACCOUNT_V18.F_GET_NUM_OCCUPIED_GROUP_SEATS(GROUP_ACCOUNT.ID) GA_SEATS_USED,
15:21:32 746  	  GROUP_ACCOUNT.IP GA_IP,
15:21:32 747  	  PROCS_SUBSCRIPTION_V18.GET_GIFT_CERT_CODE_BY_SUB_ID(SUBSCRIPTION.ID) GIFT_CERTIFICATE_CODE,
15:21:32 748  	  PROCS_ACCOUNT_V18.GET_GRACE_START_DATE(SUBSCRIPTION.ID) GRACE_START_DATE,
15:21:32 749  	  PROCS_ACCOUNT_V18.GET_GRACE_END_DATE(SUBSCRIPTION.ID) GRACE_END_DATE
15:21:32 750  	FROM
15:21:32 751  	  SUBSCRIPTION
15:21:32 752  	  INNER JOIN OFFER_CHAIN ON SUBSCRIPTION.OFFER_CHAIN_ID = OFFER_CHAIN.ID
15:21:32 753  	  LEFT JOIN SUBSCRIPTION_CANCEL_REASON ON SUBSCRIPTION.SCT_ID = SUBSCRIPTION_CANCEL_REASON.ID
15:21:32 754  	  LEFT JOIN ITUNES_RECEIPT ON SUBSCRIPTION.ID = ITUNES_RECEIPT.SUBSCRIPTION_ID
15:21:32 755  	  LEFT JOIN GROUP_ACCOUNT ON SUBSCRIPTION.ID = GROUP_ACCOUNT.SUBSCRIPTION_ID
15:21:32 756  	WHERE
15:21:32 757  	  SUBSCRIPTION.ACCOUNT_ID = var_account_id
15:21:32 758  	  AND (SUBSCRIPTION.SCT_ID IS NULL OR SUBSCRIPTION.SCT_ID != GLOBAL_STATUSES_V18.REAL_TIME_CANCEL_REASON)
15:21:32 759  	  AND SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = NVL(in_status, SUBSCRIPTION.SUBSCRIPTION_STATUS_ID)
15:21:32 760  	  AND PROCS_COMMON_V18.NORMALIZE_DATE(SUBSCRIPTION.PURCHASE_DATE) >= NVL(in_start_date, PROCS_COMMON_V18.NORMALIZE_DATE(SUBSCRIPTION.PURCHASE_DATE))
15:21:32 761  	  AND PROCS_COMMON_V18.NORMALIZE_DATE(SUBSCRIPTION.PURCHASE_DATE) <= NVL(in_end_date, PROCS_COMMON_V18.NORMALIZE_DATE(SUBSCRIPTION.PURCHASE_DATE))
15:21:32 762  	  AND (in_group_account_type IS NULL OR OFFER_CHAIN.GROUP_ACCOUNT_TYPE_ID = in_group_account_type);
15:21:32 763  
15:21:32 764  EXCEPTION
15:21:32 765  WHEN BAD_GROUP_ID THEN
15:21:32 766  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 767  	  SPROC_NAME, 'Can not find account with given group id');
15:21:32 768  WHEN OTHERS THEN
15:21:32 769  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 770  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 771  END GET_ACCOUNT_SUBSCRIPTIONS;
15:21:32 772  
15:21:32 773  /******************************************************************************/
15:21:32 774  
15:21:32 775  PROCEDURE FREEZE_ACCOUNT (
15:21:32 776  /*
15:21:32 777  Throws exceptions:
15:21:32 778  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 779  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 780  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 781  */
15:21:32 782  	in_group_id   IN NUMBER,
15:21:32 783  	in_updated_by IN VARCHAR2,
15:21:32 784  	in_note       IN VARCHAR2,
15:21:32 785  	in_agent_id   IN NUMBER
15:21:32 786  ) AS
15:21:32 787  SPROC_NAME	    CONSTANT VARCHAR2(14) := 'FREEZE_ACCOUNT';
15:21:32 788  -- VARIABLES
15:21:32 789  var_account_id	    NUMBER;
15:21:32 790  var_account_status_id NUMBER;
15:21:32 791  -- EXCEPTIONS
15:21:32 792  BAD_GROUP_ID	    EXCEPTION;
15:21:32 793  BAD_ACCOUNT_STATUS_ID EXCEPTION;
15:21:32 794  CAN_NOT_CREATE_NOTE   EXCEPTION;
15:21:32 795  EXCEPTION_MESSAGE     VARCHAR2(1024);
15:21:32 796  BEGIN
15:21:32 797  
15:21:32 798  	-- Get account status, account id
15:21:32 799  	BEGIN
15:21:32 800  	  SELECT
15:21:32 801  	    ACCOUNT.ID,
15:21:32 802  	    ACCOUNT.ACCOUNT_STATUS_ID
15:21:32 803  	    into
15:21:32 804  	    var_account_id,
15:21:32 805  	    var_account_status_id
15:21:32 806  	  FROM
15:21:32 807  	    ACCOUNT
15:21:32 808  	  WHERE
15:21:32 809  	    ACCOUNT.GROUP_ID = in_group_id;
15:21:32 810  	  EXCEPTION
15:21:32 811  	    WHEN NO_DATA_FOUND THEN
15:21:32 812  	      RAISE BAD_GROUP_ID;
15:21:32 813  	END;
15:21:32 814  
15:21:32 815  	-- We can freeze only ACTIVE accounts
15:21:32 816  	IF var_account_status_id != GLOBAL_STATUSES_V18.ACCOUNT_ACTIVE
15:21:32 817  	  AND var_account_status_id != GLOBAL_STATUSES_V18.ACCOUNT_FROZEN THEN
15:21:32 818  	  RAISE BAD_ACCOUNT_STATUS_ID;
15:21:32 819  	END IF;
15:21:32 820  
15:21:32 821  	-- Set account status
15:21:32 822  	PROCS_ACCOUNT_V18.UPDATE_ACCOUNT_STATUS(
15:21:32 823  	  in_account_id        => var_account_id,
15:21:32 824  	  in_updated_by        => in_updated_by,
15:21:32 825  	  in_account_status_id => GLOBAL_STATUSES_V18.ACCOUNT_FROZEN
15:21:32 826  	);
15:21:32 827  
15:21:32 828  	-- Annotate account
15:21:32 829  	BEGIN
15:21:32 830  	  PROCS_ACCOUNT_V18.ANNOTATE_ACCOUNT(
15:21:32 831  	    in_group_id   => in_group_id,
15:21:32 832  	    in_agent_id   => in_agent_id,
15:21:32 833  	    in_note	  => in_note,
15:21:32 834  	    in_created_by => in_updated_by
15:21:32 835  	  );
15:21:32 836  	  EXCEPTION
15:21:32 837  	    WHEN OTHERS THEN
15:21:32 838  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:32 839  	      RAISE CAN_NOT_CREATE_NOTE;
15:21:32 840  	END;
15:21:32 841  
15:21:32 842  EXCEPTION
15:21:32 843  WHEN BAD_GROUP_ID THEN
15:21:32 844  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 845  	  SPROC_NAME, 'No such group id');
15:21:32 846  WHEN BAD_ACCOUNT_STATUS_ID THEN
15:21:32 847  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.STATE_ERROR,
15:21:32 848  	  SPROC_NAME, 'Could not update this account. Status should to be active or frozen');
15:21:32 849  WHEN CAN_NOT_CREATE_NOTE THEN
15:21:32 850  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:32 851  	  SPROC_NAME, 'Could not annotate account', EXCEPTION_MESSAGE);
15:21:32 852  WHEN OTHERS THEN
15:21:32 853  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 854  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 855  END FREEZE_ACCOUNT;
15:21:32 856  
15:21:32 857  /******************************************************************************/
15:21:32 858  
15:21:32 859  PROCEDURE GET_ACCOUNT_SUBSCR_INVOICES (
15:21:32 860  /*
15:21:32 861  Throws exceptions:
15:21:32 862  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 863  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 864  */
15:21:32 865  	in_group_id	   IN  NUMBER,
15:21:32 866  	in_subscription_id IN NUMBER,
15:21:32 867  	out_result_set	   OUT SYS_REFCURSOR
15:21:32 868  ) AS
15:21:32 869  SPROC_NAME	   CONSTANT VARCHAR2(27) := 'GET_ACCOUNT_SUBSCR_INVOICES';
15:21:32 870  -- VARIABLES
15:21:32 871  var_account_id	   NUMBER;
15:21:32 872  temp_subscription_id NUMBER;
15:21:32 873  -- EXCEPTIONS
15:21:32 874  BAD_GROUP_ID	  EXCEPTION;
15:21:32 875  BAD_SUBSCRIPTION_ID EXCEPTION;
15:21:32 876  BEGIN
15:21:32 877  	-- Get account id
15:21:32 878  	BEGIN
15:21:32 879  	  SELECT
15:21:32 880  	    ACCOUNT.ID into var_account_id
15:21:32 881  	  FROM
15:21:32 882  	    ACCOUNT
15:21:32 883  	  WHERE
15:21:32 884  	    ACCOUNT.GROUP_ID = in_group_id;
15:21:32 885  	  EXCEPTION
15:21:32 886  	    WHEN NO_DATA_FOUND THEN
15:21:32 887  	      RAISE BAD_GROUP_ID;
15:21:32 888  	END;
15:21:32 889  
15:21:32 890  	-- Check that subscription exists
15:21:32 891  	BEGIN
15:21:32 892  	  IF in_subscription_id IS NOT NULL THEN
15:21:32 893  	    SELECT
15:21:32 894  	      SUBSCRIPTION.ID into temp_subscription_id
15:21:32 895  	    FROM
15:21:32 896  	      SUBSCRIPTION
15:21:32 897  	    WHERE
15:21:32 898  	      SUBSCRIPTION.ID = in_subscription_id;
15:21:32 899  	  END IF;
15:21:32 900  	  EXCEPTION
15:21:32 901  	    WHEN NO_DATA_FOUND THEN
15:21:32 902  	      RAISE BAD_SUBSCRIPTION_ID;
15:21:32 903  	END;
15:21:32 904  
15:21:32 905  	OPEN out_result_set FOR
15:21:32 906  	SELECT DISTINCT
15:21:32 907  	  INVOICE.ID as "INVOICE_ID",
15:21:32 908  	  INVOICE.CREATE_DATE,
15:21:32 909  	  INVOICE.INVOICE_STATUS_ID,
15:21:32 910  	  PROCS_INVOICE_V18.F_CALCULATE_INVOICE_AMOUNT(INVOICE.ID) as "AMOUNT",
15:21:32 911  	  OFFER_CHAIN.ID as "OFFER_CHAIN_ID",
15:21:32 912  	  OFFER_CHAIN.NAME as "OFFER_CHAIN_NAME",
15:21:32 913  	  SUBSCRIPTION.ID as "SUBSCRIPTION_ID",
15:21:32 914  	  NULL as "GC_CODE",
15:21:32 915  	  NULL as "GC_ID"
15:21:32 916  	FROM
15:21:32 917  	  LICENSE
15:21:32 918  	  INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
15:21:32 919  	  INNER JOIN INVOICE ON LICENSE.INVOICE_ID = INVOICE.ID
15:21:32 920  	  INNER JOIN OFFER_CHAIN ON SUBSCRIPTION.OFFER_CHAIN_ID = OFFER_CHAIN.ID
15:21:32 921  	WHERE
15:21:32 922  	  SUBSCRIPTION.ACCOUNT_ID = var_account_id
15:21:32 923  	  AND (SUBSCRIPTION.SCT_ID IS NULL OR SUBSCRIPTION.SCT_ID != GLOBAL_STATUSES_V18.REAL_TIME_CANCEL_REASON)
15:21:32 924  	  AND SUBSCRIPTION.ID = NVL(in_subscription_id, SUBSCRIPTION.ID);
15:21:32 925  
15:21:32 926  EXCEPTION
15:21:32 927  WHEN BAD_GROUP_ID THEN
15:21:32 928  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 929  	  SPROC_NAME, 'No such account');
15:21:32 930  WHEN BAD_SUBSCRIPTION_ID THEN
15:21:32 931  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 932  	  SPROC_NAME, 'No such subscription');
15:21:32 933  WHEN OTHERS THEN
15:21:32 934  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 935  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 936  END GET_ACCOUNT_SUBSCR_INVOICES;
15:21:32 937  
15:21:32 938  /******************************************************************************/
15:21:32 939  
15:21:32 940  PROCEDURE GET_ACCOUNT_GC_INVOICES (
15:21:32 941  /*
15:21:32 942  Throws exceptions:
15:21:32 943  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 944  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 945  */
15:21:32 946  	in_group_id    IN  NUMBER,
15:21:32 947  	out_result_set OUT SYS_REFCURSOR
15:21:32 948  ) AS
15:21:32 949  SPROC_NAME     CONSTANT VARCHAR2(23) := 'GET_ACCOUNT_GC_INVOICES';
15:21:32 950  -- VARIABLES
15:21:32 951  var_account_id NUMBER;
15:21:32 952  -- EXCEPTIONS
15:21:32 953  BAD_GROUP_ID EXCEPTION;
15:21:32 954  BEGIN
15:21:32 955  	-- Get account id
15:21:32 956  	BEGIN
15:21:32 957  	  SELECT
15:21:32 958  	    ACCOUNT.ID into var_account_id
15:21:32 959  	  FROM
15:21:32 960  	    ACCOUNT
15:21:32 961  	  WHERE
15:21:32 962  	    ACCOUNT.GROUP_ID = in_group_id;
15:21:32 963  	  EXCEPTION
15:21:32 964  	    WHEN NO_DATA_FOUND THEN
15:21:32 965  	      RAISE BAD_GROUP_ID;
15:21:32 966  	END;
15:21:32 967  
15:21:32 968  	-- Get invoices
15:21:32 969  	OPEN out_result_set FOR
15:21:32 970  	SELECT DISTINCT
15:21:32 971  	  INVOICE.ID as "INVOICE_ID",
15:21:32 972  	  INVOICE.CREATE_DATE,
15:21:32 973  	  INVOICE.INVOICE_STATUS_ID,
15:21:32 974  	  PROCS_INVOICE_V18.F_CALCULATE_INVOICE_AMOUNT(INVOICE.ID) as "AMOUNT",
15:21:32 975  	  OFFER_CHAIN.ID as "OFFER_CHAIN_ID",
15:21:32 976  	  OFFER_CHAIN.NAME as "OFFER_CHAIN_NAME",
15:21:32 977  	  NULL as "SUBSCRIPTION_ID",
15:21:32 978  	  GIFT_CERTIFICATE.CODE as "GC_CODE",
15:21:32 979  	  GIFT_CERTIFICATE.ID as "GC_ID"
15:21:32 980  	FROM
15:21:32 981  	  GIFT_CERTIFICATE
15:21:32 982  	  INNER JOIN INVOICE ON GIFT_CERTIFICATE.PURCHASE_INVOICE_ID = INVOICE.ID
15:21:32 983  	  INNER JOIN OFFER_CHAIN ON GIFT_CERTIFICATE.OFFER_CHAIN_ID = OFFER_CHAIN.ID
15:21:32 984  	WHERE
15:21:32 985  	  ROWNUM <= 100 AND
15:21:32 986  	  GIFT_CERTIFICATE.PURCHASER_GROUP_ID = in_group_id;
15:21:32 987  
15:21:32 988  EXCEPTION
15:21:32 989  WHEN BAD_GROUP_ID THEN
15:21:32 990  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 991  	  SPROC_NAME, 'No such account');
15:21:32 992  WHEN OTHERS THEN
15:21:32 993  	PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 994  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 995  END GET_ACCOUNT_GC_INVOICES;
15:21:32 996  
15:21:32 997  /******************************************************************************/
15:21:32 998  -- norlov: #38580
15:21:32 999  PROCEDURE GET_GC_INVOICE (
15:21:32 1000  /*
15:21:32 1001  Throws exceptions:
15:21:32 1002  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1003  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 1004  */
15:21:32 1005  	 in_group_id	IN  NUMBER,
15:21:32 1006  	 in_gc_code	IN  VARCHAR2,
15:21:32 1007  	 out_result_set OUT SYS_REFCURSOR
15:21:32 1008  ) AS
15:21:32 1009  SPROC_NAME     CONSTANT VARCHAR2(14) := 'GET_GC_INVOICE';
15:21:32 1010  -- VARIABLES
15:21:32 1011  var_account_id NUMBER;
15:21:32 1012  -- EXCEPTIONS
15:21:32 1013  BAD_GROUP_ID EXCEPTION;
15:21:32 1014  BEGIN
15:21:32 1015  	 -- Get account id
15:21:32 1016  	 BEGIN
15:21:32 1017  	   SELECT
15:21:32 1018  	     ACCOUNT.ID into var_account_id
15:21:32 1019  	   FROM
15:21:32 1020  	     ACCOUNT
15:21:32 1021  	   WHERE
15:21:32 1022  	     ACCOUNT.GROUP_ID = in_group_id;
15:21:32 1023  	   EXCEPTION
15:21:32 1024  	     WHEN NO_DATA_FOUND THEN
15:21:32 1025  	       RAISE BAD_GROUP_ID;
15:21:32 1026  	 END;
15:21:32 1027  
15:21:32 1028  	 -- Get invoice for the GC
15:21:32 1029  	 OPEN out_result_set FOR
15:21:32 1030  	 SELECT DISTINCT
15:21:32 1031  	   INVOICE.ID as "INVOICE_ID",
15:21:32 1032  	   INVOICE.CREATE_DATE,
15:21:32 1033  	   INVOICE.INVOICE_STATUS_ID,
15:21:32 1034  	   PROCS_INVOICE_V18.F_CALCULATE_INVOICE_AMOUNT(INVOICE.ID) as "AMOUNT",
15:21:32 1035  	   OFFER_CHAIN.ID as "OFFER_CHAIN_ID",
15:21:32 1036  	   OFFER_CHAIN.NAME as "OFFER_CHAIN_NAME",
15:21:32 1037  	   NULL as "SUBSCRIPTION_ID",
15:21:32 1038  	   GIFT_CERTIFICATE.CODE as "GC_CODE"
15:21:32 1039  	 FROM
15:21:32 1040  	   GIFT_CERTIFICATE
15:21:32 1041  	   INNER JOIN INVOICE ON GIFT_CERTIFICATE.PURCHASE_INVOICE_ID = INVOICE.ID
15:21:32 1042  	   INNER JOIN OFFER_CHAIN ON GIFT_CERTIFICATE.OFFER_CHAIN_ID = OFFER_CHAIN.ID
15:21:32 1043  	 WHERE
15:21:32 1044  	   GIFT_CERTIFICATE.PURCHASER_GROUP_ID = in_group_id
15:21:32 1045  	   AND GIFT_CERTIFICATE.CODE = in_gc_code;
15:21:32 1046  
15:21:32 1047  EXCEPTION
15:21:32 1048  WHEN BAD_GROUP_ID THEN
15:21:32 1049  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1050  	   SPROC_NAME, 'No such account');
15:21:32 1051  WHEN OTHERS THEN
15:21:32 1052  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1053  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1054  END GET_GC_INVOICE;
15:21:32 1055  /******************************************************************************/
15:21:32 1056  
15:21:32 1057  PROCEDURE GET_ACCOUNT_PRODUCTS (
15:21:32 1058  /*
15:21:32 1059  Throws exceptions:
15:21:32 1060  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1061  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 1062  */
15:21:32 1063  	 in_group_id	IN  NUMBER,
15:21:32 1064  	 out_result_set OUT SYS_REFCURSOR
15:21:32 1065  ) AS
15:21:32 1066  SPROC_NAME     CONSTANT VARCHAR2(20) := 'GET_ACCOUNT_PRODUCTS';
15:21:32 1067  -- VARIABLES
15:21:32 1068  var_account_id NUMBER;
15:21:32 1069  -- EXCEPTIONS
15:21:32 1070  BAD_GROUP_ID EXCEPTION;
15:21:32 1071  BEGIN
15:21:32 1072  	 -- Get account id
15:21:32 1073  	 BEGIN
15:21:32 1074  	   SELECT
15:21:32 1075  	     ACCOUNT.ID into var_account_id
15:21:32 1076  	   FROM
15:21:32 1077  	     ACCOUNT
15:21:32 1078  	   WHERE
15:21:32 1079  	     ACCOUNT.GROUP_ID = in_group_id;
15:21:32 1080  	   EXCEPTION
15:21:32 1081  	     WHEN NO_DATA_FOUND THEN
15:21:32 1082  	       RAISE BAD_GROUP_ID;
15:21:32 1083  	 END;
15:21:32 1084  
15:21:32 1085  	 OPEN out_result_set FOR
15:21:32 1086  	 SELECT DISTINCT
15:21:32 1087  	   PRODUCT.ID,
15:21:32 1088  	   PRODUCT.NAME
15:21:32 1089  	 FROM
15:21:32 1090  	   PRODUCT
15:21:32 1091  	 WHERE
15:21:32 1092  	   PRODUCT.ID IN (
15:21:32 1093  	     SELECT DISTINCT
15:21:32 1094  	       PRODUCT_OFFERING.PRODUCT_ID
15:21:32 1095  	     FROM
15:21:32 1096  	       PRODUCT_OFFERING
15:21:32 1097  	     WHERE
15:21:32 1098  	       PRODUCT_OFFERING.ID IN (
15:21:32 1099  		 SELECT DISTINCT
15:21:32 1100  		   OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID
15:21:32 1101  		 FROM
15:21:32 1102  		   OFFER_PRODUCT_OFFERING
15:21:32 1103  		 WHERE
15:21:32 1104  		   OFFER_PRODUCT_OFFERING.OFFER_ID IN (
15:21:32 1105  		     SELECT DISTINCT
15:21:32 1106  		       OFFER_OFFER_CHAIN.OFFER_ID
15:21:32 1107  		     FROM
15:21:32 1108  		       OFFER_OFFER_CHAIN
15:21:32 1109  		     WHERE
15:21:32 1110  		       OFFER_OFFER_CHAIN.OFFER_CHAIN_ID IN (
15:21:32 1111  			 SELECT DISTINCT
15:21:32 1112  			   SUBSCRIPTION.OFFER_CHAIN_ID
15:21:32 1113  			 FROM
15:21:32 1114  			   SUBSCRIPTION
15:21:32 1115  			 WHERE
15:21:32 1116  			   SUBSCRIPTION.ACCOUNT_ID = var_account_id
15:21:32 1117  		       )
15:21:32 1118  		   )
15:21:32 1119  	       )
15:21:32 1120  	   );
15:21:32 1121  
15:21:32 1122  EXCEPTION
15:21:32 1123  WHEN BAD_GROUP_ID THEN
15:21:32 1124  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1125  	   SPROC_NAME, 'No such account');
15:21:32 1126  WHEN OTHERS THEN
15:21:32 1127  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1128  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1129  END GET_ACCOUNT_PRODUCTS;
15:21:32 1130  
15:21:32 1131  /******************************************************************************/
15:21:32 1132  PROCEDURE GET_ACCOUNT_PROD_OFFERRINGS (
15:21:32 1133  /*
15:21:32 1134  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:32 1135  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 1136  */
15:21:32 1137  	 in_group_id IN NUMBER,
15:21:32 1138  	 out_result_set     OUT SYS_REFCURSOR
15:21:32 1139  ) AS
15:21:32 1140  SPROC_NAME CONSTANT VARCHAR2(27) := 'GET_ACCOUNT_PROD_OFFERRINGS';
15:21:32 1141  -- VARIABLES
15:21:32 1142  var_account_id NUMBER;
15:21:32 1143  -- EXCEPTIONS
15:21:32 1144  BAD_GROUP_ID EXCEPTION;
15:21:32 1145  BEGIN
15:21:32 1146  	  -- Get account id
15:21:32 1147  	 BEGIN
15:21:32 1148  	   SELECT
15:21:32 1149  	     ACCOUNT.ID into var_account_id
15:21:32 1150  	   FROM
15:21:32 1151  	     ACCOUNT
15:21:32 1152  	   WHERE
15:21:32 1153  	     ACCOUNT.GROUP_ID = in_group_id;
15:21:32 1154  	   EXCEPTION
15:21:32 1155  	     WHEN NO_DATA_FOUND THEN
15:21:32 1156  	       RAISE BAD_GROUP_ID;
15:21:32 1157  	 END;
15:21:32 1158  
15:21:32 1159  	 OPEN out_result_set FOR
15:21:32 1160  	 SELECT DISTINCT
15:21:32 1161  	   PRODUCT_OFFERING.ID,
15:21:32 1162  	   PRODUCT_OFFERING.PRODUCT_ID,
15:21:32 1163  	   PRODUCT_OFFERING.TAX_CATEGORY_ID,
15:21:32 1164  	   PRODUCT_OFFERING.UNIT_PRICE,
15:21:32 1165  	   PRODUCT_OFFERING.QUANTITY,
15:21:32 1166  	   PRODUCT_OFFERING.CREATE_DATE,
15:21:32 1167  	   PRODUCT_OFFERING.CREATED_BY,
15:21:32 1168  	   CAPABILITY.ID CAP_ID,
15:21:32 1169  	   CAPABILITY.CODE CAP_CODE,
15:21:32 1170  	   CAPABILITY.DESCRIPTION CAP_DESCRIPTION,
15:21:32 1171  	   CAPABILITY.SHAREABLE CAP_SHAREABLE
15:21:32 1172  	 FROM
15:21:32 1173  	   OFFER_PRODUCT_OFFERING
15:21:32 1174  	   INNER JOIN PRODUCT_OFFERING ON PRODUCT_OFFERING.ID = OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID
15:21:32 1175  	   INNER JOIN CAPABILITY ON PRODUCT_OFFERING.CAPABILITY_ID = CAPABILITY.ID
15:21:32 1176  	 WHERE
15:21:32 1177  	   OFFER_PRODUCT_OFFERING.OFFER_ID IN (
15:21:32 1178  	     SELECT DISTINCT
15:21:32 1179  	       OFFER_OFFER_CHAIN.OFFER_ID
15:21:32 1180  	     FROM
15:21:32 1181  	       OFFER_OFFER_CHAIN
15:21:32 1182  	     WHERE
15:21:32 1183  	       OFFER_OFFER_CHAIN.OFFER_CHAIN_ID IN (
15:21:32 1184  		 SELECT DISTINCT
15:21:32 1185  		   SUBSCRIPTION.OFFER_CHAIN_ID
15:21:32 1186  		 FROM
15:21:32 1187  		   SUBSCRIPTION
15:21:32 1188  		 WHERE
15:21:32 1189  		   SUBSCRIPTION.ACCOUNT_ID = var_account_id
15:21:32 1190  	       )
15:21:32 1191  	   );
15:21:32 1192  
15:21:32 1193  EXCEPTION
15:21:32 1194  WHEN BAD_GROUP_ID THEN
15:21:32 1195  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1196  	   SPROC_NAME, 'No such account');
15:21:32 1197  WHEN OTHERS THEN
15:21:32 1198  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1199  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1200  END GET_ACCOUNT_PROD_OFFERRINGS;
15:21:32 1201  
15:21:32 1202  /******************************************************************************/
15:21:32 1203  
15:21:32 1204  PROCEDURE UPDATE_ACCOUNT_STATUS (
15:21:32 1205  /*
15:21:32 1206  Throws exceptions:
15:21:32 1207  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1208  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 1209  */
15:21:32 1210  	 in_account_id	      IN ACCOUNT.ID%TYPE,
15:21:32 1211  	 in_account_status_id IN ACCOUNT.ACCOUNT_STATUS_ID%TYPE,
15:21:32 1212  	 in_updated_by	      IN ACCOUNT.UPDATED_BY%TYPE
15:21:32 1213  ) AS
15:21:32 1214  SPROC_NAME CONSTANT VARCHAR2(21) := 'UPDATE_ACCOUNT_STATUS';
15:21:32 1215  -- EXCEPTIONS
15:21:32 1216  BAD_ACCOUNT_ID	      EXCEPTION;
15:21:32 1217  BAD_STATUS_ID	      EXCEPTION;
15:21:32 1218  EXCEPTION_MESSAGE      VARCHAR2(1024);
15:21:32 1219  BEGIN
15:21:32 1220  
15:21:32 1221  	 IF in_account_status_id != GLOBAL_STATUSES_V18.ACCOUNT_ACTIVE
15:21:32 1222  	   AND in_account_status_id != GLOBAL_STATUSES_V18.ACCOUNT_FROZEN
15:21:32 1223  	   AND in_account_status_id != GLOBAL_STATUSES_V18.ACCOUNT_DISABLED THEN
15:21:32 1224  	   RAISE BAD_STATUS_ID;
15:21:32 1225  	 END IF;
15:21:32 1226  
15:21:32 1227  	 PROCS_ACCOUNT_CRU_V18.UPDATE_ACCOUNT(
15:21:32 1228  	   in_account_id	=> in_account_id,
15:21:32 1229  	   in_account_status_id => in_account_status_id,
15:21:32 1230  	   in_updated_by	=> in_updated_by
15:21:32 1231  	 );
15:21:32 1232  
15:21:32 1233  	 IF SQL%ROWCOUNT = 0 THEN
15:21:32 1234  	   RAISE BAD_ACCOUNT_ID;
15:21:32 1235  	 END IF;
15:21:32 1236  
15:21:32 1237  EXCEPTION
15:21:32 1238  WHEN BAD_ACCOUNT_ID THEN
15:21:32 1239  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1240  	   SPROC_NAME, 'No such account');
15:21:32 1241  WHEN BAD_STATUS_ID THEN
15:21:32 1242  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 1243  	   SPROC_NAME, 'Bad status id');
15:21:32 1244  WHEN OTHERS THEN
15:21:32 1245  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1246  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1247  END UPDATE_ACCOUNT_STATUS;
15:21:32 1248  
15:21:32 1249  /******************************************************************************/
15:21:32 1250  
15:21:32 1251  PROCEDURE GET_NEEDS_ENTTL_LICENSES_NUM (
15:21:32 1252  /*
15:21:32 1253  Throws exceptions:
15:21:32 1254  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1255  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 1256  */
15:21:32 1257  	 in_group_id	  IN ACCOUNT.GROUP_ID%TYPE,
15:21:32 1258  	 out_licenses_num OUT NUMBER
15:21:32 1259  ) AS
15:21:32 1260  SPROC_NAME CONSTANT VARCHAR2(28) := 'GET_NEEDS_ENTTL_LICENSES_NUM';
15:21:32 1261  -- VARIABLES
15:21:32 1262  var_account_id	  ACCOUNT.GROUP_ID%TYPE;
15:21:32 1263  -- EXCEPTIONS
15:21:32 1264  BAD_ACCOUNT_ID EXCEPTION;
15:21:32 1265  BEGIN
15:21:32 1266  
15:21:32 1267  	 BEGIN
15:21:32 1268  	   SELECT
15:21:32 1269  	     ACCOUNT.ID into var_account_id
15:21:32 1270  	   FROM
15:21:32 1271  	     ACCOUNT
15:21:32 1272  	   WHERE
15:21:32 1273  	     ACCOUNT.GROUP_ID = in_group_id;
15:21:32 1274  	   EXCEPTION
15:21:32 1275  	     WHEN NO_DATA_FOUND THEN
15:21:32 1276  	       RAISE BAD_ACCOUNT_ID;
15:21:32 1277  	 END;
15:21:32 1278  
15:21:32 1279  	 SELECT
15:21:32 1280  	   COUNT(LICENSE.ID) into out_licenses_num
15:21:32 1281  	 FROM
15:21:32 1282  	   LICENSE
15:21:32 1283  	   INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
15:21:32 1284  	 WHERE
15:21:32 1285  	   SUBSCRIPTION.ACCOUNT_ID = var_account_id
15:21:32 1286  	   AND LICENSE.NEEDS_ENTITLEMENTS = GLOBAL_CONSTANTS_V18.TRUE;
15:21:32 1287  
15:21:32 1288  EXCEPTION
15:21:32 1289  WHEN BAD_ACCOUNT_ID THEN
15:21:32 1290  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1291  	   SPROC_NAME, 'No such group id');
15:21:32 1292  WHEN OTHERS THEN
15:21:32 1293  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1294  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1295  END GET_NEEDS_ENTTL_LICENSES_NUM;
15:21:32 1296  
15:21:32 1297  /******************************************************************************/
15:21:32 1298  
15:21:32 1299  PROCEDURE SET_TAX_EXEMPT (
15:21:32 1300  /*
15:21:32 1301  Throws exceptions:
15:21:32 1302  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1303  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 1304  */
15:21:32 1305  	 in_group_id  IN NUMBER,
15:21:32 1306  	 in_exempt_id IN VARCHAR2
15:21:32 1307  ) AS
15:21:32 1308  SPROC_NAME CONSTANT VARCHAR2(14) := 'SET_TAX_EXEMPT';
15:21:32 1309  -- VARIABLES
15:21:32 1310  var_account_id NUMBER;
15:21:32 1311  -- EXCEPTIONS
15:21:32 1312  BAD_GROUP_ID EXCEPTION;
15:21:32 1313  BEGIN
15:21:32 1314  
15:21:32 1315  	 BEGIN
15:21:32 1316  	   SELECT
15:21:32 1317  	     ACCOUNT.ID into var_account_id
15:21:32 1318  	   FROM
15:21:32 1319  	     ACCOUNT
15:21:32 1320  	   WHERE
15:21:32 1321  	     ACCOUNT.GROUP_ID = in_group_id;
15:21:32 1322  	   EXCEPTION
15:21:32 1323  	     WHEN NO_DATA_FOUND THEN
15:21:32 1324  	       RAISE BAD_GROUP_ID;
15:21:32 1325  	 END;
15:21:32 1326  
15:21:32 1327  	 UPDATE
15:21:32 1328  	   ACCOUNT
15:21:32 1329  	 SET
15:21:32 1330  	   ACCOUNT.TAX_EXEMPT_ID = in_exempt_id
15:21:32 1331  	 WHERE
15:21:32 1332  	   ACCOUNT.ID = var_account_id;
15:21:32 1333  
15:21:32 1334  EXCEPTION
15:21:32 1335  WHEN BAD_GROUP_ID THEN
15:21:32 1336  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1337  	   SPROC_NAME, 'No such group id');
15:21:32 1338  WHEN OTHERS THEN
15:21:32 1339  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1340  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1341  END SET_TAX_EXEMPT;
15:21:32 1342  
15:21:32 1343  /******************************************************************************/
15:21:32 1344  
15:21:32 1345  PROCEDURE IS_TAX_EXEMPT (
15:21:32 1346  /*
15:21:32 1347  Throws exceptions:
15:21:32 1348  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1349  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 1350  Return:
15:21:32 1351  	 GLOBAL_CONSTANTS_V18.TRUE if ACCOUNT.EXEMPT_ID is not null
15:21:32 1352  	 GLOBAL_CONSTANTS_V18.FALSE else
15:21:32 1353  */
15:21:32 1354  	 in_group_id	   IN NUMBER,
15:21:32 1355  	 out_is_tax_exempt OUT NUMBER
15:21:32 1356  ) AS
15:21:32 1357  SPROC_NAME CONSTANT VARCHAR2(13) := 'IS_TAX_EXEMPT';
15:21:32 1358  -- VARIABLES
15:21:32 1359  var_is_tax_exempt ACCOUNT.TAX_EXEMPT_ID%TYPE;
15:21:32 1360  -- EXCEPTIONS
15:21:32 1361  BAD_GROUP_ID EXCEPTION;
15:21:32 1362  BEGIN
15:21:32 1363  
15:21:32 1364  	 BEGIN
15:21:32 1365  	   SELECT
15:21:32 1366  	     ACCOUNT.TAX_EXEMPT_ID into var_is_tax_exempt
15:21:32 1367  	   FROM
15:21:32 1368  	     ACCOUNT
15:21:32 1369  	   WHERE
15:21:32 1370  	     ACCOUNT.GROUP_ID = in_group_id;
15:21:32 1371  	   EXCEPTION
15:21:32 1372  	     WHEN NO_DATA_FOUND THEN
15:21:32 1373  	       RAISE BAD_GROUP_ID;
15:21:32 1374  	 END;
15:21:32 1375  
15:21:32 1376  	 IF var_is_tax_exempt IS NULL THEN
15:21:32 1377  	   out_is_tax_exempt := GLOBAL_CONSTANTS_V18.FALSE;
15:21:32 1378  	 ELSE
15:21:32 1379  	   out_is_tax_exempt := GLOBAL_CONSTANTS_V18.TRUE;
15:21:32 1380  	 END IF;
15:21:32 1381  
15:21:32 1382  EXCEPTION
15:21:32 1383  WHEN BAD_GROUP_ID THEN
15:21:32 1384  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1385  	   SPROC_NAME, 'No such group id');
15:21:32 1386  WHEN OTHERS THEN
15:21:32 1387  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1388  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1389  END IS_TAX_EXEMPT;
15:21:32 1390  
15:21:32 1391  /******************************************************************************/
15:21:32 1392  
15:21:32 1393  PROCEDURE GET_GROUP_ID_BY_ACCOUNT_ID (
15:21:32 1394  /*
15:21:32 1395  Throws exceptions:
15:21:32 1396  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1397  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 1398  */
15:21:32 1399  	 in_account_id IN NUMBER,
15:21:32 1400  	 out_group_id  OUT NUMBER
15:21:32 1401  ) AS
15:21:32 1402  SPROC_NAME CONSTANT VARCHAR2(26) := 'GET_GROUP_ID_BY_ACCOUNT_ID';
15:21:32 1403  BEGIN
15:21:32 1404  
15:21:32 1405  	 SELECT
15:21:32 1406  	   ACCOUNT.GROUP_ID into out_group_id
15:21:32 1407  	 FROM
15:21:32 1408  	   ACCOUNT
15:21:32 1409  	 WHERE
15:21:32 1410  	   ACCOUNT.ID = in_account_id;
15:21:32 1411  
15:21:32 1412  EXCEPTION
15:21:32 1413  WHEN NO_DATA_FOUND THEN
15:21:32 1414  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1415  	   SPROC_NAME, 'No such account');
15:21:32 1416  WHEN OTHERS THEN
15:21:32 1417  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1418  	   SPROC_NAME, 'Unknown error');
15:21:32 1419  END GET_GROUP_ID_BY_ACCOUNT_ID;
15:21:32 1420  
15:21:32 1421  /******************************************************************************/
15:21:32 1422  
15:21:32 1423  PROCEDURE GET_ACCOUNT_ID_BY_GROUP_ID (
15:21:32 1424  /*
15:21:32 1425  Throws exceptions:
15:21:32 1426  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1427  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 1428  */
15:21:32 1429  	 in_group_id IN NUMBER,
15:21:32 1430  	 out_account_id  OUT NUMBER
15:21:32 1431  ) AS
15:21:32 1432  SPROC_NAME CONSTANT VARCHAR2(26) := 'GET_ACCOUNT_ID_BY_GROUP_ID';
15:21:32 1433  BEGIN
15:21:32 1434  
15:21:32 1435  	 SELECT
15:21:32 1436  	   ACCOUNT.ID into out_account_id
15:21:32 1437  	 FROM
15:21:32 1438  	   ACCOUNT
15:21:32 1439  	 WHERE
15:21:32 1440  	   ACCOUNT.GROUP_ID = in_group_id;
15:21:32 1441  
15:21:32 1442  EXCEPTION
15:21:32 1443  WHEN NO_DATA_FOUND THEN
15:21:32 1444  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1445  	   SPROC_NAME, 'No such account');
15:21:32 1446  WHEN OTHERS THEN
15:21:32 1447  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1448  	   SPROC_NAME, 'Unknown error');
15:21:32 1449  END GET_ACCOUNT_ID_BY_GROUP_ID;
15:21:32 1450  
15:21:32 1451  /******************************************************************************/
15:21:32 1452  
15:21:32 1453  PROCEDURE GET_GROUPS_ID_BY_INVOICE_ID (
15:21:32 1454  /*
15:21:32 1455  This procedure is using for LOCKING only
15:21:32 1456  
15:21:32 1457  Throws exceptions:
15:21:32 1458  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1459  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 1460  */
15:21:32 1461  	 in_invoice_id IN NUMBER,
15:21:32 1462  	 out_group_ids OUT SYS_REFCURSOR
15:21:32 1463  ) AS
15:21:32 1464  SPROC_NAME CONSTANT VARCHAR2(27) := 'GET_GROUPS_ID_BY_INVOICE_ID';
15:21:32 1465  -- VARIABLES
15:21:32 1466  temp_invoice_id		 NUMBER;
15:21:32 1467  var_subscrib_group_id	 NUMBER;
15:21:32 1468  var_gc_purchaser_group_id NUMBER;
15:21:32 1469  var_gc_redeemer_group_id  NUMBER;
15:21:32 1470  -- EXCEPTIONS
15:21:32 1471  BAD_INVOICE_ID	    EXCEPTION;
15:21:32 1472  CAN_NOT_FIND_ACCOUNT EXCEPTION;
15:21:32 1473  BEGIN
15:21:32 1474  
15:21:32 1475  	 BEGIN
15:21:32 1476  	   SELECT
15:21:32 1477  	     INVOICE.ID into temp_invoice_id
15:21:32 1478  	   FROM
15:21:32 1479  	     INVOICE
15:21:32 1480  	   WHERE
15:21:32 1481  	     INVOICE.ID = in_invoice_id;
15:21:32 1482  	   EXCEPTION
15:21:32 1483  	     WHEN NO_DATA_FOUND THEN
15:21:32 1484  	       RAISE BAD_INVOICE_ID;
15:21:32 1485  	 END;
15:21:32 1486  
15:21:32 1487  	 BEGIN
15:21:32 1488  	   SELECT DISTINCT
15:21:32 1489  	     ACCOUNT.GROUP_ID into var_subscrib_group_id
15:21:32 1490  	   FROM
15:21:32 1491  	     ACCOUNT
15:21:32 1492  	     INNER JOIN SUBSCRIPTION ON SUBSCRIPTION.ACCOUNT_ID = ACCOUNT.ID
15:21:32 1493  	     INNER JOIN LICENSE ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
15:21:32 1494  	   WHERE
15:21:32 1495  	     LICENSE.INVOICE_ID = in_invoice_id;
15:21:32 1496  	   EXCEPTION
15:21:32 1497  	     WHEN NO_DATA_FOUND THEN
15:21:32 1498  	       var_subscrib_group_id := NULL;
15:21:32 1499  	 END;
15:21:32 1500  
15:21:32 1501  	 IF var_subscrib_group_id IS NULL THEN
15:21:32 1502  	   BEGIN
15:21:32 1503  	     SELECT
15:21:32 1504  	       GIFT_CERTIFICATE.PURCHASER_GROUP_ID,
15:21:32 1505  	       GIFT_CERTIFICATE.REDEEMER_GROUP_ID
15:21:32 1506  	       into
15:21:32 1507  	       var_gc_purchaser_group_id,
15:21:32 1508  	       var_gc_redeemer_group_id
15:21:32 1509  	     FROM
15:21:32 1510  	       GIFT_CERTIFICATE
15:21:32 1511  	     WHERE
15:21:32 1512  	       GIFT_CERTIFICATE.PURCHASE_INVOICE_ID = in_invoice_id
15:21:32 1513  	       OR GIFT_CERTIFICATE.FINALIZED_INVOICE_ID = in_invoice_id;
15:21:32 1514  	     EXCEPTION
15:21:32 1515  	       WHEN NO_DATA_FOUND THEN
15:21:32 1516  		 var_gc_purchaser_group_id := NULL;
15:21:32 1517  		 var_gc_redeemer_group_id  := NULL;
15:21:32 1518  	   END;
15:21:32 1519  	 END IF;
15:21:32 1520  
15:21:32 1521  	 IF var_subscrib_group_id IS NULL
15:21:32 1522  	   AND var_gc_purchaser_group_id IS NULL
15:21:32 1523  	   AND var_gc_redeemer_group_id IS NULL THEN
15:21:32 1524  	     RAISE CAN_NOT_FIND_ACCOUNT;
15:21:32 1525  	 END IF;
15:21:32 1526  
15:21:32 1527  	 OPEN out_group_ids FOR
15:21:32 1528  	 SELECT GROUP_ID FROM (
15:21:32 1529  	   SELECT
15:21:32 1530  	     var_subscrib_group_id as "GROUP_ID"
15:21:32 1531  	   FROM
15:21:32 1532  	     DUAL
15:21:32 1533  	   UNION
15:21:32 1534  	   SELECT
15:21:32 1535  	     var_gc_purchaser_group_id as "GROUP_ID"
15:21:32 1536  	   FROM
15:21:32 1537  	     DUAL
15:21:32 1538  	   UNION
15:21:32 1539  	   SELECT
15:21:32 1540  	     var_gc_redeemer_group_id as "GROUP_ID"
15:21:32 1541  	   FROM
15:21:32 1542  	     DUAL
15:21:32 1543  	 )
15:21:32 1544  	 WHERE
15:21:32 1545  	   GROUP_ID IS NOT NULL;
15:21:32 1546  
15:21:32 1547  EXCEPTION
15:21:32 1548  WHEN BAD_INVOICE_ID THEN
15:21:32 1549  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1550  	   SPROC_NAME, 'No such invoice');
15:21:32 1551  WHEN CAN_NOT_FIND_ACCOUNT THEN
15:21:32 1552  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1553  	   SPROC_NAME, 'Could not find account for given invoice');
15:21:32 1554  WHEN OTHERS THEN
15:21:32 1555  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1556  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1557  END GET_GROUPS_ID_BY_INVOICE_ID;
15:21:32 1558  
15:21:32 1559  PROCEDURE GET_ACCOUNT_TAX_EXEMPT_ID (
15:21:32 1560  /*
15:21:32 1561  Throws exceptions:
15:21:32 1562  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1563  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 1564  */
15:21:32 1565  	 in_group_id	   IN NUMBER,
15:21:32 1566  	 out_tax_exempt_id OUT VARCHAR2
15:21:32 1567  ) AS
15:21:32 1568  SPROC_NAME CONSTANT VARCHAR2(25) := 'GET_ACCOUNT_TAX_EXEMPT_ID';
15:21:32 1569  -- VARIABLES
15:21:32 1570  -- EXCEPTIONS
15:21:32 1571  BEGIN
15:21:32 1572  
15:21:32 1573  	 SELECT
15:21:32 1574  	   ACCOUNT.TAX_EXEMPT_ID into out_tax_exempt_id
15:21:32 1575  	 FROM
15:21:32 1576  	   ACCOUNT
15:21:32 1577  	 WHERE
15:21:32 1578  	   ACCOUNT.GROUP_ID = in_group_id;
15:21:32 1579  
15:21:32 1580  EXCEPTION
15:21:32 1581  WHEN NO_DATA_FOUND THEN
15:21:32 1582  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1583  	   SPROC_NAME, 'No such account');
15:21:32 1584  WHEN OTHERS THEN
15:21:32 1585  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1586  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1587  END GET_ACCOUNT_TAX_EXEMPT_ID;
15:21:32 1588  
15:21:32 1589  PROCEDURE GET_UPGRADABLE_SUBSCRIPTIONS (
15:21:32 1590  /*
15:21:32 1591  Throws exceptions:
15:21:32 1592  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1593  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 1594  
15:21:32 1595  Result has two columns:
15:21:32 1596  subscription_id and offer_chain_id
15:21:32 1597  */
15:21:32 1598  	 in_group_id	IN NUMBER,
15:21:32 1599  	 out_result_set OUT SYS_REFCURSOR
15:21:32 1600  ) AS
15:21:32 1601  SPROC_NAME CONSTANT VARCHAR2(28) := 'GET_UPGRADABLE_SUBSCRIPTIONS';
15:21:32 1602  -- Variables
15:21:32 1603  var_account_id NUMBER;
15:21:32 1604  -- Exceptions
15:21:32 1605  BAD_GROUP_ID   EXCEPTION;
15:21:32 1606  BEGIN
15:21:32 1607  
15:21:32 1608  	 BEGIN
15:21:32 1609  	   SELECT
15:21:32 1610  	     ID into var_account_id
15:21:32 1611  	   FROM
15:21:32 1612  	     ACCOUNT
15:21:32 1613  	   WHERE
15:21:32 1614  	     GROUP_ID = in_group_id;
15:21:32 1615  	   EXCEPTION
15:21:32 1616  	     WHEN NO_DATA_FOUND THEN
15:21:32 1617  	       RAISE BAD_GROUP_ID;
15:21:32 1618  	 END;
15:21:32 1619  
15:21:32 1620  	 OPEN out_result_set FOR
15:21:32 1621  	 SELECT
15:21:32 1622  	   S.ID as SUBSCRIPTION_ID,
15:21:32 1623  	   OCHMD.OFFER_CHAIN_ID
15:21:32 1624  	 FROM
15:21:32 1625  	   SUBSCRIPTION S
15:21:32 1626  	   INNER JOIN OFFER_CHAIN OCH ON OCH.ID = S.OFFER_CHAIN_ID
15:21:32 1627  	   INNER JOIN OFFER_CHAIN_META_DATA OCHMD ON (OCHMD.NAME = GLOBAL_CONSTANTS_V18.OCMD_UPGRADABLE_OFFER_CHAIN_ID AND TO_NUMBER(OCHMD.VALUE) = OCH.ID)
15:21:32 1628  	 WHERE
15:21:32 1629  	   S.ACCOUNT_ID = var_account_id;
15:21:32 1630  
15:21:32 1631  EXCEPTION
15:21:32 1632  WHEN BAD_GROUP_ID THEN
15:21:32 1633  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1634  	   SPROC_NAME, 'No such account');
15:21:32 1635  WHEN OTHERS THEN
15:21:32 1636  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1637  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1638  END GET_UPGRADABLE_SUBSCRIPTIONS;
15:21:32 1639  
15:21:32 1640  /******************************************************************************/
15:21:32 1641  
15:21:32 1642  PROCEDURE GET_USR_ALL_SBSCR_IDS (
15:21:32 1643  /*
15:21:32 1644  Throws exceptions:
15:21:32 1645  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1646  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:32 1647  
15:21:32 1648  Result has two columns:
15:21:32 1649  subscription_id and offer_chain_id
15:21:32 1650  */
15:21:32 1651  	 in_group_id	    IN NUMBER,
15:21:32 1652  	 out_result_set     OUT SYS_REFCURSOR
15:21:32 1653  ) AS
15:21:32 1654  SPROC_NAME CONSTANT VARCHAR2(21) := 'GET_USR_ALL_SBSCR_IDS';
15:21:32 1655  -- VARIABLES
15:21:32 1656  var_account_id NUMBER;
15:21:32 1657  -- EXCEPTIONS
15:21:32 1658  BAD_GROUP_ID EXCEPTION;
15:21:32 1659  BEGIN
15:21:32 1660  
15:21:32 1661  	 BEGIN
15:21:32 1662  	   SELECT
15:21:32 1663  	     A.ID INTO var_account_id
15:21:32 1664  	   FROM
15:21:32 1665  	     ACCOUNT A
15:21:32 1666  	   WHERE
15:21:32 1667  	     A.GROUP_ID = in_group_id;
15:21:32 1668  	   EXCEPTION
15:21:32 1669  	     WHEN NO_DATA_FOUND THEN
15:21:32 1670  	       RAISE BAD_GROUP_ID;
15:21:32 1671  	 END;
15:21:32 1672  
15:21:32 1673  	 OPEN out_result_set FOR
15:21:32 1674  	 SELECT
15:21:32 1675  	   S.ID
15:21:32 1676  	 FROM
15:21:32 1677  	   SUBSCRIPTION S
15:21:32 1678  	 WHERE
15:21:32 1679  	   S.ACCOUNT_ID = var_account_id
15:21:32 1680  	   AND S.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE;
15:21:32 1681  
15:21:32 1682  EXCEPTION
15:21:32 1683  WHEN BAD_GROUP_ID THEN
15:21:32 1684  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1685  	   SPROC_NAME, 'No such account');
15:21:32 1686  WHEN OTHERS THEN
15:21:32 1687  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1688  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1689  END GET_USR_ALL_SBSCR_IDS;
15:21:32 1690  
15:21:32 1691  /******************************************************************************/
15:21:32 1692  
15:21:32 1693  PROCEDURE GET_USR_SBSCR_IDS_BY_OFFCH_IDS (
15:21:32 1694  /*
15:21:32 1695  Throws exceptions:
15:21:32 1696  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1697  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1698  APP_EXCEPTION_CODES_V18.INVALID_PARAMETER
15:21:32 1699  
15:21:32 1700  Result has two columns:
15:21:32 1701  subscription_id and offer_chain_id
15:21:32 1702  */
15:21:32 1703  	 in_group_id	    IN NUMBER,
15:21:32 1704  	 in_offer_chain_ids IN core_owner.NUMBER_TABLE,
15:21:32 1705  	 out_result_set     OUT SYS_REFCURSOR
15:21:32 1706  ) AS
15:21:32 1707  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_USR_SBSCR_IDS_BY_OFFCH_IDS';
15:21:32 1708  -- VARIABLES
15:21:32 1709  var_account_id NUMBER;
15:21:32 1710  -- EXCEPTIONS
15:21:32 1711  BAD_GROUP_ID	   EXCEPTION;
15:21:32 1712  BAD_OFFER_CHAIN_IDS EXCEPTION;
15:21:32 1713  BEGIN
15:21:32 1714  
15:21:32 1715  	 IF in_offer_chain_ids IS NULL THEN
15:21:32 1716  	   RAISE BAD_OFFER_CHAIN_IDS;
15:21:32 1717  	 END IF;
15:21:32 1718  
15:21:32 1719  	 BEGIN
15:21:32 1720  	   SELECT
15:21:32 1721  	     A.ID INTO var_account_id
15:21:32 1722  	   FROM
15:21:32 1723  	     ACCOUNT A
15:21:32 1724  	   WHERE
15:21:32 1725  	     A.GROUP_ID = in_group_id;
15:21:32 1726  	   EXCEPTION
15:21:32 1727  	     WHEN NO_DATA_FOUND THEN
15:21:32 1728  	       RAISE BAD_GROUP_ID;
15:21:32 1729  	 END;
15:21:32 1730  
15:21:32 1731  	 OPEN out_result_set FOR
15:21:32 1732  	 SELECT
15:21:32 1733  	   S.ID
15:21:32 1734  	 FROM
15:21:32 1735  	   SUBSCRIPTION S
15:21:32 1736  	 WHERE
15:21:32 1737  	   S.ACCOUNT_ID = var_account_id
15:21:32 1738  	   AND S.OFFER_CHAIN_ID IN (SELECT * FROM TABLE(in_offer_chain_ids))
15:21:32 1739  	   AND S.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V18.SUBSCRIPTION_ACTIVE;
15:21:32 1740  
15:21:32 1741  EXCEPTION
15:21:32 1742  WHEN BAD_OFFER_CHAIN_IDS THEN
15:21:32 1743  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.INVALID_PARAMETER,
15:21:32 1744  	   SPROC_NAME, 'Offer chains ids parameter is null');
15:21:32 1745  WHEN BAD_GROUP_ID THEN
15:21:32 1746  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:32 1747  	   SPROC_NAME, 'No such account');
15:21:32 1748  WHEN OTHERS THEN
15:21:32 1749  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1750  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1751  END GET_USR_SBSCR_IDS_BY_OFFCH_IDS;
15:21:32 1752  
15:21:32 1753  PROCEDURE GET_GROUP_IDS_BY_CC_INFO (
15:21:32 1754  	 in_last_four_cc IN CREDIT_CARD.LAST_FOUR_CC%TYPE,
15:21:32 1755  	 in_expiration_date IN DATE,
15:21:32 1756  	 in_country IN CREDIT_CARD.COUNTRY%TYPE DEFAULT NULL,
15:21:32 1757  	 in_postal_code IN CREDIT_CARD.POSTAL_CODE%TYPE DEFAULT NULL,
15:21:32 1758  	 in_city IN CREDIT_CARD.CITY%TYPE DEFAULT NULL,
15:21:32 1759  	 in_state IN CREDIT_CARD.STATE%TYPE DEFAULT NULL,
15:21:32 1760  	 in_credit_card_type_id IN CREDIT_CARD.CREDIT_CARD_TYPE_ID%TYPE DEFAULT NULL,
15:21:32 1761  	 in_credit_card_status_id IN CREDIT_CARD.CREDIT_CARD_STATUS_ID%TYPE DEFAULT NULL,
15:21:32 1762  	 in_lower_bound IN NUMBER DEFAULT 1,
15:21:32 1763  	 in_upper_bound IN NUMBER DEFAULT 11,
15:21:32 1764  	 out_result_set OUT SYS_REFCURSOR
15:21:32 1765  ) AS
15:21:32 1766  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GROUP_IDS_BY_CC_INFO';
15:21:32 1767  BEGIN
15:21:32 1768  
15:21:32 1769  	 OPEN out_result_set FOR
15:21:32 1770  	     SELECT
15:21:32 1771  	       distinct /*+ first_rows(in_upper_bound-in_lower_bound) */ a.GROUP_ID GROUP_ID
15:21:32 1772  	     FROM
15:21:32 1773  	       account a,
15:21:32 1774  	       credit_card cc
15:21:32 1775  	     WHERE
15:21:32 1776  	       cc.expiration_date = in_expiration_date and
15:21:32 1777  	       cc.last_four_cc = in_last_four_cc and
15:21:32 1778  	       upper(cc.postal_code) = upper(nvl(in_postal_code, cc.postal_code)) and
15:21:32 1779  	       upper(cc.city) = upper(nvl(in_city, cc.city)) and
15:21:32 1780  	       upper(cc.state) = upper(nvl(in_state, cc.state)) and
15:21:32 1781  	       upper(cc.country) = upper(nvl(in_country, cc.country)) and
15:21:32 1782  	       cc.credit_card_status_id = nvl(in_credit_card_status_id, cc.credit_card_status_id) and
15:21:32 1783  	       cc.credit_card_type_id = nvl(in_credit_card_type_id, cc.credit_card_type_id) and
15:21:32 1784  	       a.id = cc.account_id and
15:21:32 1785  	       rownum >= in_lower_bound and
15:21:32 1786  	       rownum <= in_upper_bound
15:21:32 1787  	   ;
15:21:32 1788  
15:21:32 1789  EXCEPTION
15:21:32 1790  WHEN OTHERS THEN
15:21:32 1791  	 PROCS_COMMON_V18.THROW_EXCEPTION(APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:32 1792  	   SPROC_NAME, 'Unknown error', SQLERRM);
15:21:32 1793  END GET_GROUP_IDS_BY_CC_INFO;
15:21:32 1794  
15:21:32 1795  END PROCS_ACCOUNT_V18;
15:21:32 1796  .
15:21:32 SQL> /

Package body created.

Elapsed: 00:00:00.11
15:21:33 SQL> 
15:21:33 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_PROCESS_RETRY_V18" AS
15:21:33   2  
15:21:33   3  PROCEDURE LOG_RETRY(
15:21:33   4  	  in_process_name IN VARCHAR2,
15:21:33   5  	  in_generic_id   IN NUMBER,
15:21:33   6  	  in_date	  IN VARCHAR2,
15:21:33   7  	  out_success	   OUT NUMBER
15:21:33   8  ) AS
15:21:33   9  SPROC_NAME CONSTANT VARCHAR2(32) := 'PROCS_PROCESS_RETRY_V18';
15:21:33  10  BEGIN
15:21:33  11  
15:21:33  12  	out_success := 1;
15:21:33  13  	INSERT into PROCESS_RETRY_THROTTLE(process_name, generic_id, RETRY_count, create_date, update_date)
15:21:33  14  	VALUES (in_process_name, in_generic_id, 1, to_date(in_date, 'DD-Mon-YYYY HH24:MI:SS'), sysdate);
15:21:33  15  	commit;
15:21:33  16  EXCEPTION
15:21:33  17  WHEN DUP_VAL_ON_INDEX THEN
15:21:33  18  	rollback;
15:21:33  19  	out_success := 0;
15:21:33  20  WHEN OTHERS THEN
15:21:33  21  	rollback;
15:21:33  22  	PROCS_COMMON_V18.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:33  23  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:33  24  
15:21:33  25  END;
15:21:33  26  
15:21:33  27  PROCEDURE LOG_RETRY_DATE(
15:21:33  28  	  in_process_name IN VARCHAR2,
15:21:33  29  	  in_generic_id   IN NUMBER,
15:21:33  30  	  in_date	  IN DATE,
15:21:33  31  	  out_success	   OUT NUMBER
15:21:33  32  ) AS
15:21:33  33  SPROC_NAME CONSTANT VARCHAR2(32) := 'PROCS_PROCESS_RETRY_V18';
15:21:33  34  BEGIN
15:21:33  35  
15:21:33  36  	out_success := 1;
15:21:33  37  	INSERT into PROCESS_RETRY_THROTTLE(process_name, generic_id, RETRY_count, create_date, update_date)
15:21:33  38  	VALUES (in_process_name, in_generic_id, 1, in_date, sysdate);
15:21:33  39  	commit;
15:21:33  40  EXCEPTION
15:21:33  41  WHEN DUP_VAL_ON_INDEX THEN
15:21:33  42  	rollback;
15:21:33  43  	out_success := 0;
15:21:33  44  WHEN OTHERS THEN
15:21:33  45  	rollback;
15:21:33  46  	PROCS_COMMON_V18.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:33  47  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:33  48  
15:21:33  49  END;
15:21:33  50  
15:21:33  51  PROCEDURE DELETE_RETRY(
15:21:33  52  	  in_process_name IN VARCHAR2,
15:21:33  53  	  in_remove_minutes  IN NUMBER
15:21:33  54  ) AS
15:21:33  55  BEGIN
15:21:33  56  
15:21:33  57  delete from PROCESS_RETRY_THROTTLE
15:21:33  58  where
15:21:33  59  	process_name = in_process_name and
15:21:33  60  	create_date <= sysdate-in_remove_minutes/1440;
15:21:33  61  commit;
15:21:33  62  END;
15:21:33  63  
15:21:33  64  PROCEDURE GET_SYSDATE (
15:21:33  65  	out_date  OUT VARCHAR2
15:21:33  66  ) AS
15:21:33  67  BEGIN
15:21:33  68  	SELECT to_char(SYSDATE, 'DD-Mon-YYYY HH24:MI:SS') into out_date from dual;
15:21:33  69  END;
15:21:33  70  
15:21:33  71  END PROCS_PROCESS_RETRY_V18;
15:21:33  72  .
15:21:33 SQL> /

Package body created.

Elapsed: 00:00:00.03
15:21:33 SQL> 
15:21:33 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_NOTIFICATION_V18" AS
15:21:33   2  
15:21:33   3  PROCEDURE GET_NOTIFICATION_TYPE_BY_NAME (
15:21:33   4  /*
15:21:33   5  Throws exceptions:
15:21:33   6  CORE_OWNER.APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33   7  CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33   8  */
15:21:33   9  	in_notification_type_name IN VARCHAR2,
15:21:33  10  	out_notification_type_id  OUT NUMBER
15:21:33  11  ) AS
15:21:33  12  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_NOTIFICATION_TYPE_BY_NAME';
15:21:33  13  BEGIN
15:21:33  14  	SELECT
15:21:33  15  	  NOTIFICATION_TYPE.ID into out_notification_type_id
15:21:33  16  	FROM
15:21:33  17  	  NOTIFICATION_TYPE
15:21:33  18  	WHERE
15:21:33  19  	  NOTIFICATION_TYPE.VALUE = in_notification_type_name;
15:21:33  20  EXCEPTION
15:21:33  21  WHEN NO_DATA_FOUND THEN
15:21:33  22  	PROCS_COMMON_V18.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:33  23  	  SPROC_NAME, 'No such type');
15:21:33  24  WHEN OTHERS THEN
15:21:33  25  	PROCS_COMMON_V18.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:33  26  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:33  27  END GET_NOTIFICATION_TYPE_BY_NAME;
15:21:33  28  
15:21:33  29  /******************************************************************/
15:21:33  30  
15:21:33  31  PROCEDURE ADD_NOTIFICATION (
15:21:33  32  /*
15:21:33  33  Throws exceptions:
15:21:33  34  CORE_OWNER.APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33  35  CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33  36  */
15:21:33  37  	in_sender_account_id	 IN NUMBER DEFAULT 0,
15:21:33  38  	in_recipient_group_id	 IN NUMBER,
15:21:33  39  	in_notification_type_id  IN NUMBER,
15:21:33  40  	in_date_to_notify	 IN DATE,
15:21:33  41  	in_email_template_params IN CLOB
15:21:33  42  ) AS
15:21:33  43  SPROC_NAME CONSTANT VARCHAR2(32) := 'ADD_NOTIFICATION';
15:21:33  44  -- VARIABLES
15:21:33  45  temp_type_count NUMBER;
15:21:33  46  var_create_date DATE := SYSDATE;
15:21:33  47  -- EXCEPTIONS
15:21:33  48  BAD_NOTIFICATION_TYPE_ID EXCEPTION;
15:21:33  49  CAN_NOT_CREATE_HISTORY   EXCEPTION;
15:21:33  50  EXCEPTION_MESSAGE        VARCHAR2(1024);
15:21:33  51  BEGIN
15:21:33  52  
15:21:33  53  	SELECT
15:21:33  54  	  COUNT(*) into temp_type_count
15:21:33  55  	FROM
15:21:33  56  	  NOTIFICATION_TYPE
15:21:33  57  	WHERE
15:21:33  58  	  NOTIFICATION_TYPE.ID = in_notification_type_id;
15:21:33  59  
15:21:33  60  	IF temp_type_count = 0 THEN
15:21:33  61  	  RAISE BAD_NOTIFICATION_TYPE_ID;
15:21:33  62  	END IF;
15:21:33  63  
15:21:33  64  	INSERT INTO NOTIFICATION (
15:21:33  65  	  ID,
15:21:33  66  	  ACCOUNT_ID,
15:21:33  67  	  GROUP_ID,
15:21:33  68  	  NOTIFICATION_TYPE_ID,
15:21:33  69  	  NOTIFICATION_STATUS_ID,
15:21:33  70  	  EMAIL_TEMPLATE_PARAMS,
15:21:33  71  	  UPDATE_DATE,
15:21:33  72  	  CREATE_DATE,
15:21:33  73  	  DATE_TO_NOTIFY
15:21:33  74  	) VALUES (
15:21:33  75  	  NOT_ID_SEQ.nextVal,
15:21:33  76  	  in_sender_account_id,
15:21:33  77  	  in_recipient_group_id,
15:21:33  78  	  in_notification_type_id,
15:21:33  79  	  NOTIFICATION_STATUSES_V18.NOTIFICATION_PENDING,
15:21:33  80  	  in_email_template_params,
15:21:33  81  	  var_create_date,
15:21:33  82  	  var_create_date,
15:21:33  83  	  in_date_to_notify
15:21:33  84  	);
15:21:33  85  
15:21:33  86  	--BEGIN
15:21:33  87  	--  OPS_HIST_OWNER.PUBLIC_PROCS_OPS_V18.CREATE_NOTIFICATION_HISTORY (
15:21:33  88  	--    in_account_id		  => 0, -- ACCOUNT_ID. Can we delete it?
15:21:33  89  	--    in_group_id		  => in_recipient_group_id,
15:21:33  90  	--    notification_reason_type_id => in_notification_type_id,
15:21:33  91  	--    notification_status_id	  => NOTIFICATION_STATUSES_V18.NOTIFICATION_PENDING,
15:21:33  92  	--    email_template_params	  => in_email_template_params,
15:21:33  93  	--    in_create_date		  => var_create_date
15:21:33  94  	--  );
15:21:33  95  	--  EXCEPTION
15:21:33  96  	--    WHEN OTHERS THEN
15:21:33  97  	--	EXCEPTION_MESSAGE := SQLERRM;
15:21:33  98  	--	RAISE CAN_NOT_CREATE_HISTORY;
15:21:33  99  	--END;
15:21:33 100  
15:21:33 101  EXCEPTION
15:21:33 102  WHEN BAD_NOTIFICATION_TYPE_ID THEN
15:21:33 103  	PROCS_COMMON_V18.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:33 104  	  SPROC_NAME, 'No such notification status');
15:21:33 105  WHEN CAN_NOT_CREATE_HISTORY THEN
15:21:33 106  	PROCS_COMMON_V18.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:33 107  	  SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
15:21:33 108  WHEN OTHERS THEN
15:21:33 109  	PROCS_COMMON_V18.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:33 110  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:33 111  END ADD_NOTIFICATION;
15:21:33 112  
15:21:33 113  /******************************************************************************/
15:21:33 114  
15:21:33 115  PROCEDURE GET_PENDING_NOTIFICATIONS (
15:21:33 116  /*
15:21:33 117  Throws exceptions:
15:21:33 118  CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 119  */
15:21:33 120  	out_result_set OUT SYS_REFCURSOR
15:21:33 121  ) AS
15:21:33 122  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_PENDING_NOTIFICATIONS';
15:21:33 123  -- CONSTANTS
15:21:33 124  C_NOTIFICATION_COUNT_LIMIT CONSTANT NUMBER := 500;
15:21:33 125  BEGIN
15:21:33 126  	OPEN out_result_set FOR
15:21:33 127  SELECT * FROM
15:21:33 128  (
15:21:33 129  	SELECT
15:21:33 130  	  NOTIFICATION.ID
15:21:33 131  	FROM
15:21:33 132  	  NOTIFICATION
15:21:33 133  	  INNER JOIN NOTIFICATION_TYPE ON NOTIFICATION.NOTIFICATION_TYPE_ID = NOTIFICATION_TYPE.ID
15:21:33 134  	WHERE
15:21:33 135  	  ROWNUM <= C_NOTIFICATION_COUNT_LIMIT*10
15:21:33 136  	  AND NOT EXISTS (
15:21:33 137  	    SELECT NULL
15:21:33 138  	    FROM PROCESS_RETRY_THROTTLE
15:21:33 139  	    WHERE GENERIC_ID = NOTIFICATION.ID AND PROCESS_NAME = SPROC_NAME
15:21:33 140  	  )
15:21:33 141  	  AND (
15:21:33 142  	    NOTIFICATION.NOTIFICATION_STATUS_ID = NOTIFICATION_STATUSES_V18.NOTIFICATION_PENDING
15:21:33 143  	    OR NOTIFICATION.NOTIFICATION_STATUS_ID = NOTIFICATION_STATUSES_V18.NOTIFICATION_FAILED
15:21:33 144  	  )
15:21:33 145  	  AND (
15:21:33 146  	    NOTIFICATION.DATE_TO_NOTIFY IS NULL OR SYSDATE > NOTIFICATION.DATE_TO_NOTIFY
15:21:33 147  	  )ORDER BY dbms_random.value
15:21:33 148  ) WHERE
15:21:33 149  	ROWNUM <= C_NOTIFICATION_COUNT_LIMIT;
15:21:33 150  
15:21:33 151  EXCEPTION
15:21:33 152  WHEN OTHERS THEN
15:21:33 153  	PROCS_COMMON_V18.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:33 154  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:33 155  END GET_PENDING_NOTIFICATIONS;
15:21:33 156  
15:21:33 157  /******************************************************************************/
15:21:33 158  
15:21:33 159  PROCEDURE UPDATE_NOTIFICATION_TIMESTAMP (
15:21:33 160  /*
15:21:33 161  Throws exceptions:
15:21:33 162  CORE_OWNER.APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 163  CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 164  */
15:21:33 165  	in_notification_id IN NUMBER
15:21:33 166  ) AS
15:21:33 167  SPROC_NAME CONSTANT VARCHAR2(32) := 'UPDATE_NOTIFICATION_TIMESTAMP';
15:21:33 168  -- VARIABLES
15:21:33 169  temp_notification_id NUMBER;
15:21:33 170  -- EXCEPTIONS
15:21:33 171  BAD_NOTIFICATION_ID EXCEPTION;
15:21:33 172  BEGIN
15:21:33 173  
15:21:33 174  	BEGIN
15:21:33 175  	  SELECT
15:21:33 176  	    NOTIFICATION.ID into temp_notification_id
15:21:33 177  	  FROM
15:21:33 178  	    NOTIFICATION
15:21:33 179  	  WHERE
15:21:33 180  	    NOTIFICATION.ID = in_notification_id;
15:21:33 181  	  EXCEPTION
15:21:33 182  	    WHEN NO_DATA_FOUND THEN
15:21:33 183  	      RAISE BAD_NOTIFICATION_ID;
15:21:33 184  	END;
15:21:33 185  
15:21:33 186  	UPDATE
15:21:33 187  	  NOTIFICATION
15:21:33 188  	SET
15:21:33 189  	  NOTIFICATION.UPDATE_DATE = sysdate
15:21:33 190  	WHERE
15:21:33 191  	  NOTIFICATION.ID = in_notification_id;
15:21:33 192  
15:21:33 193  EXCEPTION
15:21:33 194  WHEN BAD_NOTIFICATION_ID THEN
15:21:33 195  	PROCS_COMMON_V18.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:33 196  	  SPROC_NAME, 'No such notification');
15:21:33 197  WHEN OTHERS THEN
15:21:33 198  	PROCS_COMMON_V18.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:33 199  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:33 200  END UPDATE_NOTIFICATION_TIMESTAMP;
15:21:33 201  
15:21:33 202  /******************************************************************************/
15:21:33 203  
15:21:33 204  PROCEDURE SET_NOTIFICATION_STATUS (
15:21:33 205  /*
15:21:33 206  Throws exceptions:
15:21:33 207  CORE_OWNER.APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 208  CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 209  */
15:21:33 210  	in_notification_id	  IN NUMBER,
15:21:33 211  	in_notification_status_id IN NUMBER,
15:21:33 212  	in_error_message	  IN VARCHAR2
15:21:33 213  ) AS
15:21:33 214  SPROC_NAME CONSTANT VARCHAR2(32) := 'SET_NOTIFICATION_STATUS';
15:21:33 215  -- VARIABLES
15:21:33 216  var_group_id		NUMBER;
15:21:33 217  var_account_id		NUMBER;
15:21:33 218  var_notification_type_id	NUMBER;
15:21:33 219  var_email_template_params CLOB;
15:21:33 220  var_create_history_date	DATE := SYSDATE;
15:21:33 221  var_notification_status_id   NUMBER;
15:21:33 222  var_date_to_notify	DATE;
15:21:33 223  max_fails   NUMBER := 5;
15:21:33 224  num_fails   NUMBER;
15:21:33 225  -- EXCEPTIONS
15:21:33 226  BAD_NOTIFICATION_ID	 EXCEPTION;
15:21:33 227  BAD_NOTIFICATION_STATUS_ID EXCEPTION;
15:21:33 228  CAN_NOT_CREATE_HISTORY	 EXCEPTION;
15:21:33 229  EXCEPTION_MESSAGE 	 VARCHAR2(1024);
15:21:33 230  BEGIN
15:21:33 231  
15:21:33 232  	IF in_notification_status_id != NOTIFICATION_STATUSES_V18.NOTIFICATION_SENT
15:21:33 233  	  AND in_notification_status_id != NOTIFICATION_STATUSES_V18.NOTIFICATION_PENDING
15:21:33 234  	  AND in_notification_status_id != NOTIFICATION_STATUSES_V18.NOTIFICATION_FAILED THEN
15:21:33 235  	  RAISE BAD_NOTIFICATION_STATUS_ID;
15:21:33 236  	END IF;
15:21:33 237  
15:21:33 238  	BEGIN
15:21:33 239  	  SELECT
15:21:33 240  	    NOTIFICATION.GROUP_ID,
15:21:33 241  	    NOTIFICATION.ACCOUNT_ID,
15:21:33 242  	    NOTIFICATION.NOTIFICATION_TYPE_ID,
15:21:33 243  	    NOTIFICATION.NOTIFICATION_STATUS_ID,
15:21:33 244  	    NOTIFICATION.EMAIL_TEMPLATE_PARAMS,
15:21:33 245  	    NOTIFICATION.DATE_TO_NOTIFY
15:21:33 246  	    into
15:21:33 247  	    var_group_id,
15:21:33 248  	    var_account_id,
15:21:33 249  	    var_notification_type_id,
15:21:33 250  	    var_notification_status_id,
15:21:33 251  	    var_email_template_params,
15:21:33 252  	    var_date_to_notify
15:21:33 253  	  FROM
15:21:33 254  	    NOTIFICATION
15:21:33 255  	  WHERE
15:21:33 256  	    NOTIFICATION.ID = in_notification_id;
15:21:33 257  	  EXCEPTION
15:21:33 258  	    WHEN NO_DATA_FOUND THEN
15:21:33 259  	      RAISE BAD_NOTIFICATION_ID;
15:21:33 260  	END;
15:21:33 261  
15:21:33 262  	BEGIN
15:21:33 263  	  CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V18.CREATE_NOTIFICATION_HISTORY (
15:21:33 264  	    in_notification_id		=> in_notification_id,
15:21:33 265  	    in_account_id		=> var_account_id,
15:21:33 266  	    in_group_id 		=> var_group_id,
15:21:33 267  	    notification_reason_type_id => var_notification_type_id,
15:21:33 268  	    notification_status_id	=> var_notification_status_id,
15:21:33 269  	    email_template_params	=> var_email_template_params,
15:21:33 270  	    in_create_date		=> var_create_history_date,
15:21:33 271  	    in_date_to_notify		=> var_date_to_notify
15:21:33 272  	  );
15:21:33 273  	  EXCEPTION
15:21:33 274  	    WHEN OTHERS THEN
15:21:33 275  	      EXCEPTION_MESSAGE := SQLERRM;
15:21:33 276  	      RAISE CAN_NOT_CREATE_HISTORY;
15:21:33 277  	END;
15:21:33 278  
15:21:33 279  	UPDATE
15:21:33 280  	  NOTIFICATION
15:21:33 281  	SET
15:21:33 282  	  NOTIFICATION.NOTIFICATION_STATUS_ID = in_notification_status_id,
15:21:33 283  	  NOTIFICATION.UPDATE_DATE = sysdate
15:21:33 284  	WHERE
15:21:33 285  	  NOTIFICATION.ID = in_notification_id;
15:21:33 286  
15:21:33 287  	IF ( in_error_message IS NOT NULL ) THEN
15:21:33 288  	  ADD_NOTIFICATION_FAILURE(
15:21:33 289  	    in_notification_id => in_notification_id,
15:21:33 290  	    in_error_message => in_error_message
15:21:33 291  	  );
15:21:33 292  	END IF;
15:21:33 293  
15:21:33 294  	SELECT COUNT(1) INTO num_fails
15:21:33 295  	FROM NOTIFICATION_FAILURE
15:21:33 296  	WHERE NOTIFICATION_ID = in_notification_id;
15:21:33 297  
15:21:33 298  	IF (in_notification_status_id = NOTIFICATION_STATUSES_V18.NOTIFICATION_SENT OR num_fails >= max_fails) then
15:21:33 299  	  FOR REC IN (
15:21:33 300  	      SELECT ID, NOTIFICATION_ID, ERROR_MESSAGE, CREATE_DATE
15:21:33 301  	      FROM NOTIFICATION_FAILURE
15:21:33 302  	      WHERE NOTIFICATION_ID = in_notification_id
15:21:33 303  	      ) LOOP
15:21:33 304  	      BEGIN
15:21:33 305  		CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V18.CREATE_NOTIF_FAILURE_HISTORY(
15:21:33 306  		  in_error_message	   => REC.ERROR_MESSAGE,
15:21:33 307  		  in_notification_id	   => REC.NOTIFICATION_ID,
15:21:33 308  		  in_create_date	   => REC.CREATE_DATE
15:21:33 309  		);
15:21:33 310  		EXCEPTION
15:21:33 311  		  WHEN OTHERS THEN
15:21:33 312  		    EXCEPTION_MESSAGE := SQLERRM;
15:21:33 313  		    RAISE CAN_NOT_CREATE_HISTORY;
15:21:33 314  	      END;
15:21:33 315  	  END LOOP;
15:21:33 316  	  DELETE FROM NOTIFICATION_FAILURE WHERE NOTIFICATION_ID = in_notification_id;
15:21:33 317  
15:21:33 318  	  BEGIN
15:21:33 319  	    SELECT
15:21:33 320  	      NOTIFICATION.GROUP_ID,
15:21:33 321  	      NOTIFICATION.ACCOUNT_ID,
15:21:33 322  	      NOTIFICATION.NOTIFICATION_TYPE_ID,
15:21:33 323  	      NOTIFICATION.NOTIFICATION_STATUS_ID,
15:21:33 324  	      NOTIFICATION.EMAIL_TEMPLATE_PARAMS,
15:21:33 325  	      NOTIFICATION.DATE_TO_NOTIFY
15:21:33 326  	      into
15:21:33 327  	      var_group_id,
15:21:33 328  	      var_account_id,
15:21:33 329  	      var_notification_type_id,
15:21:33 330  	      var_notification_status_id,
15:21:33 331  	      var_email_template_params,
15:21:33 332  	      var_date_to_notify
15:21:33 333  	    FROM
15:21:33 334  	      NOTIFICATION
15:21:33 335  	    WHERE
15:21:33 336  	      NOTIFICATION.ID = in_notification_id;
15:21:33 337  	    EXCEPTION
15:21:33 338  	      WHEN NO_DATA_FOUND THEN
15:21:33 339  		RAISE BAD_NOTIFICATION_ID;
15:21:33 340  	  END;
15:21:33 341  
15:21:33 342  	  BEGIN
15:21:33 343  	    CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V18.CREATE_NOTIFICATION_HISTORY (
15:21:33 344  	      in_notification_id	  => in_notification_id,
15:21:33 345  	      in_account_id		  => var_account_id,
15:21:33 346  	      in_group_id		  => var_group_id,
15:21:33 347  	      notification_reason_type_id => var_notification_type_id,
15:21:33 348  	      notification_status_id	  => var_notification_status_id,
15:21:33 349  	      email_template_params	  => var_email_template_params,
15:21:33 350  	      in_create_date		  => var_create_history_date,
15:21:33 351  	      in_date_to_notify 	  => var_date_to_notify
15:21:33 352  	    );
15:21:33 353  	    EXCEPTION
15:21:33 354  	      WHEN OTHERS THEN
15:21:33 355  		EXCEPTION_MESSAGE := SQLERRM;
15:21:33 356  		RAISE CAN_NOT_CREATE_HISTORY;
15:21:33 357  	  END;
15:21:33 358  
15:21:33 359  	  DELETE FROM NOTIFICATION WHERE ID = in_notification_id;
15:21:33 360  
15:21:33 361  	END IF;
15:21:33 362  	commit;
15:21:33 363  
15:21:33 364  EXCEPTION
15:21:33 365  WHEN BAD_NOTIFICATION_STATUS_ID THEN
15:21:33 366  	PROCS_COMMON_V18.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:33 367  	  SPROC_NAME, 'Bad notification status');
15:21:33 368  WHEN BAD_NOTIFICATION_ID THEN
15:21:33 369  	PROCS_COMMON_V18.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:33 370  	  SPROC_NAME, 'No such notification');
15:21:33 371  WHEN CAN_NOT_CREATE_HISTORY THEN
15:21:33 372  	PROCS_COMMON_V18.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:33 373  	  SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
15:21:33 374  WHEN OTHERS THEN
15:21:33 375  	PROCS_COMMON_V18.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:33 376  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:33 377  END SET_NOTIFICATION_STATUS;
15:21:33 378  
15:21:33 379  /******************************************************************************/
15:21:33 380  
15:21:33 381  PROCEDURE ADD_NOTIFICATION_FAILURE (
15:21:33 382  /*
15:21:33 383  Throws exceptions:
15:21:33 384  CORE_OWNER.APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 385  CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 386  */
15:21:33 387  	in_notification_id IN NUMBER,
15:21:33 388  	in_error_message   IN VARCHAR2
15:21:33 389  ) AS
15:21:33 390  SPROC_NAME CONSTANT VARCHAR2(32) := 'ADD_NOTIFICATION_FAILURE';
15:21:33 391  -- VARIABLES
15:21:33 392  temp_notification_id NUMBER;
15:21:33 393  var_create_date	   DATE := SYSDATE;
15:21:33 394  -- EXCEPTIONS
15:21:33 395  BAD_NOTIFICATION_ID	 EXCEPTION;
15:21:33 396  CAN_NOT_CREATE_HISTORY	 EXCEPTION;
15:21:33 397  EXCEPTION_MESSAGE 	 VARCHAR2(1024);
15:21:33 398  BEGIN
15:21:33 399  
15:21:33 400  	BEGIN
15:21:33 401  	  SELECT
15:21:33 402  	    NOTIFICATION.ID into temp_notification_id
15:21:33 403  	  FROM
15:21:33 404  	    NOTIFICATION
15:21:33 405  	  WHERE
15:21:33 406  	    NOTIFICATION.ID = in_notification_id;
15:21:33 407  	  EXCEPTION
15:21:33 408  	    WHEN NO_DATA_FOUND THEN
15:21:33 409  	      RAISE BAD_NOTIFICATION_ID;
15:21:33 410  	END;
15:21:33 411  
15:21:33 412  	INSERT INTO NOTIFICATION_FAILURE (
15:21:33 413  	  ID,
15:21:33 414  	  NOTIFICATION_ID,
15:21:33 415  	  ERROR_MESSAGE,
15:21:33 416  	  CREATE_DATE
15:21:33 417  	) VALUES (
15:21:33 418  	  NOTF_ID_SEQ.nextVal,
15:21:33 419  	  in_notification_id,
15:21:33 420  	  in_error_message,
15:21:33 421  	  sysdate
15:21:33 422  	);
15:21:33 423  
15:21:33 424  	--BEGIN
15:21:33 425  	--  OPS_HIST_OWNER.PUBLIC_PROCS_OPS_V18.CREATE_NOTIF_FAILURE_HISTORY(
15:21:33 426  	--    in_error_message	       => in_error_message,
15:21:33 427  	--    in_notification_queue_id => in_notification_id,
15:21:33 428  	--    in_create_date	       => var_create_date
15:21:33 429  	--  );
15:21:33 430  	--  EXCEPTION
15:21:33 431  	--    WHEN OTHERS THEN
15:21:33 432  	--	EXCEPTION_MESSAGE := SQLERRM;
15:21:33 433  	--	RAISE CAN_NOT_CREATE_HISTORY;
15:21:33 434  	--END;
15:21:33 435  
15:21:33 436  EXCEPTION
15:21:33 437  WHEN BAD_NOTIFICATION_ID THEN
15:21:33 438  	PROCS_COMMON_V18.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:33 439  	  SPROC_NAME, 'No such notification');
15:21:33 440  WHEN CAN_NOT_CREATE_HISTORY THEN
15:21:33 441  	PROCS_COMMON_V18.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V18.INTERNAL_ERROR,
15:21:33 442  	  SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
15:21:33 443  WHEN OTHERS THEN
15:21:33 444  	PROCS_COMMON_V18.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:33 445  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:33 446  END ADD_NOTIFICATION_FAILURE;
15:21:33 447  
15:21:33 448  /******************************************************************************/
15:21:33 449  
15:21:33 450  PROCEDURE LOCK_PENDING_NOTIFICATION (
15:21:33 451  /*
15:21:33 452  Result: GLOBAL_STATUSES.TRUE if notification locked
15:21:33 453  GLOBA_STATUSES.FALSE - else
15:21:33 454  */
15:21:33 455  	in_notification_id IN NUMBER,
15:21:33 456  	out_lock_status    OUT NUMBER
15:21:33 457  ) AS
15:21:33 458  SPROC_NAME CONSTANT VARCHAR2(25) := 'LOCK_PENDING_NOTIFICATION';
15:21:33 459  -- VARIABLE
15:21:33 460  temp_notification_id NUMBER;
15:21:33 461  BEGIN
15:21:33 462  	SELECT
15:21:33 463  	  NOTIFICATION.ID into temp_notification_id
15:21:33 464  	FROM
15:21:33 465  	  NOTIFICATION
15:21:33 466  	WHERE
15:21:33 467  	  NOTIFICATION.ID = in_notification_id
15:21:33 468  	  AND (
15:21:33 469  	    NOTIFICATION.NOTIFICATION_STATUS_ID = NOTIFICATION_STATUSES_V18.NOTIFICATION_PENDING
15:21:33 470  	    OR NOTIFICATION.NOTIFICATION_STATUS_ID = NOTIFICATION_STATUSES_V18.NOTIFICATION_FAILED
15:21:33 471  	  )
15:21:33 472  	FOR UPDATE;
15:21:33 473  
15:21:33 474  	out_lock_status := 1;
15:21:33 475  
15:21:33 476  EXCEPTION
15:21:33 477  WHEN NO_DATA_FOUND THEN
15:21:33 478  	out_lock_status := 0;
15:21:33 479  WHEN OTHERS THEN
15:21:33 480  	PROCS_COMMON_V18.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:33 481  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:33 482  END LOCK_PENDING_NOTIFICATION;
15:21:33 483  
15:21:33 484  /******************************************************************************/
15:21:33 485  
15:21:33 486  PROCEDURE GET_NOTIFICATION_DATA (
15:21:33 487  	in_notification_id IN NUMBER,
15:21:33 488  	out_result_set	   OUT SYS_REFCURSOR
15:21:33 489  ) AS
15:21:33 490  SPROC_NAME CONSTANT VARCHAR2(21) := 'GET_NOTIFICATION_DATA';
15:21:33 491  BEGIN
15:21:33 492  	OPEN out_result_set FOR
15:21:33 493  	SELECT
15:21:33 494  	  NOTIFICATION.ID,
15:21:33 495  	  NOTIFICATION.GROUP_ID,
15:21:33 496  	  NOTIFICATION.EMAIL_TEMPLATE_PARAMS,
15:21:33 497  	  NOTIFICATION.NOTIFICATION_STATUS_ID,
15:21:33 498  	  NOTIFICATION.CREATE_DATE,
15:21:33 499  	  NOTIFICATION.UPDATE_DATE,
15:21:33 500  	  NOTIFICATION.NOTIFICATION_TYPE_ID,
15:21:33 501  	  NOTIFICATION_TYPE.VALUE as "TYPE_VALUE",
15:21:33 502  	  NOTIFICATION_TYPE.TEMPLATE_URL
15:21:33 503  	FROM
15:21:33 504  	  NOTIFICATION
15:21:33 505  	  INNER JOIN NOTIFICATION_TYPE ON NOTIFICATION.NOTIFICATION_TYPE_ID = NOTIFICATION_TYPE.ID
15:21:33 506  	WHERE
15:21:33 507  	  NOTIFICATION.ID = in_notification_id;
15:21:33 508  
15:21:33 509  EXCEPTION
15:21:33 510  WHEN OTHERS THEN
15:21:33 511  	PROCS_COMMON_V18.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR,
15:21:33 512  	  SPROC_NAME, 'Unknown error', SQLERRM);
15:21:33 513  END GET_NOTIFICATION_DATA;
15:21:33 514  
15:21:33 515  END PROCS_NOTIFICATION_V18;
15:21:33 516  .
15:21:33 SQL> /

Package body created.

Elapsed: 00:00:00.04
15:21:33 SQL> 
15:21:33 SQL> CREATE OR REPLACE PACKAGE BODY "PUBLIC_PROCS_BILLING_V18" AS
15:21:33   2  
15:21:33   3  PROCEDURE GET_OFFER_CHAIN_BY_ID (
15:21:33   4  /*
15:21:33   5  Throws exceptions:
15:21:33   6  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33   7  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33   8  */
15:21:33   9  	  in_offer_chain_id IN	 NUMBER,
15:21:33  10  	  out_result_set    OUT  SYS_REFCURSOR
15:21:33  11  ) AS
15:21:33  12  BEGIN
15:21:33  13  	PROCS_OFFER_CHAIN_V18.GET_OFFER_CHAIN_BY_ID (
15:21:33  14  	  in_offer_chain_id => in_offer_chain_id,
15:21:33  15  	  out_result_set => out_result_set
15:21:33  16  	);
15:21:33  17  END GET_OFFER_CHAIN_BY_ID;
15:21:33  18  
15:21:33  19  PROCEDURE GET_PENDING_INVOICES (
15:21:33  20  /*
15:21:33  21  Throws exceptions:
15:21:33  22  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33  23  */
15:21:33  24  	out_result_set1      OUT SYS_REFCURSOR,
15:21:33  25  	out_result_set2      OUT SYS_REFCURSOR,
15:21:33  26  	out_result_set3      OUT SYS_REFCURSOR,
15:21:33  27  	in_row_number	     IN NUMBER DEFAULT NULL
15:21:33  28  ) AS
15:21:33  29  BEGIN
15:21:33  30  	PROCS_INVOICE_V18.GET_PENDING_INVOICES(
15:21:33  31  	  out_result_set1,
15:21:33  32  	  out_result_set2,
15:21:33  33  	  out_result_set3,
15:21:33  34  	  in_row_number
15:21:33  35  	);
15:21:33  36  END GET_PENDING_INVOICES;
15:21:33  37  
15:21:33  38  /********************************************************/
15:21:33  39  PROCEDURE GET_PENDING_REFUND_CHARGES (
15:21:33  40  /*
15:21:33  41  Throws exceptions:
15:21:33  42  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33  43  */
15:21:33  44  	out_result_set	    OUT SYS_REFCURSOR,
15:21:33  45  	in_row_number	    IN NUMBER DEFAULT NULL
15:21:33  46  ) AS
15:21:33  47  BEGIN
15:21:33  48  	PROCS_CHARGE_V18.GET_PENDING_REFUND_CHARGES(
15:21:33  49  	  out_result_set,
15:21:33  50  	  in_row_number
15:21:33  51  	);
15:21:33  52  END GET_PENDING_REFUND_CHARGES;
15:21:33  53  /********************************************************/
15:21:33  54  
15:21:33  55  PROCEDURE GET_UNPROCESSED_CHARGES (
15:21:33  56  /*
15:21:33  57  Throws exceptions:
15:21:33  58  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33  59  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33  60  */
15:21:33  61  	in_invoice_id  IN NUMBER,
15:21:33  62  	out_result_set OUT SYS_REFCURSOR
15:21:33  63  ) AS
15:21:33  64  BEGIN
15:21:33  65  	PROCS_CHARGE_V18.GET_UNPROCESSED_CHARGES(
15:21:33  66  	  in_invoice_id,
15:21:33  67  	  out_result_set
15:21:33  68  	);
15:21:33  69  END GET_UNPROCESSED_CHARGES;
15:21:33  70  
15:21:33  71  /********************************************************/
15:21:33  72  
15:21:33  73  PROCEDURE GET_PROCESSED_CHARGES (
15:21:33  74  /*
15:21:33  75  Throws exceptions:
15:21:33  76  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33  77  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33  78  */
15:21:33  79  	in_invoice_id  IN NUMBER,
15:21:33  80  	out_result_set OUT SYS_REFCURSOR
15:21:33  81  ) AS
15:21:33  82  BEGIN
15:21:33  83  	PROCS_CHARGE_V18.GET_PROCESSED_CHARGES(
15:21:33  84  	  in_invoice_id,
15:21:33  85  	  out_result_set
15:21:33  86  	);
15:21:33  87  END GET_PROCESSED_CHARGES;
15:21:33  88  
15:21:33  89  /********************************************************/
15:21:33  90  
15:21:33  91  PROCEDURE GET_TRNSCTN_ATTEMPTS_BY_STATUS (
15:21:33  92  /*
15:21:33  93  Throws exceptions:
15:21:33  94  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33  95  */
15:21:33  96  	in_transaction_id	      IN NUMBER,
15:21:33  97  	in_transaction_attempt_status IN NUMBER,
15:21:33  98  	out_result_set		      OUT SYS_REFCURSOR
15:21:33  99  ) AS
15:21:33 100  BEGIN
15:21:33 101  	PROCS_TRANSACTION_V18.GET_TRNSCTN_ATTEMPTS_BY_STATUS(
15:21:33 102  	  in_transaction_id,
15:21:33 103  	  in_transaction_attempt_status,
15:21:33 104  	  out_result_set
15:21:33 105  	);
15:21:33 106  END GET_TRNSCTN_ATTEMPTS_BY_STATUS;
15:21:33 107  
15:21:33 108  /********************************************************/
15:21:33 109  
15:21:33 110  PROCEDURE UPDATE_TRNSCTN_ATTEMPT_STATUS (
15:21:33 111  /*
15:21:33 112  Throws exceptions:
15:21:33 113  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 114  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 115  */
15:21:33 116  	in_transaction_attempt_id     IN NUMBER,
15:21:33 117  	in_transaction_attempt_status IN NUMBER
15:21:33 118  ) AS
15:21:33 119  BEGIN
15:21:33 120  	PROCS_TRANSACTION_V18.UPDATE_TRNSCTN_ATTEMPT_STATUS(
15:21:33 121  	   in_transaction_attempt_id,
15:21:33 122  	   in_transaction_attempt_status
15:21:33 123  	);
15:21:33 124  END UPDATE_TRNSCTN_ATTEMPT_STATUS;
15:21:33 125  
15:21:33 126  /********************************************************/
15:21:33 127  PROCEDURE GET_CLOSED_REFUNDS_BY_INVOICE (
15:21:33 128  /*
15:21:33 129  Throws exceptions:
15:21:33 130  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 131  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 132  */
15:21:33 133  	in_invoice_id	IN  NUMBER,
15:21:33 134  	out_result_set OUT SYS_REFCURSOR
15:21:33 135  ) AS
15:21:33 136  BEGIN
15:21:33 137  	PROCS_TRANSACTION_V18.GET_CLOSED_REFUNDS_BY_INVOICE(
15:21:33 138  	   in_invoice_id,
15:21:33 139  	   out_result_set
15:21:33 140  	);
15:21:33 141  END GET_CLOSED_REFUNDS_BY_INVOICE;
15:21:33 142  
15:21:33 143  /********************************************************/
15:21:33 144  
15:21:33 145  PROCEDURE UPDATE_TRNSCTN_ATTEMPT_TIME (
15:21:33 146  /*
15:21:33 147  Throws exceptions:
15:21:33 148  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 149  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 150  */
15:21:33 151  	in_transaction_attempt_id IN NUMBER,
15:21:33 152  	in_updated_by		  IN VARCHAR2
15:21:33 153  ) AS
15:21:33 154  BEGIN
15:21:33 155  	PROCS_TRANSACTION_V18.UPDATE_TRNSCTN_ATTEMPT_TIME(
15:21:33 156  	  in_transaction_attempt_id,
15:21:33 157  	  in_updated_by
15:21:33 158  	);
15:21:33 159  END UPDATE_TRNSCTN_ATTEMPT_TIME;
15:21:33 160  
15:21:33 161  /********************************************************/
15:21:33 162  
15:21:33 163  PROCEDURE CREATE_TRANSACTION_ATTEMPT (
15:21:33 164  /*
15:21:33 165  Throws exceptions:
15:21:33 166  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 167  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 168  */
15:21:33 169  	in_transaction_id	   IN NUMBER,
15:21:33 170  	in_trans_attempt_status    IN NUMBER,
15:21:33 171  	in_external_status_code    IN VARCHAR2,
15:21:33 172  	in_external_status_message IN VARCHAR2,
15:21:33 173  	in_created_by		   IN VARCHAR2,
15:21:33 174  	in_ext_transaction_id	   IN VARCHAR2,
15:21:33 175  	out_transaction_attempt_id OUT NUMBER
15:21:33 176  ) AS
15:21:33 177  BEGIN
15:21:33 178  	PROCS_TRANSACTION_V18.CREATE_TRANSACTION_ATTEMPT(
15:21:33 179  	  in_transaction_id,
15:21:33 180  	  in_trans_attempt_status,
15:21:33 181  	  in_external_status_code,
15:21:33 182  	  in_external_status_message,
15:21:33 183  	  in_created_by,
15:21:33 184  	  in_ext_transaction_id,
15:21:33 185  	  out_transaction_attempt_id
15:21:33 186  	);
15:21:33 187  END CREATE_TRANSACTION_ATTEMPT;
15:21:33 188  
15:21:33 189  /********************************************************/
15:21:33 190  
15:21:33 191  PROCEDURE UPDATE_TRANSACTION_ATTEMPT_INF (
15:21:33 192  /*
15:21:33 193  Throws exceptions:
15:21:33 194  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 195  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 196  */
15:21:33 197  	in_transaction_attempt_id IN NUMBER,
15:21:33 198  	in_ext_status_code	  IN VARCHAR2,
15:21:33 199  	in_ext_status_message	  IN VARCHAR2,
15:21:33 200  	in_ext_transaction_id	  IN VARCHAR2
15:21:33 201  ) AS
15:21:33 202  BEGIN
15:21:33 203  	PROCS_TRANSACTION_V18.UPDATE_TRANSACTION_ATTEMPT_INF(
15:21:33 204  	  in_transaction_attempt_id,
15:21:33 205  	  in_ext_status_code,
15:21:33 206  	  in_ext_status_message,
15:21:33 207  	  in_ext_transaction_id
15:21:33 208  	);
15:21:33 209  END UPDATE_TRANSACTION_ATTEMPT_INF;
15:21:33 210  
15:21:33 211  /********************************************************/
15:21:33 212  
15:21:33 213  PROCEDURE UPDATE_TRANSACTION_STATUS (
15:21:33 214  /*
15:21:33 215  Throws exceptions:
15:21:33 216  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 217  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 218  */
15:21:33 219  	in_transaction_id	 IN NUMBER,
15:21:33 220  	in_updated_by		 IN VARCHAR2,
15:21:33 221  	in_transaction_status_id IN NUMBER
15:21:33 222  ) AS
15:21:33 223  BEGIN
15:21:33 224  	PROCS_TRANSACTION_V18.UPDATE_TRANSACTION_STATUS(
15:21:33 225  	  in_transaction_id,
15:21:33 226  	  in_updated_by,
15:21:33 227  	  in_transaction_status_id
15:21:33 228  	);
15:21:33 229  END UPDATE_TRANSACTION_STATUS;
15:21:33 230  
15:21:33 231  /********************************************************/
15:21:33 232  
15:21:33 233  PROCEDURE GET_FAILED_ATTEMPTS_NUMBER (
15:21:33 234  /*
15:21:33 235  Throws exceptions:
15:21:33 236  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 237  */
15:21:33 238  	in_transaction_id IN  NUMBER,
15:21:33 239  	out_attempts_num  OUT NUMBER
15:21:33 240  ) AS
15:21:33 241  BEGIN
15:21:33 242  	PROCS_TRANSACTION_V18.GET_FAILED_ATTEMPTS_NUMBER(
15:21:33 243  	  in_transaction_id,
15:21:33 244  	  out_attempts_num
15:21:33 245  	);
15:21:33 246  END GET_FAILED_ATTEMPTS_NUMBER;
15:21:33 247  
15:21:33 248  /********************************************************/
15:21:33 249  
15:21:33 250  PROCEDURE IS_TRANSACTION_SUCCESSFULL (
15:21:33 251  /*
15:21:33 252  Throws exceptions:
15:21:33 253  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 254  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 255  */
15:21:33 256  	in_transaction_id IN  NUMBER,
15:21:33 257  	out_is_successfull  OUT NUMBER
15:21:33 258  ) AS
15:21:33 259  BEGIN
15:21:33 260  	PROCS_TRANSACTION_V18.IS_TRANSACTION_SUCCESSFULL(
15:21:33 261  	  in_transaction_id,
15:21:33 262  	  out_is_successfull
15:21:33 263  	);
15:21:33 264  END IS_TRANSACTION_SUCCESSFULL;
15:21:33 265  /********************************************************/
15:21:33 266  
15:21:33 267  PROCEDURE UPDATE_INVOICE_STATUS (
15:21:33 268  /*
15:21:33 269  Throws exceptions:
15:21:33 270  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 271  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 272  */
15:21:33 273  	in_invoice_id		       IN NUMBER,
15:21:33 274  	in_invoice_status_id	       IN NUMBER,
15:21:33 275  	in_updated_by		       IN VARCHAR2
15:21:33 276  ) AS
15:21:33 277  BEGIN
15:21:33 278  	PROCS_INVOICE_V18.UPDATE_INVOICE_STATUS(
15:21:33 279  	  in_invoice_id,
15:21:33 280  	  in_invoice_status_id,
15:21:33 281  	  in_updated_by
15:21:33 282  	);
15:21:33 283  END UPDATE_INVOICE_STATUS;
15:21:33 284  
15:21:33 285  /********************************************************/
15:21:33 286  
15:21:33 287  PROCEDURE SUSPEND_SUBSCRIPTION(
15:21:33 288  /*
15:21:33 289  Throws exceptions:
15:21:33 290  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 291  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:33 292  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 293  */
15:21:33 294  	  in_subs_id	IN NUMBER ,
15:21:33 295  	  in_updated_by IN VARCHAR2
15:21:33 296  ) AS
15:21:33 297  BEGIN
15:21:33 298  	PROCS_SUBSCRIPTION_V18.SUSPEND_SUBSCRIPTION(
15:21:33 299  	  in_subs_id,
15:21:33 300  	  in_updated_by
15:21:33 301  	);
15:21:33 302  END SUSPEND_SUBSCRIPTION;
15:21:33 303  
15:21:33 304  /********************************************************/
15:21:33 305  
15:21:33 306  PROCEDURE GET_CREDIT_CARD_BY_ID (
15:21:33 307  /*
15:21:33 308  Throws exceptions:
15:21:33 309  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 310  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 311  */
15:21:33 312  	in_credit_card_id IN  NUMBER,
15:21:33 313  	out_result_set	  OUT SYS_REFCURSOR
15:21:33 314  ) AS
15:21:33 315  BEGIN
15:21:33 316  	PROCS_FIN_INSTRUMENTS_V18.GET_CREDIT_CARD_BY_ID(
15:21:33 317  	  in_credit_card_id,
15:21:33 318  	  out_result_set
15:21:33 319  	);
15:21:33 320  END GET_CREDIT_CARD_BY_ID;
15:21:33 321  
15:21:33 322  /*********************************************************/
15:21:33 323  
15:21:33 324  PROCEDURE GET_TRANSACTION_AMOUNT (
15:21:33 325  /*
15:21:33 326  Throws exceptions:
15:21:33 327  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 328  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 329  */
15:21:33 330  	in_transaction_id      IN  NUMBER,
15:21:33 331  	out_transaction_amount OUT NUMBER
15:21:33 332  ) AS
15:21:33 333  BEGIN
15:21:33 334  	PROCS_TRANSACTION_V18.GET_TRANSACTION_AMOUNT(
15:21:33 335  	  in_transaction_id,
15:21:33 336  	  out_transaction_amount
15:21:33 337  	);
15:21:33 338  END GET_TRANSACTION_AMOUNT;
15:21:33 339  
15:21:33 340  /***********************************************************/
15:21:33 341  
15:21:33 342  PROCEDURE GET_ACCOUNT_BY_INVOICE_ID (
15:21:33 343  /*
15:21:33 344  Throws exceptions:
15:21:33 345  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 346  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 347  */
15:21:33 348  	in_invoice_id  IN  NUMBER,
15:21:33 349  	out_account_id OUT NUMBER
15:21:33 350  ) AS
15:21:33 351  BEGIN
15:21:33 352  	PROCS_INVOICE_V18.GET_ACCOUNT_BY_INVOICE_ID(
15:21:33 353  	  in_invoice_id,
15:21:33 354  	  out_account_id
15:21:33 355  	);
15:21:33 356  END GET_ACCOUNT_BY_INVOICE_ID;
15:21:33 357  
15:21:33 358  /************************************************************/
15:21:33 359  
15:21:33 360  PROCEDURE GET_GIFT_CERTIFICATE_BY_ID (
15:21:33 361  /*
15:21:33 362  Throws exceptions:
15:21:33 363  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:33 364  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 365  */
15:21:33 366  	in_gift_certificate_id IN NUMBER,
15:21:33 367  	out_result_set	       OUT SYS_REFCURSOR
15:21:33 368  ) AS
15:21:33 369  BEGIN
15:21:33 370  	PROCS_FIN_INSTRUMENTS_V18.GET_GIFT_CERTIFICATE_BY_ID (
15:21:33 371  	  in_gift_certificate_id,
15:21:33 372  	  out_result_set
15:21:33 373  	);
15:21:33 374  END GET_GIFT_CERTIFICATE_BY_ID;
15:21:33 375  
15:21:33 376  /**************************************************************/
15:21:33 377  
15:21:33 378  PROCEDURE GET_SUBSCR_ID_BY_CHARGE_ID (
15:21:33 379  /*
15:21:33 380  Throws exceptions:
15:21:33 381  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 382  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 383  */
15:21:33 384  	in_charge_id	    IN NUMBER,
15:21:33 385  	out_subscription_id OUT NUMBER
15:21:33 386  ) AS
15:21:33 387  BEGIN
15:21:33 388  	PROCS_CHARGE_V18.GET_SUBSCR_ID_BY_CHARGE_ID(
15:21:33 389  	  in_charge_id,
15:21:33 390  	  out_subscription_id
15:21:33 391  	);
15:21:33 392  END GET_SUBSCR_ID_BY_CHARGE_ID;
15:21:33 393  
15:21:33 394  /**************************************************************/
15:21:33 395  
15:21:33 396  PROCEDURE IS_GCERT_FOR_PROPER_OFFER (
15:21:33 397  /*
15:21:33 398  Throws exceptions:
15:21:33 399  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 400  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 401  */
15:21:33 402  	in_gift_certificate_id IN NUMBER,
15:21:33 403  	in_charge_id	       IN NUMBER,
15:21:33 404  	out_result	       OUT NUMBER
15:21:33 405  ) AS
15:21:33 406  BEGIN
15:21:33 407  	PROCS_FIN_INSTRUMENTS_V18.IS_GCERT_FOR_PROPER_OFFER (
15:21:33 408  	  in_gift_certificate_id,
15:21:33 409  	  in_charge_id,
15:21:33 410  	  out_result
15:21:33 411  	);
15:21:33 412  END IS_GCERT_FOR_PROPER_OFFER;
15:21:33 413  
15:21:33 414  /**************************************************************/
15:21:33 415  
15:21:33 416  PROCEDURE GET_SUBSCRIPTION_INFO (
15:21:33 417  /*
15:21:33 418  Throws exceptions:
15:21:33 419  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 420  */
15:21:33 421  	  in_subscription_id IN  NUMBER,
15:21:33 422  	  out_result_set      OUT SYS_REFCURSOR
15:21:33 423  ) AS
15:21:33 424  BEGIN
15:21:33 425  	PROCS_SUBSCRIPTION_V18.GET_SUBSCRIPTION_INFO (
15:21:33 426  	  in_subscription_id,
15:21:33 427  	  out_result_set
15:21:33 428  	);
15:21:33 429  END GET_SUBSCRIPTION_INFO;
15:21:33 430  
15:21:33 431  /****************************************************************/
15:21:33 432  
15:21:33 433  PROCEDURE CALCULATE_INVOICE_AMOUNT (
15:21:33 434  /*
15:21:33 435  Throws exceptions:
15:21:33 436  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 437  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 438  */
15:21:33 439  	in_invoice_id IN  NUMBER,
15:21:33 440  	out_amount    OUT NUMBER
15:21:33 441  ) AS
15:21:33 442  BEGIN
15:21:33 443  	PROCS_INVOICE_V18.CALCULATE_INVOICE_AMOUNT (
15:21:33 444  	  in_invoice_id,
15:21:33 445  	  out_amount
15:21:33 446  	);
15:21:33 447  END CALCULATE_INVOICE_AMOUNT;
15:21:33 448  
15:21:33 449  /****************************************************************/
15:21:33 450  
15:21:33 451  PROCEDURE GET_TRANSACTION_BY_ID (
15:21:33 452  /*
15:21:33 453  Throws exceptions:
15:21:33 454  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 455  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 456  */
15:21:33 457  	in_transaction_id IN NUMBER,
15:21:33 458  	out_result_set	  OUT SYS_REFCURSOR
15:21:33 459  ) AS
15:21:33 460  BEGIN
15:21:33 461  	PROCS_TRANSACTION_V18.GET_TRANSACTION_BY_ID(
15:21:33 462  	  in_transaction_id,
15:21:33 463  	  out_result_set
15:21:33 464  	);
15:21:33 465  END GET_TRANSACTION_BY_ID;
15:21:33 466  
15:21:33 467  /****************************************************************/
15:21:33 468  
15:21:33 469  PROCEDURE UPDATE_CHARGE_STATUS (
15:21:33 470  /*
15:21:33 471  Throws exceptions:
15:21:33 472  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 473  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 474  */
15:21:33 475  	in_charge_id	    IN CHARGE.ID%TYPE,
15:21:33 476  	in_charge_status_id IN CHARGE.CHARGE_STATUS_ID%TYPE,
15:21:33 477  	in_updated_by	    IN CHARGE.UPDATED_BY%TYPE
15:21:33 478  ) AS
15:21:33 479  BEGIN
15:21:33 480  	PROCS_CHARGE_V18.UPDATE_CHARGE_STATUS(
15:21:33 481  	  in_charge_id,
15:21:33 482  	  in_charge_status_id,
15:21:33 483  	  in_updated_by
15:21:33 484  	);
15:21:33 485  END UPDATE_CHARGE_STATUS;
15:21:33 486  
15:21:33 487  /****************************************************************/
15:21:33 488  
15:21:33 489  PROCEDURE GET_GC_BY_PURCH_INVOICE_ID (
15:21:33 490  	in_invoice_id		IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
15:21:33 491  	out_result_set OUT SYS_REFCURSOR
15:21:33 492  ) AS
15:21:33 493  BEGIN
15:21:33 494  	PROCS_FIN_INSTRUMENTS_V18.GET_GC_BY_PURCH_INVOICE_ID(
15:21:33 495  	  in_invoice_id,
15:21:33 496  	  out_result_set
15:21:33 497  	);
15:21:33 498  END GET_GC_BY_PURCH_INVOICE_ID;
15:21:33 499  
15:21:33 500  /****************************************************************/
15:21:33 501  
15:21:33 502  PROCEDURE UPDATE_TRANSACTION_ORDER_ID (
15:21:33 503  /*
15:21:33 504  Throws exceptions:
15:21:33 505  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 506  APP_EXCEPTION_CODES_V18.INTRNAL_ERROR
15:21:33 507  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 508  */
15:21:33 509  	in_transaction_id IN TRANSACTION.ID%TYPE,
15:21:33 510  	in_order_id	  IN TRANSACTION.ORDER_ID%TYPE,
15:21:33 511  	in_updated_by	  IN TRANSACTION.UPDATED_BY%TYPE
15:21:33 512  ) AS
15:21:33 513  BEGIN
15:21:33 514  	PROCS_TRANSACTION_V18.UPDATE_TRANSACTION_ORDER_ID(
15:21:33 515  	  in_transaction_id,
15:21:33 516  	  in_order_id,
15:21:33 517  	  in_updated_by
15:21:33 518  	);
15:21:33 519  END UPDATE_TRANSACTION_ORDER_ID;
15:21:33 520  
15:21:33 521  /****************************************************************/
15:21:33 522  
15:21:33 523  PROCEDURE GET_ACTIVE_INVOICES_IDS (
15:21:33 524  /*
15:21:33 525  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 526  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 527  */
15:21:33 528  --  in_subscription_id IN SUBSCRIPTION.ID%TYPE,
15:21:33 529  	in_subscription_id IN NUMBER,
15:21:33 530  	out_result_set	   OUT SYS_REFCURSOR
15:21:33 531  ) AS
15:21:33 532  BEGIN
15:21:33 533  	PROCS_SUBSCRIPTION_V18.GET_ACTIVE_INVOICES_IDS(
15:21:33 534  	  in_subscription_id,
15:21:33 535  	  out_result_set
15:21:33 536  	);
15:21:33 537  END GET_ACTIVE_INVOICES_IDS;
15:21:33 538  
15:21:33 539  /****************************************************************/
15:21:33 540  
15:21:33 541  PROCEDURE CANCEL_SUBSCRIPTION_INVOICE (
15:21:33 542  /*
15:21:33 543  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 544  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 545  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:33 546  */
15:21:33 547  --  in_invoice_id        IN INVOICE.ID%TYPE,
15:21:33 548  --  in_updated_by        IN INVOICE.UPDATED_BY%TYPE,
15:21:33 549  -- norlov: in_refundable	      IN refund enabled
15:21:33 550  	in_invoice_id	     IN NUMBER,
15:21:33 551  	in_updated_by	     IN VARCHAR2,
15:21:33 552  	in_refundable	     IN NUMBER DEFAULT GLOBAL_CONSTANTS_V18.FALSE
15:21:33 553  --  in_cancellation_date IN DATE DEFAULT current_timestamp
15:21:33 554  ) AS
15:21:33 555  BEGIN
15:21:33 556  	PROCS_SUBSCRIPTION_V18.CANCEL_SUBSCRIPTION_INVOICE(
15:21:33 557  	  in_invoice_id,
15:21:33 558  	  in_updated_by,
15:21:33 559  	  in_refundable
15:21:33 560  	);
15:21:33 561  END CANCEL_SUBSCRIPTION_INVOICE;
15:21:33 562  
15:21:33 563  /****************************************************************/
15:21:33 564  
15:21:33 565  PROCEDURE FINALIZE_CANCELATION (
15:21:33 566  /*
15:21:33 567  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 568  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 569  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:33 570  */
15:21:33 571  --  in_subscription_id	IN SUBSCRIPTION.ID%TYPE,
15:21:33 572  --  in_cancelation_reason IN SUBSCRIPTION_CANCEL_REASON.VALUE%TYPE,
15:21:33 573  --  in_cancelation_date	IN SUBSCRIPTION.CANCELLATION_DATE%TYPE,
15:21:33 574  --  in_note		IN SUBSCRIPTION_NOTE.NOTE%TYPE,
15:21:33 575  --  in_agent_id		IN SUBSCRIPTION_NOTE.AGENT_ID%TYPE,
15:21:33 576  --  in_updated_by 	IN SUBSCRIPTION.UPDATED_BY%TYPE
15:21:33 577  	in_subscription_id    IN NUMBER,
15:21:33 578  	in_cancelation_reason IN VARCHAR2,
15:21:33 579  	in_cancelation_date   IN DATE,
15:21:33 580  	in_note 	      IN VARCHAR2,
15:21:33 581  	in_agent_id	      IN NUMBER,
15:21:33 582  	in_updated_by	      IN VARCHAR2
15:21:33 583  ) AS
15:21:33 584  BEGIN
15:21:33 585  	PROCS_SUBSCRIPTION_V18.FINALIZE_CANCELATION(
15:21:33 586  	  in_subscription_id,
15:21:33 587  	  in_cancelation_reason,
15:21:33 588  	  in_cancelation_date,
15:21:33 589  	  in_note,
15:21:33 590  	  in_agent_id,
15:21:33 591  	  in_updated_by
15:21:33 592  	);
15:21:33 593  END FINALIZE_CANCELATION;
15:21:33 594  
15:21:33 595  /****************************************************************/
15:21:33 596  
15:21:33 597  PROCEDURE GET_SUBSCR_PROD_OFFERRINGS (
15:21:33 598  /*
15:21:33 599  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 600  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 601  */
15:21:33 602  	in_subscription_id IN NUMBER,
15:21:33 603  	out_result_set	   OUT SYS_REFCURSOR
15:21:33 604  ) AS
15:21:33 605  BEGIN
15:21:33 606  	PROCS_SUBSCRIPTION_V18.GET_SUBSCR_PROD_OFFERRINGS(
15:21:33 607  	  in_subscription_id,
15:21:33 608  	  out_result_set
15:21:33 609  	);
15:21:33 610  END GET_SUBSCR_PROD_OFFERRINGS;
15:21:33 611  
15:21:33 612  /****************************************************************/
15:21:33 613  
15:21:33 614  PROCEDURE GET_OFFER_CHAIN_META_DATA (
15:21:33 615  /*
15:21:33 616  Throws exceptions (codes):
15:21:33 617  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 618  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 619  */
15:21:33 620  	in_offer_chain_id IN NUMBER,
15:21:33 621  	in_meta_data_name IN VARCHAR2,
15:21:33 622  	out_result_set	  OUT SYS_REFCURSOR
15:21:33 623  )AS
15:21:33 624  BEGIN
15:21:33 625  	PROCS_OFFER_CHAIN_V18.GET_OFFER_CHAIN_META_DATA(
15:21:33 626  	  in_offer_chain_id,
15:21:33 627  	  in_meta_data_name,
15:21:33 628  	  out_result_set
15:21:33 629  	);
15:21:33 630  END GET_OFFER_CHAIN_META_DATA;
15:21:33 631  
15:21:33 632  /****************************************************************/
15:21:33 633  
15:21:33 634  PROCEDURE GET_PRODUCT_OFFERING_META_DATA (
15:21:33 635  /*
15:21:33 636  Throws exceptions (codes):
15:21:33 637  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 638  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 639  */
15:21:33 640  	in_product_offering_id IN NUMBER,
15:21:33 641  	in_meta_data_name      IN VARCHAR2 DEFAULT NULL,
15:21:33 642  	out_result_set	       OUT SYS_REFCURSOR
15:21:33 643  )AS
15:21:33 644  BEGIN
15:21:33 645  	PROCS_OFFER_CHAIN_V18.GET_PRODUCT_OFFERING_META_DATA(
15:21:33 646  	  in_product_offering_id,
15:21:33 647  	  in_meta_data_name,
15:21:33 648  	  out_result_set
15:21:33 649  	);
15:21:33 650  END GET_PRODUCT_OFFERING_META_DATA;
15:21:33 651  
15:21:33 652  /****************************************************************/
15:21:33 653  
15:21:33 654  PROCEDURE READ_ACCOUNT (
15:21:33 655  	in_account_id  IN ACCOUNT.ID%TYPE,
15:21:33 656  	out_result_set OUT SYS_REFCURSOR
15:21:33 657  )AS
15:21:33 658  BEGIN
15:21:33 659  	PROCS_ACCOUNT_CRU_V18.READ_ACCOUNT(
15:21:33 660  	  in_account_id,
15:21:33 661  	  out_result_set
15:21:33 662  	);
15:21:33 663  END READ_ACCOUNT;
15:21:33 664  
15:21:33 665  /****************************************************************/
15:21:33 666  
15:21:33 667  PROCEDURE GET_COLLECTED_CHARGES (
15:21:33 668  /*
15:21:33 669  Throws exceptions:
15:21:33 670  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 671  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 672  */
15:21:33 673  	in_invoice_id  IN NUMBER,
15:21:33 674  	out_result_set OUT SYS_REFCURSOR
15:21:33 675  ) AS
15:21:33 676  BEGIN
15:21:33 677  	PROCS_CHARGE_V18.GET_COLLECTED_CHARGES(
15:21:33 678  	  in_invoice_id,
15:21:33 679  	  out_result_set
15:21:33 680  	);
15:21:33 681  END GET_COLLECTED_CHARGES;
15:21:33 682  
15:21:33 683  /****************************************************************/
15:21:33 684  
15:21:33 685  PROCEDURE GET_GROUPS_ID_BY_INVOICE_ID (
15:21:33 686  /*
15:21:33 687  Throws exceptions:
15:21:33 688  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:33 689  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 690  */
15:21:33 691  	in_invoice_id IN NUMBER,
15:21:33 692  	out_group_ids OUT SYS_REFCURSOR
15:21:33 693  ) AS
15:21:33 694  BEGIN
15:21:33 695  
15:21:33 696  	PROCS_ACCOUNT_V18.GET_GROUPS_ID_BY_INVOICE_ID(
15:21:33 697  	  in_invoice_id,
15:21:33 698  	  out_group_ids
15:21:33 699  	);
15:21:33 700  
15:21:33 701  END GET_GROUPS_ID_BY_INVOICE_ID;
15:21:33 702  
15:21:33 703  /****************************************************************/
15:21:33 704  
15:21:33 705  PROCEDURE GET_ACCOUNT_ID_BY_GROUP_ID (
15:21:33 706  /*
15:21:33 707  Throws exceptions:
15:21:33 708  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:33 709  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 710  */
15:21:33 711  	in_group_id IN NUMBER,
15:21:33 712  	out_account_id	OUT NUMBER
15:21:33 713  ) AS
15:21:33 714  BEGIN
15:21:33 715  
15:21:33 716  	PROCS_ACCOUNT_V18.GET_ACCOUNT_ID_BY_GROUP_ID(
15:21:33 717  	  in_group_id,
15:21:33 718  	  out_account_id
15:21:33 719  	);
15:21:33 720  
15:21:33 721  END GET_ACCOUNT_ID_BY_GROUP_ID;
15:21:33 722  
15:21:33 723  /****************************************************************/
15:21:33 724  
15:21:33 725  PROCEDURE LOCK_ACCOUNT (
15:21:33 726  	in_group_id    IN NUMBER,
15:21:33 727  	in_lock_key    IN VARCHAR2,
15:21:33 728  	in_seconds_num IN NUMBER,
15:21:33 729  	in_created_by  IN VARCHAR2,
15:21:33 730  	in_reason      IN VARCHAR2
15:21:33 731  ) AS
15:21:33 732  BEGIN
15:21:33 733  	PROCS_LOCKING_V18.LOCK_ACCOUNT(
15:21:33 734  	  in_group_id,
15:21:33 735  	  in_lock_key,
15:21:33 736  	  in_seconds_num,
15:21:33 737  	  in_created_by,
15:21:33 738  	  in_reason
15:21:33 739  	);
15:21:33 740  END LOCK_ACCOUNT;
15:21:33 741  
15:21:33 742  /****************************************************************/
15:21:33 743  
15:21:33 744  PROCEDURE RELEASE_LOCK (
15:21:33 745  	in_group_id IN NUMBER,
15:21:33 746  	in_lock_key IN VARCHAR2
15:21:33 747  ) AS
15:21:33 748  BEGIN
15:21:33 749  	PROCS_LOCKING_V18.RELEASE_LOCK(
15:21:33 750  	  in_group_id,
15:21:33 751  	  in_lock_key
15:21:33 752  	);
15:21:33 753  END RELEASE_LOCK;
15:21:33 754  
15:21:33 755  PROCEDURE GET_PAYMENT_INFO_BY_INVOICE_ID (
15:21:33 756  	in_invoice_id		    IN NUMBER,
15:21:33 757  	out_order_id		    OUT VARCHAR2,
15:21:33 758  	out_external_transaction_id OUT VARCHAR2
15:21:33 759  ) AS
15:21:33 760  BEGIN
15:21:33 761  	PROCS_INVOICE_V18.GET_PAYMENT_INFO_BY_INVOICE_ID(
15:21:33 762  	  in_invoice_id,
15:21:33 763  	  out_order_id,
15:21:33 764  	  out_external_transaction_id
15:21:33 765  	);
15:21:33 766  END GET_PAYMENT_INFO_BY_INVOICE_ID;
15:21:33 767  
15:21:33 768  /******************************************************************************/
15:21:33 769  
15:21:33 770  PROCEDURE GET_PAYPAL_BY_ID (
15:21:33 771  	in_paypal_id   IN  NUMBER,
15:21:33 772  	out_result_set OUT SYS_REFCURSOR
15:21:33 773  ) AS
15:21:33 774  BEGIN
15:21:33 775  	PROCS_FIN_INSTRUMENTS_V18.GET_PAYPAL_BY_ID(
15:21:33 776  	  in_paypal_id,
15:21:33 777  	  out_result_set
15:21:33 778  	);
15:21:33 779  END GET_PAYPAL_BY_ID;
15:21:33 780  
15:21:33 781  PROCEDURE GET_NEXT_ATTEMPT_NUMBER (
15:21:33 782  /*
15:21:33 783  Throws exceptions:
15:21:33 784  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 785  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 786  */
15:21:33 787  	in_charge_id   in  number,
15:21:33 788  	out_attempt_count out number
15:21:33 789  ) as
15:21:33 790  begin
15:21:33 791  	PROCS_TRANSACTION_V18.GET_NEXT_ATTEMPT_NUMBER(
15:21:33 792  	  in_charge_id,
15:21:33 793  	  out_attempt_count
15:21:33 794  	);
15:21:33 795  end GET_NEXT_ATTEMPT_NUMBER;
15:21:33 796  
15:21:33 797  PROCEDURE GET_NOTIFICATION_TYPE_ID (
15:21:33 798  	in_offer_chain_id	 IN NUMBER,
15:21:33 799  	in_action_name		 IN VARCHAR2,
15:21:33 800  	out_notification_type_id out number
15:21:33 801  ) as
15:21:33 802  begin
15:21:33 803  	PROCS_OFFER_CHAIN_V18.GET_NOTIFICATION_TYPE_ID(
15:21:33 804  	  in_offer_chain_id,
15:21:33 805  	  in_action_name,
15:21:33 806  	  out_notification_type_id
15:21:33 807  	);
15:21:33 808  end GET_NOTIFICATION_TYPE_ID;
15:21:33 809  
15:21:33 810  PROCEDURE GET_GC_ID_BY_PURCH_INVOICE_ID (
15:21:33 811  /*
15:21:33 812  Throws exceptions:
15:21:33 813  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 814  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 815  */
15:21:33 816  in_invoice_id IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
15:21:33 817  out_gift_certificate_id OUT GIFT_CERTIFICATE.ID%TYPE
15:21:33 818  ) AS
15:21:33 819  BEGIN
15:21:33 820  PROCS_FIN_INSTRUMENTS_V18.GET_GC_ID_BY_PURCH_INVOICE_ID(
15:21:33 821  in_invoice_id,
15:21:33 822  out_gift_certificate_id
15:21:33 823  );
15:21:33 824  END GET_GC_ID_BY_PURCH_INVOICE_ID;
15:21:33 825  
15:21:33 826  /****************************************************************************/
15:21:33 827  
15:21:33 828  PROCEDURE SHOULD_MOVE_TO_GRACE(
15:21:33 829  	in_invoice_id  IN INVOICE.ID%TYPE,
15:21:33 830  	out_result     OUT NUMBER
15:21:33 831  ) AS
15:21:33 832  BEGIN
15:21:33 833  	-- if the invoice preceding the given invoice has no transaction attempts, then
15:21:33 834  	-- it is not billed out of Sartre. if so, then the associated subscription
15:21:33 835  	-- should be canceled after a final failed billing attempt--not moved to grace.
15:21:33 836  	SELECT DECODE(COUNT(1), 0, 0, 1) INTO out_result
15:21:33 837  	FROM CHARGE c
15:21:33 838  	INNER JOIN TRANSACTION t ON c.TRANSACTION_ID = t.ID
15:21:33 839  	INNER JOIN TRANSACTION_ATTEMPT ta ON ta.TRANSACTION_ID = t.ID
15:21:33 840  	WHERE c.INVOICE_ID = (
15:21:33 841  	  -- select previous invoice_id, or -1 if there is none
15:21:33 842  	  SELECT PREV_INVOICE_ID FROM (
15:21:33 843  	    SELECT i.ID, LAG(i.ID, 1, -1) OVER (ORDER BY i.CREATE_DATE) AS PREV_INVOICE_ID
15:21:33 844  	    FROM INVOICE i
15:21:33 845  	    INNER JOIN LICENSE l ON i.ID = l.INVOICE_ID
15:21:33 846  	    WHERE l.SUBSCRIPTION_ID = (
15:21:33 847  	      SELECT SUBSCRIPTION_ID FROM LICENSE WHERE INVOICE_ID = in_invoice_id
15:21:33 848  	    )
15:21:33 849  	  ) WHERE ID = in_invoice_id
15:21:33 850  	);
15:21:33 851  END SHOULD_MOVE_TO_GRACE;
15:21:33 852  
15:21:33 853  /****************************************************************************/
15:21:33 854  
15:21:33 855  PROCEDURE MOVE_TO_GRACE(
15:21:33 856  	in_invoice_id		      IN INVOICE.ID%TYPE,
15:21:33 857  	in_updated_by		      IN LICENSE.UPDATED_BY%TYPE,
15:21:33 858  	in_grace_period_length_hours  IN NUMBER
15:21:33 859  ) AS
15:21:33 860  BEGIN
15:21:33 861  	PROCS_SUBSCRIPTION_V18.START_GRACE_BY_INVOICE_ID(
15:21:33 862  	  in_invoice_id        => in_invoice_id,
15:21:33 863  	  in_updater	       => in_updated_by,
15:21:33 864  	  in_duration_in_hours => in_grace_period_length_hours
15:21:33 865  	);
15:21:33 866  END MOVE_TO_GRACE;
15:21:33 867  
15:21:33 868  /****************************************************************************/
15:21:33 869  
15:21:33 870  PROCEDURE MOVE_OUT_OF_GRACE(
15:21:33 871  	in_invoice_id	IN INVOICE.ID%TYPE,
15:21:33 872  	in_updated_by	IN LICENSE.UPDATED_BY%TYPE
15:21:33 873  ) AS
15:21:33 874  BEGIN
15:21:33 875  	PROCS_SUBSCRIPTION_V18.STOP_GRACE_BY_INVOICE_ID(
15:21:33 876  	  in_invoice_id => in_invoice_id,
15:21:33 877  	  in_updater	=> in_updated_by
15:21:33 878  	);
15:21:33 879  END MOVE_OUT_OF_GRACE;
15:21:33 880  
15:21:33 881  END PUBLIC_PROCS_BILLING_V18;
15:21:33 882  .
15:21:33 SQL> /

Package body created.

Elapsed: 00:00:00.05
15:21:33 SQL> 
15:21:33 SQL> CREATE OR REPLACE PACKAGE BODY "PUBLIC_PROCS_NOTIFICATION_V18" AS
15:21:33   2  
15:21:33   3  PROCEDURE LOCK_ACCOUNT (
15:21:33   4  	in_group_id    IN NUMBER,
15:21:33   5  	in_lock_key    IN VARCHAR2,
15:21:33   6  	in_seconds_num IN NUMBER,
15:21:33   7  	in_created_by  IN VARCHAR2,
15:21:33   8  	in_reason      IN VARCHAR2
15:21:33   9  ) AS
15:21:33  10  BEGIN
15:21:33  11  	PROCS_LOCKING_V18.LOCK_ACCOUNT(
15:21:33  12  	  in_group_id,
15:21:33  13  	  in_lock_key,
15:21:33  14  	  in_seconds_num,
15:21:33  15  	  in_created_by,
15:21:33  16  	  in_reason
15:21:33  17  	);
15:21:33  18  END LOCK_ACCOUNT;
15:21:33  19  
15:21:33  20  /******************************************************************************/
15:21:33  21  
15:21:33  22  PROCEDURE RELEASE_LOCK (
15:21:33  23  	in_group_id IN NUMBER,
15:21:33  24  	in_lock_key IN VARCHAR2
15:21:33  25  ) AS
15:21:33  26  BEGIN
15:21:33  27  	PROCS_LOCKING_V18.RELEASE_LOCK(
15:21:33  28  	  in_group_id,
15:21:33  29  	  in_lock_key
15:21:33  30  	);
15:21:33  31  END RELEASE_LOCK;
15:21:33  32  
15:21:33  33  END PUBLIC_PROCS_NOTIFICATION_V18;
15:21:33  34  .
15:21:33 SQL> /

Package body created.

Elapsed: 00:00:00.01
15:21:33 SQL> 
15:21:33 SQL> CREATE OR REPLACE PACKAGE BODY "PUBLIC_PROCS_RENEWAL_V18" AS
15:21:33   2  
15:21:33   3  PROCEDURE SUB_EXPIRES_NEED_ENTITLEMENTS (
15:21:33   4  	out_result_set OUT SYS_REFCURSOR
15:21:33   5  ) AS
15:21:33   6  BEGIN
15:21:33   7  	PROCS_GROUP_ACCOUNT_V18.SUB_EXPIRES_NEED_ENTITLEMENTS(out_result_set => out_result_set);
15:21:33   8  END SUB_EXPIRES_NEED_ENTITLEMENTS;
15:21:33   9  
15:21:33  10  PROCEDURE UPDATE_SS_NEED_ENTITLEMENTS (
15:21:33  11  	in_sub_share_id      IN SUBSCRIPTION_SHARE.ID%TYPE,
15:21:33  12  	in_need_entitlements IN SUBSCRIPTION_SHARE.NEEDS_ENTITLEMENTS%TYPE,
15:21:33  13  	in_updater	     IN SUBSCRIPTION_SHARE.UPDATED_BY%TYPE
15:21:33  14  ) AS
15:21:33  15  BEGIN
15:21:33  16  	PROCS_GROUP_ACCOUNT_V18.UPDATE_SS_NEED_ENTITLEMENTS(
15:21:33  17  	  in_sub_share_id => in_sub_share_id,
15:21:33  18  	  in_need_entitlements => in_need_entitlements,
15:21:33  19  	  in_updater => in_updater
15:21:33  20  	);
15:21:33  21  END UPDATE_SS_NEED_ENTITLEMENTS;
15:21:33  22  
15:21:33  23  PROCEDURE GET_OFFER_CHAIN_BY_ID (
15:21:33  24  /*
15:21:33  25  Throws exceptions:
15:21:33  26  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33  27  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33  28  */
15:21:33  29  	  in_offer_chain_id IN	 NUMBER,
15:21:33  30  	  out_result_set    OUT  SYS_REFCURSOR
15:21:33  31  ) AS
15:21:33  32  BEGIN
15:21:33  33  	PROCS_OFFER_CHAIN_V18.GET_OFFER_CHAIN_BY_ID (
15:21:33  34  	  in_offer_chain_id => in_offer_chain_id,
15:21:33  35  	  out_result_set => out_result_set
15:21:33  36  	);
15:21:33  37  END GET_OFFER_CHAIN_BY_ID;
15:21:33  38  
15:21:33  39  PROCEDURE GET_OFFER_CHAIN_META_DATA (
15:21:33  40  /*
15:21:33  41  Throws exceptions (codes):
15:21:33  42  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33  43  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33  44  */
15:21:33  45  	in_offer_chain_id IN NUMBER,
15:21:33  46  	in_meta_data_name IN VARCHAR2,
15:21:33  47  	out_result_set	  OUT SYS_REFCURSOR
15:21:33  48  )AS
15:21:33  49  BEGIN
15:21:33  50  	PROCS_OFFER_CHAIN_V18.GET_OFFER_CHAIN_META_DATA(
15:21:33  51  	  in_offer_chain_id,
15:21:33  52  	  in_meta_data_name,
15:21:33  53  	  out_result_set
15:21:33  54  	);
15:21:33  55  END GET_OFFER_CHAIN_META_DATA;
15:21:33  56  
15:21:33  57  PROCEDURE GET_ENDING_LICENSES (
15:21:33  58  /*
15:21:33  59  Throws exceptions:
15:21:33  60  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33  61  */
15:21:33  62  	in_hours_number IN NUMBER,
15:21:33  63  	out_result_set OUT SYS_REFCURSOR
15:21:33  64  ) AS
15:21:33  65  BEGIN
15:21:33  66  	PROCS_LICENSE_V18.GET_ENDING_LICENSES(in_hours_number,out_result_set);
15:21:33  67  END GET_ENDING_LICENSES;
15:21:33  68  
15:21:33  69  PROCEDURE GET_ENDING_LICENSES_CC (
15:21:33  70  /*
15:21:33  71  Throws exceptions:
15:21:33  72  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33  73  */
15:21:33  74  	in_hours_number IN NUMBER,
15:21:33  75  	out_result_set OUT SYS_REFCURSOR,
15:21:33  76  	in_process_name 	IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE
15:21:33  77  ) AS
15:21:33  78  BEGIN
15:21:33  79  	PROCS_LICENSE_V18.GET_ENDING_LICENSES_CC(in_hours_number,out_result_set, in_process_name);
15:21:33  80  END GET_ENDING_LICENSES_CC;
15:21:33  81  
15:21:33  82  /*******************************************************/
15:21:33  83  
15:21:33  84  PROCEDURE GET_RECURRING_OFFER (
15:21:33  85  /*
15:21:33  86  Throws exceptions:
15:21:33  87  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33  88  */
15:21:33  89  	in_license_id  IN NUMBER,
15:21:33  90  	out_result_set OUT SYS_REFCURSOR
15:21:33  91  ) AS
15:21:33  92  BEGIN
15:21:33  93  	PROCS_LICENSE_V18.GET_RECURRING_OFFER (
15:21:33  94  	  in_license_id,
15:21:33  95  	  out_result_set
15:21:33  96  	);
15:21:33  97  END GET_RECURRING_OFFER;
15:21:33  98  
15:21:33  99  /********************************************************/
15:21:33 100  
15:21:33 101  PROCEDURE GET_NEXT_OFFER (
15:21:33 102  /*
15:21:33 103  Throws exceptions:
15:21:33 104  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 105  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:33 106  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 107  */
15:21:33 108  	in_license_id  IN NUMBER,
15:21:33 109  	out_result_set OUT SYS_REFCURSOR
15:21:33 110  ) AS
15:21:33 111  BEGIN
15:21:33 112  	PROCS_LICENSE_V18.GET_NEXT_OFFER (
15:21:33 113  	  in_license_id,
15:21:33 114  	  out_result_set
15:21:33 115  	);
15:21:33 116  END GET_NEXT_OFFER;
15:21:33 117  
15:21:33 118  /*********************************************************/
15:21:33 119  
15:21:33 120  PROCEDURE UPDATE_LICENSE_STATUS(
15:21:33 121  /*
15:21:33 122  Throws exceptions:
15:21:33 123  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 124  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 125  */
15:21:33 126  	  in_license_id     IN NUMBER,
15:21:33 127  	  in_license_status IN NUMBER,
15:21:33 128  	  in_updated_by     IN VARCHAR2
15:21:33 129  ) AS
15:21:33 130  BEGIN
15:21:33 131  	PROCS_LICENSE_V18.UPDATE_LICENSE_STATUS (
15:21:33 132  	  in_license_id,
15:21:33 133  	  in_license_status,
15:21:33 134  	  in_updated_by
15:21:33 135  	);
15:21:33 136  END UPDATE_LICENSE_STATUS;
15:21:33 137  
15:21:33 138  /**********************************************************/
15:21:33 139  
15:21:33 140  PROCEDURE UPDATE_INVOICE_STATUS (
15:21:33 141  /*
15:21:33 142  Throws exceptions:
15:21:33 143  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 144  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 145  */
15:21:33 146  	in_invoice_id		       IN NUMBER,
15:21:33 147  	in_invoice_status_id	       IN NUMBER,
15:21:33 148  	in_updated_by		       IN VARCHAR2
15:21:33 149  ) AS
15:21:33 150  BEGIN
15:21:33 151  	PROCS_INVOICE_V18.UPDATE_INVOICE_STATUS(
15:21:33 152  	  in_invoice_id,
15:21:33 153  	  in_invoice_status_id,
15:21:33 154  	  in_updated_by
15:21:33 155  	);
15:21:33 156  END UPDATE_INVOICE_STATUS;
15:21:33 157  
15:21:33 158  /***********************************************************/
15:21:33 159  
15:21:33 160  PROCEDURE CREATE_LICENSE(
15:21:33 161  /*
15:21:33 162  Throws exceptions:
15:21:33 163  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 164  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 165  APP_EXCEPTION_CODES_V18.INTERNAL_ERROR
15:21:33 166  */
15:21:33 167  	in_status_id		    IN NUMBER,
15:21:33 168  	in_needs_entitlements	    IN NUMBER,
15:21:33 169  	in_start_date		    IN DATE,
15:21:33 170  	in_end_date		    IN DATE,
15:21:33 171  	in_offer_id		    IN NUMBER,
15:21:33 172  	in_subscription_id	    IN NUMBER,
15:21:33 173  	in_invoice_id		    IN NUMBER,
15:21:33 174  	in_created_by		    IN VARCHAR2,
15:21:33 175  	in_is_extension 	    IN NUMBER,
15:21:33 176  	in_current_offer_index	    IN NUMBER,
15:21:33 177  	in_current_offer_recurr_num IN NUMBER,
15:21:33 178  	out_license_id		    OUT NUMBER
15:21:33 179  ) AS
15:21:33 180  BEGIN
15:21:33 181  	PROCS_LICENSE_V18.CREATE_LICENSE (
15:21:33 182  	  in_status_id,
15:21:33 183  	  in_needs_entitlements,
15:21:33 184  	  in_start_date,
15:21:33 185  	  in_end_date,
15:21:33 186  	  in_offer_id,
15:21:33 187  	  in_subscription_id,
15:21:33 188  	  in_invoice_id,
15:21:33 189  	  in_created_by,
15:21:33 190  	  in_is_extension,
15:21:33 191  	  in_current_offer_index,
15:21:33 192  	  in_current_offer_recurr_num,
15:21:33 193  	  out_license_id
15:21:33 194  	);
15:21:33 195  END CREATE_LICENSE;
15:21:33 196  
15:21:33 197  /******************************************************/
15:21:33 198  
15:21:33 199  PROCEDURE CREATE_INVOICE(
15:21:33 200  /*
15:21:33 201  Throws exceptions:
15:21:33 202  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 203  */
15:21:33 204  	  in_invoice_status IN NUMBER,
15:21:33 205  	  in_created_by     IN VARCHAR2,
15:21:33 206  	  in_tax_exempt_id  IN VARCHAR2,
15:21:33 207  	  out_invoice_id    OUT NUMBER
15:21:33 208  ) AS
15:21:33 209  BEGIN
15:21:33 210  	PROCS_INVOICE_V18.CREATE_INVOICE (
15:21:33 211  	  in_invoice_status,
15:21:33 212  	  in_created_by,
15:21:33 213  	  in_tax_exempt_id,
15:21:33 214  	  out_invoice_id
15:21:33 215  	);
15:21:33 216  END CREATE_INVOICE;
15:21:33 217  
15:21:33 218  /*******************************************************/
15:21:33 219  
15:21:33 220  PROCEDURE CREATE_CHARGE(
15:21:33 221  /*
15:21:33 222  Throws exceptions:
15:21:33 223  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 224  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 225  */
15:21:33 226  	in_invoice_id	      IN NUMBER,
15:21:33 227  	in_transaction_id     IN NUMBER,
15:21:33 228  	in_instrument_type_id IN NUMBER,
15:21:33 229  	in_instrument_id      IN NUMBER,
15:21:33 230  	in_charge_amount      IN NUMBER,
15:21:33 231  	in_created_by	      IN VARCHAR2,
15:21:33 232  	in_charge_status_id   IN NUMBER,
15:21:33 233  	out_charge_id	      OUT NUMBER
15:21:33 234  ) AS
15:21:33 235  BEGIN
15:21:33 236  	PROCS_CHARGE_V18.CREATE_CHARGE (
15:21:33 237  	  in_invoice_id,
15:21:33 238  	  in_transaction_id,
15:21:33 239  	  in_instrument_type_id,
15:21:33 240  	  in_instrument_id,
15:21:33 241  	  in_charge_amount,
15:21:33 242  	  in_created_by,
15:21:33 243  	  in_charge_status_id,
15:21:33 244  	  out_charge_id
15:21:33 245  	);
15:21:33 246  END CREATE_CHARGE;
15:21:33 247  
15:21:33 248  /**********************************************************/
15:21:33 249  
15:21:33 250  PROCEDURE HAS_FUTURE_LICENSE (
15:21:33 251  /*
15:21:33 252  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 253  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 254  --
15:21:33 255  RETURNS:
15:21:33 256  1 - if has,
15:21:33 257  0 - else
15:21:33 258  */
15:21:33 259  	in_license_id IN NUMBER,
15:21:33 260  	out_result	   OUT NUMBER
15:21:33 261  ) AS
15:21:33 262  BEGIN
15:21:33 263  	PROCS_SUBSCRIPTION_V18.HAS_FUTURE_LICENSE (
15:21:33 264  	  in_license_id,
15:21:33 265  	  out_result
15:21:33 266  	);
15:21:33 267  END HAS_FUTURE_LICENSE;
15:21:33 268  
15:21:33 269  /***********************************************************/
15:21:33 270  
15:21:33 271  PROCEDURE GET_GROUP_ID_BY_LICENSE_ID (
15:21:33 272  /*
15:21:33 273  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 274  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 275  */
15:21:33 276  	in_license_id IN NUMBER,
15:21:33 277  	out_group_id  OUT NUMBER
15:21:33 278  ) AS
15:21:33 279  BEGIN
15:21:33 280  	PROCS_LICENSE_V18.GET_GROUP_ID_BY_LICENSE_ID (
15:21:33 281  	  in_license_id,
15:21:33 282  	  out_group_id
15:21:33 283  	);
15:21:33 284  END GET_GROUP_ID_BY_LICENSE_ID;
15:21:33 285  
15:21:33 286  /**********************************************************/
15:21:33 287  
15:21:33 288  PROCEDURE GET_OFFER_PRODUCTS (
15:21:33 289  /*
15:21:33 290  Throws exceptions (codes):
15:21:33 291  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 292  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 293  */
15:21:33 294  	in_offer_id    IN NUMBER,
15:21:33 295  	out_result_set OUT SYS_REFCURSOR
15:21:33 296  ) AS
15:21:33 297  BEGIN
15:21:33 298  	PROCS_OFFER_CHAIN_V18.GET_OFFER_PRODUCTS (
15:21:33 299  	  in_offer_id,
15:21:33 300  	  out_result_set
15:21:33 301  	);
15:21:33 302  END GET_OFFER_PRODUCTS;
15:21:33 303  
15:21:33 304  /***********************************************************/
15:21:33 305  
15:21:33 306  PROCEDURE CREATE_TRANSACTION (
15:21:33 307  /*
15:21:33 308  Throws exceptions:
15:21:33 309  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 310  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 311  */
15:21:33 312  	in_transaction_id	  IN NUMBER,
15:21:33 313  	in_status_id		  IN NUMBER,
15:21:33 314  	in_amount		  IN NUMBER,
15:21:33 315  	in_created_by		  IN VARCHAR2,
15:21:33 316  	in_order_id		  IN VARCHAR2,
15:21:33 317  	in_transaction_type_code  IN VARCHAR2 DEFAULT NULL,
15:21:33 318  	out_transaction_id	  OUT NUMBER
15:21:33 319  ) AS
15:21:33 320  BEGIN
15:21:33 321  	PROCS_TRANSACTION_V18.CREATE_TRANSACTION(
15:21:33 322  	  in_transaction_id,
15:21:33 323  	  in_status_id,
15:21:33 324  	  in_amount,
15:21:33 325  	  in_created_by,
15:21:33 326  	  in_order_id,
15:21:33 327  	  GLOBAL_CONSTANTS_V18.FALSE, -- is_refund should be false in renewal
15:21:33 328  	  in_transaction_type_code,
15:21:33 329  	  out_transaction_id
15:21:33 330  	);
15:21:33 331  END CREATE_TRANSACTION;
15:21:33 332  
15:21:33 333  /************************************************************/
15:21:33 334  
15:21:33 335  PROCEDURE ADD_LINE_ITEMS(
15:21:33 336  /*
15:21:33 337  Throws exceptions:
15:21:33 338  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 339  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 340  */
15:21:33 341  	in_invoice_id IN NUMBER,
15:21:33 342  	in_offer_id   IN NUMBER,
15:21:33 343  	in_created_by IN VARCHAR2
15:21:33 344  ) AS
15:21:33 345  BEGIN
15:21:33 346  	PROCS_LINE_ITEMS_V18.ADD_LINE_ITEMS(
15:21:33 347  	  in_invoice_id,
15:21:33 348  	  in_offer_id,
15:21:33 349  	  in_created_by
15:21:33 350  	);
15:21:33 351  END ADD_LINE_ITEMS;
15:21:33 352  
15:21:33 353  /************************************************************/
15:21:33 354  
15:21:33 355  PROCEDURE CALCULATE_INVOICE_AMOUNT (
15:21:33 356  /*
15:21:33 357  Throws exceptions:
15:21:33 358  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 359  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 360  */
15:21:33 361  	in_invoice_id IN  NUMBER,
15:21:33 362  	out_amount    OUT NUMBER
15:21:33 363  ) AS
15:21:33 364  BEGIN
15:21:33 365  	PROCS_INVOICE_V18.CALCULATE_INVOICE_AMOUNT (
15:21:33 366  	  in_invoice_id,
15:21:33 367  	  out_amount
15:21:33 368  	);
15:21:33 369  END CALCULATE_INVOICE_AMOUNT;
15:21:33 370  
15:21:33 371  /*************************************************************/
15:21:33 372  
15:21:33 373  PROCEDURE RESERVE_TRANSACTION_ID (
15:21:33 374  /*
15:21:33 375  Throws exceptions:
15:21:33 376  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 377  */
15:21:33 378  	out_transaction_id OUT NUMBER
15:21:33 379  ) AS
15:21:33 380  BEGIN
15:21:33 381  	PROCS_TRANSACTION_V18.RESERVE_TRANSACTION_ID (
15:21:33 382  	  out_transaction_id
15:21:33 383  	);
15:21:33 384  END RESERVE_TRANSACTION_ID;
15:21:33 385  
15:21:33 386  /***************************************************************/
15:21:33 387  
15:21:33 388  PROCEDURE P_GET_NEXT_OFFER_INDEX (
15:21:33 389  	in_offer_chain_id	     IN NUMBER,
15:21:33 390  	in_offer_chain_current_index IN NUMBER,
15:21:33 391  	out_next_offer_index	     OUT NUMBER
15:21:33 392  ) AS
15:21:33 393  BEGIN
15:21:33 394  	PROCS_OFFER_CHAIN_V18.P_GET_NEXT_OFFER_INDEX(
15:21:33 395  	  in_offer_chain_id,
15:21:33 396  	  in_offer_chain_current_index,
15:21:33 397  	  out_next_offer_index
15:21:33 398  	);
15:21:33 399  END P_GET_NEXT_OFFER_INDEX;
15:21:33 400  
15:21:33 401  /***************************************************************/
15:21:33 402  
15:21:33 403  PROCEDURE GET_NEXT_OFFER_INDEX_BY_LCNS (
15:21:33 404  	in_license_id		     IN NUMBER,
15:21:33 405  	in_offer_chain_current_index IN NUMBER,
15:21:33 406  	out_next_offer_index	     OUT NUMBER
15:21:33 407  ) AS
15:21:33 408  BEGIN
15:21:33 409  	PROCS_OFFER_CHAIN_V18.GET_NEXT_OFFER_INDEX_BY_LCNS(
15:21:33 410  	  in_license_id,
15:21:33 411  	  in_offer_chain_current_index,
15:21:33 412  	  out_next_offer_index
15:21:33 413  	);
15:21:33 414  END GET_NEXT_OFFER_INDEX_BY_LCNS;
15:21:33 415  
15:21:33 416  /******************************************************************/
15:21:33 417  
15:21:33 418  PROCEDURE GET_SUBSCRIPTION_INFO (
15:21:33 419  /*
15:21:33 420  Throws exceptions:
15:21:33 421  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 422  */
15:21:33 423  	  in_subscription_id IN  NUMBER,
15:21:33 424  	  out_result_set      OUT SYS_REFCURSOR
15:21:33 425  ) AS
15:21:33 426  BEGIN
15:21:33 427  	PROCS_SUBSCRIPTION_V18.GET_SUBSCRIPTION_INFO(
15:21:33 428  	  in_subscription_id,
15:21:33 429  	  out_result_set
15:21:33 430  	);
15:21:33 431  END GET_SUBSCRIPTION_INFO;
15:21:33 432  
15:21:33 433  /*******************************************************************/
15:21:33 434  
15:21:33 435  PROCEDURE CLOSE_SUBSCRIPTION (
15:21:33 436  	in_subscription_id IN NUMBER,
15:21:33 437  	in_updated_by	   IN VARCHAR2
15:21:33 438  ) AS
15:21:33 439  BEGIN
15:21:33 440  	PROCS_SUBSCRIPTION_V18.CLOSE_SUBSCRIPTION(
15:21:33 441  	  in_subscription_id,
15:21:33 442  	  in_updated_by
15:21:33 443  	);
15:21:33 444  END CLOSE_SUBSCRIPTION;
15:21:33 445  
15:21:33 446  /*******************************************************************/
15:21:33 447  
15:21:33 448  PROCEDURE GET_NEED_ENTITLEMENTS_LICENSES (
15:21:33 449  	out_result_set OUT SYS_REFCURSOR
15:21:33 450  ) AS
15:21:33 451  BEGIN
15:21:33 452  	PROCS_LICENSE_V18.GET_NEED_ENTITLEMENTS_LICENSES(
15:21:33 453  	  out_result_set
15:21:33 454  	);
15:21:33 455  END GET_NEED_ENTITLEMENTS_LICENSES;
15:21:33 456  
15:21:33 457  /*******************************************************************/
15:21:33 458  
15:21:33 459  PROCEDURE UPDATE_NEED_ENTITLEMENTS_FLAG (
15:21:33 460  	in_license_id	      IN NUMBER,
15:21:33 461  	in_needs_entitlements IN NUMBER,
15:21:33 462  	in_updated_by	      IN VARCHAR2
15:21:33 463  ) AS
15:21:33 464  BEGIN
15:21:33 465  	PROCS_LICENSE_V18.UPDATE_NEED_ENTITLEMENTS_FLAG(
15:21:33 466  	  in_license_id,
15:21:33 467  	  in_needs_entitlements,
15:21:33 468  	  in_updated_by
15:21:33 469  	);
15:21:33 470  END UPDATE_NEED_ENTITLEMENTS_FLAG;
15:21:33 471  
15:21:33 472  /*******************************************************/
15:21:33 473  
15:21:33 474  PROCEDURE GET_PROD_OFFERINGS_BY_OFFER_ID (
15:21:33 475  /*
15:21:33 476  Throws exceptions (codes):
15:21:33 477  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 478  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 479  */
15:21:33 480  	in_offer_id    IN NUMBER,
15:21:33 481  	out_result_set OUT SYS_REFCURSOR
15:21:33 482  ) AS
15:21:33 483  BEGIN
15:21:33 484  	PROCS_OFFER_CHAIN_V18.GET_PROD_OFFERINGS_BY_OFFER_ID(in_offer_id,out_result_set);
15:21:33 485  END GET_PROD_OFFERINGS_BY_OFFER_ID;
15:21:33 486  
15:21:33 487  /*******************************************************/
15:21:33 488  PROCEDURE GET_PRODUCT_OFFERING_META_DATA (
15:21:33 489  /*
15:21:33 490  Throws exceptions (codes):
15:21:33 491  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 492  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 493  */
15:21:33 494  	in_product_offering_id IN NUMBER,
15:21:33 495  	in_meta_data_name      IN VARCHAR2 DEFAULT NULL,
15:21:33 496  	out_result_set	       OUT SYS_REFCURSOR
15:21:33 497  ) AS
15:21:33 498  BEGIN
15:21:33 499  	PROCS_OFFER_CHAIN_V18.GET_PRODUCT_OFFERING_META_DATA(in_product_offering_id,in_meta_data_name,out_result_set);
15:21:33 500  END GET_PRODUCT_OFFERING_META_DATA;
15:21:33 501  
15:21:33 502  /*******************************************************/
15:21:33 503  
15:21:33 504  PROCEDURE LOCK_ACCOUNT (
15:21:33 505  	in_group_id    IN NUMBER,
15:21:33 506  	in_lock_key    IN VARCHAR2,
15:21:33 507  	in_seconds_num IN NUMBER,
15:21:33 508  	in_created_by  IN VARCHAR2,
15:21:33 509  	in_reason      IN VARCHAR2
15:21:33 510  ) AS
15:21:33 511  BEGIN
15:21:33 512  	PROCS_LOCKING_V18.LOCK_ACCOUNT(
15:21:33 513  	  in_group_id,
15:21:33 514  	  in_lock_key,
15:21:33 515  	  in_seconds_num,
15:21:33 516  	  in_created_by,
15:21:33 517  	  in_reason
15:21:33 518  	);
15:21:33 519  END LOCK_ACCOUNT;
15:21:33 520  
15:21:33 521  /****************************************************************/
15:21:33 522  
15:21:33 523  PROCEDURE RELEASE_LOCK (
15:21:33 524  	in_group_id IN NUMBER,
15:21:33 525  	in_lock_key IN VARCHAR2
15:21:33 526  ) AS
15:21:33 527  BEGIN
15:21:33 528  	PROCS_LOCKING_V18.RELEASE_LOCK(
15:21:33 529  	  in_group_id,
15:21:33 530  	  in_lock_key
15:21:33 531  	);
15:21:33 532  END RELEASE_LOCK;
15:21:33 533  
15:21:33 534  /******************************************************************************/
15:21:33 535  
15:21:33 536  PROCEDURE GET_INVOICE_LINE_ITEMS (
15:21:33 537  	in_invoice_id  IN NUMBER,
15:21:33 538  	out_result_set OUT SYS_REFCURSOR
15:21:33 539  ) AS
15:21:33 540  BEGIN
15:21:33 541  	PROCS_INVOICE_V18.GET_INVOICE_LINE_ITEMS(
15:21:33 542  	  in_invoice_id,
15:21:33 543  	  out_result_set
15:21:33 544  	);
15:21:33 545  END GET_INVOICE_LINE_ITEMS;
15:21:33 546  
15:21:33 547  /******************************************************************************/
15:21:33 548  
15:21:33 549  PROCEDURE ADD_TAX (
15:21:33 550  	in_tax_type_id		 IN NUMBER,
15:21:33 551  	in_calculated_amount	 IN NUMBER,
15:21:33 552  	in_created_by		 IN VARCHAR2,
15:21:33 553  	in_line_item_id 	 IN NUMBER,
15:21:33 554  	in_effective_rate	 IN VARCHAR2,
15:21:33 555  	in_taxable_amount	 IN NUMBER,
15:21:33 556  	in_tax_rule_id		 IN NUMBER,
15:21:33 557  	in_jurisdiction_level_id IN NUMBER,
15:21:33 558  	in_jurisdiction_name	 IN VARCHAR2,
15:21:33 559  	in_jurisdiction_id	 IN VARCHAR2,
15:21:33 560  	in_ext_tax_type 	 IN VARCHAR2,
15:21:33 561  	in_ext_result		 IN VARCHAR2,
15:21:33 562  	in_imposition_type	 IN VARCHAR2,
15:21:33 563  	in_imposition		 IN VARCHAR2
15:21:33 564  ) AS
15:21:33 565  BEGIN
15:21:33 566  	PROCS_TAXES_V18.ADD_TAX(
15:21:33 567  	  in_tax_type_id,
15:21:33 568  	  in_calculated_amount,
15:21:33 569  	  in_created_by,
15:21:33 570  	  in_line_item_id,
15:21:33 571  	  in_effective_rate,
15:21:33 572  	  in_taxable_amount,
15:21:33 573  	  in_tax_rule_id,
15:21:33 574  	  in_jurisdiction_level_id,
15:21:33 575  	  in_jurisdiction_name,
15:21:33 576  	  in_jurisdiction_id,
15:21:33 577  	  in_ext_tax_type,
15:21:33 578  	  in_ext_result,
15:21:33 579  	  in_imposition_type,
15:21:33 580  	  in_imposition
15:21:33 581  	);
15:21:33 582  END ADD_TAX;
15:21:33 583  
15:21:33 584  /******************************************************************************/
15:21:33 585  
15:21:33 586  PROCEDURE GET_CREDIT_CARD_BY_ID (
15:21:33 587  	in_credit_card_id IN  NUMBER,
15:21:33 588  	out_result_set	  OUT SYS_REFCURSOR
15:21:33 589  ) AS
15:21:33 590  BEGIN
15:21:33 591  	PROCS_FIN_INSTRUMENTS_V18.GET_CREDIT_CARD_BY_ID(
15:21:33 592  	  in_credit_card_id,
15:21:33 593  	  out_result_set
15:21:33 594  	);
15:21:33 595  END GET_CREDIT_CARD_BY_ID;
15:21:33 596  
15:21:33 597  /******************************************************************************/
15:21:33 598  
15:21:33 599  PROCEDURE GET_PRD_OFFERING_BY_LINE_IT_ID (
15:21:33 600  	in_line_item_id IN NUMBER,
15:21:33 601  	out_result_set	OUT SYS_REFCURSOR
15:21:33 602  ) AS
15:21:33 603  BEGIN
15:21:33 604  	PROCS_PRODUCT_V18.GET_PRD_OFFERING_BY_LINE_IT_ID(
15:21:33 605  	  in_line_item_id,
15:21:33 606  	  out_result_set
15:21:33 607  	);
15:21:33 608  END GET_PRD_OFFERING_BY_LINE_IT_ID;
15:21:33 609  
15:21:33 610  /******************************************************************************/
15:21:33 611  
15:21:33 612  PROCEDURE GET_ACCOUNT_ID_BY_GROUP_ID (
15:21:33 613  /*
15:21:33 614  Throws exceptions:
15:21:33 615  APP_EXCEPTION_CODES_V18.NOT_FOUND,
15:21:33 616  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 617  */
15:21:33 618  	in_group_id IN NUMBER,
15:21:33 619  	out_account_id	OUT NUMBER
15:21:33 620  ) AS
15:21:33 621  BEGIN
15:21:33 622  	PROCS_ACCOUNT_V18.GET_ACCOUNT_ID_BY_GROUP_ID(
15:21:33 623  	  in_group_id,
15:21:33 624  	  out_account_id
15:21:33 625  	);
15:21:33 626  END GET_ACCOUNT_ID_BY_GROUP_ID;
15:21:33 627  
15:21:33 628  /******************************************************************************/
15:21:33 629  
15:21:33 630  PROCEDURE GET_LINE_ITEM_DISCOUNTS (
15:21:33 631  /*
15:21:33 632  Throws exceptions:
15:21:33 633  APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33 634  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 635  */
15:21:33 636  	in_line_item_id IN  NUMBER,
15:21:33 637  	out_result_set	OUT SYS_REFCURSOR
15:21:33 638  ) AS
15:21:33 639  BEGIN
15:21:33 640  	PROCS_LINE_ITEMS_V18.GET_LINE_ITEM_DISCOUNTS(
15:21:33 641  	  in_line_item_id,
15:21:33 642  	  out_result_set
15:21:33 643  	);
15:21:33 644  END GET_LINE_ITEM_DISCOUNTS;
15:21:33 645  
15:21:33 646  /******************************************************************************/
15:21:33 647  
15:21:33 648  PROCEDURE UPDATE_LINE_ITEM_AMOUNT (
15:21:33 649  	in_line_item_id    IN NUMBER,
15:21:33 650  	in_amount	   IN NUMBER,
15:21:33 651  	in_discount_amount IN NUMBER,
15:21:33 652  	in_taxes_amount    IN NUMBER
15:21:33 653  ) AS
15:21:33 654  BEGIN
15:21:33 655  	PROCS_LINE_ITEMS_V18.UPDATE_LINE_ITEM_AMOUNT(
15:21:33 656  	  in_line_item_id,
15:21:33 657  	  in_amount,
15:21:33 658  	  in_discount_amount,
15:21:33 659  	  in_taxes_amount
15:21:33 660  	);
15:21:33 661  END UPDATE_LINE_ITEM_AMOUNT;
15:21:33 662  
15:21:33 663  /******************************************************************************/
15:21:33 664  
15:21:33 665  PROCEDURE GET_PAYPAL_BY_ID (
15:21:33 666  	in_paypal_id   IN  NUMBER,
15:21:33 667  	out_result_set OUT SYS_REFCURSOR
15:21:33 668  ) AS
15:21:33 669  BEGIN
15:21:33 670  	PROCS_FIN_INSTRUMENTS_V18.GET_PAYPAL_BY_ID(
15:21:33 671  	  in_paypal_id,
15:21:33 672  	  out_result_set
15:21:33 673  	);
15:21:33 674  END GET_PAYPAL_BY_ID;
15:21:33 675  
15:21:33 676  PROCEDURE GET_GC_BY_PURCH_INVOICE_ID (
15:21:33 677  	in_invoice_id		IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
15:21:33 678  	out_result_set OUT SYS_REFCURSOR
15:21:33 679  ) AS
15:21:33 680  BEGIN
15:21:33 681  	PROCS_FIN_INSTRUMENTS_V18.GET_GC_BY_PURCH_INVOICE_ID (
15:21:33 682  	  in_invoice_id,
15:21:33 683  	  out_result_set
15:21:33 684  	);
15:21:33 685  END GET_GC_BY_PURCH_INVOICE_ID;
15:21:33 686  
15:21:33 687  PROCEDURE GET_LICENSE_BY_ID (
15:21:33 688  	in_license_id  IN NUMBER,
15:21:33 689  	out_result_set OUT SYS_REFCURSOR
15:21:33 690  ) AS
15:21:33 691  BEGIN
15:21:33 692  	PROCS_LICENSE_V18.GET_LICENSE_BY_ID (
15:21:33 693  	  in_license_id,
15:21:33 694  	  out_result_set
15:21:33 695  	);
15:21:33 696  END GET_LICENSE_BY_ID;
15:21:33 697  
15:21:33 698  /******************************************************************************/
15:21:33 699  
15:21:33 700  PROCEDURE GET_NOTIFICATION_TYPE_ID (
15:21:33 701  	in_offer_chain_id	 IN NUMBER,
15:21:33 702  	in_action_name		 IN VARCHAR2,
15:21:33 703  	out_notification_type_id OUT NUMBER
15:21:33 704  ) AS
15:21:33 705  BEGIN
15:21:33 706  	PROCS_OFFER_CHAIN_V18.GET_NOTIFICATION_TYPE_ID(
15:21:33 707  	  in_offer_chain_id,
15:21:33 708  	  in_action_name,
15:21:33 709  	  out_notification_type_id
15:21:33 710  	);
15:21:33 711  END GET_NOTIFICATION_TYPE_ID;
15:21:33 712  
15:21:33 713  /******************************************************************************/
15:21:33 714  
15:21:33 715  PROCEDURE GET_ALL_OCH_META_DATA (
15:21:33 716  	in_offer_chain_id IN NUMBER,
15:21:33 717  	out_result_set	  OUT SYS_REFCURSOR
15:21:33 718  ) AS
15:21:33 719  BEGIN
15:21:33 720  	PROCS_OFFER_CHAIN_V18.GET_ALL_META_DATA (
15:21:33 721  	  in_offer_chain_id,
15:21:33 722  	  out_result_set
15:21:33 723  	);
15:21:33 724  END GET_ALL_OCH_META_DATA;
15:21:33 725  
15:21:33 726  /******************************************************************************/
15:21:33 727  
15:21:33 728  PROCEDURE GET_SUBSCRIPTIONS_META_DATA (
15:21:33 729  /*
15:21:33 730  APP_EXCEPTION_CODES_V18.INVALID_PARAMETER
15:21:33 731  APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33 732  */
15:21:33 733  	in_subscriptions_ids IN core_owner.NUMBER_TABLE,
15:21:33 734  	out_result_set	     OUT SYS_REFCURSOR
15:21:33 735  ) AS
15:21:33 736  BEGIN
15:21:33 737  	PROCS_SUBSCRIPTION_V18.GET_SUBSCRIPTIONS_META_DATA(
15:21:33 738  	  in_subscriptions_ids,
15:21:33 739  	  out_result_set
15:21:33 740  	);
15:21:33 741  END GET_SUBSCRIPTIONS_META_DATA;
15:21:33 742  
15:21:33 743  PROCEDURE GET_UNREDEEMED_GCS (
15:21:33 744  	out_result_set		OUT SYS_REFCURSOR,
15:21:33 745  	in_hours_number 	IN NUMBER DEFAULT 14*24,
15:21:33 746  	in_num_rows		IN NUMBER DEFAULT 10000,
15:21:33 747  	in_process_name 	IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE
15:21:33 748  ) AS
15:21:33 749  BEGIN
15:21:33 750  	PROCS_FIN_INSTRUMENTS_V18.GET_UNREDEEMED_GCS(
15:21:33 751  	  out_result_set => out_result_set,
15:21:33 752  	  in_hours_number => in_hours_number,
15:21:33 753  	  in_num_rows => in_num_rows,
15:21:33 754  	  in_process_name => in_process_name
15:21:33 755  	);
15:21:33 756  END GET_UNREDEEMED_GCS;
15:21:33 757  
15:21:33 758  PROCEDURE GET_OFFER_CHAIN_MD_VALUE (
15:21:33 759  	in_offer_chain_id IN NUMBER,
15:21:33 760  	in_meta_data_name IN VARCHAR2,
15:21:33 761  	out_value	  OUT VARCHAR2
15:21:33 762  ) AS
15:21:33 763  BEGIN
15:21:33 764  	PROCS_OFFER_CHAIN_V18.GET_OFFER_CHAIN_MD_VALUE(
15:21:33 765  	  in_offer_chain_id => in_offer_chain_id,
15:21:33 766  	  in_meta_data_name => in_meta_data_name,
15:21:33 767  	  out_value => out_value
15:21:33 768  	);
15:21:33 769  END GET_OFFER_CHAIN_MD_VALUE;
15:21:33 770  
15:21:33 771  PROCEDURE GET_ACT_SUBS_W_CPT_CHARGEBACKS (
15:21:33 772  	out_result_set	    OUT SYS_REFCURSOR
15:21:33 773  )
15:21:33 774  AS
15:21:33 775  BEGIN
15:21:33 776  	PROCS_SUBSCRIPTION_V18.GET_ACT_SUBS_W_CPT_CHARGEBACKS(
15:21:33 777  	  out_result_set => out_result_set
15:21:33 778  	);
15:21:33 779  END GET_ACT_SUBS_W_CPT_CHARGEBACKS;
15:21:33 780  
15:21:33 781  PROCEDURE GET_ACT_SUBS_W_PP_CHARGEBACKS (
15:21:33 782  	out_result_set	    OUT SYS_REFCURSOR
15:21:33 783  )
15:21:33 784  AS
15:21:33 785  BEGIN
15:21:33 786  	PROCS_SUBSCRIPTION_V18.GET_ACT_SUBS_W_PP_CHARGEBACKS(
15:21:33 787  	  out_result_set => out_result_set
15:21:33 788  	);
15:21:33 789  END GET_ACT_SUBS_W_PP_CHARGEBACKS;
15:21:33 790  
15:21:33 791  PROCEDURE GET_GRACE_PERIOD_SUB_REGIS (
15:21:33 792  	in_max_days_until_close IN NUMBER,
15:21:33 793  	in_num_subs_to_fetch	IN NUMBER,
15:21:33 794  	out_result_set		OUT SYS_REFCURSOR
15:21:33 795  )
15:21:33 796  AS
15:21:33 797  BEGIN
15:21:33 798  	PROCS_SUBSCRIPTION_V18.GET_GRACE_PERIOD_SUB_REGIS(
15:21:33 799  	  in_max_days_until_close => in_max_days_until_close,
15:21:33 800  	  in_num_subs_to_fetch => in_num_subs_to_fetch,
15:21:33 801  	  out_result_set => out_result_set
15:21:33 802  	);
15:21:33 803  END GET_GRACE_PERIOD_SUB_REGIS;
15:21:33 804  
15:21:33 805  PROCEDURE GET_ACT_SUBS_W_AMEX_CB (
15:21:33 806  	out_result_set	    OUT SYS_REFCURSOR
15:21:33 807  )
15:21:33 808  AS
15:21:33 809  BEGIN
15:21:33 810  	PROCS_SUBSCRIPTION_V18.GET_ACT_SUBS_W_AMEX_CB(
15:21:33 811  	  out_result_set => out_result_set
15:21:33 812  	);
15:21:33 813  END GET_ACT_SUBS_W_AMEX_CB;
15:21:33 814  
15:21:33 815  PROCEDURE GET_GRACE_LICE_FOR_FINAL_TRANS (
15:21:33 816  	in_days_before_close	 IN NUMBER,
15:21:33 817  	in_num_licenses_to_fetch IN NUMBER,
15:21:33 818  	out_result_set		 OUT SYS_REFCURSOR
15:21:33 819  ) AS
15:21:33 820  BEGIN
15:21:33 821  	PROCS_LICENSE_V18.GET_GRACE_LICE_FOR_FINAL_TRANS(
15:21:33 822  	  in_days_before_close => in_days_before_close,
15:21:33 823  	  in_num_licenses_to_fetch => in_num_licenses_to_fetch,
15:21:33 824  	  out_result_set => out_result_set
15:21:33 825  	);
15:21:33 826  END GET_GRACE_LICE_FOR_FINAL_TRANS;
15:21:33 827  
15:21:33 828  END PUBLIC_PROCS_RENEWAL_V18;
15:21:33 829  .
15:21:33 SQL> /

Package body created.

Elapsed: 00:00:00.06
15:21:33 SQL> 
15:21:33 SQL> CREATE OR REPLACE PACKAGE BODY "PUBLIC_PROCS_CLIENT_V18" AS
15:21:33   2  
15:21:33   3  PROCEDURE GET_NOTIFICATION_TYPE_BY_NAME (
15:21:33   4  /*
15:21:33   5  Throws exceptions:
15:21:33   6  CORE_OWNER.APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33   7  CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33   8  */
15:21:33   9  	in_notification_type_name IN VARCHAR2,
15:21:33  10  	out_notification_type_id  OUT NUMBER
15:21:33  11  ) AS
15:21:33  12  BEGIN
15:21:33  13  	PROCS_NOTIFICATION_V18.GET_NOTIFICATION_TYPE_BY_NAME (
15:21:33  14  	  in_notification_type_name,
15:21:33  15  	  out_notification_type_id
15:21:33  16  	);
15:21:33  17  END;
15:21:33  18  
15:21:33  19  /*****************************************************************/
15:21:33  20  
15:21:33  21  PROCEDURE ADD_NOTIFICATION (
15:21:33  22  /*
15:21:33  23  Throws exceptions:
15:21:33  24  CORE_OWNER.APP_EXCEPTION_CODES_V18.NOT_FOUND
15:21:33  25  CORE_OWNER.APP_EXCEPTION_CODES_V18.UNKNOWN_ERROR
15:21:33  26  */
15:21:33  27  	in_sender_account_id	 IN NUMBER DEFAULT 0,
15:21:33  28  	in_recipient_group_id	 IN NUMBER,
15:21:33  29  	in_notification_type_id  IN NUMBER,
15:21:33  30  	in_date_to_notify	 IN DATE,
15:21:33  31  	in_email_template_params IN CLOB
15:21:33  32  ) AS
15:21:33  33  BEGIN
15:21:33  34  	PROCS_NOTIFICATION_V18.ADD_NOTIFICATION (
15:21:33  35  	  in_sender_account_id,
15:21:33  36  	  in_recipient_group_id,
15:21:33  37  	  in_notification_type_id,
15:21:33  38  	  in_date_to_notify,
15:21:33  39  	  in_email_template_params
15:21:33  40  	);
15:21:33  41  END;
15:21:33  42  
15:21:33  43  END PUBLIC_PROCS_CLIENT_V18;
15:21:33  44  .
15:21:33 SQL> /

Package body created.

Elapsed: 00:00:00.01
15:21:33 SQL> 
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_ACCOUNT_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.02
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_ADX_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_CHARGE_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_COMMON_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_FIN_INSTRUMENTS_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_INVOICE_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_LICENSE_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_LINE_ITEMS_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_OFFER_CHAIN_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_PRODUCT_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_SUBSCRIPTION_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_SYSTEM_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_TEST_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_TRANSACTION_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_TAXES_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_LOCKING_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_ADJUSTMENTS_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.02
15:21:33 SQL> grant execute on CORE_OWNER.PUBLIC_PROCS_BILLING_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_ADDRESS_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_GROUP_ACCOUNT_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> 
15:21:33 SQL> grant execute on CORE_OWNER.PUBLIC_PROCS_BILLING_V18 to core_billing_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PUBLIC_PROCS_RENEWAL_V18 to core_licensing_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_GROUP_ACCOUNT_V18 to core_licensing_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PUBLIC_PROCS_NOTIFICATION_V18 to ops_notif_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> 
15:21:33 SQL> 
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_TAXES_V18 to core_tax_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_PRODUCT_V18 to core_tax_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_ACCOUNT_V18 to core_tax_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> 
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_POLLING_SYNC to core_poller_app;

Grant succeeded.

Elapsed: 00:00:00.03
15:21:33 SQL> 
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_RECONCILIATION_CRU_V18 to etl_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_SUBSCRIPTION_V18 to etl_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_TRANSACTION_V18 to etl_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_REPORTING to etl_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_LOCKING_V18 to etl_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_ACCOUNT_V18 to etl_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_INVOICE_V18 to etl_app;

Grant succeeded.

Elapsed: 00:00:00.02
15:21:33 SQL> 
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_ITUNES_RECEIPT_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_ITUNES_RECEIPT_V18 to core_subup_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_AMAZON_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_AMAZON_V18 to core_subup_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_LICENSE_V18 to core_subup_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_LOCKING_V18 to core_subup_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> 
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_SUBSCRIPTION_V18 to core_subup_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_GROUP_ACCOUNT_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_GROUP_ACCOUNT_CRU_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_ENTITLEMENT_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> 
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_CUPY to cupy_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_LOCKING_V18 to cupy_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> 
15:21:33 SQL> grant execute on CORE_OWNER.NOTIFICATION_STATUSES_V18 to ops_aaa_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_NOTIFICATION_V18 to ops_aaa_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_SYSTEM_V18 to ops_aaa_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> 
15:21:33 SQL> grant execute on CORE_OWNER.NOTIFICATION_STATUSES_V18 to ops_payment_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_NOTIFICATION_V18 to ops_payment_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_SYSTEM_V18 to ops_payment_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> 
15:21:33 SQL> grant execute on CORE_OWNER.NOTIFICATION_STATUSES_V18 to ops_notif_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_NOTIFICATION_V18 to ops_notif_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_SYSTEM_V18 to ops_notif_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> 
15:21:33 SQL> grant execute on CORE_OWNER.PUBLIC_PROCS_CLIENT_V18 to core_licensing_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PUBLIC_PROCS_CLIENT_V18 to core_billing_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PUBLIC_PROCS_CLIENT_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PUBLIC_PROCS_CLIENT_V18 to cupy_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> 
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_PROCESS_RETRY_V18 to cupy_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_PROCESS_RETRY_V18 to core_owner;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_PROCESS_RETRY_V18 to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_PROCESS_RETRY_V18 to core_billing_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_PROCESS_RETRY_V18 to core_licensing_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_PROCESS_RETRY_V18 to ops_notif_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_PROCESS_RETRY_V18 to etl_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_PROCESS_RETRY_V18 to core_subup_app;

Grant succeeded.

Elapsed: 00:00:00.02
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_PROCESS_RETRY_V18 to core_poller_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant execute on CORE_OWNER.PROCS_PROCESS_RETRY_V18 to core_subup_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> 
15:21:33 SQL> grant select on CORE_OWNER.PROCESS_RETRY_THROTTLE to cupy_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant select on CORE_OWNER.PROCESS_RETRY_THROTTLE to core_owner;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant select on CORE_OWNER.PROCESS_RETRY_THROTTLE to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant select on CORE_OWNER.PROCESS_RETRY_THROTTLE to core_billing_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant select on CORE_OWNER.PROCESS_RETRY_THROTTLE to core_licensing_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant select on CORE_OWNER.PROCESS_RETRY_THROTTLE to core_subup_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> 
15:21:33 SQL> grant select on CORE_OWNER.NOTIFICATION_TYPE to cupy_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant select on CORE_OWNER.NOTIFICATION_TYPE to core_owner;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant select on CORE_OWNER.NOTIFICATION_TYPE to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant select on CORE_OWNER.NOTIFICATION_TYPE to core_billing_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant select on CORE_OWNER.NOTIFICATION_TYPE to core_licensing_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> 
15:21:33 SQL> grant REFERENCES on CORE_OWNER.NOTIFICATION_TYPE to cupy_app;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> grant REFERENCES on CORE_OWNER.NOTIFICATION_TYPE to core_owner;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant REFERENCES on CORE_OWNER.NOTIFICATION_TYPE to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant REFERENCES on CORE_OWNER.NOTIFICATION_TYPE to core_billing_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant REFERENCES on CORE_OWNER.NOTIFICATION_TYPE to core_licensing_app;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> 
15:21:33 SQL> grant select, insert, update, delete ON CORE_OWNER.NOTIFICATION_TYPE to core_owner;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> grant select ON CORE_OWNER.NOTTID_SEQ to core_owner;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> 
15:21:33 SQL> Grant Execute On Core_Owner.App_Exception_Codes_V18 To Ops_Owner;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> Grant Execute On Core_Owner.App_Exception_Codes_V18 To Core_Hist_Owner;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> 
15:21:33 SQL> Grant Execute On Core_Owner.GLOBAL_ENUMS_V18 To Ops_Owner;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> Grant Execute On Core_Owner.GLOBAL_ENUMS_V18 To Core_Hist_Owner;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> 
15:21:33 SQL> Grant Execute On Core_Owner.Global_Statuses_V18 To Ops_Owner;

Grant succeeded.

Elapsed: 00:00:00.01
15:21:33 SQL> Grant Execute On Core_Owner.Global_Statuses_V18 To Core_Hist_Owner;

Grant succeeded.

Elapsed: 00:00:00.00
15:21:33 SQL> 
15:21:33 SQL> commit;

Commit complete.

Elapsed: 00:00:00.00
15:21:33 SQL> spool off;


Subject: Nomad upgrade completed successfully: ECPR@rac01.prd.ewr1.nytimes.com
From: Nomad for Oracle <nytd_oracledba@nytimes.com>
To: nytd_ecommerce@nytimes.com
Cc: nytd_oracledba@nytimes.com

Nomad upgrade operation completed successfully without errors. 
        
        Details
        -------
        DB Hostname: rac01.prd.ewr1.nytimes.com
        DB Role: PRIMARY
        SID: ECPR
        Schema: core_owner
        Migration: 30.2-release-1.13.0-3-CORE-all
        SVN Revision: 11663
        Duration: 6 sec.
        DBA: sbao
        Service Request: https://jira.em.nytimes.com/browse/ORA-557