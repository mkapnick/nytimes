14:33:48 SQL> @/dbbackups/ECPR/migrations/core_owner/58.4-release-1.16.0-3-CORE-all.sql/upgrade.sql
14:33:48 SQL> 
14:33:48 SQL> .
14:33:48 SQL> /
SP2-0103: Nothing in SQL buffer to run.
14:33:48 SQL> 
14:33:48 SQL> --------------------------------------------------------------------------------
14:33:48 SQL> -- DDL for package PROCS_ACCOUNT
14:33:48 SQL> --------------------------------------------------------------------------------
14:33:48 SQL> 
14:33:48 SQL> CREATE OR REPLACE PACKAGE "PROCS_ACCOUNT_V22" AS
14:33:48   2  
14:33:48   3  FUNCTION GET_GRACE_START_DATE(
14:33:48   4  	in_subscription_id IN NUMBER
14:33:48   5  ) RETURN DATE;
14:33:48   6  
14:33:48   7  FUNCTION GET_GRACE_END_DATE(
14:33:48   8  	in_subscription_id IN NUMBER
14:33:48   9  ) RETURN DATE;
14:33:48  10  
14:33:48  11  PROCEDURE INVOICE_IDS_BY_GROUP_ID (
14:33:48  12  	in_group_id    IN  NUMBER,
14:33:48  13  	out_result_set OUT SYS_REFCURSOR
14:33:48  14  );
14:33:48  15  
14:33:48  16  PROCEDURE ANNOTATE_ACCOUNT (
14:33:48  17  	in_group_id   IN  NUMBER,
14:33:48  18  	in_agent_id   IN  NUMBER,
14:33:48  19  	in_note       IN  VARCHAR2,
14:33:48  20  	in_created_by IN  VARCHAR2
14:33:48  21  );
14:33:48  22  
14:33:48  23  PROCEDURE ASSERT_ACCOUNT_EXISTS (
14:33:48  24  	in_group_id IN	NUMBER,
14:33:48  25  	out_exists  OUT NUMBER
14:33:48  26  );
14:33:48  27  
14:33:48  28  PROCEDURE DISABLE_ACCOUNT (
14:33:48  29  	in_group_id   IN NUMBER,
14:33:48  30  	in_updated_by IN VARCHAR2,
14:33:48  31  	in_note       IN VARCHAR2,
14:33:48  32  	in_agent_id   IN NUMBER
14:33:48  33  );
14:33:48  34  
14:33:48  35  PROCEDURE CREATE_ACTIVE_ACCOUNT(
14:33:48  36  	in_group_id	   IN  ACCOUNT.GROUP_ID%TYPE,
14:33:48  37  	in_created_by	   IN  ACCOUNT.CREATED_BY%TYPE,
14:33:48  38  	out_new_account_id OUT ACCOUNT.ID%TYPE
14:33:48  39  );
14:33:48  40  
14:33:48  41  PROCEDURE REACTIVATE_ACCOUNT (
14:33:48  42  	in_group_id	  IN NUMBER,
14:33:48  43  	in_updated_by	  IN VARCHAR2,
14:33:48  44  	in_note 	  IN VARCHAR2,
14:33:48  45  	in_agent_id	  IN NUMBER
14:33:48  46  );
14:33:48  47  
14:33:48  48  PROCEDURE GET_ACCOUNT_CREDIT_CARDS (
14:33:48  49  	in_group_id    IN ACCOUNT.GROUP_ID%TYPE,
14:33:48  50  	in_status_id   IN CREDIT_CARD.CREDIT_CARD_STATUS_ID%TYPE DEFAULT GLOBAL_STATUSES_V22.CREDIT_CARD_ACTIVE,
14:33:48  51  	out_result_set OUT SYS_REFCURSOR
14:33:48  52  );
14:33:48  53  
14:33:48  54  PROCEDURE GET_ACCOUNT_GIFT_CERTIFICATES (
14:33:48  55  	in_group_id	  IN NUMBER,
14:33:48  56  	out_result_gc_set OUT SYS_REFCURSOR,
14:33:48  57  	in_instr_status   IN NUMBER DEFAULT GLOBAL_CONSTANTS_V22.TRUE
14:33:48  58  );
14:33:48  59  
14:33:48  60  PROCEDURE GET_ACCOUNT_INFO  (
14:33:48  61  	  in_group_id	    IN	NUMBER,
14:33:48  62  	  out_account_info  OUT SYS_REFCURSOR
14:33:48  63  );
14:33:48  64  
14:33:48  65  PROCEDURE GET_ACCOUNT_NOTES (
14:33:48  66  	  in_group_id	 IN  NUMBER,
14:33:48  67  	  out_result_set OUT SYS_REFCURSOR
14:33:48  68  );
14:33:48  69  
14:33:48  70  PROCEDURE GET_ACCOUNT_PAYPALS(
14:33:48  71  	in_group_id    IN  ACCOUNT.GROUP_ID%TYPE,
14:33:48  72  	in_status_id   IN  PAYPAL.PAYPAL_STATUS_ID%TYPE DEFAULT GLOBAL_STATUSES_V22.PAYPAL_ACTIVE,
14:33:48  73  	out_result_set OUT SYS_REFCURSOR
14:33:48  74  );
14:33:48  75  
14:33:48  76  PROCEDURE GET_ACCOUNT_SUBSCRIPTIONS (
14:33:48  77  	  in_group_id	 IN  NUMBER,
14:33:48  78  	  in_start_date  IN DATE,
14:33:48  79  	  in_end_date	 IN DATE,
14:33:48  80  	  in_status	 IN NUMBER,
14:33:48  81  	  in_group_account_type IN VARCHAR2,
14:33:48  82  	  out_result_set  OUT SYS_REFCURSOR
14:33:48  83  );
14:33:48  84  
14:33:48  85  PROCEDURE FREEZE_ACCOUNT (
14:33:48  86  	in_group_id   IN NUMBER,
14:33:48  87  	in_updated_by IN VARCHAR2,
14:33:48  88  	in_note       IN VARCHAR2,
14:33:48  89  	in_agent_id   IN NUMBER
14:33:48  90  );
14:33:48  91  
14:33:48  92  PROCEDURE GET_ACCOUNT_SUBSCR_INVOICES (
14:33:48  93  	in_group_id	   IN  NUMBER,
14:33:48  94  	in_subscription_id IN NUMBER,
14:33:48  95  	out_result_set	   OUT SYS_REFCURSOR
14:33:48  96  );
14:33:48  97  
14:33:48  98  PROCEDURE GET_ACCOUNT_GC_INVOICES (
14:33:48  99  	in_group_id    IN  NUMBER,
14:33:48 100  	out_result_set OUT SYS_REFCURSOR
14:33:48 101  );
14:33:48 102  
14:33:48 103  PROCEDURE GET_GC_INVOICE (
14:33:48 104  	in_group_id    IN  NUMBER,
14:33:48 105  	in_gc_code     IN  VARCHAR2,
14:33:48 106  	out_result_set OUT SYS_REFCURSOR
14:33:48 107  );
14:33:48 108  
14:33:48 109  PROCEDURE GET_ACCOUNT_PRODUCTS (
14:33:48 110  	in_group_id    IN  NUMBER,
14:33:48 111  	out_result_set OUT SYS_REFCURSOR
14:33:48 112  );
14:33:48 113  
14:33:48 114  PROCEDURE GET_ACCOUNT_PROD_OFFERRINGS (
14:33:48 115  	in_group_id IN NUMBER,
14:33:48 116  	out_result_set	   OUT SYS_REFCURSOR
14:33:48 117  );
14:33:48 118  
14:33:48 119  PROCEDURE UPDATE_ACCOUNT_STATUS (
14:33:48 120  	in_account_id	     IN ACCOUNT.ID%TYPE,
14:33:48 121  	in_account_status_id IN ACCOUNT.ACCOUNT_STATUS_ID%TYPE,
14:33:48 122  	in_updated_by	     IN ACCOUNT.UPDATED_BY%TYPE
14:33:48 123  );
14:33:48 124  
14:33:48 125  PROCEDURE GET_NEEDS_ENTTL_LICENSES_NUM (
14:33:48 126  	in_group_id	 IN ACCOUNT.GROUP_ID%TYPE,
14:33:48 127  	out_licenses_num OUT NUMBER
14:33:48 128  );
14:33:48 129  
14:33:48 130  PROCEDURE SET_TAX_EXEMPT (
14:33:48 131  	in_group_id  IN NUMBER,
14:33:48 132  	in_exempt_id IN VARCHAR2
14:33:48 133  );
14:33:48 134  
14:33:48 135  PROCEDURE IS_TAX_EXEMPT (
14:33:48 136  	in_group_id	  IN NUMBER,
14:33:48 137  	out_is_tax_exempt OUT NUMBER
14:33:48 138  );
14:33:48 139  
14:33:48 140  PROCEDURE GET_GROUP_ID_BY_ACCOUNT_ID (
14:33:48 141  	in_account_id IN NUMBER,
14:33:48 142  	out_group_id  OUT NUMBER
14:33:48 143  );
14:33:48 144  
14:33:48 145  PROCEDURE GET_ACCOUNT_ID_BY_GROUP_ID (
14:33:48 146  	in_group_id IN NUMBER,
14:33:48 147  	out_account_id	OUT NUMBER
14:33:48 148  );
14:33:48 149  
14:33:48 150  PROCEDURE GET_GROUPS_ID_BY_INVOICE_ID (
14:33:48 151  	in_invoice_id IN NUMBER,
14:33:48 152  	out_group_ids OUT SYS_REFCURSOR
14:33:48 153  );
14:33:48 154  
14:33:48 155  PROCEDURE GET_ACCOUNT_TAX_EXEMPT_ID (
14:33:48 156  	in_group_id	  IN NUMBER,
14:33:48 157  	out_tax_exempt_id OUT VARCHAR2
14:33:48 158  );
14:33:48 159  
14:33:48 160  PROCEDURE GET_UPGRADABLE_SUBSCRIPTIONS (
14:33:48 161  	in_group_id    IN NUMBER,
14:33:48 162  	out_result_set OUT SYS_REFCURSOR
14:33:48 163  );
14:33:48 164  
14:33:48 165  PROCEDURE GET_USR_ALL_SBSCR_IDS (
14:33:48 166  	in_group_id	   IN NUMBER,
14:33:48 167  	out_result_set	   OUT SYS_REFCURSOR
14:33:48 168  );
14:33:48 169  
14:33:48 170  PROCEDURE GET_USR_SBSCR_IDS_BY_OFFCH_IDS (
14:33:48 171  	in_group_id	   IN NUMBER,
14:33:48 172  	in_offer_chain_ids IN core_owner.NUMBER_TABLE,
14:33:48 173  	out_result_set	   OUT SYS_REFCURSOR
14:33:48 174  );
14:33:48 175  
14:33:48 176  PROCEDURE GET_GROUP_IDS_BY_CC_INFO (
14:33:48 177  	in_last_four_cc IN CREDIT_CARD.LAST_FOUR_CC%TYPE,
14:33:48 178  	in_expiration_date IN DATE,
14:33:48 179  	in_country IN CREDIT_CARD.COUNTRY%TYPE DEFAULT NULL,
14:33:48 180  	in_postal_code IN CREDIT_CARD.POSTAL_CODE%TYPE DEFAULT NULL,
14:33:48 181  	in_city IN CREDIT_CARD.CITY%TYPE DEFAULT NULL,
14:33:48 182  	in_state IN CREDIT_CARD.STATE%TYPE DEFAULT NULL,
14:33:48 183  	in_credit_card_type_id IN CREDIT_CARD.CREDIT_CARD_TYPE_ID%TYPE DEFAULT NULL,
14:33:48 184  	in_credit_card_status_id IN CREDIT_CARD.CREDIT_CARD_STATUS_ID%TYPE DEFAULT NULL,
14:33:48 185  	in_lower_bound IN NUMBER DEFAULT 1,
14:33:48 186  	in_upper_bound IN NUMBER DEFAULT 11,
14:33:48 187  	out_result_set OUT SYS_REFCURSOR
14:33:48 188  );
14:33:48 189  
14:33:48 190  END PROCS_ACCOUNT_V22;
14:33:48 191  .
14:33:48 SQL> /

Package created.

Elapsed: 00:00:00.25
14:33:49 SQL> 
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> -- DDL for package PROCS_ACCOUNT_CRU
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> 
14:33:49 SQL> CREATE OR REPLACE PACKAGE "PROCS_ACCOUNT_CRU_V22" AS
14:33:49   2  
14:33:49   3  PROCEDURE CREATE_ACCOUNT (
14:33:49   4  	out_account_id	      OUT ACCOUNT.ID%TYPE,
14:33:49   5  	in_account_status_id  IN ACCOUNT.ACCOUNT_STATUS_ID%TYPE,
14:33:49   6  	in_suspend_date       IN ACCOUNT.SUSPEND_DATE%TYPE DEFAULT NULL,
14:33:49   7  	in_group_id	      IN ACCOUNT.GROUP_ID%TYPE,
14:33:49   8  	in_created_by	      IN ACCOUNT.CREATED_BY%TYPE,
14:33:49   9  	in_system_category_id IN ACCOUNT.SYSTEM_CATEGORY_ID%TYPE,
14:33:49  10  	in_instrument_type_id IN ACCOUNT.INSTRUMENT_TYPE_ID%TYPE DEFAULT NULL,
14:33:49  11  	in_instrument_id      IN ACCOUNT.INSTRUMENT_ID%TYPE DEFAULT NULL
14:33:49  12  );
14:33:49  13  
14:33:49  14  PROCEDURE UPDATE_ACCOUNT (
14:33:49  15  	in_account_id	      IN ACCOUNT.ID%TYPE,
14:33:49  16  	in_account_status_id  IN ACCOUNT.ACCOUNT_STATUS_ID%TYPE DEFAULT NULL,
14:33:49  17  	in_suspend_date       IN ACCOUNT.SUSPEND_DATE%TYPE DEFAULT NULL,
14:33:49  18  	in_updated_by	      IN ACCOUNT.UPDATED_BY%TYPE,
14:33:49  19  	in_system_category_id IN ACCOUNT.SYSTEM_CATEGORY_ID%TYPE DEFAULT NULL,
14:33:49  20  	in_instrument_type_id IN ACCOUNT.INSTRUMENT_TYPE_ID%TYPE DEFAULT NULL,
14:33:49  21  	in_instrument_id      IN ACCOUNT.INSTRUMENT_ID%TYPE DEFAULT NULL
14:33:49  22  );
14:33:49  23  
14:33:49  24  PROCEDURE UPDATE_DEF_FIN_INSTRUMENT(
14:33:49  25  	in_account_id	      IN ACCOUNT.ID%TYPE,
14:33:49  26  	in_instrument_type_id IN ACCOUNT.INSTRUMENT_TYPE_ID%TYPE,
14:33:49  27  	in_instrument_id      IN ACCOUNT.INSTRUMENT_ID%TYPE,
14:33:49  28  	in_updated_by	      IN ACCOUNT.UPDATED_BY%TYPE
14:33:49  29  );
14:33:49  30  
14:33:49  31  PROCEDURE READ_ACCOUNT (
14:33:49  32  	in_account_id  IN ACCOUNT.ID%TYPE,
14:33:49  33  	out_result_set OUT SYS_REFCURSOR
14:33:49  34  );
14:33:49  35  
14:33:49  36  PROCEDURE CREATE_ACCOUNT_NOTE (
14:33:49  37  	inout_account_note_id IN OUT ACCOUNT_NOTE.ID%TYPE,
14:33:49  38  	in_agent_id	      IN ACCOUNT_NOTE.AGENT_ID%TYPE,
14:33:49  39  	in_account_id	      IN ACCOUNT_NOTE.ACCOUNT_ID%TYPE,
14:33:49  40  	in_note 	      IN ACCOUNT_NOTE.NOTE%TYPE,
14:33:49  41  	in_created_by	      IN ACCOUNT_NOTE.CREATED_BY%TYPE
14:33:49  42  );
14:33:49  43  
14:33:49  44  END PROCS_ACCOUNT_CRU_V22;
14:33:49  45  .
14:33:49 SQL> /

Package created.

Elapsed: 00:00:00.05
14:33:49 SQL> 
14:33:49 SQL> CREATE OR REPLACE PACKAGE "PROCS_ADDRESS_V22" AS
14:33:49   2  
14:33:49   3  PROCEDURE CREATE_ADDRESS(
14:33:49   4  /*
14:33:49   5  Throws exceptions:
14:33:49   6  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49   7  */
14:33:49   8  	  out_address_id	OUT NUMBER,
14:33:49   9  	  in_address1		IN ADDRESS.ADDRESS1%TYPE DEFAULT NULL,
14:33:49  10  	  in_address2		IN ADDRESS.ADDRESS2%TYPE DEFAULT NULL,
14:33:49  11  	  in_city		IN ADDRESS.CITY%TYPE DEFAULT NULL,
14:33:49  12  	  in_state		IN ADDRESS.STATE%TYPE DEFAULT NULL,
14:33:49  13  	  in_postal_code	IN ADDRESS.POSTAL_CODE%TYPE DEFAULT NULL,
14:33:49  14  	  in_country		IN ADDRESS.COUNTRY%TYPE DEFAULT NULL,
14:33:49  15  	  in_created_by 	IN ADDRESS.CREATED_BY%TYPE
14:33:49  16  );
14:33:49  17  
14:33:49  18  PROCEDURE UPDATE_ADDRESS(
14:33:49  19  /*
14:33:49  20  Throws exceptions:
14:33:49  21  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  22  */
14:33:49  23  	  in_address_id 	IN ADDRESS.ID%TYPE,
14:33:49  24  	  in_address1		IN ADDRESS.ADDRESS1%TYPE DEFAULT NULL,
14:33:49  25  	  in_address2		IN ADDRESS.ADDRESS2%TYPE DEFAULT NULL,
14:33:49  26  	  in_city		IN ADDRESS.CITY%TYPE DEFAULT NULL,
14:33:49  27  	  in_state		IN ADDRESS.STATE%TYPE DEFAULT NULL,
14:33:49  28  	  in_postal_code	IN ADDRESS.POSTAL_CODE%TYPE DEFAULT NULL,
14:33:49  29  	  in_country		IN ADDRESS.COUNTRY%TYPE DEFAULT NULL,
14:33:49  30  	  in_updated_by 	IN ADDRESS.UPDATED_BY%TYPE
14:33:49  31  );
14:33:49  32  
14:33:49  33  PROCEDURE GET_ADDRESS (
14:33:49  34  /*
14:33:49  35  Throws exceptions:
14:33:49  36  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  37  */
14:33:49  38  	  in_id 		IN ADDRESS.ID%TYPE,
14:33:49  39  	  out_result_set	OUT SYS_REFCURSOR
14:33:49  40  );
14:33:49  41  
14:33:49  42  END PROCS_ADDRESS_V22;
14:33:49  43  .
14:33:49 SQL> /

Package created.

Elapsed: 00:00:00.03
14:33:49 SQL> 
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> -- DDL for package PROCS_ADDRESS_CRU
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> 
14:33:49 SQL> CREATE OR REPLACE PACKAGE "PROCS_ADDRESS_CRU_V22" AS
14:33:49   2  
14:33:49   3  PROCEDURE CREATE_ADDRESS(
14:33:49   4  	out_address_id	      OUT ADDRESS.ID%TYPE,
14:33:49   5  	in_address_id	      IN ADDRESS.ID%TYPE DEFAULT NULL,
14:33:49   6  	in_address1	      IN ADDRESS.ADDRESS1%TYPE DEFAULT NULL,
14:33:49   7  	in_address2	      IN ADDRESS.ADDRESS2%TYPE DEFAULT NULL,
14:33:49   8  	in_city 	      IN ADDRESS.CITY%TYPE DEFAULT NULL,
14:33:49   9  	in_state	      IN ADDRESS.STATE%TYPE DEFAULT NULL,
14:33:49  10  	in_postal_code	      IN ADDRESS.POSTAL_CODE%TYPE DEFAULT NULL,
14:33:49  11  	in_country	      IN ADDRESS.COUNTRY%TYPE DEFAULT NULL,
14:33:49  12  	in_created_by	      IN ADDRESS.CREATED_BY%TYPE
14:33:49  13  );
14:33:49  14  
14:33:49  15  PROCEDURE UPDATE_ADDRESS(
14:33:49  16  	in_address_id	      IN ADDRESS.ID%TYPE,
14:33:49  17  	in_address1	      IN ADDRESS.ADDRESS1%TYPE DEFAULT NULL,
14:33:49  18  	in_address2	      IN ADDRESS.ADDRESS2%TYPE DEFAULT NULL,
14:33:49  19  	in_city 	      IN ADDRESS.CITY%TYPE DEFAULT NULL,
14:33:49  20  	in_state	      IN ADDRESS.STATE%TYPE DEFAULT NULL,
14:33:49  21  	in_postal_code	      IN ADDRESS.POSTAL_CODE%TYPE DEFAULT NULL,
14:33:49  22  	in_country	      IN ADDRESS.COUNTRY%TYPE DEFAULT NULL,
14:33:49  23  	in_updated_by	      IN ADDRESS.UPDATED_BY%TYPE
14:33:49  24  );
14:33:49  25  
14:33:49  26  END PROCS_ADDRESS_CRU_V22;
14:33:49  27  .
14:33:49 SQL> /

Package created.

Elapsed: 00:00:00.03
14:33:49 SQL> 
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> -- DDL for package PROCS_ADJUSTMENTS
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> 
14:33:49 SQL> CREATE OR REPLACE PACKAGE "PROCS_ADJUSTMENTS_V22" AS
14:33:49   2  
14:33:49   3  PROCEDURE CREATE_INVOICE_ADJUSTMENT (
14:33:49   4  	in_invoice_id		  IN NUMBER,
14:33:49   5  	in_adjustment_reason	  IN VARCHAR2,
14:33:49   6  	in_is_credit		  IN NUMBER,
14:33:49   7  	in_charge_id		  IN NUMBER,
14:33:49   8  	in_business_date	  IN DATE,
14:33:49   9  	in_created_by		  IN VARCHAR2,
14:33:49  10  	out_invoice_adjustment_id OUT NUMBER
14:33:49  11  );
14:33:49  12  
14:33:49  13  PROCEDURE UPDATE_INVOICE_ADJUSTMENT (
14:33:49  14  	in_invoice_id		  IN NUMBER,
14:33:49  15  	in_original_charge_id	  IN NUMBER,
14:33:49  16  	in_charge_id		  IN NUMBER,
14:33:49  17  	in_updated_by		  IN VARCHAR2
14:33:49  18  );
14:33:49  19  
14:33:49  20  PROCEDURE CREATE_LINE_ITEM_ADJUSTMENT (
14:33:49  21  	in_line_item_id 	    IN NUMBER,
14:33:49  22  	in_invoice_adjustment_id    IN NUMBER,
14:33:49  23  	in_amount		    IN NUMBER,
14:33:49  24  	in_tax			    IN NUMBER,
14:33:49  25  	in_discount		    IN NUMBER,
14:33:49  26  	in_created_by		    IN VARCHAR2,
14:33:49  27  	out_line_item_adjustment_id OUT NUMBER
14:33:49  28  );
14:33:49  29  
14:33:49  30  PROCEDURE CREATE_TAX_ADJUSTMENT (
14:33:49  31  	in_tax_id		   IN NUMBER,
14:33:49  32  	in_line_item_adjustment_id IN NUMBER,
14:33:49  33  	in_amount		   IN NUMBER,
14:33:49  34  	in_created_by		   IN VARCHAR2,
14:33:49  35  	out_tax_adjustment_id	   OUT NUMBER
14:33:49  36  );
14:33:49  37  
14:33:49  38  PROCEDURE CREATE_DISCOUNT_LI_ADJUSTMENT (
14:33:49  39  	in_discount_id		   NUMBER,
14:33:49  40  	in_line_item_id 	   NUMBER,
14:33:49  41  	in_line_item_adjustment_id IN NUMBER,
14:33:49  42  	in_amount		   IN NUMBER,
14:33:49  43  	in_created_by		   IN VARCHAR2,
14:33:49  44  	out_discount_li_id	   OUT NUMBER
14:33:49  45  );
14:33:49  46  
14:33:49  47  END PROCS_ADJUSTMENTS_V22;
14:33:49  48  .
14:33:49 SQL> /

Package created.

Elapsed: 00:00:00.04
14:33:49 SQL> 
14:33:49 SQL> CREATE OR REPLACE PACKAGE "PROCS_ADX_V22" AS
14:33:49   2  
14:33:49   3  PROCEDURE GET_SUB_ADX_INFO (
14:33:49   4  /*
14:33:49   5  Throws exceptions:
14:33:49   6  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49   7  */
14:33:49   8  	out_result_set	    OUT SYS_REFCURSOR,
14:33:49   9  	in_group_id    IN ACCOUNT.GROUP_ID%TYPE
14:33:49  10  );
14:33:49  11  
14:33:49  12  END PROCS_ADX_V22;
14:33:49  13  .
14:33:49 SQL> /

Package created.

Elapsed: 00:00:00.03
14:33:49 SQL> 
14:33:49 SQL> CREATE OR REPLACE PACKAGE "PROCS_AMAZON_V22" AS
14:33:49   2  
14:33:49   3  PROCEDURE AASR_PURCHASE_TOKEN_USED(
14:33:49   4  	in_purchase_token IN AMAZON_APPSTORE_RECEIPT.PURCHASE_TOKEN%TYPE,
14:33:49   5  	out_data	  OUT NUMBER
14:33:49   6  );
14:33:49   7  
14:33:49   8  PROCEDURE UPDATE_AASR_LAST_CHECK_DATE(
14:33:49   9  	in_id	      IN AMAZON_APPSTORE_RECEIPT.ID%TYPE,
14:33:49  10  	in_updated_by IN AMAZON_APPSTORE_RECEIPT.UPDATED_BY%TYPE
14:33:49  11  );
14:33:49  12  
14:33:49  13  PROCEDURE EXPIRED_AASR_SUB_IDS(
14:33:49  14  	out_data   OUT SYS_REFCURSOR
14:33:49  15  );
14:33:49  16  
14:33:49  17  PROCEDURE UPDATE_AASR_PURCHASE_TOKEN(
14:33:49  18  	in_id		  IN AMAZON_APPSTORE_RECEIPT.ID%TYPE,
14:33:49  19  	in_purchase_token IN AMAZON_APPSTORE_RECEIPT.PURCHASE_TOKEN%TYPE,
14:33:49  20  	in_updated_by	  IN AMAZON_APPSTORE_RECEIPT.UPDATED_BY%TYPE
14:33:49  21  );
14:33:49  22  
14:33:49  23  PROCEDURE UPDATE_AASR_END_DATE(
14:33:49  24  	in_id	      IN AMAZON_APPSTORE_RECEIPT.ID%TYPE,
14:33:49  25  	in_end_date   IN AMAZON_APPSTORE_RECEIPT.END_DATE%TYPE,
14:33:49  26  	in_updated_by IN AMAZON_APPSTORE_RECEIPT.UPDATED_BY%TYPE
14:33:49  27  );
14:33:49  28  
14:33:49  29  PROCEDURE AASR_RECEIPTS_WITH_ACTIVE_SUBS(
14:33:49  30  	out_data   OUT SYS_REFCURSOR,
14:33:49  31  	in_process_name IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE
14:33:49  32  );
14:33:49  33  
14:33:49  34  PROCEDURE ADD_AMAZON_APPSTORE_RECEIPT(
14:33:49  35  	in_subscription_id IN AMAZON_APPSTORE_RECEIPT.SUBSCRIPTION_ID%TYPE,
14:33:49  36  	in_user_id	   IN AMAZON_APPSTORE_RECEIPT.USER_ID%TYPE,
14:33:49  37  	in_item_type	   IN AMAZON_APPSTORE_RECEIPT.ITEM_TYPE%TYPE,
14:33:49  38  	in_start_date	   IN AMAZON_APPSTORE_RECEIPT.START_DATE%TYPE,
14:33:49  39  	in_end_date	   IN AMAZON_APPSTORE_RECEIPT.END_DATE%TYPE DEFAULT NULL,
14:33:49  40  	in_sku		   IN AMAZON_APPSTORE_RECEIPT.SKU%TYPE,
14:33:49  41  	in_purchase_token  IN AMAZON_APPSTORE_RECEIPT.PURCHASE_TOKEN%TYPE,
14:33:49  42  	in_created_by	   IN AMAZON_APPSTORE_RECEIPT.CREATED_BY%TYPE
14:33:49  43  );
14:33:49  44  
14:33:49  45  PROCEDURE AMAZON_APPSTORE_RECEIPTS(
14:33:49  46  	in_user_id IN AMAZON_APPSTORE_RECEIPT.USER_ID%TYPE,
14:33:49  47  	in_sku	   IN AMAZON_APPSTORE_RECEIPT.SKU%TYPE,
14:33:49  48  	out_data   OUT SYS_REFCURSOR
14:33:49  49  );
14:33:49  50  
14:33:49  51  PROCEDURE CREATE_AMAZON_SUB(
14:33:49  52  	  out_id	      OUT NUMBER,
14:33:49  53  	  in_subscription_id  IN AMAZON_SUB.SUBSCRIPTION_ID%TYPE,
14:33:49  54  	  in_amazon_id	      IN AMAZON_SUB.AMAZON_ID%TYPE,
14:33:49  55  	  in_created_by       IN AMAZON_SUB.CREATED_BY%TYPE
14:33:49  56  );
14:33:49  57  
14:33:49  58  PROCEDURE GET_ACTIVE_SUB_IDS (
14:33:49  59  	out_result_set	    OUT SYS_REFCURSOR,
14:33:49  60  	in_amazon_id	IN AMAZON_SUB.AMAZON_ID%TYPE
14:33:49  61  );
14:33:49  62  
14:33:49  63  PROCEDURE GET_ACTIVE_GROUP_IDS (
14:33:49  64  	out_result_set	    OUT SYS_REFCURSOR,
14:33:49  65  	in_amazon_id	IN AMAZON_SUB.AMAZON_ID%TYPE
14:33:49  66  );
14:33:49  67  
14:33:49  68  END PROCS_AMAZON_V22;
14:33:49  69  .
14:33:49 SQL> /

Package created.

Elapsed: 00:00:00.04
14:33:49 SQL> 
14:33:49 SQL> CREATE OR REPLACE PACKAGE "PROCS_AMAZON_CRU_V22" AS
14:33:49   2  
14:33:49   3  PROCEDURE UPDATE_AMAZON_APPSTORE_RECEIPT(
14:33:49   4  	in_id		   IN AMAZON_APPSTORE_RECEIPT.ID%TYPE,
14:33:49   5  	in_updated_by	   IN AMAZON_APPSTORE_RECEIPT.UPDATED_BY%TYPE,
14:33:49   6  	in_subscription_id IN AMAZON_APPSTORE_RECEIPT.SUBSCRIPTION_ID%TYPE DEFAULT NULL,
14:33:49   7  	in_user_id	   IN AMAZON_APPSTORE_RECEIPT.USER_ID%TYPE DEFAULT NULL,
14:33:49   8  	in_item_type	   IN AMAZON_APPSTORE_RECEIPT.ITEM_TYPE%TYPE DEFAULT NULL,
14:33:49   9  	in_start_date	   IN AMAZON_APPSTORE_RECEIPT.START_DATE%TYPE DEFAULT NULL,
14:33:49  10  	in_end_date	   IN AMAZON_APPSTORE_RECEIPT.END_DATE%TYPE DEFAULT NULL,
14:33:49  11  	in_sku		   IN AMAZON_APPSTORE_RECEIPT.SKU%TYPE DEFAULT NULL,
14:33:49  12  	in_purchase_token  IN AMAZON_APPSTORE_RECEIPT.PURCHASE_TOKEN%TYPE DEFAULT NULL,
14:33:49  13  	in_last_check_date IN AMAZON_APPSTORE_RECEIPT.LAST_CHECK_DATE%TYPE DEFAULT NULL
14:33:49  14  );
14:33:49  15  
14:33:49  16  PROCEDURE ADD_AMAZON_APPSTORE_RECEIPT(
14:33:49  17  	in_subscription_id IN AMAZON_APPSTORE_RECEIPT.SUBSCRIPTION_ID%TYPE,
14:33:49  18  	in_user_id	   IN AMAZON_APPSTORE_RECEIPT.USER_ID%TYPE,
14:33:49  19  	in_item_type	   IN AMAZON_APPSTORE_RECEIPT.ITEM_TYPE%TYPE,
14:33:49  20  	in_start_date	   IN AMAZON_APPSTORE_RECEIPT.START_DATE%TYPE,
14:33:49  21  	in_end_date	   IN AMAZON_APPSTORE_RECEIPT.END_DATE%TYPE DEFAULT NULL,
14:33:49  22  	in_sku		   IN AMAZON_APPSTORE_RECEIPT.SKU%TYPE,
14:33:49  23  	in_purchase_token  IN AMAZON_APPSTORE_RECEIPT.PURCHASE_TOKEN%TYPE,
14:33:49  24  	in_created_by	   IN AMAZON_APPSTORE_RECEIPT.CREATED_BY%TYPE
14:33:49  25  );
14:33:49  26  
14:33:49  27  PROCEDURE CREATE_AMAZON_SUB(
14:33:49  28  	  out_id	      OUT NUMBER,
14:33:49  29  	  in_subscription_id  IN AMAZON_SUB.SUBSCRIPTION_ID%TYPE,
14:33:49  30  	  in_amazon_id	      IN AMAZON_SUB.AMAZON_ID%TYPE,
14:33:49  31  	  in_created_by       IN AMAZON_SUB.CREATED_BY%TYPE
14:33:49  32  );
14:33:49  33  
14:33:49  34  END PROCS_AMAZON_CRU_V22;
14:33:49  35  .
14:33:49 SQL> /

Package created.

Elapsed: 00:00:00.02
14:33:49 SQL> 
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> -- DDL for package PROCS_CHARGE
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> 
14:33:49 SQL> CREATE OR REPLACE PACKAGE "PROCS_CHARGE_V22" AS
14:33:49   2  
14:33:49   3  PROCEDURE CREATE_CHARGE(
14:33:49   4  /*
14:33:49   5  Throws exceptions:
14:33:49   6  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:49   7  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49   8  */
14:33:49   9  	in_invoice_id	      IN NUMBER,
14:33:49  10  	in_transaction_id     IN NUMBER,
14:33:49  11  	in_instrument_type_id IN NUMBER,
14:33:49  12  	in_instrument_id      IN NUMBER,
14:33:49  13  	in_charge_amount      IN NUMBER,
14:33:49  14  	in_created_by	      IN VARCHAR2,
14:33:49  15  	in_charge_status_id   IN NUMBER,
14:33:49  16  	out_charge_id	      OUT NUMBER
14:33:49  17  );
14:33:49  18  
14:33:49  19  PROCEDURE GET_PENDING_REFUND_CHARGES (
14:33:49  20  /*
14:33:49  21  Throws exceptions:
14:33:49  22  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  23  */
14:33:49  24  	out_result_set	    OUT SYS_REFCURSOR,
14:33:49  25  	in_row_number	    IN NUMBER DEFAULT NULL
14:33:49  26  );
14:33:49  27  
14:33:49  28  PROCEDURE GET_UNPROCESSED_CHARGES (
14:33:49  29  /*
14:33:49  30  Throws exceptions:
14:33:49  31  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:49  32  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  33  */
14:33:49  34  	in_invoice_id  IN NUMBER,
14:33:49  35  	out_result_set OUT SYS_REFCURSOR
14:33:49  36  );
14:33:49  37  
14:33:49  38  PROCEDURE GET_PROCESSED_CHARGES (
14:33:49  39  /*
14:33:49  40  Throws exceptions:
14:33:49  41  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:49  42  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  43  */
14:33:49  44  	in_invoice_id  IN NUMBER,
14:33:49  45  	out_result_set OUT SYS_REFCURSOR
14:33:49  46  );
14:33:49  47  
14:33:49  48  PROCEDURE GET_SUBSCR_ID_BY_CHARGE_ID (
14:33:49  49  /*
14:33:49  50  Throws exceptions:
14:33:49  51  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:49  52  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  53  */
14:33:49  54  	in_charge_id	    IN NUMBER,
14:33:49  55  	out_subscription_id OUT NUMBER
14:33:49  56  );
14:33:49  57  
14:33:49  58  PROCEDURE UPDATE_CHARGE_STATUS (
14:33:49  59  /*
14:33:49  60  Throws exceptions:
14:33:49  61  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:49  62  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  63  */
14:33:49  64  	in_charge_id	    IN CHARGE.ID%TYPE,
14:33:49  65  	in_charge_status_id IN CHARGE.CHARGE_STATUS_ID%TYPE,
14:33:49  66  	in_updated_by	    IN CHARGE.UPDATED_BY%TYPE
14:33:49  67  );
14:33:49  68  
14:33:49  69  FUNCTION IS_CHARGE_COLLECTED (
14:33:49  70  /*
14:33:49  71  Throws:
14:33:49  72  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:49  73  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  74  Returns:
14:33:49  75  GLOBAL_CONST.TRUE if transaction collected,
14:33:49  76  GLOBAL_CONST.FALSE else
14:33:49  77  */
14:33:49  78  	in_charge_id IN NUMBER
14:33:49  79  ) RETURN NUMBER;
14:33:49  80  
14:33:49  81  PROCEDURE GET_COLLECTED_CHARGES (
14:33:49  82  /*
14:33:49  83  Throws exceptions:
14:33:49  84  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:49  85  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  86  */
14:33:49  87  	in_invoice_id  IN NUMBER,
14:33:49  88  	out_result_set OUT SYS_REFCURSOR
14:33:49  89  );
14:33:49  90  
14:33:49  91  END PROCS_CHARGE_V22;
14:33:49  92  .
14:33:49 SQL> /

Package created.

Elapsed: 00:00:00.04
14:33:49 SQL> 
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> -- DDL for package PROCS_CHARGE_CRU
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> 
14:33:49 SQL> CREATE OR REPLACE PACKAGE "PROCS_CHARGE_CRU_V22" AS
14:33:49   2  
14:33:49   3  PROCEDURE CREATE_CHARGE(
14:33:49   4  	out_charge_id	      OUT CHARGE.ID%TYPE,
14:33:49   5  	in_charge_id	      IN CHARGE.ID%TYPE DEFAULT NULL,
14:33:49   6  	in_invoice_id	      IN CHARGE.INVOICE_ID%TYPE,
14:33:49   7  	in_transaction_id     IN CHARGE.TRANSACTION_ID%TYPE DEFAULT NULL,
14:33:49   8  	in_instrument_type_id IN CHARGE.INSTRUMENT_TYPE_ID%TYPE,
14:33:49   9  	in_instrument_id      IN CHARGE.INSTRUMENT_ID%TYPE,
14:33:49  10  	in_charge_amount      IN CHARGE.CHARGE_AMOUNT%TYPE,
14:33:49  11  	in_charge_status_id   IN CHARGE.CHARGE_STATUS_ID%TYPE,
14:33:49  12  	in_created_by	      IN CHARGE.CREATED_BY%TYPE
14:33:49  13  );
14:33:49  14  
14:33:49  15  PROCEDURE UPDATE_CHARGE(
14:33:49  16  	in_charge_id	      IN CHARGE.ID%TYPE,
14:33:49  17  	in_instrument_type_id IN CHARGE.INSTRUMENT_TYPE_ID%TYPE DEFAULT NULL,
14:33:49  18  	in_instrument_id      IN CHARGE.INSTRUMENT_ID%TYPE DEFAULT NULL,
14:33:49  19  	in_charge_amount      IN CHARGE.CHARGE_AMOUNT%TYPE DEFAULT NULL,
14:33:49  20  	in_charge_status_id   IN CHARGE.CHARGE_STATUS_ID%TYPE DEFAULT NULL,
14:33:49  21  	in_updated_by	      IN CHARGE.UPDATED_BY%TYPE
14:33:49  22  );
14:33:49  23  
14:33:49  24  END PROCS_CHARGE_CRU_V22;
14:33:49  25  .
14:33:49 SQL> /

Package created.

Elapsed: 00:00:00.02
14:33:49 SQL> 
14:33:49 SQL> CREATE OR REPLACE PACKAGE "PROCS_CUPY" AS
14:33:49   2  
14:33:49   3  	PROCEDURE POPULATE_REQUEST_INFO(
14:33:49   4  	  in_hours_prior    IN	NUMBER,
14:33:49   5  	  in_filename	    IN	CC_REQUEST_FILE.FILE_NAME%TYPE,
14:33:49   6  	  in_creator	    IN	CC_REQUEST_FILE.UPDATED_BY%TYPE
14:33:49   7  	);
14:33:49   8  
14:33:49   9  	PROCEDURE CHASE_PROFILE_BY_REQ_FILE_ID(
14:33:49  10  	  in_request_file_id IN CC_UPDATE.CC_REQUEST_FILE_ID%TYPE,
14:33:49  11  	  in_start	     IN NUMBER,
14:33:49  12  	  in_end	     IN NUMBER,
14:33:49  13  	  out_result_set     OUT SYS_REFCURSOR
14:33:49  14  	);
14:33:49  15  
14:33:49  16  	PROCEDURE UPDATE_REQUEST_FILE_STATUS(
14:33:49  17  	  in_request_file_id IN CC_REQUEST_FILE.ID%TYPE,
14:33:49  18  	  in_status	     IN CC_REQUEST_FILE.CC_REQUEST_FILE_STATUS%TYPE,
14:33:49  19  	  in_updated_by      IN CC_REQUEST_FILE.UPDATED_BY%TYPE
14:33:49  20  	);
14:33:49  21  
14:33:49  22  	PROCEDURE UPDATE_CC_REQUEST_STATUS(
14:33:49  23  	  in_request_file_id IN CC_UPDATE.CC_REQUEST_FILE_ID%TYPE,
14:33:49  24  	  in_status	     IN CC_UPDATE.CC_UPDATE_STATUS%TYPE,
14:33:49  25  	  in_updated_by      IN CC_UPDATE.UPDATED_BY%TYPE
14:33:49  26  	);
14:33:49  27  
14:33:49  28  	PROCEDURE REQUEST_FILES_BY_STATUS (
14:33:49  29  	  in_status	      IN  CC_REQUEST_FILE.CC_REQUEST_FILE_STATUS%TYPE,
14:33:49  30  	  in_older_than_hours IN  NUMBER DEFAULT -288,
14:33:49  31  	  out_request_files   OUT SYS_REFCURSOR
14:33:49  32  	);
14:33:49  33  
14:33:49  34  	PROCEDURE COUNT_BY_REQUEST_FILE_ID (
14:33:49  35  	  in_id     IN	CC_UPDATE.CC_REQUEST_FILE_ID%TYPE,
14:33:49  36  	  out_count OUT NUMBER
14:33:49  37  	);
14:33:49  38  
14:33:49  39  	PROCEDURE GET_CREDIT_CARD_INFO (
14:33:49  40  	  in_chase_profile_id  IN  CREDIT_CARD.CHASE_PROFILE_ID%TYPE,
14:33:49  41  	  in_request_filename  IN  CC_REQUEST_FILE.FILE_NAME%TYPE DEFAULT NULL,
14:33:49  42  	  out_card_info        OUT SYS_REFCURSOR
14:33:49  43  	);
14:33:49  44  
14:33:49  45  	PROCEDURE UPDATE_CC_UPDATE(
14:33:49  46  	  in_id 	     IN CC_UPDATE.ID%TYPE,
14:33:49  47  	  in_status	     IN CC_UPDATE.CC_UPDATE_STATUS%TYPE,
14:33:49  48  	  in_action	     IN CC_UPDATE.CC_UPDATE_ACTION%TYPE DEFAULT NULL,
14:33:49  49  	  in_reason	     IN CC_UPDATE.CC_UPDATE_REASON%TYPE DEFAULT NULL,
14:33:49  50  	  in_response_proc_status_code IN CC_UPDATE.RESPONSE_PROC_STATUS_CODE%TYPE DEFAULT NULL,
14:33:49  51  	  in_response_proc_status_msg  IN CC_UPDATE.RESPONSE_PROC_STATUS_MESSAGE%TYPE DEFAULT NULL,
14:33:49  52  	  in_updated_by      IN CC_UPDATE.UPDATED_BY%TYPE
14:33:49  53  	);
14:33:49  54  
14:33:49  55  	PROCEDURE UPDATE_CC_UPDATE_STATUS(
14:33:49  56  	  in_id 	IN CC_UPDATE.ID%TYPE,
14:33:49  57  	  in_status	IN CC_UPDATE.CC_UPDATE_STATUS%TYPE,
14:33:49  58  	  in_updated_by IN CC_UPDATE.UPDATED_BY%TYPE
14:33:49  59  	);
14:33:49  60  
14:33:49  61  	PROCEDURE GET_REQUEST_FILE_BY_FILENAME (
14:33:49  62  	  in_request_filename  IN  CC_REQUEST_FILE.FILE_NAME%TYPE,
14:33:49  63  	  out_request_file     OUT SYS_REFCURSOR
14:33:49  64  	);
14:33:49  65  
14:33:49  66  	PROCEDURE SUSPEND_CREDIT_CARD (
14:33:49  67  	  in_credit_card_id  IN CREDIT_CARD.ID%TYPE,
14:33:49  68  	  in_updated_by      IN CREDIT_CARD.UPDATED_BY%TYPE
14:33:49  69  	);
14:33:49  70  
14:33:49  71  	PROCEDURE UPDATE_CREDIT_CARD (
14:33:49  72  	  in_credit_card_id   IN CREDIT_CARD.ID%TYPE,
14:33:49  73  	  in_last_four_cc     IN CREDIT_CARD.LAST_FOUR_CC%TYPE,
14:33:49  74  	  in_expiration_date  IN CREDIT_CARD.EXPIRATION_DATE%TYPE,
14:33:49  75  	  in_updated_by       IN CREDIT_CARD.UPDATED_BY%TYPE
14:33:49  76  	);
14:33:49  77  
14:33:49  78  	PROCEDURE COMPLETABLE_REQUESTS (
14:33:49  79  	  out_request_files OUT SYS_REFCURSOR
14:33:49  80  	);
14:33:49  81  
14:33:49  82  	PROCEDURE COMPLETABLE_REQUESTS_W_FAILS (
14:33:49  83  	  in_max_hours_before_report IN  NUMBER,
14:33:49  84  	  out_request_files	     OUT SYS_REFCURSOR
14:33:49  85  	);
14:33:49  86  
14:33:49  87  	PROCEDURE GET_GROUP_ID_BY_ACCOUNT_ID (
14:33:49  88  	  in_account_id IN NUMBER,
14:33:49  89  	  out_group_id	OUT NUMBER
14:33:49  90  	);
14:33:49  91  
14:33:49  92  	PROCEDURE GET_LICENSE_BY_ID (
14:33:49  93  	  in_license_id  IN NUMBER,
14:33:49  94  	  out_result_set OUT SYS_REFCURSOR
14:33:49  95  	);
14:33:49  96  
14:33:49  97  END PROCS_CUPY;
14:33:49  98  .
14:33:49 SQL> /

Package created.

Elapsed: 00:00:00.10
14:33:49 SQL> 
14:33:49 SQL> CREATE OR REPLACE
14:33:49   2  PACKAGE PROCS_ENTITLEMENT_V22 AS
14:33:49   3  
14:33:49   4  PROCEDURE GET_ALL_ENTITLEMENTS(
14:33:49   5  	in_group_id IN NUMBER,
14:33:49   6  	out_result_set OUT SYS_REFCURSOR);
14:33:49   7  
14:33:49   8  PROCEDURE GET_ITUNES_ENTITLEMENTS(
14:33:49   9  	in_product_id IN CORE_OWNER.ITUNES_RECEIPT.PRODUCT_ID%TYPE,
14:33:49  10  	out_result_set OUT SYS_REFCURSOR);
14:33:49  11  
14:33:49  12  PROCEDURE GET_ARCHIVE_ENTITLEMENT_URI(
14:33:49  13  	in_subscription_id IN NUMBER,
14:33:49  14  	out_uri OUT VARCHAR2);
14:33:49  15  
14:33:49  16  END PROCS_ENTITLEMENT_V22;
14:33:49  17  .
14:33:49 SQL> /

Package created.

Elapsed: 00:00:00.02
14:33:49 SQL> 
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> -- DDL for package PROCS_FIN_INSTRUMENTS
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> 
14:33:49 SQL> CREATE OR REPLACE PACKAGE "PROCS_FIN_INSTRUMENTS_V22" AS
14:33:49   2  
14:33:49   3  PROCEDURE UPDATE_GC_STATUS_BY_INVOICE (
14:33:49   4  	  in_invoice_id IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
14:33:49   5  	  in_status_id	IN GIFT_CERTIFICATE_STATUS.ID%TYPE,
14:33:49   6  	  in_updater	IN GIFT_CERTIFICATE.UPDATED_BY%TYPE
14:33:49   7  );
14:33:49   8  
14:33:49   9  PROCEDURE IS_INVOICE_FOR_REDEEMED_GC (
14:33:49  10  	in_invoice_id		     IN NUMBER,
14:33:49  11  	out_is_invoice_for_redeem_gc OUT NUMBER
14:33:49  12  );
14:33:49  13  
14:33:49  14  PROCEDURE GET_UNREDEEMED_GCS (
14:33:49  15  	out_result_set		OUT SYS_REFCURSOR,
14:33:49  16  	in_hours_number 	IN NUMBER DEFAULT 14*24,
14:33:49  17  	in_num_rows		IN NUMBER DEFAULT 10000,
14:33:49  18  	in_process_name 	IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE
14:33:49  19  );
14:33:49  20  
14:33:49  21  PROCEDURE GET_GC_ID_BY_PURCH_INVOICE_ID (
14:33:49  22  in_invoice_id IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
14:33:49  23  out_gift_certificate_id OUT GIFT_CERTIFICATE.ID%TYPE
14:33:49  24  );
14:33:49  25  
14:33:49  26  PROCEDURE ADD_CREDIT_CARD (
14:33:49  27  /*
14:33:49  28  Throws exceptions:
14:33:49  29  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:49  30  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  31  */
14:33:49  32  	in_group_id		  IN NUMBER,
14:33:49  33  	in_updated_by		  IN VARCHAR2,
14:33:49  34  	in_instrument_name	  IN VARCHAR2,
14:33:49  35  	in_card_holder_name	  IN VARCHAR2,
14:33:49  36  	in_street_address	  IN VARCHAR2,
14:33:49  37  	in_street_address2	  IN VARCHAR2,
14:33:49  38  	in_state		  IN VARCHAR2,
14:33:49  39  	in_city 		  IN VARCHAR2,
14:33:49  40  	in_postal_code		  IN VARCHAR2,
14:33:49  41  	in_country		  IN CHAR,
14:33:49  42  	in_last_four_cc 	  IN VARCHAR2,
14:33:49  43  	in_expiration_date	  IN DATE,
14:33:49  44  	in_credit_card_type_id	  IN NUMBER,
14:33:49  45  	in_token		  IN VARCHAR2,
14:33:49  46  	in_chase_profile_id	  IN VARCHAR2,
14:33:49  47  	in_credit_card_status_id  IN NUMBER,
14:33:49  48  	in_private_first_name	  IN VARCHAR2,
14:33:49  49  	in_private_last_name	  IN VARCHAR2,
14:33:49  50  	out_credit_card_id	  OUT NUMBER
14:33:49  51  );
14:33:49  52  
14:33:49  53  /******************************************************************************/
14:33:49  54  
14:33:49  55  PROCEDURE ADD_PAYPAL (
14:33:49  56  /*
14:33:49  57  Throws exceptions:
14:33:49  58  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:49  59  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  60  */
14:33:49  61  	in_group_id			IN NUMBER,
14:33:49  62  	in_instrument_name		IN VARCHAR2,
14:33:49  63  	in_private_email_address	IN VARCHAR2,
14:33:49  64  	in_created_by			IN VARCHAR2,
14:33:49  65  	in_paypal_status_id		IN NUMBER,
14:33:49  66  	in_paypal_prvt_street_address	IN VARCHAR2,
14:33:49  67  	in_paypal_prvt_street_address2	IN VARCHAR2,
14:33:49  68  	in_state			IN VARCHAR2,
14:33:49  69  	in_city 			IN VARCHAR2,
14:33:49  70  	in_postal_code			IN VARCHAR2,
14:33:49  71  	in_country			IN CHAR,
14:33:49  72  	in_expiration_date		IN DATE,
14:33:49  73  	in_secret_token 		IN VARCHAR2,
14:33:49  74  	out_paypal_id			OUT NUMBER
14:33:49  75  );
14:33:49  76  
14:33:49  77  /********************************************/
14:33:49  78  
14:33:49  79  PROCEDURE GET_GIFT_CERTIFICATE_BY_CODE (
14:33:49  80  /*
14:33:49  81  Throws exceptions:
14:33:49  82  APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:49  83  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  84  */
14:33:49  85  	in_code       IN VARCHAR,
14:33:49  86  	out_result_set OUT SYS_REFCURSOR
14:33:49  87  );
14:33:49  88  
14:33:49  89  /********************************************/
14:33:49  90  
14:33:49  91  PROCEDURE GET_GIFT_CERTIFICATE_BY_ID (
14:33:49  92  /*
14:33:49  93  Throws exceptions:
14:33:49  94  APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:49  95  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  96  */
14:33:49  97  	in_gift_certificate_id IN NUMBER,
14:33:49  98  	out_result_set	       OUT SYS_REFCURSOR
14:33:49  99  );
14:33:49 100  
14:33:49 101  /********************************************/
14:33:49 102  
14:33:49 103  PROCEDURE DISABLE_CREDIT_CARD (
14:33:49 104  /*
14:33:49 105  Throws exceptions:
14:33:49 106  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:49 107  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49 108  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:49 109  */
14:33:49 110  	in_credit_card_id IN NUMBER,
14:33:49 111  	in_updated_by	  IN VARCHAR2
14:33:49 112  );
14:33:49 113  
14:33:49 114  /********************************************/
14:33:49 115  
14:33:49 116  PROCEDURE DISABLE_PAYPAL (
14:33:49 117  /*
14:33:49 118  Throws exceptions:
14:33:49 119  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:49 120  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49 121  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:49 122  */
14:33:49 123  	in_paypal_id  IN NUMBER,
14:33:49 124  	in_updated_by IN VARCHAR2
14:33:49 125  );
14:33:49 126  
14:33:49 127  /********************************************/
14:33:49 128  
14:33:49 129  PROCEDURE UPDATE_CREDIT_CARD (
14:33:49 130  /*
14:33:49 131  Throws exceptions:
14:33:49 132  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:49 133  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49 134  */
14:33:49 135  	in_credit_card_id	  IN NUMBER,
14:33:49 136  	in_updated_by		  IN VARCHAR2,
14:33:49 137  	in_instrument_name	  IN VARCHAR2,
14:33:49 138  	in_is_default		  IN NUMBER
14:33:49 139  );
14:33:49 140  
14:33:49 141  /********************************************/
14:33:49 142  
14:33:49 143  PROCEDURE START_GC_PURCHASING (
14:33:49 144  	in_group_id		  IN NUMBER,
14:33:49 145  	in_offer_chain_id	  IN VARCHAR2,
14:33:49 146  	in_gift_certificate_code  IN  VARCHAR2,
14:33:49 147  	in_created_by		  IN  VARCHAR2,
14:33:49 148  	in_recipient_name	  IN  VARCHAR2,
14:33:49 149  	in_recipient_email	  IN  VARCHAR2,
14:33:49 150  	in_recipient_address_id   IN NUMBER,
14:33:49 151  	in_recipient_notify_date  IN DATE,
14:33:49 152  	in_sender_name		  IN VARCHAR2,
14:33:49 153  	in_sender_email 	  IN VARCHAR2,
14:33:49 154  	in_gift_message 	  IN  VARCHAR2,
14:33:49 155  	in_expiration_date	  IN DATE,
14:33:49 156  	in_campaign		  IN VARCHAR2,
14:33:49 157  	in_reference_code	  IN VARCHAR2,
14:33:49 158  	out_gift_certificate_id   OUT NUMBER,
14:33:49 159  	out_invoice_id		  OUT NUMBER
14:33:49 160  );
14:33:49 161  
14:33:49 162  PROCEDURE FINALIZE_GC_PURCHASING (
14:33:49 163  	in_invoice_id	      IN NUMBER,
14:33:49 164  	in_created_by	      IN VARCHAR2,
14:33:49 165  	in_instrument_id      IN NUMBER,
14:33:49 166  	in_instrument_type_id IN NUMBER,
14:33:49 167  	in_order_id	      IN VARCHAR2,
14:33:49 168  	in_transaction_id     IN NUMBER,
14:33:49 169  	out_charge_amount     OUT NUMBER
14:33:49 170  );
14:33:49 171  
14:33:49 172  PROCEDURE PURCHASE_GIFT_CERTIFICATE (
14:33:49 173  	in_group_id	  IN NUMBER,
14:33:49 174  	in_offer_chain_id IN VARCHAR2,
14:33:49 175  	in_gift_certificate_code  IN  VARCHAR2,
14:33:49 176  	in_created_by IN  VARCHAR2,
14:33:49 177  	in_recipient_name IN  VARCHAR2,
14:33:49 178  	in_recipient_email IN  VARCHAR2,
14:33:49 179  	in_sender_name IN VARCHAR2,
14:33:49 180  	in_sender_email IN VARCHAR2,
14:33:49 181  	in_gift_message IN  VARCHAR2,
14:33:49 182  	in_instrument_id  IN  NUMBER,
14:33:49 183  	in_instrument_type_id IN NUMBER,
14:33:49 184  	in_expiration_date IN DATE,
14:33:49 185  	in_order_id IN VARCHAR2,
14:33:49 186  	in_transaction_id IN NUMBER
14:33:49 187  );
14:33:49 188  
14:33:49 189  /*********************************************/
14:33:49 190  
14:33:49 191  PROCEDURE REDEEM_GIFT_CERTIFICATE (
14:33:49 192  	in_group_id			IN NUMBER,
14:33:49 193  	in_gift_certificate_code	IN VARCHAR2,
14:33:49 194  	in_created_by			IN VARCHAR2,
14:33:49 195  	in_redeemer_address_id		IN NUMBER,
14:33:49 196  	in_fin_instrument_id		IN NUMBER,
14:33:49 197  	in_fin_instrument_type_id	IN NUMBER,
14:33:49 198  	in_redemption_offer_chain_id	IN NUMBER,
14:33:49 199  	out_subscription_id		OUT NUMBER,
14:33:49 200  	out_license_id			OUT NUMBER
14:33:49 201  );
14:33:49 202  
14:33:49 203  /********************************************/
14:33:49 204  
14:33:49 205  PROCEDURE GET_DEF_FINANCIAL_INSTRUMENT (
14:33:49 206  	in_group_id	       IN  NUMBER,
14:33:49 207  	out_instrument_type_id OUT NUMBER,
14:33:49 208  	out_instrument_id      OUT NUMBER
14:33:49 209  );
14:33:49 210  
14:33:49 211  /************************************************/
14:33:49 212  
14:33:49 213  PROCEDURE SET_DEF_FINANCIAL_INSTRUMENT (
14:33:49 214  	in_group_id	      IN NUMBER,
14:33:49 215  	in_instrument_type_id IN NUMBER,
14:33:49 216  	in_instrument_id      IN NUMBER,
14:33:49 217  	in_updated_by	      IN VARCHAR2
14:33:49 218  );
14:33:49 219  
14:33:49 220  /***************************************************/
14:33:49 221  
14:33:49 222  PROCEDURE DEL_DEF_FINANCIAL_INSTRUMENT (
14:33:49 223  	in_group_id	      IN NUMBER
14:33:49 224  );
14:33:49 225  
14:33:49 226  /****************************************************/
14:33:49 227  
14:33:49 228  PROCEDURE GET_CREDIT_CARD_BY_ID (
14:33:49 229  	in_credit_card_id IN  NUMBER,
14:33:49 230  	out_result_set	  OUT SYS_REFCURSOR
14:33:49 231  );
14:33:49 232  
14:33:49 233  /****************************************************/
14:33:49 234  
14:33:49 235  PROCEDURE GET_PAYPAL_BY_ID (
14:33:49 236  	in_paypal_id   IN  NUMBER,
14:33:49 237  	out_result_set OUT SYS_REFCURSOR
14:33:49 238  );
14:33:49 239  
14:33:49 240  /***********************************************/
14:33:49 241  
14:33:49 242  FUNCTION F_CAN_DISABLE_CREDIT_CARD (
14:33:49 243  	in_credit_card_id NUMBER
14:33:49 244  ) RETURN NUMBER;
14:33:49 245  
14:33:49 246  /*************************************************/
14:33:49 247  
14:33:49 248  PROCEDURE GET_PURCHASED_GCERTIFICATES (
14:33:49 249  	in_group_id    IN NUMBER,
14:33:49 250  	out_result_set OUT SYS_REFCURSOR
14:33:49 251  );
14:33:49 252  
14:33:49 253  /*************************************************/
14:33:49 254  
14:33:49 255  -- isGiftCertificateForProperOffer
14:33:49 256  
14:33:49 257  PROCEDURE IS_GCERT_FOR_PROPER_OFFER (
14:33:49 258  	in_gift_certificate_id IN NUMBER,
14:33:49 259  	in_charge_id	       IN NUMBER,
14:33:49 260  	out_result	       OUT NUMBER
14:33:49 261  );
14:33:49 262  
14:33:49 263  FUNCTION IS_CREDIT_CARD_EXISTS (
14:33:49 264  /*
14:33:49 265  1 - if instrument exists
14:33:49 266  0 - else
14:33:49 267  */
14:33:49 268  	in_credit_card_id IN NUMBER
14:33:49 269  ) RETURN NUMBER;
14:33:49 270  
14:33:49 271  FUNCTION IS_PAYPAL_EXISTS (
14:33:49 272  /*
14:33:49 273  1 - if instrument exists
14:33:49 274  0 - else
14:33:49 275  */
14:33:49 276  	in_paypal_id IN NUMBER
14:33:49 277  ) RETURN NUMBER;
14:33:49 278  
14:33:49 279  FUNCTION IS_GIFT_CERTIFICATE_EXISTS (
14:33:49 280  /*
14:33:49 281  1 - if instrument exists
14:33:49 282  0 - else
14:33:49 283  */
14:33:49 284  	in_gift_certificate_id IN NUMBER
14:33:49 285  ) RETURN NUMBER;
14:33:49 286  
14:33:49 287  PROCEDURE GET_GROUP_ID_BY_CREDIT_CARD_ID (
14:33:49 288  	in_credit_card_id IN NUMBER,
14:33:49 289  	out_group_id	  OUT NUMBER
14:33:49 290  );
14:33:49 291  
14:33:49 292  PROCEDURE GET_GROUP_ID_BY_PAYPAL_ID (
14:33:49 293  	in_paypal_id IN NUMBER,
14:33:49 294  	out_group_id	  OUT NUMBER
14:33:49 295  );
14:33:49 296  
14:33:49 297  PROCEDURE GET_EXPIRING_PAYPAL (
14:33:49 298  	in_expire_window_days	IN NUMBER,
14:33:49 299  	in_creation_limit_days	IN NUMBER,
14:33:49 300  	in_retry_throttle_name	PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE,
14:33:49 301  	out_result_set		OUT SYS_REFCURSOR
14:33:49 302  );
14:33:49 303  
14:33:49 304  PROCEDURE UPDATE_CREDIT_CARD_STATUS (
14:33:49 305  	in_credit_card_id	 IN CREDIT_CARD.ID%TYPE,
14:33:49 306  	in_credit_card_status_id IN CREDIT_CARD.CREDIT_CARD_STATUS_ID%TYPE,
14:33:49 307  	in_updated_by		 IN CREDIT_CARD.UPDATED_BY%TYPE
14:33:49 308  );
14:33:49 309  
14:33:49 310  PROCEDURE UPDATE_PAYPAL_STATUS (
14:33:49 311  	in_paypal_id	    IN PAYPAL.ID%TYPE,
14:33:49 312  	in_paypal_status_id IN PAYPAL.PAYPAL_STATUS_ID%TYPE,
14:33:49 313  	in_updated_by	    IN PAYPAL.UPDATED_BY%TYPE
14:33:49 314  );
14:33:49 315  
14:33:49 316  PROCEDURE UPDATE_GIFT_CERTIFICATE_STATUS (
14:33:49 317  	in_gift_certificate_id	      IN GIFT_CERTIFICATE.ID%TYPE,
14:33:49 318  	in_gift_certificate_status_id IN GIFT_CERTIFICATE.GIFT_CERTIFICATE_STATUS_ID%TYPE,
14:33:49 319  	in_updated_by		      IN GIFT_CERTIFICATE.UPDATED_BY%TYPE
14:33:49 320  );
14:33:49 321  
14:33:49 322  PROCEDURE GET_GC_BY_PURCH_INVOICE_ID (
14:33:49 323  	in_invoice_id		IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
14:33:49 324  	out_result_set OUT SYS_REFCURSOR
14:33:49 325  );
14:33:49 326  
14:33:49 327  PROCEDURE SWITCH_FINANCIAL_INSTRUMENT (
14:33:49 328  	/*in_group_id		     IN NUMBER	-- TODO: should we pass group_id here?*/
14:33:49 329  	in_old_fin_instrument_id   IN NUMBER,
14:33:49 330  	in_old_fin_instrument_type IN NUMBER,
14:33:49 331  	in_new_fin_instrument_id   IN NUMBER,
14:33:49 332  	in_new_fin_instrument_type IN NUMBER,
14:33:49 333  	in_updated_by		   IN VARCHAR2
14:33:49 334  );
14:33:49 335  
14:33:49 336  END PROCS_FIN_INSTRUMENTS_V22;
14:33:49 337  .
14:33:49 SQL> /

Package created.

Elapsed: 00:00:00.06
14:33:49 SQL> 
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> -- DDL for package PROCS_FIN_INSTRUMENTS_CRU
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> 
14:33:49 SQL> CREATE OR REPLACE PACKAGE "PROCS_FIN_INSTRUMENTS_CRU_V22" AS
14:33:49   2  
14:33:49   3  PROCEDURE CREATE_CREDIT_CARD(
14:33:49   4  	out_credit_card_id	    OUT CREDIT_CARD.ID%TYPE,
14:33:49   5  	in_credit_card_id	    IN CREDIT_CARD.ID%TYPE DEFAULT NULL,
14:33:49   6  	in_account_id		    IN CREDIT_CARD.ACCOUNT_ID%TYPE,
14:33:49   7  	in_instrument_name	    IN CREDIT_CARD.INSTRUMENT_NAME%TYPE,
14:33:49   8  	in_private_card_holder_name IN CREDIT_CARD.PRIVATE_CARD_HOLDER_NAME%TYPE,
14:33:49   9  	in_private_street_address   IN CREDIT_CARD.PRIVATE_STREET_ADDRESS%TYPE,
14:33:49  10  	in_private_street_address2  IN CREDIT_CARD.PRIVATE_STREET_ADDRESS2%TYPE DEFAULT NULL,
14:33:49  11  	in_state		    IN CREDIT_CARD.STATE%TYPE,
14:33:49  12  	in_city 		    IN CREDIT_CARD.CITY%TYPE,
14:33:49  13  	in_postal_code		    IN CREDIT_CARD.POSTAL_CODE%TYPE,
14:33:49  14  	in_country		    IN CREDIT_CARD.COUNTRY%TYPE,
14:33:49  15  	in_last_four_cc 	    IN CREDIT_CARD.LAST_FOUR_CC%TYPE,
14:33:49  16  	in_expiration_date	    IN CREDIT_CARD.EXPIRATION_DATE%TYPE,
14:33:49  17  	in_credit_card_type_id	    IN CREDIT_CARD.CREDIT_CARD_TYPE_ID%TYPE,
14:33:49  18  	in_secret_token 	    IN CREDIT_CARD.SECRET_TOKEN%TYPE,
14:33:49  19  	in_chase_profile_id	    IN CREDIT_CARD.CHASE_PROFILE_ID%TYPE,
14:33:49  20  	in_created_by		    IN CREDIT_CARD.CREATED_BY%TYPE,
14:33:49  21  	in_credit_card_status_id    IN CREDIT_CARD.CREDIT_CARD_STATUS_ID%TYPE,
14:33:49  22  	in_private_first_name	    IN CREDIT_CARD.PRIVATE_FIRST_NAME%TYPE,
14:33:49  23  	in_private_last_name	    IN CREDIT_CARD.PRIVATE_LAST_NAME%TYPE
14:33:49  24  );
14:33:49  25  
14:33:49  26  PROCEDURE UPDATE_CREDIT_CARD(
14:33:49  27  	in_credit_card_id	    IN CREDIT_CARD.ID%TYPE,
14:33:49  28  	in_instrument_name	    IN CREDIT_CARD.INSTRUMENT_NAME%TYPE DEFAULT NULL,
14:33:49  29  	in_private_card_holder_name IN CREDIT_CARD.PRIVATE_CARD_HOLDER_NAME%TYPE DEFAULT NULL,
14:33:49  30  	in_private_street_address   IN CREDIT_CARD.PRIVATE_STREET_ADDRESS%TYPE DEFAULT NULL,
14:33:49  31  	in_private_street_address2  IN CREDIT_CARD.PRIVATE_STREET_ADDRESS2%TYPE DEFAULT NULL,
14:33:49  32  	in_state		    IN CREDIT_CARD.STATE%TYPE DEFAULT NULL,
14:33:49  33  	in_city 		    IN CREDIT_CARD.CITY%TYPE DEFAULT NULL,
14:33:49  34  	in_postal_code		    IN CREDIT_CARD.POSTAL_CODE%TYPE DEFAULT NULL,
14:33:49  35  	in_country		    IN CREDIT_CARD.COUNTRY%TYPE DEFAULT NULL,
14:33:49  36  	in_last_four_cc 	    IN CREDIT_CARD.LAST_FOUR_CC%TYPE DEFAULT NULL,
14:33:49  37  	in_expiration_date	    IN CREDIT_CARD.EXPIRATION_DATE%TYPE DEFAULT NULL,
14:33:49  38  	in_credit_card_type_id	    IN CREDIT_CARD.CREDIT_CARD_TYPE_ID%TYPE DEFAULT NULL,
14:33:49  39  	in_secret_token 	    IN CREDIT_CARD.SECRET_TOKEN%TYPE DEFAULT NULL,
14:33:49  40  	in_chase_profile_id	    IN CREDIT_CARD.CHASE_PROFILE_ID%TYPE DEFAULT NULL,
14:33:49  41  	in_updated_by		    IN CREDIT_CARD.UPDATED_BY%TYPE,
14:33:49  42  	in_credit_card_status_id    IN CREDIT_CARD.CREDIT_CARD_STATUS_ID%TYPE DEFAULT NULL,
14:33:49  43  	in_private_first_name	    IN CREDIT_CARD.PRIVATE_FIRST_NAME%TYPE DEFAULT NULL,
14:33:49  44  	in_private_last_name	    IN CREDIT_CARD.PRIVATE_LAST_NAME%TYPE DEFAULT NULL
14:33:49  45  );
14:33:49  46  
14:33:49  47  PROCEDURE CREATE_PAYPAL(
14:33:49  48  	out_paypal_id			OUT PAYPAL.ID%TYPE,
14:33:49  49  	in_paypal_id			IN PAYPAL.ID%TYPE DEFAULT NULL,
14:33:49  50  	in_account_id			IN PAYPAL.ACCOUNT_ID%TYPE,
14:33:49  51  	in_instrument_name		IN PAYPAL.INSTRUMENT_NAME%TYPE DEFAULT NULL,
14:33:49  52  	in_private_email_address	IN PAYPAL.PRIVATE_EMAIL_ADDRESS%TYPE DEFAULT NULL,
14:33:49  53  	in_created_by			IN PAYPAL.CREATED_BY%TYPE,
14:33:49  54  	in_paypal_status_id		IN PAYPAL.PAYPAL_STATUS_ID%TYPE,
14:33:49  55  	in_paypal_prvt_street_address	IN PAYPAL.PRIVATE_STREET_ADDRESS%TYPE,
14:33:49  56  	in_paypal_prvt_street_address2	IN PAYPAL.PRIVATE_STREET_ADDRESS%TYPE,
14:33:49  57  	in_state			IN PAYPAL.STATE%TYPE,
14:33:49  58  	in_city 			IN PAYPAL.CITY%TYPE,
14:33:49  59  	in_postal_code			IN PAYPAL.POSTAL_CODE%TYPE,
14:33:49  60  	in_country			IN PAYPAL.COUNTRY%TYPE,
14:33:49  61  	in_expiration_date		IN PAYPAL.EXPIRATION_DATE%TYPE,
14:33:49  62  	in_secret_token 		IN PAYPAL.SECRET_TOKEN%TYPE
14:33:49  63  );
14:33:49  64  
14:33:49  65  PROCEDURE UPDATE_PAYPAL(
14:33:49  66  	in_paypal_id			IN PAYPAL.ID%TYPE,
14:33:49  67  	in_instrument_name		IN PAYPAL.INSTRUMENT_NAME%TYPE DEFAULT NULL,
14:33:49  68  	in_private_email_address	IN PAYPAL.PRIVATE_EMAIL_ADDRESS%TYPE DEFAULT NULL,
14:33:49  69  	in_updated_by			IN PAYPAL.UPDATED_BY%TYPE,
14:33:49  70  	in_paypal_status_id		IN PAYPAL.PAYPAL_STATUS_ID%TYPE DEFAULT NULL,
14:33:49  71  	in_paypal_prvt_street_address	IN PAYPAL.PRIVATE_STREET_ADDRESS%TYPE DEFAULT NULL,
14:33:49  72  	in_paypal_prvt_street_address2	IN PAYPAL.PRIVATE_STREET_ADDRESS%TYPE DEFAULT NULL,
14:33:49  73  	in_state			IN PAYPAL.STATE%TYPE DEFAULT NULL,
14:33:49  74  	in_city 			IN PAYPAL.CITY%TYPE DEFAULT NULL,
14:33:49  75  	in_postal_code			IN PAYPAL.POSTAL_CODE%TYPE DEFAULT NULL,
14:33:49  76  	in_country			IN PAYPAL.COUNTRY%TYPE DEFAULT NULL,
14:33:49  77  	in_expiration_date		IN PAYPAL.EXPIRATION_DATE%TYPE DEFAULT NULL,
14:33:49  78  	in_secret_token 		IN PAYPAL.SECRET_TOKEN%TYPE DEFAULT NULL
14:33:49  79  );
14:33:49  80  
14:33:49  81  PROCEDURE CREATE_GIFT_CERTIFICATE(
14:33:49  82  	out_gift_certificate_id       OUT GIFT_CERTIFICATE.ID%TYPE,
14:33:49  83  	in_gift_certificate_id	      IN GIFT_CERTIFICATE.ID%TYPE DEFAULT NULL,
14:33:49  84  	in_purchaser_group_id	      IN GIFT_CERTIFICATE.PURCHASER_GROUP_ID%TYPE,
14:33:49  85  	in_purchaser_invoice_id       IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
14:33:49  86  	in_offer_chain_id	      IN GIFT_CERTIFICATE.OFFER_CHAIN_ID%TYPE,
14:33:49  87  	in_expiration_date	      IN GIFT_CERTIFICATE.EXPIRATION_DATE%TYPE DEFAULT NULL,
14:33:49  88  	in_purchase_date	      IN GIFT_CERTIFICATE.PURCHASE_DATE%TYPE,
14:33:49  89  	in_gift_certificate_status_id IN GIFT_CERTIFICATE.GIFT_CERTIFICATE_STATUS_ID%TYPE,
14:33:49  90  	in_code 		      IN GIFT_CERTIFICATE.CODE%TYPE,
14:33:49  91  	in_created_by		      IN GIFT_CERTIFICATE.CREATED_BY%TYPE,
14:33:49  92  	in_recipient_name	      IN GIFT_CERTIFICATE.RECIPIENT_NAME%TYPE DEFAULT NULL,
14:33:49  93  	in_gift_message 	      IN GIFT_CERTIFICATE.GIFT_MESSAGE%TYPE DEFAULT NULL,
14:33:49  94  	in_recipient_email	      IN GIFT_CERTIFICATE.RECIPIENT_EMAIL%TYPE DEFAULT NULL,
14:33:49  95  	in_finalized_invoice_id       IN GIFT_CERTIFICATE.FINALIZED_INVOICE_ID%TYPE DEFAULT NULL,
14:33:49  96  	in_sender_email 	      IN GIFT_CERTIFICATE.SENDER_EMAIL%TYPE,
14:33:49  97  	in_sender_name		      IN GIFT_CERTIFICATE.SENDER_NAME%TYPE,
14:33:49  98  	in_redemption_date	      IN GIFT_CERTIFICATE.REDEMPTION_DATE%TYPE DEFAULT NULL,
14:33:49  99  	in_cancelation_date	      IN GIFT_CERTIFICATE.CANCELATION_DATE%TYPE DEFAULT NULL,
14:33:49 100  	in_redeemer_group_id	      IN GIFT_CERTIFICATE.REDEEMER_GROUP_ID%TYPE DEFAULT NULL,
14:33:49 101  	in_recipient_address_id       IN GIFT_CERTIFICATE.RECIPIENT_ADDRESS_ID%TYPE DEFAULT NULL,
14:33:49 102  	in_recipient_notify_date      IN GIFT_CERTIFICATE.RECIPIENT_NOTIFY_DATE%TYPE DEFAULT NULL,
14:33:49 103  	in_campaign		      IN GC_CAMPAIGN_AND_REF.CAMPAIGN%TYPE DEFAULT NULL,
14:33:49 104  	in_reference_code	      IN GC_CAMPAIGN_AND_REF.REFERENCE_CODE%TYPE DEFAULT NULL
14:33:49 105  );
14:33:49 106  
14:33:49 107  PROCEDURE UPDATE_GIFT_CERTIFICATE(
14:33:49 108  	in_gift_certificate_id	      IN GIFT_CERTIFICATE.ID%TYPE,
14:33:49 109  	in_expiration_date	      IN GIFT_CERTIFICATE.EXPIRATION_DATE%TYPE DEFAULT NULL,
14:33:49 110  	in_gift_certificate_status_id IN GIFT_CERTIFICATE.GIFT_CERTIFICATE_STATUS_ID%TYPE DEFAULT NULL,
14:33:49 111  	in_code 		      IN GIFT_CERTIFICATE.CODE%TYPE DEFAULT NULL,
14:33:49 112  	in_updated_by		      IN GIFT_CERTIFICATE.UPDATED_BY%TYPE,
14:33:49 113  	in_recipient_name	      IN GIFT_CERTIFICATE.RECIPIENT_NAME%TYPE DEFAULT NULL,
14:33:49 114  	in_gift_message 	      IN GIFT_CERTIFICATE.GIFT_MESSAGE%TYPE DEFAULT NULL,
14:33:49 115  	in_recipient_email	      IN GIFT_CERTIFICATE.RECIPIENT_EMAIL%TYPE DEFAULT NULL,
14:33:49 116  	in_finalized_invoice_id       IN GIFT_CERTIFICATE.FINALIZED_INVOICE_ID%TYPE DEFAULT NULL,
14:33:49 117  	in_sender_email 	      IN GIFT_CERTIFICATE.SENDER_EMAIL%TYPE DEFAULT NULL,
14:33:49 118  	in_sender_name		      IN GIFT_CERTIFICATE.SENDER_NAME%TYPE DEFAULT NULL,
14:33:49 119  	in_redemption_date	      IN GIFT_CERTIFICATE.REDEMPTION_DATE%TYPE DEFAULT NULL,
14:33:49 120  	in_cancelation_date	      IN GIFT_CERTIFICATE.CANCELATION_DATE%TYPE DEFAULT NULL,
14:33:49 121  	in_redeemer_group_id	      IN GIFT_CERTIFICATE.REDEEMER_GROUP_ID%TYPE DEFAULT NULL,
14:33:49 122  	in_recipient_address_id       IN GIFT_CERTIFICATE.RECIPIENT_ADDRESS_ID%TYPE DEFAULT NULL,
14:33:49 123  	in_redeemer_address_id	      IN GIFT_CERTIFICATE.REDEEMER_ADDRESS_ID%TYPE DEFAULT NULL,
14:33:49 124  	in_recipient_notify_date      IN GIFT_CERTIFICATE.RECIPIENT_NOTIFY_DATE%TYPE DEFAULT NULL
14:33:49 125  );
14:33:49 126  
14:33:49 127  END PROCS_FIN_INSTRUMENTS_CRU_V22;
14:33:49 128  .
14:33:49 SQL> /

Package created.

Elapsed: 00:00:00.05
14:33:49 SQL> 
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> -- DDL for package PROCS_GROUP_ACCOUNT
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> 
14:33:49 SQL> CREATE OR REPLACE PACKAGE "PROCS_GROUP_ACCOUNT_V22" As
14:33:49   2  
14:33:49   3  PROCEDURE UPDATE_SS_NEED_ENTITLEMENTS (
14:33:49   4  	in_sub_share_id      IN SUBSCRIPTION_SHARE.ID%TYPE,
14:33:49   5  	in_need_entitlements IN SUBSCRIPTION_SHARE.NEEDS_ENTITLEMENTS%TYPE,
14:33:49   6  	in_updater	     IN SUBSCRIPTION_SHARE.UPDATED_BY%TYPE
14:33:49   7  );
14:33:49   8  
14:33:49   9  PROCEDURE SUB_EXPIRES_NEED_ENTITLEMENTS (
14:33:49  10  	out_result_set OUT SYS_REFCURSOR
14:33:49  11  );
14:33:49  12  
14:33:49  13  PROCEDURE EXPIRE_SUB_SHARE (
14:33:49  14  	in_sub_share_id IN SUBSCRIPTION_SHARE.ID%TYPE,
14:33:49  15  	in_updater	IN SUBSCRIPTION_SHARE.UPDATED_BY%TYPE
14:33:49  16  );
14:33:49  17  
14:33:49  18  PROCEDURE EXPIRE_ALL_SHARES (
14:33:49  19  	in_group_account_id IN SUBSCRIPTION_SHARE.GROUP_ACCOUNT_ID%TYPE,
14:33:49  20  	in_updated_by	    IN SUBSCRIPTION_SHARE.UPDATED_BY%TYPE
14:33:49  21  );
14:33:49  22  
14:33:49  23  PROCEDURE SUB_SHARE_BY_GROUP_ID (
14:33:49  24  	in_group_id	 IN  ACCOUNT.GROUP_ID%TYPE,
14:33:49  25  	in_start	 IN  NUMBER,
14:33:49  26  	in_end		 IN  NUMBER,
14:33:49  27  	in_expired	 IN  NUMBER,
14:33:49  28  	out_result_set	 OUT SYS_REFCURSOR,
14:33:49  29  	out_shares_count OUT NUMBER
14:33:49  30  );
14:33:49  31  
14:33:49  32  PROCEDURE IS_VALID_IP_ADDRESS (
14:33:49  33  	in_group_account_id IN GROUP_ACCOUNT_IP_RANGE.GROUP_ACCOUNT_ID%TYPE,
14:33:49  34  	in_ip_low	    IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_LOW%TYPE,
14:33:49  35  	in_ip_high	    IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_HIGH%TYPE,
14:33:49  36  	out_is_valid	    OUT NUMBER
14:33:49  37  );
14:33:49  38  
14:33:49  39  PROCEDURE IS_VALID_EMAIL_DOMAIN (
14:33:49  40  	in_group_account_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
14:33:49  41  	in_email_domain     IN GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE,
14:33:49  42  	out_is_valid	    OUT NUMBER
14:33:49  43  );
14:33:49  44  
14:33:49  45  PROCEDURE GET_SUBSCRIPTION_SHARE (
14:33:49  46  	in_group_account_id    IN SUBSCRIPTION_SHARE.GROUP_ACCOUNT_ID%TYPE,
14:33:49  47  	in_borrower_account_id IN SUBSCRIPTION_SHARE.BORROWER_ACCOUNT_ID%TYPE,
14:33:49  48  	Out_Result_Set	       Out Sys_Refcursor
14:33:49  49  );
14:33:49  50  
14:33:49  51  PROCEDURE GET_SUBSCRIPTION_SHARES (
14:33:49  52  	in_group_account_id IN NUMBER,
14:33:49  53  	in_start	    IN NUMBER,
14:33:49  54  	in_end		    IN NUMBER,
14:33:49  55  	Out_Result_Set	    OUT Sys_Refcursor
14:33:49  56  );
14:33:49  57  
14:33:49  58  PROCEDURE GET_GROUP_ACCOUNT_BY_SUB_ID (
14:33:49  59  	in_subscription_id IN Group_Account.SUBSCRIPTION_ID%TYPE,
14:33:49  60  	Out_Result_Set	   Out Sys_Refcursor
14:33:49  61  );
14:33:49  62  
14:33:49  63  PROCEDURE CREATE_GROUP_ACCOUNT (
14:33:49  64  	in_subscription_id	 IN NUMBER,
14:33:49  65  	in_group_name		 IN VARCHAR2,
14:33:49  66  	in_first_name		 IN VARCHAR2,
14:33:49  67  	in_last_name		 IN VARCHAR2,
14:33:49  68  	in_email		 IN VARCHAR2,
14:33:49  69  	in_phone		 IN VARCHAR2,
14:33:49  70  	in_organization_type	 IN VARCHAR2,
14:33:49  71  	in_seats		 IN NUMBER,
14:33:49  72  	in_seat_ttl_in_hours	 IN NUMBER,
14:33:49  73  	in_ip			 IN NUMBER,
14:33:49  74  	in_created_by		 IN VARCHAR2
14:33:49  75  );
14:33:49  76  
14:33:49  77  PROCEDURE GET_GROUP_ACCOUNT_BY_EMAIL (
14:33:49  78  	in_email_domain     IN GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE,
14:33:49  79  	out_result_set	    OUT SYS_REFCURSOR
14:33:49  80  );
14:33:49  81  
14:33:49  82  PROCEDURE GET_GROUP_ACCOUNT_BY_IP (
14:33:49  83  	in_ip_low	    IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_LOW%TYPE,
14:33:49  84  	in_ip_high	    IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_HIGH%TYPE,
14:33:49  85  	out_result_set	    OUT SYS_REFCURSOR
14:33:49  86  );
14:33:49  87  
14:33:49  88  PROCEDURE GET_GROUP_ACCOUNT_IP_RANGES (
14:33:49  89  	in_group_account_id   IN NUMBER,
14:33:49  90  	in_start	      IN NUMBER,
14:33:49  91  	in_end		      IN NUMBER,
14:33:49  92  	in_status	      IN NUMBER,
14:33:49  93  	out_record_count      OUT NUMBER,
14:33:49  94  	out_result_set	      OUT SYS_REFCURSOR
14:33:49  95  );
14:33:49  96  
14:33:49  97  PROCEDURE GET_GRP_ACCNT_EMAIL_DOMAINS (
14:33:49  98  	in_group_account_id   IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
14:33:49  99  	in_start	      IN NUMBER,
14:33:49 100  	in_end		      IN NUMBER,
14:33:49 101  	in_status	      IN GROUP_ACCOUNT_EMAIL_DOMAIN.IS_ACTIVE%TYPE,
14:33:49 102  	out_record_count      OUT NUMBER,
14:33:49 103  	out_result_set	      OUT SYS_REFCURSOR
14:33:49 104  );
14:33:49 105  
14:33:49 106  PROCEDURE ADD_EMAIL_DOMAIN (
14:33:49 107  	in_group_account_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
14:33:49 108  	in_email_domain IN GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE,
14:33:49 109  	in_created_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.CREATED_BY%TYPE
14:33:49 110  );
14:33:49 111  
14:33:49 112  PROCEDURE DISABLE_EMAIL_DOMAIN_BY_GA_ID(
14:33:49 113  	in_group_account_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
14:33:49 114  	in_updated_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.UPDATED_BY%TYPE
14:33:49 115  );
14:33:49 116  
14:33:49 117  PROCEDURE DISABLE_EMAIL_DOMAIN_BY_ID(
14:33:49 118  	in_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.ID%TYPE,
14:33:49 119  	in_updated_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.UPDATED_BY%TYPE
14:33:49 120  );
14:33:49 121  
14:33:49 122  PROCEDURE CREATE_SUBSCRIPTION_SHARE (
14:33:49 123  	in_group_account_id    IN NUMBER,
14:33:49 124  	in_borrower_account_id IN NUMBER,
14:33:49 125  	in_ip_address	       IN VARCHAR2,
14:33:49 126  	in_email_domain        IN VARCHAR2,
14:33:49 127  	in_created_by	       IN VARCHAR2
14:33:49 128  );
14:33:49 129  
14:33:49 130  PROCEDURE GET_NUM_OCCUPIED_GROUP_SEATS (
14:33:49 131  	in_group_account_id   IN NUMBER,
14:33:49 132  	out_occupied_seats   OUT NUMBER
14:33:49 133  );
14:33:49 134  
14:33:49 135  FUNCTION F_GET_NUM_OCCUPIED_GROUP_SEATS (
14:33:49 136  	in_group_account_id   IN NUMBER
14:33:49 137  ) RETURN NUMBER;
14:33:49 138  
14:33:49 139  PROCEDURE DISABLE_IP_RANGES_BY_GA_ID(
14:33:49 140  	in_group_account_id IN GROUP_ACCOUNT_IP_RANGE.GROUP_ACCOUNT_ID%TYPE,
14:33:49 141  	in_updated_by IN GROUP_ACCOUNT_IP_RANGE.UPDATED_BY%TYPE
14:33:49 142  );
14:33:49 143  
14:33:49 144  PROCEDURE DISABLE_IP_RANGE_BY_ID(
14:33:49 145  	in_id IN GROUP_ACCOUNT_IP_RANGE.ID%TYPE,
14:33:49 146  	in_updated_by IN GROUP_ACCOUNT_IP_RANGE.UPDATED_BY%TYPE
14:33:49 147  );
14:33:49 148  
14:33:49 149  PROCEDURE ADD_IP_RANGE (
14:33:49 150  	in_group_account_id IN GROUP_ACCOUNT_IP_RANGE.GROUP_ACCOUNT_ID%TYPE,
14:33:49 151  	in_minimum_ip_string IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_STRING%TYPE,
14:33:49 152  	in_minimum_ip_low IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_LOW%TYPE,
14:33:49 153  	in_minimum_ip_high IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_HIGH%TYPE,
14:33:49 154  	in_maximum_ip_string IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_STRING%TYPE,
14:33:49 155  	in_maximum_ip_low IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_LOW%TYPE,
14:33:49 156  	in_maximum_ip_high IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_HIGH%TYPE,
14:33:49 157  	in_created_by IN GROUP_ACCOUNT_IP_RANGE.CREATED_BY%TYPE
14:33:49 158  );
14:33:49 159  
14:33:49 160  PROCEDURE GET_GRP_ID_BY_GRP_ACCOUNT_ID (
14:33:49 161  	in_group_account_id IN NUMBER,
14:33:49 162  	out_group_id OUT NUMBER
14:33:49 163  );
14:33:49 164  
14:33:49 165  PROCEDURE GET_GRP_ID_BY_GRPACCIPRNG_ID (
14:33:49 166  	in_group_account_ip_range_id IN NUMBER,
14:33:49 167  	out_group_id OUT NUMBER
14:33:49 168  );
14:33:49 169  
14:33:49 170  PROCEDURE GET_GRP_ID_BY_EMAIL_DOM_ID (
14:33:49 171  	in_group_account_email_dom_id IN NUMBER,
14:33:49 172  	out_group_id OUT NUMBER
14:33:49 173  );
14:33:49 174  
14:33:49 175  PROCEDURE UPDATE_GROUP_ACCOUNT (
14:33:49 176  	in_group_account_id	 IN GROUP_ACCOUNT.ID%TYPE,
14:33:49 177  	in_group_name		 IN GROUP_ACCOUNT.GROUP_NAME%TYPE,
14:33:49 178  	in_first_name		 IN GROUP_ACCOUNT.FIRST_NAME%TYPE,
14:33:49 179  	in_last_name		 IN GROUP_ACCOUNT.LAST_NAME%TYPE,
14:33:49 180  	in_email		 IN GROUP_ACCOUNT.EMAIL%TYPE,
14:33:49 181  	in_phone		 IN GROUP_ACCOUNT.PHONE%TYPE,
14:33:49 182  	in_updated_by		 IN GROUP_ACCOUNT.UPDATED_BY%TYPE
14:33:49 183  );
14:33:49 184  
14:33:49 185  PROCEDURE UPDATE_GROUP_ACCOUNT_SEATS (
14:33:49 186  	in_group_account_id	 IN GROUP_ACCOUNT.ID%TYPE,
14:33:49 187  	in_seats		 IN GROUP_ACCOUNT.SEATS%TYPE,
14:33:49 188  	in_updated_by		 IN GROUP_ACCOUNT.UPDATED_BY%TYPE
14:33:49 189  );
14:33:49 190  
14:33:49 191  END PROCS_GROUP_ACCOUNT_V22;
14:33:49 192  .
14:33:49 SQL> /

Package created.

Elapsed: 00:00:00.07
14:33:49 SQL> 
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> -- DDL for package PROCS_GROUP_ACCOUNT
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> 
14:33:49 SQL> CREATE OR REPLACE PACKAGE "PROCS_GROUP_ACCOUNT_CRU_V22" AS
14:33:49   2  
14:33:49   3  PROCEDURE UPDATE_SUBSCRIPTION_SHARE (
14:33:49   4  	in_id		       IN SUBSCRIPTION_SHARE.ID%TYPE,
14:33:49   5  	in_group_account_id    IN SUBSCRIPTION_SHARE.GROUP_ACCOUNT_ID%TYPE DEFAULT NULL,
14:33:49   6  	in_borrower_account_id IN SUBSCRIPTION_SHARE.BORROWER_ACCOUNT_ID%TYPE DEFAULT NULL,
14:33:49   7  	in_ip_address	       IN SUBSCRIPTION_SHARE.IP_ADDRESS%TYPE DEFAULT NULL,
14:33:49   8  	in_start_date	       IN SUBSCRIPTION_SHARE.START_DATE%TYPE DEFAULT NULL,
14:33:49   9  	in_end_date	       IN SUBSCRIPTION_SHARE.END_DATE%TYPE DEFAULT NULL,
14:33:49  10  	in_needs_entitlements  IN SUBSCRIPTION_SHARE.NEEDS_ENTITLEMENTS%TYPE DEFAULT NULL,
14:33:49  11  	in_updated_by	       IN SUBSCRIPTION_SHARE.UPDATED_BY%TYPE
14:33:49  12  );
14:33:49  13  
14:33:49  14  PROCEDURE CREATE_GROUP_ACCOUNT (
14:33:49  15  	in_subscription_id	 IN NUMBER,
14:33:49  16  	in_group_name		 IN VARCHAR2,
14:33:49  17  	in_first_name		 IN VARCHAR2,
14:33:49  18  	in_last_name		 IN VARCHAR2,
14:33:49  19  	in_email		 IN VARCHAR2,
14:33:49  20  	in_phone		 IN VARCHAR2,
14:33:49  21  	in_organization_type	 IN VARCHAR2,
14:33:49  22  	in_seats		 IN NUMBER,
14:33:49  23  	in_seat_ttl_in_hours	 IN NUMBER,
14:33:49  24  	in_ip			 IN NUMBER,
14:33:49  25  	in_created_by		 IN VARCHAR2
14:33:49  26  );
14:33:49  27  
14:33:49  28  PROCEDURE CREATE_SUBSCRIPTION_SHARE (
14:33:49  29  	in_group_account_id    IN NUMBER,
14:33:49  30  	in_borrower_account_id IN NUMBER,
14:33:49  31  	in_ip_address	       IN VARCHAR2,
14:33:49  32  	in_email_domain        IN VARCHAR2,
14:33:49  33  	in_start_date	       IN DATE,
14:33:49  34  	in_end_date	       IN DATE,
14:33:49  35  	in_created_by	       IN VARCHAR2
14:33:49  36  );
14:33:49  37  
14:33:49  38  PROCEDURE DISABLE_IP_RANGES_BY_GA_ID(
14:33:49  39  	in_group_account_id IN GROUP_ACCOUNT_IP_RANGE.GROUP_ACCOUNT_ID%TYPE,
14:33:49  40  	in_updated_by IN GROUP_ACCOUNT_IP_RANGE.UPDATED_BY%TYPE
14:33:49  41  );
14:33:49  42  
14:33:49  43  PROCEDURE DISABLE_IP_RANGE_BY_ID(
14:33:49  44  	in_id IN GROUP_ACCOUNT_IP_RANGE.ID%TYPE,
14:33:49  45  	in_updated_by IN GROUP_ACCOUNT_IP_RANGE.UPDATED_BY%TYPE
14:33:49  46  );
14:33:49  47  
14:33:49  48  PROCEDURE ADD_IP_RANGE (
14:33:49  49  	in_group_account_id IN GROUP_ACCOUNT_IP_RANGE.GROUP_ACCOUNT_ID%TYPE,
14:33:49  50  	in_minimum_ip_string IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_STRING%TYPE,
14:33:49  51  	in_minimum_ip_low IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_LOW%TYPE,
14:33:49  52  	in_minimum_ip_high IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_HIGH%TYPE,
14:33:49  53  	in_maximum_ip_string IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_STRING%TYPE,
14:33:49  54  	in_maximum_ip_low IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_LOW%TYPE,
14:33:49  55  	in_maximum_ip_high IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_HIGH%TYPE,
14:33:49  56  	in_created_by IN GROUP_ACCOUNT_IP_RANGE.CREATED_BY%TYPE
14:33:49  57  );
14:33:49  58  
14:33:49  59  PROCEDURE DISABLE_EMAIL_DOMAIN_BY_GA_ID(
14:33:49  60  	in_group_account_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
14:33:49  61  	in_updated_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.UPDATED_BY%TYPE
14:33:49  62  );
14:33:49  63  
14:33:49  64  PROCEDURE DISABLE_EMAIL_DOMAIN_BY_ID(
14:33:49  65  	in_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.ID%TYPE,
14:33:49  66  	in_updated_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.UPDATED_BY%TYPE
14:33:49  67  );
14:33:49  68  
14:33:49  69  PROCEDURE ENABLE_EMAIL_DOMAIN_BY_ID(
14:33:49  70  	in_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.ID%TYPE,
14:33:49  71  	in_updated_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.UPDATED_BY%TYPE
14:33:49  72  );
14:33:49  73  
14:33:49  74  PROCEDURE ADD_EMAIL_DOMAIN (
14:33:49  75  	in_group_account_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
14:33:49  76  	in_email_domain IN GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE,
14:33:49  77  	in_is_active IN  GROUP_ACCOUNT_EMAIL_DOMAIN.IS_ACTIVE%TYPE,
14:33:49  78  	in_created_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.CREATED_BY%TYPE
14:33:49  79  );
14:33:49  80  
14:33:49  81  PROCEDURE UPDATE_GROUP_ACCOUNT (
14:33:49  82  	in_group_account_id	 IN GROUP_ACCOUNT.ID%TYPE,
14:33:49  83  	in_group_name		 IN GROUP_ACCOUNT.GROUP_NAME%TYPE,
14:33:49  84  	in_first_name		 IN GROUP_ACCOUNT.FIRST_NAME%TYPE,
14:33:49  85  	in_last_name		 IN GROUP_ACCOUNT.LAST_NAME%TYPE,
14:33:49  86  	in_email		 IN GROUP_ACCOUNT.EMAIL%TYPE,
14:33:49  87  	in_phone		 IN GROUP_ACCOUNT.PHONE%TYPE,
14:33:49  88  	in_updated_by		 IN GROUP_ACCOUNT.UPDATED_BY%TYPE
14:33:49  89  );
14:33:49  90  
14:33:49  91  PROCEDURE UPDATE_GROUP_ACCOUNT_SEATS (
14:33:49  92  	in_group_account_id	 IN GROUP_ACCOUNT.ID%TYPE,
14:33:49  93  	in_seats		 IN GROUP_ACCOUNT.SEATS%TYPE,
14:33:49  94  	in_updated_by		 IN GROUP_ACCOUNT.UPDATED_BY%TYPE
14:33:49  95  );
14:33:49  96  END PROCS_GROUP_ACCOUNT_CRU_V22;
14:33:49  97  .
14:33:49 SQL> /

Package created.

Elapsed: 00:00:00.03
14:33:49 SQL> 
14:33:49 SQL> CREATE OR REPLACE PACKAGE "PROCS_HISTORY_V22" AS
14:33:49   2  
14:33:49   3  PROCEDURE CREATE_AASR_HISTORY(
14:33:49   4  	in_id			     IN CORE_OWNER.AMAZON_APPSTORE_RECEIPT.ID%TYPE,
14:33:49   5  	in_system_activity_reason_id IN NUMBER,
14:33:49   6  	in_created_by		     IN VARCHAR2
14:33:49   7  );
14:33:49   8  
14:33:49   9  PROCEDURE CREATE_ADDRESS_HISTORY(
14:33:49  10  	in_address_id		     IN NUMBER,
14:33:49  11  	in_system_activity_reason_id IN NUMBER
14:33:49  12  );
14:33:49  13  
14:33:49  14  PROCEDURE CREATE_ACCOUNT_HISTORY(
14:33:49  15  	in_account_id		     IN NUMBER,
14:33:49  16  	in_system_activity_reason_id IN NUMBER
14:33:49  17  );
14:33:49  18  
14:33:49  19  PROCEDURE CREATE_SUBSCRIPTION_HISTORY (
14:33:49  20  	in_subscription_id	     IN NUMBER,
14:33:49  21  	in_system_activity_reason_id IN NUMBER
14:33:49  22  );
14:33:49  23  
14:33:49  24  PROCEDURE CREATE_CREDIT_CARD_HISTORY(
14:33:49  25  	in_credit_card_id	      IN NUMBER,
14:33:49  26  	in_system_activity_reason_id  IN  NUMBER
14:33:49  27  );
14:33:49  28  
14:33:49  29  PROCEDURE CREATE_PAYPAL_HISTORY(
14:33:49  30  	in_paypal_id		      IN NUMBER,
14:33:49  31  	in_system_activity_reason_id  IN NUMBER
14:33:49  32  );
14:33:49  33  
14:33:49  34  PROCEDURE CREATE_GIFT_CERT_HISTORY(
14:33:49  35  	in_gift_certificate_id	      IN NUMBER,
14:33:49  36  	in_system_activity_reason_id  IN  NUMBER
14:33:49  37  );
14:33:49  38  
14:33:49  39  PROCEDURE CREATE_TRANSACTION_HISTORY (
14:33:49  40  	in_transaction_id	     IN NUMBER,
14:33:49  41  	in_system_activity_reason_id IN NUMBER
14:33:49  42  );
14:33:49  43  
14:33:49  44  PROCEDURE CREATE_INVOICE_HISTORY (
14:33:49  45  	in_invoice_id		     IN NUMBER,
14:33:49  46  	in_system_activity_reason_id IN NUMBER
14:33:49  47  );
14:33:49  48  
14:33:49  49  PROCEDURE CREATE_LICENSE_HISTORY (
14:33:49  50  	in_license_id		     IN NUMBER,
14:33:49  51  	in_system_activity_reason_id IN NUMBER
14:33:49  52  );
14:33:49  53  
14:33:49  54  PROCEDURE CREATE_CHARGE_HISTORY (
14:33:49  55  	in_charge_id		    IN NUMBER,
14:33:49  56  	in_system_activity_reason_id IN NUMBER
14:33:49  57  );
14:33:49  58  
14:33:49  59  PROCEDURE CREATE_INVOICE_ADJ_HISTORY (
14:33:49  60  	in_invoice_adjustment_id     IN NUMBER,
14:33:49  61  	in_system_activity_reason_id IN NUMBER
14:33:49  62  );
14:33:49  63  
14:33:49  64  
14:33:49  65  END PROCS_HISTORY_V22;
14:33:49  66  .
14:33:49 SQL> /

Package created.

Elapsed: 00:00:00.02
14:33:49 SQL> 
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> -- DDL for package PROCS_INVOICE
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> 
14:33:49 SQL> CREATE OR REPLACE PACKAGE "PROCS_INVOICE_V22" AS
14:33:49   2  
14:33:49   3  PROCEDURE GET_INVOICE_IDS(
14:33:49   4  	in_group_id    IN ACCOUNT.GROUP_ID%TYPE,
14:33:49   5  	in_fin_id      IN SUBSCRIPTION.INSTRUMENT_ID%TYPE,
14:33:49   6  	out_result_set OUT SYS_REFCURSOR
14:33:49   7  );
14:33:49   8  
14:33:49   9  PROCEDURE IS_INVOICE_FOR_GC (
14:33:49  10  	in_invoice_id  IN NUMBER,
14:33:49  11  	out_result     OUT NUMBER
14:33:49  12  );
14:33:49  13  
14:33:49  14  PROCEDURE CREATE_INVOICE(
14:33:49  15  /*
14:33:49  16  Throws exceptions:
14:33:49  17  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  18  */
14:33:49  19  	  in_invoice_status IN NUMBER,
14:33:49  20  	  in_created_by     IN VARCHAR2,
14:33:49  21  	  in_tax_exempt_id  IN VARCHAR2,
14:33:49  22  	  out_invoice_id    OUT NUMBER
14:33:49  23  );
14:33:49  24  
14:33:49  25  PROCEDURE GET_PENDING_INVOICES (
14:33:49  26  /*
14:33:49  27  Throws exceptions:
14:33:49  28  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  29  */
14:33:49  30  	out_result_set	     OUT SYS_REFCURSOR,
14:33:49  31  	in_row_number	     IN NUMBER DEFAULT NULL
14:33:49  32  );
14:33:49  33  
14:33:49  34  PROCEDURE CALCULATE_INVOICE_AMOUNT (
14:33:49  35  /*
14:33:49  36  Throws exceptions:
14:33:49  37  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:49  38  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  39  */
14:33:49  40  	in_invoice_id IN  NUMBER,
14:33:49  41  	out_amount    OUT NUMBER
14:33:49  42  );
14:33:49  43  
14:33:49  44  FUNCTION F_CALCULATE_INVOICE_AMOUNT(
14:33:49  45  	in_invoice_id IN  NUMBER
14:33:49  46  ) RETURN NUMBER;
14:33:49  47  
14:33:49  48  PROCEDURE GET_ACCOUNT_BY_INVOICE_ID (
14:33:49  49  /*
14:33:49  50  Throws exceptions:
14:33:49  51  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:49  52  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  53  */
14:33:49  54  	in_invoice_id  IN  NUMBER,
14:33:49  55  	out_account_id OUT NUMBER
14:33:49  56  );
14:33:49  57  
14:33:49  58  PROCEDURE GET_INVOICE_DETAILS (
14:33:49  59  /*
14:33:49  60  Throws exceptions:
14:33:49  61  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:49  62  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  63  */
14:33:49  64  	in_invoice_id	   IN  NUMBER,
14:33:49  65  	out_group_id	   OUT NUMBER,
14:33:49  66  	out_status_id	   OUT NUMBER,
14:33:49  67  	out_line_items_set OUT SYS_REFCURSOR,
14:33:49  68  	out_pp_charges_set OUT SYS_REFCURSOR,
14:33:49  69  	out_cc_charges_set OUT SYS_REFCURSOR,
14:33:49  70  	out_gc_charges_set OUT SYS_REFCURSOR
14:33:49  71  );
14:33:49  72  -- norlov: #38796
14:33:49  73  PROCEDURE GET_TRANSACTION_INVOICE (
14:33:49  74  /*
14:33:49  75  Throws exceptions:
14:33:49  76  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:49  77  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  78  */
14:33:49  79  	in_transaction_id  IN  NUMBER,
14:33:49  80  	out_result_set	      OUT SYS_REFCURSOR
14:33:49  81  );
14:33:49  82  
14:33:49  83  PROCEDURE UPDATE_INVOICE_STATUS (
14:33:49  84  /*
14:33:49  85  Throws exceptions:
14:33:49  86  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:49  87  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  88  */
14:33:49  89  	in_invoice_id		       IN NUMBER,
14:33:49  90  	in_invoice_status_id	       IN NUMBER,
14:33:49  91  	in_updated_by		       IN VARCHAR2
14:33:49  92  );
14:33:49  93  
14:33:49  94  FUNCTION IS_INVOICE_PAYING_STARTED (
14:33:49  95  /*
14:33:49  96  Throws exceptions:
14:33:49  97  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:49  98  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  99  */
14:33:49 100  	in_invoice_id IN NUMBER
14:33:49 101  ) RETURN NUMBER;
14:33:49 102  
14:33:49 103  PROCEDURE P_IS_INVOICE_PAYING_STARTED (
14:33:49 104  	in_invoice_id  IN NUMBER,
14:33:49 105  	out_is_started OUT NUMBER
14:33:49 106  );
14:33:49 107  
14:33:49 108  PROCEDURE CALCULATE_INVOICE_CHARGEBACK (
14:33:49 109  	in_invoice_id	      IN NUMBER,
14:33:49 110  	in_chargeback_date    IN DATE,
14:33:49 111  	out_chargeback_amount OUT NUMBER
14:33:49 112  );
14:33:49 113  
14:33:49 114  PROCEDURE APPLY_REFUND (
14:33:49 115  	in_invoice_id	     IN NUMBER,
14:33:49 116  	in_chargeback_amount IN NUMBER,
14:33:49 117  	in_created_by	     IN VARCHAR2,
14:33:49 118  	out_charge_id	     OUT NUMBER
14:33:49 119  );
14:33:49 120  
14:33:49 121  PROCEDURE GET_MAX_REFUND (
14:33:49 122  	in_invoice_id IN NUMBER,
14:33:49 123  	out_amount    OUT NUMBER
14:33:49 124  );
14:33:49 125  
14:33:49 126  PROCEDURE GET_INVOICE_DAYS_USED_NUMBER (
14:33:49 127  	in_invoice_id	    IN NUMBER,
14:33:49 128  	in_chargeback_date  IN DATE DEFAULT SYSDATE,
14:33:49 129  	out_days_num	    OUT NUMBER
14:33:49 130  );
14:33:49 131  
14:33:49 132  PROCEDURE GET_INVOICE_LINE_ITEMS (
14:33:49 133  	in_invoice_id  IN NUMBER,
14:33:49 134  	out_result_set OUT SYS_REFCURSOR
14:33:49 135  );
14:33:49 136  
14:33:49 137  PROCEDURE GET_INVOICE_LICENSES (
14:33:49 138  	in_invoice_id  IN NUMBER,
14:33:49 139  	out_result_set OUT SYS_REFCURSOR
14:33:49 140  );
14:33:49 141  
14:33:49 142  PROCEDURE GET_OFFER_CH_ID_BY_INVOICE_ID (
14:33:49 143  	in_invoice_id	   IN NUMBER,
14:33:49 144  	out_offer_chain_id OUT NUMBER
14:33:49 145  );
14:33:49 146  
14:33:49 147  PROCEDURE CLOSE_INVOICE_AS_NOT_COLLECTED (
14:33:49 148  -- Closing invoice without refund
14:33:49 149  	in_invoice_id IN NUMBER,
14:33:49 150  	in_updated_by IN VARCHAR2
14:33:49 151  );
14:33:49 152  
14:33:49 153  PROCEDURE GET_SUBSCR_ID_BY_INVOICE_ID (
14:33:49 154  	in_invoice_id	    IN NUMBER,
14:33:49 155  	out_subscription_id OUT NUMBER
14:33:49 156  );
14:33:49 157  
14:33:49 158  PROCEDURE IS_INVOICE_TAX_EXEMPT (
14:33:49 159  /*
14:33:49 160  Throws exceptions:
14:33:49 161  APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:49 162  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49 163  Return:
14:33:49 164  	GLOBAL_CONSTANTS_V22.TRUE if ACCOUNT.EXEMPT_ID is not null
14:33:49 165  	GLOBAL_CONSTANTS_V22.FALSE else
14:33:49 166  */
14:33:49 167  	in_invoice_id	  IN NUMBER,
14:33:49 168  	out_is_tax_exempt OUT NUMBER
14:33:49 169  );
14:33:49 170  
14:33:49 171  PROCEDURE GET_INVOICE_BY_ID (
14:33:49 172  	in_invoice_id  IN NUMBER,
14:33:49 173  	out_result_set OUT SYS_REFCURSOR
14:33:49 174  );
14:33:49 175  
14:33:49 176  PROCEDURE GET_IS_TAX_CALCULATION_NEEDED (
14:33:49 177  	in_invoice_id		      IN NUMBER,
14:33:49 178  	out_is_tax_calculation_needed OUT NUMBER
14:33:49 179  );
14:33:49 180  
14:33:49 181  PROCEDURE SET_IS_TAX_CALCULATION_NEEDED (
14:33:49 182  	in_invoice_id		     IN NUMBER,
14:33:49 183  	in_updated_by		     IN VARCHAR2,
14:33:49 184  	in_is_tax_calculation_needed IN NUMBER
14:33:49 185  );
14:33:49 186  
14:33:49 187  PROCEDURE REFUND_INVOICE (
14:33:49 188  	in_invoice_id	   IN NUMBER,
14:33:49 189  	in_refund_amount   IN NUMBER,
14:33:49 190  	in_note 	   IN VARCHAR2,
14:33:49 191  	in_created_by	   IN VARCHAR2,
14:33:49 192  	out_charge_id	   OUT NUMBER
14:33:49 193  );
14:33:49 194  
14:33:49 195  PROCEDURE GET_PAYMENT_INFO_BY_INVOICE_ID (
14:33:49 196  	in_invoice_id		    IN NUMBER,
14:33:49 197  	out_order_id		    OUT VARCHAR2,
14:33:49 198  	out_external_transaction_id OUT VARCHAR2
14:33:49 199  );
14:33:49 200  
14:33:49 201  PROCEDURE GET_INVOICE_BY_TRNS_ORDER_ID (
14:33:49 202  	in_order_id  IN TRANSACTION.ORDER_ID%TYPE,
14:33:49 203  	out_result_set OUT SYS_REFCURSOR
14:33:49 204  );
14:33:49 205  
14:33:49 206  PROCEDURE IS_REVOKE_ENTITLEMENTS(
14:33:49 207  	in_invoice_id IN NUMBER,
14:33:49 208  	out_is_revoke OUT NUMBER
14:33:49 209  );
14:33:49 210  
14:33:49 211  END PROCS_INVOICE_V22;
14:33:49 212  .
14:33:49 SQL> /

Package created.

Elapsed: 00:00:00.08
14:33:49 SQL> 
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> -- DDL for package PROCS_INVOICE_CRU
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> 
14:33:49 SQL> CREATE OR REPLACE PACKAGE "PROCS_INVOICE_CRU_V22" AS
14:33:49   2  
14:33:49   3  PROCEDURE CREATE_INVOICE (
14:33:49   4  	out_invoice_id		       OUT INVOICE.ID%TYPE,
14:33:49   5  	in_invoice_id		       IN INVOICE.ID%TYPE DEFAULT NULL,
14:33:49   6  	in_invoice_status_id	       IN INVOICE.INVOICE_STATUS_ID%TYPE,
14:33:49   7  	in_tax_exempt_id	       IN INVOICE.TAX_EXEMPT_ID%TYPE,
14:33:49   8  	in_created_by		       IN INVOICE.CREATED_BY%TYPE
14:33:49   9  );
14:33:49  10  
14:33:49  11  PROCEDURE UPDATE_INVOICE (
14:33:49  12  	in_invoice_id		       IN INVOICE.ID%TYPE,
14:33:49  13  	in_updated_by		       IN INVOICE.UPDATED_BY%TYPE,
14:33:49  14  	in_invoice_status_id	       IN INVOICE.INVOICE_STATUS_ID%TYPE DEFAULT NULL,
14:33:49  15  	in_is_tax_calculation_needed   IN INVOICE.IS_TAX_CALCULATION_NEEDED%TYPE DEFAULT NULL
14:33:49  16  );
14:33:49  17  
14:33:49  18  END PROCS_INVOICE_CRU_V22;
14:33:49  19  .
14:33:49 SQL> /

Package created.

Elapsed: 00:00:00.04
14:33:49 SQL> 
14:33:49 SQL> /*
14:33:49 SQL> CREATE TABLE ITUNES_RECEIPT (
14:33:49 SQL> 	id NUMBER NOT NULL ENABLE,
14:33:49 SQL> 	subscription_id NUMBER NOT NULL ENABLE,
14:33:49 SQL> 	receipt VARCHAR(1024) NOT NULL ENABLE,
14:33:49 SQL> 	status NUMBER,
14:33:49 SQL> 	quantity NUMBER,
14:33:49 SQL> 	product_id VARCHAR(1024),
14:33:49 SQL> 	transaction_id VARCHAR(1024),
14:33:49 SQL> 	purchase_date TIMESTAMP,
14:33:49 SQL> 	original_transaction_id VARCHAR(1024),
14:33:49 SQL> 	original_purchase_date TIMESTAMP,
14:33:49 SQL> 	app_item_id VARCHAR(1024),
14:33:49 SQL> 	version_external_id NUMBER,
14:33:49 SQL> 	bid VARCHAR(1024),
14:33:49 SQL> 	bvrs VARCHAR(255),
14:33:49 SQL> 	expires_date TIMESTAMP,
14:33:49 SQL> 	create_date DATE NOT NULL,
14:33:49 SQL> 	created_by VARCHAR(255) NOT NULL,
14:33:49 SQL> 	update_date DATE NOT NULL,
14:33:49 SQL> 	updated_by VARCHAR(255) NOT NULL,
14:33:49 SQL> 	last_check_date DATE NOT NULL,
14:33:49 SQL> 	CONSTRAINT "ITUNESRECEIPT_PK" PRIMARY KEY ("ID") USING INDEX TABLESPACE "CORE_IDX" ENABLE,
14:33:49 SQL> 	CONSTRAINT "ITUNESRECEIPT_SUBID_FK" FOREIGN KEY ("SUBSCRIPTION_ID") REFERENCES SUBSCRIPTION(ID) USING INDEX TABLESPACE "CORE_IDX" ENABLE,
14:33:49 SQL> 	CONSTRAINT "ITUNESRECEIPT_RECEIPT_UK" UNIQUE(receipt) USING INDEX TABLESPACE "CORE_IDX" ENABLE,
14:33:49 SQL> 	CONSTRAINT "ITUNESRECEIPT_SUBID_UK" UNIQUE(subscription_id) USING INDEX TABLESPACE "CORE_IDX" ENABLE
14:33:49 SQL> )
14:33:49 SQL> TABLESPACE CORE;
14:33:49 SQL> */
14:33:49 SQL> 
14:33:49 SQL> 
14:33:49 SQL> CREATE OR REPLACE PACKAGE "PROCS_ITUNES_RECEIPT_V22" AS
14:33:49   2  
14:33:49   3  PROCEDURE ITUNES_RECEIPT_SUBSCRIPTION(
14:33:49   4  	      /*
14:33:49   5  	      Throws exceptions:
14:33:49   6  	      APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49   7  	      */
14:33:49   8  	      in_original_transaction_id IN ITUNES_RECEIPT.ORIGINAL_TRANSACTION_ID%TYPE,
14:33:49   9  	      out_result_set	  OUT SYS_REFCURSOR
14:33:49  10  );
14:33:49  11  
14:33:49  12  PROCEDURE CREATE_RECEIPT(
14:33:49  13  /*
14:33:49  14  Throws exceptions:
14:33:49  15  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  16  */
14:33:49  17  	  out_id	      OUT NUMBER,
14:33:49  18  	  in_subscription_id  IN ITUNES_RECEIPT.SUBSCRIPTION_ID%TYPE,
14:33:49  19  	  in_receipt	      IN ITUNES_RECEIPT.RECEIPT%TYPE,
14:33:49  20  	  in_status	      IN ITUNES_RECEIPT.STATUS%TYPE,
14:33:49  21  	  in_quantity	      IN ITUNES_RECEIPT.QUANTITY%TYPE,
14:33:49  22  	  in_product_id       IN ITUNES_RECEIPT.PRODUCT_ID%TYPE,
14:33:49  23  	  in_transaction_id   IN ITUNES_RECEIPT.TRANSACTION_ID%TYPE,
14:33:49  24  	  in_purchase_date    IN ITUNES_RECEIPT.PURCHASE_DATE%TYPE,
14:33:49  25  	  in_original_transaction_id IN ITUNES_RECEIPT.ORIGINAL_TRANSACTION_ID%TYPE,
14:33:49  26  	  in_original_purchase_date IN ITUNES_RECEIPT.ORIGINAL_PURCHASE_DATE%TYPE,
14:33:49  27  	  in_app_item_id      IN ITUNES_RECEIPT.APP_ITEM_ID%TYPE,
14:33:49  28  	  in_version_external_id IN ITUNES_RECEIPT.VERSION_EXTERNAL_ID%TYPE,
14:33:49  29  	  in_bid	      IN ITUNES_RECEIPT.BID%TYPE,
14:33:49  30  	  in_bvrs	      IN ITUNES_RECEIPT.BVRS%TYPE,
14:33:49  31  	  in_expires_date     IN ITUNES_RECEIPT.EXPIRES_DATE%TYPE,
14:33:49  32  	  in_created_by       IN ITUNES_RECEIPT.CREATED_BY%TYPE
14:33:49  33  );
14:33:49  34  
14:33:49  35  PROCEDURE UPDATE_RECEIPT(
14:33:49  36  /*
14:33:49  37  Throws exceptions:
14:33:49  38  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  39  */
14:33:49  40  	  in_id 	      IN ITUNES_RECEIPT.ID%TYPE,
14:33:49  41  	  in_receipt	      IN ITUNES_RECEIPT.RECEIPT%TYPE,
14:33:49  42  	  in_status	      IN ITUNES_RECEIPT.STATUS%TYPE,
14:33:49  43  	  in_quantity	      IN ITUNES_RECEIPT.QUANTITY%TYPE,
14:33:49  44  	  in_product_id       IN ITUNES_RECEIPT.PRODUCT_ID%TYPE,
14:33:49  45  	  in_transaction_id   IN ITUNES_RECEIPT.TRANSACTION_ID%TYPE,
14:33:49  46  	  in_purchase_date    IN ITUNES_RECEIPT.PURCHASE_DATE%TYPE,
14:33:49  47  	  in_original_transaction_id IN ITUNES_RECEIPT.ORIGINAL_TRANSACTION_ID%TYPE,
14:33:49  48  	  in_original_purchase_date IN ITUNES_RECEIPT.ORIGINAL_PURCHASE_DATE%TYPE,
14:33:49  49  	  in_app_item_id      IN ITUNES_RECEIPT.APP_ITEM_ID%TYPE,
14:33:49  50  	  in_version_external_id IN ITUNES_RECEIPT.VERSION_EXTERNAL_ID%TYPE,
14:33:49  51  	  in_bid	      IN ITUNES_RECEIPT.BID%TYPE,
14:33:49  52  	  in_bvrs	      IN ITUNES_RECEIPT.BVRS%TYPE,
14:33:49  53  	  in_expires_date     IN ITUNES_RECEIPT.EXPIRES_DATE%TYPE,
14:33:49  54  	  in_updated_by       IN ITUNES_RECEIPT.UPDATED_BY%TYPE,
14:33:49  55  	  in_is_expired       IN NUMBER
14:33:49  56  );
14:33:49  57  
14:33:49  58  PROCEDURE LINK_ITUNES_RECEIPT(
14:33:49  59  /*
14:33:49  60  Throws exceptions:
14:33:49  61  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  62  */
14:33:49  63  	  in_id 	      IN ITUNES_RECEIPT.ID%TYPE,
14:33:49  64  	  in_subscription_id  IN ITUNES_RECEIPT.SUBSCRIPTION_ID%TYPE,
14:33:49  65  	  in_updated_by       IN ITUNES_RECEIPT.UPDATED_BY%TYPE
14:33:49  66  );
14:33:49  67  
14:33:49  68  PROCEDURE MARK_RECEIPT_CHECKED(
14:33:49  69  /*
14:33:49  70  Throws exceptions:
14:33:49  71  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  72  */
14:33:49  73  	  in_id       IN ITUNES_RECEIPT.ID%TYPE
14:33:49  74  );
14:33:49  75  
14:33:49  76  PROCEDURE GET_ITUNES_RECEIPTS (
14:33:49  77  /*
14:33:49  78  Throws exceptions:
14:33:49  79  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  80  */
14:33:49  81  	out_result_set	    OUT SYS_REFCURSOR,
14:33:49  82  	in_row_number	    IN NUMBER DEFAULT 500
14:33:49  83  );
14:33:49  84  
14:33:49  85  PROCEDURE GET_VENDOR_FROM_ITUNES_PID(
14:33:49  86  /*
14:33:49  87  Throws exceptions:
14:33:49  88  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  89  */
14:33:49  90  	  out_vendor_source_id OUT OFFER_CHAIN.VENDOR_SOURCE_ID%TYPE,
14:33:49  91  	  in_itunes_pid        IN ITUNES_RECEIPT.PRODUCT_ID%TYPE
14:33:49  92  );
14:33:49  93  
14:33:49  94  END PROCS_ITUNES_RECEIPT_V22;
14:33:49  95  .
14:33:49 SQL> /

Package created.

Elapsed: 00:00:00.04
14:33:49 SQL> 
14:33:49 SQL> /*
14:33:49 SQL> CREATE TABLE ITUNES_RECEIPT (
14:33:49 SQL> 	id NUMBER NOT NULL ENABLE,
14:33:49 SQL> 	subscription_id NUMBER NOT NULL ENABLE,
14:33:49 SQL> 	receipt VARCHAR(1024) NOT NULL ENABLE,
14:33:49 SQL> 	status NUMBER,
14:33:49 SQL> 	quantity NUMBER,
14:33:49 SQL> 	product_id VARCHAR(1024),
14:33:49 SQL> 	transaction_id VARCHAR(1024),
14:33:49 SQL> 	purchase_date TIMESTAMP,
14:33:49 SQL> 	original_transaction_id VARCHAR(1024),
14:33:49 SQL> 	original_purchase_date TIMESTAMP,
14:33:49 SQL> 	app_item_id VARCHAR(1024),
14:33:49 SQL> 	version_external_id NUMBER,
14:33:49 SQL> 	bid VARCHAR(1024),
14:33:49 SQL> 	bvrs VARCHAR(255),
14:33:49 SQL> 	expires_date TIMESTAMP,
14:33:49 SQL> 	create_date DATE NOT NULL,
14:33:49 SQL> 	created_by VARCHAR(255) NOT NULL,
14:33:49 SQL> 	update_date DATE NOT NULL,
14:33:49 SQL> 	updated_by VARCHAR(255) NOT NULL,
14:33:49 SQL> 	last_check_date DATE NOT NULL,
14:33:49 SQL> 	CONSTRAINT "ITUNESRECEIPT_PK" PRIMARY KEY ("ID") USING INDEX TABLESPACE "CORE_IDX" ENABLE,
14:33:49 SQL> 	CONSTRAINT "ITUNESRECEIPT_SUBID_FK" FOREIGN KEY ("SUBSCRIPTION_ID") REFERENCES SUBSCRIPTION(ID) USING INDEX TABLESPACE "CORE_IDX" ENABLE,
14:33:49 SQL> 	CONSTRAINT "ITUNESRECEIPT_RECEIPT_UK" UNIQUE(receipt) USING INDEX TABLESPACE "CORE_IDX" ENABLE,
14:33:49 SQL> 	CONSTRAINT "ITUNESRECEIPT_SUBID_UK" UNIQUE(subscription_id) USING INDEX TABLESPACE "CORE_IDX" ENABLE
14:33:49 SQL> )
14:33:49 SQL> TABLESPACE CORE;
14:33:49 SQL> */
14:33:49 SQL> 
14:33:49 SQL> 
14:33:49 SQL> CREATE OR REPLACE PACKAGE "PROCS_ITUNES_RECEIPT_CRU_V22" AS
14:33:49   2  
14:33:49   3  PROCEDURE CREATE_RECEIPT(
14:33:49   4  /*
14:33:49   5  Throws exceptions:
14:33:49   6  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49   7  */
14:33:49   8  	  out_id	      OUT NUMBER,
14:33:49   9  	  in_subscription_id  IN CORE_OWNER.ITUNES_RECEIPT.SUBSCRIPTION_ID%TYPE,
14:33:49  10  	  in_receipt	      IN CORE_OWNER.ITUNES_RECEIPT.RECEIPT%TYPE,
14:33:49  11  	  in_status	      IN CORE_OWNER.ITUNES_RECEIPT.STATUS%TYPE,
14:33:49  12  	  in_quantity	      IN CORE_OWNER.ITUNES_RECEIPT.QUANTITY%TYPE,
14:33:49  13  	  in_product_id       IN CORE_OWNER.ITUNES_RECEIPT.PRODUCT_ID%TYPE,
14:33:49  14  	  in_transaction_id   IN CORE_OWNER.ITUNES_RECEIPT.TRANSACTION_ID%TYPE,
14:33:49  15  	  in_purchase_date    IN CORE_OWNER.ITUNES_RECEIPT.PURCHASE_DATE%TYPE,
14:33:49  16  	  in_original_transaction_id IN CORE_OWNER.ITUNES_RECEIPT.ORIGINAL_TRANSACTION_ID%TYPE,
14:33:49  17  	  in_original_purchase_date IN CORE_OWNER.ITUNES_RECEIPT.ORIGINAL_PURCHASE_DATE%TYPE,
14:33:49  18  	  in_app_item_id      IN CORE_OWNER.ITUNES_RECEIPT.APP_ITEM_ID%TYPE,
14:33:49  19  	  in_version_external_id IN CORE_OWNER.ITUNES_RECEIPT.VERSION_EXTERNAL_ID%TYPE,
14:33:49  20  	  in_bid	      IN CORE_OWNER.ITUNES_RECEIPT.BID%TYPE,
14:33:49  21  	  in_bvrs	      IN CORE_OWNER.ITUNES_RECEIPT.BVRS%TYPE,
14:33:49  22  	  in_expires_date     IN CORE_OWNER.ITUNES_RECEIPT.EXPIRES_DATE%TYPE,
14:33:49  23  	  in_created_by       IN CORE_OWNER.ITUNES_RECEIPT.CREATED_BY%TYPE
14:33:49  24  );
14:33:49  25  
14:33:49  26  PROCEDURE UPDATE_RECEIPT(
14:33:49  27  /*
14:33:49  28  Throws exceptions:
14:33:49  29  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  30  */
14:33:49  31  	  in_id 	      IN CORE_OWNER.ITUNES_RECEIPT.ID%TYPE,
14:33:49  32  	  in_receipt	      IN CORE_OWNER.ITUNES_RECEIPT.RECEIPT%TYPE,
14:33:49  33  	  in_status	      IN CORE_OWNER.ITUNES_RECEIPT.STATUS%TYPE,
14:33:49  34  	  in_quantity	      IN CORE_OWNER.ITUNES_RECEIPT.QUANTITY%TYPE,
14:33:49  35  	  in_product_id       IN CORE_OWNER.ITUNES_RECEIPT.PRODUCT_ID%TYPE,
14:33:49  36  	  in_transaction_id   IN CORE_OWNER.ITUNES_RECEIPT.TRANSACTION_ID%TYPE,
14:33:49  37  	  in_purchase_date    IN CORE_OWNER.ITUNES_RECEIPT.PURCHASE_DATE%TYPE,
14:33:49  38  	  in_original_transaction_id IN CORE_OWNER.ITUNES_RECEIPT.ORIGINAL_TRANSACTION_ID%TYPE,
14:33:49  39  	  in_original_purchase_date IN CORE_OWNER.ITUNES_RECEIPT.ORIGINAL_PURCHASE_DATE%TYPE,
14:33:49  40  	  in_app_item_id      IN CORE_OWNER.ITUNES_RECEIPT.APP_ITEM_ID%TYPE,
14:33:49  41  	  in_version_external_id IN CORE_OWNER.ITUNES_RECEIPT.VERSION_EXTERNAL_ID%TYPE,
14:33:49  42  	  in_bid	      IN CORE_OWNER.ITUNES_RECEIPT.BID%TYPE,
14:33:49  43  	  in_bvrs	      IN CORE_OWNER.ITUNES_RECEIPT.BVRS%TYPE,
14:33:49  44  	  in_expires_date     IN CORE_OWNER.ITUNES_RECEIPT.EXPIRES_DATE%TYPE,
14:33:49  45  	  in_updated_by       IN CORE_OWNER.ITUNES_RECEIPT.UPDATED_BY%TYPE,
14:33:49  46  	  in_cancel_date      IN CORE_OWNER.ITUNES_RECEIPT.CANCEL_DATE%TYPE
14:33:49  47  );
14:33:49  48  
14:33:49  49  PROCEDURE LINK_ITUNES_RECEIPT(
14:33:49  50  /*
14:33:49  51  Throws exceptions:
14:33:49  52  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  53  */
14:33:49  54  	  in_id 	      IN CORE_OWNER.ITUNES_RECEIPT.ID%TYPE,
14:33:49  55  	  in_subscription_id  IN CORE_OWNER.ITUNES_RECEIPT.SUBSCRIPTION_ID%TYPE,
14:33:49  56  	  in_updated_by       IN CORE_OWNER.ITUNES_RECEIPT.UPDATED_BY%TYPE
14:33:49  57  );
14:33:49  58  
14:33:49  59  PROCEDURE MARK_RECEIPT_CHECKED(
14:33:49  60  /*
14:33:49  61  Throws exceptions:
14:33:49  62  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  63  */
14:33:49  64  	  in_id 	      IN CORE_OWNER.ITUNES_RECEIPT.ID%TYPE
14:33:49  65  );
14:33:49  66  
14:33:49  67  END PROCS_ITUNES_RECEIPT_CRU_V22;
14:33:49  68  .
14:33:49 SQL> /

Package created.

Elapsed: 00:00:00.03
14:33:49 SQL> 
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> -- DDL for package PROCS_LICENSE
14:33:49 SQL> --------------------------------------------------------------------------------
14:33:49 SQL> 
14:33:49 SQL> CREATE OR REPLACE PACKAGE "PROCS_LICENSE_V22" AS
14:33:49   2  
14:33:49   3  PROCEDURE CREATE_LICENSE(
14:33:49   4  /*
14:33:49   5  Throws exceptions:
14:33:49   6  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:49   7  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49   8  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:49   9  */
14:33:49  10  	in_status_id		    IN NUMBER,
14:33:49  11  	in_needs_entitlements	    IN NUMBER,
14:33:49  12  	in_start_date		    IN DATE,
14:33:49  13  	in_end_date		    IN DATE,
14:33:49  14  	in_offer_id		    IN NUMBER,
14:33:49  15  	in_subscription_id	    IN NUMBER,
14:33:49  16  	in_invoice_id		    IN NUMBER,
14:33:49  17  	in_created_by		    IN VARCHAR2,
14:33:49  18  	in_is_extension 	    IN NUMBER,
14:33:49  19  	in_current_offer_index	    IN NUMBER,
14:33:49  20  	in_current_offer_recurr_num IN NUMBER,
14:33:49  21  	out_license_id		    OUT NUMBER
14:33:49  22  );
14:33:49  23  
14:33:49  24  /*********************************************/
14:33:49  25  
14:33:49  26  PROCEDURE UPDATE_LICENSE_STATUS(
14:33:49  27  /*
14:33:49  28  Throws exceptions:
14:33:49  29  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:49  30  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:49  31  */
14:33:49  32  	  in_license_id     IN NUMBER,
14:33:49  33  	  in_license_status IN NUMBER,
14:33:49  34  	  in_updated_by     IN VARCHAR2,
14:33:49  35  	  in_ent_end	    IN NUMBER DEFAULT GLOBAL_CONSTANTS_V22.FALSE
14:33:49  36  );
14:33:49  37  
14:33:49  38  /*********************************************/
14:33:49  39  
14:33:49  40  PROCEDURE GET_ENDING_LICENSES (
14:33:49  41  	in_hours_number IN NUMBER,
14:33:49  42  	out_result_set OUT SYS_REFCURSOR
14:33:49  43  );
14:33:49  44  
14:33:49  45  /*********************************************/
14:33:49  46  
14:33:49  47  PROCEDURE GET_ENDING_LICENSES_CC (
14:33:49  48  	in_hours_number IN NUMBER,
14:33:49  49  	out_result_set OUT SYS_REFCURSOR,
14:33:49  50  	in_process_name IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE
14:33:49  51  );
14:33:49  52  
14:33:49  53  /**********************************************/
14:33:49  54  
14:33:49  55  PROCEDURE GET_RECURRING_OFFER (
14:33:49  56  	in_license_id  IN NUMBER,
14:33:49  57  	out_result_set OUT SYS_REFCURSOR
14:33:49  58  );
14:33:49  59  
14:33:49  60  /**********************************************/
14:33:49  61  
14:33:49  62  PROCEDURE GET_NEXT_OFFER (
14:33:49  63  	in_license_id  IN NUMBER,
14:33:49  64  	out_result_set OUT SYS_REFCURSOR
14:33:49  65  );
14:33:49  66  
14:33:49  67  /**********************************************/
14:33:49  68  
14:33:49  69  PROCEDURE GET_GROUP_ID_BY_LICENSE_ID (
14:33:49  70  	in_license_id IN NUMBER,
14:33:49  71  	out_group_id  OUT NUMBER
14:33:49  72  );
14:33:49  73  
14:33:49  74  /**************************************************/
14:33:49  75  
14:33:49  76  PROCEDURE GET_NEED_ENTITLEMENTS_LICENSES (
14:33:49  77  	out_result_set OUT SYS_REFCURSOR
14:33:49  78  );
14:33:49  79  
14:33:49  80  /**************************************************/
14:33:49  81  
14:33:49  82  PROCEDURE UPDATE_NEED_ENTITLEMENTS_FLAG (
14:33:49  83  	in_license_id	      IN NUMBER,
14:33:49  84  	in_needs_entitlements IN NUMBER,
14:33:49  85  	in_updated_by	      IN VARCHAR2
14:33:49  86  );
14:33:49  87  
14:33:49  88  PROCEDURE GET_ENDED_GC_LICENSES (
14:33:49  89  	out_result_set		OUT SYS_REFCURSOR,
14:33:49  90  	in_hours_number 	IN NUMBER DEFAULT 14*24,
14:33:49  91  	in_num_rows		IN NUMBER DEFAULT 10000,
14:33:49  92  	in_process_name 	IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE
14:33:49  93  );
14:33:49  94  
14:33:49  95  PROCEDURE GET_LICENSE_BY_ID (
14:33:49  96  
14:33:49  97  	in_license_id  IN NUMBER,
14:33:49  98  
14:33:49  99  	out_result_set OUT SYS_REFCURSOR
14:33:49 100  
14:33:49 101  );
14:33:49 102  PROCEDURE UP_LATEST_LICE_END_BY_SUBID (
14:33:49 103  	in_subscription_id IN NUMBER,
14:33:49 104  	in_end_date IN DATE,
14:33:49 105  	in_updated_by IN VARCHAR2
14:33:49 106  );
14:33:49 107  
14:33:49 108  PROCEDURE GET_GRACE_LICE_FOR_FINAL_TRANS (
14:33:49 109  	in_days_before_close	 IN NUMBER,
14:33:49 110  	in_num_licenses_to_fetch IN NUMBER,
14:33:49 111  	out_result_set		 OUT SYS_REFCURSOR
14:33:49 112  );
14:33:49 113  
14:33:49 114  END PROCS_LICENSE_V22;
14:33:49 115  .
14:33:49 SQL> /

Package created.

Elapsed: 00:00:00.03
14:33:50 SQL> 
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> -- DDL for package PROCS_LICENSE_CRU
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> 
14:33:50 SQL> CREATE OR REPLACE PACKAGE "PROCS_LICENSE_CRU_V22" AS
14:33:50   2  
14:33:50   3  PROCEDURE CREATE_LICENSE(
14:33:50   4  	out_license_id		    OUT LICENSE.ID%TYPE,
14:33:50   5  	in_license_id		    IN LICENSE.ID%TYPE DEFAULT NULL,
14:33:50   6  	in_license_status_id	    IN LICENSE.LICENSE_STATUS_ID%TYPE,
14:33:50   7  	in_needs_entitlements	    IN LICENSE.NEEDS_ENTITLEMENTS%TYPE,
14:33:50   8  	in_start_date		    IN LICENSE.START_DATE%TYPE,
14:33:50   9  	in_offer_id		    IN LICENSE.OFFER_ID%TYPE,
14:33:50  10  	in_subscription_id	    IN LICENSE.SUBSCRIPTION_ID%TYPE,
14:33:50  11  	in_invoice_id		    IN LICENSE.INVOICE_ID%TYPE,
14:33:50  12  	in_end_date		    IN LICENSE.END_DATE%TYPE,
14:33:50  13  	in_created_by		    IN LICENSE.CREATED_BY%TYPE,
14:33:50  14  	in_is_extension 	    IN LICENSE.IS_EXTENSION%TYPE,
14:33:50  15  	in_current_offer_index	    IN LICENSE.CURRENT_OFFER_INDEX%TYPE,
14:33:50  16  	in_current_offer_recurr_num IN LICENSE.CURRENT_OFFER_RECURR_NUM%TYPE
14:33:50  17  );
14:33:50  18  
14:33:50  19  PROCEDURE UPDATE_LICENSE (
14:33:50  20  	in_license_id		    IN LICENSE.ID%TYPE,
14:33:50  21  	in_license_status_id	    IN LICENSE.LICENSE_STATUS_ID%TYPE DEFAULT NULL,
14:33:50  22  	in_needs_entitlements	    IN LICENSE.NEEDS_ENTITLEMENTS%TYPE DEFAULT NULL,
14:33:50  23  	in_start_date		    IN LICENSE.START_DATE%TYPE DEFAULT NULL,
14:33:50  24  	in_end_date		    IN LICENSE.END_DATE%TYPE DEFAULT NULL,
14:33:50  25  	in_updated_by		    IN LICENSE.CREATED_BY%TYPE,
14:33:50  26  	in_is_extension 	    IN LICENSE.IS_EXTENSION%TYPE DEFAULT NULL,
14:33:50  27  	in_current_offer_index	    IN LICENSE.CURRENT_OFFER_INDEX%TYPE DEFAULT NULL,
14:33:50  28  	in_current_offer_recurr_num IN LICENSE.CURRENT_OFFER_RECURR_NUM%TYPE DEFAULT NULL,
14:33:50  29  	in_entitlement_end_date     IN LICENSE.ENTITLEMENT_END_DATE%TYPE DEFAULT NULL,
14:33:50  30  	in_grace_start_date	    IN LICENSE.GRACE_START_DATE%TYPE DEFAULT NULL,
14:33:50  31  	in_grace_end_date	    IN LICENSE.GRACE_END_DATE%TYPE DEFAULT NULL
14:33:50  32  );
14:33:50  33  
14:33:50  34  END PROCS_LICENSE_CRU_V22;
14:33:50  35  .
14:33:50 SQL> /

Package created.

Elapsed: 00:00:00.04
14:33:50 SQL> 
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> -- DDL for package PROCS_LINE_ITEMS
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> 
14:33:50 SQL> CREATE OR REPLACE PACKAGE "PROCS_LINE_ITEMS_V22" AS
14:33:50   2  
14:33:50   3  PROCEDURE ADD_LINE_ITEMS(
14:33:50   4  /*
14:33:50   5  Throws exceptions:
14:33:50   6  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50   7  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50   8  */
14:33:50   9  	in_invoice_id IN NUMBER,
14:33:50  10  	in_offer_id   IN NUMBER,
14:33:50  11  	in_created_by IN VARCHAR2
14:33:50  12  );
14:33:50  13  
14:33:50  14  /****************************************************/
14:33:50  15  
14:33:50  16  PROCEDURE UPDATE_LINE_ITEM_AMOUNT (
14:33:50  17  	in_line_item_id    IN NUMBER,
14:33:50  18  	in_amount	   IN NUMBER,
14:33:50  19  	in_discount_amount IN NUMBER,
14:33:50  20  	in_taxes_amount    IN NUMBER
14:33:50  21  );
14:33:50  22  
14:33:50  23  /****************************************************/
14:33:50  24  
14:33:50  25  PROCEDURE GET_INVOICE_LINE_ITEMS (
14:33:50  26  /*
14:33:50  27  Throws exceptions:
14:33:50  28  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50  29  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50  30  */
14:33:50  31  	in_invoice_id  IN NUMBER,
14:33:50  32  	out_result_set OUT SYS_REFCURSOR
14:33:50  33  );
14:33:50  34  
14:33:50  35  /****************************************************/
14:33:50  36  
14:33:50  37  PROCEDURE GET_LINE_ITEM_TAXES (
14:33:50  38  /*
14:33:50  39  Throws exceptions:
14:33:50  40  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50  41  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50  42  */
14:33:50  43  	in_line_item_id IN  NUMBER,
14:33:50  44  	out_result_set	OUT SYS_REFCURSOR
14:33:50  45  );
14:33:50  46  /****************************************************/
14:33:50  47  
14:33:50  48  PROCEDURE GET_LINE_ITEM_DISCOUNTS (
14:33:50  49  /*
14:33:50  50  Throws exceptions:
14:33:50  51  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50  52  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50  53  */
14:33:50  54  	in_line_item_id IN  NUMBER,
14:33:50  55  	out_result_set	OUT SYS_REFCURSOR
14:33:50  56  );
14:33:50  57  
14:33:50  58  /****************************************************/
14:33:50  59  
14:33:50  60  PROCEDURE CALCULATE_LINE_ITEM_AMOUNT (
14:33:50  61  /*
14:33:50  62  Throws exceptions:
14:33:50  63  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50  64  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50  65  */
14:33:50  66  	in_line_item_id     IN	NUMBER,
14:33:50  67  	out_amount	    OUT NUMBER
14:33:50  68  );
14:33:50  69  
14:33:50  70  /****************************************************/
14:33:50  71  
14:33:50  72  FUNCTION F_CALCULATE_LINE_ITEM_AMOUNT (
14:33:50  73  /*
14:33:50  74  Throws exceptions:
14:33:50  75  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50  76  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50  77  */
14:33:50  78  	in_line_item_id     IN	NUMBER
14:33:50  79  ) RETURN NUMBER;
14:33:50  80  
14:33:50  81  END PROCS_LINE_ITEMS_V22;
14:33:50  82  .
14:33:50 SQL> /

Package created.

Elapsed: 00:00:00.03
14:33:50 SQL> 
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> -- DDL for package PROCS_LINE_ITEMS_CRU
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> 
14:33:50 SQL> CREATE OR REPLACE PACKAGE "PROCS_LINE_ITEMS_CRU_V22" AS
14:33:50   2  
14:33:50   3  PROCEDURE CREATE_LINE_ITEM (
14:33:50   4  	inout_line_item_id  IN OUT LINE_ITEM.ID%TYPE,
14:33:50   5  	in_product_offer_id IN LINE_ITEM.PRODUCT_OFFER_ID%TYPE,
14:33:50   6  	in_invoice_id	    IN LINE_ITEM.INVOICE_ID%TYPE,
14:33:50   7  	in_amount	    IN LINE_ITEM.AMOUNT%TYPE,
14:33:50   8  	in_created_by	    IN LINE_ITEM.CREATED_BY%TYPE,
14:33:50   9  	in_discount_amount  IN LINE_ITEM.DISCOUNT_AMOUNT%TYPE,
14:33:50  10  	in_taxes_amount     IN LINE_ITEM.TAXES_AMOUNT%TYPE
14:33:50  11  );
14:33:50  12  
14:33:50  13  PROCEDURE UPDATE_LINE_ITEM (
14:33:50  14  	in_line_item_id     IN LINE_ITEM.ID%TYPE,
14:33:50  15  	in_amount	    IN LINE_ITEM.AMOUNT%TYPE DEFAULT NULL,
14:33:50  16  	in_discount_amount  IN LINE_ITEM.DISCOUNT_AMOUNT%TYPE  DEFAULT NULL,
14:33:50  17  	in_taxes_amount     IN LINE_ITEM.TAXES_AMOUNT%TYPE DEFAULT NULL
14:33:50  18  );
14:33:50  19  
14:33:50  20  PROCEDURE CREATE_DISCOUNT_LINE_ITEM (
14:33:50  21  	in_discount_id	IN DISCOUNT.ID%TYPE,
14:33:50  22  	in_line_item_id IN LINE_ITEM.ID%TYPE
14:33:50  23  );
14:33:50  24  
14:33:50  25  END PROCS_LINE_ITEMS_CRU_V22;
14:33:50  26  .
14:33:50 SQL> /

Package created.

Elapsed: 00:00:00.03
14:33:50 SQL> 
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> -- DDL for package PROCS_LOCKING
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> 
14:33:50 SQL> CREATE OR REPLACE PACKAGE "PROCS_LOCKING_V22" AS
14:33:50   2  
14:33:50   3  /*
14:33:50   4  Removed by Sergey
14:33:50   5  10.12.2010
14:33:50   6  PROCEDURE INITIALIZE_SYSTEM;
14:33:50   7  
14:33:50   8  PROCEDURE INITIALIZE_ACCOUNT (
14:33:50   9  	in_account_id IN NUMBER
14:33:50  10  );
14:33:50  11  
14:33:50  12  PROCEDURE INITIALIZE_GROUP (
14:33:50  13  	in_group_id IN NUMBER
14:33:50  14  );
14:33:50  15  */
14:33:50  16  
14:33:50  17  PROCEDURE LOCK_ACCOUNT (
14:33:50  18  	in_group_id    IN NUMBER,
14:33:50  19  	in_lock_key    IN VARCHAR2,
14:33:50  20  	in_seconds_num IN NUMBER,
14:33:50  21  	in_created_by  IN VARCHAR2,
14:33:50  22  	in_reason      IN VARCHAR2
14:33:50  23  );
14:33:50  24  
14:33:50  25  PROCEDURE RELEASE_LOCK (
14:33:50  26  	in_group_id IN NUMBER,
14:33:50  27  	in_lock_key IN VARCHAR2
14:33:50  28  );
14:33:50  29  
14:33:50  30  END PROCS_LOCKING_V22;
14:33:50  31  .
14:33:50 SQL> /

Package created.

Elapsed: 00:00:00.02
14:33:50 SQL> 
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> -- DDL for package PROCS_NOTIFICATION
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> 
14:33:50 SQL> CREATE OR REPLACE PACKAGE "PROCS_NOTIFICATION_V22" AS
14:33:50   2  
14:33:50   3  PROCEDURE GET_NOTIFICATION_TYPE_BY_NAME (
14:33:50   4  /*
14:33:50   5  Throws exceptions:
14:33:50   6  CORE_OWNER.APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50   7  CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50   8  */
14:33:50   9  	in_notification_type_name IN VARCHAR2,
14:33:50  10  	out_notification_type_id  OUT NUMBER
14:33:50  11  );
14:33:50  12  
14:33:50  13  PROCEDURE ADD_NOTIFICATION (
14:33:50  14  /*
14:33:50  15  Throws exceptions:
14:33:50  16  CORE_OWNER.APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50  17  CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50  18  */
14:33:50  19  	in_sender_account_id	 IN NUMBER DEFAULT 0,
14:33:50  20  	in_recipient_group_id	 IN NUMBER,
14:33:50  21  	in_notification_type_id  IN NUMBER,
14:33:50  22  	in_date_to_notify	 IN DATE,
14:33:50  23  	in_email_template_params IN CLOB
14:33:50  24  );
14:33:50  25  
14:33:50  26  PROCEDURE GET_PENDING_NOTIFICATIONS (
14:33:50  27  /*
14:33:50  28  Throws exceptions:
14:33:50  29  CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50  30  */
14:33:50  31  	out_result_set OUT SYS_REFCURSOR
14:33:50  32  );
14:33:50  33  
14:33:50  34  PROCEDURE UPDATE_NOTIFICATION_TIMESTAMP (
14:33:50  35  /*
14:33:50  36  Throws exceptions:
14:33:50  37  CORE_OWNER.APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50  38  CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50  39  */
14:33:50  40  	in_notification_id IN NUMBER
14:33:50  41  );
14:33:50  42  
14:33:50  43  PROCEDURE SET_NOTIFICATION_STATUS (
14:33:50  44  /*
14:33:50  45  Throws exceptions:
14:33:50  46  CORE_OWNER.APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50  47  CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50  48  */
14:33:50  49  	in_notification_id	  IN NUMBER,
14:33:50  50  	in_notification_status_id IN NUMBER,
14:33:50  51  	in_error_message	  IN VARCHAR2
14:33:50  52  );
14:33:50  53  
14:33:50  54  PROCEDURE ADD_NOTIFICATION_FAILURE (
14:33:50  55  /*
14:33:50  56  Throws exceptions:
14:33:50  57  CORE_OWNER.APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50  58  CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50  59  */
14:33:50  60  	in_notification_id IN NUMBER,
14:33:50  61  	in_error_message   IN VARCHAR2
14:33:50  62  );
14:33:50  63  
14:33:50  64  PROCEDURE LOCK_PENDING_NOTIFICATION (
14:33:50  65  /*
14:33:50  66  Result: 1 if notification locked
14:33:50  67  2 - else
14:33:50  68  */
14:33:50  69  	in_notification_id IN NUMBER,
14:33:50  70  	out_lock_status    OUT NUMBER
14:33:50  71  );
14:33:50  72  
14:33:50  73  PROCEDURE GET_NOTIFICATION_DATA (
14:33:50  74  	in_notification_id IN NUMBER,
14:33:50  75  	out_result_set	   OUT SYS_REFCURSOR
14:33:50  76  );
14:33:50  77  
14:33:50  78  END PROCS_NOTIFICATION_V22;
14:33:50  79  .
14:33:50 SQL> /

Package created.

Elapsed: 00:00:00.02
14:33:50 SQL> 
14:33:50 SQL> CREATE OR REPLACE PACKAGE "PROCS_OFFER_CHAIN_V22" AS
14:33:50   2  
14:33:50   3  PROCEDURE OC_ID_BY_ITUNES_PRODUCT_ID(
14:33:50   4  	in_itunes_product_id IN  OFFER_CHAIN.ITUNES_PRODUCT_ID%TYPE,
14:33:50   5  	out_data	     OUT OFFER_CHAIN.ID%TYPE
14:33:50   6  );
14:33:50   7  
14:33:50   8  PROCEDURE OFFER_CHAIN_ID_BY_AMAZON_SKU(
14:33:50   9  	in_amazon_appstore_sku IN  OFFER_CHAIN.AMAZON_APPSTORE_SKU%TYPE,
14:33:50  10  	out_data	       OUT OFFER_CHAIN.ID%TYPE
14:33:50  11  );
14:33:50  12  
14:33:50  13  PROCEDURE GET_OFFER_CHAIN_BY_ID (
14:33:50  14  	  in_offer_chain_id IN	 NUMBER,
14:33:50  15  	  out_result_set    OUT  SYS_REFCURSOR
14:33:50  16  );
14:33:50  17  
14:33:50  18  PROCEDURE GET_OFFER_CHAINS_BY_IDS (
14:33:50  19  	in_offer_chain_ids IN core_owner.NUMBER_TABLE,
14:33:50  20  	out_result_set	   OUT SYS_REFCURSOR
14:33:50  21  );
14:33:50  22  
14:33:50  23  PROCEDURE GET_OFFER_CHAINS_PRODUCTS (
14:33:50  24  	in_offer_chain_ids IN core_owner.NUMBER_TABLE,
14:33:50  25  	out_result_set	   OUT SYS_REFCURSOR
14:33:50  26  );
14:33:50  27  
14:33:50  28  PROCEDURE GET_OFFER_CHAINS_OFFERS (
14:33:50  29  	in_offer_chain_ids IN core_owner.NUMBER_TABLE,
14:33:50  30  	out_result_set	   OUT SYS_REFCURSOR
14:33:50  31  );
14:33:50  32  
14:33:50  33  PROCEDURE GET_OFFER_CHAINS_BY_PRODUCT (
14:33:50  34  	in_product_id  IN  NUMBER,
14:33:50  35  	out_result_set OUT SYS_REFCURSOR
14:33:50  36  );
14:33:50  37  
14:33:50  38  PROCEDURE GET_OFFER_CHAIN_PRICE (
14:33:50  39  	in_offer_chain_id IN NUMBER,
14:33:50  40  	out_price	  OUT NUMBER
14:33:50  41  );
14:33:50  42  
14:33:50  43  PROCEDURE GET_FIRST_OFFER(
14:33:50  44  	in_offer_chain_id IN  NUMBER,
14:33:50  45  	out_offer_id	  OUT NUMBER
14:33:50  46  );
14:33:50  47  
14:33:50  48  PROCEDURE GET_ACTIVE_OFFER_CHAINS (
14:33:50  49  	out_result_set OUT SYS_REFCURSOR
14:33:50  50  );
14:33:50  51  
14:33:50  52  PROCEDURE GET_OFFER_CHAIN_PRODUCTS (
14:33:50  53  	in_offer_chain_id IN NUMBER,
14:33:50  54  	out_result_set	  OUT SYS_REFCURSOR
14:33:50  55  );
14:33:50  56  
14:33:50  57  FUNCTION CALCULATE_OFFER_CHAIN_END_DATE (
14:33:50  58  	in_offer_chain_id	  IN NUMBER,
14:33:50  59  	in_offer_chain_start_date IN DATE
14:33:50  60  ) RETURN DATE;
14:33:50  61  
14:33:50  62  FUNCTION CALCULATE_OFFER_AMOUNT (
14:33:50  63  	in_offer_id IN NUMBER
14:33:50  64  ) RETURN NUMBER;
14:33:50  65  
14:33:50  66  FUNCTION CALCULATE_OFFER_CHAIN_AMOUNT (
14:33:50  67  	in_offer_chain_id IN NUMBER
14:33:50  68  ) RETURN NUMBER;
14:33:50  69  
14:33:50  70  FUNCTION GET_FIRST_OFFER_INDEX (
14:33:50  71  	in_offer_chain_id IN NUMBER
14:33:50  72  ) RETURN NUMBER;
14:33:50  73  
14:33:50  74  FUNCTION GET_NEXT_OFFER_INDEX (
14:33:50  75  	in_offer_chain_id	     IN NUMBER,
14:33:50  76  	in_offer_chain_current_index IN NUMBER
14:33:50  77  ) RETURN NUMBER;
14:33:50  78  
14:33:50  79  PROCEDURE P_GET_NEXT_OFFER_INDEX (
14:33:50  80  	in_offer_chain_id	     IN NUMBER,
14:33:50  81  	in_offer_chain_current_index IN NUMBER,
14:33:50  82  	out_next_offer_index	     OUT NUMBER
14:33:50  83  );
14:33:50  84  
14:33:50  85  PROCEDURE GET_NEXT_OFFER_INDEX_BY_LCNS (
14:33:50  86  	in_license_id		     IN NUMBER,
14:33:50  87  	in_offer_chain_current_index IN NUMBER,
14:33:50  88  	out_next_offer_index	     OUT NUMBER
14:33:50  89  );
14:33:50  90  
14:33:50  91  FUNCTION IS_OFFER_INDEX_EXISTS (
14:33:50  92  	in_offer_chain_id	   IN NUMBER,
14:33:50  93  	in_offer_chain_offer_index IN NUMBER
14:33:50  94  ) RETURN NUMBER;
14:33:50  95  
14:33:50  96  PROCEDURE GET_OFFER_LENGTH (
14:33:50  97  	in_offer_id IN NUMBER,
14:33:50  98  	out_years   OUT NUMBER,
14:33:50  99  	out_months  OUT NUMBER,
14:33:50 100  	out_days    OUT NUMBER
14:33:50 101  );
14:33:50 102  
14:33:50 103  PROCEDURE GET_OFFER_LENGTH_IN_DAYS (
14:33:50 104  	in_offer_id   IN NUMBER,
14:33:50 105  	in_start_date IN DATE DEFAULT SYSDATE,
14:33:50 106  	out_days      OUT NUMBER
14:33:50 107  );
14:33:50 108  
14:33:50 109  PROCEDURE GET_OFFER_PRODUCTS (
14:33:50 110  	in_offer_id    IN NUMBER,
14:33:50 111  	out_result_set OUT SYS_REFCURSOR
14:33:50 112  );
14:33:50 113  
14:33:50 114  PROCEDURE GET_OFFER_CHAIN_PROD_OFFERINGS (
14:33:50 115  	in_offer_chain_id IN NUMBER,
14:33:50 116  	out_result_set	  OUT SYS_REFCURSOR
14:33:50 117  );
14:33:50 118  
14:33:50 119  FUNCTION CHECK_FOR_SAME_PRODUCTS (
14:33:50 120  	in_offer_chain_1	 IN OFFER_CHAIN.ID%TYPE,
14:33:50 121  	in_offer_chain_2	 IN OFFER_CHAIN.ID%TYPE,
14:33:50 122  	in_use_eligibility_rules IN NUMBER DEFAULT GLOBAL_CONSTANTS_V22.FALSE
14:33:50 123  ) RETURN NUMBER;
14:33:50 124  
14:33:50 125  FUNCTION IS_OFFER_CHAIN_CANCELABLE (
14:33:50 126  	in_offer_chain_id IN NUMBER
14:33:50 127  ) RETURN NUMBER;
14:33:50 128  
14:33:50 129  FUNCTION GET_OFFER_CHAIN_MAX_CONC_SUBSC (
14:33:50 130  	in_offer_chain_id IN NUMBER
14:33:50 131  ) RETURN NUMBER;
14:33:50 132  
14:33:50 133  PROCEDURE GET_OFFER_CHAIN_ELIGIBILITY (
14:33:50 134  	in_offer_chain_id   IN NUMBER,
14:33:50 135  	in_eligibility_name IN VARCHAR2,
14:33:50 136  	out_result_set	    OUT SYS_REFCURSOR
14:33:50 137  );
14:33:50 138  
14:33:50 139  PROCEDURE GET_OFFER_CHAINS_ELIGIBILITY (
14:33:50 140  	in_offer_chain_ids  IN VARCHAR2,
14:33:50 141  	in_eligibility_name IN VARCHAR2,
14:33:50 142  	out_result_set	    OUT SYS_REFCURSOR
14:33:50 143  );
14:33:50 144  
14:33:50 145  PROCEDURE GET_OFFER_CHAIN_META_DATA (
14:33:50 146  	in_offer_chain_id IN NUMBER,
14:33:50 147  	in_meta_data_name IN VARCHAR2,
14:33:50 148  	out_result_set	  OUT SYS_REFCURSOR
14:33:50 149  );
14:33:50 150  
14:33:50 151  PROCEDURE GET_OFFER_CHAINS_META_DATA (
14:33:50 152  	in_offer_chain_ids IN VARCHAR2,
14:33:50 153  	in_meta_data_name  IN VARCHAR2,
14:33:50 154  	out_result_set	   OUT SYS_REFCURSOR
14:33:50 155  );
14:33:50 156  
14:33:50 157  PROCEDURE GET_PROD_OFFERINGS_BY_OFFER_ID (
14:33:50 158  	in_offer_id    IN NUMBER,
14:33:50 159  	out_result_set OUT SYS_REFCURSOR
14:33:50 160  );
14:33:50 161  
14:33:50 162  PROCEDURE GET_PRODUCT_OFFERING_META_DATA (
14:33:50 163  	in_product_offering_id IN NUMBER,
14:33:50 164  	in_meta_data_name      IN VARCHAR2 DEFAULT NULL,
14:33:50 165  	out_result_set	       OUT SYS_REFCURSOR
14:33:50 166  );
14:33:50 167  
14:33:50 168  PROCEDURE GET_OFF_CHAINS_SAME_PRODUCTS (
14:33:50 169  	in_offer_chain_1 IN NUMBER,
14:33:50 170  	in_offer_chain_2 IN NUMBER,
14:33:50 171  	out_result_set	OUT SYS_REFCURSOR
14:33:50 172  );
14:33:50 173  
14:33:50 174  PROCEDURE GET_OFFER_CHAIN_MD_VALUE (
14:33:50 175  	in_offer_chain_id IN NUMBER,
14:33:50 176  	in_meta_data_name IN VARCHAR2,
14:33:50 177  	out_value	  OUT VARCHAR2
14:33:50 178  );
14:33:50 179  
14:33:50 180  PROCEDURE GET_OFFER_CHAIN_EL_VALUE (
14:33:50 181  	in_offer_chain_id   IN NUMBER,
14:33:50 182  	in_eligibility_name IN VARCHAR2,
14:33:50 183  	out_value	    OUT VARCHAR2
14:33:50 184  );
14:33:50 185  
14:33:50 186  PROCEDURE GET_OFFER_PRODUCT_OFFERINGS (
14:33:50 187  	in_offer_id    IN NUMBER,
14:33:50 188  	out_result_set OUT SYS_REFCURSOR
14:33:50 189  );
14:33:50 190  
14:33:50 191  PROCEDURE GET_OFFER_CHAINS_BY_META_DATA (
14:33:50 192  	in_meta_data_name  IN VARCHAR2,
14:33:50 193  	in_meta_data_value IN VARCHAR2,
14:33:50 194  	out_result_set	   OUT SYS_REFCURSOR
14:33:50 195  );
14:33:50 196  
14:33:50 197  PROCEDURE GET_ALL_META_DATA (
14:33:50 198  	in_offer_chain_id IN NUMBER,
14:33:50 199  	out_result_set	  OUT SYS_REFCURSOR
14:33:50 200  );
14:33:50 201  
14:33:50 202  PROCEDURE CHECK_PRODUCT_ELIGIBILITY (
14:33:50 203  	in_group_id	  IN NUMBER,
14:33:50 204  	in_offer_chain_id IN NUMBER,
14:33:50 205  	out_is_eligible   OUT NUMBER,
14:33:50 206  	out_concurrent_subscription_id OUT NUMBER
14:33:50 207  );
14:33:50 208  
14:33:50 209  PROCEDURE GET_NOTIFICATION_TYPE_ID (
14:33:50 210  	in_offer_chain_id	 IN NUMBER,
14:33:50 211  	in_action_name		 IN VARCHAR2,
14:33:50 212  	out_notification_type_id OUT NUMBER
14:33:50 213  );
14:33:50 214  
14:33:50 215  END PROCS_OFFER_CHAIN_V22;
14:33:50 216  .
14:33:50 SQL> /

Package created.

Elapsed: 00:00:00.12
14:33:50 SQL> 
14:33:50 SQL> CREATE OR REPLACE PACKAGE 		  "PROCS_POLLING_SYNC"
14:33:50   2  AS
14:33:50   3  
14:33:50   4  ----
14:33:50   5  --------------------------------------------------------------------------------
14:33:50   6  ----
14:33:50   7  	  /* Call the Gather Events on a timer. Pass in the timestamp
14:33:50   8  	      returned from the previous call and store the result for the
14:33:50   9  	      next call.
14:33:50  10  	     This method will identify and create new Sync Events from trigger activity data */
14:33:50  11  	  procedure GATHER_SYNC_EVENTS(in_last_timestamp timestamp, out_new_timestamp out timestamp);
14:33:50  12  ----
14:33:50  13  --------------------------------------------------------------------------------
14:33:50  14  ----
14:33:50  15  	  /* Internal logic call may need to be used to fix poller data */
14:33:50  16  	  procedure GATHER_SYNC_EVENTS_RANGE(in_start_ts timestamp, in_end_ts timestamp, in_offset number);
14:33:50  17  ----
14:33:50  18  --------------------------------------------------------------------------------
14:33:50  19  ----
14:33:50  20  	  /* User request for sync events. Params should be hard-coded in the application
14:33:50  21  	      layer. Unconfirmed transfer sets will be resent up to maximum before being
14:33:50  22  	      skipped. Last read time is logged.
14:33:50  23  	     Params:
14:33:50  24  		  set_maximum: Size of each transfer set
14:33:50  25  		  max_retries: Number of times to resend unconfirmed sets before skipping
14:33:50  26  	     Returns:
14:33:50  27  		  set_id: Transfer set id, duplicated for all entries
14:33:50  28  		  group_id: regi_id value
14:33:50  29  		  event_type: Financial (I)nstrument, (S)ubscription, (G)ift Cert
14:33:50  30  	  */
14:33:50  31  	  procedure GET_TRANSFER_SET(in_set_maximum number, in_max_retries number, out_refcursor out sys_refcursor);
14:33:50  32  ----
14:33:50  33  --------------------------------------------------------------------------------
14:33:50  34  ----
14:33:50  35  	  /* Confirmation from user of receipt of sync transfer set. Will only allow a
14:33:50  36  	      single confirmation per transfer set.
14:33:50  37  	  */
14:33:50  38  	  procedure CONFIRM_TRANSFER_SET(in_set_id core_owner.polling_sync.set_id%type);
14:33:50  39  ----
14:33:50  40  --------------------------------------------------------------------------------
14:33:50  41  ----
14:33:50  42  	  procedure SET_LAST_RUN(ts in timestamp);
14:33:50  43  	  procedure GET_LAST_RUN(ts out timestamp);
14:33:50  44  END PROCS_POLLING_SYNC;
14:33:50  45  .
14:33:50 SQL> /

Package created.

Elapsed: 00:00:00.16
14:33:50 SQL> 
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> -- DDL for package PROCS_PROCESS_RETRY_THROTTLE
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> 
14:33:50 SQL> CREATE OR REPLACE PACKAGE "PROCS_PROCESS_RETRY_V22" AS
14:33:50   2  
14:33:50   3  PROCEDURE LOG_RETRY(
14:33:50   4  	  in_process_name IN VARCHAR2,
14:33:50   5  	  in_generic_id   IN NUMBER,
14:33:50   6  	  in_date	  IN VARCHAR2,
14:33:50   7  	  out_success	   OUT NUMBER
14:33:50   8  );
14:33:50   9  
14:33:50  10  PROCEDURE LOG_RETRY_DATE(
14:33:50  11  	  in_process_name IN VARCHAR2,
14:33:50  12  	  in_generic_id   IN NUMBER,
14:33:50  13  	  in_date	  IN DATE,
14:33:50  14  	  out_success	   OUT NUMBER
14:33:50  15  );
14:33:50  16  
14:33:50  17  PROCEDURE DELETE_RETRY(
14:33:50  18  	  in_process_name IN VARCHAR2,
14:33:50  19  	  in_remove_minutes  IN NUMBER
14:33:50  20  );
14:33:50  21  
14:33:50  22  PROCEDURE GET_SYSDATE (
14:33:50  23  	  out_date OUT VARCHAR2
14:33:50  24  );
14:33:50  25  
14:33:50  26  END PROCS_PROCESS_RETRY_V22;
14:33:50  27  .
14:33:50 SQL> /

Package created.

Elapsed: 00:00:00.02
14:33:50 SQL> 
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> -- DDL for package PROCS_PRODUCT
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> 
14:33:50 SQL> CREATE OR REPLACE PACKAGE "PROCS_PRODUCT_V22" AS
14:33:50   2  
14:33:50   3  PROCEDURE GET_PRODUCTS (
14:33:50   4  /*
14:33:50   5  Throws exceptions:
14:33:50   6  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50   7  */
14:33:50   8  	in_status_id   IN  NUMBER,
14:33:50   9  	out_result_set OUT SYS_REFCURSOR
14:33:50  10  );
14:33:50  11  
14:33:50  12  PROCEDURE GET_PRODUCT_OFFERING_META_DATA (
14:33:50  13  /*
14:33:50  14  Throws exceptions:
14:33:50  15  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50  16  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50  17  */
14:33:50  18  	in_product_offering_id	IN NUMBER,
14:33:50  19  	out_result_set OUT SYS_REFCURSOR
14:33:50  20  );
14:33:50  21  
14:33:50  22  PROCEDURE GET_PRODUCT_ELIGIBIL_BY_NAME (
14:33:50  23  /*
14:33:50  24  Throws exceptions:
14:33:50  25  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50  26  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50  27  */
14:33:50  28  	in_product_id	    IN NUMBER,
14:33:50  29  	in_eligibility_name IN VARCHAR2 DEFAULT NULL,
14:33:50  30  	out_result_set	    OUT SYS_REFCURSOR
14:33:50  31  );
14:33:50  32  
14:33:50  33  PROCEDURE GET_PRODUCT_BY_ID (
14:33:50  34  	in_product_id  IN NUMBER,
14:33:50  35  	out_result_set OUT SYS_REFCURSOR
14:33:50  36  );
14:33:50  37  
14:33:50  38  PROCEDURE GET_PRD_OFFERING_BY_LINE_IT_ID (
14:33:50  39  	in_line_item_id IN NUMBER,
14:33:50  40  	out_result_set	OUT SYS_REFCURSOR
14:33:50  41  );
14:33:50  42  
14:33:50  43  PROCEDURE GET_PRD_OFFERING_BY_ID (
14:33:50  44  	in_product_offering_id IN NUMBER,
14:33:50  45  	out_result_set	OUT SYS_REFCURSOR
14:33:50  46  );
14:33:50  47  
14:33:50  48  PROCEDURE GET_PRODUCT_OFFERING_DISCOUNTS(
14:33:50  49  	in_product_offering_id IN NUMBER,
14:33:50  50  	out_result_set	       OUT SYS_REFCURSOR
14:33:50  51  );
14:33:50  52  
14:33:50  53  END PROCS_PRODUCT_V22;
14:33:50  54  .
14:33:50 SQL> /

Package created.

Elapsed: 00:00:00.02
14:33:50 SQL> 
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> -- DDL for package PROCS_RECONCILIATION_CRU
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> 
14:33:50 SQL> CREATE OR REPLACE PACKAGE "PROCS_RECONCILIATION_CRU_V22" AS
14:33:50   2  
14:33:50   3  PROCEDURE CREATE_CPT_CHARGEBACK_ACT (
14:33:50   4  	out_cpt_chargeback_act_id   OUT RCN_CPT_CHARGEBACK_ACT_DETAIL.ID%TYPE,
14:33:50   5  	in_cpt_chargeback_act_id    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.ID%TYPE DEFAULT NULL,
14:33:50   6  	in_ext_source_log_id	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.RCN_EXT_SOURCE_LOG_ID%TYPE,
14:33:50   7  	in_record_type		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.RECORD_TYPE%TYPE,
14:33:50   8  	in_entity_type		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.ENTITY_TYPE%TYPE,
14:33:50   9  	in_entity_number	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.ENTITY_NUMBER%TYPE,
14:33:50  10  	in_chargeback_amount_issuer IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CHARGEBACK_AMOUNT_ISSUER%TYPE,
14:33:50  11  	in_prev_partial_repres	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.PREV_PARTIAL_REPRESENTMENT%TYPE,
14:33:50  12  	in_presentment_currency     IN RCN_CPT_CHARGEBACK_ACT_DETAIL.PRESENTMENT_CURRENCY%TYPE,
14:33:50  13  	in_chargeback_category	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CHARGEBACK_CATEGORY%TYPE,
14:33:50  14  	in_status_flag		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.STATUS_FLAG%TYPE,
14:33:50  15  	in_sequence_number	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.SEQUENCE_NUMBER%TYPE,
14:33:50  16  	in_merchant_order_number    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.MERCHANT_ORDER_NUMBER%TYPE,
14:33:50  17  	in_account_number	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.ACCOUNT_NUMBER%TYPE,
14:33:50  18  	in_reason_code		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.REASON_CODE%TYPE,
14:33:50  19  	in_transaction_date	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.TRANSACTION_DATE%TYPE,
14:33:50  20  	in_chargeback_date	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CHARGEBACK_DATE%TYPE,
14:33:50  21  	in_activity_date	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.ACTIVITY_DATE%TYPE,
14:33:50  22  	in_chargeback_amount_action IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CHARGEBACK_AMOUNT_ACTION%TYPE,
14:33:50  23  	in_fee_amount		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.FEE_AMOUNT%TYPE,
14:33:50  24  	in_usage_code		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.USAGE_CODE%TYPE,
14:33:50  25  	in_mop_code		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.MOP_CODE%TYPE,
14:33:50  26  	in_authorization_date	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.AUTHORIZATION_DATE%TYPE,
14:33:50  27  	in_chargeback_due_date	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CHARGEBACK_DUE_DATE%TYPE,
14:33:50  28  	in_created_by		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CREATED_BY%TYPE
14:33:50  29  );
14:33:50  30  
14:33:50  31  PROCEDURE CREATE_EXT_SOURCE_LOG (
14:33:50  32  	out_ext_source_log_id	    OUT RCN_EXT_SOURCE_LOG.ID%TYPE,
14:33:50  33  	in_ext_source_log_id	    IN RCN_EXT_SOURCE_LOG.ID%TYPE DEFAULT NULL,
14:33:50  34  	in_extraction_timestamp     IN RCN_EXT_SOURCE_LOG.EXTRACTION_TIMESTAMP%TYPE,
14:33:50  35  	in_report_date		    IN RCN_EXT_SOURCE_LOG.REPORT_DATE%TYPE,
14:33:50  36  	in_report_gen_datetime	    IN RCN_EXT_SOURCE_LOG.REPORT_GENERATION_DATETIME%TYPE,
14:33:50  37  	in_record_type		    IN RCN_EXT_SOURCE_LOG.RECORD_TYPE%TYPE,
14:33:50  38  	in_report_file_name	    IN RCN_EXT_SOURCE_LOG.REPORT_FILE_NAME%TYPE,
14:33:50  39  	in_created_by		    IN RCN_EXT_SOURCE_LOG.CREATED_BY%TYPE
14:33:50  40  );
14:33:50  41  
14:33:50  42  PROCEDURE CREATE_CPT_SERVICE_CHARGE (
14:33:50  43  	out_cpt_service_charge_id   OUT RCN_CPT_SERVICE_CHARGE_DETAIL.ID%TYPE,
14:33:50  44  	in_cpt_service_charge_id    IN RCN_CPT_SERVICE_CHARGE_DETAIL.ID%TYPE DEFAULT NULL,
14:33:50  45  	in_ext_source_log_id	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.RCN_EXT_SOURCE_LOG_ID%TYPE,
14:33:50  46  	in_record_type		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.RECORD_TYPE%TYPE,
14:33:50  47  	in_category		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.CATEGORY%TYPE,
14:33:50  48  	in_sub_category 	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.SUB_CATEGORY%TYPE,
14:33:50  49  	in_entity_type		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.ENTITY_TYPE%TYPE,
14:33:50  50  	in_entity_number	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.ENTITY_NUMBER%TYPE,
14:33:50  51  	in_funds_trans_inst_number  IN RCN_CPT_SERVICE_CHARGE_DETAIL.FUNDS_TRANSFER_INST_NUMBER%TYPE,
14:33:50  52  	in_secure_ba_number	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.SECURE_BA_NUMBER%TYPE,
14:33:50  53  	in_settlement_currency	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.SETTLEMENT_CURRENCY%TYPE,
14:33:50  54  	in_fee_schedule 	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.FEE_SCHEDULE%TYPE,
14:33:50  55  	in_mop			    IN RCN_CPT_SERVICE_CHARGE_DETAIL.MOP%TYPE,
14:33:50  56  	in_interchange_qual	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.INTERCHANGE_QUALIFICATION%TYPE,
14:33:50  57  	in_fee_type_description     IN RCN_CPT_SERVICE_CHARGE_DETAIL.FEE_TYPE_DESCRIPTION%TYPE,
14:33:50  58  	in_action_type		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.ACTION_TYPE%TYPE,
14:33:50  59  	in_unit_quantity	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.UNIT_QUANTITY%TYPE,
14:33:50  60  	in_unit_fee		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.UNIT_FEE%TYPE,
14:33:50  61  	in_amount		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.AMOUNT%TYPE,
14:33:50  62  	in_percentage_rate	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.PERCENTAGE_RATE%TYPE,
14:33:50  63  	in_total_charge 	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.TOTAL_CHARGE%TYPE,
14:33:50  64  	in_created_by		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.CREATED_BY%TYPE
14:33:50  65  );
14:33:50  66  
14:33:50  67  PROCEDURE CREATE_CPT_EXCEPTION (
14:33:50  68  	out_cpt_exception_id	 OUT RCN_CPT_EXCEPTION_DETAIL.ID%TYPE,
14:33:50  69  	in_cpt_exception_id	 IN RCN_CPT_EXCEPTION_DETAIL.ID%TYPE DEFAULT NULL,
14:33:50  70  	in_ext_source_log_id	 IN RCN_CPT_EXCEPTION_DETAIL.RCN_EXT_SOURCE_LOG_ID%TYPE,
14:33:50  71  	in_record_type		 IN RCN_CPT_EXCEPTION_DETAIL.RECORD_TYPE%TYPE,
14:33:50  72  	in_submission_date	 IN RCN_CPT_EXCEPTION_DETAIL.SUBMISSION_DATE%TYPE,
14:33:50  73  	in_pid_number		 IN RCN_CPT_EXCEPTION_DETAIL.PID_NUMBER%TYPE,
14:33:50  74  	in_pid_short_name	 IN RCN_CPT_EXCEPTION_DETAIL.PID_SHORT_NAME%TYPE,
14:33:50  75  	in_submission_number	 IN RCN_CPT_EXCEPTION_DETAIL.SUBMISSION_NUMBER%TYPE,
14:33:50  76  	in_record_number	 IN RCN_CPT_EXCEPTION_DETAIL.RECORD_NUMBER%TYPE,
14:33:50  77  	in_entity_type		 IN RCN_CPT_EXCEPTION_DETAIL.ENTITY_TYPE%TYPE,
14:33:50  78  	in_entity_number	 IN RCN_CPT_EXCEPTION_DETAIL.ENTITY_NUMBER%TYPE,
14:33:50  79  	in_presentment_currency  IN RCN_CPT_EXCEPTION_DETAIL.PRESENTMENT_CURRENCY%TYPE,
14:33:50  80  	in_merchant_order_number IN RCN_CPT_EXCEPTION_DETAIL.MERCHANT_ORDER_NUMBER%TYPE,
14:33:50  81  	in_rdfi_number		 IN RCN_CPT_EXCEPTION_DETAIL.RDFI_NUMBER%TYPE,
14:33:50  82  	in_account_number	 IN RCN_CPT_EXCEPTION_DETAIL.ACCOUNT_NUMBER%TYPE,
14:33:50  83  	in_expiration_date	 IN RCN_CPT_EXCEPTION_DETAIL.EXPIRATION_DATE%TYPE,
14:33:50  84  	in_amount		 IN RCN_CPT_EXCEPTION_DETAIL.AMOUNT%TYPE,
14:33:50  85  	in_mop			 IN RCN_CPT_EXCEPTION_DETAIL.MOP%TYPE,
14:33:50  86  	in_action_code		 IN RCN_CPT_EXCEPTION_DETAIL.ACTION_CODE%TYPE,
14:33:50  87  	in_auth_date		 IN RCN_CPT_EXCEPTION_DETAIL.AUTH_DATE%TYPE,
14:33:50  88  	in_auth_code		 IN RCN_CPT_EXCEPTION_DETAIL.AUTH_CODE%TYPE,
14:33:50  89  	in_auth_response_code	 IN RCN_CPT_EXCEPTION_DETAIL.AUTH_RESPONSE_CODE%TYPE,
14:33:50  90  	in_trace_number 	 IN RCN_CPT_EXCEPTION_DETAIL.TRACE_NUMBER%TYPE,
14:33:50  91  	in_consumer_country_code IN RCN_CPT_EXCEPTION_DETAIL.CONSUMER_COUNTRY_CODE%TYPE,
14:33:50  92  	in_category		 IN RCN_CPT_EXCEPTION_DETAIL.CATEGORY%TYPE,
14:33:50  93  	in_mcc			 IN RCN_CPT_EXCEPTION_DETAIL.MCC%TYPE,
14:33:50  94  	in_reject_code		 IN RCN_CPT_EXCEPTION_DETAIL.REJECT_CODE%TYPE,
14:33:50  95  	in_submission_status	 IN RCN_CPT_EXCEPTION_DETAIL.SUBMISSION_STATUS%TYPE,
14:33:50  96  	in_created_by		 IN RCN_CPT_EXCEPTION_DETAIL.CREATED_BY%TYPE
14:33:50  97  );
14:33:50  98  
14:33:50  99  PROCEDURE CREATE_CPT_DEPOSIT (
14:33:50 100  	out_cpt_deposit_id	  OUT RCN_CPT_DEPOSIT_DETAIL.ID%TYPE,
14:33:50 101  	in_cpt_deposit_id	  IN RCN_CPT_DEPOSIT_DETAIL.ID%TYPE DEFAULT NULL,
14:33:50 102  	in_ext_source_log_id	  IN RCN_CPT_DEPOSIT_DETAIL.RCN_EXT_SOURCE_LOG_ID%TYPE,
14:33:50 103  	in_record_type		  IN RCN_CPT_DEPOSIT_DETAIL.RECORD_TYPE%TYPE,
14:33:50 104  	in_submission_date	  IN RCN_CPT_DEPOSIT_DETAIL.SUBMISSION_DATE%TYPE,
14:33:50 105  	in_pid_number		  IN RCN_CPT_DEPOSIT_DETAIL.PID_NUMBER%TYPE,
14:33:50 106  	in_pid_short_name	  IN RCN_CPT_DEPOSIT_DETAIL.PID_SHORT_NAME%TYPE,
14:33:50 107  	in_submission_number	  IN RCN_CPT_DEPOSIT_DETAIL.SUBMISSION_NUMBER%TYPE,
14:33:50 108  	in_record_number	  IN RCN_CPT_DEPOSIT_DETAIL.RECORD_NUMBER%TYPE,
14:33:50 109  	in_entity_type		  IN RCN_CPT_DEPOSIT_DETAIL.ENTITY_TYPE%TYPE,
14:33:50 110  	in_entity_number	  IN RCN_CPT_DEPOSIT_DETAIL.ENTITY_NUMBER%TYPE,
14:33:50 111  	in_presentment_currency   IN RCN_CPT_DEPOSIT_DETAIL.PRESENTMENT_CURRENCY%TYPE,
14:33:50 112  	in_merchant_order_number  IN RCN_CPT_DEPOSIT_DETAIL.MERCHANT_ORDER_NUMBER%TYPE,
14:33:50 113  	in_rdfi_number		  IN RCN_CPT_DEPOSIT_DETAIL.RDFI_NUMBER%TYPE,
14:33:50 114  	in_account_number	  IN RCN_CPT_DEPOSIT_DETAIL.ACCOUNT_NUMBER%TYPE,
14:33:50 115  	in_expiration_date	  IN RCN_CPT_DEPOSIT_DETAIL.EXPIRATION_DATE%TYPE,
14:33:50 116  	in_amount		  IN RCN_CPT_DEPOSIT_DETAIL.AMOUNT%TYPE,
14:33:50 117  	in_mop			  IN RCN_CPT_DEPOSIT_DETAIL.MOP%TYPE,
14:33:50 118  	in_action_code		  IN RCN_CPT_DEPOSIT_DETAIL.ACTION_CODE%TYPE,
14:33:50 119  	in_auth_date		  IN RCN_CPT_DEPOSIT_DETAIL.AUTH_DATE%TYPE,
14:33:50 120  	in_auth_code		  IN RCN_CPT_DEPOSIT_DETAIL.AUTH_CODE%TYPE,
14:33:50 121  	in_auth_response_code	  IN RCN_CPT_DEPOSIT_DETAIL.AUTH_RESPONSE_CODE%TYPE,
14:33:50 122  	in_trace_number 	  IN RCN_CPT_DEPOSIT_DETAIL.TRACE_NUMBER%TYPE,
14:33:50 123  	in_consumer_country_code  IN RCN_CPT_DEPOSIT_DETAIL.CONSUMER_COUNTRY_CODE%TYPE,
14:33:50 124  	in_mcc			  IN RCN_CPT_DEPOSIT_DETAIL.MCC%TYPE,
14:33:50 125  	in_fee_code		  IN RCN_CPT_DEPOSIT_DETAIL.FEE_CODE%TYPE,
14:33:50 126  	in_unit_fee		  IN RCN_CPT_DEPOSIT_DETAIL.UNIT_FEE%TYPE,
14:33:50 127  	in_percent_fee		  IN RCN_CPT_DEPOSIT_DETAIL.PERCENT_FEE%TYPE,
14:33:50 128  	in_total_interchange_fee  IN RCN_CPT_DEPOSIT_DETAIL.TOTAL_INTERCHANGE_FEE%TYPE,
14:33:50 129  	in_total_assessment_fee   IN RCN_CPT_DEPOSIT_DETAIL.TOTAL_ASSESSMENT_FEE%TYPE,
14:33:50 130  	in_other_fee		  IN RCN_CPT_DEPOSIT_DETAIL.OTHER_FEE%TYPE,
14:33:50 131  	in_created_by		  IN RCN_CPT_DEPOSIT_DETAIL.CREATED_BY%TYPE
14:33:50 132  );
14:33:50 133  
14:33:50 134  PROCEDURE CREATE_PP_SETTLEMENT (
14:33:50 135  	out_pp_settlement_id	   OUT RCN_PP_SETTLEMENT.ID%TYPE,
14:33:50 136  	in_pp_settlement_id	   IN RCN_PP_SETTLEMENT.ID%TYPE DEFAULT NULL,
14:33:50 137  	in_ext_source_log_id	   IN RCN_PP_SETTLEMENT.RCN_EXT_SOURCE_LOG_ID%TYPE,
14:33:50 138  	in_transaction_id	   IN RCN_PP_SETTLEMENT.TRANSACTION_ID%TYPE,
14:33:50 139  	in_invoice_id		   IN RCN_PP_SETTLEMENT.INVOICE_ID%TYPE,
14:33:50 140  	in_pp_ref_id		   IN RCN_PP_SETTLEMENT.PP_REF_ID%TYPE,
14:33:50 141  	in_pp_ref_id_type	   IN RCN_PP_SETTLEMENT.PP_REF_ID_TYPE%TYPE,
14:33:50 142  	in_trans_event_code	   IN RCN_PP_SETTLEMENT.TRANS_EVENT_CODE%TYPE,
14:33:50 143  	in_trans_init_date	   IN RCN_PP_SETTLEMENT.TRANS_INIT_DATE%TYPE,
14:33:50 144  	in_trans_comp_date	   IN RCN_PP_SETTLEMENT.TRANS_COMP_DATE%TYPE,
14:33:50 145  	in_trans_deb_or_cred	   IN RCN_PP_SETTLEMENT.TRANS_DEB_OR_CRED%TYPE,
14:33:50 146  	in_gross_trans_amount	   IN RCN_PP_SETTLEMENT.GROSS_TRANS_AMOUNT%TYPE,
14:33:50 147  	in_gross_trans_currency    IN RCN_PP_SETTLEMENT.GROSS_TRANS_CURRENCY%TYPE,
14:33:50 148  	in_fee_deb_or_cred	   IN RCN_PP_SETTLEMENT.FEE_DEB_OR_CRED%TYPE,
14:33:50 149  	in_fee_amount		   IN RCN_PP_SETTLEMENT.FEE_AMOUNT%TYPE,
14:33:50 150  	in_fee_currency 	   IN RCN_PP_SETTLEMENT.FEE_CURRENCY%TYPE,
14:33:50 151  	in_custom_field 	   IN RCN_PP_SETTLEMENT.CUSTOM_FIELD%TYPE,
14:33:50 152  	in_created_by		   IN RCN_PP_SETTLEMENT.CREATED_BY%TYPE
14:33:50 153  );
14:33:50 154  
14:33:50 155  PROCEDURE CREATE_PP_DISPUTE (
14:33:50 156  	out_pp_dispute_id	     OUT RCN_PP_DISPUTE.ID%TYPE,
14:33:50 157  	in_pp_dispute_id	     IN RCN_PP_DISPUTE.ID%TYPE DEFAULT NULL,
14:33:50 158  	in_ext_source_log_id	     IN RCN_PP_DISPUTE.RCN_EXT_SOURCE_LOG_ID%TYPE,
14:33:50 159  	in_dispute_type 	     IN RCN_PP_DISPUTE.DISPUTE_TYPE%TYPE,
14:33:50 160  	in_claimant_name	     IN RCN_PP_DISPUTE.CLAIMANT_NAME%TYPE,
14:33:50 161  	in_claimant_email	     IN RCN_PP_DISPUTE.CLAIMANT_EMAIL%TYPE,
14:33:50 162  	in_transaction_id	     IN RCN_PP_DISPUTE.TRANSACTION_ID%TYPE,
14:33:50 163  	in_trans_date		     IN RCN_PP_DISPUTE.TRANS_DATE%TYPE,
14:33:50 164  	in_disputed_amount	     IN RCN_PP_DISPUTE.DISPUTED_AMOUNT%TYPE,
14:33:50 165  	in_disputed_amount_currency  IN RCN_PP_DISPUTE.DISPUTED_AMOUNT_CURRENCY%TYPE,
14:33:50 166  	in_dispute_reason	     IN RCN_PP_DISPUTE.DISPUTE_REASON%TYPE,
14:33:50 167  	in_dispute_filing_date	     IN RCN_PP_DISPUTE.DISPUTE_FILING_DATE%TYPE,
14:33:50 168  	in_dispute_status	     IN RCN_PP_DISPUTE.DISPUTE_STATUS%TYPE,
14:33:50 169  	in_dispute_case_id	     IN RCN_PP_DISPUTE.DISPUTE_CASE_ID%TYPE,
14:33:50 170  	in_invoice_id		     IN RCN_PP_DISPUTE.INVOICE_ID%TYPE,
14:33:50 171  	in_created_by		     IN RCN_PP_DISPUTE.CREATED_BY%TYPE
14:33:50 172  );
14:33:50 173  
14:33:50 174  PROCEDURE CREATE_PP_TRANS_DETAIL (
14:33:50 175  	out_pp_trans_detail_id	     OUT RCN_PP_TRANS_DETAIL.ID%TYPE,
14:33:50 176  	in_pp_trans_detail_id	     IN RCN_PP_TRANS_DETAIL.ID%TYPE DEFAULT NULL,
14:33:50 177  	in_ext_source_log_id	     IN RCN_PP_TRANS_DETAIL.RCN_EXT_SOURCE_LOG_ID%TYPE,
14:33:50 178  	in_invoice_id		     IN RCN_PP_TRANS_DETAIL.INVOICE_ID%TYPE,
14:33:50 179  	in_transaction_id	     IN RCN_PP_TRANS_DETAIL.TRANSACTION_ID%TYPE,
14:33:50 180  	in_pp_ref_id		     IN RCN_PP_TRANS_DETAIL.PP_REF_ID%TYPE,
14:33:50 181  	in_trans_deb_or_cred	     IN RCN_PP_TRANS_DETAIL.TRANS_DEB_OR_CRED%TYPE,
14:33:50 182  	in_trans_init_date	     IN RCN_PP_TRANS_DETAIL.TRANS_INIT_DATE%TYPE,
14:33:50 183  	in_trans_comp_date	     IN RCN_PP_TRANS_DETAIL.TRANS_COMP_DATE%TYPE,
14:33:50 184  	in_gross_trans_amount	     IN RCN_PP_TRANS_DETAIL.GROSS_TRANS_AMOUNT%TYPE,
14:33:50 185  	in_gross_trans_currency      IN RCN_PP_TRANS_DETAIL.GROSS_TRANS_CURRENCY%TYPE,
14:33:50 186  	in_fee_amount		     IN RCN_PP_TRANS_DETAIL.FEE_AMOUNT%TYPE,
14:33:50 187  	in_fee_currency 	     IN RCN_PP_TRANS_DETAIL.FEE_CURRENCY%TYPE,
14:33:50 188  	in_fee_deb_or_cred	     IN RCN_PP_TRANS_DETAIL.FEE_DEB_OR_CRED%TYPE,
14:33:50 189  	in_trans_event_code	     IN RCN_PP_TRANS_DETAIL.TRANS_EVENT_CODE%TYPE,
14:33:50 190  	in_trans_status 	     IN RCN_PP_TRANS_DETAIL.TRANS_STATUS%TYPE,
14:33:50 191  	in_insurance_amount	     IN RCN_PP_TRANS_DETAIL.INSURANCE_AMOUNT%TYPE,
14:33:50 192  	in_sales_tax_amount	     IN RCN_PP_TRANS_DETAIL.SALES_TAX_AMOUNT%TYPE,
14:33:50 193  	in_shipping_amount	     IN RCN_PP_TRANS_DETAIL.SHIPPING_AMOUNT%TYPE,
14:33:50 194  	in_trans_subject	     IN RCN_PP_TRANS_DETAIL.TRANS_SUBJECT%TYPE,
14:33:50 195  	in_trans_note		     IN RCN_PP_TRANS_DETAIL.TRANS_NOTE%TYPE,
14:33:50 196  	in_payer_acct_id	     IN RCN_PP_TRANS_DETAIL.PAYER_ACCT_ID%TYPE,
14:33:50 197  	in_payer_addr_status	     IN RCN_PP_TRANS_DETAIL.PAYER_ADDR_STATUS%TYPE,
14:33:50 198  	in_item_name		     IN RCN_PP_TRANS_DETAIL.ITEM_NAME%TYPE,
14:33:50 199  	in_item_id		     IN RCN_PP_TRANS_DETAIL.ITEM_ID%TYPE,
14:33:50 200  	in_option_1_name	     IN RCN_PP_TRANS_DETAIL.OPTION_1_NAME%TYPE,
14:33:50 201  	in_option_1_value	     IN RCN_PP_TRANS_DETAIL.OPTION_1_VALUE%TYPE,
14:33:50 202  	in_option_2_name	     IN RCN_PP_TRANS_DETAIL.OPTION_2_NAME%TYPE,
14:33:50 203  	in_option_2_value	     IN RCN_PP_TRANS_DETAIL.OPTION_2_VALUE%TYPE,
14:33:50 204  	in_auction_site 	     IN RCN_PP_TRANS_DETAIL.AUCTION_SITE%TYPE,
14:33:50 205  	in_auction_buyer_id	     IN RCN_PP_TRANS_DETAIL.AUCTION_BUYER_ID%TYPE,
14:33:50 206  	in_auction_closing_date      IN RCN_PP_TRANS_DETAIL.AUCTION_CLOSING_DATE%TYPE,
14:33:50 207  	in_shipping_addr_line_1      IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_LINE_1%TYPE,
14:33:50 208  	in_shipping_addr_line_2      IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_LINE_2%TYPE,
14:33:50 209  	in_shipping_addr_city	     IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_CITY%TYPE,
14:33:50 210  	in_shipping_addr_state	     IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_STATE%TYPE,
14:33:50 211  	in_shipping_addr_zip	     IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_ZIP%TYPE,
14:33:50 212  	in_shipping_addr_country     IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_COUNTRY%TYPE,
14:33:50 213  	in_custom_field 	     IN RCN_PP_TRANS_DETAIL.CUSTOM_FIELD%TYPE,
14:33:50 214  	in_created_by		     IN RCN_PP_TRANS_DETAIL.CREATED_BY%TYPE
14:33:50 215  );
14:33:50 216  
14:33:50 217  PROCEDURE GET_EXT_SOURCE_LOG (
14:33:50 218  	in_record_type		 IN RCN_EXT_SOURCE_LOG.RECORD_TYPE%TYPE,
14:33:50 219  	in_report_file_name	 IN RCN_EXT_SOURCE_LOG.REPORT_FILE_NAME%TYPE,
14:33:50 220  	out_result_set		 OUT SYS_REFCURSOR
14:33:50 221  );
14:33:50 222  
14:33:50 223  FUNCTION CHECK_EXT_SOURCE_LOG (
14:33:50 224  	in_record_type		 IN RCN_EXT_SOURCE_LOG.RECORD_TYPE%TYPE,
14:33:50 225  	in_report_file_name	 IN RCN_EXT_SOURCE_LOG.REPORT_FILE_NAME%TYPE
14:33:50 226  ) RETURN NUMBER;
14:33:50 227  
14:33:50 228  PROCEDURE CREATE_AMEX_CHARGEBACK (
14:33:50 229  	  in_rcn_ext_source_log_id IN RCN_EXT_SOURCE_LOG.ID%TYPE,
14:33:50 230  	  in_resolution IN RCN_AMEX_CHARGEBACK.RESOLUTION%TYPE,
14:33:50 231  	  in_from_system IN RCN_AMEX_CHARGEBACK.FROM_SYSTEM%TYPE,
14:33:50 232  	  in_rejects_to_system IN RCN_AMEX_CHARGEBACK.REJECTS_TO_SYSTEM%TYPE,
14:33:50 233  	  in_disputes_to_system IN RCN_AMEX_CHARGEBACK.DISPUTES_TO_SYSTEM%TYPE,
14:33:50 234  	  in_date_of_adjustment IN RCN_AMEX_CHARGEBACK.DATE_OF_ADJUSTMENT%TYPE,
14:33:50 235  	  in_date_of_charge IN RCN_AMEX_CHARGEBACK.DATE_OF_CHARGE%TYPE,
14:33:50 236  	  in_case_type IN RCN_AMEX_CHARGEBACK.CASE_TYPE%TYPE,
14:33:50 237  	  in_cb_reas_code IN RCN_AMEX_CHARGEBACK.CB_REAS_CODE%TYPE,
14:33:50 238  	  in_cb_amount IN RCN_AMEX_CHARGEBACK.CB_AMOUNT%TYPE,
14:33:50 239  	  in_cb_adjustment_number IN RCN_AMEX_CHARGEBACK.CB_ADJUSTMENT_NUMBER%TYPE,
14:33:50 240  	  in_billed_amount IN RCN_AMEX_CHARGEBACK.BILLED_AMOUNT%TYPE,
14:33:50 241  	  in_soc_amount IN RCN_AMEX_CHARGEBACK.SOC_AMOUNT%TYPE,
14:33:50 242  	  in_foreign_amount IN RCN_AMEX_CHARGEBACK.FOREIGN_AMOUNT%TYPE,
14:33:50 243  	  in_currency IN RCN_AMEX_CHARGEBACK.CURRENCY%TYPE,
14:33:50 244  	  in_note1 IN RCN_AMEX_CHARGEBACK.NOTE1%TYPE,
14:33:50 245  	  in_note2 IN RCN_AMEX_CHARGEBACK.NOTE2%TYPE,
14:33:50 246  	  in_note3 IN RCN_AMEX_CHARGEBACK.NOTE3%TYPE,
14:33:50 247  	  in_note4 IN RCN_AMEX_CHARGEBACK.NOTE4%TYPE,
14:33:50 248  	  in_note5 IN RCN_AMEX_CHARGEBACK.NOTE5%TYPE,
14:33:50 249  	  in_note6 IN RCN_AMEX_CHARGEBACK.NOTE6%TYPE,
14:33:50 250  	  in_note7 IN RCN_AMEX_CHARGEBACK.NOTE7%TYPE,
14:33:50 251  	  in_ind_ref_number IN RCN_AMEX_CHARGEBACK.IND_REF_NUMBER%TYPE,
14:33:50 252  	  in_created_by IN RCN_AMEX_CHARGEBACK.CREATED_BY%TYPE
14:33:50 253  );
14:33:50 254  
14:33:50 255  END PROCS_RECONCILIATION_CRU_V22;
14:33:50 256  .
14:33:50 SQL> /

Package created.

Elapsed: 00:00:00.09
14:33:50 SQL> 
14:33:50 SQL> CREATE OR REPLACE PACKAGE "CORE_OWNER"."PROCS_REPORTING" AS
14:33:50   2  
14:33:50   3  ----
14:33:50   4  --------------------------------------------------------------------------------
14:33:50   5  ----
14:33:50   6  	  procedure ext_charge(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50   7  ----
14:33:50   8  --------------------------------------------------------------------------------
14:33:50   9  ----
14:33:50  10  	  procedure ext_license(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50  11  ----
14:33:50  12  --------------------------------------------------------------------------------
14:33:50  13  ----
14:33:50  14  	  procedure ext_invoice(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50  15  ----
14:33:50  16  --------------------------------------------------------------------------------
14:33:50  17  ----
14:33:50  18  	  procedure ext_line_item(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50  19  ----
14:33:50  20  --------------------------------------------------------------------------------
14:33:50  21  ----
14:33:50  22  	  procedure ext_account(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50  23  ----
14:33:50  24  --------------------------------------------------------------------------------
14:33:50  25  ----
14:33:50  26  	  procedure ext_subscription(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50  27  ----
14:33:50  28  --------------------------------------------------------------------------------
14:33:50  29  ----
14:33:50  30  	  procedure ext_transaction(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50  31  ----
14:33:50  32  --------------------------------------------------------------------------------
14:33:50  33  ----
14:33:50  34  	  procedure ext_offer_chain(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50  35  ----
14:33:50  36  --------------------------------------------------------------------------------
14:33:50  37  ----
14:33:50  38  	  procedure ext_offer_offer_chain(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50  39  ----
14:33:50  40  --------------------------------------------------------------------------------
14:33:50  41  ----
14:33:50  42  	  procedure ext_offer(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50  43  ----
14:33:50  44  --------------------------------------------------------------------------------
14:33:50  45  ----
14:33:50  46  	  procedure ext_gift_certificate(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50  47  ----
14:33:50  48  --------------------------------------------------------------------------------
14:33:50  49  ----
14:33:50  50  	  procedure ext_product_offering(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50  51  ----
14:33:50  52  --------------------------------------------------------------------------------
14:33:50  53  ----
14:33:50  54  	  procedure ext_product(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50  55  ----
14:33:50  56  --------------------------------------------------------------------------------
14:33:50  57  ----
14:33:50  58  	  procedure ext_offer_product_offering(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50  59  ----
14:33:50  60  --------------------------------------------------------------------------------
14:33:50  61  ----
14:33:50  62  	  procedure ext_discount_product_offering(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50  63  ----
14:33:50  64  --------------------------------------------------------------------------------
14:33:50  65  ----
14:33:50  66  	  procedure ext_discount(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50  67  ----
14:33:50  68  --------------------------------------------------------------------------------
14:33:50  69  ----
14:33:50  70  	  procedure ext_offer_chain_metadata(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50  71  ----
14:33:50  72  --------------------------------------------------------------------------------
14:33:50  73  ----
14:33:50  74  	  procedure ext_product_offering_metadata(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50  75  ----
14:33:50  76  --------------------------------------------------------------------------------
14:33:50  77  ----
14:33:50  78  	  procedure ext_subscription_metadata(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50  79  ----
14:33:50  80  --------------------------------------------------------------------------------
14:33:50  81  ----
14:33:50  82  	  procedure ext_credit_card(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50  83  ----
14:33:50  84  --------------------------------------------------------------------------------
14:33:50  85  ----
14:33:50  86  	  procedure ext_transaction_attempt(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50  87  ----
14:33:50  88  --------------------------------------------------------------------------------
14:33:50  89  ----
14:33:50  90  	  procedure ext_invoice_adjustment(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50  91  ----
14:33:50  92  --------------------------------------------------------------------------------
14:33:50  93  ----
14:33:50  94  	  procedure ext_line_item_adjustment(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50  95  ----
14:33:50  96  --------------------------------------------------------------------------------
14:33:50  97  ----
14:33:50  98  	  procedure ext_product_eligibility(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50  99  ----
14:33:50 100  --------------------------------------------------------------------------------
14:33:50 101  ----
14:33:50 102  	  procedure ext_offer_chain_eligibility(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50 103  ----
14:33:50 104  --------------------------------------------------------------------------------
14:33:50 105  ----
14:33:50 106  	  procedure ext_tax(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50 107  ----
14:33:50 108  --------------------------------------------------------------------------------
14:33:50 109  ----
14:33:50 110  	  procedure ext_tax_adjustment(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50 111  ----
14:33:50 112  --------------------------------------------------------------------------------
14:33:50 113  ----
14:33:50 114  /**/
14:33:50 115  	  procedure ext_rcn_ext_source_log(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50 116  ----
14:33:50 117  --------------------------------------------------------------------------------
14:33:50 118  ----
14:33:50 119  	  procedure ext_rcn_cpt_svc_chg_dtl(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50 120  ----
14:33:50 121  --------------------------------------------------------------------------------
14:33:50 122  ----
14:33:50 123  	  procedure ext_rcn_cpt_excpt_dtl(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50 124  ----
14:33:50 125  --------------------------------------------------------------------------------
14:33:50 126  ----
14:33:50 127  	  procedure ext_rcn_cpt_dpst_dtl(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50 128  ----
14:33:50 129  --------------------------------------------------------------------------------
14:33:50 130  ----
14:33:50 131  	  procedure ext_rcn_cpt_chgbk_act_dtl(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50 132  ----
14:33:50 133  --------------------------------------------------------------------------------
14:33:50 134  ----
14:33:50 135  	  procedure ext_rcn_pp_sttlmnt(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50 136  ----
14:33:50 137  --------------------------------------------------------------------------------
14:33:50 138  ----
14:33:50 139  	  procedure ext_rcn_pp_dispute(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50 140  ----
14:33:50 141  --------------------------------------------------------------------------------
14:33:50 142  ----
14:33:50 143  	  procedure ext_rcn_pp_trns_dtl(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50 144  ----
14:33:50 145  --------------------------------------------------------------------------------
14:33:50 146  ----
14:33:50 147  	  procedure ext_rcn_amex_chargeback(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50 148  ----
14:33:50 149  --------------------------------------------------------------------------------
14:33:50 150  ----
14:33:50 151  	  procedure ext_paypal(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50 152  ----
14:33:50 153  --------------------------------------------------------------------------------
14:33:50 154  ----
14:33:50 155  	  procedure ext_address(in_start_date date, in_end_date date, out_cursor out sys_refcursor);
14:33:50 156  ----
14:33:50 157  --------------------------------------------------------------------------------
14:33:50 158  ----
14:33:50 159  /**/
14:33:50 160  END PROCS_REPORTING;
14:33:50 161  .
14:33:50 SQL> /

Package created.

Elapsed: 00:00:00.11
14:33:50 SQL> 
14:33:50 SQL> prompt Compiling Package PROCS_REPORTING_1A
Compiling Package PROCS_REPORTING_1A
14:33:50 SQL> 
14:33:50 SQL> whenever sqlerror exit failure
14:33:50 SQL> 
14:33:50 SQL> create or replace PACKAGE 	     "PROCS_REPORTING_1A" AS
14:33:50   2  
14:33:50   3  ----
14:33:50   4  --------------------------------------------------------------------------------
14:33:50   5  ----
14:33:50   6  	  function getDiscountAmount(in_line_item_id line_item.id%type)
14:33:50   7  	      return line_item.amount%type;
14:33:50   8  ----
14:33:50   9  --------------------------------------------------------------------------------
14:33:50  10  ----
14:33:50  11  	  function getRefundAmount(in_line_item_id line_item.id%type)
14:33:50  12  	      return line_item.amount%type;
14:33:50  13  ----
14:33:50  14  --------------------------------------------------------------------------------
14:33:50  15  ----
14:33:50  16  	  PROCEDURE EXTRACT_LINE_ITEMS(
14:33:50  17  	      in_lower_date_bound DATE,
14:33:50  18  	      in_upper_date_bound DATE,
14:33:50  19  	      out_lic_cur OUT sys_refcursor
14:33:50  20  	  );
14:33:50  21  ----
14:33:50  22  --------------------------------------------------------------------------------
14:33:50  23  ----
14:33:50  24  END PROCS_REPORTING_1A;
14:33:50  25  .
14:33:50 SQL> /

Package created.

Elapsed: 00:00:00.16
14:33:50 SQL> 
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> -- DDL for package PROCS_REPORTS
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> 
14:33:50 SQL> CREATE OR REPLACE PACKAGE "PROCS_REPORTS_V22" AS
14:33:50   2  
14:33:50   3  FUNCTION GET_PRODUCT_NAMES(
14:33:50   4  	in_offer_id IN NUMBER
14:33:50   5  ) RETURN VARCHAR2;
14:33:50   6  
14:33:50   7  PROCEDURE GET_FULL_FLASH_REPORT_PURCH (
14:33:50   8  	in_start_date  IN DATE,
14:33:50   9  	in_end_date    IN DATE,
14:33:50  10  	out_result_set OUT SYS_REFCURSOR
14:33:50  11  );
14:33:50  12  
14:33:50  13  PROCEDURE GET_FLASH_REPORT_PURCHASES (
14:33:50  14  	in_offer_id	       IN NUMBER,
14:33:50  15  	in_start_date	       IN DATE,
14:33:50  16  	in_end_date	       IN DATE,
14:33:50  17  	out_new_purchasers_num OUT NUMBER,
14:33:50  18  	out_renewals_num       OUT NUMBER,
14:33:50  19  	out_product_names      OUT VARCHAR2,
14:33:50  20  	out_total_dollar_value OUT NUMBER,
14:33:50  21  	out_unique_purchasers  OUT NUMBER
14:33:50  22  );
14:33:50  23  
14:33:50  24  /*
14:33:50  25  FUNCTIONS FOR THE FLASH REPORT
14:33:50  26  */
14:33:50  27  
14:33:50  28  FUNCTION FLR_NEW_PURCHASERS_NUM (
14:33:50  29  	in_offer_id	       IN NUMBER,
14:33:50  30  	in_start_date	       IN DATE,
14:33:50  31  	in_end_date	       IN DATE
14:33:50  32  ) RETURN NUMBER;
14:33:50  33  
14:33:50  34  FUNCTION FLR_RENEWALS_NUM (
14:33:50  35  	in_offer_id	       IN NUMBER,
14:33:50  36  	in_start_date	       IN DATE,
14:33:50  37  	in_end_date	       IN DATE
14:33:50  38  ) RETURN NUMBER;
14:33:50  39  
14:33:50  40  FUNCTION FLR_TOTAL_DOLLAR_VALUE (
14:33:50  41  	in_offer_id	       IN NUMBER,
14:33:50  42  	in_start_date	       IN DATE,
14:33:50  43  	in_end_date	       IN DATE
14:33:50  44  ) RETURN NUMBER;
14:33:50  45  
14:33:50  46  FUNCTION FLR_UNIQUE_PURCHASERS (
14:33:50  47  	in_offer_id	       IN NUMBER,
14:33:50  48  	in_start_date	       IN DATE,
14:33:50  49  	in_end_date	       IN DATE
14:33:50  50  ) RETURN NUMBER;
14:33:50  51  
14:33:50  52  END PROCS_REPORTS_V22;
14:33:50  53  .
14:33:50 SQL> /

Package created.

Elapsed: 00:00:00.02
14:33:50 SQL> 
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> -- DDL for package PROCS_SUBSCRIPTION
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> 
14:33:50 SQL> CREATE OR REPLACE PACKAGE "PROCS_SUBSCRIPTION_V22" AS
14:33:50   2  
14:33:50   3  PROCEDURE START_GRACE_BY_INVOICE_ID(
14:33:50   4  	in_invoice_id	     IN LICENSE.INVOICE_ID%TYPE,
14:33:50   5  	in_updater	     IN VARCHAR2,
14:33:50   6  	in_duration_in_hours IN NUMBER
14:33:50   7  );
14:33:50   8  
14:33:50   9  PROCEDURE STOP_GRACE_BY_INVOICE_ID(
14:33:50  10  	in_invoice_id IN LICENSE.INVOICE_ID%TYPE,
14:33:50  11  	in_updater    IN VARCHAR2
14:33:50  12  );
14:33:50  13  
14:33:50  14  PROCEDURE START_SUBSCRIPTION_CREATION (
14:33:50  15  	in_group_id	      IN NUMBER,
14:33:50  16  	in_created_by	      IN VARCHAR2,
14:33:50  17  	in_offer_chain_id     IN NUMBER,
14:33:50  18  	in_instrument_type_id IN NUMBER,
14:33:50  19  	in_instrument_id      IN NUMBER,
14:33:50  20  	in_agent_id	      IN NUMBER,
14:33:50  21  	in_note 	      IN VARCHAR2,
14:33:50  22  	out_subscription_id   OUT NUMBER,
14:33:50  23  	out_invoice_id	      OUT NUMBER,
14:33:50  24  	out_new_license_id    OUT NUMBER,
14:33:50  25  	in_check_dupe_products	 IN NUMBER DEFAULT GLOBAL_CONSTANTS_V22.TRUE
14:33:50  26  );
14:33:50  27  
14:33:50  28  PROCEDURE FINALIZE_SUBSCRIPTION_CREATION (
14:33:50  29  	in_subscription_id    IN NUMBER,
14:33:50  30  	in_invoice_id	      IN NUMBER,
14:33:50  31  	in_instrument_type_id IN NUMBER,
14:33:50  32  	in_instrument_id      IN NUMBER,
14:33:50  33  	in_created_by	      IN VARCHAR2
14:33:50  34  );
14:33:50  35  
14:33:50  36  PROCEDURE SUSPEND_SUBSCRIPTION(
14:33:50  37  /*
14:33:50  38  Throws exceptions:
14:33:50  39  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50  40  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:50  41  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50  42  */
14:33:50  43  	  in_subs_id	IN NUMBER ,
14:33:50  44  	  in_updated_by IN VARCHAR2
14:33:50  45  );
14:33:50  46  
14:33:50  47  PROCEDURE REACTIVATE_SUBSCRIPTION (
14:33:50  48  	in_subscription_id IN  NUMBER,
14:33:50  49  	in_updated_by	   IN  VARCHAR2
14:33:50  50  );
14:33:50  51  
14:33:50  52  PROCEDURE GET_SUBSCRIPTION_INFO (
14:33:50  53  /*
14:33:50  54  Throws exceptions:
14:33:50  55  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50  56  */
14:33:50  57  	  in_subscription_id IN  NUMBER,
14:33:50  58  	  out_result_set      OUT SYS_REFCURSOR
14:33:50  59  );
14:33:50  60  
14:33:50  61  PROCEDURE GET_SUBSCRIPTION_INVOICES (
14:33:50  62  /*
14:33:50  63  Throws exceptions:
14:33:50  64  APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:50  65  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50  66  */
14:33:50  67  	in_subscription_id  IN	NUMBER,
14:33:50  68  	out_result_set	    OUT SYS_REFCURSOR
14:33:50  69  );
14:33:50  70  
14:33:50  71  PROCEDURE GET_SUBSCRIPTION_NOTES (
14:33:50  72  /*
14:33:50  73  Throws exceptions:
14:33:50  74  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50  75  */
14:33:50  76  	in_subscription_id  IN	NUMBER,
14:33:50  77  	out_result_set	    OUT SYS_REFCURSOR
14:33:50  78  );
14:33:50  79  
14:33:50  80  PROCEDURE ANNOTATE_SUBSCRIPTION (
14:33:50  81  /*
14:33:50  82  Throws exceptions:
14:33:50  83  APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:50  84  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50  85  */
14:33:50  86  	in_subscription_id IN  NUMBER,
14:33:50  87  	in_agent_id	   IN  NUMBER,
14:33:50  88  	in_note 	   IN  VARCHAR2,
14:33:50  89  	in_created_by	   IN  VARCHAR2
14:33:50  90  );
14:33:50  91  
14:33:50  92  PROCEDURE GET_CANCEL_REASONS (
14:33:50  93  	out_result_set OUT    SYS_REFCURSOR
14:33:50  94  );
14:33:50  95  
14:33:50  96  FUNCTION GET_RENEWAL_DATE (
14:33:50  97  /*
14:33:50  98  Throws exceptions:
14:33:50  99  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50 100  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50 101  */
14:33:50 102  	in_subscription_id in NUMBER
14:33:50 103  ) RETURN DATE;
14:33:50 104  
14:33:50 105  FUNCTION GET_RECENT_CHARGE (
14:33:50 106  /*
14:33:50 107  Throws exceptions:
14:33:50 108  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50 109  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50 110  */
14:33:50 111  	in_subscription_id IN NUMBER
14:33:50 112  ) RETURN NUMBER;
14:33:50 113  
14:33:50 114  FUNCTION GET_BILLING_CYCLE (
14:33:50 115  /*
14:33:50 116  Throws exceptions:
14:33:50 117  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50 118  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50 119  */
14:33:50 120  	in_subscription_id IN NUMBER
14:33:50 121  ) RETURN VARCHAR2;
14:33:50 122  
14:33:50 123  PROCEDURE REFUND_SUBSCRIPTION (
14:33:50 124  /*
14:33:50 125  Throws exceptions:
14:33:50 126  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50 127  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50 128  */
14:33:50 129  	in_subscription_id IN NUMBER,
14:33:50 130  	in_invoice_id	   IN NUMBER,
14:33:50 131  	in_refund_amount   IN NUMBER,
14:33:50 132  	in_note 	   IN VARCHAR2,
14:33:50 133  	in_created_by	   IN VARCHAR2,
14:33:50 134  	out_charge_id	   OUT NUMBER
14:33:50 135  );
14:33:50 136  
14:33:50 137  PROCEDURE ADD_SUBSCRIPTION_EXTENSION (
14:33:50 138  /*
14:33:50 139  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50 140  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:50 141  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50 142  */
14:33:50 143  	in_subscription_id	IN NUMBER,
14:33:50 144  	in_effective_start_date IN DATE,
14:33:50 145  	in_effective_end_date	IN DATE,
14:33:50 146  	in_note 		IN VARCHAR2,
14:33:50 147  	in_updated_by		IN VARCHAR2
14:33:50 148  );
14:33:50 149  
14:33:50 150  FUNCTION CALC_SUBSCRIPTION_END_DATE (
14:33:50 151  /*
14:33:50 152  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50 153  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:50 154  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50 155  Returns:
14:33:50 156  NULL if it is impossible to calculate end date (for example,
14:33:50 157  	offer chain includes offer with infinity recurrences number)
14:33:50 158  DATE else
14:33:50 159  */
14:33:50 160  	in_subscription_id IN NUMBER
14:33:50 161  ) RETURN DATE;
14:33:50 162  
14:33:50 163  PROCEDURE HAS_FUTURE_LICENSE (
14:33:50 164  /*
14:33:50 165  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50 166  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50 167  */
14:33:50 168  	in_license_id IN  NUMBER,
14:33:50 169  	out_result    OUT NUMBER
14:33:50 170  );
14:33:50 171  
14:33:50 172  PROCEDURE CLOSE_SUBSCRIPTION (
14:33:50 173  	in_subscription_id IN NUMBER,
14:33:50 174  	in_updated_by	   IN VARCHAR2
14:33:50 175  );
14:33:50 176  
14:33:50 177  PROCEDURE GET_GROUP_ID_BY_SBSCRPTN_ID (
14:33:50 178  	in_subscription_id IN NUMBER,
14:33:50 179  	out_group_id	   OUT NUMBER
14:33:50 180  );
14:33:50 181  
14:33:50 182  PROCEDURE GET_SUBSCRIPTION_PRODUCTS (
14:33:50 183  /*
14:33:50 184  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50 185  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50 186  */
14:33:50 187  	in_subscription_id IN NUMBER,
14:33:50 188  	out_result_set	   OUT SYS_REFCURSOR
14:33:50 189  );
14:33:50 190  
14:33:50 191  PROCEDURE UPDATE_SUBSCRIPTION_STATUS (
14:33:50 192  /*
14:33:50 193  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50 194  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50 195  */
14:33:50 196  	in_subscription_id	  IN SUBSCRIPTION.ID%TYPE,
14:33:50 197  	in_subscription_status_id IN SUBSCRIPTION.SUBSCRIPTION_STATUS_ID%TYPE,
14:33:50 198  	in_updated_by		  IN SUBSCRIPTION.UPDATED_BY%TYPE
14:33:50 199  );
14:33:50 200  
14:33:50 201  PROCEDURE GET_ACTIVE_INVOICES_IDS (
14:33:50 202  /*
14:33:50 203  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50 204  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50 205  */
14:33:50 206  --  in_subscription_id IN SUBSCRIPTION.ID%TYPE,
14:33:50 207  	in_subscription_id IN NUMBER,
14:33:50 208  	out_result_set	   OUT SYS_REFCURSOR
14:33:50 209  );
14:33:50 210  
14:33:50 211  PROCEDURE CANCEL_SUBSCRIPTION_INVOICE (
14:33:50 212  /*
14:33:50 213  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50 214  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50 215  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:50 216  */
14:33:50 217  	in_invoice_id	     IN NUMBER,
14:33:50 218  	in_updated_by	     IN VARCHAR2,
14:33:50 219  	in_refundable	     IN NUMBER DEFAULT GLOBAL_CONSTANTS_V22.FALSE
14:33:50 220  );
14:33:50 221  
14:33:50 222  PROCEDURE FINALIZE_CANCELATION (
14:33:50 223  /*
14:33:50 224  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50 225  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50 226  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:50 227  */
14:33:50 228  --  in_subscription_id	IN SUBSCRIPTION.ID%TYPE,
14:33:50 229  --  in_cancelation_reason IN SUBSCRIPTION_CANCEL_REASON.VALUE%TYPE,
14:33:50 230  --  in_cancelation_date	IN SUBSCRIPTION.CANCELLATION_DATE%TYPE,
14:33:50 231  --  in_note		IN SUBSCRIPTION_NOTE.NOTE%TYPE,
14:33:50 232  --  in_agent_id		IN SUBSCRIPTION_NOTE.AGENT_ID%TYPE,
14:33:50 233  --  in_updated_by 	IN SUBSCRIPTION.UPDATED_BY%TYPE
14:33:50 234  	in_subscription_id    IN NUMBER,
14:33:50 235  	in_cancelation_reason IN VARCHAR2,
14:33:50 236  	in_cancelation_date   IN DATE,
14:33:50 237  	in_note 	      IN VARCHAR2,
14:33:50 238  	in_agent_id	      IN NUMBER,
14:33:50 239  	in_updated_by	      IN VARCHAR2
14:33:50 240  );
14:33:50 241  
14:33:50 242  PROCEDURE FINALIZE_FALSE_START (
14:33:50 243  /*
14:33:50 244  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50 245  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50 246  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:50 247  */
14:33:50 248  --  in_subscription_id	IN SUBSCRIPTION.ID%TYPE,
14:33:50 249  --  in_cancelation_date	IN SUBSCRIPTION.CANCELLATION_DATE%TYPE,
14:33:50 250  --  in_note		IN SUBSCRIPTION_NOTE.NOTE%TYPE,
14:33:50 251  --  in_agent_id		IN SUBSCRIPTION_NOTE.AGENT_ID%TYPE,
14:33:50 252  --  in_updated_by 	IN SUBSCRIPTION.UPDATED_BY%TYPE
14:33:50 253  	in_subscription_id    IN NUMBER,
14:33:50 254  	in_cancelation_date   IN DATE,
14:33:50 255  	in_note 	      IN VARCHAR2,
14:33:50 256  	in_agent_id	      IN NUMBER,
14:33:50 257  	in_updated_by	      IN VARCHAR2
14:33:50 258  );
14:33:50 259  
14:33:50 260  FUNCTION IS_SUBSCRIPTION_CANCELABLE (
14:33:50 261  	in_subscription_id IN NUMBER
14:33:50 262  ) RETURN NUMBER;
14:33:50 263  
14:33:50 264  PROCEDURE GET_SUBSCR_PROD_OFFERRINGS (
14:33:50 265  /*
14:33:50 266  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50 267  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50 268  */
14:33:50 269  	in_subscription_id IN NUMBER,
14:33:50 270  	out_result_set	   OUT SYS_REFCURSOR
14:33:50 271  );
14:33:50 272  
14:33:50 273  PROCEDURE RETRIEVE_SUB_PROD_OFFER (
14:33:50 274  /*
14:33:50 275  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50 276  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50 277  */
14:33:50 278  	in_subscription_id IN NUMBER,
14:33:50 279  	out_result_set	   OUT SYS_REFCURSOR
14:33:50 280  );
14:33:50 281  
14:33:50 282  PROCEDURE GET_SUBSCR_LIC_OFFER (
14:33:50 283  /*
14:33:50 284  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50 285  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50 286  */
14:33:50 287  	in_subscription_id IN NUMBER,
14:33:50 288  	out_result_set	   OUT SYS_REFCURSOR
14:33:50 289  );
14:33:50 290  
14:33:50 291  PROCEDURE ARE_REFUNDS_PENDING_FOR_SUBSCR (
14:33:50 292  /*
14:33:50 293  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50 294  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50 295  */
14:33:50 296  	in_subscription_id IN NUMBER,
14:33:50 297  	out_result	   OUT NUMBER
14:33:50 298  );
14:33:50 299  
14:33:50 300  PROCEDURE GET_EXISTING_SUBSCR_NUMBER (
14:33:50 301  /*
14:33:50 302  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50 303  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50 304  */
14:33:50 305  	in_group_id	   IN NUMBER,
14:33:50 306  	in_offer_chain_id  IN NUMBER,
14:33:50 307  	out_result	   out number
14:33:50 308  );
14:33:50 309  
14:33:50 310  PROCEDURE GET_EXISTING_SUBSCR_IDS (
14:33:50 311  /*
14:33:50 312  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50 313  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50 314  */
14:33:50 315  	in_group_id	   IN NUMBER,
14:33:50 316  	in_offer_chain_id  IN NUMBER,
14:33:50 317  	out_result_set	   OUT SYS_REFCURSOR
14:33:50 318  );
14:33:50 319  
14:33:50 320  PROCEDURE ADD_META_DATA (
14:33:50 321  /*
14:33:50 322  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:50 323  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50 324  */
14:33:50 325  	in_subscription_id IN NUMBER,
14:33:50 326  	in_name 	   IN VARCHAR2,
14:33:50 327  	in_value	   IN VARCHAR2,
14:33:50 328  	in_created_by	   IN VARCHAR2
14:33:50 329  );
14:33:50 330  
14:33:50 331  PROCEDURE GET_SUBSCRIPTIONS_META_DATA (
14:33:50 332  /*
14:33:50 333  APP_EXCEPTION_CODES_V22.INVALID_PARAMETER
14:33:50 334  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50 335  */
14:33:50 336  	in_subscriptions_ids IN core_owner.NUMBER_TABLE,
14:33:50 337  	out_result_set	     OUT SYS_REFCURSOR
14:33:50 338  );
14:33:50 339  
14:33:50 340  PROCEDURE GET_SUBS_BY_TRNS_ORDER_ID (
14:33:50 341  /*
14:33:50 342  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50 343  */
14:33:50 344  	in_order_id	   IN TRANSACTION.ORDER_ID%TYPE,
14:33:50 345  	out_result_set	   OUT SYS_REFCURSOR
14:33:50 346  );
14:33:50 347  
14:33:50 348  PROCEDURE GET_OPEN_CHARGES_BY_SUBID
14:33:50 349   (
14:33:50 350  /*
14:33:50 351  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:50 352  */
14:33:50 353  	in_subscription_id  IN SUBSCRIPTION.ID%TYPE,
14:33:50 354  	out_result_set	    OUT SYS_REFCURSOR
14:33:50 355  );
14:33:50 356  
14:33:50 357  FUNCTION GET_GIFT_CERT_ID_BY_SUB_ID (
14:33:50 358  	in_subscription_id IN SUBSCRIPTION.ID%TYPE
14:33:50 359  ) RETURN NUMBER;
14:33:50 360  
14:33:50 361  FUNCTION GET_GIFT_CERT_CODE_BY_SUB_ID (
14:33:50 362  	in_subscription_id IN SUBSCRIPTION.ID%TYPE
14:33:50 363  ) RETURN VARCHAR2;
14:33:50 364  
14:33:50 365  
14:33:50 366  
14:33:50 367  PROCEDURE GET_ACTIVE_MEU_SUBS (
14:33:50 368  	out_result_set	    OUT SYS_REFCURSOR
14:33:50 369  );
14:33:50 370  
14:33:50 371  PROCEDURE GET_EARLIEST_ACTIVE_OFFER_ID (
14:33:50 372  	in_subscription_id  IN SUBSCRIPTION.ID%TYPE,
14:33:50 373  	out_offer_id	    OUT LICENSE.ID%TYPE
14:33:50 374  );
14:33:50 375  
14:33:50 376  PROCEDURE GET_EARLIEST_ACTIVE_LICENSE_ID (
14:33:50 377  	in_subscription_id  IN SUBSCRIPTION.ID%TYPE,
14:33:50 378  	out_license_id	    OUT LICENSE.ID%TYPE
14:33:50 379  );
14:33:50 380  
14:33:50 381  PROCEDURE GET_ACT_SUBS_W_CPT_CHARGEBACKS (
14:33:50 382  	out_result_set	    OUT SYS_REFCURSOR
14:33:50 383  );
14:33:50 384  
14:33:50 385  PROCEDURE GET_ACT_SUBS_W_PP_CHARGEBACKS (
14:33:50 386  	out_result_set	    OUT SYS_REFCURSOR
14:33:50 387  );
14:33:50 388  
14:33:50 389  PROCEDURE GET_ACT_SUBS_W_AMEX_CB (
14:33:50 390  	out_result_set	    OUT SYS_REFCURSOR
14:33:50 391  );
14:33:50 392  
14:33:50 393  PROCEDURE GET_GRACE_PERIOD_SUB_REGIS (
14:33:50 394  	in_max_days_until_close IN NUMBER,
14:33:50 395  	in_num_subs_to_fetch	IN NUMBER,
14:33:50 396  	out_result_set		OUT SYS_REFCURSOR
14:33:50 397  );
14:33:50 398  
14:33:50 399  
14:33:50 400  END PROCS_SUBSCRIPTION_V22;
14:33:50 401  .
14:33:50 SQL> /

Package created.

Elapsed: 00:00:00.05
14:33:50 SQL> 
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> -- DDL for package PROCS_SUBSCRIPTION_CRU
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> 
14:33:50 SQL> CREATE OR REPLACE PACKAGE "PROCS_SUBSCRIPTION_CRU_V22" AS
14:33:50   2  
14:33:50   3  PROCEDURE CREATE_SUBSCRIPTION(
14:33:50   4  	out_subscription_id	     OUT SUBSCRIPTION.ID%TYPE,
14:33:50   5  	in_subscription_id	     IN SUBSCRIPTION.ID%TYPE DEFAULT NULL,
14:33:50   6  	in_suspend_date 	     IN SUBSCRIPTION.SUSPEND_DATE%TYPE DEFAULT NULL,
14:33:50   7  	in_account_id		     IN SUBSCRIPTION.ACCOUNT_ID%TYPE,
14:33:50   8  	in_purchase_date	     IN SUBSCRIPTION.PURCHASE_DATE%TYPE,
14:33:50   9  	in_offer_chain_id	     IN SUBSCRIPTION.OFFER_CHAIN_ID%TYPE,
14:33:50  10  	in_termination_date	     IN SUBSCRIPTION.TERMINATION_DATE%TYPE DEFAULT NULL,
14:33:50  11  	in_days_remainning_ajustment IN SUBSCRIPTION.DAYS_REMAINING_ADJUSTMENT%TYPE DEFAULT NULL,
14:33:50  12  	in_sct_id		     IN SUBSCRIPTION.SCT_ID%TYPE DEFAULT NULL,
14:33:50  13  	in_created_by		     IN SUBSCRIPTION.CREATED_BY%TYPE,
14:33:50  14  	in_instrument_type_id	     IN SUBSCRIPTION.INSTRUMENT_TYPE_ID%TYPE,
14:33:50  15  	in_instrument_id	     IN SUBSCRIPTION.INSTRUMENT_ID%TYPE,
14:33:50  16  	in_subscription_status_id    IN SUBSCRIPTION.SUBSCRIPTION_STATUS_ID%TYPE,
14:33:50  17  	in_cancelation_date	     IN SUBSCRIPTION.CANCELLATION_DATE%TYPE DEFAULT NULL,
14:33:50  18  	in_reactivation_date	     IN SUBSCRIPTION.REACTIVATION_DATE%TYPE DEFAULT NULL
14:33:50  19  );
14:33:50  20  
14:33:50  21  PROCEDURE UPDATE_SUBSCRIPTION(
14:33:50  22  	in_subscription_id	     IN SUBSCRIPTION.ID%TYPE,
14:33:50  23  	in_suspend_date 	     IN SUBSCRIPTION.SUSPEND_DATE%TYPE DEFAULT NULL,
14:33:50  24  	in_purchase_date	     IN SUBSCRIPTION.PURCHASE_DATE%TYPE DEFAULT NULL,
14:33:50  25  	in_termination_date	     IN SUBSCRIPTION.TERMINATION_DATE%TYPE DEFAULT NULL,
14:33:50  26  	in_days_remainning_ajustment IN SUBSCRIPTION.DAYS_REMAINING_ADJUSTMENT%TYPE DEFAULT NULL,
14:33:50  27  	in_sct_id		     IN SUBSCRIPTION.SCT_ID%TYPE DEFAULT NULL,
14:33:50  28  	in_updated_by		     IN SUBSCRIPTION.CREATED_BY%TYPE DEFAULT NULL,
14:33:50  29  	in_instrument_type_id	     IN SUBSCRIPTION.INSTRUMENT_TYPE_ID%TYPE DEFAULT NULL,
14:33:50  30  	in_instrument_id	     IN SUBSCRIPTION.INSTRUMENT_ID%TYPE DEFAULT NULL,
14:33:50  31  	in_subscription_status_id    IN SUBSCRIPTION.SUBSCRIPTION_STATUS_ID%TYPE DEFAULT NULL,
14:33:50  32  	in_cancelation_date	     IN SUBSCRIPTION.CANCELLATION_DATE%TYPE DEFAULT NULL,
14:33:50  33  	in_reactivation_date	     IN SUBSCRIPTION.REACTIVATION_DATE%TYPE DEFAULT NULL
14:33:50  34  );
14:33:50  35  
14:33:50  36  PROCEDURE CREATE_SUBSCRIPTION_NOTE (
14:33:50  37  	inout_subscription_note_id IN OUT SUBSCRIPTION_NOTE.ID%TYPE,
14:33:50  38  	in_agent_id		   IN SUBSCRIPTION_NOTE.AGENT_ID%TYPE,
14:33:50  39  	in_subscription_id	   IN SUBSCRIPTION_NOTE.ID%TYPE,
14:33:50  40  	in_note 		   IN SUBSCRIPTION_NOTE.NOTE%TYPE,
14:33:50  41  	in_created_by		   IN SUBSCRIPTION_NOTE.CREATED_BY%TYPE
14:33:50  42  );
14:33:50  43  
14:33:50  44  END PROCS_SUBSCRIPTION_CRU_V22;
14:33:50  45  .
14:33:50 SQL> /

Package created.

Elapsed: 00:00:00.04
14:33:50 SQL> 
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> -- DDL for package PROCS_SYSTEM
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> 
14:33:50 SQL> CREATE OR REPLACE PACKAGE "PROCS_SYSTEM_V22" AS
14:33:50   2  
14:33:50   3  PROCEDURE INCREMENT_VERSION;
14:33:50   4  
14:33:50   5  PROCEDURE CHECK_VERSION(
14:33:50   6  	  in_vers    IN NUMBER,
14:33:50   7  	  out_result OUT NUMBER
14:33:50   8  );
14:33:50   9  
14:33:50  10  END PROCS_SYSTEM_V22;
14:33:50  11  .
14:33:50 SQL> /

Package created.

Elapsed: 00:00:00.02
14:33:50 SQL> 
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> -- DDL for package PROCS_TAXES
14:33:50 SQL> --------------------------------------------------------------------------------
14:33:50 SQL> 
14:33:50 SQL> CREATE OR REPLACE PACKAGE "PROCS_TAXES_V22" AS
14:33:50   2  
14:33:50   3  PROCEDURE ADD_TAX (
14:33:50   4  	in_tax_type_id		 IN NUMBER,
14:33:50   5  	in_calculated_amount	 IN NUMBER,
14:33:50   6  	in_created_by		 IN VARCHAR2,
14:33:50   7  	in_line_item_id 	 IN NUMBER,
14:33:50   8  	in_effective_rate	 IN VARCHAR2,
14:33:50   9  	in_taxable_amount	 IN NUMBER,
14:33:50  10  	in_tax_rule_id		 IN NUMBER,
14:33:50  11  	in_jurisdiction_level_id IN NUMBER,
14:33:50  12  	in_jurisdiction_name	 IN VARCHAR2,
14:33:50  13  	in_jurisdiction_id	 IN VARCHAR2,
14:33:50  14  	in_ext_tax_type 	 IN VARCHAR2,
14:33:50  15  	in_ext_result		 IN VARCHAR2,
14:33:50  16  	in_imposition_type	 IN VARCHAR2,
14:33:50  17  	in_imposition		 IN VARCHAR2
14:33:50  18  );
14:33:50  19  
14:33:50  20  PROCEDURE CHECK_COUNTRY_FOR_EXCLUSION (
14:33:50  21  	in_country_code IN CHAR,
14:33:50  22  	in_check_date IN DATE,
14:33:50  23  	out_is_founded	OUT NUMBER -- GLOBAL_CONSTANT.TRUE of GLOBAL_CONSTANTS_V22.FALSE
14:33:50  24  );
14:33:50  25  
14:33:50  26  PROCEDURE GET_TAX_CATEGORY (
14:33:50  27  	in_tax_category_id IN NUMBER,
14:33:50  28  	out_result_set	   OUT SYS_REFCURSOR
14:33:50  29  );
14:33:50  30  
14:33:50  31  END PROCS_TAXES_V22;
14:33:50  32  .
14:33:50 SQL> /

Package created.

Elapsed: 00:00:00.08
14:33:51 SQL> 
14:33:51 SQL> --------------------------------------------------------------------------------
14:33:51 SQL> -- DDL for package PROCS_TAXES_CRU
14:33:51 SQL> --------------------------------------------------------------------------------
14:33:51 SQL> 
14:33:51 SQL> CREATE OR REPLACE PACKAGE "PROCS_TAXES_CRU_V22" AS
14:33:51   2  
14:33:51   3  PROCEDURE CREATE_TAX (
14:33:51   4  	inout_tax_id		 IN OUT NUMBER,
14:33:51   5  	in_tax_type_id		 IN NUMBER,
14:33:51   6  	in_calculated_amount	 IN NUMBER,
14:33:51   7  	in_created_by		 IN VARCHAR2,
14:33:51   8  	in_line_item_id 	 IN NUMBER,
14:33:51   9  	in_effective_rate	 IN VARCHAR2,
14:33:51  10  	in_taxable_amount	 IN NUMBER,
14:33:51  11  	in_tax_rule_id		 IN NUMBER,
14:33:51  12  	in_jurisdiction_level_id IN NUMBER,
14:33:51  13  	in_jurisdiction_name	 IN VARCHAR2,
14:33:51  14  	in_jurisdiction_id	 IN VARCHAR2,
14:33:51  15  	in_ext_tax_type 	 IN VARCHAR2,
14:33:51  16  	in_ext_result		 IN VARCHAR2,
14:33:51  17  	in_imposition_type	 IN VARCHAR2,
14:33:51  18  	in_imposition		 IN VARCHAR2
14:33:51  19  );
14:33:51  20  
14:33:51  21  END PROCS_TAXES_CRU_V22;
14:33:51  22  .
14:33:51 SQL> /

Package created.

Elapsed: 00:00:00.03
14:33:51 SQL> 
14:33:51 SQL> --------------------------------------------------------------------------------
14:33:51 SQL> -- DDL for package PROCS_TEST
14:33:51 SQL> --------------------------------------------------------------------------------
14:33:51 SQL> 
14:33:51 SQL> CREATE OR REPLACE PACKAGE "PROCS_TEST_V22" AS
14:33:51   2  
14:33:51   3  PROCEDURE TEST_CLEAR_ALL;
14:33:51   4  PROCEDURE TEST_CLEAR_PRODUCTS;
14:33:51   5  
14:33:51   6  /********************************************/
14:33:51   7  
14:33:51   8  PROCEDURE TEST_GET_ACCOUNT (
14:33:51   9  	in_group_id	IN NUMBER,
14:33:51  10  	out_result_set	OUT SYS_REFCURSOR
14:33:51  11  );
14:33:51  12  
14:33:51  13  /********************************************/
14:33:51  14  
14:33:51  15  PROCEDURE TEST_GET_SUBSCRIPTION (
14:33:51  16  	in_subscription_id IN NUMBER,
14:33:51  17  	out_result_set	   OUT SYS_REFCURSOR
14:33:51  18  );
14:33:51  19  
14:33:51  20  /*********************************************/
14:33:51  21  
14:33:51  22  PROCEDURE TEST_DELETE_INVOICE (
14:33:51  23  	in_invoice_id IN NUMBER
14:33:51  24  );
14:33:51  25  
14:33:51  26  PROCEDURE TEST_DELETE_USER_ACCOUNT (
14:33:51  27  	in_group_id IN NUMBER
14:33:51  28  );
14:33:51  29  
14:33:51  30  PROCEDURE TEST_DELETE_USER_ACCOUNTS  (
14:33:51  31  	in_start_group_id IN NUMBER,
14:33:51  32  	in_end_group_id   IN NUMBER
14:33:51  33  );
14:33:51  34  
14:33:51  35  /**********************************************/
14:33:51  36  
14:33:51  37  FUNCTION TEST_IS_INVOICE_EXISTS(
14:33:51  38  /*
14:33:51  39  1 - exists
14:33:51  40  0 - not exists
14:33:51  41  */
14:33:51  42  	in_invoice_id IN NUMBER
14:33:51  43  ) RETURN NUMBER;
14:33:51  44  
14:33:51  45  PROCEDURE TEST_GET_INVOICE_INFO (
14:33:51  46  	in_invoice_id  IN NUMBER,
14:33:51  47  	out_result_set OUT SYS_REFCURSOR
14:33:51  48  );
14:33:51  49  
14:33:51  50  /******************************************************************************/
14:33:51  51  
14:33:51  52  PROCEDURE TEST_DELETE_OFFER_CHAIN(
14:33:51  53  	in_offer_chain_id in number
14:33:51  54  );
14:33:51  55  
14:33:51  56  END PROCS_TEST_V22;
14:33:51  57  .
14:33:51 SQL> /

Package created.

Elapsed: 00:00:00.03
14:33:51 SQL> 
14:33:51 SQL> --------------------------------------------------------------------------------
14:33:51 SQL> -- DDL for package PROCS_TRANSACTION
14:33:51 SQL> --------------------------------------------------------------------------------
14:33:51 SQL> 
14:33:51 SQL> CREATE OR REPLACE PACKAGE "PROCS_TRANSACTION_V22" AS
14:33:51   2  
14:33:51   3  PROCEDURE CREATE_TRANSACTION (
14:33:51   4  /*
14:33:51   5  Throws exceptions:
14:33:51   6  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51   7  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51   8  */
14:33:51   9  	in_transaction_id	  IN NUMBER,
14:33:51  10  	in_status_id		  IN NUMBER,
14:33:51  11  	in_amount		  IN NUMBER,
14:33:51  12  	in_created_by		  IN VARCHAR2,
14:33:51  13  	in_order_id		  IN VARCHAR2,
14:33:51  14  	in_is_refund		  IN NUMBER DEFAULT GLOBAL_CONSTANTS_V22.FALSE,
14:33:51  15  	in_transaction_type_code  IN VARCHAR2 DEFAULT NULL,
14:33:51  16  	out_transaction_id	  OUT NUMBER
14:33:51  17  );
14:33:51  18  
14:33:51  19  PROCEDURE CREATE_TRANSACTION_ATTEMPT (
14:33:51  20  /*
14:33:51  21  Throws exceptions:
14:33:51  22  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51  23  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  24  */
14:33:51  25  	in_transaction_id	   IN NUMBER,
14:33:51  26  	in_trans_attempt_status    IN NUMBER,
14:33:51  27  	in_external_status_code    IN VARCHAR2,
14:33:51  28  	in_external_status_message IN VARCHAR2,
14:33:51  29  	in_created_by		   IN VARCHAR2,
14:33:51  30  	in_ext_transaction_id	   IN VARCHAR2,
14:33:51  31  	out_transaction_attempt_id OUT NUMBER
14:33:51  32  );
14:33:51  33  
14:33:51  34  PROCEDURE UPDATE_TRANSACTION_STATUS (
14:33:51  35  /*
14:33:51  36  Throws exceptions:
14:33:51  37  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51  38  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  39  */
14:33:51  40  	in_transaction_id	 IN NUMBER,
14:33:51  41  	in_updated_by		 IN VARCHAR2,
14:33:51  42  	in_transaction_status_id IN NUMBER
14:33:51  43  );
14:33:51  44  
14:33:51  45  PROCEDURE UPDATE_TRANSACTION_SETTLED (
14:33:51  46  /*
14:33:51  47  Throws exceptions:
14:33:51  48  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51  49  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  50  */
14:33:51  51  	in_transaction_id	 IN NUMBER,
14:33:51  52  	in_updated_by		 IN VARCHAR2,
14:33:51  53  	in_is_settled		 IN NUMBER
14:33:51  54  );
14:33:51  55  
14:33:51  56  PROCEDURE UPDATE_TRNSCTN_ATTEMPT_TIME (
14:33:51  57  /*
14:33:51  58  Throws exceptions:
14:33:51  59  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51  60  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  61  */
14:33:51  62  	in_transaction_attempt_id IN NUMBER,
14:33:51  63  	in_updated_by		  IN VARCHAR2
14:33:51  64  );
14:33:51  65  
14:33:51  66  PROCEDURE UPDATE_TRNSCTN_ATTEMPT_STATUS (
14:33:51  67  /*
14:33:51  68  Throws exceptions:
14:33:51  69  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51  70  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  71  */
14:33:51  72  	in_transaction_attempt_id     IN NUMBER,
14:33:51  73  	in_transaction_attempt_status IN NUMBER
14:33:51  74  );
14:33:51  75  
14:33:51  76  PROCEDURE GET_TRNSCTN_ATTEMPTS_BY_STATUS (
14:33:51  77  /*
14:33:51  78  Throws exceptions:
14:33:51  79  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  80  */
14:33:51  81  	in_transaction_id	      IN NUMBER,
14:33:51  82  	in_transaction_attempt_status IN NUMBER,
14:33:51  83  	out_result_set		      OUT SYS_REFCURSOR
14:33:51  84  );
14:33:51  85  
14:33:51  86  PROCEDURE UPDATE_TRANSACTION_ATTEMPT_INF (
14:33:51  87  /*
14:33:51  88  Throws exceptions:
14:33:51  89  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51  90  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  91  */
14:33:51  92  	in_transaction_attempt_id IN NUMBER,
14:33:51  93  	in_ext_status_code	  IN VARCHAR2,
14:33:51  94  	in_ext_status_message	  IN VARCHAR2,
14:33:51  95  	in_ext_transaction_id	  IN VARCHAR2
14:33:51  96  );
14:33:51  97  
14:33:51  98  PROCEDURE GET_FAILED_ATTEMPTS_NUMBER (
14:33:51  99  /*
14:33:51 100  Throws exceptions:
14:33:51 101  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 102  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 103  */
14:33:51 104  	in_transaction_id IN  NUMBER,
14:33:51 105  	out_attempts_num  OUT NUMBER
14:33:51 106  );
14:33:51 107  
14:33:51 108  PROCEDURE GET_TRANSACTION_AMOUNT (
14:33:51 109  /*
14:33:51 110  Throws exceptions:
14:33:51 111  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 112  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 113  */
14:33:51 114  	in_transaction_id      IN  NUMBER,
14:33:51 115  	out_transaction_amount OUT NUMBER
14:33:51 116  );
14:33:51 117  
14:33:51 118  PROCEDURE GET_TRANSACTIONS_BY_CHARGE_ID (
14:33:51 119  /*
14:33:51 120  Throws exceptions:
14:33:51 121  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 122  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 123  */
14:33:51 124  	in_charge_id   IN  NUMBER,
14:33:51 125  	out_result_set OUT SYS_REFCURSOR
14:33:51 126  );
14:33:51 127  
14:33:51 128  PROCEDURE GET_TRANSACTION_BY_ORDER_ID (
14:33:51 129  /*
14:33:51 130  Throws exceptions:
14:33:51 131  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 132  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 133  */
14:33:51 134  	in_order_id   IN  TRANSACTION.ORDER_ID%TYPE,
14:33:51 135  	out_result_set OUT SYS_REFCURSOR
14:33:51 136  );
14:33:51 137  
14:33:51 138  PROCEDURE GET_TRANSACTIONS_BY_ORDER_ID (
14:33:51 139  /*
14:33:51 140  Throws exceptions:
14:33:51 141  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 142  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 143  */
14:33:51 144  	in_order_id   IN  TRANSACTION.ORDER_ID%TYPE,
14:33:51 145  	out_result_set OUT SYS_REFCURSOR
14:33:51 146  );
14:33:51 147  
14:33:51 148  PROCEDURE GET_TRANSACTION_ATTEMPTS (
14:33:51 149  /*
14:33:51 150  Throws exceptions:
14:33:51 151  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 152  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 153  */
14:33:51 154  	in_transaction_id IN  NUMBER,
14:33:51 155  	out_result_set	  OUT SYS_REFCURSOR
14:33:51 156  );
14:33:51 157  
14:33:51 158  PROCEDURE RESERVE_TRANSACTION_ID (
14:33:51 159  /*
14:33:51 160  Throws exceptions:
14:33:51 161  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 162  */
14:33:51 163  	out_transaction_id OUT NUMBER
14:33:51 164  );
14:33:51 165  
14:33:51 166  PROCEDURE GET_TRANSACTION_BY_ID (
14:33:51 167  /*
14:33:51 168  Throws exceptions:
14:33:51 169  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 170  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 171  */
14:33:51 172  	in_transaction_id IN NUMBER,
14:33:51 173  	out_result_set	  OUT SYS_REFCURSOR
14:33:51 174  );
14:33:51 175  
14:33:51 176  PROCEDURE UPDATE_TRANSACTION_ORDER_ID (
14:33:51 177  /*
14:33:51 178  Throws exceptions:
14:33:51 179  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 180  APP_EXCEPTION_CODES_V22.INTRNAL_ERROR
14:33:51 181  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 182  */
14:33:51 183  	in_transaction_id IN TRANSACTION.ID%TYPE,
14:33:51 184  	in_order_id	  IN TRANSACTION.ORDER_ID%TYPE,
14:33:51 185  	in_updated_by	  IN TRANSACTION.UPDATED_BY%TYPE
14:33:51 186  );
14:33:51 187  
14:33:51 188  PROCEDURE GET_CLOSED_REFUNDS_BY_INVOICE (
14:33:51 189  /*
14:33:51 190  Throws exceptions:
14:33:51 191  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 192  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 193  */
14:33:51 194  	in_invoice_id	IN  NUMBER,
14:33:51 195  	out_result_set OUT SYS_REFCURSOR
14:33:51 196  );
14:33:51 197  PROCEDURE IS_TRANSACTION_SUCCESSFULL (
14:33:51 198  /*
14:33:51 199  Throws exceptions:
14:33:51 200  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 201  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 202  */
14:33:51 203  	in_transaction_id IN  NUMBER,
14:33:51 204  	out_is_successfull  OUT NUMBER
14:33:51 205  );
14:33:51 206  
14:33:51 207  FUNCTION GET_TRANSACTION_TAX_AMOUNT (
14:33:51 208  	in_transaction_id IN NUMBER
14:33:51 209  ) RETURN NUMBER;
14:33:51 210  
14:33:51 211  FUNCTION GET_TRANSACTION_INTRL_TAXES (
14:33:51 212  	in_transaction_id IN NUMBER
14:33:51 213  ) RETURN NUMBER;
14:33:51 214  
14:33:51 215  -- norlov: #38796
14:33:51 216  PROCEDURE GET_TRANSACTIONS (
14:33:51 217  /*
14:33:51 218  Throws exceptions:
14:33:51 219  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 220  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 221  */
14:33:51 222  	in_group_id	      IN  NUMBER,
14:33:51 223  	in_invoice_id	      IN NUMBER DEFAULT NULL,
14:33:51 224  	in_subscription_id    IN NUMBER DEFAULT NULL,
14:33:51 225  	in_start_date	      IN TRANSACTION.CREATE_DATE%TYPE DEFAULT NULL,
14:33:51 226  	in_end_date	      IN TRANSACTION.CREATE_DATE%TYPE DEFAULT NULL,
14:33:51 227  	in_transaction_status IN NUMBER DEFAULT NULL,
14:33:51 228  	out_result_set	      OUT SYS_REFCURSOR
14:33:51 229  );
14:33:51 230  
14:33:51 231  FUNCTION IS_TRANSACTION_COLLECTED (
14:33:51 232  /*
14:33:51 233  Throws:
14:33:51 234  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 235  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 236  Returns:
14:33:51 237  GLOBAL_CONST.TRUE if transaction collected,
14:33:51 238  GLOBAL_CONST.FALSE else
14:33:51 239  */
14:33:51 240  	in_transaction_id IN NUMBER
14:33:51 241  ) RETURN NUMBER;
14:33:51 242  
14:33:51 243  PROCEDURE GET_NEXT_ATTEMPT_NUMBER (
14:33:51 244  /*
14:33:51 245  Throws exceptions:
14:33:51 246  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 247  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 248  */
14:33:51 249  	in_charge_id   in  number,
14:33:51 250  	out_attempt_count out number
14:33:51 251  );
14:33:51 252  
14:33:51 253  END PROCS_TRANSACTION_V22;
14:33:51 254  .
14:33:51 SQL> /

Package created.

Elapsed: 00:00:00.05
14:33:51 SQL> 
14:33:51 SQL> --------------------------------------------------------------------------------
14:33:51 SQL> -- DDL for package PROCS_TRANSACTION_CRU
14:33:51 SQL> --------------------------------------------------------------------------------
14:33:51 SQL> 
14:33:51 SQL> CREATE OR REPLACE PACKAGE "PROCS_TRANSACTION_CRU_V22" AS
14:33:51   2  
14:33:51   3  PROCEDURE CREATE_TRANSACTION (
14:33:51   4  	out_transaction_id	 OUT TRANSACTION.ID%TYPE,
14:33:51   5  	in_transaction_id	 IN TRANSACTION.ID%TYPE DEFAULT NULL,
14:33:51   6  	in_transaction_status_id IN TRANSACTION.TRANSACTION_STATUS_ID%TYPE,
14:33:51   7  	in_transaction_amount	 IN TRANSACTION.TRANSACTION_AMOUNT%TYPE,
14:33:51   8  	in_created_by		 IN TRANSACTION.CREATED_BY%TYPE,
14:33:51   9  	in_order_id		 IN TRANSACTION.ORDER_ID%TYPE,
14:33:51  10  	in_is_refund		 IN TRANSACTION.IS_REFUND%TYPE DEFAULT GLOBAL_CONSTANTS_V22.FALSE,
14:33:51  11  	in_transaction_type_code IN TRANSACTION.TRANSACTION_TYPE_CODE%TYPE DEFAULT NULL
14:33:51  12  );
14:33:51  13  
14:33:51  14  PROCEDURE UPDATE_TRANSACTION (
14:33:51  15  	in_transaction_id	 IN TRANSACTION.ID%TYPE,
14:33:51  16  	in_transaction_status_id IN TRANSACTION.TRANSACTION_STATUS_ID%TYPE DEFAULT NULL,
14:33:51  17  	in_transaction_amount	 IN TRANSACTION.TRANSACTION_AMOUNT%TYPE DEFAULT NULL,
14:33:51  18  	in_updated_by		 IN TRANSACTION.CREATED_BY%TYPE,
14:33:51  19  	in_order_id		 IN TRANSACTION.ORDER_ID%TYPE DEFAULT NULL,
14:33:51  20  	in_is_settled		 IN TRANSACTION.IS_SETTLED%TYPE DEFAULT NULL
14:33:51  21  );
14:33:51  22  
14:33:51  23  PROCEDURE READ_TRANSACTION (
14:33:51  24  	in_transaction_id IN TRANSACTION.ID%TYPE,
14:33:51  25  	out_result_set	  OUT SYS_REFCURSOR
14:33:51  26  );
14:33:51  27  
14:33:51  28  PROCEDURE CREATE_TRANSACTION_ATTEMPT(
14:33:51  29  	inout_transaction_attempt_id IN OUT TRANSACTION_ATTEMPT.ID%TYPE,
14:33:51  30  	in_transaction_id	     IN TRANSACTION_ATTEMPT.TRANSACTION_ID%TYPE,
14:33:51  31  	in_external_status_code      IN TRANSACTION_ATTEMPT.EXTERNAL_STATUS_CODE%TYPE DEFAULT NULL,
14:33:51  32  	in_external_status_message   IN TRANSACTION_ATTEMPT.EXTERNAL_STATUS_MESSAGE%TYPE DEFAULT NULL,
14:33:51  33  	in_created_by		     IN TRANSACTION_ATTEMPT.CREATED_BY%TYPE,
14:33:51  34  	in_external_transaction_id   IN TRANSACTION_ATTEMPT.EXTERNAL_TRANSACTION_ID%TYPE DEFAULT NULL,
14:33:51  35  	in_transaction_start_time    IN TRANSACTION_ATTEMPT.TRANSACTION_START_TIME%TYPE DEFAULT NULL,
14:33:51  36  	in_status_id		     IN TRANSACTION_ATTEMPT.TRANSACTION_ATTEMPT_STATUS_ID%TYPE
14:33:51  37  );
14:33:51  38  
14:33:51  39  PROCEDURE UPDATE_TRANSACTION_ORDER_ID (
14:33:51  40  /*
14:33:51  41  Throws exceptions:
14:33:51  42  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51  43  APP_EXCEPTION_CODES_V22.INTRNAL_ERROR
14:33:51  44  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  45  */
14:33:51  46  	in_transaction_id IN TRANSACTION.ID%TYPE,
14:33:51  47  	in_order_id	  IN TRANSACTION.ORDER_ID%TYPE,
14:33:51  48  	in_updated_by	  IN TRANSACTION.UPDATED_BY%TYPE
14:33:51  49  );
14:33:51  50  
14:33:51  51  PROCEDURE UPDATE_TRANSACTION_ATTEMPT (
14:33:51  52  	in_transaction_attempt_id  IN TRANSACTION_ATTEMPT.ID%TYPE,
14:33:51  53  	in_external_status_code    IN TRANSACTION_ATTEMPT.EXTERNAL_STATUS_CODE%TYPE DEFAULT NULL,
14:33:51  54  	in_external_status_message IN TRANSACTION_ATTEMPT.EXTERNAL_STATUS_MESSAGE%TYPE DEFAULT NULL,
14:33:51  55  	in_external_transaction_id IN TRANSACTION_ATTEMPT.EXTERNAL_TRANSACTION_ID%TYPE DEFAULT NULL,
14:33:51  56  	in_transaction_start_time  IN TRANSACTION_ATTEMPT.TRANSACTION_START_TIME%TYPE DEFAULT NULL,
14:33:51  57  	in_status_id		   IN TRANSACTION_ATTEMPT.TRANSACTION_ATTEMPT_STATUS_ID%TYPE DEFAULT NULL
14:33:51  58  );
14:33:51  59  
14:33:51  60  END PROCS_TRANSACTION_CRU_V22;
14:33:51  61  .
14:33:51 SQL> /

Package created.

Elapsed: 00:00:00.09
14:33:51 SQL> 
14:33:51 SQL> --------------------------------------------------------------------------------
14:33:51 SQL> -- DDL for package PUBLIC_PROCS_BILLING
14:33:51 SQL> --------------------------------------------------------------------------------
14:33:51 SQL> 
14:33:51 SQL> CREATE OR REPLACE PACKAGE "PUBLIC_PROCS_BILLING_V22" AS
14:33:51   2  
14:33:51   3  PROCEDURE GET_OFFER_CHAIN_BY_ID (
14:33:51   4  /*
14:33:51   5  Throws exceptions:
14:33:51   6  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51   7  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51   8  */
14:33:51   9  	  in_offer_chain_id IN	 NUMBER,
14:33:51  10  	  out_result_set    OUT  SYS_REFCURSOR
14:33:51  11  );
14:33:51  12  
14:33:51  13  PROCEDURE GET_GC_ID_BY_PURCH_INVOICE_ID (
14:33:51  14  /*
14:33:51  15  Throws exceptions:
14:33:51  16  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51  17  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  18  */
14:33:51  19  in_invoice_id IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
14:33:51  20  out_gift_certificate_id OUT GIFT_CERTIFICATE.ID%TYPE
14:33:51  21  );
14:33:51  22  
14:33:51  23  PROCEDURE GET_PENDING_INVOICES (
14:33:51  24  /*
14:33:51  25  Throws exceptions:
14:33:51  26  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  27  */
14:33:51  28  	out_result_set	     OUT SYS_REFCURSOR,
14:33:51  29  	in_row_number	     IN NUMBER DEFAULT NULL
14:33:51  30  );
14:33:51  31  
14:33:51  32  PROCEDURE GET_PENDING_REFUND_CHARGES (
14:33:51  33  /*
14:33:51  34  Throws exceptions:
14:33:51  35  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  36  */
14:33:51  37  	out_result_set	    OUT SYS_REFCURSOR,
14:33:51  38  	in_row_number	    IN NUMBER DEFAULT NULL
14:33:51  39  );
14:33:51  40  
14:33:51  41  PROCEDURE GET_UNPROCESSED_CHARGES (
14:33:51  42  /*
14:33:51  43  Throws exceptions:
14:33:51  44  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51  45  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  46  */
14:33:51  47  	in_invoice_id  IN NUMBER,
14:33:51  48  	out_result_set OUT SYS_REFCURSOR
14:33:51  49  );
14:33:51  50  
14:33:51  51  PROCEDURE GET_PROCESSED_CHARGES (
14:33:51  52  /*
14:33:51  53  Throws exceptions:
14:33:51  54  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51  55  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  56  */
14:33:51  57  	in_invoice_id  IN NUMBER,
14:33:51  58  	out_result_set OUT SYS_REFCURSOR
14:33:51  59  );
14:33:51  60  
14:33:51  61  PROCEDURE GET_TRNSCTN_ATTEMPTS_BY_STATUS (
14:33:51  62  /*
14:33:51  63  Throws exceptions:
14:33:51  64  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  65  */
14:33:51  66  	in_transaction_id	      IN NUMBER,
14:33:51  67  	in_transaction_attempt_status IN NUMBER,
14:33:51  68  	out_result_set		      OUT SYS_REFCURSOR
14:33:51  69  );
14:33:51  70  
14:33:51  71  PROCEDURE UPDATE_TRNSCTN_ATTEMPT_STATUS (
14:33:51  72  /*
14:33:51  73  Throws exceptions:
14:33:51  74  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51  75  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  76  */
14:33:51  77  	in_transaction_attempt_id     IN NUMBER,
14:33:51  78  	in_transaction_attempt_status IN NUMBER
14:33:51  79  );
14:33:51  80  
14:33:51  81  PROCEDURE UPDATE_TRNSCTN_ATTEMPT_TIME (
14:33:51  82  /*
14:33:51  83  Throws exceptions:
14:33:51  84  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51  85  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  86  */
14:33:51  87  	in_transaction_attempt_id IN NUMBER,
14:33:51  88  	in_updated_by		  IN VARCHAR2
14:33:51  89  );
14:33:51  90  
14:33:51  91  PROCEDURE CREATE_TRANSACTION_ATTEMPT (
14:33:51  92  /*
14:33:51  93  Throws exceptions:
14:33:51  94  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51  95  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  96  */
14:33:51  97  	in_transaction_id	   IN NUMBER,
14:33:51  98  	in_trans_attempt_status    IN NUMBER,
14:33:51  99  	in_external_status_code    IN VARCHAR2,
14:33:51 100  	in_external_status_message IN VARCHAR2,
14:33:51 101  	in_created_by		   IN VARCHAR2,
14:33:51 102  	in_ext_transaction_id	   IN VARCHAR2,
14:33:51 103  	out_transaction_attempt_id OUT NUMBER
14:33:51 104  );
14:33:51 105  
14:33:51 106  PROCEDURE UPDATE_TRANSACTION_ATTEMPT_INF (
14:33:51 107  /*
14:33:51 108  Throws exceptions:
14:33:51 109  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 110  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 111  */
14:33:51 112  	in_transaction_attempt_id IN NUMBER,
14:33:51 113  	in_ext_status_code	  IN VARCHAR2,
14:33:51 114  	in_ext_status_message	  IN VARCHAR2,
14:33:51 115  	in_ext_transaction_id	  IN VARCHAR2
14:33:51 116  );
14:33:51 117  
14:33:51 118  PROCEDURE UPDATE_TRANSACTION_STATUS (
14:33:51 119  /*
14:33:51 120  Throws exceptions:
14:33:51 121  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 122  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 123  */
14:33:51 124  	in_transaction_id	 IN NUMBER,
14:33:51 125  	in_updated_by		 IN VARCHAR2,
14:33:51 126  	in_transaction_status_id IN NUMBER
14:33:51 127  );
14:33:51 128  
14:33:51 129  PROCEDURE GET_FAILED_ATTEMPTS_NUMBER (
14:33:51 130  /*
14:33:51 131  Throws exceptions:
14:33:51 132  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 133  */
14:33:51 134  	in_transaction_id IN  NUMBER,
14:33:51 135  	out_attempts_num  OUT NUMBER
14:33:51 136  );
14:33:51 137  
14:33:51 138  PROCEDURE IS_TRANSACTION_SUCCESSFULL (
14:33:51 139  /*
14:33:51 140  Throws exceptions:
14:33:51 141  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 142  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 143  */
14:33:51 144  	in_transaction_id IN  NUMBER,
14:33:51 145  	out_is_successfull  OUT NUMBER
14:33:51 146  );
14:33:51 147  
14:33:51 148  PROCEDURE UPDATE_INVOICE_STATUS (
14:33:51 149  /*
14:33:51 150  Throws exceptions:
14:33:51 151  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 152  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 153  */
14:33:51 154  	in_invoice_id		       IN NUMBER,
14:33:51 155  	in_invoice_status_id	       IN NUMBER,
14:33:51 156  	in_updated_by		       IN VARCHAR2
14:33:51 157  );
14:33:51 158  
14:33:51 159  PROCEDURE SUSPEND_SUBSCRIPTION(
14:33:51 160  /*
14:33:51 161  Throws exceptions:
14:33:51 162  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 163  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:51 164  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 165  */
14:33:51 166  	  in_subs_id	IN NUMBER ,
14:33:51 167  	  in_updated_by IN VARCHAR2
14:33:51 168  );
14:33:51 169  
14:33:51 170  PROCEDURE GET_CREDIT_CARD_BY_ID (
14:33:51 171  /*
14:33:51 172  Throws exceptions:
14:33:51 173  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 174  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 175  */
14:33:51 176  	in_credit_card_id IN  NUMBER,
14:33:51 177  	out_result_set	  OUT SYS_REFCURSOR
14:33:51 178  );
14:33:51 179  
14:33:51 180  PROCEDURE GET_TRANSACTION_AMOUNT (
14:33:51 181  /*
14:33:51 182  Throws exceptions:
14:33:51 183  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 184  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 185  */
14:33:51 186  	in_transaction_id      IN  NUMBER,
14:33:51 187  	out_transaction_amount OUT NUMBER
14:33:51 188  );
14:33:51 189  
14:33:51 190  PROCEDURE GET_ACCOUNT_BY_INVOICE_ID (
14:33:51 191  /*
14:33:51 192  Throws exceptions:
14:33:51 193  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 194  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 195  */
14:33:51 196  	in_invoice_id  IN  NUMBER,
14:33:51 197  	out_account_id OUT NUMBER
14:33:51 198  );
14:33:51 199  
14:33:51 200  PROCEDURE GET_GIFT_CERTIFICATE_BY_ID (
14:33:51 201  /*
14:33:51 202  Throws exceptions:
14:33:51 203  APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:51 204  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 205  */
14:33:51 206  	in_gift_certificate_id IN NUMBER,
14:33:51 207  	out_result_set	       OUT SYS_REFCURSOR
14:33:51 208  );
14:33:51 209  
14:33:51 210  PROCEDURE GET_SUBSCR_ID_BY_CHARGE_ID (
14:33:51 211  /*
14:33:51 212  Throws exceptions:
14:33:51 213  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 214  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 215  */
14:33:51 216  	in_charge_id	    IN NUMBER,
14:33:51 217  	out_subscription_id OUT NUMBER
14:33:51 218  );
14:33:51 219  
14:33:51 220  PROCEDURE IS_GCERT_FOR_PROPER_OFFER (
14:33:51 221  /*
14:33:51 222  Throws exceptions:
14:33:51 223  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 224  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 225  */
14:33:51 226  	in_gift_certificate_id IN NUMBER,
14:33:51 227  	in_charge_id	       IN NUMBER,
14:33:51 228  	out_result	       OUT NUMBER
14:33:51 229  );
14:33:51 230  
14:33:51 231  PROCEDURE GET_SUBSCRIPTION_INFO (
14:33:51 232  /*
14:33:51 233  Throws exceptions:
14:33:51 234  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 235  */
14:33:51 236  	  in_subscription_id IN  NUMBER,
14:33:51 237  	  out_result_set      OUT SYS_REFCURSOR
14:33:51 238  );
14:33:51 239  
14:33:51 240  PROCEDURE CALCULATE_INVOICE_AMOUNT (
14:33:51 241  /*
14:33:51 242  Throws exceptions:
14:33:51 243  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 244  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 245  */
14:33:51 246  	in_invoice_id IN  NUMBER,
14:33:51 247  	out_amount    OUT NUMBER
14:33:51 248  );
14:33:51 249  
14:33:51 250  PROCEDURE GET_TRANSACTION_BY_ID (
14:33:51 251  /*
14:33:51 252  Throws exceptions:
14:33:51 253  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 254  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 255  */
14:33:51 256  	in_transaction_id IN NUMBER,
14:33:51 257  	out_result_set	  OUT SYS_REFCURSOR
14:33:51 258  );
14:33:51 259  
14:33:51 260  PROCEDURE UPDATE_CHARGE_STATUS (
14:33:51 261  /*
14:33:51 262  Throws exceptions:
14:33:51 263  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 264  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 265  */
14:33:51 266  	in_charge_id	    IN CHARGE.ID%TYPE,
14:33:51 267  	in_charge_status_id IN CHARGE.CHARGE_STATUS_ID%TYPE,
14:33:51 268  	in_updated_by	    IN CHARGE.UPDATED_BY%TYPE
14:33:51 269  );
14:33:51 270  
14:33:51 271  PROCEDURE GET_GC_BY_PURCH_INVOICE_ID (
14:33:51 272  	in_invoice_id		IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
14:33:51 273  	out_result_set OUT SYS_REFCURSOR
14:33:51 274  );
14:33:51 275  
14:33:51 276  PROCEDURE UPDATE_TRANSACTION_ORDER_ID (
14:33:51 277  /*
14:33:51 278  Throws exceptions:
14:33:51 279  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 280  APP_EXCEPTION_CODES_V22.INTRNAL_ERROR
14:33:51 281  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 282  */
14:33:51 283  	in_transaction_id IN TRANSACTION.ID%TYPE,
14:33:51 284  	in_order_id	  IN TRANSACTION.ORDER_ID%TYPE,
14:33:51 285  	in_updated_by	  IN TRANSACTION.UPDATED_BY%TYPE
14:33:51 286  );
14:33:51 287  PROCEDURE GET_CLOSED_REFUNDS_BY_INVOICE (
14:33:51 288  /*
14:33:51 289  Throws exceptions:
14:33:51 290  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 291  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 292  */
14:33:51 293  	in_invoice_id	IN  NUMBER,
14:33:51 294  	out_result_set OUT SYS_REFCURSOR
14:33:51 295  );
14:33:51 296  PROCEDURE GET_ACTIVE_INVOICES_IDS (
14:33:51 297  /*
14:33:51 298  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 299  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 300  */
14:33:51 301  --  in_subscription_id IN SUBSCRIPTION.ID%TYPE,
14:33:51 302  	in_subscription_id IN NUMBER,
14:33:51 303  	out_result_set	   OUT SYS_REFCURSOR
14:33:51 304  );
14:33:51 305  PROCEDURE CANCEL_SUBSCRIPTION_INVOICE (
14:33:51 306  /*
14:33:51 307  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 308  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 309  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:51 310  */
14:33:51 311  --  in_invoice_id        IN INVOICE.ID%TYPE,
14:33:51 312  --  in_updated_by        IN INVOICE.UPDATED_BY%TYPE,
14:33:51 313  -- norlov: in_refundable	      IN refund enabled
14:33:51 314  	in_invoice_id	     IN NUMBER,
14:33:51 315  	in_updated_by	     IN VARCHAR2,
14:33:51 316  	in_refundable	     IN NUMBER DEFAULT GLOBAL_CONSTANTS_V22.FALSE
14:33:51 317  --  in_cancellation_date IN DATE DEFAULT current_timestamp
14:33:51 318  );
14:33:51 319  
14:33:51 320  PROCEDURE FINALIZE_CANCELATION (
14:33:51 321  /*
14:33:51 322  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 323  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 324  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:51 325  */
14:33:51 326  --  in_subscription_id	IN SUBSCRIPTION.ID%TYPE,
14:33:51 327  --  in_cancelation_reason IN SUBSCRIPTION_CANCEL_REASON.VALUE%TYPE,
14:33:51 328  --  in_cancelation_date	IN SUBSCRIPTION.CANCELLATION_DATE%TYPE,
14:33:51 329  --  in_note		IN SUBSCRIPTION_NOTE.NOTE%TYPE,
14:33:51 330  --  in_agent_id		IN SUBSCRIPTION_NOTE.AGENT_ID%TYPE,
14:33:51 331  --  in_updated_by 	IN SUBSCRIPTION.UPDATED_BY%TYPE
14:33:51 332  	in_subscription_id    IN NUMBER,
14:33:51 333  	in_cancelation_reason IN VARCHAR2,
14:33:51 334  	in_cancelation_date   IN DATE,
14:33:51 335  	in_note 	      IN VARCHAR2,
14:33:51 336  	in_agent_id	      IN NUMBER,
14:33:51 337  	in_updated_by	      IN VARCHAR2
14:33:51 338  );
14:33:51 339  PROCEDURE GET_SUBSCR_PROD_OFFERRINGS (
14:33:51 340  /*
14:33:51 341  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 342  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 343  */
14:33:51 344  	in_subscription_id IN NUMBER,
14:33:51 345  	out_result_set	   OUT SYS_REFCURSOR
14:33:51 346  );
14:33:51 347  PROCEDURE GET_OFFER_CHAIN_META_DATA (
14:33:51 348  /*
14:33:51 349  Throws exceptions (codes):
14:33:51 350  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 351  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 352  */
14:33:51 353  	in_offer_chain_id IN NUMBER,
14:33:51 354  	in_meta_data_name IN VARCHAR2,
14:33:51 355  	out_result_set	  OUT SYS_REFCURSOR
14:33:51 356  );
14:33:51 357  PROCEDURE GET_PRODUCT_OFFERING_META_DATA (
14:33:51 358  /*
14:33:51 359  Throws exceptions (codes):
14:33:51 360  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 361  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 362  */
14:33:51 363  	in_product_offering_id IN NUMBER,
14:33:51 364  	in_meta_data_name      IN VARCHAR2 DEFAULT NULL,
14:33:51 365  	out_result_set	       OUT SYS_REFCURSOR
14:33:51 366  );
14:33:51 367  PROCEDURE READ_ACCOUNT (
14:33:51 368  	in_account_id  IN ACCOUNT.ID%TYPE,
14:33:51 369  	out_result_set OUT SYS_REFCURSOR
14:33:51 370  );
14:33:51 371  
14:33:51 372  PROCEDURE GET_COLLECTED_CHARGES (
14:33:51 373  /*
14:33:51 374  Throws exceptions:
14:33:51 375  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 376  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 377  */
14:33:51 378  	in_invoice_id  IN NUMBER,
14:33:51 379  	out_result_set OUT SYS_REFCURSOR
14:33:51 380  );
14:33:51 381  
14:33:51 382  PROCEDURE GET_GROUPS_ID_BY_INVOICE_ID (
14:33:51 383  /*
14:33:51 384  Throws exceptions:
14:33:51 385  APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:51 386  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 387  */
14:33:51 388  	in_invoice_id IN NUMBER,
14:33:51 389  	out_group_ids OUT SYS_REFCURSOR
14:33:51 390  );
14:33:51 391  
14:33:51 392  PROCEDURE GET_ACCOUNT_ID_BY_GROUP_ID (
14:33:51 393  /*
14:33:51 394  Throws exceptions:
14:33:51 395  APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:51 396  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 397  */
14:33:51 398  	in_group_id IN NUMBER,
14:33:51 399  	out_account_id	OUT NUMBER
14:33:51 400  );
14:33:51 401  
14:33:51 402  PROCEDURE LOCK_ACCOUNT (
14:33:51 403  	in_group_id    IN NUMBER,
14:33:51 404  	in_lock_key    IN VARCHAR2,
14:33:51 405  	in_seconds_num IN NUMBER,
14:33:51 406  	in_created_by  IN VARCHAR2,
14:33:51 407  	in_reason      IN VARCHAR2
14:33:51 408  );
14:33:51 409  
14:33:51 410  PROCEDURE RELEASE_LOCK (
14:33:51 411  	in_group_id IN NUMBER,
14:33:51 412  	in_lock_key IN VARCHAR2
14:33:51 413  );
14:33:51 414  
14:33:51 415  PROCEDURE GET_PAYMENT_INFO_BY_INVOICE_ID (
14:33:51 416  	in_invoice_id		    IN NUMBER,
14:33:51 417  	out_order_id		    OUT VARCHAR2,
14:33:51 418  	out_external_transaction_id OUT VARCHAR2
14:33:51 419  );
14:33:51 420  
14:33:51 421  PROCEDURE GET_PAYPAL_BY_ID (
14:33:51 422  	in_paypal_id   IN  NUMBER,
14:33:51 423  	out_result_set OUT SYS_REFCURSOR
14:33:51 424  );
14:33:51 425  
14:33:51 426  PROCEDURE GET_NEXT_ATTEMPT_NUMBER (
14:33:51 427  /*
14:33:51 428  Throws exceptions:
14:33:51 429  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 430  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 431  */
14:33:51 432  	in_charge_id   in  number,
14:33:51 433  	out_attempt_count out number
14:33:51 434  );
14:33:51 435  
14:33:51 436  PROCEDURE GET_NOTIFICATION_TYPE_ID (
14:33:51 437  	in_offer_chain_id	 IN NUMBER,
14:33:51 438  	in_action_name		 IN VARCHAR2,
14:33:51 439  	out_notification_type_id out number
14:33:51 440  );
14:33:51 441  
14:33:51 442  PROCEDURE SHOULD_MOVE_TO_GRACE(
14:33:51 443  	in_invoice_id  IN INVOICE.ID%TYPE,
14:33:51 444  	out_result     OUT NUMBER
14:33:51 445  );
14:33:51 446  
14:33:51 447  PROCEDURE MOVE_TO_GRACE(
14:33:51 448  	in_invoice_id		      IN INVOICE.ID%TYPE,
14:33:51 449  	in_updated_by		      IN LICENSE.UPDATED_BY%TYPE,
14:33:51 450  	in_grace_period_length_hours  IN NUMBER
14:33:51 451  );
14:33:51 452  
14:33:51 453  PROCEDURE MOVE_OUT_OF_GRACE(
14:33:51 454  	in_invoice_id	IN INVOICE.ID%TYPE,
14:33:51 455  	in_updated_by	IN LICENSE.UPDATED_BY%TYPE
14:33:51 456  );
14:33:51 457  
14:33:51 458  END PUBLIC_PROCS_BILLING_V22;
14:33:51 459  .
14:33:51 SQL> /

Package created.

Elapsed: 00:00:00.07
14:33:51 SQL> 
14:33:51 SQL> --------------------------------------------------------------------------------
14:33:51 SQL> -- DDL for package PUBLIC_PROCS_CLIENT
14:33:51 SQL> --------------------------------------------------------------------------------
14:33:51 SQL> 
14:33:51 SQL> CREATE OR REPLACE PACKAGE "PUBLIC_PROCS_CLIENT_V22" AS
14:33:51   2  
14:33:51   3  PROCEDURE GET_NOTIFICATION_TYPE_BY_NAME (
14:33:51   4  /*
14:33:51   5  Throws exceptions:
14:33:51   6  CORE_OWNER.APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51   7  CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51   8  */
14:33:51   9  	in_notification_type_name IN VARCHAR2,
14:33:51  10  	out_notification_type_id  OUT NUMBER
14:33:51  11  );
14:33:51  12  
14:33:51  13  PROCEDURE ADD_NOTIFICATION (
14:33:51  14  /*
14:33:51  15  Throws exceptions:
14:33:51  16  CORE_OWNER.APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51  17  CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  18  */
14:33:51  19  	in_sender_account_id	 IN NUMBER DEFAULT 0,
14:33:51  20  	in_recipient_group_id	 IN NUMBER,
14:33:51  21  	in_notification_type_id  IN NUMBER,
14:33:51  22  	in_date_to_notify	 IN DATE,
14:33:51  23  	in_email_template_params IN CLOB
14:33:51  24  );
14:33:51  25  
14:33:51  26  END PUBLIC_PROCS_CLIENT_V22;
14:33:51  27  .
14:33:51 SQL> /

Package created.

Elapsed: 00:00:00.02
14:33:51 SQL> 
14:33:51 SQL> --------------------------------------------------------------------------------
14:33:51 SQL> -- DDL for package PUBLIC_PROCS_NOTIFICATION
14:33:51 SQL> --------------------------------------------------------------------------------
14:33:51 SQL> 
14:33:51 SQL> CREATE OR REPLACE PACKAGE "PUBLIC_PROCS_NOTIFICATION_V22" AS
14:33:51   2  
14:33:51   3  PROCEDURE LOCK_ACCOUNT (
14:33:51   4  	in_group_id    IN NUMBER,
14:33:51   5  	in_lock_key    IN VARCHAR2,
14:33:51   6  	in_seconds_num IN NUMBER,
14:33:51   7  	in_created_by  IN VARCHAR2,
14:33:51   8  	in_reason      IN VARCHAR2
14:33:51   9  );
14:33:51  10  
14:33:51  11  PROCEDURE RELEASE_LOCK (
14:33:51  12  	in_group_id IN NUMBER,
14:33:51  13  	in_lock_key IN VARCHAR2
14:33:51  14  );
14:33:51  15  
14:33:51  16  END PUBLIC_PROCS_NOTIFICATION_V22;
14:33:51  17  .
14:33:51 SQL> /

Package created.

Elapsed: 00:00:00.02
14:33:51 SQL> 
14:33:51 SQL> --------------------------------------------------------------------------------
14:33:51 SQL> -- DDL for package PUBLIC_PROCS_RENEWAL
14:33:51 SQL> --------------------------------------------------------------------------------
14:33:51 SQL> 
14:33:51 SQL> CREATE OR REPLACE PACKAGE "PUBLIC_PROCS_RENEWAL_V22" AS
14:33:51   2  
14:33:51   3  PROCEDURE SUB_EXPIRES_NEED_ENTITLEMENTS (
14:33:51   4  	out_result_set OUT SYS_REFCURSOR
14:33:51   5  );
14:33:51   6  
14:33:51   7  PROCEDURE UPDATE_SS_NEED_ENTITLEMENTS (
14:33:51   8  	in_sub_share_id      IN SUBSCRIPTION_SHARE.ID%TYPE,
14:33:51   9  	in_need_entitlements IN SUBSCRIPTION_SHARE.NEEDS_ENTITLEMENTS%TYPE,
14:33:51  10  	in_updater	     IN SUBSCRIPTION_SHARE.UPDATED_BY%TYPE
14:33:51  11  );
14:33:51  12  
14:33:51  13  PROCEDURE GET_OFFER_CHAIN_BY_ID (
14:33:51  14  /*
14:33:51  15  Throws exceptions:
14:33:51  16  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51  17  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  18  */
14:33:51  19  	  in_offer_chain_id IN	 NUMBER,
14:33:51  20  	  out_result_set    OUT  SYS_REFCURSOR
14:33:51  21  );
14:33:51  22  
14:33:51  23  PROCEDURE GET_UNREDEEMED_GCS (
14:33:51  24  	out_result_set		OUT SYS_REFCURSOR,
14:33:51  25  	in_hours_number 	IN NUMBER DEFAULT 14*24,
14:33:51  26  	in_num_rows		IN NUMBER DEFAULT 10000,
14:33:51  27  	in_process_name 	IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE
14:33:51  28  );
14:33:51  29  
14:33:51  30  PROCEDURE GET_SUBSCRIPTIONS_META_DATA (
14:33:51  31  /*
14:33:51  32  APP_EXCEPTION_CODES_V22.INVALID_PARAMETER
14:33:51  33  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  34  */
14:33:51  35  	in_subscriptions_ids IN core_owner.NUMBER_TABLE,
14:33:51  36  	out_result_set	     OUT SYS_REFCURSOR
14:33:51  37  );
14:33:51  38  
14:33:51  39  PROCEDURE GET_ALL_OCH_META_DATA (
14:33:51  40  	in_offer_chain_id IN NUMBER,
14:33:51  41  	out_result_set	  OUT SYS_REFCURSOR
14:33:51  42  );
14:33:51  43  
14:33:51  44  PROCEDURE GET_OFFER_CHAIN_META_DATA (
14:33:51  45  /*
14:33:51  46  Throws exceptions (codes):
14:33:51  47  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51  48  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  49  */
14:33:51  50  	in_offer_chain_id IN NUMBER,
14:33:51  51  	in_meta_data_name IN VARCHAR2,
14:33:51  52  	out_result_set	  OUT SYS_REFCURSOR
14:33:51  53  );
14:33:51  54  
14:33:51  55  PROCEDURE GET_ENDING_LICENSES (
14:33:51  56  /*
14:33:51  57  Throws exceptions:
14:33:51  58  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  59  */
14:33:51  60  	in_hours_number IN NUMBER,
14:33:51  61  	out_result_set OUT SYS_REFCURSOR
14:33:51  62  );
14:33:51  63  
14:33:51  64  PROCEDURE GET_ENDING_LICENSES_CC (
14:33:51  65  /*
14:33:51  66  Throws exceptions:
14:33:51  67  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  68  */
14:33:51  69  	in_hours_number IN NUMBER,
14:33:51  70  	out_result_set OUT SYS_REFCURSOR,
14:33:51  71  	in_process_name 	IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE
14:33:51  72  );
14:33:51  73  
14:33:51  74  /************************************************/
14:33:51  75  
14:33:51  76  PROCEDURE GET_RECURRING_OFFER (
14:33:51  77  /*
14:33:51  78  Throws exceptions:
14:33:51  79  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  80  */
14:33:51  81  	in_license_id  IN NUMBER,
14:33:51  82  	out_result_set OUT SYS_REFCURSOR
14:33:51  83  );
14:33:51  84  
14:33:51  85  /*************************************************/
14:33:51  86  
14:33:51  87  PROCEDURE GET_NEXT_OFFER (
14:33:51  88  /*
14:33:51  89  Throws exceptions:
14:33:51  90  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51  91  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:51  92  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  93  */
14:33:51  94  	in_license_id  IN NUMBER,
14:33:51  95  	out_result_set OUT SYS_REFCURSOR
14:33:51  96  );
14:33:51  97  
14:33:51  98  /**************************************************/
14:33:51  99  
14:33:51 100  PROCEDURE UPDATE_LICENSE_STATUS(
14:33:51 101  /*
14:33:51 102  Throws exceptions:
14:33:51 103  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 104  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 105  */
14:33:51 106  	  in_license_id     IN NUMBER,
14:33:51 107  	  in_license_status IN NUMBER,
14:33:51 108  	  in_updated_by     IN VARCHAR2
14:33:51 109  );
14:33:51 110  
14:33:51 111  /***************************************************/
14:33:51 112  
14:33:51 113  PROCEDURE UPDATE_INVOICE_STATUS (
14:33:51 114  /*
14:33:51 115  Throws exceptions:
14:33:51 116  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 117  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 118  */
14:33:51 119  	in_invoice_id		       IN NUMBER,
14:33:51 120  	in_invoice_status_id	       IN NUMBER,
14:33:51 121  	in_updated_by		       IN VARCHAR2
14:33:51 122  );
14:33:51 123  
14:33:51 124  /***************************************************/
14:33:51 125  
14:33:51 126  PROCEDURE CREATE_LICENSE(
14:33:51 127  /*
14:33:51 128  Throws exceptions:
14:33:51 129  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 130  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 131  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:51 132  */
14:33:51 133  	in_status_id		    IN NUMBER,
14:33:51 134  	in_needs_entitlements	    IN NUMBER,
14:33:51 135  	in_start_date		    IN DATE,
14:33:51 136  	in_end_date		    IN DATE,
14:33:51 137  	in_offer_id		    IN NUMBER,
14:33:51 138  	in_subscription_id	    IN NUMBER,
14:33:51 139  	in_invoice_id		    IN NUMBER,
14:33:51 140  	in_created_by		    IN VARCHAR2,
14:33:51 141  	in_is_extension 	    IN NUMBER,
14:33:51 142  	in_current_offer_index	    IN NUMBER,
14:33:51 143  	in_current_offer_recurr_num IN NUMBER,
14:33:51 144  	out_license_id		    OUT NUMBER
14:33:51 145  );
14:33:51 146  
14:33:51 147  /**************************************************/
14:33:51 148  
14:33:51 149  PROCEDURE CREATE_INVOICE(
14:33:51 150  /*
14:33:51 151  Throws exceptions:
14:33:51 152  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 153  */
14:33:51 154  	  in_invoice_status IN NUMBER,
14:33:51 155  	  in_created_by     IN VARCHAR2,
14:33:51 156  	  in_tax_exempt_id  IN VARCHAR2,
14:33:51 157  	  out_invoice_id    OUT NUMBER
14:33:51 158  );
14:33:51 159  
14:33:51 160  /*****************************************************/
14:33:51 161  
14:33:51 162  PROCEDURE CREATE_CHARGE(
14:33:51 163  /*
14:33:51 164  Throws exceptions:
14:33:51 165  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 166  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 167  */
14:33:51 168  	in_invoice_id	      IN NUMBER,
14:33:51 169  	in_transaction_id     IN NUMBER,
14:33:51 170  	in_instrument_type_id IN NUMBER,
14:33:51 171  	in_instrument_id      IN NUMBER,
14:33:51 172  	in_charge_amount      IN NUMBER,
14:33:51 173  	in_created_by	      IN VARCHAR2,
14:33:51 174  	in_charge_status_id   IN NUMBER,
14:33:51 175  	out_charge_id	      OUT NUMBER
14:33:51 176  );
14:33:51 177  
14:33:51 178  /*****************************************************/
14:33:51 179  
14:33:51 180  PROCEDURE HAS_FUTURE_LICENSE (
14:33:51 181  /*
14:33:51 182  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 183  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 184  --
14:33:51 185  RETURNS:
14:33:51 186  1 - if has,
14:33:51 187  0 - else
14:33:51 188  */
14:33:51 189  	in_license_id IN NUMBER,
14:33:51 190  	out_result	   OUT NUMBER
14:33:51 191  );
14:33:51 192  
14:33:51 193  /*****************************************************/
14:33:51 194  
14:33:51 195  PROCEDURE GET_GROUP_ID_BY_LICENSE_ID (
14:33:51 196  /*
14:33:51 197  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 198  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 199  */
14:33:51 200  	in_license_id IN NUMBER,
14:33:51 201  	out_group_id  OUT NUMBER
14:33:51 202  );
14:33:51 203  
14:33:51 204  /*****************************************************/
14:33:51 205  
14:33:51 206  PROCEDURE GET_OFFER_PRODUCTS (
14:33:51 207  /*
14:33:51 208  Throws exceptions (codes):
14:33:51 209  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 210  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 211  */
14:33:51 212  	in_offer_id    IN NUMBER,
14:33:51 213  	out_result_set OUT SYS_REFCURSOR
14:33:51 214  );
14:33:51 215  
14:33:51 216  /*******************************************************/
14:33:51 217  
14:33:51 218  PROCEDURE CREATE_TRANSACTION (
14:33:51 219  /*
14:33:51 220  Throws exceptions:
14:33:51 221  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 222  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 223  */
14:33:51 224  	in_transaction_id	  IN NUMBER,
14:33:51 225  	in_status_id		  IN NUMBER,
14:33:51 226  	in_amount		  IN NUMBER,
14:33:51 227  	in_created_by		  IN VARCHAR2,
14:33:51 228  	in_order_id		  IN VARCHAR2,
14:33:51 229  	in_transaction_type_code  IN VARCHAR2 DEFAULT NULL,
14:33:51 230  	out_transaction_id	  OUT NUMBER
14:33:51 231  );
14:33:51 232  
14:33:51 233  /*********************************************************/
14:33:51 234  
14:33:51 235  PROCEDURE ADD_LINE_ITEMS(
14:33:51 236  /*
14:33:51 237  Throws exceptions:
14:33:51 238  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 239  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 240  */
14:33:51 241  	in_invoice_id IN NUMBER,
14:33:51 242  	in_offer_id   IN NUMBER,
14:33:51 243  	in_created_by IN VARCHAR2
14:33:51 244  );
14:33:51 245  
14:33:51 246  /**********************************************************/
14:33:51 247  
14:33:51 248  PROCEDURE CALCULATE_INVOICE_AMOUNT (
14:33:51 249  /*
14:33:51 250  Throws exceptions:
14:33:51 251  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 252  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 253  */
14:33:51 254  	in_invoice_id IN  NUMBER,
14:33:51 255  	out_amount    OUT NUMBER
14:33:51 256  );
14:33:51 257  
14:33:51 258  /*********************************************************/
14:33:51 259  
14:33:51 260  PROCEDURE RESERVE_TRANSACTION_ID (
14:33:51 261  /*
14:33:51 262  Throws exceptions:
14:33:51 263  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 264  */
14:33:51 265  	out_transaction_id OUT NUMBER
14:33:51 266  );
14:33:51 267  
14:33:51 268  /**********************************************************/
14:33:51 269  
14:33:51 270  PROCEDURE P_GET_NEXT_OFFER_INDEX (
14:33:51 271  	in_offer_chain_id	     IN NUMBER,
14:33:51 272  	in_offer_chain_current_index IN NUMBER,
14:33:51 273  	out_next_offer_index	     OUT NUMBER
14:33:51 274  );
14:33:51 275  
14:33:51 276  /***********************************************************/
14:33:51 277  
14:33:51 278  PROCEDURE GET_NEXT_OFFER_INDEX_BY_LCNS (
14:33:51 279  	in_license_id		     IN NUMBER,
14:33:51 280  	in_offer_chain_current_index IN NUMBER,
14:33:51 281  	out_next_offer_index	     OUT NUMBER
14:33:51 282  );
14:33:51 283  
14:33:51 284  /**********************************************************/
14:33:51 285  
14:33:51 286  PROCEDURE GET_SUBSCRIPTION_INFO (
14:33:51 287  /*
14:33:51 288  Throws exceptions:
14:33:51 289  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 290  */
14:33:51 291  	  in_subscription_id IN  NUMBER,
14:33:51 292  	  out_result_set      OUT SYS_REFCURSOR
14:33:51 293  );
14:33:51 294  
14:33:51 295  /***********************************************************/
14:33:51 296  
14:33:51 297  PROCEDURE CLOSE_SUBSCRIPTION (
14:33:51 298  	in_subscription_id IN NUMBER,
14:33:51 299  	in_updated_by	   IN VARCHAR2
14:33:51 300  );
14:33:51 301  
14:33:51 302  /***********************************************************/
14:33:51 303  
14:33:51 304  PROCEDURE GET_NEED_ENTITLEMENTS_LICENSES (
14:33:51 305  	out_result_set OUT SYS_REFCURSOR
14:33:51 306  );
14:33:51 307  
14:33:51 308  /***********************************************************/
14:33:51 309  
14:33:51 310  PROCEDURE UPDATE_NEED_ENTITLEMENTS_FLAG (
14:33:51 311  	in_license_id	      IN NUMBER,
14:33:51 312  	in_needs_entitlements IN NUMBER,
14:33:51 313  	in_updated_by	      IN VARCHAR2
14:33:51 314  );
14:33:51 315  /***********************************************************/
14:33:51 316  PROCEDURE GET_PROD_OFFERINGS_BY_OFFER_ID (
14:33:51 317  	in_offer_id    IN NUMBER,
14:33:51 318  	out_result_set OUT SYS_REFCURSOR
14:33:51 319  );
14:33:51 320  /***********************************************************/
14:33:51 321  PROCEDURE GET_PRODUCT_OFFERING_META_DATA (
14:33:51 322  	in_product_offering_id IN NUMBER,
14:33:51 323  	in_meta_data_name      IN VARCHAR2 DEFAULT NULL,
14:33:51 324  	out_result_set	       OUT SYS_REFCURSOR
14:33:51 325  );
14:33:51 326  
14:33:51 327  PROCEDURE LOCK_ACCOUNT (
14:33:51 328  	in_group_id    IN NUMBER,
14:33:51 329  	in_lock_key    IN VARCHAR2,
14:33:51 330  	in_seconds_num IN NUMBER,
14:33:51 331  	in_created_by  IN VARCHAR2,
14:33:51 332  	in_reason      IN VARCHAR2
14:33:51 333  );
14:33:51 334  
14:33:51 335  PROCEDURE RELEASE_LOCK (
14:33:51 336  	in_group_id IN NUMBER,
14:33:51 337  	in_lock_key IN VARCHAR2
14:33:51 338  );
14:33:51 339  
14:33:51 340  PROCEDURE GET_INVOICE_LINE_ITEMS (
14:33:51 341  	in_invoice_id  IN NUMBER,
14:33:51 342  	out_result_set OUT SYS_REFCURSOR
14:33:51 343  );
14:33:51 344  
14:33:51 345  PROCEDURE ADD_TAX (
14:33:51 346  	in_tax_type_id		 IN NUMBER,
14:33:51 347  	in_calculated_amount	 IN NUMBER,
14:33:51 348  	in_created_by		 IN VARCHAR2,
14:33:51 349  	in_line_item_id 	 IN NUMBER,
14:33:51 350  	in_effective_rate	 IN VARCHAR2,
14:33:51 351  	in_taxable_amount	 IN NUMBER,
14:33:51 352  	in_tax_rule_id		 IN NUMBER,
14:33:51 353  	in_jurisdiction_level_id IN NUMBER,
14:33:51 354  	in_jurisdiction_name	 IN VARCHAR2,
14:33:51 355  	in_jurisdiction_id	 IN VARCHAR2,
14:33:51 356  	in_ext_tax_type 	 IN VARCHAR2,
14:33:51 357  	in_ext_result		 IN VARCHAR2,
14:33:51 358  	in_imposition_type	 IN VARCHAR2,
14:33:51 359  	in_imposition		 IN VARCHAR2
14:33:51 360  );
14:33:51 361  
14:33:51 362  PROCEDURE GET_CREDIT_CARD_BY_ID (
14:33:51 363  	in_credit_card_id IN  NUMBER,
14:33:51 364  	out_result_set	  OUT SYS_REFCURSOR
14:33:51 365  );
14:33:51 366  
14:33:51 367  PROCEDURE GET_PRD_OFFERING_BY_LINE_IT_ID (
14:33:51 368  	in_line_item_id IN NUMBER,
14:33:51 369  	out_result_set	OUT SYS_REFCURSOR
14:33:51 370  );
14:33:51 371  
14:33:51 372  PROCEDURE GET_ACCOUNT_ID_BY_GROUP_ID (
14:33:51 373  /*
14:33:51 374  Throws exceptions:
14:33:51 375  APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:51 376  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 377  */
14:33:51 378  	in_group_id IN NUMBER,
14:33:51 379  	out_account_id	OUT NUMBER
14:33:51 380  );
14:33:51 381  
14:33:51 382  PROCEDURE GET_LINE_ITEM_DISCOUNTS (
14:33:51 383  /*
14:33:51 384  Throws exceptions:
14:33:51 385  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:51 386  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 387  */
14:33:51 388  	in_line_item_id IN  NUMBER,
14:33:51 389  	out_result_set	OUT SYS_REFCURSOR
14:33:51 390  );
14:33:51 391  
14:33:51 392  PROCEDURE UPDATE_LINE_ITEM_AMOUNT (
14:33:51 393  	in_line_item_id    IN NUMBER,
14:33:51 394  	in_amount	   IN NUMBER,
14:33:51 395  	in_discount_amount IN NUMBER,
14:33:51 396  	in_taxes_amount    IN NUMBER
14:33:51 397  );
14:33:51 398  
14:33:51 399  PROCEDURE GET_PAYPAL_BY_ID (
14:33:51 400  	in_paypal_id   IN  NUMBER,
14:33:51 401  	out_result_set OUT SYS_REFCURSOR
14:33:51 402  );
14:33:51 403  
14:33:51 404  PROCEDURE GET_GC_BY_PURCH_INVOICE_ID (
14:33:51 405  	in_invoice_id		IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
14:33:51 406  	out_result_set OUT SYS_REFCURSOR
14:33:51 407  );
14:33:51 408  
14:33:51 409  PROCEDURE GET_LICENSE_BY_ID (
14:33:51 410  	in_license_id  IN NUMBER,
14:33:51 411  	out_result_set OUT SYS_REFCURSOR
14:33:51 412  );
14:33:51 413  
14:33:51 414  PROCEDURE GET_NOTIFICATION_TYPE_ID (
14:33:51 415  	in_offer_chain_id	 IN NUMBER,
14:33:51 416  	in_action_name		 IN VARCHAR2,
14:33:51 417  	out_notification_type_id OUT NUMBER
14:33:51 418  );
14:33:51 419  
14:33:51 420  PROCEDURE GET_OFFER_CHAIN_MD_VALUE (
14:33:51 421  	in_offer_chain_id IN NUMBER,
14:33:51 422  	in_meta_data_name IN VARCHAR2,
14:33:51 423  	out_value	  OUT VARCHAR2
14:33:51 424  );
14:33:51 425  
14:33:51 426  PROCEDURE GET_ACT_SUBS_W_CPT_CHARGEBACKS (
14:33:51 427  	out_result_set	    OUT SYS_REFCURSOR
14:33:51 428  );
14:33:51 429  
14:33:51 430  PROCEDURE GET_ACT_SUBS_W_PP_CHARGEBACKS (
14:33:51 431  	out_result_set	    OUT SYS_REFCURSOR
14:33:51 432  );
14:33:51 433  
14:33:51 434  PROCEDURE GET_ACT_SUBS_W_AMEX_CB (
14:33:51 435  	out_result_set	    OUT SYS_REFCURSOR
14:33:51 436  );
14:33:51 437  
14:33:51 438  PROCEDURE GET_GRACE_PERIOD_SUB_REGIS (
14:33:51 439  	in_max_days_until_close IN NUMBER,
14:33:51 440  	in_num_subs_to_fetch	IN NUMBER,
14:33:51 441  	out_result_set		OUT SYS_REFCURSOR
14:33:51 442  );
14:33:51 443  
14:33:51 444  PROCEDURE GET_GRACE_LICE_FOR_FINAL_TRANS (
14:33:51 445  	in_days_before_close	 IN NUMBER,
14:33:51 446  	in_num_licenses_to_fetch IN NUMBER,
14:33:51 447  	out_result_set		 OUT SYS_REFCURSOR
14:33:51 448  );
14:33:51 449  
14:33:51 450  PROCEDURE GET_EXPIRING_PAYPAL (
14:33:51 451  	in_expire_window_days	IN NUMBER,
14:33:51 452  	in_creation_limit_days	IN NUMBER,
14:33:51 453  	in_retry_throttle_name	IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE,
14:33:51 454  	out_result_set		OUT SYS_REFCURSOR
14:33:51 455  );
14:33:51 456  
14:33:51 457  END PUBLIC_PROCS_RENEWAL_V22;
14:33:51 458  .
14:33:51 SQL> /

Package created.

Elapsed: 00:00:00.06
14:33:51 SQL> 
14:33:51 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_ACCOUNT_CRU_V22" AS
14:33:51   2  
14:33:51   3  PROCEDURE CREATE_ACCOUNT (
14:33:51   4  	out_account_id	      OUT ACCOUNT.ID%TYPE,
14:33:51   5  	in_account_status_id  IN ACCOUNT.ACCOUNT_STATUS_ID%TYPE,
14:33:51   6  	in_suspend_date       IN ACCOUNT.SUSPEND_DATE%TYPE DEFAULT NULL,
14:33:51   7  	in_group_id	      IN ACCOUNT.GROUP_ID%TYPE,
14:33:51   8  	in_created_by	      IN ACCOUNT.CREATED_BY%TYPE,
14:33:51   9  	in_system_category_id IN ACCOUNT.SYSTEM_CATEGORY_ID%TYPE,
14:33:51  10  	in_instrument_type_id IN ACCOUNT.INSTRUMENT_TYPE_ID%TYPE DEFAULT NULL,
14:33:51  11  	in_instrument_id      IN ACCOUNT.INSTRUMENT_ID%TYPE DEFAULT NULL
14:33:51  12  ) AS
14:33:51  13  -- VARIABLES
14:33:51  14  var_new_account_id ACCOUNT.ID%TYPE;
14:33:51  15  -- arosolovskiy: using data variable instead of direct get data calls (#38860)
14:33:51  16  var_date DATE := SYSDATE;
14:33:51  17  BEGIN
14:33:51  18  	SELECT
14:33:51  19  	  ACC_ID_SEQ.nextVal into var_new_account_id
14:33:51  20  	FROM DUAL;
14:33:51  21  	INSERT INTO ACCOUNT (
14:33:51  22  	  ID,
14:33:51  23  	  ACCOUNT_STATUS_ID,
14:33:51  24  	  SUSPEND_DATE,
14:33:51  25  	  GROUP_ID,
14:33:51  26  	  CREATE_DATE,
14:33:51  27  	  CREATED_BY,
14:33:51  28  	  UPDATE_DATE,
14:33:51  29  	  UPDATED_BY,
14:33:51  30  	  SYSTEM_CATEGORY_ID,
14:33:51  31  	  INSTRUMENT_TYPE_ID,
14:33:51  32  	  INSTRUMENT_ID,
14:33:51  33  	  TAX_EXEMPT_ID
14:33:51  34  	) VALUES (
14:33:51  35  	  var_new_account_id,
14:33:51  36  	  in_account_status_id,
14:33:51  37  	  in_suspend_date,
14:33:51  38  	  in_group_id,
14:33:51  39  	  var_date,
14:33:51  40  	  in_created_by,
14:33:51  41  	  var_date,
14:33:51  42  	  in_created_by,
14:33:51  43  	  in_system_category_id,
14:33:51  44  	  in_instrument_type_id,
14:33:51  45  	  in_instrument_id,
14:33:51  46  	  NULL
14:33:51  47  	);
14:33:51  48  
14:33:51  49  	out_account_id := var_new_account_id;
14:33:51  50  END CREATE_ACCOUNT;
14:33:51  51  
14:33:51  52  /*************************************************************/
14:33:51  53  
14:33:51  54  PROCEDURE UPDATE_ACCOUNT (
14:33:51  55  	in_account_id	      IN ACCOUNT.ID%TYPE,
14:33:51  56  	in_account_status_id  IN ACCOUNT.ACCOUNT_STATUS_ID%TYPE DEFAULT NULL,
14:33:51  57  	in_suspend_date       IN ACCOUNT.SUSPEND_DATE%TYPE DEFAULT NULL,
14:33:51  58  	in_updated_by	      IN ACCOUNT.UPDATED_BY%TYPE,
14:33:51  59  	in_system_category_id IN ACCOUNT.SYSTEM_CATEGORY_ID%TYPE DEFAULT NULL,
14:33:51  60  	in_instrument_type_id IN ACCOUNT.INSTRUMENT_TYPE_ID%TYPE DEFAULT NULL,
14:33:51  61  	in_instrument_id      IN ACCOUNT.INSTRUMENT_ID%TYPE DEFAULT NULL
14:33:51  62  ) AS
14:33:51  63  BEGIN
14:33:51  64  
14:33:51  65  	-- CREATE HISTORY
14:33:51  66  	PROCS_HISTORY_V22.CREATE_ACCOUNT_HISTORY(
14:33:51  67  	  in_account_id 	       => in_account_id,
14:33:51  68  	  in_system_activity_reason_id => GLOBAL_ENUMS_V22.SAC_SYSTEM_APPLIED_RULE
14:33:51  69  	);
14:33:51  70  
14:33:51  71  	UPDATE ACCOUNT SET
14:33:51  72  	  ACCOUNT_STATUS_ID  = NVL(in_account_status_id, ACCOUNT_STATUS_ID),
14:33:51  73  	  SUSPEND_DATE	     = NVL(in_suspend_date, SUSPEND_DATE),
14:33:51  74  	  UPDATED_BY	     = in_updated_by,
14:33:51  75  	  UPDATE_DATE	     = SYSDATE,
14:33:51  76  	  SYSTEM_CATEGORY_ID = NVL(in_system_category_id, SYSTEM_CATEGORY_ID),
14:33:51  77  	  INSTRUMENT_TYPE_ID = NVL(in_instrument_type_id, INSTRUMENT_TYPE_ID),
14:33:51  78  	  INSTRUMENT_ID      = NVL(in_instrument_id, INSTRUMENT_ID)
14:33:51  79  	WHERE
14:33:51  80  	  ACCOUNT.ID = in_account_id;
14:33:51  81  
14:33:51  82  END UPDATE_ACCOUNT;
14:33:51  83  
14:33:51  84  /*************************************************************/
14:33:51  85  
14:33:51  86  PROCEDURE UPDATE_DEF_FIN_INSTRUMENT(
14:33:51  87  	in_account_id	      IN ACCOUNT.ID%TYPE,
14:33:51  88  	in_instrument_type_id IN ACCOUNT.INSTRUMENT_TYPE_ID%TYPE,
14:33:51  89  	in_instrument_id      IN ACCOUNT.INSTRUMENT_ID%TYPE,
14:33:51  90  	in_updated_by	      IN ACCOUNT.UPDATED_BY%TYPE
14:33:51  91  ) AS
14:33:51  92  BEGIN
14:33:51  93  
14:33:51  94  	-- CREATE HISTORY
14:33:51  95  	PROCS_HISTORY_V22.CREATE_ACCOUNT_HISTORY(
14:33:51  96  	  in_account_id 	       => in_account_id,
14:33:51  97  	  in_system_activity_reason_id => GLOBAL_ENUMS_V22.SAC_SYSTEM_APPLIED_RULE
14:33:51  98  	);
14:33:51  99  
14:33:51 100  	UPDATE ACCOUNT SET
14:33:51 101  	  INSTRUMENT_TYPE_ID = in_instrument_type_id,
14:33:51 102  	  INSTRUMENT_ID      = in_instrument_id
14:33:51 103  	WHERE
14:33:51 104  	  ACCOUNT.ID = in_account_id;
14:33:51 105  
14:33:51 106  END;
14:33:51 107  
14:33:51 108  /*************************************************************/
14:33:51 109  
14:33:51 110  PROCEDURE READ_ACCOUNT (
14:33:51 111  	in_account_id  IN ACCOUNT.ID%TYPE,
14:33:51 112  	out_result_set OUT SYS_REFCURSOR
14:33:51 113  ) AS
14:33:51 114  BEGIN
14:33:51 115  	OPEN out_result_set FOR
14:33:51 116  	SELECT
14:33:51 117  	  ACCOUNT_STATUS_ID,
14:33:51 118  	  SUSPEND_DATE,
14:33:51 119  	  GROUP_ID
14:33:51 120  	FROM
14:33:51 121  	  ACCOUNT
14:33:51 122  	WHERE
14:33:51 123  	  ID = in_account_id;
14:33:51 124  END READ_ACCOUNT;
14:33:51 125  
14:33:51 126  /*************************************************************/
14:33:51 127  
14:33:51 128  PROCEDURE CREATE_ACCOUNT_NOTE (
14:33:51 129  	inout_account_note_id IN OUT ACCOUNT_NOTE.ID%TYPE,
14:33:51 130  	in_agent_id	      IN ACCOUNT_NOTE.AGENT_ID%TYPE,
14:33:51 131  	in_account_id	      IN ACCOUNT_NOTE.ACCOUNT_ID%TYPE,
14:33:51 132  	in_note 	      IN ACCOUNT_NOTE.NOTE%TYPE,
14:33:51 133  	in_created_by	      IN ACCOUNT_NOTE.CREATED_BY%TYPE
14:33:51 134  ) AS
14:33:51 135  BEGIN
14:33:51 136  	IF inout_account_note_id IS NULL THEN
14:33:51 137  	  SELECT
14:33:51 138  	    ACCN_ID_SEQ.nextVal into inout_account_note_id
14:33:51 139  	  FROM DUAL;
14:33:51 140  	END IF;
14:33:51 141  	INSERT INTO ACCOUNT_NOTE(
14:33:51 142  	  ID,
14:33:51 143  	  AGENT_ID,
14:33:51 144  	  ACCOUNT_ID,
14:33:51 145  	  NOTE,
14:33:51 146  	  CREATE_DATE,
14:33:51 147  	  CREATED_BY
14:33:51 148  	) VALUES (
14:33:51 149  	  inout_account_note_id,
14:33:51 150  	  in_agent_id,
14:33:51 151  	  in_account_id,
14:33:51 152  	  in_note,
14:33:51 153  	  SYSDATE,
14:33:51 154  	  in_created_by
14:33:51 155  	);
14:33:51 156  END CREATE_ACCOUNT_NOTE;
14:33:51 157  
14:33:51 158  END PROCS_ACCOUNT_CRU_V22;
14:33:51 159  .
14:33:51 SQL> /

Package body created.

Elapsed: 00:00:00.04
14:33:51 SQL> 
14:33:51 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_ADDRESS_CRU_V22" AS
14:33:51   2  
14:33:51   3  PROCEDURE CREATE_ADDRESS(
14:33:51   4  	out_address_id	      OUT ADDRESS.ID%TYPE,
14:33:51   5  	in_address_id	      IN ADDRESS.ID%TYPE DEFAULT NULL,
14:33:51   6  	in_address1	      IN ADDRESS.ADDRESS1%TYPE DEFAULT NULL,
14:33:51   7  	in_address2	      IN ADDRESS.ADDRESS2%TYPE DEFAULT NULL,
14:33:51   8  	in_city 	      IN ADDRESS.CITY%TYPE DEFAULT NULL,
14:33:51   9  	in_state	      IN ADDRESS.STATE%TYPE DEFAULT NULL,
14:33:51  10  	in_postal_code	      IN ADDRESS.POSTAL_CODE%TYPE DEFAULT NULL,
14:33:51  11  	in_country	      IN ADDRESS.COUNTRY%TYPE DEFAULT NULL,
14:33:51  12  	in_created_by	      IN ADDRESS.CREATED_BY%TYPE
14:33:51  13  ) AS
14:33:51  14  -- VARIABLES
14:33:51  15  var_address_id ADDRESS.ID%TYPE;
14:33:51  16  var_date DATE := SYSDATE;
14:33:51  17  BEGIN
14:33:51  18  	IF in_address_id IS NULL THEN
14:33:51  19  	  SELECT
14:33:51  20  	    ADDRESS_ID_SEQ.nextVal into var_address_id
14:33:51  21  	  FROM DUAL;
14:33:51  22  	ELSE
14:33:51  23  	  var_address_id := in_address_id;
14:33:51  24  	END IF;
14:33:51  25  	INSERT INTO
14:33:51  26  	  ADDRESS (
14:33:51  27  	    ID,
14:33:51  28  	    ADDRESS1,
14:33:51  29  	    ADDRESS2,
14:33:51  30  	    CITY,
14:33:51  31  	    STATE,
14:33:51  32  	    POSTAL_CODE,
14:33:51  33  	    COUNTRY,
14:33:51  34  	    CREATE_DATE,
14:33:51  35  	    CREATED_BY,
14:33:51  36  	    UPDATE_DATE,
14:33:51  37  	    UPDATED_BY
14:33:51  38  	  ) VALUES (
14:33:51  39  	    var_address_id,
14:33:51  40  	    in_address1,
14:33:51  41  	    in_address2,
14:33:51  42  	    in_city,
14:33:51  43  	    in_state,
14:33:51  44  	    in_postal_code,
14:33:51  45  	    in_country,
14:33:51  46  	    var_date,
14:33:51  47  	    in_created_by,
14:33:51  48  	    var_date,
14:33:51  49  	    in_created_by
14:33:51  50  	  );
14:33:51  51  
14:33:51  52  	out_address_id := var_address_id;
14:33:51  53  END CREATE_ADDRESS;
14:33:51  54  
14:33:51  55  PROCEDURE UPDATE_ADDRESS(
14:33:51  56  	in_address_id	      IN ADDRESS.ID%TYPE,
14:33:51  57  	in_address1	      IN ADDRESS.ADDRESS1%TYPE DEFAULT NULL,
14:33:51  58  	in_address2	      IN ADDRESS.ADDRESS2%TYPE DEFAULT NULL,
14:33:51  59  	in_city 	      IN ADDRESS.CITY%TYPE DEFAULT NULL,
14:33:51  60  	in_state	      IN ADDRESS.STATE%TYPE DEFAULT NULL,
14:33:51  61  	in_postal_code	      IN ADDRESS.POSTAL_CODE%TYPE DEFAULT NULL,
14:33:51  62  	in_country	      IN ADDRESS.COUNTRY%TYPE DEFAULT NULL,
14:33:51  63  	in_updated_by	      IN ADDRESS.UPDATED_BY%TYPE
14:33:51  64  ) AS
14:33:51  65  BEGIN
14:33:51  66  
14:33:51  67  	-- Create history
14:33:51  68  	PROCS_HISTORY_V22.CREATE_ADDRESS_HISTORY(
14:33:51  69  	  in_address_id 		=> in_address_id,
14:33:51  70  	  in_system_activity_reason_id => GLOBAL_ENUMS_V22.SAC_SYSTEM_APPLIED_RULE
14:33:51  71  	);
14:33:51  72  
14:33:51  73  	UPDATE
14:33:51  74  	  ADDRESS
14:33:51  75  	SET
14:33:51  76  	  ADDRESS1 = NVL(in_address1, ADDRESS1),
14:33:51  77  	  ADDRESS2 = NVL(in_address2, ADDRESS2),
14:33:51  78  	  CITY = NVL(in_city, CITY),
14:33:51  79  	  STATE = NVL(in_state, STATE),
14:33:51  80  	  POSTAL_CODE = NVL(in_postal_code, POSTAL_CODE),
14:33:51  81  	  COUNTRY = NVL(in_country, COUNTRY),
14:33:51  82  	  UPDATE_DATE = SYSDATE,
14:33:51  83  	  UPDATED_BY = in_updated_by
14:33:51  84  	WHERE
14:33:51  85  	  ID = in_address_id;
14:33:51  86  
14:33:51  87  END UPDATE_ADDRESS;
14:33:51  88  
14:33:51  89  END PROCS_ADDRESS_CRU_V22;
14:33:51  90  .
14:33:51 SQL> /

Package body created.

Elapsed: 00:00:00.03
14:33:51 SQL> 
14:33:51 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_AMAZON_CRU_V22" AS
14:33:51   2  
14:33:51   3  PROCEDURE UPDATE_AMAZON_APPSTORE_RECEIPT(
14:33:51   4  	in_id		   IN AMAZON_APPSTORE_RECEIPT.ID%TYPE,
14:33:51   5  	in_updated_by	   IN AMAZON_APPSTORE_RECEIPT.UPDATED_BY%TYPE,
14:33:51   6  	in_subscription_id IN AMAZON_APPSTORE_RECEIPT.SUBSCRIPTION_ID%TYPE DEFAULT NULL,
14:33:51   7  	in_user_id	   IN AMAZON_APPSTORE_RECEIPT.USER_ID%TYPE DEFAULT NULL,
14:33:51   8  	in_item_type	   IN AMAZON_APPSTORE_RECEIPT.ITEM_TYPE%TYPE DEFAULT NULL,
14:33:51   9  	in_start_date	   IN AMAZON_APPSTORE_RECEIPT.START_DATE%TYPE DEFAULT NULL,
14:33:51  10  	in_end_date	   IN AMAZON_APPSTORE_RECEIPT.END_DATE%TYPE DEFAULT NULL,
14:33:51  11  	in_sku		   IN AMAZON_APPSTORE_RECEIPT.SKU%TYPE DEFAULT NULL,
14:33:51  12  	in_purchase_token  IN AMAZON_APPSTORE_RECEIPT.PURCHASE_TOKEN%TYPE DEFAULT NULL,
14:33:51  13  	in_last_check_date IN AMAZON_APPSTORE_RECEIPT.LAST_CHECK_DATE%TYPE DEFAULT NULL
14:33:51  14  ) AS
14:33:51  15  SPROC_NAME CONSTANT VARCHAR2(32) := 'UPDATE_AMAZON_APPSTORE_RECEIPT';
14:33:51  16  BEGIN
14:33:51  17  	CORE_OWNER.PROCS_HISTORY_V22.CREATE_AASR_HISTORY(
14:33:51  18  	    in_id => in_id,
14:33:51  19  	    in_system_activity_reason_id => GLOBAL_ENUMS_V22.SAC_SYSTEM_APPLIED_RULE,
14:33:51  20  	    in_created_by => in_updated_by
14:33:51  21  	);
14:33:51  22  
14:33:51  23  	UPDATE AMAZON_APPSTORE_RECEIPT SET
14:33:51  24  	  SUBSCRIPTION_ID = NVL(in_subscription_id,SUBSCRIPTION_ID),
14:33:51  25  	  USER_ID	  = NVL(in_user_id,USER_ID),
14:33:51  26  	  ITEM_TYPE	  = NVL(in_item_type,ITEM_TYPE),
14:33:51  27  	  START_DATE	  = NVL(in_start_date,START_DATE),
14:33:51  28  	  END_DATE	  = NVL(in_end_date,END_DATE),
14:33:51  29  	  SKU		  = NVL(in_sku,SKU),
14:33:51  30  	  PURCHASE_TOKEN  = NVL(in_purchase_token,PURCHASE_TOKEN),
14:33:51  31  	  LAST_CHECK_DATE = NVL(in_last_check_date,LAST_CHECK_DATE),
14:33:51  32  	  UPDATE_DATE	  = SYSDATE,
14:33:51  33  	  UPDATED_BY	  = in_updated_by
14:33:51  34  	WHERE
14:33:51  35  	  ID = in_id;
14:33:51  36  END UPDATE_AMAZON_APPSTORE_RECEIPT;
14:33:51  37  
14:33:51  38  PROCEDURE ADD_AMAZON_APPSTORE_RECEIPT(
14:33:51  39  	in_subscription_id IN AMAZON_APPSTORE_RECEIPT.SUBSCRIPTION_ID%TYPE,
14:33:51  40  	in_user_id	   IN AMAZON_APPSTORE_RECEIPT.USER_ID%TYPE,
14:33:51  41  	in_item_type	   IN AMAZON_APPSTORE_RECEIPT.ITEM_TYPE%TYPE,
14:33:51  42  	in_start_date	   IN AMAZON_APPSTORE_RECEIPT.START_DATE%TYPE,
14:33:51  43  	in_end_date	   IN AMAZON_APPSTORE_RECEIPT.END_DATE%TYPE DEFAULT NULL,
14:33:51  44  	in_sku		   IN AMAZON_APPSTORE_RECEIPT.SKU%TYPE,
14:33:51  45  	in_purchase_token  IN AMAZON_APPSTORE_RECEIPT.PURCHASE_TOKEN%TYPE,
14:33:51  46  	in_created_by	   IN AMAZON_APPSTORE_RECEIPT.CREATED_BY%TYPE
14:33:51  47  ) AS
14:33:51  48  SPROC_NAME CONSTANT VARCHAR2(32) := 'ADD_AMAZON_APPSTORE_RECEIPT';
14:33:51  49  var_now	 DATE := SYSDATE;
14:33:51  50  BEGIN
14:33:51  51  	INSERT INTO CORE_OWNER.AMAZON_APPSTORE_RECEIPT (
14:33:51  52  	  ID,
14:33:51  53  	  SUBSCRIPTION_ID,
14:33:51  54  	  USER_ID,
14:33:51  55  	  ITEM_TYPE,
14:33:51  56  	  START_DATE,
14:33:51  57  	  END_DATE,
14:33:51  58  	  SKU,
14:33:51  59  	  PURCHASE_TOKEN,
14:33:51  60  	  CREATE_DATE,
14:33:51  61  	  CREATED_BY,
14:33:51  62  	  UPDATE_DATE,
14:33:51  63  	  UPDATED_BY
14:33:51  64  	) VALUES (
14:33:51  65  	  CORE_OWNER.AAS_RECEIPT_ID_SEQ.nextval,
14:33:51  66  	  in_subscription_id,
14:33:51  67  	  in_user_id,
14:33:51  68  	  in_item_type,
14:33:51  69  	  in_start_date,
14:33:51  70  	  in_end_date,
14:33:51  71  	  in_sku,
14:33:51  72  	  in_purchase_token,
14:33:51  73  	  var_now,
14:33:51  74  	  in_created_by,
14:33:51  75  	  var_now,
14:33:51  76  	  in_created_by
14:33:51  77  	);
14:33:51  78  END ADD_AMAZON_APPSTORE_RECEIPT;
14:33:51  79  
14:33:51  80  	PROCEDURE CREATE_AMAZON_SUB(
14:33:51  81  /*
14:33:51  82  Throws exceptions:
14:33:51  83  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51  84  */
14:33:51  85  	  out_id	      OUT NUMBER,
14:33:51  86  	  in_subscription_id  IN AMAZON_SUB.SUBSCRIPTION_ID%TYPE,
14:33:51  87  	  in_amazon_id	      IN AMAZON_SUB.AMAZON_ID%TYPE,
14:33:51  88  	  in_created_by       IN AMAZON_SUB.CREATED_BY%TYPE
14:33:51  89  ) AS
14:33:51  90  -- VARIABLES
14:33:51  91  SPROC_NAME	CONSTANT VARCHAR2(32) := 'CREATE_AMAZON_SUB';
14:33:51  92  var_current_date	DATE;
14:33:51  93  var_count 	NUMBER;
14:33:51  94  AMAZON_SUB_USED	EXCEPTION;
14:33:51  95  BEGIN
14:33:51  96  
14:33:51  97  	SELECT COUNT(1) INTO var_count
14:33:51  98  	FROM SUBSCRIPTION s, AMAZON_SUB am
14:33:51  99  	WHERE
14:33:51 100  	  am.AMAZON_ID = in_amazon_id
14:33:51 101  	  and am.subscription_id = s.id
14:33:51 102  	  and s.subscription_status_id = GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE;
14:33:51 103  
14:33:51 104  	if var_count > 0 then
14:33:51 105  	  raise AMAZON_SUB_USED;
14:33:51 106  	end if;
14:33:51 107  
14:33:51 108  	SELECT
14:33:51 109  	  CORE_OWNER.AMAZON_SUB_ID_SEQ.NEXTVAL
14:33:51 110  	INTO
14:33:51 111  	  out_id
14:33:51 112  	FROM
14:33:51 113  	  dual
14:33:51 114  	;
14:33:51 115  
14:33:51 116  	SELECT
14:33:51 117  	  sysdate
14:33:51 118  	INTO
14:33:51 119  	  var_current_date
14:33:51 120  	FROM
14:33:51 121  	  dual
14:33:51 122  	;
14:33:51 123  
14:33:51 124  	INSERT INTO CORE_OWNER.AMAZON_SUB
14:33:51 125  	(
14:33:51 126  	  id,
14:33:51 127  	  subscription_id,
14:33:51 128  	  amazon_id,
14:33:51 129  	  create_date,
14:33:51 130  	  created_by,
14:33:51 131  	  update_date,
14:33:51 132  	  updated_by
14:33:51 133  	)
14:33:51 134  	VALUES
14:33:51 135  	(
14:33:51 136  	  out_id,
14:33:51 137  	  in_subscription_id,
14:33:51 138  	  in_amazon_id,
14:33:51 139  	  var_current_date,
14:33:51 140  	  in_created_by,
14:33:51 141  	  var_current_date,
14:33:51 142  	  in_created_by
14:33:51 143  	);
14:33:51 144  
14:33:51 145  EXCEPTION
14:33:51 146  WHEN AMAZON_SUB_USED THEN
14:33:51 147  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.DUPLICATE_ERROR,
14:33:51 148  	  SPROC_NAME, 'Amazon sub already used', SQLERRM);
14:33:51 149  WHEN DUP_VAL_ON_INDEX THEN
14:33:51 150  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.DUPLICATE_ERROR,
14:33:51 151  	  SPROC_NAME, 'Duplicate value', SQLERRM);
14:33:51 152  WHEN OTHERS THEN
14:33:51 153  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:51 154  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:51 155  END CREATE_AMAZON_SUB;
14:33:51 156  
14:33:51 157  END PROCS_AMAZON_CRU_V22;
14:33:51 158  .
14:33:51 SQL> /

Package body created.

Elapsed: 00:00:00.03
14:33:51 SQL> 
14:33:51 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_CHARGE_CRU_V22" AS
14:33:51   2  
14:33:51   3  PROCEDURE CREATE_CHARGE(
14:33:51   4  	out_charge_id	      OUT CHARGE.ID%TYPE,
14:33:51   5  	in_charge_id	      IN CHARGE.ID%TYPE DEFAULT NULL,
14:33:51   6  	in_invoice_id	      IN CHARGE.INVOICE_ID%TYPE,
14:33:51   7  	in_transaction_id     IN CHARGE.TRANSACTION_ID%TYPE DEFAULT NULL,
14:33:51   8  	in_instrument_type_id IN CHARGE.INSTRUMENT_TYPE_ID%TYPE,
14:33:51   9  	in_instrument_id      IN CHARGE.INSTRUMENT_ID%TYPE,
14:33:51  10  	in_charge_amount      IN CHARGE.CHARGE_AMOUNT%TYPE,
14:33:51  11  	in_charge_status_id   IN CHARGE.CHARGE_STATUS_ID%TYPE,
14:33:51  12  	in_created_by	      IN CHARGE.CREATED_BY%TYPE
14:33:51  13  ) AS
14:33:51  14  -- VARIABLES
14:33:51  15  var_charge_id CHARGE.ID%TYPE;
14:33:51  16  -- arosolovskiy: using data variable instead of direct get data calls (#38860)
14:33:51  17  var_date DATE := SYSDATE;
14:33:51  18  BEGIN
14:33:51  19  	IF in_charge_id IS NULL THEN
14:33:51  20  	  SELECT
14:33:51  21  	    CRG_ID_SEQ.nextVal into var_charge_id
14:33:51  22  	  FROM DUAL;
14:33:51  23  	ELSE
14:33:51  24  	  var_charge_id := in_charge_id;
14:33:51  25  	END IF;
14:33:51  26  	INSERT INTO
14:33:51  27  	  CHARGE (
14:33:51  28  	    ID,
14:33:51  29  	    INVOICE_ID,
14:33:51  30  	    TRANSACTION_ID,
14:33:51  31  	    INSTRUMENT_TYPE_ID,
14:33:51  32  	    INSTRUMENT_ID,
14:33:51  33  	    CHARGE_AMOUNT,
14:33:51  34  	    CHARGE_STATUS_ID,
14:33:51  35  	    CREATE_DATE,
14:33:51  36  	    CREATED_BY,
14:33:51  37  	    UPDATE_DATE,
14:33:51  38  	    UPDATED_BY
14:33:51  39  	  ) VALUES (
14:33:51  40  	    var_charge_id,
14:33:51  41  	    in_invoice_id,
14:33:51  42  	    in_transaction_id,
14:33:51  43  	    in_instrument_type_id,
14:33:51  44  	    in_instrument_id,
14:33:51  45  	    in_charge_amount,
14:33:51  46  	    in_charge_status_id,
14:33:51  47  	    var_date,
14:33:51  48  	    in_created_by,
14:33:51  49  	    var_date,
14:33:51  50  	    in_created_by
14:33:51  51  	  );
14:33:51  52  
14:33:51  53  	out_charge_id := var_charge_id;
14:33:51  54  END CREATE_CHARGE;
14:33:51  55  
14:33:51  56  PROCEDURE UPDATE_CHARGE(
14:33:51  57  	in_charge_id	      IN CHARGE.ID%TYPE,
14:33:51  58  	in_instrument_type_id IN CHARGE.INSTRUMENT_TYPE_ID%TYPE DEFAULT NULL,
14:33:51  59  	in_instrument_id      IN CHARGE.INSTRUMENT_ID%TYPE DEFAULT NULL,
14:33:51  60  	in_charge_amount      IN CHARGE.CHARGE_AMOUNT%TYPE DEFAULT NULL,
14:33:51  61  	in_charge_status_id   IN CHARGE.CHARGE_STATUS_ID%TYPE DEFAULT NULL,
14:33:51  62  	in_updated_by	      IN CHARGE.UPDATED_BY%TYPE
14:33:51  63  ) AS
14:33:51  64  BEGIN
14:33:51  65  
14:33:51  66  	-- Create history
14:33:51  67  	PROCS_HISTORY_V22.CREATE_CHARGE_HISTORY(
14:33:51  68  	  in_charge_id		       => in_charge_id,
14:33:51  69  	  in_system_activity_reason_id => GLOBAL_ENUMS_V22.SAC_SYSTEM_APPLIED_RULE
14:33:51  70  	);
14:33:51  71  
14:33:51  72  	UPDATE
14:33:51  73  	  CHARGE
14:33:51  74  	SET
14:33:51  75  	  INSTRUMENT_TYPE_ID = NVL(in_instrument_type_id, INSTRUMENT_TYPE_ID),
14:33:51  76  	  INSTRUMENT_ID      = NVL(in_instrument_id, INSTRUMENT_ID),
14:33:51  77  	  CHARGE_AMOUNT      = NVL(in_charge_amount, CHARGE_AMOUNT),
14:33:51  78  	  CHARGE_STATUS_ID   = NVL(in_charge_status_id, CHARGE_STATUS_ID),
14:33:51  79  	  UPDATE_DATE	     = SYSDATE,
14:33:51  80  	  UPDATED_BY	     = in_updated_by
14:33:51  81  	WHERE
14:33:51  82  	  ID = in_charge_id;
14:33:51  83  
14:33:51  84  END UPDATE_CHARGE;
14:33:51  85  
14:33:51  86  END PROCS_CHARGE_CRU_V22;
14:33:51  87  .
14:33:51 SQL> /

Package body created.

Elapsed: 00:00:00.02
14:33:51 SQL> 
14:33:51 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_FIN_INSTRUMENTS_CRU_V22" AS
14:33:51   2  
14:33:51   3  PROCEDURE CREATE_CREDIT_CARD(
14:33:51   4  	out_credit_card_id	    OUT CREDIT_CARD.ID%TYPE,
14:33:51   5  	in_credit_card_id	    IN CREDIT_CARD.ID%TYPE DEFAULT NULL,
14:33:51   6  	in_account_id		    IN CREDIT_CARD.ACCOUNT_ID%TYPE,
14:33:51   7  	in_instrument_name	    IN CREDIT_CARD.INSTRUMENT_NAME%TYPE,
14:33:51   8  	in_private_card_holder_name IN CREDIT_CARD.PRIVATE_CARD_HOLDER_NAME%TYPE,
14:33:51   9  	in_private_street_address   IN CREDIT_CARD.PRIVATE_STREET_ADDRESS%TYPE,
14:33:51  10  	in_private_street_address2  IN CREDIT_CARD.PRIVATE_STREET_ADDRESS2%TYPE DEFAULT NULL,
14:33:51  11  	in_state		    IN CREDIT_CARD.STATE%TYPE,
14:33:51  12  	in_city 		    IN CREDIT_CARD.CITY%TYPE,
14:33:51  13  	in_postal_code		    IN CREDIT_CARD.POSTAL_CODE%TYPE,
14:33:51  14  	in_country		    IN CREDIT_CARD.COUNTRY%TYPE,
14:33:51  15  	in_last_four_cc 	    IN CREDIT_CARD.LAST_FOUR_CC%TYPE,
14:33:51  16  	in_expiration_date	    IN CREDIT_CARD.EXPIRATION_DATE%TYPE,
14:33:51  17  	in_credit_card_type_id	    IN CREDIT_CARD.CREDIT_CARD_TYPE_ID%TYPE,
14:33:51  18  	in_secret_token 	    IN CREDIT_CARD.SECRET_TOKEN%TYPE,
14:33:51  19  	in_chase_profile_id		in CREDIT_CARD.CHASE_PROFILE_ID%TYPE,
14:33:51  20  	in_created_by		    IN CREDIT_CARD.CREATED_BY%TYPE,
14:33:51  21  	in_credit_card_status_id    IN CREDIT_CARD.CREDIT_CARD_STATUS_ID%TYPE,
14:33:51  22  	in_private_first_name	    IN CREDIT_CARD.PRIVATE_FIRST_NAME%TYPE,
14:33:51  23  	in_private_last_name	    IN CREDIT_CARD.PRIVATE_LAST_NAME%TYPE
14:33:51  24  ) AS
14:33:51  25  -- VARIABLES
14:33:51  26  var_credit_card_id CREDIT_CARD.ID%TYPE;
14:33:51  27  -- arosolovskiy: using data variable instead of direct get data calls (#38860)
14:33:51  28  var_date DATE := SYSDATE;
14:33:51  29  BEGIN
14:33:51  30  	IF in_credit_card_id IS NULL THEN
14:33:51  31  	  SELECT
14:33:51  32  	    CC_ID_SEQ.nextVal into var_credit_card_id
14:33:51  33  	  FROM DUAL;
14:33:51  34  	ELSE
14:33:51  35  	  var_credit_card_id := in_credit_card_id;
14:33:51  36  	END IF;
14:33:51  37  	INSERT INTO CREDIT_CARD(
14:33:51  38  	    ID,
14:33:51  39  	    ACCOUNT_ID,
14:33:51  40  	    INSTRUMENT_NAME,
14:33:51  41  	    PRIVATE_CARD_HOLDER_NAME,
14:33:51  42  	    PRIVATE_STREET_ADDRESS,
14:33:51  43  	    PRIVATE_STREET_ADDRESS2,
14:33:51  44  	    STATE,
14:33:51  45  	    CITY,
14:33:51  46  	    POSTAL_CODE,
14:33:51  47  	    COUNTRY,
14:33:51  48  	    LAST_FOUR_CC,
14:33:51  49  	    EXPIRATION_DATE,
14:33:51  50  	    CREDIT_CARD_TYPE_ID,
14:33:51  51  	    SECRET_TOKEN,
14:33:51  52  	    CHASE_PROFILE_ID,
14:33:51  53  	    CREATE_DATE,
14:33:51  54  	    CREATED_BY,
14:33:51  55  	    UPDATE_DATE,
14:33:51  56  	    UPDATED_BY,
14:33:51  57  	    CREDIT_CARD_STATUS_ID,
14:33:51  58  	    PRIVATE_FIRST_NAME,
14:33:51  59  	    PRIVATE_LAST_NAME
14:33:51  60  	  ) VALUES (
14:33:51  61  	    var_credit_card_id,
14:33:51  62  	    in_account_id,
14:33:51  63  	    in_instrument_name,
14:33:51  64  	    in_private_card_holder_name,
14:33:51  65  	    in_private_street_address,
14:33:51  66  	    in_private_street_address2,
14:33:51  67  	    in_state,
14:33:51  68  	    in_city,
14:33:51  69  	    in_postal_code,
14:33:51  70  	    in_country,
14:33:51  71  	    in_last_four_cc,
14:33:51  72  	    in_expiration_date,
14:33:51  73  	    in_credit_card_type_id,
14:33:51  74  	    in_secret_token,
14:33:51  75  	    in_chase_profile_id,
14:33:51  76  	    var_date,
14:33:51  77  	    in_created_by,
14:33:51  78  	    var_date,
14:33:51  79  	    in_created_by,
14:33:51  80  	    in_credit_card_status_id,
14:33:51  81  	    in_private_first_name,
14:33:51  82  	    in_private_last_name
14:33:51  83  	  );
14:33:51  84  
14:33:51  85  	out_credit_card_id := var_credit_card_id;
14:33:51  86  END CREATE_CREDIT_CARD;
14:33:51  87  
14:33:51  88  /******************************************************************************/
14:33:51  89  
14:33:51  90  PROCEDURE UPDATE_CREDIT_CARD(
14:33:51  91  	in_credit_card_id	    IN CREDIT_CARD.ID%TYPE,
14:33:51  92  	in_instrument_name	    IN CREDIT_CARD.INSTRUMENT_NAME%TYPE DEFAULT NULL,
14:33:51  93  	in_private_card_holder_name IN CREDIT_CARD.PRIVATE_CARD_HOLDER_NAME%TYPE DEFAULT NULL,
14:33:51  94  	in_private_street_address   IN CREDIT_CARD.PRIVATE_STREET_ADDRESS%TYPE DEFAULT NULL,
14:33:51  95  	in_private_street_address2  IN CREDIT_CARD.PRIVATE_STREET_ADDRESS2%TYPE DEFAULT NULL,
14:33:51  96  	in_state		    IN CREDIT_CARD.STATE%TYPE DEFAULT NULL,
14:33:51  97  	in_city 		    IN CREDIT_CARD.CITY%TYPE DEFAULT NULL,
14:33:51  98  	in_postal_code		    IN CREDIT_CARD.POSTAL_CODE%TYPE DEFAULT NULL,
14:33:51  99  	in_country		    IN CREDIT_CARD.COUNTRY%TYPE DEFAULT NULL,
14:33:51 100  	in_last_four_cc 	    IN CREDIT_CARD.LAST_FOUR_CC%TYPE DEFAULT NULL,
14:33:51 101  	in_expiration_date	    IN CREDIT_CARD.EXPIRATION_DATE%TYPE DEFAULT NULL,
14:33:51 102  	in_credit_card_type_id	    IN CREDIT_CARD.CREDIT_CARD_TYPE_ID%TYPE DEFAULT NULL,
14:33:51 103  	in_secret_token 	    IN CREDIT_CARD.SECRET_TOKEN%TYPE DEFAULT NULL,
14:33:51 104  	in_chase_profile_id	    IN CREDIT_CARD.CHASE_PROFILE_ID%TYPE DEFAULT NULL,
14:33:51 105  	in_updated_by		    IN CREDIT_CARD.UPDATED_BY%TYPE,
14:33:51 106  	in_credit_card_status_id    IN CREDIT_CARD.CREDIT_CARD_STATUS_ID%TYPE DEFAULT NULL,
14:33:51 107  	in_private_first_name	    IN CREDIT_CARD.PRIVATE_FIRST_NAME%TYPE DEFAULT NULL,
14:33:51 108  	in_private_last_name	    IN CREDIT_CARD.PRIVATE_LAST_NAME%TYPE DEFAULT NULL
14:33:51 109  ) AS
14:33:51 110  BEGIN
14:33:51 111  
14:33:51 112  	-- Create history
14:33:51 113  	PROCS_HISTORY_V22.CREATE_CREDIT_CARD_HISTORY(
14:33:51 114  	  in_credit_card_id	       => in_credit_card_id,
14:33:51 115  	  in_system_activity_reason_id => GLOBAL_ENUMS_V22.SAC_SYSTEM_APPLIED_RULE
14:33:51 116  	);
14:33:51 117  
14:33:51 118  	UPDATE CREDIT_CARD SET
14:33:51 119  	  INSTRUMENT_NAME	   = NVL(in_instrument_name, INSTRUMENT_NAME),
14:33:51 120  	  PRIVATE_CARD_HOLDER_NAME = NVL(in_private_card_holder_name, PRIVATE_CARD_HOLDER_NAME),
14:33:51 121  	  PRIVATE_STREET_ADDRESS   = NVL(in_private_street_address, PRIVATE_STREET_ADDRESS),
14:33:51 122  	  PRIVATE_STREET_ADDRESS2  = NVL(in_private_street_address, PRIVATE_STREET_ADDRESS2),
14:33:51 123  	  STATE 		   = NVL(in_state, STATE),
14:33:51 124  	  CITY			   = NVL(in_city, CITY),
14:33:51 125  	  POSTAL_CODE		   = NVL(in_postal_code, POSTAL_CODE),
14:33:51 126  	  COUNTRY		   = NVL(in_country, COUNTRY),
14:33:51 127  	  LAST_FOUR_CC		   = NVL(in_last_four_cc, LAST_FOUR_CC),
14:33:51 128  	  EXPIRATION_DATE	   = NVL(in_expiration_date, EXPIRATION_DATE),
14:33:51 129  	  CREDIT_CARD_TYPE_ID	   = NVL(in_credit_card_type_id, CREDIT_CARD_TYPE_ID),
14:33:51 130  	  SECRET_TOKEN		   = NVL(in_secret_token, SECRET_TOKEN),
14:33:51 131  	  CHASE_PROFILE_ID	   = NVL(in_chase_profile_id, CHASE_PROFILE_ID),
14:33:51 132  	  UPDATE_DATE		   = SYSDATE,
14:33:51 133  	  UPDATED_BY		   = in_updated_by,
14:33:51 134  	  CREDIT_CARD_STATUS_ID    = NVL(in_credit_card_status_id, CREDIT_CARD_STATUS_ID),
14:33:51 135  	  PRIVATE_FIRST_NAME	   = NVL(in_private_first_name, PRIVATE_FIRST_NAME),
14:33:51 136  	  PRIVATE_LAST_NAME	   = NVL(in_private_last_name, PRIVATE_LAST_NAME)
14:33:51 137  	WHERE
14:33:51 138  	  ID = in_credit_card_id;
14:33:51 139  
14:33:51 140  END UPDATE_CREDIT_CARD;
14:33:51 141  
14:33:51 142  /******************************************************************************/
14:33:51 143  
14:33:51 144  PROCEDURE CREATE_PAYPAL(
14:33:51 145  	out_paypal_id			OUT PAYPAL.ID%TYPE,
14:33:51 146  	in_paypal_id			IN PAYPAL.ID%TYPE DEFAULT NULL,
14:33:51 147  	in_account_id			IN PAYPAL.ACCOUNT_ID%TYPE,
14:33:51 148  	in_instrument_name		IN PAYPAL.INSTRUMENT_NAME%TYPE DEFAULT NULL,
14:33:51 149  	in_private_email_address	IN PAYPAL.PRIVATE_EMAIL_ADDRESS%TYPE DEFAULT NULL,
14:33:51 150  	in_created_by			IN PAYPAL.CREATED_BY%TYPE,
14:33:51 151  	in_paypal_status_id		IN PAYPAL.PAYPAL_STATUS_ID%TYPE,
14:33:51 152  	in_paypal_prvt_street_address	IN PAYPAL.PRIVATE_STREET_ADDRESS%TYPE,
14:33:51 153  	in_paypal_prvt_street_address2	IN PAYPAL.PRIVATE_STREET_ADDRESS%TYPE,
14:33:51 154  	in_state			IN PAYPAL.STATE%TYPE,
14:33:51 155  	in_city 			IN PAYPAL.CITY%TYPE,
14:33:51 156  	in_postal_code			IN PAYPAL.POSTAL_CODE%TYPE,
14:33:51 157  	in_country			IN PAYPAL.COUNTRY%TYPE,
14:33:51 158  	in_expiration_date		IN PAYPAL.EXPIRATION_DATE%TYPE,
14:33:51 159  	in_secret_token 		IN PAYPAL.SECRET_TOKEN%TYPE
14:33:51 160  ) AS
14:33:51 161  -- VARIABLES
14:33:51 162  var_paypal_id PAYPAL.ID%TYPE;
14:33:51 163  -- arosolovskiy: using data variable instead of direct get data calls (#38860)
14:33:51 164  var_date DATE := SYSDATE;
14:33:51 165  BEGIN
14:33:51 166  	IF in_paypal_id IS NULL THEN
14:33:51 167  	  SELECT
14:33:51 168  	    PP_ID_SEQ.nextVal into var_paypal_id
14:33:51 169  	  FROM DUAL;
14:33:51 170  	ELSE
14:33:51 171  	  var_paypal_id := in_paypal_id;
14:33:51 172  	END IF;
14:33:51 173  	INSERT INTO PAYPAL(
14:33:51 174  	    ID,
14:33:51 175  	    ACCOUNT_ID,
14:33:51 176  	    INSTRUMENT_NAME,
14:33:51 177  	    PRIVATE_EMAIL_ADDRESS,
14:33:51 178  	    CREATE_DATE,
14:33:51 179  	    CREATED_BY,
14:33:51 180  	    UPDATE_DATE,
14:33:51 181  	    UPDATED_BY,
14:33:51 182  	    PAYPAL_STATUS_ID,
14:33:51 183  	    PRIVATE_STREET_ADDRESS,
14:33:51 184  	    PRIVATE_STREET_ADDRESS2,
14:33:51 185  	    STATE,
14:33:51 186  	    CITY,
14:33:51 187  	    POSTAL_CODE,
14:33:51 188  	    COUNTRY,
14:33:51 189  	    EXPIRATION_DATE,
14:33:51 190  	    SECRET_TOKEN
14:33:51 191  	  ) VALUES (
14:33:51 192  	    var_paypal_id,
14:33:51 193  	    in_account_id,
14:33:51 194  	    in_instrument_name,
14:33:51 195  	    in_private_email_address,
14:33:51 196  	    var_date,
14:33:51 197  	    in_created_by,
14:33:51 198  	    var_date,
14:33:51 199  	    in_created_by,
14:33:51 200  	    in_paypal_status_id,
14:33:51 201  	    in_paypal_prvt_street_address,
14:33:51 202  	    in_paypal_prvt_street_address2,
14:33:51 203  	    in_state,
14:33:51 204  	    in_city,
14:33:51 205  	    in_postal_code,
14:33:51 206  	    in_country,
14:33:51 207  	    in_expiration_date,
14:33:51 208  	    in_secret_token
14:33:51 209  	  );
14:33:51 210  	out_paypal_id := var_paypal_id;
14:33:51 211  END CREATE_PAYPAL;
14:33:51 212  
14:33:51 213  /******************************************************************************/
14:33:51 214  
14:33:51 215  PROCEDURE UPDATE_PAYPAL(
14:33:51 216  	in_paypal_id			IN PAYPAL.ID%TYPE,
14:33:51 217  	in_instrument_name		IN PAYPAL.INSTRUMENT_NAME%TYPE DEFAULT NULL,
14:33:51 218  	in_private_email_address	IN PAYPAL.PRIVATE_EMAIL_ADDRESS%TYPE DEFAULT NULL,
14:33:51 219  	in_updated_by			IN PAYPAL.UPDATED_BY%TYPE,
14:33:51 220  	in_paypal_status_id		IN PAYPAL.PAYPAL_STATUS_ID%TYPE DEFAULT NULL,
14:33:51 221  	in_paypal_prvt_street_address	IN PAYPAL.PRIVATE_STREET_ADDRESS%TYPE DEFAULT NULL,
14:33:51 222  	in_paypal_prvt_street_address2	IN PAYPAL.PRIVATE_STREET_ADDRESS%TYPE DEFAULT NULL,
14:33:51 223  	in_state			IN PAYPAL.STATE%TYPE DEFAULT NULL,
14:33:51 224  	in_city 			IN PAYPAL.CITY%TYPE DEFAULT NULL,
14:33:51 225  	in_postal_code			IN PAYPAL.POSTAL_CODE%TYPE DEFAULT NULL,
14:33:51 226  	in_country			IN PAYPAL.COUNTRY%TYPE DEFAULT NULL,
14:33:51 227  	in_expiration_date		IN PAYPAL.EXPIRATION_DATE%TYPE DEFAULT NULL,
14:33:51 228  	in_secret_token 		IN PAYPAL.SECRET_TOKEN%TYPE
14:33:51 229  ) AS
14:33:51 230  BEGIN
14:33:51 231  	-- Create history
14:33:51 232  	PROCS_HISTORY_V22.CREATE_PAYPAL_HISTORY(
14:33:51 233  	  in_paypal_id		       => in_paypal_id,
14:33:51 234  	  in_system_activity_reason_id => GLOBAL_ENUMS_V22.SAC_SYSTEM_APPLIED_RULE
14:33:51 235  	);
14:33:51 236  
14:33:51 237  	UPDATE PAYPAL SET
14:33:51 238  	  INSTRUMENT_NAME  = NVL(in_instrument_name, INSTRUMENT_NAME),
14:33:51 239  	  PRIVATE_EMAIL_ADDRESS    = NVL(in_private_email_address, PRIVATE_EMAIL_ADDRESS),
14:33:51 240  	  UPDATE_DATE	   = SYSDATE,
14:33:51 241  	  UPDATED_BY	   = in_updated_by,
14:33:51 242  	  PAYPAL_STATUS_ID = NVL(in_paypal_status_id, PAYPAL_STATUS_ID),
14:33:51 243  	  PRIVATE_STREET_ADDRESS  = NVL(in_paypal_prvt_street_address, PRIVATE_STREET_ADDRESS),
14:33:51 244  	  PRIVATE_STREET_ADDRESS2 = NVL(in_paypal_prvt_street_address2, PRIVATE_STREET_ADDRESS2),
14:33:51 245  	  STATE 		  = NVL(in_state, STATE),
14:33:51 246  	  CITY			  = NVL(in_city, CITY),
14:33:51 247  	  POSTAL_CODE		  = NVL(in_postal_code, POSTAL_CODE),
14:33:51 248  	  COUNTRY		  = NVL(in_country, COUNTRY),
14:33:51 249  	  EXPIRATION_DATE	  = NVL(in_expiration_date, EXPIRATION_DATE),
14:33:51 250  	  SECRET_TOKEN		  = NVL(in_secret_token, SECRET_TOKEN)
14:33:51 251  	WHERE
14:33:51 252  	  ID = in_paypal_id;
14:33:51 253  END UPDATE_PAYPAL;
14:33:51 254  
14:33:51 255  /******************************************************************************/
14:33:51 256  
14:33:51 257  PROCEDURE CREATE_GIFT_CERTIFICATE(
14:33:51 258  	out_gift_certificate_id       OUT GIFT_CERTIFICATE.ID%TYPE,
14:33:51 259  	in_gift_certificate_id	      IN GIFT_CERTIFICATE.ID%TYPE DEFAULT NULL,
14:33:51 260  	in_purchaser_group_id	      IN GIFT_CERTIFICATE.PURCHASER_GROUP_ID%TYPE,
14:33:51 261  	in_purchaser_invoice_id       IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
14:33:51 262  	in_offer_chain_id	      IN GIFT_CERTIFICATE.OFFER_CHAIN_ID%TYPE,
14:33:51 263  	in_expiration_date	      IN GIFT_CERTIFICATE.EXPIRATION_DATE%TYPE DEFAULT NULL,
14:33:51 264  	in_purchase_date	      IN GIFT_CERTIFICATE.PURCHASE_DATE%TYPE,
14:33:51 265  	in_gift_certificate_status_id IN GIFT_CERTIFICATE.GIFT_CERTIFICATE_STATUS_ID%TYPE,
14:33:51 266  	in_code 		      IN GIFT_CERTIFICATE.CODE%TYPE,
14:33:51 267  	in_created_by		      IN GIFT_CERTIFICATE.CREATED_BY%TYPE,
14:33:51 268  	in_recipient_name	      IN GIFT_CERTIFICATE.RECIPIENT_NAME%TYPE DEFAULT NULL,
14:33:51 269  	in_gift_message 	      IN GIFT_CERTIFICATE.GIFT_MESSAGE%TYPE DEFAULT NULL,
14:33:51 270  	in_recipient_email	      IN GIFT_CERTIFICATE.RECIPIENT_EMAIL%TYPE DEFAULT NULL,
14:33:51 271  	in_finalized_invoice_id       IN GIFT_CERTIFICATE.FINALIZED_INVOICE_ID%TYPE DEFAULT NULL,
14:33:51 272  	in_sender_email 	      IN GIFT_CERTIFICATE.SENDER_EMAIL%TYPE,
14:33:51 273  	in_sender_name		      IN GIFT_CERTIFICATE.SENDER_NAME%TYPE,
14:33:51 274  	in_redemption_date	      IN GIFT_CERTIFICATE.REDEMPTION_DATE%TYPE DEFAULT NULL,
14:33:51 275  	in_cancelation_date	      IN GIFT_CERTIFICATE.CANCELATION_DATE%TYPE DEFAULT NULL,
14:33:51 276  	in_redeemer_group_id	      IN GIFT_CERTIFICATE.REDEEMER_GROUP_ID%TYPE DEFAULT NULL,
14:33:51 277  	in_recipient_address_id       IN GIFT_CERTIFICATE.RECIPIENT_ADDRESS_ID%TYPE DEFAULT NULL,
14:33:51 278  	in_recipient_notify_date      IN GIFT_CERTIFICATE.RECIPIENT_NOTIFY_DATE%TYPE DEFAULT NULL,
14:33:51 279  	in_campaign		      IN GC_CAMPAIGN_AND_REF.CAMPAIGN%TYPE DEFAULT NULL,
14:33:51 280  	in_reference_code	      IN GC_CAMPAIGN_AND_REF.REFERENCE_CODE%TYPE DEFAULT NULL
14:33:51 281  ) AS
14:33:51 282  -- VARIABLES
14:33:51 283  var_gift_certificate_id GIFT_CERTIFICATE.ID%TYPE;
14:33:51 284  -- arosolovskiy: using data variable instead of direct get data calls (#38860)
14:33:51 285  var_date DATE := SYSDATE;
14:33:51 286  BEGIN
14:33:51 287  	IF in_gift_certificate_id IS NULL THEN
14:33:51 288  	  SELECT
14:33:51 289  	    GC_ID_SEQ.nextVal into var_gift_certificate_id
14:33:51 290  	  FROM DUAL;
14:33:51 291  	ELSE
14:33:51 292  	  var_gift_certificate_id := in_gift_certificate_id;
14:33:51 293  	END IF;
14:33:51 294  
14:33:51 295  	INSERT INTO GIFT_CERTIFICATE (
14:33:51 296  	    ID,
14:33:51 297  	    PURCHASER_GROUP_ID,
14:33:51 298  	    PURCHASE_INVOICE_ID,
14:33:51 299  	    OFFER_CHAIN_ID,
14:33:51 300  	    EXPIRATION_DATE,
14:33:51 301  	    PURCHASE_DATE,
14:33:51 302  	    GIFT_CERTIFICATE_STATUS_ID,
14:33:51 303  	    CODE,
14:33:51 304  	    CREATE_DATE,
14:33:51 305  	    CREATED_BY,
14:33:51 306  	    UPDATE_DATE,
14:33:51 307  	    UPDATED_BY,
14:33:51 308  	    RECIPIENT_NAME,
14:33:51 309  	    GIFT_MESSAGE,
14:33:51 310  	    RECIPIENT_EMAIL,
14:33:51 311  	    FINALIZED_INVOICE_ID,
14:33:51 312  	    SENDER_EMAIL,
14:33:51 313  	    SENDER_NAME,
14:33:51 314  	    REDEMPTION_DATE,
14:33:51 315  	    CANCELATION_DATE,
14:33:51 316  	    REDEEMER_GROUP_ID,
14:33:51 317  	    RECIPIENT_ADDRESS_ID,
14:33:51 318  	    RECIPIENT_NOTIFY_DATE
14:33:51 319  	  ) VALUES(
14:33:51 320  	    var_gift_certificate_id,
14:33:51 321  	    in_purchaser_group_id,
14:33:51 322  	    in_purchaser_invoice_id,
14:33:51 323  	    in_offer_chain_id,
14:33:51 324  	    in_expiration_date,
14:33:51 325  	    in_purchase_date,
14:33:51 326  	    in_gift_certificate_status_id,
14:33:51 327  	    in_code,
14:33:51 328  	    var_date,
14:33:51 329  	    in_created_by,
14:33:51 330  	    var_date,
14:33:51 331  	    in_created_by,
14:33:51 332  	    in_recipient_name,
14:33:51 333  	    in_gift_message,
14:33:51 334  	    in_recipient_email,
14:33:51 335  	    in_finalized_invoice_id,
14:33:51 336  	    in_sender_email,
14:33:51 337  	    in_sender_name,
14:33:51 338  	    in_redemption_date,
14:33:51 339  	    in_cancelation_date,
14:33:51 340  	    in_redeemer_group_id,
14:33:51 341  	    in_recipient_address_id,
14:33:51 342  	    in_recipient_notify_date
14:33:51 343  	  );
14:33:51 344  
14:33:51 345  	  IF in_campaign IS NOT NULL THEN
14:33:51 346  	    INSERT INTO GC_CAMPAIGN_AND_REF(GC_ID, CAMPAIGN, REFERENCE_CODE)
14:33:51 347  	      VALUES(var_gift_certificate_id, in_campaign, in_reference_code);
14:33:51 348  	  END IF;
14:33:51 349  
14:33:51 350  	out_gift_certificate_id := var_gift_certificate_id;
14:33:51 351  END CREATE_GIFT_CERTIFICATE;
14:33:51 352  
14:33:51 353  /******************************************************************************/
14:33:51 354  
14:33:51 355  PROCEDURE UPDATE_GIFT_CERTIFICATE(
14:33:51 356  	in_gift_certificate_id	      IN GIFT_CERTIFICATE.ID%TYPE,
14:33:51 357  	in_expiration_date	      IN GIFT_CERTIFICATE.EXPIRATION_DATE%TYPE DEFAULT NULL,
14:33:51 358  	in_gift_certificate_status_id IN GIFT_CERTIFICATE.GIFT_CERTIFICATE_STATUS_ID%TYPE DEFAULT NULL,
14:33:51 359  	in_code 		      IN GIFT_CERTIFICATE.CODE%TYPE DEFAULT NULL,
14:33:51 360  	in_updated_by		      IN GIFT_CERTIFICATE.UPDATED_BY%TYPE,
14:33:51 361  	in_recipient_name	      IN GIFT_CERTIFICATE.RECIPIENT_NAME%TYPE DEFAULT NULL,
14:33:51 362  	in_gift_message 	      IN GIFT_CERTIFICATE.GIFT_MESSAGE%TYPE DEFAULT NULL,
14:33:51 363  	in_recipient_email	      IN GIFT_CERTIFICATE.RECIPIENT_EMAIL%TYPE DEFAULT NULL,
14:33:51 364  	in_finalized_invoice_id       IN GIFT_CERTIFICATE.FINALIZED_INVOICE_ID%TYPE DEFAULT NULL,
14:33:51 365  	in_sender_email 	      IN GIFT_CERTIFICATE.SENDER_EMAIL%TYPE DEFAULT NULL,
14:33:51 366  	in_sender_name		      IN GIFT_CERTIFICATE.SENDER_NAME%TYPE DEFAULT NULL,
14:33:51 367  	in_redemption_date	      IN GIFT_CERTIFICATE.REDEMPTION_DATE%TYPE DEFAULT NULL,
14:33:51 368  	in_cancelation_date	      IN GIFT_CERTIFICATE.CANCELATION_DATE%TYPE DEFAULT NULL,
14:33:51 369  	in_redeemer_group_id	      IN GIFT_CERTIFICATE.REDEEMER_GROUP_ID%TYPE DEFAULT NULL,
14:33:51 370  	in_recipient_address_id       IN GIFT_CERTIFICATE.RECIPIENT_ADDRESS_ID%TYPE DEFAULT NULL,
14:33:51 371  	in_redeemer_address_id	      IN GIFT_CERTIFICATE.REDEEMER_ADDRESS_ID%TYPE DEFAULT NULL,
14:33:51 372  	in_recipient_notify_date      IN GIFT_CERTIFICATE.RECIPIENT_NOTIFY_DATE%TYPE DEFAULT NULL
14:33:51 373  ) AS
14:33:51 374  BEGIN
14:33:51 375  
14:33:51 376  	-- Create history
14:33:51 377  	PROCS_HISTORY_V22.CREATE_GIFT_CERT_HISTORY(
14:33:51 378  	  in_gift_certificate_id       => in_gift_certificate_id,
14:33:51 379  	  in_system_activity_reason_id => GLOBAL_ENUMS_V22.SAC_SYSTEM_APPLIED_RULE
14:33:51 380  	);
14:33:51 381  
14:33:51 382  	UPDATE GIFT_CERTIFICATE SET
14:33:51 383  	  EXPIRATION_DATE	     = NVL(in_expiration_date, EXPIRATION_DATE),
14:33:51 384  	  GIFT_CERTIFICATE_STATUS_ID = NVL(in_gift_certificate_status_id, GIFT_CERTIFICATE_STATUS_ID),
14:33:51 385  	  CODE			     = NVL(in_code, CODE),
14:33:51 386  	  UPDATE_DATE		     = SYSDATE,
14:33:51 387  	  UPDATED_BY		     = in_updated_by,
14:33:51 388  	  RECIPIENT_NAME	     = NVL(in_recipient_name, RECIPIENT_NAME),
14:33:51 389  	  GIFT_MESSAGE		     = NVL(in_gift_message, GIFT_MESSAGE),
14:33:51 390  	  RECIPIENT_EMAIL	     = NVL(in_recipient_email, RECIPIENT_EMAIL),
14:33:51 391  	  FINALIZED_INVOICE_ID	     = NVL(in_finalized_invoice_id, FINALIZED_INVOICE_ID),
14:33:51 392  	  SENDER_EMAIL		     = NVL(in_sender_email, SENDER_EMAIL),
14:33:51 393  	  SENDER_NAME		     = NVL(in_sender_name, SENDER_NAME),
14:33:51 394  	  REDEMPTION_DATE	     = NVL(in_redemption_date, REDEMPTION_DATE),
14:33:51 395  	  CANCELATION_DATE	     = NVL(in_cancelation_date, CANCELATION_DATE),
14:33:51 396  	  REDEEMER_GROUP_ID	     = NVL(in_redeemer_group_id, REDEEMER_GROUP_ID),
14:33:51 397  	  RECIPIENT_ADDRESS_ID	     = NVL(in_recipient_address_id, RECIPIENT_ADDRESS_ID),
14:33:51 398  	  REDEEMER_ADDRESS_ID	     = NVL(in_redeemer_address_id, REDEEMER_ADDRESS_ID),
14:33:51 399  	  RECIPIENT_NOTIFY_DATE      = NVL(in_recipient_notify_date, RECIPIENT_NOTIFY_DATE)
14:33:51 400  	WHERE
14:33:51 401  	  ID = in_gift_certificate_id;
14:33:51 402  
14:33:51 403  END UPDATE_GIFT_CERTIFICATE;
14:33:51 404  
14:33:51 405  END PROCS_FIN_INSTRUMENTS_CRU_V22;
14:33:51 406  .
14:33:51 SQL> /

Package body created.

Elapsed: 00:00:00.07
14:33:51 SQL> 
14:33:51 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_GROUP_ACCOUNT_CRU_V22" AS
14:33:51   2  
14:33:51   3  PROCEDURE UPDATE_SUBSCRIPTION_SHARE (
14:33:51   4  	in_id		       IN SUBSCRIPTION_SHARE.ID%TYPE,
14:33:51   5  	in_group_account_id    IN SUBSCRIPTION_SHARE.GROUP_ACCOUNT_ID%TYPE DEFAULT NULL,
14:33:51   6  	in_borrower_account_id IN SUBSCRIPTION_SHARE.BORROWER_ACCOUNT_ID%TYPE DEFAULT NULL,
14:33:51   7  	in_ip_address	       IN SUBSCRIPTION_SHARE.IP_ADDRESS%TYPE DEFAULT NULL,
14:33:51   8  	in_start_date	       IN SUBSCRIPTION_SHARE.START_DATE%TYPE DEFAULT NULL,
14:33:51   9  	in_end_date	       IN SUBSCRIPTION_SHARE.END_DATE%TYPE DEFAULT NULL,
14:33:51  10  	in_needs_entitlements  IN SUBSCRIPTION_SHARE.NEEDS_ENTITLEMENTS%TYPE DEFAULT NULL,
14:33:51  11  	in_updated_by	       IN SUBSCRIPTION_SHARE.UPDATED_BY%TYPE
14:33:51  12  ) AS
14:33:51  13  SPROC_NAME CONSTANT VARCHAR2(32) := 'UPDATE_SUBSCRIPTION_SHARE';
14:33:51  14  BEGIN
14:33:51  15  	UPDATE SUBSCRIPTION_SHARE SET
14:33:51  16  	  GROUP_ACCOUNT_ID     = NVL(in_group_account_id,GROUP_ACCOUNT_ID),
14:33:51  17  	  BORROWER_ACCOUNT_ID  = NVL(in_borrower_account_id,BORROWER_ACCOUNT_ID),
14:33:51  18  	  IP_ADDRESS	       = NVL(in_ip_address,IP_ADDRESS),
14:33:51  19  	  START_DATE	       = NVL(in_start_date,START_DATE),
14:33:51  20  	  END_DATE	       = NVL(in_end_date,END_DATE),
14:33:51  21  	  NEEDS_ENTITLEMENTS   = NVL(in_needs_entitlements,NEEDS_ENTITLEMENTS),
14:33:51  22  	  UPDATED_BY	       = in_updated_by,
14:33:51  23  	  UPDATE_DATE	       = SYSDATE
14:33:51  24  	WHERE
14:33:51  25  	  SUBSCRIPTION_SHARE.ID = in_id;
14:33:51  26  EXCEPTION
14:33:51  27  	WHEN OTHERS THEN
14:33:51  28  	  Procs_Common_V22.Throw_Exception(APP_EXCEPTION_CODES_V22.Internal_Error,
14:33:51  29  	    SPROC_NAME, 'Error while updating subscription share', SQLERRM);
14:33:51  30  END UPDATE_SUBSCRIPTION_SHARE;
14:33:51  31  
14:33:51  32  PROCEDURE CREATE_GROUP_ACCOUNT (
14:33:51  33  	in_subscription_id	 IN NUMBER,
14:33:51  34  	in_group_name		 IN VARCHAR2,
14:33:51  35  	in_first_name		 IN VARCHAR2,
14:33:51  36  	in_last_name		 IN VARCHAR2,
14:33:51  37  	in_email		 IN VARCHAR2,
14:33:51  38  	in_phone		 IN VARCHAR2,
14:33:51  39  	in_organization_type	 IN VARCHAR2,
14:33:51  40  	in_seats		 IN NUMBER,
14:33:51  41  	in_seat_ttl_in_hours	 IN NUMBER,
14:33:51  42  	in_ip			 IN NUMBER,
14:33:51  43  	in_created_by		 IN VARCHAR2
14:33:51  44  ) AS
14:33:51  45  SPROC_NAME CONSTANT VARCHAR2(32) := 'CREATE_GROUP_ACCOUNT';
14:33:51  46  var_now DATE;
14:33:51  47  BEGIN
14:33:51  48  
14:33:51  49  	SELECT
14:33:51  50  	  SYSDATE INTO var_now
14:33:51  51  	FROM dual;
14:33:51  52  
14:33:51  53  	INSERT INTO GROUP_ACCOUNT (
14:33:51  54  	  id,
14:33:51  55  	  subscription_id,
14:33:51  56  	  group_name,
14:33:51  57  	  first_name,
14:33:51  58  	  last_name,
14:33:51  59  	  email,
14:33:51  60  	  phone,
14:33:51  61  	  organization_type,
14:33:51  62  	  seats,
14:33:51  63  	  seat_ttl_in_hours,
14:33:51  64  	  ip,
14:33:51  65  	  create_date,
14:33:51  66  	  created_by,
14:33:51  67  	  update_date,
14:33:51  68  	  updated_by
14:33:51  69  	) VALUES (
14:33:51  70  	  core_owner.GRPACCNT_ID_SEQ.NEXTVAL,
14:33:51  71  	  in_subscription_id,
14:33:51  72  	  in_group_name,
14:33:51  73  	  in_first_name,
14:33:51  74  	  in_last_name,
14:33:51  75  	  in_email,
14:33:51  76  	  in_phone,
14:33:51  77  	  in_organization_type,
14:33:51  78  	  in_seats,
14:33:51  79  	  in_seat_ttl_in_hours,
14:33:51  80  	  in_ip,
14:33:51  81  	  var_now,
14:33:51  82  	  in_created_by,
14:33:51  83  	  var_now,
14:33:51  84  	  in_created_by
14:33:51  85  	);
14:33:51  86  
14:33:51  87  EXCEPTION
14:33:51  88  	WHEN PROGRAM_ERROR THEN
14:33:51  89  	  PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:51  90  	    SPROC_NAME, 'Program error when inserting group account', SQLERRM);
14:33:51  91  	WHEN OTHERS THEN
14:33:51  92  	  PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:51  93  	    SPROC_NAME, 'Unknown error when inserting group account', SQLERRM);
14:33:51  94  END CREATE_GROUP_ACCOUNT;
14:33:51  95  
14:33:51  96  
14:33:51  97  PROCEDURE CREATE_SUBSCRIPTION_SHARE (
14:33:51  98  	in_group_account_id    IN NUMBER,
14:33:51  99  	in_borrower_account_id IN NUMBER,
14:33:51 100  	in_ip_address	       IN VARCHAR2,
14:33:51 101  	in_email_domain        IN VARCHAR2,
14:33:51 102  	in_start_date	       IN DATE,
14:33:51 103  	in_end_date	       IN DATE,
14:33:51 104  	in_created_by	       IN VARCHAR2
14:33:51 105  ) AS
14:33:51 106  SPROC_NAME CONSTANT VARCHAR2(32) := 'CREATE_SUBSCRIPTION_SHARE';
14:33:51 107  var_now DATE;
14:33:51 108  BEGIN
14:33:51 109  
14:33:51 110  	SELECT
14:33:51 111  	  SYSDATE INTO var_now
14:33:51 112  	FROM dual;
14:33:51 113  
14:33:51 114  	INSERT INTO SUBSCRIPTION_SHARE (
14:33:51 115  	  id,
14:33:51 116  	  group_account_id,
14:33:51 117  	  borrower_account_id,
14:33:51 118  	  ip_address,
14:33:51 119  	  email_domain,
14:33:51 120  	  start_date,
14:33:51 121  	  end_date,
14:33:51 122  	  create_date,
14:33:51 123  	  created_by,
14:33:51 124  	  update_date,
14:33:51 125  	  updated_by
14:33:51 126  	) VALUES (
14:33:51 127  	  core_owner.SUBSCRIPTIONSHARE_ID_SEQ.NEXTVAL,
14:33:51 128  	  in_group_account_id,
14:33:51 129  	  in_borrower_account_id,
14:33:51 130  	  in_ip_address,
14:33:51 131  	  in_email_domain,
14:33:51 132  	  in_start_date,
14:33:51 133  	  in_end_date,
14:33:51 134  	  var_now,
14:33:51 135  	  in_created_by,
14:33:51 136  	  var_now,
14:33:51 137  	  in_created_by
14:33:51 138  	);
14:33:51 139  
14:33:51 140  EXCEPTION
14:33:51 141  	WHEN PROGRAM_ERROR THEN
14:33:51 142  	  PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:51 143  	    SPROC_NAME, 'Program error when inserting subscription share', SQLERRM);
14:33:51 144  END CREATE_SUBSCRIPTION_SHARE;
14:33:51 145  
14:33:51 146  -- Eh, I don't like the cru packages at all
14:33:51 147  -- the idea of code reuse in PL/SQL is still lost on me
14:33:51 148  PROCEDURE DISABLE_IP_RANGES_BY_GA_ID(
14:33:51 149  	in_group_account_id IN GROUP_ACCOUNT_IP_RANGE.GROUP_ACCOUNT_ID%TYPE,
14:33:51 150  	in_updated_by IN GROUP_ACCOUNT_IP_RANGE.UPDATED_BY%TYPE
14:33:51 151  ) AS
14:33:51 152  SPROC_NAME CONSTANT VARCHAR2(32) := 'DISABLE_IP_RANGES_BY_GA_ID';
14:33:51 153  BEGIN
14:33:51 154  	update
14:33:51 155  	  GROUP_ACCOUNT_IP_RANGE IR
14:33:51 156  	set
14:33:51 157  	  IR.GROUP_ACC_IP_RNG_STATUS_ID = GLOBAL_STATUSES_V22.GROUP_ACC_IP_RNG_INACTIVE,
14:33:51 158  	  IR.UPDATED_BY = in_updated_by,
14:33:51 159  	  IR.UPDATE_DATE = sysdate
14:33:51 160  	where
14:33:51 161  	  IR.GROUP_ACCOUNT_ID = in_group_account_id and
14:33:51 162  	  IR.GROUP_ACC_IP_RNG_STATUS_ID = GLOBAL_STATUSES_V22.GROUP_ACC_IP_RNG_ACTIVE
14:33:51 163  	;
14:33:51 164  EXCEPTION
14:33:51 165  WHEN OTHERS THEN
14:33:51 166  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:51 167  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:51 168  END DISABLE_IP_RANGES_BY_GA_ID;
14:33:51 169  
14:33:51 170  PROCEDURE DISABLE_IP_RANGE_BY_ID(
14:33:51 171  	in_id	IN GROUP_ACCOUNT_IP_RANGE.ID%TYPE,
14:33:51 172  	in_updated_by IN GROUP_ACCOUNT_IP_RANGE.UPDATED_BY%TYPE
14:33:51 173  ) AS
14:33:51 174  SPROC_NAME CONSTANT VARCHAR2(32) := 'DISABLE_IP_RANGE_BY_ID';
14:33:51 175  BEGIN
14:33:51 176  	update
14:33:51 177  	  GROUP_ACCOUNT_IP_RANGE IR
14:33:51 178  	set
14:33:51 179  	  IR.GROUP_ACC_IP_RNG_STATUS_ID = GLOBAL_STATUSES_V22.GROUP_ACC_IP_RNG_INACTIVE,
14:33:51 180  	  IR.UPDATED_BY = in_updated_by,
14:33:51 181  	  IR.UPDATE_DATE = sysdate
14:33:51 182  	where
14:33:51 183  	  IR.ID = in_id and
14:33:51 184  	  IR.GROUP_ACC_IP_RNG_STATUS_ID = GLOBAL_STATUSES_V22.GROUP_ACC_IP_RNG_ACTIVE
14:33:51 185  	;
14:33:51 186  	if sql%rowcount = 0 then
14:33:51 187  	  raise NO_DATA_FOUND ;
14:33:51 188  	end if;
14:33:51 189  EXCEPTION
14:33:51 190  WHEN NO_DATA_FOUND THEN
14:33:51 191  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:51 192  	  SPROC_NAME, 'Missing or invalid group_account_ip_range_id '||in_id, SQLERRM);
14:33:51 193  WHEN OTHERS THEN
14:33:51 194  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:51 195  	  SPROC_NAME, 'Unknown error '||in_id, SQLERRM);
14:33:51 196  END DISABLE_IP_RANGE_BY_ID;
14:33:51 197  
14:33:51 198  PROCEDURE ADD_IP_RANGE (
14:33:51 199  	in_group_account_id IN GROUP_ACCOUNT_IP_RANGE.GROUP_ACCOUNT_ID%TYPE,
14:33:51 200  	in_minimum_ip_string IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_STRING%TYPE,
14:33:51 201  	in_minimum_ip_low IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_LOW%TYPE,
14:33:51 202  	in_minimum_ip_high IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_HIGH%TYPE,
14:33:51 203  	in_maximum_ip_string IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_STRING%TYPE,
14:33:51 204  	in_maximum_ip_low IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_LOW%TYPE,
14:33:51 205  	in_maximum_ip_high IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_HIGH%TYPE,
14:33:51 206  	in_created_by IN GROUP_ACCOUNT_IP_RANGE.CREATED_BY%TYPE
14:33:51 207  ) AS
14:33:51 208  SPROC_NAME CONSTANT VARCHAR2(32) := 'ADD_IP_RANGE';
14:33:51 209  BEGIN
14:33:51 210  	  INSERT INTO GROUP_ACCOUNT_IP_RANGE (
14:33:51 211  	    ID,
14:33:51 212  	    GROUP_ACCOUNT_ID,
14:33:51 213  	    MINIMUM_IP_STRING,
14:33:51 214  	    MINIMUM_IP_LOW,
14:33:51 215  	    MINIMUM_IP_HIGH,
14:33:51 216  	    MAXIMUM_IP_STRING,
14:33:51 217  	    MAXIMUM_IP_LOW,
14:33:51 218  	    MAXIMUM_IP_HIGH,
14:33:51 219  	    CREATED_BY,
14:33:51 220  	    CREATE_DATE,
14:33:51 221  	    UPDATED_BY,
14:33:51 222  	    UPDATE_DATE,
14:33:51 223  	    GROUP_ACC_IP_RNG_STATUS_ID
14:33:51 224  	  )
14:33:51 225  	  VALUES (
14:33:51 226  	    GROUPACCOUNTIPRANGE_ID_SEQ.nextval,
14:33:51 227  	    in_group_account_id,
14:33:51 228  	    in_minimum_ip_string,
14:33:51 229  	    in_minimum_ip_low,
14:33:51 230  	    in_minimum_ip_high,
14:33:51 231  	    in_maximum_ip_string,
14:33:51 232  	    in_maximum_ip_low,
14:33:51 233  	    in_maximum_ip_high,
14:33:51 234  	    in_created_by,
14:33:51 235  	    sysdate,
14:33:51 236  	    in_created_by,
14:33:51 237  	    sysdate,
14:33:51 238  	    GLOBAL_STATUSES_V22.GROUP_ACC_IP_RNG_ACTIVE
14:33:51 239  	  );
14:33:51 240  EXCEPTION
14:33:51 241  WHEN OTHERS THEN
14:33:51 242  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:51 243  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:51 244  END ADD_IP_RANGE;
14:33:51 245  
14:33:51 246  PROCEDURE DISABLE_EMAIL_DOMAIN_BY_GA_ID(
14:33:51 247  	in_group_account_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
14:33:51 248  	in_updated_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.UPDATED_BY%TYPE
14:33:51 249  ) AS
14:33:51 250  SPROC_NAME CONSTANT VARCHAR2(32) := 'DISABLE_EMAIL_DOMAIN_BY_GA_ID';
14:33:51 251  BEGIN
14:33:51 252  	update
14:33:51 253  	  GROUP_ACCOUNT_EMAIL_DOMAIN ED
14:33:51 254  	set
14:33:51 255  	  ED.IS_ACTIVE = GLOBAL_STATUSES_V22.GROUP_ACC_EMAIL_DOMAIN_INACT,
14:33:51 256  	  ED.UPDATED_BY = in_updated_by,
14:33:51 257  	  ED.UPDATE_DATE = sysdate
14:33:51 258  	where
14:33:51 259  	  ED.GROUP_ACCOUNT_ID = in_group_account_id and
14:33:51 260  	  ED.IS_ACTIVE = GLOBAL_STATUSES_V22.GROUP_ACC_EMAIL_DOMAIN_ACT
14:33:51 261  	;
14:33:51 262  EXCEPTION
14:33:51 263  WHEN OTHERS THEN
14:33:51 264  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:51 265  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:51 266  END DISABLE_EMAIL_DOMAIN_BY_GA_ID;
14:33:51 267  
14:33:51 268  PROCEDURE DISABLE_EMAIL_DOMAIN_BY_ID(
14:33:51 269  	in_id	IN GROUP_ACCOUNT_EMAIL_DOMAIN.ID%TYPE,
14:33:51 270  	in_updated_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.UPDATED_BY%TYPE
14:33:51 271  ) AS
14:33:51 272  SPROC_NAME CONSTANT VARCHAR2(32) := 'DISABLE_EMAIL_DOMAIN_BY_ID';
14:33:51 273  BEGIN
14:33:51 274  	update
14:33:51 275  	  GROUP_ACCOUNT_EMAIL_DOMAIN ED
14:33:51 276  	set
14:33:51 277  	  ED.IS_ACTIVE = GLOBAL_STATUSES_V22.GROUP_ACC_EMAIL_DOMAIN_INACT,
14:33:51 278  	  ED.UPDATED_BY = in_updated_by,
14:33:51 279  	  ED.UPDATE_DATE = sysdate
14:33:51 280  	where
14:33:51 281  	  ED.ID = in_id and
14:33:51 282  	  ED.IS_ACTIVE = GLOBAL_STATUSES_V22.GROUP_ACC_EMAIL_DOMAIN_ACT
14:33:51 283  	;
14:33:51 284  EXCEPTION
14:33:51 285  WHEN OTHERS THEN
14:33:51 286  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:51 287  	  SPROC_NAME, 'Unknown error '||in_id, SQLERRM);
14:33:51 288  END DISABLE_EMAIL_DOMAIN_BY_ID;
14:33:51 289  
14:33:51 290  
14:33:51 291  PROCEDURE ENABLE_EMAIL_DOMAIN_BY_ID(
14:33:51 292  	in_id	IN GROUP_ACCOUNT_EMAIL_DOMAIN.ID%TYPE,
14:33:51 293  	in_updated_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.UPDATED_BY%TYPE
14:33:51 294  ) AS
14:33:51 295  SPROC_NAME CONSTANT VARCHAR2(32) := 'ENABLE_EMAIL_DOMAIN_BY_ID';
14:33:51 296  BEGIN
14:33:51 297  	update
14:33:51 298  	  GROUP_ACCOUNT_EMAIL_DOMAIN ED
14:33:51 299  	set
14:33:51 300  	  ED.IS_ACTIVE = GLOBAL_STATUSES_V22.GROUP_ACC_EMAIL_DOMAIN_ACT,
14:33:51 301  	  ED.UPDATED_BY = in_updated_by,
14:33:51 302  	  ED.UPDATE_DATE = sysdate
14:33:51 303  	where
14:33:51 304  	  ED.ID = in_id and
14:33:51 305  	  ED.IS_ACTIVE = GLOBAL_STATUSES_V22.GROUP_ACC_EMAIL_DOMAIN_INACT
14:33:51 306  	;
14:33:51 307  EXCEPTION
14:33:51 308  WHEN DUP_VAL_ON_INDEX THEN
14:33:51 309  	PROCS_COMMON_V19.THROW_EXCEPTION(APP_EXCEPTION_CODES_V19.DUPLICATE_ERROR,
14:33:51 310  		SPROC_NAME, 'Unique Constraint Violated', SQLERRM);
14:33:51 311  WHEN OTHERS THEN
14:33:51 312  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:51 313  	  SPROC_NAME, 'Unknown error '||in_id, SQLERRM);
14:33:51 314  END ENABLE_EMAIL_DOMAIN_BY_ID;
14:33:51 315  
14:33:51 316  
14:33:51 317  PROCEDURE ADD_EMAIL_DOMAIN (
14:33:51 318  	in_group_account_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
14:33:51 319  	in_email_domain IN GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE,
14:33:51 320  	in_is_active IN  GROUP_ACCOUNT_EMAIL_DOMAIN.IS_ACTIVE%TYPE,
14:33:51 321  	in_created_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.CREATED_BY%TYPE
14:33:51 322  ) AS
14:33:51 323  SPROC_NAME CONSTANT VARCHAR2(32) := 'ADD_EMAIL_DOMAIN';
14:33:51 324  BEGIN
14:33:51 325  	  INSERT INTO GROUP_ACCOUNT_EMAIL_DOMAIN (
14:33:51 326  	    ID,
14:33:51 327  	    GROUP_ACCOUNT_ID,
14:33:51 328  	    EMAIL_DOMAIN,
14:33:51 329  		IS_ACTIVE,
14:33:51 330  	    CREATED_BY,
14:33:51 331  	    CREATE_DATE,
14:33:51 332  	    UPDATED_BY,
14:33:51 333  	    UPDATE_DATE
14:33:51 334  	  )
14:33:51 335  	  VALUES (
14:33:51 336  	    GROUPACCOUNTEMAILDOMAIN_SEQ.nextval,
14:33:51 337  	    in_group_account_id,
14:33:51 338  		in_email_domain,
14:33:51 339  		in_is_active,
14:33:51 340  		in_created_by,
14:33:51 341  	    sysdate,
14:33:51 342  	    in_created_by,
14:33:51 343  	    sysdate
14:33:51 344  	  );
14:33:51 345  EXCEPTION
14:33:51 346  WHEN DUP_VAL_ON_INDEX THEN
14:33:51 347  <<<<<<< HEAD
14:33:51 348  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:51 349  =======
14:33:51 350  	PROCS_COMMON_V19.THROW_EXCEPTION(APP_EXCEPTION_CODES_V19.DUPLICATE_ERROR,
14:33:51 351  >>>>>>> feature/unique_group_email
14:33:51 352  	  SPROC_NAME, 'Unique Constraint Violated', SQLERRM);
14:33:51 353  WHEN OTHERS THEN
14:33:51 354  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:51 355  	  SPROC_NAME, 'Unknown error 1', SQLERRM);
14:33:51 356  END ADD_EMAIL_DOMAIN;
14:33:51 357  
14:33:51 358  PROCEDURE UPDATE_GROUP_ACCOUNT (
14:33:51 359  	in_group_account_id	 IN GROUP_ACCOUNT.ID%TYPE,
14:33:51 360  	in_group_name		 IN GROUP_ACCOUNT.GROUP_NAME%TYPE,
14:33:51 361  	in_first_name		 IN GROUP_ACCOUNT.FIRST_NAME%TYPE,
14:33:51 362  	in_last_name		 IN GROUP_ACCOUNT.LAST_NAME%TYPE,
14:33:51 363  	in_email		 IN GROUP_ACCOUNT.EMAIL%TYPE,
14:33:51 364  	in_phone		 IN GROUP_ACCOUNT.PHONE%TYPE,
14:33:51 365  	in_updated_by		 IN GROUP_ACCOUNT.UPDATED_BY%TYPE
14:33:51 366  ) AS
14:33:51 367  SPROC_NAME CONSTANT VARCHAR2(32) := 'UPDATE_GROUP_ACCOUNT';
14:33:51 368  BEGIN
14:33:51 369  	update
14:33:51 370  	  group_account
14:33:51 371  	set
14:33:51 372  	  group_name = nvl(in_group_name, group_name),
14:33:51 373  	  first_name = nvl(in_first_name, first_name),
14:33:51 374  	  last_name = nvl(in_last_name, last_name),
14:33:51 375  	  email = nvl(in_email, email),
14:33:51 376  	  phone = nvl(in_phone, phone),
14:33:51 377  	  updated_by = in_updated_by,
14:33:51 378  	  update_date = sysdate
14:33:51 379  	where
14:33:51 380  	  id = in_group_account_id;
14:33:51 381  
14:33:51 382  	if(sql%rowcount = 0) then
14:33:51 383  	  PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:51 384  	  SPROC_NAME, 'Group Account not found', SQLERRM);
14:33:51 385  	end if;
14:33:51 386  EXCEPTION
14:33:51 387  	WHEN OTHERS THEN
14:33:51 388  	  PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:51 389  	    SPROC_NAME, 'Error while updating group account', SQLERRM);
14:33:51 390  END UPDATE_GROUP_ACCOUNT;
14:33:51 391  
14:33:51 392  PROCEDURE UPDATE_GROUP_ACCOUNT_SEATS (
14:33:51 393  	in_group_account_id	 IN GROUP_ACCOUNT.ID%TYPE,
14:33:51 394  	in_seats		 IN GROUP_ACCOUNT.SEATS%TYPE,
14:33:51 395  	in_updated_by		 IN GROUP_ACCOUNT.UPDATED_BY%TYPE
14:33:51 396  ) AS
14:33:51 397  SPROC_NAME CONSTANT VARCHAR2(32) := 'UPDATE_GROUP_ACCOUNT_SEATS';
14:33:51 398  var_subscription_id NUMBER;
14:33:51 399  var_seats NUMBER;
14:33:51 400  BEGIN
14:33:51 401  	select subscription_id, seats into var_subscription_id, var_seats
14:33:51 402  	from group_account
14:33:51 403  	where id = in_group_account_id;
14:33:51 404  
14:33:51 405  	update
14:33:51 406  	  group_account
14:33:51 407  	set
14:33:51 408  	  seats = in_seats,
14:33:51 409  	  updated_by = in_updated_by,
14:33:51 410  	  update_date = sysdate
14:33:51 411  	where
14:33:51 412  	  id = in_group_account_id;
14:33:51 413  
14:33:51 414  	if(sql%rowcount = 0) then
14:33:51 415  	  PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:51 416  	  SPROC_NAME, 'Group Account not found', SQLERRM);
14:33:51 417  	end if;
14:33:51 418  
14:33:51 419  	PROCS_SUBSCRIPTION_V22.ANNOTATE_SUBSCRIPTION(
14:33:51 420  	  in_subscription_id => var_subscription_id,
14:33:51 421  	  in_agent_id	     => 0,
14:33:51 422  	  in_note	     => 'seats updated from '||var_seats||' to '||in_seats,
14:33:51 423  	  in_created_by      => in_updated_by
14:33:51 424  	);
14:33:51 425  EXCEPTION
14:33:51 426  	WHEN NO_DATA_FOUND THEN
14:33:51 427  	  PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:51 428  	  SPROC_NAME, 'Group Account not found', SQLERRM);
14:33:51 429  	WHEN OTHERS THEN
14:33:51 430  	  PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:51 431  	    SPROC_NAME, 'Error while updating group account seats', SQLERRM);
14:33:51 432  END UPDATE_GROUP_ACCOUNT_SEATS;
14:33:51 433  
14:33:51 434  END PROCS_GROUP_ACCOUNT_CRU_V22;
14:33:51 435  .
14:33:51 SQL> /

Warning: Package Body created with compilation errors.

Elapsed: 00:00:00.10
14:33:51 SQL> 
14:33:51 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_INVOICE_CRU_V22" AS
14:33:51   2  
14:33:51   3  PROCEDURE CREATE_INVOICE (
14:33:51   4  	out_invoice_id		       OUT INVOICE.ID%TYPE,
14:33:51   5  	in_invoice_id		       IN INVOICE.ID%TYPE DEFAULT NULL,
14:33:51   6  	in_invoice_status_id	       IN INVOICE.INVOICE_STATUS_ID%TYPE,
14:33:51   7  	in_tax_exempt_id	       IN INVOICE.TAX_EXEMPT_ID%TYPE,
14:33:51   8  	in_created_by		       IN INVOICE.CREATED_BY%TYPE
14:33:51   9  ) AS
14:33:51  10  -- VARIABLES
14:33:51  11  var_invoice_id INVOICE.ID%TYPE;
14:33:51  12  -- arosolovskiy: using data variable instead of direct get data calls (#38860)
14:33:51  13  var_date DATE := SYSDATE;
14:33:51  14  BEGIN
14:33:51  15  	IF in_invoice_id IS NULL THEN
14:33:51  16  	  SELECT
14:33:51  17  	    INV_ID_SEQ.nextVal into var_invoice_id
14:33:51  18  	  FROM DUAL;
14:33:51  19  	ELSE
14:33:51  20  	  var_invoice_id := in_invoice_id;
14:33:51  21  	END IF;
14:33:51  22  	INSERT INTO
14:33:51  23  	  INVOICE (
14:33:51  24  	    ID,
14:33:51  25  	    INVOICE_STATUS_ID,
14:33:51  26  	    CREATE_DATE,
14:33:51  27  	    CREATED_BY,
14:33:51  28  	    UPDATE_DATE,
14:33:51  29  	    UPDATED_BY,
14:33:51  30  	    TAX_EXEMPT_ID,
14:33:51  31  	    IS_TAX_CALCULATION_NEEDED
14:33:51  32  	  ) VALUES (
14:33:51  33  	    var_invoice_id,
14:33:51  34  	    in_invoice_status_id,
14:33:51  35  	    var_date,
14:33:51  36  	    in_created_by,
14:33:51  37  	    var_date,
14:33:51  38  	    in_created_by,
14:33:51  39  	    in_tax_exempt_id,
14:33:51  40  	    0 -- DEFAULT VALUE
14:33:51  41  	  );
14:33:51  42  
14:33:51  43  	out_invoice_id := var_invoice_id;
14:33:51  44  END;
14:33:51  45  
14:33:51  46  /*****************************************************************/
14:33:51  47  
14:33:51  48  PROCEDURE UPDATE_INVOICE (
14:33:51  49  	in_invoice_id		       IN INVOICE.ID%TYPE,
14:33:51  50  	in_updated_by		       IN INVOICE.UPDATED_BY%TYPE,
14:33:51  51  	in_invoice_status_id	       IN INVOICE.INVOICE_STATUS_ID%TYPE DEFAULT NULL,
14:33:51  52  	in_is_tax_calculation_needed   IN INVOICE.IS_TAX_CALCULATION_NEEDED%TYPE DEFAULT NULL
14:33:51  53  ) AS
14:33:51  54  BEGIN
14:33:51  55  	-- Create history
14:33:51  56  	PROCS_HISTORY_V22.CREATE_INVOICE_HISTORY(
14:33:51  57  	  in_invoice_id 	       => in_invoice_id,
14:33:51  58  	  in_system_activity_reason_id => GLOBAL_ENUMS_V22.SAC_SYSTEM_APPLIED_RULE
14:33:51  59  	);
14:33:51  60  
14:33:51  61  	UPDATE
14:33:51  62  	  INVOICE
14:33:51  63  	SET
14:33:51  64  	  INVOICE_STATUS_ID	    = NVL(in_invoice_status_id, INVOICE_STATUS_ID),
14:33:51  65  	  UPDATE_DATE		    = SYSDATE,
14:33:51  66  	  UPDATED_BY		    = in_updated_by,
14:33:51  67  	  IS_TAX_CALCULATION_NEEDED = NVL(in_is_tax_calculation_needed, IS_TAX_CALCULATION_NEEDED)
14:33:51  68  	WHERE
14:33:51  69  	  ID = in_invoice_id;
14:33:51  70  END;
14:33:51  71  
14:33:51  72  END PROCS_INVOICE_CRU_V22;
14:33:51  73  .
14:33:51 SQL> /

Package body created.

Elapsed: 00:00:00.03
14:33:51 SQL> 
14:33:51 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_ITUNES_RECEIPT_CRU_V22" AS
14:33:51   2  
14:33:51   3  PROCEDURE CREATE_RECEIPT(
14:33:51   4  /*
14:33:51   5  Throws exceptions:
14:33:51   6  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51   7  */
14:33:51   8  	  out_id	      OUT NUMBER,
14:33:51   9  	  in_subscription_id  IN CORE_OWNER.ITUNES_RECEIPT.SUBSCRIPTION_ID%TYPE,
14:33:51  10  	  in_receipt	      IN CORE_OWNER.ITUNES_RECEIPT.RECEIPT%TYPE,
14:33:51  11  	  in_status	      IN CORE_OWNER.ITUNES_RECEIPT.STATUS%TYPE,
14:33:51  12  	  in_quantity	      IN CORE_OWNER.ITUNES_RECEIPT.QUANTITY%TYPE,
14:33:51  13  	  in_product_id       IN CORE_OWNER.ITUNES_RECEIPT.PRODUCT_ID%TYPE,
14:33:51  14  	  in_transaction_id   IN CORE_OWNER.ITUNES_RECEIPT.TRANSACTION_ID%TYPE,
14:33:51  15  	  in_purchase_date    IN CORE_OWNER.ITUNES_RECEIPT.PURCHASE_DATE%TYPE,
14:33:51  16  	  in_original_transaction_id IN CORE_OWNER.ITUNES_RECEIPT.ORIGINAL_TRANSACTION_ID%TYPE,
14:33:51  17  	  in_original_purchase_date IN CORE_OWNER.ITUNES_RECEIPT.ORIGINAL_PURCHASE_DATE%TYPE,
14:33:51  18  	  in_app_item_id      IN CORE_OWNER.ITUNES_RECEIPT.APP_ITEM_ID%TYPE,
14:33:51  19  	  in_version_external_id IN CORE_OWNER.ITUNES_RECEIPT.VERSION_EXTERNAL_ID%TYPE,
14:33:51  20  	  in_bid	      IN CORE_OWNER.ITUNES_RECEIPT.BID%TYPE,
14:33:51  21  	  in_bvrs	      IN CORE_OWNER.ITUNES_RECEIPT.BVRS%TYPE,
14:33:51  22  	  in_expires_date     IN CORE_OWNER.ITUNES_RECEIPT.EXPIRES_DATE%TYPE,
14:33:51  23  	  in_created_by       IN CORE_OWNER.ITUNES_RECEIPT.CREATED_BY%TYPE
14:33:51  24  ) AS
14:33:51  25  -- VARIABLES
14:33:51  26  SPROC_NAME	CONSTANT VARCHAR2(32) := 'CREATE_RECEIPT';
14:33:51  27  var_current_date	    DATE;
14:33:51  28  var_count 	    NUMBER;
14:33:51  29  ITUNES_ORG_TNX_USED   EXCEPTION;
14:33:51  30  BEGIN
14:33:51  31  	SELECT COUNT(1) into var_count
14:33:51  32  	FROM
14:33:51  33  	  ITUNES_RECEIPT IR, SUBSCRIPTION S
14:33:51  34  	WHERE
14:33:51  35  	  IR.ORIGINAL_TRANSACTION_ID = in_original_transaction_id AND
14:33:51  36  	  IR.SUBSCRIPTION_ID = S.ID AND
14:33:51  37  	  S.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE;
14:33:51  38  
14:33:51  39  	if var_count > 0 then
14:33:51  40  	  raise ITUNES_ORG_TNX_USED;
14:33:51  41  	end if;
14:33:51  42  
14:33:51  43  	SELECT
14:33:51  44  	  CORE_OWNER.ITUNES_RECEIPT_ID_SEQ.NEXTVAL
14:33:51  45  	INTO
14:33:51  46  	  out_id
14:33:51  47  	FROM
14:33:51  48  	  dual
14:33:51  49  	;
14:33:51  50  
14:33:51  51  	SELECT
14:33:51  52  	  sysdate
14:33:51  53  	INTO
14:33:51  54  	  var_current_date
14:33:51  55  	FROM
14:33:51  56  	  dual
14:33:51  57  	;
14:33:51  58  
14:33:51  59  	INSERT INTO CORE_OWNER.ITUNES_RECEIPT
14:33:51  60  	(
14:33:51  61  	  id,
14:33:51  62  	  subscription_id,
14:33:51  63  	  receipt,
14:33:51  64  	  status,
14:33:51  65  	  quantity,
14:33:51  66  	  product_id,
14:33:51  67  	  transaction_id,
14:33:51  68  	  purchase_date,
14:33:51  69  	  original_transaction_id,
14:33:51  70  	  original_purchase_date,
14:33:51  71  	  app_item_id,
14:33:51  72  	  version_external_id,
14:33:51  73  	  bid,
14:33:51  74  	  bvrs,
14:33:51  75  	  expires_date,
14:33:51  76  	  create_date,
14:33:51  77  	  created_by,
14:33:51  78  	  update_date,
14:33:51  79  	  updated_by,
14:33:51  80  	  last_check_date
14:33:51  81  	)
14:33:51  82  	VALUES
14:33:51  83  	(
14:33:51  84  	  out_id,
14:33:51  85  	  in_subscription_id,
14:33:51  86  	  in_receipt,
14:33:51  87  	  in_status,
14:33:51  88  	  in_quantity,
14:33:51  89  	  in_product_id,
14:33:51  90  	  in_transaction_id,
14:33:51  91  	  in_purchase_date,
14:33:51  92  	  in_original_transaction_id,
14:33:51  93  	  in_original_purchase_date,
14:33:51  94  	  in_app_item_id,
14:33:51  95  	  in_version_external_id,
14:33:51  96  	  in_bid,
14:33:51  97  	  in_bvrs,
14:33:51  98  	  in_expires_date,
14:33:51  99  	  var_current_date,
14:33:51 100  	  in_created_by,
14:33:51 101  	  var_current_date,
14:33:51 102  	  in_created_by,
14:33:51 103  	  var_current_date
14:33:51 104  	);
14:33:51 105  
14:33:51 106  EXCEPTION
14:33:51 107  WHEN ITUNES_ORG_TNX_USED THEN
14:33:51 108  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.DUPLICATE_ERROR,
14:33:51 109  	  SPROC_NAME, 'iTunes orginal transaction id already in use', SQLERRM);
14:33:51 110  WHEN DUP_VAL_ON_INDEX THEN
14:33:51 111  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.DUPLICATE_ERROR,
14:33:51 112  	  SPROC_NAME, 'Duplicate value', SQLERRM);
14:33:51 113  WHEN OTHERS THEN
14:33:51 114  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:51 115  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:51 116  END CREATE_RECEIPT;
14:33:51 117  
14:33:51 118  PROCEDURE UPDATE_RECEIPT(
14:33:51 119  /*
14:33:51 120  Throws exceptions:
14:33:51 121  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 122  */
14:33:51 123  	  in_id 	      IN CORE_OWNER.ITUNES_RECEIPT.ID%TYPE,
14:33:51 124  	  in_receipt	      IN CORE_OWNER.ITUNES_RECEIPT.RECEIPT%TYPE,
14:33:51 125  	  in_status	      IN CORE_OWNER.ITUNES_RECEIPT.STATUS%TYPE,
14:33:51 126  	  in_quantity	      IN CORE_OWNER.ITUNES_RECEIPT.QUANTITY%TYPE,
14:33:51 127  	  in_product_id       IN CORE_OWNER.ITUNES_RECEIPT.PRODUCT_ID%TYPE,
14:33:51 128  	  in_transaction_id   IN CORE_OWNER.ITUNES_RECEIPT.TRANSACTION_ID%TYPE,
14:33:51 129  	  in_purchase_date    IN CORE_OWNER.ITUNES_RECEIPT.PURCHASE_DATE%TYPE,
14:33:51 130  	  in_original_transaction_id IN CORE_OWNER.ITUNES_RECEIPT.ORIGINAL_TRANSACTION_ID%TYPE,
14:33:51 131  	  in_original_purchase_date IN CORE_OWNER.ITUNES_RECEIPT.ORIGINAL_PURCHASE_DATE%TYPE,
14:33:51 132  	  in_app_item_id      IN CORE_OWNER.ITUNES_RECEIPT.APP_ITEM_ID%TYPE,
14:33:51 133  	  in_version_external_id IN CORE_OWNER.ITUNES_RECEIPT.VERSION_EXTERNAL_ID%TYPE,
14:33:51 134  	  in_bid	      IN CORE_OWNER.ITUNES_RECEIPT.BID%TYPE,
14:33:51 135  	  in_bvrs	      IN CORE_OWNER.ITUNES_RECEIPT.BVRS%TYPE,
14:33:51 136  	  in_expires_date     IN CORE_OWNER.ITUNES_RECEIPT.EXPIRES_DATE%TYPE,
14:33:51 137  	  in_updated_by       IN CORE_OWNER.ITUNES_RECEIPT.UPDATED_BY%TYPE,
14:33:51 138  	  in_cancel_date      IN CORE_OWNER.ITUNES_RECEIPT.CANCEL_DATE%TYPE
14:33:51 139  ) AS
14:33:51 140  -- VARIABLES
14:33:51 141  SPROC_NAME	CONSTANT VARCHAR2(32) := 'UPDATE_RECEIPT';
14:33:51 142  var_current_date	    DATE;
14:33:51 143  BEGIN
14:33:51 144  
14:33:51 145  	SELECT
14:33:51 146  	  sysdate
14:33:51 147  	INTO
14:33:51 148  	  var_current_date
14:33:51 149  	FROM
14:33:51 150  	  dual
14:33:51 151  	;
14:33:51 152  
14:33:51 153  	FOR REC IN (SELECT * FROM CORE_OWNER.ITUNES_RECEIPT WHERE ID = in_id) LOOP
14:33:51 154  	  CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V22.CREATE_ITUNES_RECEIPT_HISTORY
14:33:51 155  	  (
14:33:51 156  	      rec.id,
14:33:51 157  	      rec.subscription_id,
14:33:51 158  	      rec.receipt,
14:33:51 159  	      rec.status,
14:33:51 160  	      rec.quantity,
14:33:51 161  	      rec.product_id,
14:33:51 162  	      rec.transaction_id,
14:33:51 163  	      rec.purchase_date,
14:33:51 164  	      rec.original_transaction_id,
14:33:51 165  	      rec.original_purchase_date,
14:33:51 166  	      rec.app_item_id,
14:33:51 167  	      rec.version_external_id,
14:33:51 168  	      rec.bid,
14:33:51 169  	      rec.bvrs,
14:33:51 170  	      rec.expires_date,
14:33:51 171  	      rec.create_date,
14:33:51 172  	      rec.created_by,
14:33:51 173  	      rec.update_date,
14:33:51 174  	      rec.updated_by,
14:33:51 175  	      rec.last_check_date,
14:33:51 176  	      rec.cancel_date
14:33:51 177  	  );
14:33:51 178  	END LOOP;
14:33:51 179  
14:33:51 180  	UPDATE CORE_OWNER.ITUNES_RECEIPT
14:33:51 181  	SET
14:33:51 182  	  receipt = in_receipt,
14:33:51 183  	  status = in_status,
14:33:51 184  	  quantity = in_quantity,
14:33:51 185  	  product_id = in_product_id,
14:33:51 186  	  transaction_id = in_transaction_id,
14:33:51 187  	  purchase_date = in_purchase_date,
14:33:51 188  	  original_transaction_id = in_original_transaction_id,
14:33:51 189  	  original_purchase_date = in_original_purchase_date,
14:33:51 190  	  app_item_id = in_app_item_id,
14:33:51 191  	  version_external_id = in_version_external_id,
14:33:51 192  	  bid = in_bid,
14:33:51 193  	  bvrs = in_bvrs,
14:33:51 194  	  expires_date = in_expires_date,
14:33:51 195  	  update_date = var_current_date,
14:33:51 196  	  updated_by = in_updated_by,
14:33:51 197  	  last_check_date = var_current_date,
14:33:51 198  	  cancel_date = in_cancel_date
14:33:51 199  	WHERE
14:33:51 200  	  id = in_id
14:33:51 201  	;
14:33:51 202  
14:33:51 203  EXCEPTION
14:33:51 204  WHEN DUP_VAL_ON_INDEX THEN
14:33:51 205  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.DUPLICATE_ERROR,
14:33:51 206  	  SPROC_NAME, 'Duplicate value', SQLERRM);
14:33:51 207  WHEN OTHERS THEN
14:33:51 208  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:51 209  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:51 210  
14:33:51 211  END UPDATE_RECEIPT;
14:33:51 212  
14:33:51 213  PROCEDURE LINK_ITUNES_RECEIPT(
14:33:51 214  /*
14:33:51 215  Throws exceptions:
14:33:51 216  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 217  */
14:33:51 218  	  in_id 	      IN CORE_OWNER.ITUNES_RECEIPT.ID%TYPE,
14:33:51 219  	  in_subscription_id  IN CORE_OWNER.ITUNES_RECEIPT.SUBSCRIPTION_ID%TYPE,
14:33:51 220  	  in_updated_by       IN CORE_OWNER.ITUNES_RECEIPT.UPDATED_BY%TYPE
14:33:51 221  ) AS
14:33:51 222  -- VARIABLES
14:33:51 223  SPROC_NAME	CONSTANT VARCHAR2(32) := 'LINK_ITUNES_RECEIPT';
14:33:51 224  var_current_date	    DATE;
14:33:51 225  BEGIN
14:33:51 226  
14:33:51 227  	      SELECT
14:33:51 228  	  sysdate
14:33:51 229  	      INTO
14:33:51 230  	  var_current_date
14:33:51 231  	      FROM
14:33:51 232  	  dual
14:33:51 233  	      ;
14:33:51 234  
14:33:51 235  	      FOR REC IN (SELECT * FROM CORE_OWNER.ITUNES_RECEIPT WHERE ID = in_id) LOOP
14:33:51 236  	      CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V22.CREATE_ITUNES_RECEIPT_HISTORY
14:33:51 237  	      (
14:33:51 238  	    rec.id,
14:33:51 239  	    rec.subscription_id,
14:33:51 240  	    rec.receipt,
14:33:51 241  	    rec.status,
14:33:51 242  	    rec.quantity,
14:33:51 243  	    rec.product_id,
14:33:51 244  	    rec.transaction_id,
14:33:51 245  	    rec.purchase_date,
14:33:51 246  	    rec.original_transaction_id,
14:33:51 247  	    rec.original_purchase_date,
14:33:51 248  	    rec.app_item_id,
14:33:51 249  	    rec.version_external_id,
14:33:51 250  	    rec.bid,
14:33:51 251  	    rec.bvrs,
14:33:51 252  	    rec.expires_date,
14:33:51 253  	    rec.create_date,
14:33:51 254  	    rec.created_by,
14:33:51 255  	    rec.update_date,
14:33:51 256  	    rec.updated_by,
14:33:51 257  	    rec.last_check_date,
14:33:51 258  	    rec.cancel_date
14:33:51 259  	      );
14:33:51 260  	      END LOOP;
14:33:51 261  
14:33:51 262  	      UPDATE CORE_OWNER.ITUNES_RECEIPT
14:33:51 263  		SET
14:33:51 264  		      subscription_id = in_subscription_id,
14:33:51 265  		      update_date = var_current_date,
14:33:51 266  	      updated_by = in_updated_by,
14:33:51 267  	      last_check_date = var_current_date
14:33:51 268  	      WHERE
14:33:51 269  		  id = in_id
14:33:51 270  	      ;
14:33:51 271  
14:33:51 272  	      EXCEPTION
14:33:51 273  	      WHEN DUP_VAL_ON_INDEX THEN
14:33:51 274  		PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.DUPLICATE_ERROR,
14:33:51 275  		  SPROC_NAME, 'Duplicate value', SQLERRM);
14:33:51 276  	      WHEN OTHERS THEN
14:33:51 277  		PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:51 278  		  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:51 279  END LINK_ITUNES_RECEIPT;
14:33:51 280  
14:33:51 281  
14:33:51 282  PROCEDURE MARK_RECEIPT_CHECKED(
14:33:51 283  /*
14:33:51 284  Throws exceptions:
14:33:51 285  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:51 286  */
14:33:51 287  	  in_id       IN CORE_OWNER.ITUNES_RECEIPT.ID%TYPE
14:33:51 288  ) AS
14:33:51 289  SPROC_NAME	CONSTANT VARCHAR2(32) := 'MARK_RECEIPT_CHECKED';
14:33:51 290  BEGIN
14:33:51 291  	UPDATE
14:33:51 292  	  CORE_OWNER.ITUNES_RECEIPT
14:33:51 293  	SET
14:33:51 294  	  last_check_date = sysdate
14:33:51 295  	WHERE
14:33:51 296  	  id = in_id
14:33:51 297  	;
14:33:51 298  EXCEPTION
14:33:51 299  WHEN OTHERS THEN
14:33:51 300  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:51 301  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:51 302  END MARK_RECEIPT_CHECKED;
14:33:51 303  
14:33:51 304  END PROCS_ITUNES_RECEIPT_CRU_V22;
14:33:51 305  .
14:33:51 SQL> /

Package body created.

Elapsed: 00:00:00.05
14:33:51 SQL> 
14:33:51 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_LICENSE_CRU_V22" AS
14:33:51   2  
14:33:51   3  PROCEDURE CREATE_LICENSE(
14:33:51   4  	out_license_id		    OUT LICENSE.ID%TYPE,
14:33:51   5  	in_license_id		    IN LICENSE.ID%TYPE DEFAULT NULL,
14:33:51   6  	in_license_status_id	    IN LICENSE.LICENSE_STATUS_ID%TYPE,
14:33:51   7  	in_needs_entitlements	    IN LICENSE.NEEDS_ENTITLEMENTS%TYPE,
14:33:51   8  	in_start_date		    IN LICENSE.START_DATE%TYPE,
14:33:51   9  	in_offer_id		    IN LICENSE.OFFER_ID%TYPE,
14:33:51  10  	in_subscription_id	    IN LICENSE.SUBSCRIPTION_ID%TYPE,
14:33:51  11  	in_invoice_id		    IN LICENSE.INVOICE_ID%TYPE,
14:33:51  12  	in_end_date		    IN LICENSE.END_DATE%TYPE,
14:33:51  13  	in_created_by		    IN LICENSE.CREATED_BY%TYPE,
14:33:51  14  	in_is_extension 	    IN LICENSE.IS_EXTENSION%TYPE,
14:33:51  15  	in_current_offer_index	    IN LICENSE.CURRENT_OFFER_INDEX%TYPE,
14:33:51  16  	in_current_offer_recurr_num IN LICENSE.CURRENT_OFFER_RECURR_NUM%TYPE
14:33:51  17  ) AS
14:33:51  18  -- VARIABLES
14:33:51  19  var_license_id LICENSE.ID%TYPE;
14:33:51  20  -- arosolovskiy: using data variable instead of direct get data calls (#38860)
14:33:51  21  var_date DATE := SYSDATE;
14:33:51  22  BEGIN
14:33:51  23  	IF in_license_id IS NULL THEN
14:33:51  24  	  SELECT
14:33:51  25  	    LCN_ID_SEQ.nextVal into var_license_id
14:33:51  26  	  FROM DUAL;
14:33:51  27  	ELSE
14:33:51  28  	  var_license_id := in_license_id;
14:33:51  29  	END IF;
14:33:51  30  	INSERT INTO
14:33:51  31  	  LICENSE (
14:33:51  32  	    ID,
14:33:51  33  	    LICENSE_STATUS_ID,
14:33:51  34  	    NEEDS_ENTITLEMENTS,
14:33:51  35  	    START_DATE,
14:33:51  36  	    OFFER_ID,
14:33:51  37  	    SUBSCRIPTION_ID,
14:33:51  38  	    INVOICE_ID,
14:33:51  39  	    END_DATE,
14:33:51  40  	    CREATE_DATE,
14:33:51  41  	    CREATED_BY,
14:33:51  42  	    UPDATE_DATE,
14:33:51  43  	    UPDATED_BY,
14:33:51  44  	    IS_EXTENSION,
14:33:51  45  	    CURRENT_OFFER_INDEX,
14:33:51  46  	    CURRENT_OFFER_RECURR_NUM,
14:33:51  47  	    ENTITLEMENT_END_DATE
14:33:51  48  	  ) VALUES (
14:33:51  49  	    var_license_id,
14:33:51  50  	    in_license_status_id,
14:33:51  51  	    in_needs_entitlements,
14:33:51  52  	    in_start_date,
14:33:51  53  	    in_offer_id,
14:33:51  54  	    in_subscription_id,
14:33:51  55  	    in_invoice_id,
14:33:51  56  	    in_end_date,
14:33:51  57  	    var_date,
14:33:51  58  	    in_created_by,
14:33:51  59  	    var_date,
14:33:51  60  	    in_created_by,
14:33:51  61  	    in_is_extension,
14:33:51  62  	    in_current_offer_index,
14:33:51  63  	    in_current_offer_recurr_num,
14:33:51  64  	    in_end_date
14:33:51  65  	  );
14:33:51  66  
14:33:51  67  	out_license_id := var_license_id;
14:33:51  68  END CREATE_LICENSE;
14:33:51  69  
14:33:51  70  /********************************************************************/
14:33:51  71  
14:33:51  72  PROCEDURE UPDATE_LICENSE (
14:33:51  73  	in_license_id		    IN LICENSE.ID%TYPE,
14:33:51  74  	in_license_status_id	    IN LICENSE.LICENSE_STATUS_ID%TYPE DEFAULT NULL,
14:33:51  75  	in_needs_entitlements	    IN LICENSE.NEEDS_ENTITLEMENTS%TYPE DEFAULT NULL,
14:33:51  76  	in_start_date		    IN LICENSE.START_DATE%TYPE DEFAULT NULL,
14:33:51  77  	in_end_date		    IN LICENSE.END_DATE%TYPE DEFAULT NULL,
14:33:51  78  	in_updated_by		    IN LICENSE.CREATED_BY%TYPE,
14:33:51  79  	in_is_extension 	    IN LICENSE.IS_EXTENSION%TYPE DEFAULT NULL,
14:33:51  80  	in_current_offer_index	    IN LICENSE.CURRENT_OFFER_INDEX%TYPE DEFAULT NULL,
14:33:51  81  	in_current_offer_recurr_num IN LICENSE.CURRENT_OFFER_RECURR_NUM%TYPE DEFAULT NULL,
14:33:51  82  	in_entitlement_end_date     IN LICENSE.ENTITLEMENT_END_DATE%TYPE DEFAULT NULL,
14:33:51  83  	in_grace_start_date	    IN LICENSE.GRACE_START_DATE%TYPE DEFAULT NULL,
14:33:51  84  	in_grace_end_date	    IN LICENSE.GRACE_END_DATE%TYPE DEFAULT NULL
14:33:51  85  ) AS
14:33:51  86  BEGIN
14:33:51  87  	-- Create history
14:33:51  88  	PROCS_HISTORY_V22.CREATE_LICENSE_HISTORY(
14:33:51  89  	  in_license_id 	       => in_license_id,
14:33:51  90  	  in_system_activity_reason_id => GLOBAL_ENUMS_V22.SAC_SYSTEM_APPLIED_RULE
14:33:51  91  	);
14:33:51  92  
14:33:51  93  	UPDATE
14:33:51  94  	  LICENSE
14:33:51  95  	SET
14:33:51  96  	  LICENSE_STATUS_ID	   = NVL(in_license_status_id, LICENSE_STATUS_ID),
14:33:51  97  	  NEEDS_ENTITLEMENTS	   = NVL(in_needs_entitlements, NEEDS_ENTITLEMENTS),
14:33:51  98  	  START_DATE		   = NVL(in_start_date, START_DATE),
14:33:51  99  	  END_DATE		   = NVL(in_end_date, END_DATE),
14:33:51 100  	  UPDATE_DATE		   = SYSDATE,
14:33:51 101  	  UPDATED_BY		   = in_updated_by,
14:33:51 102  	  IS_EXTENSION		   = NVL(in_is_extension, IS_EXTENSION),
14:33:51 103  	  CURRENT_OFFER_INDEX	   = NVL(in_current_offer_index, CURRENT_OFFER_INDEX),
14:33:51 104  	  CURRENT_OFFER_RECURR_NUM = NVL(in_current_offer_recurr_num, CURRENT_OFFER_RECURR_NUM),
14:33:51 105  	  ENTITLEMENT_END_DATE	   = NVL(in_entitlement_end_date, ENTITLEMENT_END_DATE),
14:33:51 106  	  GRACE_START_DATE	   = NVL(in_grace_start_date, GRACE_START_DATE),
14:33:51 107  	  GRACE_END_DATE	   = NVL(in_grace_end_date, GRACE_END_DATE)
14:33:51 108  	WHERE
14:33:51 109  	  LICENSE.ID = in_license_id;
14:33:51 110  END UPDATE_LICENSE;
14:33:51 111  
14:33:51 112  END PROCS_LICENSE_CRU_V22;
14:33:51 113  .
14:33:51 SQL> /

Package body created.

Elapsed: 00:00:00.02
14:33:51 SQL> 
14:33:51 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_LINE_ITEMS_CRU_V22" AS
14:33:51   2  
14:33:51   3  PROCEDURE CREATE_LINE_ITEM (
14:33:51   4  	inout_line_item_id  IN OUT LINE_ITEM.ID%TYPE,
14:33:51   5  	in_product_offer_id IN LINE_ITEM.PRODUCT_OFFER_ID%TYPE,
14:33:51   6  	in_invoice_id	    IN LINE_ITEM.INVOICE_ID%TYPE,
14:33:51   7  	in_amount	    IN LINE_ITEM.AMOUNT%TYPE,
14:33:51   8  	in_created_by	    IN LINE_ITEM.CREATED_BY%TYPE,
14:33:51   9  	in_discount_amount  IN LINE_ITEM.DISCOUNT_AMOUNT%TYPE,
14:33:51  10  	in_taxes_amount     IN LINE_ITEM.TAXES_AMOUNT%TYPE
14:33:51  11  ) AS
14:33:51  12  BEGIN
14:33:51  13  	IF inout_line_item_id IS NULL THEN
14:33:51  14  	  SELECT
14:33:51  15  	    LI_ID_SEQ.nextVal into inout_line_item_id
14:33:51  16  	  FROM DUAL;
14:33:51  17  	END IF;
14:33:51  18  	INSERT INTO LINE_ITEM (
14:33:51  19  	  ID,
14:33:51  20  	  PRODUCT_OFFER_ID,
14:33:51  21  	  INVOICE_ID,
14:33:51  22  	  AMOUNT,
14:33:51  23  	  QUANTITY,
14:33:51  24  	  CREATE_DATE,
14:33:51  25  	  CREATED_BY,
14:33:51  26  	  DISCOUNT_AMOUNT,
14:33:51  27  	  TAXES_AMOUNT
14:33:51  28  	) VALUES (
14:33:51  29  	  inout_line_item_id,
14:33:51  30  	  in_product_offer_id,
14:33:51  31  	  in_invoice_id,
14:33:51  32  	  in_amount,
14:33:51  33  	  1, -- [REVU]: Deprecated. Ignore this field
14:33:51  34  	  SYSDATE,
14:33:51  35  	  in_created_by,
14:33:51  36  	  in_discount_amount,
14:33:51  37  	  in_taxes_amount
14:33:51  38  	);
14:33:51  39  END CREATE_LINE_ITEM;
14:33:51  40  
14:33:51  41  /******************************************************************************/
14:33:51  42  
14:33:51  43  PROCEDURE UPDATE_LINE_ITEM (
14:33:51  44  	in_line_item_id     IN LINE_ITEM.ID%TYPE,
14:33:51  45  	in_amount	    IN LINE_ITEM.AMOUNT%TYPE DEFAULT NULL,
14:33:51  46  	in_discount_amount  IN LINE_ITEM.DISCOUNT_AMOUNT%TYPE  DEFAULT NULL,
14:33:51  47  	in_taxes_amount     IN LINE_ITEM.TAXES_AMOUNT%TYPE DEFAULT NULL
14:33:51  48  ) AS
14:33:51  49  BEGIN
14:33:51  50  	UPDATE
14:33:51  51  	  LINE_ITEM
14:33:51  52  	SET
14:33:51  53  	  LINE_ITEM.AMOUNT	    = NVL(in_amount, LINE_ITEM.AMOUNT),
14:33:51  54  	  LINE_ITEM.DISCOUNT_AMOUNT = NVL(in_discount_amount, LINE_ITEM.DISCOUNT_AMOUNT),
14:33:51  55  	  LINE_ITEM.TAXES_AMOUNT    = NVL(in_taxes_amount, LINE_ITEM.TAXES_AMOUNT)
14:33:51  56  	WHERE
14:33:51  57  	  LINE_ITEM.ID = in_line_item_id;
14:33:51  58  END UPDATE_LINE_ITEM;
14:33:51  59  
14:33:51  60  /******************************************************************************/
14:33:51  61  
14:33:51  62  PROCEDURE CREATE_DISCOUNT_LINE_ITEM (
14:33:51  63  	in_discount_id	IN DISCOUNT.ID%TYPE,
14:33:51  64  	in_line_item_id IN LINE_ITEM.ID%TYPE
14:33:51  65  ) AS
14:33:51  66  BEGIN
14:33:51  67  	INSERT INTO DISCOUNT_LINE_ITEM(
14:33:51  68  	  DISCOUNT_ID,
14:33:51  69  	  LINE_ITEM_ID
14:33:51  70  	) VALUES (
14:33:51  71  	  in_discount_id,
14:33:51  72  	  in_line_item_id
14:33:51  73  	);
14:33:51  74  END CREATE_DISCOUNT_LINE_ITEM;
14:33:51  75  
14:33:51  76  END PROCS_LINE_ITEMS_CRU_V22;
14:33:51  77  .
14:33:51 SQL> /

Package body created.

Elapsed: 00:00:00.03
14:33:51 SQL> 
14:33:51 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_RECONCILIATION_CRU_V22" AS
14:33:51   2  
14:33:51   3  PROCEDURE CREATE_CPT_CHARGEBACK_ACT (
14:33:51   4  	out_cpt_chargeback_act_id   OUT RCN_CPT_CHARGEBACK_ACT_DETAIL.ID%TYPE,
14:33:51   5  	in_cpt_chargeback_act_id    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.ID%TYPE DEFAULT NULL,
14:33:51   6  	in_ext_source_log_id	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.RCN_EXT_SOURCE_LOG_ID%TYPE,
14:33:51   7  	in_record_type		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.RECORD_TYPE%TYPE,
14:33:51   8  	in_entity_type		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.ENTITY_TYPE%TYPE,
14:33:51   9  	in_entity_number	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.ENTITY_NUMBER%TYPE,
14:33:51  10  	in_chargeback_amount_issuer IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CHARGEBACK_AMOUNT_ISSUER%TYPE,
14:33:51  11  	in_prev_partial_repres	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.PREV_PARTIAL_REPRESENTMENT%TYPE,
14:33:51  12  	in_presentment_currency     IN RCN_CPT_CHARGEBACK_ACT_DETAIL.PRESENTMENT_CURRENCY%TYPE,
14:33:51  13  	in_chargeback_category	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CHARGEBACK_CATEGORY%TYPE,
14:33:51  14  	in_status_flag		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.STATUS_FLAG%TYPE,
14:33:51  15  	in_sequence_number	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.SEQUENCE_NUMBER%TYPE,
14:33:51  16  	in_merchant_order_number    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.MERCHANT_ORDER_NUMBER%TYPE,
14:33:51  17  	in_account_number	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.ACCOUNT_NUMBER%TYPE,
14:33:51  18  	in_reason_code		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.REASON_CODE%TYPE,
14:33:51  19  	in_transaction_date	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.TRANSACTION_DATE%TYPE,
14:33:51  20  	in_chargeback_date	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CHARGEBACK_DATE%TYPE,
14:33:51  21  	in_activity_date	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.ACTIVITY_DATE%TYPE,
14:33:51  22  	in_chargeback_amount_action IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CHARGEBACK_AMOUNT_ACTION%TYPE,
14:33:51  23  	in_fee_amount		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.FEE_AMOUNT%TYPE,
14:33:51  24  	in_usage_code		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.USAGE_CODE%TYPE,
14:33:51  25  	in_mop_code		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.MOP_CODE%TYPE,
14:33:51  26  	in_authorization_date	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.AUTHORIZATION_DATE%TYPE,
14:33:51  27  	in_chargeback_due_date	    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CHARGEBACK_DUE_DATE%TYPE,
14:33:51  28  	in_created_by		    IN RCN_CPT_CHARGEBACK_ACT_DETAIL.CREATED_BY%TYPE
14:33:51  29  ) AS
14:33:51  30  -- VARIABLES
14:33:51  31  var_cpt_chargeback_act_id RCN_CPT_CHARGEBACK_ACT_DETAIL.ID%TYPE;
14:33:51  32  var_date DATE := SYSDATE;
14:33:51  33  BEGIN
14:33:51  34  	IF in_cpt_chargeback_act_id IS NULL THEN
14:33:51  35  	  SELECT
14:33:51  36  	    RCN_CPT_CHRGBK_ACT_DETAIL_SEQ.nextVal into var_cpt_chargeback_act_id
14:33:51  37  	  FROM DUAL;
14:33:51  38  	ELSE
14:33:51  39  	  var_cpt_chargeback_act_id := in_cpt_chargeback_act_id;
14:33:51  40  	END IF;
14:33:51  41  	INSERT INTO
14:33:51  42  	  RCN_CPT_CHARGEBACK_ACT_DETAIL (
14:33:51  43  	    id,
14:33:51  44  	    rcn_ext_source_log_id,
14:33:51  45  	    record_type,
14:33:51  46  	    entity_type,
14:33:51  47  	    entity_number,
14:33:51  48  	    chargeback_amount_issuer,
14:33:51  49  	    prev_partial_representment,
14:33:51  50  	    presentment_currency,
14:33:51  51  	    chargeback_category,
14:33:51  52  	    status_flag,
14:33:51  53  	    sequence_number,
14:33:51  54  	    merchant_order_number,
14:33:51  55  	    account_number,
14:33:51  56  	    reason_code,
14:33:51  57  	    transaction_date,
14:33:51  58  	    chargeback_date,
14:33:51  59  	    activity_date,
14:33:51  60  	    chargeback_amount_action,
14:33:51  61  	    fee_amount,
14:33:51  62  	    usage_code,
14:33:51  63  	    mop_code,
14:33:51  64  	    authorization_date,
14:33:51  65  	    chargeback_due_date,
14:33:51  66  	    create_date,
14:33:51  67  	    created_by
14:33:51  68  	  ) VALUES (
14:33:51  69  	    var_cpt_chargeback_act_id,
14:33:51  70  	    in_ext_source_log_id,
14:33:51  71  	    in_record_type,
14:33:51  72  	    in_entity_type,
14:33:51  73  	    in_entity_number,
14:33:51  74  	    in_chargeback_amount_issuer,
14:33:51  75  	    in_prev_partial_repres,
14:33:51  76  	    in_presentment_currency,
14:33:51  77  	    in_chargeback_category,
14:33:51  78  	    in_status_flag,
14:33:51  79  	    in_sequence_number,
14:33:51  80  	    in_merchant_order_number,
14:33:51  81  	    in_account_number,
14:33:51  82  	    in_reason_code,
14:33:51  83  	    in_transaction_date,
14:33:51  84  	    in_chargeback_date,
14:33:51  85  	    in_activity_date,
14:33:51  86  	    in_chargeback_amount_action,
14:33:51  87  	    in_fee_amount,
14:33:51  88  	    in_usage_code,
14:33:51  89  	    in_mop_code,
14:33:51  90  	    in_authorization_date,
14:33:51  91  	    in_chargeback_due_date,
14:33:51  92  	    var_date,
14:33:51  93  	    in_created_by
14:33:51  94  	  );
14:33:51  95  
14:33:51  96  	out_cpt_chargeback_act_id := var_cpt_chargeback_act_id;
14:33:51  97  END CREATE_CPT_CHARGEBACK_ACT;
14:33:51  98  
14:33:51  99  PROCEDURE CREATE_EXT_SOURCE_LOG (
14:33:51 100  	out_ext_source_log_id	    OUT RCN_EXT_SOURCE_LOG.ID%TYPE,
14:33:51 101  	in_ext_source_log_id	    IN RCN_EXT_SOURCE_LOG.ID%TYPE DEFAULT NULL,
14:33:51 102  	in_extraction_timestamp     IN RCN_EXT_SOURCE_LOG.EXTRACTION_TIMESTAMP%TYPE,
14:33:51 103  	in_report_date		    IN RCN_EXT_SOURCE_LOG.REPORT_DATE%TYPE,
14:33:51 104  	in_report_gen_datetime	    IN RCN_EXT_SOURCE_LOG.REPORT_GENERATION_DATETIME%TYPE,
14:33:51 105  	in_record_type		    IN RCN_EXT_SOURCE_LOG.RECORD_TYPE%TYPE,
14:33:51 106  	in_report_file_name	    IN RCN_EXT_SOURCE_LOG.REPORT_FILE_NAME%TYPE,
14:33:51 107  	in_created_by		    IN RCN_EXT_SOURCE_LOG.CREATED_BY%TYPE
14:33:51 108  ) AS
14:33:51 109  -- VARIABLES
14:33:51 110  var_ext_source_log_id RCN_EXT_SOURCE_LOG.ID%TYPE;
14:33:51 111  var_date DATE := SYSDATE;
14:33:51 112  BEGIN
14:33:51 113  	IF in_ext_source_log_id IS NULL THEN
14:33:51 114  	  SELECT
14:33:51 115  	    RCN_EXT_SOURCE_LOG_SEQ.nextVal into var_ext_source_log_id
14:33:51 116  	  FROM DUAL;
14:33:51 117  	ELSE
14:33:51 118  	  var_ext_source_log_id := in_ext_source_log_id;
14:33:51 119  	END IF;
14:33:51 120  	INSERT INTO
14:33:51 121  	  RCN_EXT_SOURCE_LOG (
14:33:51 122  	    id,
14:33:51 123  	    extraction_timestamp,
14:33:51 124  	    report_date,
14:33:51 125  	    report_generation_datetime,
14:33:51 126  	    record_type,
14:33:51 127  	    report_file_name,
14:33:51 128  	    create_date,
14:33:51 129  	    created_by
14:33:51 130  	  ) VALUES (
14:33:51 131  	    var_ext_source_log_id,
14:33:51 132  	    in_extraction_timestamp,
14:33:51 133  	    in_report_date,
14:33:51 134  	    in_report_gen_datetime,
14:33:51 135  	    in_record_type,
14:33:51 136  	    in_report_file_name,
14:33:51 137  	    var_date,
14:33:51 138  	    in_created_by
14:33:51 139  	  );
14:33:51 140  
14:33:51 141  	out_ext_source_log_id := var_ext_source_log_id;
14:33:51 142  END CREATE_EXT_SOURCE_LOG;
14:33:51 143  
14:33:51 144  PROCEDURE CREATE_CPT_SERVICE_CHARGE (
14:33:51 145  	out_cpt_service_charge_id   OUT RCN_CPT_SERVICE_CHARGE_DETAIL.ID%TYPE,
14:33:51 146  	in_cpt_service_charge_id    IN RCN_CPT_SERVICE_CHARGE_DETAIL.ID%TYPE DEFAULT NULL,
14:33:51 147  	in_ext_source_log_id	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.RCN_EXT_SOURCE_LOG_ID%TYPE,
14:33:51 148  	in_record_type		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.RECORD_TYPE%TYPE,
14:33:51 149  	in_category		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.CATEGORY%TYPE,
14:33:51 150  	in_sub_category 	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.SUB_CATEGORY%TYPE,
14:33:51 151  	in_entity_type		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.ENTITY_TYPE%TYPE,
14:33:51 152  	in_entity_number	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.ENTITY_NUMBER%TYPE,
14:33:51 153  	in_funds_trans_inst_number  IN RCN_CPT_SERVICE_CHARGE_DETAIL.FUNDS_TRANSFER_INST_NUMBER%TYPE,
14:33:51 154  	in_secure_ba_number	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.SECURE_BA_NUMBER%TYPE,
14:33:51 155  	in_settlement_currency	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.SETTLEMENT_CURRENCY%TYPE,
14:33:51 156  	in_fee_schedule 	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.FEE_SCHEDULE%TYPE,
14:33:51 157  	in_mop			    IN RCN_CPT_SERVICE_CHARGE_DETAIL.MOP%TYPE,
14:33:51 158  	in_interchange_qual	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.INTERCHANGE_QUALIFICATION%TYPE,
14:33:51 159  	in_fee_type_description     IN RCN_CPT_SERVICE_CHARGE_DETAIL.FEE_TYPE_DESCRIPTION%TYPE,
14:33:51 160  	in_action_type		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.ACTION_TYPE%TYPE,
14:33:51 161  	in_unit_quantity	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.UNIT_QUANTITY%TYPE,
14:33:51 162  	in_unit_fee		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.UNIT_FEE%TYPE,
14:33:51 163  	in_amount		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.AMOUNT%TYPE,
14:33:51 164  	in_percentage_rate	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.PERCENTAGE_RATE%TYPE,
14:33:51 165  	in_total_charge 	    IN RCN_CPT_SERVICE_CHARGE_DETAIL.TOTAL_CHARGE%TYPE,
14:33:51 166  	in_created_by		    IN RCN_CPT_SERVICE_CHARGE_DETAIL.CREATED_BY%TYPE
14:33:51 167  ) AS
14:33:51 168  -- VARIABLES
14:33:51 169  var_cpt_service_charge_id RCN_CPT_SERVICE_CHARGE_DETAIL.ID%TYPE;
14:33:51 170  var_date DATE := SYSDATE;
14:33:51 171  BEGIN
14:33:51 172  	IF in_cpt_service_charge_id IS NULL THEN
14:33:51 173  	  SELECT
14:33:51 174  	    RCN_CPT_SERV_CHARGE_DETAIL_SEQ.nextVal into var_cpt_service_charge_id
14:33:51 175  	  FROM DUAL;
14:33:51 176  	ELSE
14:33:51 177  	  var_cpt_service_charge_id := in_cpt_service_charge_id;
14:33:51 178  	END IF;
14:33:51 179  	INSERT INTO
14:33:51 180  	  RCN_CPT_SERVICE_CHARGE_DETAIL (
14:33:51 181  	    id,
14:33:51 182  	    rcn_ext_source_log_id,
14:33:51 183  	    record_type,
14:33:51 184  	    category,
14:33:51 185  	    sub_category,
14:33:51 186  	    entity_type,
14:33:51 187  	    entity_number,
14:33:51 188  	    funds_transfer_inst_number,
14:33:51 189  	    secure_ba_number,
14:33:51 190  	    settlement_currency,
14:33:51 191  	    fee_schedule,
14:33:51 192  	    mop,
14:33:51 193  	    interchange_qualification,
14:33:51 194  	    fee_type_description,
14:33:51 195  	    action_type,
14:33:51 196  	    unit_quantity,
14:33:51 197  	    unit_fee,
14:33:51 198  	    amount,
14:33:51 199  	    percentage_rate,
14:33:51 200  	    total_charge,
14:33:51 201  	    create_date,
14:33:51 202  	    created_by
14:33:51 203  	  ) VALUES (
14:33:51 204  	    var_cpt_service_charge_id,
14:33:51 205  	    in_ext_source_log_id,
14:33:51 206  	    in_record_type,
14:33:51 207  	    in_category,
14:33:51 208  	    in_sub_category,
14:33:51 209  	    in_entity_type,
14:33:51 210  	    in_entity_number,
14:33:51 211  	    in_funds_trans_inst_number,
14:33:51 212  	    in_secure_ba_number,
14:33:51 213  	    in_settlement_currency,
14:33:51 214  	    in_fee_schedule,
14:33:51 215  	    in_mop,
14:33:51 216  	    in_interchange_qual,
14:33:51 217  	    in_fee_type_description,
14:33:51 218  	    in_action_type,
14:33:51 219  	    in_unit_quantity,
14:33:51 220  	    in_unit_fee,
14:33:51 221  	    in_amount,
14:33:51 222  	    in_percentage_rate,
14:33:51 223  	    in_total_charge,
14:33:51 224  	    var_date,
14:33:51 225  	    in_created_by
14:33:51 226  	  );
14:33:51 227  
14:33:51 228  	out_cpt_service_charge_id := var_cpt_service_charge_id;
14:33:51 229  END CREATE_CPT_SERVICE_CHARGE;
14:33:51 230  
14:33:51 231  PROCEDURE CREATE_CPT_EXCEPTION (
14:33:51 232  	out_cpt_exception_id	 OUT RCN_CPT_EXCEPTION_DETAIL.ID%TYPE,
14:33:51 233  	in_cpt_exception_id	 IN RCN_CPT_EXCEPTION_DETAIL.ID%TYPE DEFAULT NULL,
14:33:51 234  	in_ext_source_log_id	 IN RCN_CPT_EXCEPTION_DETAIL.RCN_EXT_SOURCE_LOG_ID%TYPE,
14:33:51 235  	in_record_type		 IN RCN_CPT_EXCEPTION_DETAIL.RECORD_TYPE%TYPE,
14:33:51 236  	in_submission_date	 IN RCN_CPT_EXCEPTION_DETAIL.SUBMISSION_DATE%TYPE,
14:33:51 237  	in_pid_number		 IN RCN_CPT_EXCEPTION_DETAIL.PID_NUMBER%TYPE,
14:33:51 238  	in_pid_short_name	 IN RCN_CPT_EXCEPTION_DETAIL.PID_SHORT_NAME%TYPE,
14:33:51 239  	in_submission_number	 IN RCN_CPT_EXCEPTION_DETAIL.SUBMISSION_NUMBER%TYPE,
14:33:51 240  	in_record_number	 IN RCN_CPT_EXCEPTION_DETAIL.RECORD_NUMBER%TYPE,
14:33:51 241  	in_entity_type		 IN RCN_CPT_EXCEPTION_DETAIL.ENTITY_TYPE%TYPE,
14:33:51 242  	in_entity_number	 IN RCN_CPT_EXCEPTION_DETAIL.ENTITY_NUMBER%TYPE,
14:33:51 243  	in_presentment_currency  IN RCN_CPT_EXCEPTION_DETAIL.PRESENTMENT_CURRENCY%TYPE,
14:33:51 244  	in_merchant_order_number IN RCN_CPT_EXCEPTION_DETAIL.MERCHANT_ORDER_NUMBER%TYPE,
14:33:51 245  	in_rdfi_number		 IN RCN_CPT_EXCEPTION_DETAIL.RDFI_NUMBER%TYPE,
14:33:51 246  	in_account_number	 IN RCN_CPT_EXCEPTION_DETAIL.ACCOUNT_NUMBER%TYPE,
14:33:51 247  	in_expiration_date	 IN RCN_CPT_EXCEPTION_DETAIL.EXPIRATION_DATE%TYPE,
14:33:51 248  	in_amount		 IN RCN_CPT_EXCEPTION_DETAIL.AMOUNT%TYPE,
14:33:51 249  	in_mop			 IN RCN_CPT_EXCEPTION_DETAIL.MOP%TYPE,
14:33:51 250  	in_action_code		 IN RCN_CPT_EXCEPTION_DETAIL.ACTION_CODE%TYPE,
14:33:51 251  	in_auth_date		 IN RCN_CPT_EXCEPTION_DETAIL.AUTH_DATE%TYPE,
14:33:51 252  	in_auth_code		 IN RCN_CPT_EXCEPTION_DETAIL.AUTH_CODE%TYPE,
14:33:51 253  	in_auth_response_code	 IN RCN_CPT_EXCEPTION_DETAIL.AUTH_RESPONSE_CODE%TYPE,
14:33:51 254  	in_trace_number 	 IN RCN_CPT_EXCEPTION_DETAIL.TRACE_NUMBER%TYPE,
14:33:51 255  	in_consumer_country_code IN RCN_CPT_EXCEPTION_DETAIL.CONSUMER_COUNTRY_CODE%TYPE,
14:33:51 256  	in_category		 IN RCN_CPT_EXCEPTION_DETAIL.CATEGORY%TYPE,
14:33:51 257  	in_mcc			 IN RCN_CPT_EXCEPTION_DETAIL.MCC%TYPE,
14:33:51 258  	in_reject_code		 IN RCN_CPT_EXCEPTION_DETAIL.REJECT_CODE%TYPE,
14:33:51 259  	in_submission_status	 IN RCN_CPT_EXCEPTION_DETAIL.SUBMISSION_STATUS%TYPE,
14:33:51 260  	in_created_by		 IN RCN_CPT_EXCEPTION_DETAIL.CREATED_BY%TYPE
14:33:51 261  ) AS
14:33:51 262  -- VARIABLES
14:33:51 263  var_cpt_exception_id RCN_CPT_EXCEPTION_DETAIL.ID%TYPE;
14:33:51 264  var_date DATE := SYSDATE;
14:33:51 265  BEGIN
14:33:51 266  	IF in_cpt_exception_id IS NULL THEN
14:33:51 267  	  SELECT
14:33:51 268  	    RCN_CPT_EXCEPTION_DETAIL_SEQ.nextVal into var_cpt_exception_id
14:33:51 269  	  FROM DUAL;
14:33:51 270  	ELSE
14:33:51 271  	  var_cpt_exception_id := in_cpt_exception_id;
14:33:51 272  	END IF;
14:33:51 273  	INSERT INTO
14:33:51 274  	  RCN_CPT_EXCEPTION_DETAIL (
14:33:51 275  	    id,
14:33:51 276  	    rcn_ext_source_log_id,
14:33:51 277  	    record_type,
14:33:51 278  	    submission_date,
14:33:51 279  	    pid_number,
14:33:51 280  	    pid_short_name,
14:33:51 281  	    submission_number,
14:33:51 282  	    record_number,
14:33:51 283  	    entity_type,
14:33:51 284  	    entity_number,
14:33:51 285  	    presentment_currency,
14:33:51 286  	    merchant_order_number,
14:33:51 287  	    rdfi_number,
14:33:51 288  	    account_number,
14:33:51 289  	    expiration_date,
14:33:51 290  	    amount,
14:33:51 291  	    mop,
14:33:51 292  	    action_code,
14:33:51 293  	    auth_date,
14:33:51 294  	    auth_code,
14:33:51 295  	    auth_response_code,
14:33:51 296  	    trace_number,
14:33:51 297  	    consumer_country_code,
14:33:51 298  	    category,
14:33:51 299  	    mcc,
14:33:51 300  	    reject_code,
14:33:51 301  	    submission_status,
14:33:51 302  	    create_date,
14:33:51 303  	    created_by
14:33:51 304  	  ) VALUES (
14:33:51 305  	    var_cpt_exception_id,
14:33:51 306  	    in_ext_source_log_id,
14:33:51 307  	    in_record_type,
14:33:51 308  	    in_submission_date,
14:33:51 309  	    in_pid_number,
14:33:51 310  	    in_pid_short_name,
14:33:51 311  	    in_submission_number,
14:33:51 312  	    in_record_number,
14:33:51 313  	    in_entity_type,
14:33:51 314  	    in_entity_number,
14:33:51 315  	    in_presentment_currency,
14:33:51 316  	    in_merchant_order_number,
14:33:51 317  	    in_rdfi_number,
14:33:51 318  	    in_account_number,
14:33:51 319  	    in_expiration_date,
14:33:51 320  	    in_amount,
14:33:51 321  	    in_mop,
14:33:51 322  	    in_action_code,
14:33:51 323  	    in_auth_date,
14:33:51 324  	    in_auth_code,
14:33:51 325  	    in_auth_response_code,
14:33:51 326  	    in_trace_number,
14:33:51 327  	    in_consumer_country_code,
14:33:51 328  	    in_category,
14:33:51 329  	    in_mcc,
14:33:51 330  	    in_reject_code,
14:33:51 331  	    in_submission_status,
14:33:51 332  	    var_date,
14:33:51 333  	    in_created_by
14:33:51 334  	  );
14:33:51 335  
14:33:51 336  	out_cpt_exception_id := var_cpt_exception_id;
14:33:51 337  END CREATE_CPT_EXCEPTION;
14:33:51 338  
14:33:51 339  PROCEDURE CREATE_CPT_DEPOSIT (
14:33:51 340  	out_cpt_deposit_id	  OUT RCN_CPT_DEPOSIT_DETAIL.ID%TYPE,
14:33:51 341  	in_cpt_deposit_id	  IN RCN_CPT_DEPOSIT_DETAIL.ID%TYPE DEFAULT NULL,
14:33:51 342  	in_ext_source_log_id	  IN RCN_CPT_DEPOSIT_DETAIL.RCN_EXT_SOURCE_LOG_ID%TYPE,
14:33:51 343  	in_record_type		  IN RCN_CPT_DEPOSIT_DETAIL.RECORD_TYPE%TYPE,
14:33:51 344  	in_submission_date	  IN RCN_CPT_DEPOSIT_DETAIL.SUBMISSION_DATE%TYPE,
14:33:51 345  	in_pid_number		  IN RCN_CPT_DEPOSIT_DETAIL.PID_NUMBER%TYPE,
14:33:51 346  	in_pid_short_name	  IN RCN_CPT_DEPOSIT_DETAIL.PID_SHORT_NAME%TYPE,
14:33:51 347  	in_submission_number	  IN RCN_CPT_DEPOSIT_DETAIL.SUBMISSION_NUMBER%TYPE,
14:33:51 348  	in_record_number	  IN RCN_CPT_DEPOSIT_DETAIL.RECORD_NUMBER%TYPE,
14:33:51 349  	in_entity_type		  IN RCN_CPT_DEPOSIT_DETAIL.ENTITY_TYPE%TYPE,
14:33:51 350  	in_entity_number	  IN RCN_CPT_DEPOSIT_DETAIL.ENTITY_NUMBER%TYPE,
14:33:51 351  	in_presentment_currency   IN RCN_CPT_DEPOSIT_DETAIL.PRESENTMENT_CURRENCY%TYPE,
14:33:51 352  	in_merchant_order_number  IN RCN_CPT_DEPOSIT_DETAIL.MERCHANT_ORDER_NUMBER%TYPE,
14:33:51 353  	in_rdfi_number		  IN RCN_CPT_DEPOSIT_DETAIL.RDFI_NUMBER%TYPE,
14:33:51 354  	in_account_number	  IN RCN_CPT_DEPOSIT_DETAIL.ACCOUNT_NUMBER%TYPE,
14:33:51 355  	in_expiration_date	  IN RCN_CPT_DEPOSIT_DETAIL.EXPIRATION_DATE%TYPE,
14:33:51 356  	in_amount		  IN RCN_CPT_DEPOSIT_DETAIL.AMOUNT%TYPE,
14:33:51 357  	in_mop			  IN RCN_CPT_DEPOSIT_DETAIL.MOP%TYPE,
14:33:51 358  	in_action_code		  IN RCN_CPT_DEPOSIT_DETAIL.ACTION_CODE%TYPE,
14:33:51 359  	in_auth_date		  IN RCN_CPT_DEPOSIT_DETAIL.AUTH_DATE%TYPE,
14:33:51 360  	in_auth_code		  IN RCN_CPT_DEPOSIT_DETAIL.AUTH_CODE%TYPE,
14:33:51 361  	in_auth_response_code	  IN RCN_CPT_DEPOSIT_DETAIL.AUTH_RESPONSE_CODE%TYPE,
14:33:51 362  	in_trace_number 	  IN RCN_CPT_DEPOSIT_DETAIL.TRACE_NUMBER%TYPE,
14:33:51 363  	in_consumer_country_code  IN RCN_CPT_DEPOSIT_DETAIL.CONSUMER_COUNTRY_CODE%TYPE,
14:33:51 364  	in_mcc			  IN RCN_CPT_DEPOSIT_DETAIL.MCC%TYPE,
14:33:51 365  	in_fee_code		  IN RCN_CPT_DEPOSIT_DETAIL.FEE_CODE%TYPE,
14:33:51 366  	in_unit_fee		  IN RCN_CPT_DEPOSIT_DETAIL.UNIT_FEE%TYPE,
14:33:51 367  	in_percent_fee		  IN RCN_CPT_DEPOSIT_DETAIL.PERCENT_FEE%TYPE,
14:33:51 368  	in_total_interchange_fee  IN RCN_CPT_DEPOSIT_DETAIL.TOTAL_INTERCHANGE_FEE%TYPE,
14:33:51 369  	in_total_assessment_fee   IN RCN_CPT_DEPOSIT_DETAIL.TOTAL_ASSESSMENT_FEE%TYPE,
14:33:51 370  	in_other_fee		  IN RCN_CPT_DEPOSIT_DETAIL.OTHER_FEE%TYPE,
14:33:51 371  	in_created_by		  IN RCN_CPT_DEPOSIT_DETAIL.CREATED_BY%TYPE
14:33:51 372  ) AS
14:33:51 373  -- VARIABLES
14:33:51 374  var_cpt_deposit_id RCN_CPT_DEPOSIT_DETAIL.ID%TYPE;
14:33:51 375  var_date DATE := SYSDATE;
14:33:51 376  BEGIN
14:33:51 377  	IF in_cpt_deposit_id IS NULL THEN
14:33:51 378  	  SELECT
14:33:51 379  	    RCN_CPT_DEPOSIT_DETAIL_SEQ.nextVal into var_cpt_deposit_id
14:33:51 380  	  FROM DUAL;
14:33:51 381  	ELSE
14:33:51 382  	  var_cpt_deposit_id := in_cpt_deposit_id;
14:33:51 383  	END IF;
14:33:51 384  	INSERT INTO
14:33:51 385  	  RCN_CPT_DEPOSIT_DETAIL (
14:33:51 386  	    id,
14:33:51 387  	    rcn_ext_source_log_id,
14:33:51 388  	    record_type,
14:33:51 389  	    submission_date,
14:33:51 390  	    pid_number,
14:33:51 391  	    pid_short_name,
14:33:51 392  	    submission_number,
14:33:51 393  	    record_number,
14:33:51 394  	    entity_type,
14:33:51 395  	    entity_number,
14:33:51 396  	    presentment_currency,
14:33:51 397  	    merchant_order_number,
14:33:51 398  	    rdfi_number,
14:33:51 399  	    account_number,
14:33:51 400  	    expiration_date,
14:33:51 401  	    amount,
14:33:51 402  	    mop,
14:33:51 403  	    action_code,
14:33:51 404  	    auth_date,
14:33:51 405  	    auth_code,
14:33:51 406  	    auth_response_code,
14:33:51 407  	    trace_number,
14:33:51 408  	    consumer_country_code,
14:33:51 409  	    mcc,
14:33:51 410  	    fee_code,
14:33:51 411  	    unit_fee,
14:33:51 412  	    percent_fee,
14:33:51 413  	    total_interchange_fee,
14:33:51 414  	    total_assessment_fee,
14:33:51 415  	    other_fee,
14:33:51 416  	    create_date,
14:33:51 417  	    created_by
14:33:51 418  	  ) VALUES (
14:33:51 419  	    var_cpt_deposit_id,
14:33:51 420  	    in_ext_source_log_id,
14:33:51 421  	    in_record_type,
14:33:51 422  	    in_submission_date,
14:33:51 423  	    in_pid_number,
14:33:51 424  	    in_pid_short_name,
14:33:51 425  	    in_submission_number,
14:33:51 426  	    in_record_number,
14:33:51 427  	    in_entity_type,
14:33:51 428  	    in_entity_number,
14:33:51 429  	    in_presentment_currency,
14:33:51 430  	    in_merchant_order_number,
14:33:51 431  	    in_rdfi_number,
14:33:51 432  	    in_account_number,
14:33:51 433  	    in_expiration_date,
14:33:51 434  	    in_amount,
14:33:51 435  	    in_mop,
14:33:51 436  	    in_action_code,
14:33:51 437  	    in_auth_date,
14:33:51 438  	    in_auth_code,
14:33:51 439  	    in_auth_response_code,
14:33:51 440  	    in_trace_number,
14:33:51 441  	    in_consumer_country_code,
14:33:51 442  	    in_mcc,
14:33:51 443  	    in_fee_code,
14:33:51 444  	    in_unit_fee,
14:33:51 445  	    in_percent_fee,
14:33:51 446  	    in_total_interchange_fee,
14:33:51 447  	    in_total_assessment_fee,
14:33:51 448  	    in_other_fee,
14:33:51 449  	    var_date,
14:33:51 450  	    in_created_by
14:33:51 451  	  );
14:33:51 452  
14:33:51 453  	out_cpt_deposit_id := var_cpt_deposit_id;
14:33:51 454  END CREATE_CPT_DEPOSIT;
14:33:51 455  
14:33:51 456  PROCEDURE CREATE_PP_SETTLEMENT (
14:33:51 457  	out_pp_settlement_id	   OUT RCN_PP_SETTLEMENT.ID%TYPE,
14:33:51 458  	in_pp_settlement_id	   IN RCN_PP_SETTLEMENT.ID%TYPE DEFAULT NULL,
14:33:51 459  	in_ext_source_log_id	   IN RCN_PP_SETTLEMENT.RCN_EXT_SOURCE_LOG_ID%TYPE,
14:33:51 460  	in_transaction_id	   IN RCN_PP_SETTLEMENT.TRANSACTION_ID%TYPE,
14:33:51 461  	in_invoice_id		   IN RCN_PP_SETTLEMENT.INVOICE_ID%TYPE,
14:33:51 462  	in_pp_ref_id		   IN RCN_PP_SETTLEMENT.PP_REF_ID%TYPE,
14:33:51 463  	in_pp_ref_id_type	   IN RCN_PP_SETTLEMENT.PP_REF_ID_TYPE%TYPE,
14:33:51 464  	in_trans_event_code	   IN RCN_PP_SETTLEMENT.TRANS_EVENT_CODE%TYPE,
14:33:51 465  	in_trans_init_date	   IN RCN_PP_SETTLEMENT.TRANS_INIT_DATE%TYPE,
14:33:51 466  	in_trans_comp_date	   IN RCN_PP_SETTLEMENT.TRANS_COMP_DATE%TYPE,
14:33:51 467  	in_trans_deb_or_cred	   IN RCN_PP_SETTLEMENT.TRANS_DEB_OR_CRED%TYPE,
14:33:51 468  	in_gross_trans_amount	   IN RCN_PP_SETTLEMENT.GROSS_TRANS_AMOUNT%TYPE,
14:33:51 469  	in_gross_trans_currency    IN RCN_PP_SETTLEMENT.GROSS_TRANS_CURRENCY%TYPE,
14:33:51 470  	in_fee_deb_or_cred	   IN RCN_PP_SETTLEMENT.FEE_DEB_OR_CRED%TYPE,
14:33:51 471  	in_fee_amount		   IN RCN_PP_SETTLEMENT.FEE_AMOUNT%TYPE,
14:33:51 472  	in_fee_currency 	   IN RCN_PP_SETTLEMENT.FEE_CURRENCY%TYPE,
14:33:51 473  	in_custom_field 	   IN RCN_PP_SETTLEMENT.CUSTOM_FIELD%TYPE,
14:33:51 474  	in_created_by		   IN RCN_PP_SETTLEMENT.CREATED_BY%TYPE
14:33:51 475  ) AS
14:33:51 476  -- VARIABLES
14:33:51 477  var_pp_settlement_id RCN_PP_SETTLEMENT.ID%TYPE;
14:33:51 478  var_date DATE := SYSDATE;
14:33:51 479  BEGIN
14:33:51 480  	IF in_pp_settlement_id IS NULL THEN
14:33:51 481  	  SELECT
14:33:51 482  	    RCN_PP_SETTLEMENT_SEQ.nextVal into var_pp_settlement_id
14:33:51 483  	  FROM DUAL;
14:33:51 484  	ELSE
14:33:51 485  	  var_pp_settlement_id := in_pp_settlement_id;
14:33:51 486  	END IF;
14:33:51 487  	INSERT INTO
14:33:51 488  	  RCN_PP_SETTLEMENT (
14:33:51 489  	    id,
14:33:51 490  	    rcn_ext_source_log_id,
14:33:51 491  	    transaction_id,
14:33:51 492  	    invoice_id,
14:33:51 493  	    pp_ref_id,
14:33:51 494  	    pp_ref_id_type,
14:33:51 495  	    trans_event_code,
14:33:51 496  	    trans_init_date,
14:33:51 497  	    trans_comp_date,
14:33:51 498  	    trans_deb_or_cred,
14:33:51 499  	    gross_trans_amount,
14:33:51 500  	    gross_trans_currency,
14:33:51 501  	    fee_deb_or_cred,
14:33:51 502  	    fee_amount,
14:33:51 503  	    fee_currency,
14:33:51 504  	    custom_field,
14:33:51 505  	    create_date,
14:33:51 506  	    created_by
14:33:51 507  	  ) VALUES (
14:33:51 508  	    var_pp_settlement_id,
14:33:51 509  	    in_ext_source_log_id,
14:33:51 510  	    in_transaction_id,
14:33:51 511  	    in_invoice_id,
14:33:51 512  	    in_pp_ref_id,
14:33:51 513  	    in_pp_ref_id_type,
14:33:51 514  	    in_trans_event_code,
14:33:51 515  	    in_trans_init_date,
14:33:51 516  	    in_trans_comp_date,
14:33:51 517  	    in_trans_deb_or_cred,
14:33:51 518  	    in_gross_trans_amount,
14:33:51 519  	    in_gross_trans_currency,
14:33:51 520  	    in_fee_deb_or_cred,
14:33:51 521  	    in_fee_amount,
14:33:51 522  	    in_fee_currency,
14:33:51 523  	    in_custom_field,
14:33:51 524  	    var_date,
14:33:51 525  	    in_created_by
14:33:51 526  	  );
14:33:51 527  
14:33:51 528  	out_pp_settlement_id := var_pp_settlement_id;
14:33:51 529  END CREATE_PP_SETTLEMENT;
14:33:51 530  
14:33:51 531  PROCEDURE CREATE_PP_DISPUTE (
14:33:51 532  	out_pp_dispute_id	     OUT RCN_PP_DISPUTE.ID%TYPE,
14:33:51 533  	in_pp_dispute_id	     IN RCN_PP_DISPUTE.ID%TYPE DEFAULT NULL,
14:33:51 534  	in_ext_source_log_id	     IN RCN_PP_DISPUTE.RCN_EXT_SOURCE_LOG_ID%TYPE,
14:33:51 535  	in_dispute_type 	     IN RCN_PP_DISPUTE.DISPUTE_TYPE%TYPE,
14:33:51 536  	in_claimant_name	     IN RCN_PP_DISPUTE.CLAIMANT_NAME%TYPE,
14:33:51 537  	in_claimant_email	     IN RCN_PP_DISPUTE.CLAIMANT_EMAIL%TYPE,
14:33:51 538  	in_transaction_id	     IN RCN_PP_DISPUTE.TRANSACTION_ID%TYPE,
14:33:51 539  	in_trans_date		     IN RCN_PP_DISPUTE.TRANS_DATE%TYPE,
14:33:51 540  	in_disputed_amount	     IN RCN_PP_DISPUTE.DISPUTED_AMOUNT%TYPE,
14:33:51 541  	in_disputed_amount_currency  IN RCN_PP_DISPUTE.DISPUTED_AMOUNT_CURRENCY%TYPE,
14:33:51 542  	in_dispute_reason	     IN RCN_PP_DISPUTE.DISPUTE_REASON%TYPE,
14:33:51 543  	in_dispute_filing_date	     IN RCN_PP_DISPUTE.DISPUTE_FILING_DATE%TYPE,
14:33:51 544  	in_dispute_status	     IN RCN_PP_DISPUTE.DISPUTE_STATUS%TYPE,
14:33:51 545  	in_dispute_case_id	     IN RCN_PP_DISPUTE.DISPUTE_CASE_ID%TYPE,
14:33:51 546  	in_invoice_id		     IN RCN_PP_DISPUTE.INVOICE_ID%TYPE,
14:33:51 547  	in_created_by		     IN RCN_PP_DISPUTE.CREATED_BY%TYPE
14:33:51 548  ) AS
14:33:51 549  -- VARIABLES
14:33:51 550  var_pp_dispute_id RCN_PP_DISPUTE.ID%TYPE;
14:33:51 551  var_date DATE := SYSDATE;
14:33:51 552  BEGIN
14:33:51 553  	IF in_pp_dispute_id IS NULL THEN
14:33:51 554  	  SELECT
14:33:51 555  	    RCN_PP_DISPUTE_SEQ.nextVal into var_pp_dispute_id
14:33:51 556  	  FROM DUAL;
14:33:51 557  	ELSE
14:33:51 558  	  var_pp_dispute_id := in_pp_dispute_id;
14:33:51 559  	END IF;
14:33:51 560  	INSERT INTO
14:33:51 561  	  RCN_PP_DISPUTE (
14:33:51 562  	    id,
14:33:51 563  	    rcn_ext_source_log_id,
14:33:51 564  	    dispute_type,
14:33:51 565  	    claimant_name,
14:33:51 566  	    claimant_email,
14:33:51 567  	    transaction_id,
14:33:51 568  	    trans_date,
14:33:51 569  	    disputed_amount,
14:33:51 570  	    disputed_amount_currency,
14:33:51 571  	    dispute_reason,
14:33:51 572  	    dispute_filing_date,
14:33:51 573  	    dispute_status,
14:33:51 574  	    dispute_case_id,
14:33:51 575  	    invoice_id,
14:33:51 576  	    create_date,
14:33:51 577  	    created_by
14:33:51 578  	  ) VALUES (
14:33:51 579  	    var_pp_dispute_id,
14:33:51 580  	    in_ext_source_log_id,
14:33:51 581  	    in_dispute_type,
14:33:51 582  	    in_claimant_name,
14:33:51 583  	    in_claimant_email,
14:33:51 584  	    in_transaction_id,
14:33:51 585  	    in_trans_date,
14:33:51 586  	    in_disputed_amount,
14:33:51 587  	    in_disputed_amount_currency,
14:33:51 588  	    in_dispute_reason,
14:33:51 589  	    in_dispute_filing_date,
14:33:51 590  	    in_dispute_status,
14:33:51 591  	    in_dispute_case_id,
14:33:51 592  	    in_invoice_id,
14:33:51 593  	    var_date,
14:33:51 594  	    in_created_by
14:33:51 595  	  );
14:33:51 596  
14:33:51 597  	out_pp_dispute_id := var_pp_dispute_id;
14:33:51 598  END CREATE_PP_DISPUTE;
14:33:51 599  
14:33:51 600  PROCEDURE CREATE_PP_TRANS_DETAIL (
14:33:51 601  	out_pp_trans_detail_id	     OUT RCN_PP_TRANS_DETAIL.ID%TYPE,
14:33:51 602  	in_pp_trans_detail_id	     IN RCN_PP_TRANS_DETAIL.ID%TYPE DEFAULT NULL,
14:33:51 603  	in_ext_source_log_id	     IN RCN_PP_TRANS_DETAIL.RCN_EXT_SOURCE_LOG_ID%TYPE,
14:33:51 604  	in_invoice_id		     IN RCN_PP_TRANS_DETAIL.INVOICE_ID%TYPE,
14:33:51 605  	in_transaction_id	     IN RCN_PP_TRANS_DETAIL.TRANSACTION_ID%TYPE,
14:33:51 606  	in_pp_ref_id		     IN RCN_PP_TRANS_DETAIL.PP_REF_ID%TYPE,
14:33:51 607  	in_trans_deb_or_cred	     IN RCN_PP_TRANS_DETAIL.TRANS_DEB_OR_CRED%TYPE,
14:33:51 608  	in_trans_init_date	     IN RCN_PP_TRANS_DETAIL.TRANS_INIT_DATE%TYPE,
14:33:51 609  	in_trans_comp_date	     IN RCN_PP_TRANS_DETAIL.TRANS_COMP_DATE%TYPE,
14:33:51 610  	in_gross_trans_amount	     IN RCN_PP_TRANS_DETAIL.GROSS_TRANS_AMOUNT%TYPE,
14:33:51 611  	in_gross_trans_currency      IN RCN_PP_TRANS_DETAIL.GROSS_TRANS_CURRENCY%TYPE,
14:33:51 612  	in_fee_amount		     IN RCN_PP_TRANS_DETAIL.FEE_AMOUNT%TYPE,
14:33:51 613  	in_fee_currency 	     IN RCN_PP_TRANS_DETAIL.FEE_CURRENCY%TYPE,
14:33:51 614  	in_fee_deb_or_cred	     IN RCN_PP_TRANS_DETAIL.FEE_DEB_OR_CRED%TYPE,
14:33:51 615  	in_trans_event_code	     IN RCN_PP_TRANS_DETAIL.TRANS_EVENT_CODE%TYPE,
14:33:51 616  	in_trans_status 	     IN RCN_PP_TRANS_DETAIL.TRANS_STATUS%TYPE,
14:33:51 617  	in_insurance_amount	     IN RCN_PP_TRANS_DETAIL.INSURANCE_AMOUNT%TYPE,
14:33:51 618  	in_sales_tax_amount	     IN RCN_PP_TRANS_DETAIL.SALES_TAX_AMOUNT%TYPE,
14:33:51 619  	in_shipping_amount	     IN RCN_PP_TRANS_DETAIL.SHIPPING_AMOUNT%TYPE,
14:33:51 620  	in_trans_subject	     IN RCN_PP_TRANS_DETAIL.TRANS_SUBJECT%TYPE,
14:33:51 621  	in_trans_note		     IN RCN_PP_TRANS_DETAIL.TRANS_NOTE%TYPE,
14:33:51 622  	in_payer_acct_id	     IN RCN_PP_TRANS_DETAIL.PAYER_ACCT_ID%TYPE,
14:33:51 623  	in_payer_addr_status	     IN RCN_PP_TRANS_DETAIL.PAYER_ADDR_STATUS%TYPE,
14:33:51 624  	in_item_name		     IN RCN_PP_TRANS_DETAIL.ITEM_NAME%TYPE,
14:33:51 625  	in_item_id		     IN RCN_PP_TRANS_DETAIL.ITEM_ID%TYPE,
14:33:51 626  	in_option_1_name	     IN RCN_PP_TRANS_DETAIL.OPTION_1_NAME%TYPE,
14:33:51 627  	in_option_1_value	     IN RCN_PP_TRANS_DETAIL.OPTION_1_VALUE%TYPE,
14:33:51 628  	in_option_2_name	     IN RCN_PP_TRANS_DETAIL.OPTION_2_NAME%TYPE,
14:33:51 629  	in_option_2_value	     IN RCN_PP_TRANS_DETAIL.OPTION_2_VALUE%TYPE,
14:33:51 630  	in_auction_site 	     IN RCN_PP_TRANS_DETAIL.AUCTION_SITE%TYPE,
14:33:51 631  	in_auction_buyer_id	     IN RCN_PP_TRANS_DETAIL.AUCTION_BUYER_ID%TYPE,
14:33:51 632  	in_auction_closing_date      IN RCN_PP_TRANS_DETAIL.AUCTION_CLOSING_DATE%TYPE,
14:33:51 633  	in_shipping_addr_line_1      IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_LINE_1%TYPE,
14:33:51 634  	in_shipping_addr_line_2      IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_LINE_2%TYPE,
14:33:51 635  	in_shipping_addr_city	     IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_CITY%TYPE,
14:33:51 636  	in_shipping_addr_state	     IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_STATE%TYPE,
14:33:51 637  	in_shipping_addr_zip	     IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_ZIP%TYPE,
14:33:51 638  	in_shipping_addr_country     IN RCN_PP_TRANS_DETAIL.SHIPPING_ADDR_COUNTRY%TYPE,
14:33:51 639  	in_custom_field 	     IN RCN_PP_TRANS_DETAIL.CUSTOM_FIELD%TYPE,
14:33:51 640  	in_created_by		     IN RCN_PP_TRANS_DETAIL.CREATED_BY%TYPE
14:33:51 641  ) AS
14:33:51 642  -- VARIABLES
14:33:51 643  var_pp_trans_detail_id RCN_PP_TRANS_DETAIL.ID%TYPE;
14:33:51 644  var_date DATE := SYSDATE;
14:33:51 645  BEGIN
14:33:51 646  	IF in_pp_trans_detail_id IS NULL THEN
14:33:51 647  	  SELECT
14:33:51 648  	    RCN_PP_TRANS_DETAIL_SEQ.nextVal into var_pp_trans_detail_id
14:33:51 649  	  FROM DUAL;
14:33:51 650  	ELSE
14:33:51 651  	  var_pp_trans_detail_id := in_pp_trans_detail_id;
14:33:51 652  	END IF;
14:33:51 653  	INSERT INTO
14:33:51 654  	  RCN_PP_TRANS_DETAIL (
14:33:51 655  	    id,
14:33:51 656  	    rcn_ext_source_log_id,
14:33:51 657  	    transaction_id,
14:33:51 658  	    invoice_id,
14:33:51 659  	    pp_ref_id,
14:33:51 660  	    trans_event_code,
14:33:51 661  	    trans_init_date,
14:33:51 662  	    trans_comp_date,
14:33:51 663  	    trans_deb_or_cred,
14:33:51 664  	    gross_trans_amount,
14:33:51 665  	    gross_trans_currency,
14:33:51 666  	    fee_deb_or_cred,
14:33:51 667  	    fee_amount,
14:33:51 668  	    fee_currency,
14:33:51 669  	    trans_status,
14:33:51 670  	    insurance_amount,
14:33:51 671  	    sales_tax_amount,
14:33:51 672  	    shipping_amount,
14:33:51 673  	    trans_subject,
14:33:51 674  	    trans_note,
14:33:51 675  	    payer_acct_id,
14:33:51 676  	    payer_addr_status,
14:33:51 677  	    item_name,
14:33:51 678  	    item_id,
14:33:51 679  	    option_1_name,
14:33:51 680  	    option_1_value,
14:33:51 681  	    option_2_name,
14:33:51 682  	    option_2_value,
14:33:51 683  	    auction_site,
14:33:51 684  	    auction_buyer_id,
14:33:51 685  	    auction_closing_date,
14:33:51 686  	    shipping_addr_line_1,
14:33:51 687  	    shipping_addr_line_2,
14:33:51 688  	    shipping_addr_city,
14:33:51 689  	    shipping_addr_state,
14:33:51 690  	    shipping_addr_zip,
14:33:51 691  	    shipping_addr_country,
14:33:51 692  	    custom_field,
14:33:51 693  	    create_date,
14:33:51 694  	    created_by
14:33:51 695  	  ) VALUES (
14:33:51 696  	    var_pp_trans_detail_id,
14:33:51 697  	    in_ext_source_log_id,
14:33:51 698  	    in_transaction_id,
14:33:51 699  	    in_invoice_id,
14:33:51 700  	    in_pp_ref_id,
14:33:51 701  	    in_trans_event_code,
14:33:51 702  	    in_trans_init_date,
14:33:51 703  	    in_trans_comp_date,
14:33:51 704  	    in_trans_deb_or_cred,
14:33:51 705  	    in_gross_trans_amount,
14:33:51 706  	    in_gross_trans_currency,
14:33:51 707  	    in_fee_deb_or_cred,
14:33:51 708  	    in_fee_amount,
14:33:51 709  	    in_fee_currency,
14:33:51 710  	    in_trans_status,
14:33:51 711  	    in_insurance_amount,
14:33:51 712  	    in_sales_tax_amount,
14:33:51 713  	    in_shipping_amount,
14:33:51 714  	    in_trans_subject,
14:33:51 715  	    in_trans_note,
14:33:51 716  	    in_payer_acct_id,
14:33:51 717  	    in_payer_addr_status,
14:33:51 718  	    in_item_name,
14:33:51 719  	    in_item_id,
14:33:51 720  	    in_option_1_name,
14:33:51 721  	    in_option_1_value,
14:33:51 722  	    in_option_2_name,
14:33:51 723  	    in_option_2_value,
14:33:51 724  	    in_auction_site,
14:33:51 725  	    in_auction_buyer_id,
14:33:51 726  	    in_auction_closing_date,
14:33:51 727  	    in_shipping_addr_line_1,
14:33:51 728  	    in_shipping_addr_line_2,
14:33:51 729  	    in_shipping_addr_city,
14:33:51 730  	    in_shipping_addr_state,
14:33:51 731  	    in_shipping_addr_zip,
14:33:51 732  	    in_shipping_addr_country,
14:33:51 733  	    in_custom_field,
14:33:51 734  	    var_date,
14:33:51 735  	    in_created_by
14:33:51 736  	  );
14:33:51 737  
14:33:51 738  	out_pp_trans_detail_id := var_pp_trans_detail_id;
14:33:51 739  END CREATE_PP_TRANS_DETAIL;
14:33:51 740  
14:33:51 741  PROCEDURE DELETE_EXT_SOURCE_LOG (
14:33:51 742  	in_record_type		 IN RCN_EXT_SOURCE_LOG.RECORD_TYPE%TYPE,
14:33:51 743  	in_report_file_name	 IN RCN_EXT_SOURCE_LOG.REPORT_FILE_NAME%TYPE
14:33:51 744  ) AS
14:33:51 745  BEGIN
14:33:51 746  	DELETE FROM
14:33:51 747  	  RCN_EXT_SOURCE_LOG
14:33:51 748  	WHERE
14:33:51 749  	  RCN_EXT_SOURCE_LOG.RECORD_TYPE = in_record_type AND
14:33:51 750  	  RCN_EXT_SOURCE_LOG.REPORT_FILE_NAME = in_report_file_name;
14:33:51 751  END DELETE_EXT_SOURCE_LOG;
14:33:51 752  
14:33:51 753  PROCEDURE GET_EXT_SOURCE_LOG (
14:33:51 754  	in_record_type		 IN RCN_EXT_SOURCE_LOG.RECORD_TYPE%TYPE,
14:33:51 755  	in_report_file_name	 IN RCN_EXT_SOURCE_LOG.REPORT_FILE_NAME%TYPE,
14:33:51 756  	out_result_set		 OUT SYS_REFCURSOR
14:33:51 757  ) AS
14:33:51 758  BEGIN
14:33:51 759  	OPEN out_result_set FOR
14:33:51 760  	SELECT * FROM
14:33:51 761  	  RCN_EXT_SOURCE_LOG
14:33:51 762  	WHERE
14:33:51 763  	  RCN_EXT_SOURCE_LOG.RECORD_TYPE = in_record_type AND
14:33:51 764  	  RCN_EXT_SOURCE_LOG.REPORT_FILE_NAME = in_report_file_name;
14:33:51 765  END GET_EXT_SOURCE_LOG;
14:33:51 766  
14:33:51 767  FUNCTION CHECK_EXT_SOURCE_LOG (
14:33:51 768  	in_record_type		 IN RCN_EXT_SOURCE_LOG.RECORD_TYPE%TYPE,
14:33:51 769  	in_report_file_name	 IN RCN_EXT_SOURCE_LOG.REPORT_FILE_NAME%TYPE
14:33:51 770  ) RETURN NUMBER AS
14:33:51 771  var_exists NUMBER;
14:33:51 772  BEGIN
14:33:51 773  	SELECT count(1) INTO var_exists
14:33:51 774  	FROM
14:33:51 775  	  RCN_EXT_SOURCE_LOG
14:33:51 776  	WHERE
14:33:51 777  	  RCN_EXT_SOURCE_LOG.RECORD_TYPE = in_record_type AND
14:33:51 778  	  RCN_EXT_SOURCE_LOG.REPORT_FILE_NAME = in_report_file_name;
14:33:51 779  
14:33:51 780  	IF var_exists > 1 THEN
14:33:51 781  	  var_exists := 1;
14:33:51 782  	END IF;
14:33:51 783  
14:33:51 784  	RETURN var_exists;
14:33:51 785  END;
14:33:51 786  
14:33:51 787  PROCEDURE CREATE_AMEX_CHARGEBACK (
14:33:51 788  	  in_rcn_ext_source_log_id IN RCN_EXT_SOURCE_LOG.ID%TYPE,
14:33:51 789  	  in_resolution IN RCN_AMEX_CHARGEBACK.RESOLUTION%TYPE,
14:33:51 790  	  in_from_system IN RCN_AMEX_CHARGEBACK.FROM_SYSTEM%TYPE,
14:33:51 791  	  in_rejects_to_system IN RCN_AMEX_CHARGEBACK.REJECTS_TO_SYSTEM%TYPE,
14:33:51 792  	  in_disputes_to_system IN RCN_AMEX_CHARGEBACK.DISPUTES_TO_SYSTEM%TYPE,
14:33:51 793  	  in_date_of_adjustment IN RCN_AMEX_CHARGEBACK.DATE_OF_ADJUSTMENT%TYPE,
14:33:51 794  	  in_date_of_charge IN RCN_AMEX_CHARGEBACK.DATE_OF_CHARGE%TYPE,
14:33:51 795  	  in_case_type IN RCN_AMEX_CHARGEBACK.CASE_TYPE%TYPE,
14:33:51 796  	  in_cb_reas_code IN RCN_AMEX_CHARGEBACK.CB_REAS_CODE%TYPE,
14:33:51 797  	  in_cb_amount IN RCN_AMEX_CHARGEBACK.CB_AMOUNT%TYPE,
14:33:51 798  	  in_cb_adjustment_number IN RCN_AMEX_CHARGEBACK.CB_ADJUSTMENT_NUMBER%TYPE,
14:33:51 799  	  in_billed_amount IN RCN_AMEX_CHARGEBACK.BILLED_AMOUNT%TYPE,
14:33:51 800  	  in_soc_amount IN RCN_AMEX_CHARGEBACK.SOC_AMOUNT%TYPE,
14:33:51 801  	  in_foreign_amount IN RCN_AMEX_CHARGEBACK.FOREIGN_AMOUNT%TYPE,
14:33:51 802  	  in_currency IN RCN_AMEX_CHARGEBACK.CURRENCY%TYPE,
14:33:51 803  	  in_note1 IN RCN_AMEX_CHARGEBACK.NOTE1%TYPE,
14:33:51 804  	  in_note2 IN RCN_AMEX_CHARGEBACK.NOTE2%TYPE,
14:33:51 805  	  in_note3 IN RCN_AMEX_CHARGEBACK.NOTE3%TYPE,
14:33:51 806  	  in_note4 IN RCN_AMEX_CHARGEBACK.NOTE4%TYPE,
14:33:51 807  	  in_note5 IN RCN_AMEX_CHARGEBACK.NOTE5%TYPE,
14:33:51 808  	  in_note6 IN RCN_AMEX_CHARGEBACK.NOTE6%TYPE,
14:33:51 809  	  in_note7 IN RCN_AMEX_CHARGEBACK.NOTE7%TYPE,
14:33:51 810  	  in_ind_ref_number IN RCN_AMEX_CHARGEBACK.IND_REF_NUMBER%TYPE,
14:33:51 811  	  in_created_by IN RCN_AMEX_CHARGEBACK.CREATED_BY%TYPE
14:33:51 812  ) AS
14:33:51 813  var_amex_chargeback_id RCN_AMEX_CHARGEBACK.ID%TYPE;
14:33:51 814  var_date DATE := SYSDATE;
14:33:51 815  BEGIN
14:33:51 816  	SELECT
14:33:51 817  	  RCNAMEXCB_ID_SEQ.nextVal into var_amex_chargeback_id
14:33:51 818  	FROM DUAL;
14:33:51 819  
14:33:51 820  	INSERT INTO
14:33:51 821  	  RCN_AMEX_CHARGEBACK (
14:33:51 822  	    id,
14:33:51 823  	    rcn_ext_source_log_id,
14:33:51 824  	    resolution,
14:33:51 825  	    from_system,
14:33:51 826  	    rejects_to_system,
14:33:51 827  	    disputes_to_system,
14:33:51 828  	    date_of_adjustment,
14:33:51 829  	    date_of_charge,
14:33:51 830  	    case_type,
14:33:51 831  	    cb_reas_code,
14:33:51 832  	    cb_amount,
14:33:51 833  	    cb_adjustment_number,
14:33:51 834  	    billed_amount,
14:33:51 835  	    soc_amount,
14:33:51 836  	    foreign_amount,
14:33:51 837  	    currency,
14:33:51 838  	    note1,
14:33:51 839  	    note2,
14:33:51 840  	    note3,
14:33:51 841  	    note4,
14:33:51 842  	    note5,
14:33:51 843  	    note6,
14:33:51 844  	    note7,
14:33:51 845  	    ind_ref_number,
14:33:51 846  	    create_date,
14:33:51 847  	    created_by,
14:33:51 848  	    update_date,
14:33:51 849  	    updated_by
14:33:51 850  	  ) VALUES (
14:33:51 851  	    var_amex_chargeback_id,
14:33:51 852  	    in_rcn_ext_source_log_id,
14:33:51 853  	    in_resolution,
14:33:51 854  	    in_from_system,
14:33:51 855  	    in_rejects_to_system,
14:33:51 856  	    in_disputes_to_system,
14:33:51 857  	    in_date_of_adjustment,
14:33:51 858  	    in_date_of_charge,
14:33:51 859  	    in_case_type,
14:33:51 860  	    in_cb_reas_code,
14:33:51 861  	    in_cb_amount,
14:33:51 862  	    in_cb_adjustment_number,
14:33:51 863  	    in_billed_amount,
14:33:51 864  	    in_soc_amount,
14:33:51 865  	    in_foreign_amount,
14:33:51 866  	    in_currency,
14:33:51 867  	    in_note1,
14:33:51 868  	    in_note2,
14:33:51 869  	    in_note3,
14:33:51 870  	    in_note4,
14:33:51 871  	    in_note5,
14:33:51 872  	    in_note6,
14:33:51 873  	    in_note7,
14:33:51 874  	    in_ind_ref_number,
14:33:51 875  	    var_date,
14:33:51 876  	    in_created_by,
14:33:51 877  	    var_date,
14:33:51 878  	    in_created_by
14:33:51 879  	  );
14:33:51 880  
14:33:51 881  END CREATE_AMEX_CHARGEBACK;
14:33:51 882  
14:33:51 883  END PROCS_RECONCILIATION_CRU_V22;
14:33:51 884  .
14:33:51 SQL> /

Package body created.

Elapsed: 00:00:00.08
14:33:51 SQL> 
14:33:51 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_SUBSCRIPTION_CRU_V22" AS
14:33:51   2  
14:33:51   3  PROCEDURE CREATE_SUBSCRIPTION(
14:33:51   4  	out_subscription_id	     OUT SUBSCRIPTION.ID%TYPE,
14:33:51   5  	in_subscription_id	     IN SUBSCRIPTION.ID%TYPE DEFAULT NULL,
14:33:51   6  	in_suspend_date 	     IN SUBSCRIPTION.SUSPEND_DATE%TYPE DEFAULT NULL,
14:33:51   7  	in_account_id		     IN SUBSCRIPTION.ACCOUNT_ID%TYPE,
14:33:51   8  	in_purchase_date	     IN SUBSCRIPTION.PURCHASE_DATE%TYPE,
14:33:51   9  	in_offer_chain_id	     IN SUBSCRIPTION.OFFER_CHAIN_ID%TYPE,
14:33:51  10  	in_termination_date	     IN SUBSCRIPTION.TERMINATION_DATE%TYPE DEFAULT NULL,
14:33:51  11  	in_days_remainning_ajustment IN SUBSCRIPTION.DAYS_REMAINING_ADJUSTMENT%TYPE DEFAULT NULL,
14:33:51  12  	in_sct_id		     IN SUBSCRIPTION.SCT_ID%TYPE DEFAULT NULL,
14:33:51  13  	in_created_by		     IN SUBSCRIPTION.CREATED_BY%TYPE,
14:33:51  14  	in_instrument_type_id	     IN SUBSCRIPTION.INSTRUMENT_TYPE_ID%TYPE,
14:33:51  15  	in_instrument_id	     IN SUBSCRIPTION.INSTRUMENT_ID%TYPE,
14:33:51  16  	in_subscription_status_id    IN SUBSCRIPTION.SUBSCRIPTION_STATUS_ID%TYPE,
14:33:51  17  	in_cancelation_date	     IN SUBSCRIPTION.CANCELLATION_DATE%TYPE DEFAULT NULL,
14:33:51  18  	in_reactivation_date	     IN SUBSCRIPTION.REACTIVATION_DATE%TYPE DEFAULT NULL
14:33:51  19  ) AS
14:33:51  20  -- VARIABLES
14:33:51  21  var_new_subscription_id SUBSCRIPTION.ID%TYPE;
14:33:51  22  -- arosolovskiy: using data variable instead of direct get data calls (#38860)
14:33:51  23  var_date DATE := SYSDATE;
14:33:51  24  BEGIN
14:33:51  25  	IF in_subscription_id IS NULL THEN
14:33:51  26  	  SELECT
14:33:51  27  	    SUB_ID_SEQ.nextVal into var_new_subscription_id
14:33:51  28  	  FROM DUAL;
14:33:51  29  	ELSE
14:33:51  30  	  var_new_subscription_id := in_subscription_id;
14:33:51  31  	END IF;
14:33:51  32  	INSERT INTO SUBSCRIPTION (
14:33:51  33  	  ID,
14:33:51  34  	  SUSPEND_DATE,
14:33:51  35  	  ACCOUNT_ID,
14:33:51  36  	  PURCHASE_DATE,
14:33:51  37  	  OFFER_CHAIN_ID,
14:33:51  38  	  TERMINATION_DATE,
14:33:51  39  	  DAYS_REMAINING_ADJUSTMENT,
14:33:51  40  	  SCT_ID,
14:33:51  41  	  CREATE_DATE,
14:33:51  42  	  CREATED_BY,
14:33:51  43  	  UPDATE_DATE,
14:33:51  44  	  UPDATED_BY,
14:33:51  45  	  INSTRUMENT_TYPE_ID,
14:33:51  46  	  INSTRUMENT_ID,
14:33:51  47  	  SUBSCRIPTION_STATUS_ID,
14:33:51  48  	  CANCELLATION_DATE,
14:33:51  49  	  REACTIVATION_DATE
14:33:51  50  	) VALUES (
14:33:51  51  	  var_new_subscription_id,
14:33:51  52  	  in_suspend_date,
14:33:51  53  	  in_account_id,
14:33:51  54  	  in_purchase_date,
14:33:51  55  	  in_offer_chain_id,
14:33:51  56  	  in_termination_date,
14:33:51  57  	  in_days_remainning_ajustment,
14:33:51  58  	  in_sct_id,
14:33:51  59  	  var_date,
14:33:51  60  	  in_created_by,
14:33:51  61  	  var_date,
14:33:51  62  	  in_created_by,
14:33:51  63  	  in_instrument_type_id,
14:33:51  64  	  in_instrument_id,
14:33:51  65  	  in_subscription_status_id,
14:33:51  66  	  in_cancelation_date,
14:33:51  67  	  in_reactivation_date
14:33:51  68  	);
14:33:51  69  
14:33:51  70  	out_subscription_id := var_new_subscription_id;
14:33:51  71  END CREATE_SUBSCRIPTION;
14:33:51  72  
14:33:51  73  /******************************************************************************/
14:33:51  74  
14:33:51  75  PROCEDURE UPDATE_SUBSCRIPTION(
14:33:51  76  	in_subscription_id	     IN SUBSCRIPTION.ID%TYPE,
14:33:51  77  	in_suspend_date 	     IN SUBSCRIPTION.SUSPEND_DATE%TYPE DEFAULT NULL,
14:33:51  78  	in_purchase_date	     IN SUBSCRIPTION.PURCHASE_DATE%TYPE DEFAULT NULL,
14:33:51  79  	in_termination_date	     IN SUBSCRIPTION.TERMINATION_DATE%TYPE DEFAULT NULL,
14:33:51  80  	in_days_remainning_ajustment IN SUBSCRIPTION.DAYS_REMAINING_ADJUSTMENT%TYPE DEFAULT NULL,
14:33:51  81  	in_sct_id		     IN SUBSCRIPTION.SCT_ID%TYPE DEFAULT NULL,
14:33:51  82  	in_updated_by		     IN SUBSCRIPTION.CREATED_BY%TYPE,
14:33:51  83  	in_instrument_type_id	     IN SUBSCRIPTION.INSTRUMENT_TYPE_ID%TYPE DEFAULT NULL,
14:33:51  84  	in_instrument_id	     IN SUBSCRIPTION.INSTRUMENT_ID%TYPE DEFAULT NULL,
14:33:51  85  	in_subscription_status_id    IN SUBSCRIPTION.SUBSCRIPTION_STATUS_ID%TYPE DEFAULT NULL,
14:33:51  86  	in_cancelation_date	     IN SUBSCRIPTION.CANCELLATION_DATE%TYPE DEFAULT NULL,
14:33:51  87  	in_reactivation_date	     IN SUBSCRIPTION.REACTIVATION_DATE%TYPE DEFAULT NULL
14:33:51  88  ) AS
14:33:51  89  BEGIN
14:33:51  90  	-- Create history
14:33:51  91  	PROCS_HISTORY_V22.CREATE_SUBSCRIPTION_HISTORY(
14:33:51  92  	  in_subscription_id	       => in_subscription_id,
14:33:51  93  	  in_system_activity_reason_id => GLOBAL_ENUMS_V22.SAC_SYSTEM_APPLIED_RULE
14:33:51  94  	);
14:33:51  95  
14:33:51  96  	UPDATE SUBSCRIPTION SET
14:33:51  97  	  SUSPEND_DATE		    = NVL(in_suspend_date, SUSPEND_DATE),
14:33:51  98  	  PURCHASE_DATE 	    = NVL(in_purchase_date, PURCHASE_DATE),
14:33:51  99  	  TERMINATION_DATE	    = NVL(in_termination_date, TERMINATION_DATE),
14:33:51 100  	  DAYS_REMAINING_ADJUSTMENT = NVL(days_remaining_adjustment, DAYS_REMAINING_ADJUSTMENT),
14:33:51 101  	  SCT_ID		    = NVL(in_sct_id, SCT_ID),
14:33:51 102  	  UPDATE_DATE		    = SYSDATE,
14:33:51 103  	  UPDATED_BY		    = in_updated_by,
14:33:51 104  	  INSTRUMENT_TYPE_ID	    = NVL(in_instrument_type_id, INSTRUMENT_TYPE_ID),
14:33:51 105  	  INSTRUMENT_ID 	    = NVL(in_instrument_id, INSTRUMENT_ID),
14:33:51 106  	  SUBSCRIPTION_STATUS_ID    = NVL(in_subscription_status_id, SUBSCRIPTION_STATUS_ID),
14:33:51 107  	  CANCELLATION_DATE	    = NVL(in_cancelation_date, CANCELLATION_DATE),
14:33:51 108  	  REACTIVATION_DATE	    = NVL(in_reactivation_date, REACTIVATION_DATE)
14:33:51 109  	WHERE
14:33:51 110  	  ID = in_subscription_id;
14:33:51 111  END UPDATE_SUBSCRIPTION;
14:33:51 112  
14:33:51 113  /******************************************************************************/
14:33:51 114  
14:33:51 115  PROCEDURE CREATE_SUBSCRIPTION_NOTE (
14:33:51 116  	inout_subscription_note_id IN OUT SUBSCRIPTION_NOTE.ID%TYPE,
14:33:51 117  	in_agent_id		   IN SUBSCRIPTION_NOTE.AGENT_ID%TYPE,
14:33:51 118  	in_subscription_id	   IN SUBSCRIPTION_NOTE.ID%TYPE,
14:33:51 119  	in_note 		   IN SUBSCRIPTION_NOTE.NOTE%TYPE,
14:33:51 120  	in_created_by		   IN SUBSCRIPTION_NOTE.CREATED_BY%TYPE
14:33:51 121  ) AS
14:33:51 122  BEGIN
14:33:51 123  	IF inout_subscription_note_id IS NULL THEN
14:33:51 124  	  SELECT
14:33:51 125  	    SUBN_ID_SEQ.nextVal into inout_subscription_note_id
14:33:51 126  	  FROM DUAL;
14:33:51 127  	END IF;
14:33:51 128  	INSERT INTO SUBSCRIPTION_NOTE (
14:33:51 129  	  ID,
14:33:51 130  	  AGENT_ID,
14:33:51 131  	  SUBSCRIPTION_ID,
14:33:51 132  	  NOTE,
14:33:51 133  	  CREATE_DATE,
14:33:51 134  	  CREATED_BY
14:33:51 135  	) VALUES (
14:33:51 136  	  inout_subscription_note_id,
14:33:51 137  	  in_agent_id,
14:33:51 138  	  in_subscription_id,
14:33:51 139  	  in_note,
14:33:51 140  	  SYSDATE,
14:33:51 141  	  in_created_by
14:33:51 142  	);
14:33:51 143  END CREATE_SUBSCRIPTION_NOTE;
14:33:51 144  
14:33:51 145  END PROCS_SUBSCRIPTION_CRU_V22;
14:33:51 146  .
14:33:51 SQL> /

Package body created.

Elapsed: 00:00:00.02
14:33:51 SQL> 
14:33:51 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_TAXES_CRU_V22" AS
14:33:51   2  
14:33:51   3  PROCEDURE CREATE_TAX (
14:33:51   4  	inout_tax_id		 IN OUT NUMBER,
14:33:51   5  	in_tax_type_id		 IN NUMBER,
14:33:51   6  	in_calculated_amount	 IN NUMBER,
14:33:51   7  	in_created_by		 IN VARCHAR2,
14:33:51   8  	in_line_item_id 	 IN NUMBER,
14:33:51   9  	in_effective_rate	 IN VARCHAR2,
14:33:51  10  	in_taxable_amount	 IN NUMBER,
14:33:51  11  	in_tax_rule_id		 IN NUMBER,
14:33:51  12  	in_jurisdiction_level_id IN NUMBER,
14:33:51  13  	in_jurisdiction_name	 IN VARCHAR2,
14:33:51  14  	in_jurisdiction_id	 IN VARCHAR2,
14:33:51  15  	in_ext_tax_type 	 IN VARCHAR2,
14:33:51  16  	in_ext_result		 IN VARCHAR2,
14:33:51  17  	in_imposition_type	 IN VARCHAR2,
14:33:51  18  	in_imposition		 IN VARCHAR2
14:33:51  19  ) AS
14:33:51  20  var_date DATE := SYSDATE;
14:33:51  21  BEGIN
14:33:51  22  
14:33:51  23  	IF inout_tax_id IS NULL THEN
14:33:51  24  	  SELECT
14:33:51  25  	    TAX_ID_SEQ.nextVal into inout_tax_id
14:33:51  26  	  FROM DUAL;
14:33:51  27  	END IF;
14:33:51  28  
14:33:51  29  	INSERT INTO TAX (
14:33:51  30  	  ID,
14:33:51  31  	  TAX_TYPE_ID,
14:33:51  32  	  CALCULATED_AMOUNT,
14:33:51  33  	  CREATE_DATE,
14:33:51  34  	  CREATED_BY,
14:33:51  35  	  LINE_ITEM_ID,
14:33:51  36  	  EFFECTIVE_RATE,
14:33:51  37  	  TAXABLE_AMOUNT,
14:33:51  38  	  TAX_RULE_ID,
14:33:51  39  	  JURISDICTION_LEVEL_ID,
14:33:51  40  	  JURISDICTION_NAME,
14:33:51  41  	  JURISDICTION_ID,
14:33:51  42  	  EXT_TAX_TYPE,
14:33:51  43  	  EXT_RESULT,
14:33:51  44  	  IMPOSITION_TYPE,
14:33:51  45  	  IMPOSITION
14:33:51  46  	) VALUES (
14:33:51  47  	  inout_tax_id,
14:33:51  48  	  in_tax_type_id,
14:33:51  49  	  in_calculated_amount,
14:33:51  50  	  var_date,
14:33:51  51  	  in_created_by,
14:33:51  52  	  in_line_item_id,
14:33:51  53  	  in_effective_rate,
14:33:51  54  	  in_taxable_amount,
14:33:51  55  	  in_tax_rule_id,
14:33:51  56  	  in_jurisdiction_level_id,
14:33:51  57  	  in_jurisdiction_name,
14:33:51  58  	  in_jurisdiction_id,
14:33:51  59  	  in_ext_tax_type,
14:33:51  60  	  in_ext_result,
14:33:51  61  	  in_imposition_type,
14:33:51  62  	  in_imposition
14:33:51  63  	);
14:33:51  64  
14:33:51  65  END CREATE_TAX;
14:33:51  66  
14:33:51  67  END PROCS_TAXES_CRU_V22;
14:33:51  68  .
14:33:51 SQL> /

Package body created.

Elapsed: 00:00:00.04
14:33:52 SQL> 
14:33:52 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_TRANSACTION_CRU_V22" AS
14:33:52   2  
14:33:52   3  PROCEDURE CREATE_TRANSACTION (
14:33:52   4  	out_transaction_id	 OUT TRANSACTION.ID%TYPE,
14:33:52   5  	in_transaction_id	 IN TRANSACTION.ID%TYPE DEFAULT NULL,
14:33:52   6  	in_transaction_status_id IN TRANSACTION.TRANSACTION_STATUS_ID%TYPE,
14:33:52   7  	in_transaction_amount	 IN TRANSACTION.TRANSACTION_AMOUNT%TYPE,
14:33:52   8  	in_created_by		 IN TRANSACTION.CREATED_BY%TYPE,
14:33:52   9  	in_order_id		 IN TRANSACTION.ORDER_ID%TYPE,
14:33:52  10  	in_is_refund		 IN TRANSACTION.IS_REFUND%TYPE DEFAULT GLOBAL_CONSTANTS_V22.FALSE,
14:33:52  11  	in_transaction_type_code IN TRANSACTION.TRANSACTION_TYPE_CODE%TYPE DEFAULT NULL
14:33:52  12  ) AS
14:33:52  13  -- VARIABLES
14:33:52  14  var_transaction_id TRANSACTION.ID%TYPE;
14:33:52  15  -- arosolovskiy: using data variable instead of direct get data calls (#38860)
14:33:52  16  var_date DATE := SYSDATE;
14:33:52  17  BEGIN
14:33:52  18  	IF in_transaction_id IS NULL THEN
14:33:52  19  	  SELECT
14:33:52  20  	    TRN_ID_SEQ.nextVal into var_transaction_id
14:33:52  21  	  FROM DUAL;
14:33:52  22  	ELSE
14:33:52  23  	  var_transaction_id := in_transaction_id;
14:33:52  24  	END IF;
14:33:52  25  	INSERT INTO
14:33:52  26  	  TRANSACTION (
14:33:52  27  	    ID,
14:33:52  28  	    TRANSACTION_STATUS_ID,
14:33:52  29  	    TRANSACTION_AMOUNT,
14:33:52  30  	    CREATE_DATE,
14:33:52  31  	    CREATED_BY,
14:33:52  32  	    UPDATE_DATE,
14:33:52  33  	    UPDATED_BY,
14:33:52  34  	    ORDER_ID,
14:33:52  35  	    IS_REFUND,
14:33:52  36  	    TRANSACTION_TYPE_CODE
14:33:52  37  	  ) VALUES (
14:33:52  38  	    var_transaction_id,
14:33:52  39  	    in_transaction_status_id,
14:33:52  40  	    in_transaction_amount,
14:33:52  41  	    var_date,
14:33:52  42  	    in_created_by,
14:33:52  43  	    var_date,
14:33:52  44  	    in_created_by,
14:33:52  45  	    in_order_id,
14:33:52  46  	    in_is_refund,
14:33:52  47  	    in_transaction_type_code
14:33:52  48  	  );
14:33:52  49  
14:33:52  50  	out_transaction_id := var_transaction_id;
14:33:52  51  END CREATE_TRANSACTION;
14:33:52  52  
14:33:52  53  /*******************************************************************/
14:33:52  54  
14:33:52  55  PROCEDURE UPDATE_TRANSACTION (
14:33:52  56  	in_transaction_id	 IN TRANSACTION.ID%TYPE,
14:33:52  57  	in_transaction_status_id IN TRANSACTION.TRANSACTION_STATUS_ID%TYPE DEFAULT NULL,
14:33:52  58  	in_transaction_amount	 IN TRANSACTION.TRANSACTION_AMOUNT%TYPE DEFAULT NULL,
14:33:52  59  	in_updated_by		 IN TRANSACTION.CREATED_BY%TYPE,
14:33:52  60  	in_order_id		 IN TRANSACTION.ORDER_ID%TYPE DEFAULT NULL,
14:33:52  61  	in_is_settled		 IN TRANSACTION.IS_SETTLED%TYPE DEFAULT NULL
14:33:52  62  ) AS
14:33:52  63  BEGIN
14:33:52  64  	-- Create history
14:33:52  65  	PROCS_HISTORY_V22.CREATE_TRANSACTION_HISTORY(
14:33:52  66  	  in_transaction_id	       => in_transaction_id,
14:33:52  67  	  in_system_activity_reason_id => GLOBAL_ENUMS_V22.SAC_SYSTEM_APPLIED_RULE
14:33:52  68  	);
14:33:52  69  	UPDATE
14:33:52  70  	  TRANSACTION
14:33:52  71  	SET
14:33:52  72  	  TRANSACTION_STATUS_ID = NVL(in_transaction_status_id, TRANSACTION_STATUS_ID),
14:33:52  73  	  TRANSACTION_AMOUNT	= NVL(in_transaction_amount, TRANSACTION_AMOUNT),
14:33:52  74  	  UPDATE_DATE		= SYSDATE,
14:33:52  75  	  UPDATED_BY		= in_updated_by,
14:33:52  76  	  ORDER_ID		= NVL(in_order_id, ORDER_ID),
14:33:52  77  	  IS_SETTLED		= NVL(in_is_settled, IS_SETTLED)
14:33:52  78  	WHERE
14:33:52  79  	  ID = in_transaction_id;
14:33:52  80  END UPDATE_TRANSACTION;
14:33:52  81  
14:33:52  82  /*******************************************************************/
14:33:52  83  
14:33:52  84  PROCEDURE READ_TRANSACTION (
14:33:52  85  	in_transaction_id IN TRANSACTION.ID%TYPE,
14:33:52  86  	out_result_set	  OUT SYS_REFCURSOR
14:33:52  87  ) AS
14:33:52  88  BEGIN
14:33:52  89  	OPEN out_result_set FOR
14:33:52  90  	SELECT
14:33:52  91  	  ID,
14:33:52  92  	  TRANSACTION_STATUS_ID,
14:33:52  93  	  TRANSACTION_TYPE_CODE,
14:33:52  94  	  TRANSACTION_AMOUNT,
14:33:52  95  	  CREATE_DATE,
14:33:52  96  	  CREATED_BY,
14:33:52  97  	  UPDATE_DATE,
14:33:52  98  	  UPDATED_BY,
14:33:52  99  	  ORDER_ID,
14:33:52 100  	  IS_REFUND,
14:33:52 101  	  IS_SETTLED
14:33:52 102  	FROM
14:33:52 103  	  TRANSACTION
14:33:52 104  	WHERE
14:33:52 105  	  ID = in_transaction_id;
14:33:52 106  END READ_TRANSACTION;
14:33:52 107  
14:33:52 108  /*******************************************************************/
14:33:52 109  
14:33:52 110  PROCEDURE CREATE_TRANSACTION_ATTEMPT(
14:33:52 111  	inout_transaction_attempt_id IN OUT TRANSACTION_ATTEMPT.ID%TYPE,
14:33:52 112  	in_transaction_id	     IN TRANSACTION_ATTEMPT.TRANSACTION_ID%TYPE,
14:33:52 113  	in_external_status_code      IN TRANSACTION_ATTEMPT.EXTERNAL_STATUS_CODE%TYPE DEFAULT NULL,
14:33:52 114  	in_external_status_message   IN TRANSACTION_ATTEMPT.EXTERNAL_STATUS_MESSAGE%TYPE DEFAULT NULL,
14:33:52 115  	in_created_by		     IN TRANSACTION_ATTEMPT.CREATED_BY%TYPE,
14:33:52 116  	in_external_transaction_id   IN TRANSACTION_ATTEMPT.EXTERNAL_TRANSACTION_ID%TYPE DEFAULT NULL,
14:33:52 117  	in_transaction_start_time    IN TRANSACTION_ATTEMPT.TRANSACTION_START_TIME%TYPE DEFAULT NULL,
14:33:52 118  	in_status_id		     IN TRANSACTION_ATTEMPT.TRANSACTION_ATTEMPT_STATUS_ID%TYPE
14:33:52 119  ) AS
14:33:52 120  BEGIN
14:33:52 121  	IF inout_transaction_attempt_id IS NULL THEN
14:33:52 122  	  SELECT
14:33:52 123  	    TRNA_ID_SEQ.nextVal into inout_transaction_attempt_id
14:33:52 124  	  FROM DUAL;
14:33:52 125  	END IF;
14:33:52 126  	INSERT INTO TRANSACTION_ATTEMPT (
14:33:52 127  	  ID,
14:33:52 128  	  TRANSACTION_ID,
14:33:52 129  	  EXTERNAL_STATUS_CODE,
14:33:52 130  	  EXTERNAL_STATUS_MESSAGE,
14:33:52 131  	  CREATE_DATE,
14:33:52 132  	  CREATED_BY,
14:33:52 133  	  EXTERNAL_TRANSACTION_ID,
14:33:52 134  	  TRANSACTION_START_TIME,
14:33:52 135  	  TRANSACTION_ATTEMPT_STATUS_ID
14:33:52 136  	) VALUES (
14:33:52 137  	  inout_transaction_attempt_id,
14:33:52 138  	  in_transaction_id,
14:33:52 139  	  in_external_status_code,
14:33:52 140  	  in_external_status_message,
14:33:52 141  	  SYSDATE,
14:33:52 142  	  in_created_by,
14:33:52 143  	  in_external_transaction_id,
14:33:52 144  	  in_transaction_start_time,
14:33:52 145  	  in_status_id
14:33:52 146  	);
14:33:52 147  END;
14:33:52 148  
14:33:52 149  /*******************************************************************/
14:33:52 150  
14:33:52 151  PROCEDURE UPDATE_TRANSACTION_ATTEMPT (
14:33:52 152  	in_transaction_attempt_id  IN TRANSACTION_ATTEMPT.ID%TYPE,
14:33:52 153  	in_external_status_code    IN TRANSACTION_ATTEMPT.EXTERNAL_STATUS_CODE%TYPE DEFAULT NULL,
14:33:52 154  	in_external_status_message IN TRANSACTION_ATTEMPT.EXTERNAL_STATUS_MESSAGE%TYPE DEFAULT NULL,
14:33:52 155  	in_external_transaction_id IN TRANSACTION_ATTEMPT.EXTERNAL_TRANSACTION_ID%TYPE DEFAULT NULL,
14:33:52 156  	in_transaction_start_time  IN TRANSACTION_ATTEMPT.TRANSACTION_START_TIME%TYPE DEFAULT NULL,
14:33:52 157  	in_status_id		   IN TRANSACTION_ATTEMPT.TRANSACTION_ATTEMPT_STATUS_ID%TYPE
14:33:52 158  ) AS
14:33:52 159  BEGIN
14:33:52 160  	UPDATE
14:33:52 161  	  TRANSACTION_ATTEMPT
14:33:52 162  	SET
14:33:52 163  	  EXTERNAL_STATUS_CODE		= NVL(in_external_status_code, EXTERNAL_STATUS_CODE),
14:33:52 164  	  EXTERNAL_STATUS_MESSAGE	= NVL(in_external_status_message, EXTERNAL_STATUS_MESSAGE),
14:33:52 165  	  EXTERNAL_TRANSACTION_ID	= NVL(in_external_transaction_id, EXTERNAL_TRANSACTION_ID),
14:33:52 166  	  TRANSACTION_START_TIME	= NVL(in_transaction_start_time, TRANSACTION_START_TIME),
14:33:52 167  	  TRANSACTION_ATTEMPT_STATUS_ID = NVL(in_status_id, TRANSACTION_ATTEMPT_STATUS_ID)
14:33:52 168  	WHERE
14:33:52 169  	  ID = in_transaction_attempt_id;
14:33:52 170  END;
14:33:52 171  
14:33:52 172  /*******************************************************************/
14:33:52 173  
14:33:52 174  PROCEDURE UPDATE_TRANSACTION_ORDER_ID (
14:33:52 175  /*
14:33:52 176  Throws exceptions:
14:33:52 177  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:52 178  APP_EXCEPTION_CODES_V22.INTRNAL_ERROR
14:33:52 179  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:52 180  */
14:33:52 181  	in_transaction_id IN TRANSACTION.ID%TYPE,
14:33:52 182  	in_order_id	  IN TRANSACTION.ORDER_ID%TYPE,
14:33:52 183  	in_updated_by	  IN TRANSACTION.UPDATED_BY%TYPE
14:33:52 184  ) AS
14:33:52 185  SPROC_NAME CONSTANT VARCHAR2(27) := 'UPDATE_TRANSACTION_ORDER_ID';
14:33:52 186  -- EXCEPTIONS
14:33:52 187  BAD_TRANSACTION_ID EXCEPTION;
14:33:52 188  BEGIN
14:33:52 189  
14:33:52 190  	PROCS_HISTORY_V22.CREATE_TRANSACTION_HISTORY(
14:33:52 191  	  in_transaction_id	       => in_transaction_id,
14:33:52 192  	  in_system_activity_reason_id => GLOBAL_ENUMS_V22.SAC_SYSTEM_APPLIED_RULE
14:33:52 193  	);
14:33:52 194  
14:33:52 195  	UPDATE
14:33:52 196  	  TRANSACTION
14:33:52 197  	SET
14:33:52 198  	  TRANSACTION.ORDER_ID	 = in_order_id,
14:33:52 199  	  TRANSACTION.UPDATED_BY = in_updated_by,
14:33:52 200  	  TRANSACTION.UPDATE_DATE= SYSDATE
14:33:52 201  	WHERE
14:33:52 202  	  TRANSACTION.ID = in_transaction_id
14:33:52 203  	  AND TRANSACTION.ORDER_ID IS NULL;
14:33:52 204  
14:33:52 205  	IF SQL%ROWCOUNT = 0 THEN
14:33:52 206  	  RAISE BAD_TRANSACTION_ID;
14:33:52 207  	END IF;
14:33:52 208  EXCEPTION
14:33:52 209  WHEN BAD_TRANSACTION_ID THEN
14:33:52 210  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:52 211  	  SPROC_NAME, 'No such transaction');
14:33:52 212  END UPDATE_TRANSACTION_ORDER_ID;
14:33:52 213  
14:33:52 214  END PROCS_TRANSACTION_CRU_V22;
14:33:52 215  .
14:33:52 SQL> /

Package body created.

Elapsed: 00:00:00.08
14:33:52 SQL> 
14:33:52 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_ADDRESS_V22" AS
14:33:52   2  
14:33:52   3  PROCEDURE CREATE_ADDRESS(
14:33:52   4  /*
14:33:52   5  Throws exceptions:
14:33:52   6  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:52   7  */
14:33:52   8  	  out_address_id	OUT NUMBER,
14:33:52   9  	  in_address1		IN ADDRESS.ADDRESS1%TYPE DEFAULT NULL,
14:33:52  10  	  in_address2		IN ADDRESS.ADDRESS2%TYPE DEFAULT NULL,
14:33:52  11  	  in_city		IN ADDRESS.CITY%TYPE DEFAULT NULL,
14:33:52  12  	  in_state		IN ADDRESS.STATE%TYPE DEFAULT NULL,
14:33:52  13  	  in_postal_code	IN ADDRESS.POSTAL_CODE%TYPE DEFAULT NULL,
14:33:52  14  	  in_country		IN ADDRESS.COUNTRY%TYPE DEFAULT NULL,
14:33:52  15  	  in_created_by 	IN ADDRESS.CREATED_BY%TYPE
14:33:52  16  ) AS
14:33:52  17  -- VARIABLES
14:33:52  18  SPROC_NAME	 CONSTANT VARCHAR2(14) := 'CREATE_ADDRESS';
14:33:52  19  -- EXCEPTIONS
14:33:52  20  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:52  21  BEGIN
14:33:52  22  
14:33:52  23  	CORE_OWNER.PROCS_ADDRESS_CRU_V22.CREATE_ADDRESS(
14:33:52  24  	  out_address_id      => out_address_id,
14:33:52  25  	  in_address_id       => null,
14:33:52  26  	  in_address1	      => in_address1,
14:33:52  27  	  in_address2	      => in_address2,
14:33:52  28  	  in_city	      => in_city,
14:33:52  29  	  in_state	      => in_state,
14:33:52  30  	  in_postal_code      => in_postal_code,
14:33:52  31  	  in_country	      => in_country,
14:33:52  32  	  in_created_by       => in_created_by
14:33:52  33  	);
14:33:52  34  
14:33:52  35  END CREATE_ADDRESS;
14:33:52  36  
14:33:52  37  PROCEDURE UPDATE_ADDRESS(
14:33:52  38  /*
14:33:52  39  Throws exceptions:
14:33:52  40  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:52  41  */
14:33:52  42  	  in_address_id 	IN ADDRESS.ID%TYPE,
14:33:52  43  	  in_address1		IN ADDRESS.ADDRESS1%TYPE DEFAULT NULL,
14:33:52  44  	  in_address2		IN ADDRESS.ADDRESS2%TYPE DEFAULT NULL,
14:33:52  45  	  in_city		IN ADDRESS.CITY%TYPE DEFAULT NULL,
14:33:52  46  	  in_state		IN ADDRESS.STATE%TYPE DEFAULT NULL,
14:33:52  47  	  in_postal_code	IN ADDRESS.POSTAL_CODE%TYPE DEFAULT NULL,
14:33:52  48  	  in_country		IN ADDRESS.COUNTRY%TYPE DEFAULT NULL,
14:33:52  49  	  in_updated_by 	IN ADDRESS.UPDATED_BY%TYPE
14:33:52  50  ) AS
14:33:52  51  BEGIN
14:33:52  52  	CORE_OWNER.PROCS_ADDRESS_CRU_V22.UPDATE_ADDRESS(
14:33:52  53  	  in_address_id 	=> in_address_id,
14:33:52  54  	  in_address1		=> in_address1,
14:33:52  55  	  in_address2		=> in_address2,
14:33:52  56  	  in_city		=> in_city,
14:33:52  57  	  in_state		=> in_state,
14:33:52  58  	  in_postal_code	=> in_postal_code,
14:33:52  59  	  in_country		=> in_country,
14:33:52  60  	  in_updated_by 	=> in_updated_by
14:33:52  61  	);
14:33:52  62  END UPDATE_ADDRESS;
14:33:52  63  
14:33:52  64  PROCEDURE GET_ADDRESS (
14:33:52  65  /*
14:33:52  66  Throws exceptions:
14:33:52  67  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:52  68  */
14:33:52  69  	  in_id 		IN ADDRESS.ID%TYPE,
14:33:52  70  	  out_result_set	OUT SYS_REFCURSOR
14:33:52  71  ) AS
14:33:52  72  SPROC_NAME CONSTANT VARCHAR2(11) := 'GET_ADDRESS';
14:33:52  73  BEGIN
14:33:52  74  
14:33:52  75  OPEN out_result_set FOR
14:33:52  76  SELECT * FROM ADDRESS WHERE ADDRESS.ID = in_id;
14:33:52  77  
14:33:52  78  END GET_ADDRESS;
14:33:52  79  
14:33:52  80  END PROCS_ADDRESS_V22;
14:33:52  81  .
14:33:52 SQL> /

Package body created.

Elapsed: 00:00:00.02
14:33:52 SQL> 
14:33:52 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_ADJUSTMENTS_V22" AS
14:33:52   2  
14:33:52   3  PROCEDURE CREATE_INVOICE_ADJUSTMENT (
14:33:52   4  	in_invoice_id		  IN NUMBER,
14:33:52   5  	in_adjustment_reason	  IN VARCHAR2,
14:33:52   6  	in_is_credit		  IN NUMBER,
14:33:52   7  	in_charge_id		  IN NUMBER,
14:33:52   8  	in_business_date	  IN DATE,
14:33:52   9  	in_created_by		  IN VARCHAR2,
14:33:52  10  	out_invoice_adjustment_id OUT NUMBER
14:33:52  11  ) AS
14:33:52  12  SPROC_NAME CONSTANT VARCHAR2(25) := 'CREATE_INVOICE_ADJUSTMENT';
14:33:52  13  -- VARIABLES
14:33:52  14  var_current_date	    DATE := SYSDATE;
14:33:52  15  var_new_entity_id     NUMBER;
14:33:52  16  var_inv_adj_reason_id NUMBER;
14:33:52  17  -- EXCEPTIONS
14:33:52  18  BAD_IN_IS_CREDIT_VALUE EXCEPTION;
14:33:52  19  DAB_ADJUSTMENT_REASON  EXCEPTION;
14:33:52  20  BEGIN
14:33:52  21  
14:33:52  22  	IF in_is_credit != GLOBAL_CONSTANTS_V22.TRUE AND in_is_credit != GLOBAL_CONSTANTS_V22.FALSE THEN
14:33:52  23  	  RAISE BAD_IN_IS_CREDIT_VALUE;
14:33:52  24  	END IF;
14:33:52  25  
14:33:52  26  	BEGIN
14:33:52  27  	  SELECT
14:33:52  28  	    ID into var_inv_adj_reason_id
14:33:52  29  	  FROM
14:33:52  30  	    INVOICE_ADJUSTMENT_REASON
14:33:52  31  	  WHERE
14:33:52  32  	    UPPER(VALUE) = UPPER(in_adjustment_reason);
14:33:52  33  	  EXCEPTION
14:33:52  34  	    WHEN NO_DATA_FOUND THEN
14:33:52  35  	      RAISE DAB_ADJUSTMENT_REASON;
14:33:52  36  	END;
14:33:52  37  
14:33:52  38  	SELECT
14:33:52  39  	  INV_ADJ_ID_SEQ.nextVal into var_new_entity_id
14:33:52  40  	FROM
14:33:52  41  	  DUAL;
14:33:52  42  
14:33:52  43  	INSERT INTO INVOICE_ADJUSTMENT (
14:33:52  44  	  ID,
14:33:52  45  	  INVOICE_ID,
14:33:52  46  	  INVOICE_ADJUSTMENT_REASON_ID,
14:33:52  47  	  IS_CREDIT,
14:33:52  48  	  CHARGE_ID,
14:33:52  49  	  ADJUSTMENT_DATE,
14:33:52  50  	  CREATE_DATE,
14:33:52  51  	  CREATED_BY,
14:33:52  52  	  UPDATE_DATE,
14:33:52  53  	  UPDATED_BY
14:33:52  54  	)
14:33:52  55  	VALUES (
14:33:52  56  	  var_new_entity_id,
14:33:52  57  	  in_invoice_id,
14:33:52  58  	  var_inv_adj_reason_id,
14:33:52  59  	  in_is_credit,
14:33:52  60  	  in_charge_id,
14:33:52  61  	  in_business_date,
14:33:52  62  	  var_current_date,
14:33:52  63  	  in_created_by,
14:33:52  64  	  var_current_date,
14:33:52  65  	  in_created_by
14:33:52  66  	);
14:33:52  67  
14:33:52  68  	out_invoice_adjustment_id := var_new_entity_id;
14:33:52  69  
14:33:52  70  EXCEPTION
14:33:52  71  WHEN BAD_IN_IS_CREDIT_VALUE THEN
14:33:52  72  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:52  73  	  SPROC_NAME, 'Bad in_is_credit value');
14:33:52  74  WHEN DAB_ADJUSTMENT_REASON THEN
14:33:52  75  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:52  76  	  SPROC_NAME, 'Bad adjustment reason');
14:33:52  77  WHEN OTHERS THEN
14:33:52  78  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52  79  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52  80  END CREATE_INVOICE_ADJUSTMENT;
14:33:52  81  
14:33:52  82  /******************************************************************************/
14:33:52  83  
14:33:52  84  PROCEDURE UPDATE_INVOICE_ADJUSTMENT (
14:33:52  85  	  in_invoice_id 	    IN NUMBER,
14:33:52  86  	  in_original_charge_id     IN NUMBER,
14:33:52  87  	  in_charge_id		    IN NUMBER,
14:33:52  88  	  in_updated_by 	    IN VARCHAR2
14:33:52  89  ) AS
14:33:52  90  SPROC_NAME CONSTANT VARCHAR2(32) := 'UPDATE_INVOICE_ADJUSTMENT';
14:33:52  91  var_invoice_adjustment_id NUMBER;
14:33:52  92  BEGIN
14:33:52  93  	SELECT
14:33:52  94  	  id into var_invoice_adjustment_id
14:33:52  95  	FROM
14:33:52  96  	  INVOICE_ADJUSTMENT
14:33:52  97  	WHERE INVOICE_ID = in_invoice_id
14:33:52  98  	      AND CHARGE_ID = in_original_charge_id;
14:33:52  99  
14:33:52 100  	--create history
14:33:52 101  	PROCS_HISTORY_V22.CREATE_INVOICE_ADJ_HISTORY(
14:33:52 102  	  in_invoice_adjustment_id    => var_invoice_adjustment_id,
14:33:52 103  	  in_system_activity_reason_id => GLOBAL_ENUMS_V22.SAC_SYSTEM_APPLIED_RULE
14:33:52 104  	);
14:33:52 105  
14:33:52 106  	UPDATE INVOICE_ADJUSTMENT
14:33:52 107  	SET CHARGE_ID = in_charge_id, UPDATE_DATE=sysdate, UPDATED_BY=in_updated_by
14:33:52 108  	WHERE ID = var_invoice_adjustment_id;
14:33:52 109  
14:33:52 110  EXCEPTION
14:33:52 111  WHEN NO_DATA_FOUND THEN
14:33:52 112  	    NULL;
14:33:52 113  END UPDATE_INVOICE_ADJUSTMENT;
14:33:52 114  
14:33:52 115  /******************************************************************************/
14:33:52 116  
14:33:52 117  PROCEDURE CREATE_LINE_ITEM_ADJUSTMENT (
14:33:52 118  	in_line_item_id 	    IN NUMBER,
14:33:52 119  	in_invoice_adjustment_id    IN NUMBER,
14:33:52 120  	in_amount		    IN NUMBER,
14:33:52 121  	in_tax			    IN NUMBER,
14:33:52 122  	in_discount		    IN NUMBER,
14:33:52 123  	in_created_by		    IN VARCHAR2,
14:33:52 124  	out_line_item_adjustment_id OUT NUMBER
14:33:52 125  ) AS
14:33:52 126  SPROC_NAME CONSTANT VARCHAR2(30) := 'CREATE_LINE_ITEM_ADJUSTMENT';
14:33:52 127  -- VARIABLES
14:33:52 128  var_current_date DATE := SYSDATE;
14:33:52 129  var_new_entity_id NUMBER;
14:33:52 130  BEGIN
14:33:52 131  
14:33:52 132  	SELECT
14:33:52 133  	  LI_ADJ_ID_SEQ.nextVal into var_new_entity_id
14:33:52 134  	FROM
14:33:52 135  	  DUAL;
14:33:52 136  
14:33:52 137  	INSERT INTO LINE_ITEM_ADJUSTMENT (
14:33:52 138  	  ID,
14:33:52 139  	  LINE_ITEM_ID,
14:33:52 140  	  INVOICE_ADJUSTMENT_ID,
14:33:52 141  	  AMOUNT,
14:33:52 142  	  TAX,
14:33:52 143  	  DISCOUNT,
14:33:52 144  	  CREATE_DATE,
14:33:52 145  	  CREATED_BY
14:33:52 146  	)
14:33:52 147  	VALUES (
14:33:52 148  	  var_new_entity_id,
14:33:52 149  	  in_line_item_id,
14:33:52 150  	  in_invoice_adjustment_id,
14:33:52 151  	  in_amount,
14:33:52 152  	  in_tax,
14:33:52 153  	  in_discount,
14:33:52 154  	  var_current_date,
14:33:52 155  	  in_created_by
14:33:52 156  	);
14:33:52 157  
14:33:52 158  	out_line_item_adjustment_id := var_new_entity_id;
14:33:52 159  
14:33:52 160  EXCEPTION
14:33:52 161  WHEN OTHERS THEN
14:33:52 162  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52 163  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52 164  END CREATE_LINE_ITEM_ADJUSTMENT;
14:33:52 165  
14:33:52 166  /******************************************************************************/
14:33:52 167  
14:33:52 168  PROCEDURE CREATE_TAX_ADJUSTMENT (
14:33:52 169  	in_tax_id		   IN NUMBER,
14:33:52 170  	in_line_item_adjustment_id IN NUMBER,
14:33:52 171  	in_amount		   IN NUMBER,
14:33:52 172  	in_created_by		   IN VARCHAR2,
14:33:52 173  	out_tax_adjustment_id	   OUT NUMBER
14:33:52 174  ) AS
14:33:52 175  SPROC_NAME CONSTANT VARCHAR2(30) := 'CREATE_TAX_ADJUSTMENT';
14:33:52 176  -- VARIABLES
14:33:52 177  var_current_date DATE := SYSDATE;
14:33:52 178  var_new_entity_id NUMBER;
14:33:52 179  BEGIN
14:33:52 180  
14:33:52 181  	SELECT
14:33:52 182  	  TAXADJ_ID_SEQ.nextVal into var_new_entity_id
14:33:52 183  	FROM
14:33:52 184  	  DUAL;
14:33:52 185  
14:33:52 186  	INSERT INTO TAX_ADJUSTMENT (
14:33:52 187  	  ID,
14:33:52 188  	  TAX_ID,
14:33:52 189  	  LINE_ITEM_ADJUSTMENT_ID,
14:33:52 190  	  AMOUNT,
14:33:52 191  	  CREATE_DATE,
14:33:52 192  	  CREATED_BY
14:33:52 193  	)
14:33:52 194  	VALUES (
14:33:52 195  	  var_new_entity_id,
14:33:52 196  	  in_tax_id,
14:33:52 197  	  in_line_item_adjustment_id,
14:33:52 198  	  in_amount,
14:33:52 199  	  var_current_date,
14:33:52 200  	  in_created_by
14:33:52 201  	);
14:33:52 202  
14:33:52 203  	out_tax_adjustment_id := var_new_entity_id;
14:33:52 204  
14:33:52 205  EXCEPTION
14:33:52 206  WHEN OTHERS THEN
14:33:52 207  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52 208  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52 209  END CREATE_TAX_ADJUSTMENT;
14:33:52 210  
14:33:52 211  /******************************************************************************/
14:33:52 212  
14:33:52 213  PROCEDURE CREATE_DISCOUNT_LI_ADJUSTMENT (
14:33:52 214  	in_discount_id		   NUMBER,
14:33:52 215  	in_line_item_id 	   NUMBER,
14:33:52 216  	in_line_item_adjustment_id IN NUMBER,
14:33:52 217  	in_amount		   IN NUMBER,
14:33:52 218  	in_created_by		   IN VARCHAR2,
14:33:52 219  	out_discount_li_id	   OUT NUMBER
14:33:52 220  ) AS
14:33:52 221  SPROC_NAME CONSTANT VARCHAR2(32) := 'CREATE_DISCOUNT_LI_ADJUSTMENT';
14:33:52 222  -- VARIABLES
14:33:52 223  var_current_date DATE := SYSDATE;
14:33:52 224  var_new_entity_id NUMBER;
14:33:52 225  BEGIN
14:33:52 226  
14:33:52 227  	SELECT
14:33:52 228  	  DLIADJ_ID_SEQ.nextVal into var_new_entity_id
14:33:52 229  	FROM
14:33:52 230  	  DUAL;
14:33:52 231  
14:33:52 232  	INSERT INTO DISCOUNT_LINEITEM_ADJUSTMENT (
14:33:52 233  	  ID,
14:33:52 234  	  DISCOUNT_ID,
14:33:52 235  	  LINE_ITEM_ID,
14:33:52 236  	  LINE_ITEM_ADJUSTMENT_ID,
14:33:52 237  	  AMOUNT,
14:33:52 238  	  CREATE_DATE,
14:33:52 239  	  CREATED_BY
14:33:52 240  	)
14:33:52 241  	VALUES (
14:33:52 242  	  var_new_entity_id,
14:33:52 243  	  in_discount_id,
14:33:52 244  	  in_line_item_id,
14:33:52 245  	  in_line_item_adjustment_id,
14:33:52 246  	  in_amount,
14:33:52 247  	  var_current_date,
14:33:52 248  	  in_created_by
14:33:52 249  	);
14:33:52 250  
14:33:52 251  	out_discount_li_id := var_new_entity_id;
14:33:52 252  
14:33:52 253  EXCEPTION
14:33:52 254  WHEN OTHERS THEN
14:33:52 255  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52 256  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52 257  END CREATE_DISCOUNT_LI_ADJUSTMENT;
14:33:52 258  
14:33:52 259  END PROCS_ADJUSTMENTS_V22;
14:33:52 260  .
14:33:52 SQL> /

Package body created.

Elapsed: 00:00:00.08
14:33:52 SQL> 
14:33:52 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_ADX_V22" AS
14:33:52   2  
14:33:52   3  PROCEDURE GET_SUB_ADX_INFO (
14:33:52   4  /*
14:33:52   5  Throws exceptions:
14:33:52   6  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:52   7  */
14:33:52   8  	out_result_set	    OUT SYS_REFCURSOR,
14:33:52   9  	in_group_id    IN ACCOUNT.GROUP_ID%TYPE
14:33:52  10  ) AS
14:33:52  11  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_SUB_ADX_INFO';
14:33:52  12  BEGIN
14:33:52  13  OPEN out_result_set FOR
14:33:52  14  SELECT /*+ FIRST_ROWS(5) */
14:33:52  15  	s.offer_chain_id,
14:33:52  16  	s.create_date,
14:33:52  17  	decode(s.subscription_status_id, 1, 'a', 'c') status,
14:33:52  18  	ocmd.value,
14:33:52  19  	a.group_id,
14:33:52  20  	s.id subscription_id
14:33:52  21  FROM
14:33:52  22  	account a,
14:33:52  23  	subscription s,
14:33:52  24  	offer_chain_meta_data ocmd,
14:33:52  25  	group_account g,
14:33:52  26  	subscription_share ss,
14:33:52  27  	account a2
14:33:52  28  WHERE
14:33:52  29  	s.account_id = a.id and
14:33:52  30  	s.offer_chain_id = ocmd.offer_chain_id and
14:33:52  31  	g.id = ss.group_account_id and
14:33:52  32  	ss.borrower_account_id = a2.id and
14:33:52  33  	s.id = g.subscription_id and
14:33:52  34  	ocmd.name = 'ADX_BUNDLE' and
14:33:52  35  	a2.group_id = in_group_id and
14:33:52  36  	rownum < 5
14:33:52  37  union all
14:33:52  38  SELECT /*+ FIRST_ROWS(5) */
14:33:52  39  	s.offer_chain_id,
14:33:52  40  	s.create_date,
14:33:52  41  	decode(s.subscription_status_id, 1, 'a', 'c') status,
14:33:52  42  	ocmd.value,
14:33:52  43  	a.group_id,
14:33:52  44  	s.id subscription_id
14:33:52  45  FROM
14:33:52  46  	account a,
14:33:52  47  	subscription s,
14:33:52  48  	offer_chain_meta_data ocmd
14:33:52  49  WHERE
14:33:52  50  	s.account_id = a.id and
14:33:52  51  	s.offer_chain_id = ocmd.offer_chain_id and
14:33:52  52  	ocmd.name = 'ADX_BUNDLE' and
14:33:52  53  	a.group_id = in_group_id and
14:33:52  54  	rownum < 5
14:33:52  55  ;
14:33:52  56  
14:33:52  57  END GET_SUB_ADX_INFO;
14:33:52  58  
14:33:52  59  END PROCS_ADX_V22;
14:33:52  60  .
14:33:52 SQL> /

Package body created.

Elapsed: 00:00:00.07
14:33:52 SQL> 
14:33:52 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_AMAZON_V22" AS
14:33:52   2  
14:33:52   3  PROCEDURE AASR_PURCHASE_TOKEN_USED(
14:33:52   4  	in_purchase_token IN AMAZON_APPSTORE_RECEIPT.PURCHASE_TOKEN%TYPE,
14:33:52   5  	out_data	  OUT NUMBER
14:33:52   6  ) AS
14:33:52   7  SPROC_NAME CONSTANT VARCHAR2(32) := 'AASR_PURCHASE_TOKEN_USED';
14:33:52   8  BEGIN
14:33:52   9  	SELECT
14:33:52  10  	  COUNT(1)
14:33:52  11  	INTO OUT_DATA
14:33:52  12  	FROM AMAZON_APPSTORE_RECEIPT
14:33:52  13  	WHERE PURCHASE_TOKEN = in_purchase_token;
14:33:52  14  	EXCEPTION
14:33:52  15  	WHEN NO_DATA_FOUND THEN
14:33:52  16  	out_data := 0;
14:33:52  17  END;
14:33:52  18  
14:33:52  19  PROCEDURE UPDATE_AASR_LAST_CHECK_DATE(
14:33:52  20  	in_id	      IN AMAZON_APPSTORE_RECEIPT.ID%TYPE,
14:33:52  21  	in_updated_by IN AMAZON_APPSTORE_RECEIPT.UPDATED_BY%TYPE
14:33:52  22  ) AS
14:33:52  23  BEGIN
14:33:52  24  	CORE_OWNER.PROCS_AMAZON_CRU_V22.UPDATE_AMAZON_APPSTORE_RECEIPT(
14:33:52  25  	  in_id 	     => in_id,
14:33:52  26  	  in_updated_by      => in_updated_by,
14:33:52  27  	  in_last_check_date => SYSDATE
14:33:52  28  	);
14:33:52  29  END UPDATE_AASR_LAST_CHECK_DATE;
14:33:52  30  
14:33:52  31  PROCEDURE EXPIRED_AASR_SUB_IDS(
14:33:52  32  	out_data   OUT SYS_REFCURSOR
14:33:52  33  ) AS
14:33:52  34  SPROC_NAME CONSTANT VARCHAR2(32) := 'EXPIRED_AASR_SUB_IDS';
14:33:52  35  BEGIN
14:33:52  36  	OPEN out_data FOR
14:33:52  37  	SELECT
14:33:52  38  	  *
14:33:52  39  	FROM
14:33:52  40  	  (
14:33:52  41  	    SELECT
14:33:52  42  	      AMAZON_APPSTORE_RECEIPT.SUBSCRIPTION_ID
14:33:52  43  	    FROM AMAZON_APPSTORE_RECEIPT
14:33:52  44  	      INNER JOIN SUBSCRIPTION ON SUBSCRIPTION.ID = AMAZON_APPSTORE_RECEIPT.SUBSCRIPTION_ID
14:33:52  45  	    WHERE
14:33:52  46  	      AMAZON_APPSTORE_RECEIPT.END_DATE <= SYSDATE AND
14:33:52  47  	      SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE
14:33:52  48  	    ORDER BY dbms_random.value
14:33:52  49  	  )
14:33:52  50  	WHERE
14:33:52  51  	  ROWNUM <= 1000;
14:33:52  52  END EXPIRED_AASR_SUB_IDS;
14:33:52  53  
14:33:52  54  PROCEDURE UPDATE_AASR_PURCHASE_TOKEN(
14:33:52  55  	in_id		  IN AMAZON_APPSTORE_RECEIPT.ID%TYPE,
14:33:52  56  	in_purchase_token IN AMAZON_APPSTORE_RECEIPT.PURCHASE_TOKEN%TYPE,
14:33:52  57  	in_updated_by	  IN AMAZON_APPSTORE_RECEIPT.UPDATED_BY%TYPE
14:33:52  58  ) AS
14:33:52  59  SPROC_NAME CONSTANT VARCHAR2(32) := 'UPDATE_AASR_PURCHASE_TOKEN';
14:33:52  60  BEGIN
14:33:52  61  	  CORE_OWNER.PROCS_AMAZON_CRU_V22.UPDATE_AMAZON_APPSTORE_RECEIPT(
14:33:52  62  	      in_id		  => in_id,
14:33:52  63  	      in_updated_by	  => in_updated_by,
14:33:52  64  	      in_purchase_token   => in_purchase_token
14:33:52  65  	  );
14:33:52  66  END UPDATE_AASR_PURCHASE_TOKEN;
14:33:52  67  
14:33:52  68  PROCEDURE UPDATE_AASR_END_DATE(
14:33:52  69  	in_id	      IN AMAZON_APPSTORE_RECEIPT.ID%TYPE,
14:33:52  70  	in_end_date   IN AMAZON_APPSTORE_RECEIPT.END_DATE%TYPE,
14:33:52  71  	in_updated_by IN AMAZON_APPSTORE_RECEIPT.UPDATED_BY%TYPE
14:33:52  72  ) AS
14:33:52  73  SPROC_NAME CONSTANT VARCHAR2(32) := 'UPDATE_AASR_END_DATE';
14:33:52  74  BEGIN
14:33:52  75  	CORE_OWNER.PROCS_AMAZON_CRU_V22.UPDATE_AMAZON_APPSTORE_RECEIPT(
14:33:52  76  	    in_id	  => in_id,
14:33:52  77  	    in_updated_by => in_updated_by,
14:33:52  78  	    in_end_date   => in_end_date
14:33:52  79  	);
14:33:52  80  END UPDATE_AASR_END_DATE;
14:33:52  81  
14:33:52  82  PROCEDURE AASR_RECEIPTS_WITH_ACTIVE_SUBS(
14:33:52  83  	out_data   OUT SYS_REFCURSOR,
14:33:52  84  	in_process_name IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE
14:33:52  85  ) AS
14:33:52  86  SPROC_NAME CONSTANT VARCHAR2(32) := 'AASR_RECEIPTS_WITH_ACTIVE_SUBS';
14:33:52  87  BEGIN
14:33:52  88  	OPEN out_data FOR
14:33:52  89  	SELECT
14:33:52  90  	  *
14:33:52  91  	FROM (
14:33:52  92  	  SELECT
14:33:52  93  	    AMAZON_APPSTORE_RECEIPT.ID,
14:33:52  94  	    AMAZON_APPSTORE_RECEIPT.SUBSCRIPTION_ID,
14:33:52  95  	    AMAZON_APPSTORE_RECEIPT.USER_ID,
14:33:52  96  	    AMAZON_APPSTORE_RECEIPT.ITEM_TYPE,
14:33:52  97  	    AMAZON_APPSTORE_RECEIPT.START_DATE,
14:33:52  98  	    AMAZON_APPSTORE_RECEIPT.END_DATE,
14:33:52  99  	    AMAZON_APPSTORE_RECEIPT.SKU,
14:33:52 100  	    AMAZON_APPSTORE_RECEIPT.PURCHASE_TOKEN,
14:33:52 101  	    AMAZON_APPSTORE_RECEIPT.CREATE_DATE,
14:33:52 102  	    AMAZON_APPSTORE_RECEIPT.CREATED_BY,
14:33:52 103  	    AMAZON_APPSTORE_RECEIPT.UPDATE_DATE,
14:33:52 104  	    AMAZON_APPSTORE_RECEIPT.UPDATED_BY,
14:33:52 105  	    AMAZON_APPSTORE_RECEIPT.LAST_CHECK_DATE
14:33:52 106  	  FROM AMAZON_APPSTORE_RECEIPT
14:33:52 107  	    INNER JOIN SUBSCRIPTION ON SUBSCRIPTION.ID = AMAZON_APPSTORE_RECEIPT.SUBSCRIPTION_ID
14:33:52 108  	  WHERE
14:33:52 109  	    SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE
14:33:52 110  	    AND NOT EXISTS
14:33:52 111  	    (
14:33:52 112  		SELECT
14:33:52 113  		  NULL
14:33:52 114  		FROM PROCESS_RETRY_THROTTLE
14:33:52 115  		WHERE PROCESS_NAME = in_process_name
14:33:52 116  		      AND GENERIC_ID = AMAZON_APPSTORE_RECEIPT.ID
14:33:52 117  	    )
14:33:52 118  	  ORDER BY dbms_random.value
14:33:52 119  	)
14:33:52 120  	WHERE
14:33:52 121  	  ROWNUM <= 1000;
14:33:52 122  END AASR_RECEIPTS_WITH_ACTIVE_SUBS;
14:33:52 123  
14:33:52 124  PROCEDURE ADD_AMAZON_APPSTORE_RECEIPT(
14:33:52 125  	in_subscription_id IN AMAZON_APPSTORE_RECEIPT.SUBSCRIPTION_ID%TYPE,
14:33:52 126  	in_user_id	   IN AMAZON_APPSTORE_RECEIPT.USER_ID%TYPE,
14:33:52 127  	in_item_type	   IN AMAZON_APPSTORE_RECEIPT.ITEM_TYPE%TYPE,
14:33:52 128  	in_start_date	   IN AMAZON_APPSTORE_RECEIPT.START_DATE%TYPE,
14:33:52 129  	in_end_date	   IN AMAZON_APPSTORE_RECEIPT.END_DATE%TYPE DEFAULT NULL,
14:33:52 130  	in_sku		   IN AMAZON_APPSTORE_RECEIPT.SKU%TYPE,
14:33:52 131  	in_purchase_token  IN AMAZON_APPSTORE_RECEIPT.PURCHASE_TOKEN%TYPE,
14:33:52 132  	in_created_by	   IN AMAZON_APPSTORE_RECEIPT.CREATED_BY%TYPE
14:33:52 133  ) AS
14:33:52 134  SPROC_NAME	 CONSTANT VARCHAR2(32) := 'ADD_AMAZON_APPSTORE_RECEIPT';
14:33:52 135  BEGIN
14:33:52 136  	CORE_OWNER.PROCS_AMAZON_CRU_V22.ADD_AMAZON_APPSTORE_RECEIPT(
14:33:52 137  	    in_subscription_id =>  in_subscription_id,
14:33:52 138  	    in_user_id	       =>  in_user_id,
14:33:52 139  	    in_item_type       =>  in_item_type,
14:33:52 140  	    in_start_date      =>  in_start_date,
14:33:52 141  	    in_end_date        =>  in_end_date,
14:33:52 142  	    in_sku	       =>  in_sku,
14:33:52 143  	    in_purchase_token  =>  in_purchase_token,
14:33:52 144  	    in_created_by      =>  in_created_by
14:33:52 145  	);
14:33:52 146  END ADD_AMAZON_APPSTORE_RECEIPT;
14:33:52 147  
14:33:52 148  PROCEDURE AMAZON_APPSTORE_RECEIPTS(
14:33:52 149  	in_user_id IN AMAZON_APPSTORE_RECEIPT.USER_ID%TYPE,
14:33:52 150  	in_sku	   IN AMAZON_APPSTORE_RECEIPT.SKU%TYPE,
14:33:52 151  	out_data   OUT SYS_REFCURSOR
14:33:52 152  ) AS
14:33:52 153  SPROC_NAME CONSTANT VARCHAR2(32) := 'AMAZON_APPSTORE_RECEIPTS';
14:33:52 154  BEGIN
14:33:52 155  	OPEN out_data FOR
14:33:52 156  	SELECT
14:33:52 157  	  AMAZON_APPSTORE_RECEIPT.ID,
14:33:52 158  	  AMAZON_APPSTORE_RECEIPT.SUBSCRIPTION_ID,
14:33:52 159  	  AMAZON_APPSTORE_RECEIPT.USER_ID,
14:33:52 160  	  AMAZON_APPSTORE_RECEIPT.ITEM_TYPE,
14:33:52 161  	  AMAZON_APPSTORE_RECEIPT.START_DATE,
14:33:52 162  	  AMAZON_APPSTORE_RECEIPT.END_DATE,
14:33:52 163  	  AMAZON_APPSTORE_RECEIPT.SKU,
14:33:52 164  	  AMAZON_APPSTORE_RECEIPT.PURCHASE_TOKEN,
14:33:52 165  	  AMAZON_APPSTORE_RECEIPT.CREATE_DATE,
14:33:52 166  	  AMAZON_APPSTORE_RECEIPT.CREATED_BY,
14:33:52 167  	  AMAZON_APPSTORE_RECEIPT.UPDATE_DATE,
14:33:52 168  	  AMAZON_APPSTORE_RECEIPT.UPDATED_BY,
14:33:52 169  	  AMAZON_APPSTORE_RECEIPT.LAST_CHECK_DATE
14:33:52 170  	FROM AMAZON_APPSTORE_RECEIPT
14:33:52 171  	  INNER JOIN SUBSCRIPTION ON SUBSCRIPTION.ID = AMAZON_APPSTORE_RECEIPT.SUBSCRIPTION_ID
14:33:52 172  	WHERE AMAZON_APPSTORE_RECEIPT.USER_ID = in_user_id AND
14:33:52 173  	      AMAZON_APPSTORE_RECEIPT.SKU = in_sku AND
14:33:52 174  	      SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE;
14:33:52 175  END AMAZON_APPSTORE_RECEIPTS;
14:33:52 176  
14:33:52 177  	PROCEDURE CREATE_AMAZON_SUB(
14:33:52 178  	  out_id	      OUT NUMBER,
14:33:52 179  	  in_subscription_id  IN AMAZON_SUB.SUBSCRIPTION_ID%TYPE,
14:33:52 180  	  in_amazon_id	      IN AMAZON_SUB.AMAZON_ID%TYPE,
14:33:52 181  	  in_created_by       IN AMAZON_SUB.CREATED_BY%TYPE
14:33:52 182  ) AS
14:33:52 183  -- VARIABLES
14:33:52 184  SPROC_NAME	 CONSTANT VARCHAR2(32) := 'CREATE_AMAZON_SUB';
14:33:52 185  -- EXCEPTIONS
14:33:52 186  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:52 187  BEGIN
14:33:52 188  
14:33:52 189  	CORE_OWNER.PROCS_AMAZON_CRU_V22.CREATE_AMAZON_SUB(
14:33:52 190  	  out_id	      =>  out_id,
14:33:52 191  	  in_subscription_id  =>  in_subscription_id,
14:33:52 192  	  in_amazon_id	      =>  in_amazon_id,
14:33:52 193  	  in_created_by       =>  in_created_by
14:33:52 194  	);
14:33:52 195  
14:33:52 196  END CREATE_AMAZON_SUB;
14:33:52 197  
14:33:52 198  PROCEDURE GET_ACTIVE_SUB_IDS (
14:33:52 199  	out_result_set	    OUT SYS_REFCURSOR,
14:33:52 200  	in_amazon_id	IN AMAZON_SUB.AMAZON_ID%TYPE
14:33:52 201  ) AS
14:33:52 202  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_ACTIVE_SUB_IDS';
14:33:52 203  BEGIN
14:33:52 204  OPEN out_result_set FOR
14:33:52 205  SELECT s.id
14:33:52 206  FROM subscription s, amazon_sub am
14:33:52 207  WHERE
14:33:52 208  	s.id = am.subscription_id
14:33:52 209  	and s.subscription_status_id = GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE
14:33:52 210  	and am.amazon_id = in_amazon_id
14:33:52 211  ;
14:33:52 212  
14:33:52 213  END GET_ACTIVE_SUB_IDS;
14:33:52 214  
14:33:52 215  PROCEDURE GET_ACTIVE_GROUP_IDS (
14:33:52 216  	out_result_set	    OUT SYS_REFCURSOR,
14:33:52 217  	in_amazon_id	IN AMAZON_SUB.AMAZON_ID%TYPE
14:33:52 218  ) AS
14:33:52 219  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_ACTIVE_GROUP_IDS';
14:33:52 220  BEGIN
14:33:52 221  OPEN out_result_set FOR
14:33:52 222  SELECT distinct a.group_id id
14:33:52 223  FROM subscription s, amazon_sub am, account a
14:33:52 224  WHERE
14:33:52 225  	s.id = am.subscription_id
14:33:52 226  	and a.id = s.account_id
14:33:52 227  	and s.subscription_status_id = GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE
14:33:52 228  	and am.amazon_id = in_amazon_id
14:33:52 229  ;
14:33:52 230  
14:33:52 231  END GET_ACTIVE_GROUP_IDS;
14:33:52 232  
14:33:52 233  END PROCS_AMAZON_V22;
14:33:52 234  .
14:33:52 SQL> /

Package body created.

Elapsed: 00:00:00.04
14:33:52 SQL> 
14:33:52 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_CUPY" AS
14:33:52   2  
14:33:52   3  	/****************************************************************************/
14:33:52   4  
14:33:52   5  	PROCEDURE POPULATE_REQUEST_INFO(
14:33:52   6  	  in_hours_prior    IN	NUMBER,
14:33:52   7  	  in_filename	    IN	CC_REQUEST_FILE.FILE_NAME%TYPE,
14:33:52   8  	  in_creator	    IN	CC_REQUEST_FILE.UPDATED_BY%TYPE
14:33:52   9  	) AS
14:33:52  10  	SPROC_NAME CONSTANT VARCHAR2(32) := 'POPULATE_REQUEST_INFO';
14:33:52  11  	var_start_date	    DATE := SYSDATE;
14:33:52  12  	var_end_date	    DATE := var_start_date + (in_hours_prior/24);
14:33:52  13  	var_request_file_id NUMBER := 0;
14:33:52  14  	var_license_count   NUMBER := 0;
14:33:52  15  	var_cc_update_count NUMBER := 0;
14:33:52  16  	BEGIN
14:33:52  17  	    SELECT CC_REQUEST_FILE_ID_SEQ.NEXTVAL INTO var_request_file_id  FROM DUAL;
14:33:52  18  	    INSERT INTO CC_REQUEST_FILE (ID,
14:33:52  19  					 FILE_NAME,
14:33:52  20  					 CC_REQUEST_FILE_STATUS,
14:33:52  21  					 CREATE_DATE,
14:33:52  22  					 CREATED_BY,
14:33:52  23  					 UPDATE_DATE,
14:33:52  24  					 UPDATED_BY)
14:33:52  25  					 VALUES (
14:33:52  26  					 var_request_file_id,
14:33:52  27  					 in_filename,
14:33:52  28  					 'NOT_CREATED',
14:33:52  29  					 var_start_date,
14:33:52  30  					 in_creator,
14:33:52  31  					 var_start_date,
14:33:52  32  					 in_creator);
14:33:52  33  
14:33:52  34  	   FOR record IN (SELECT
14:33:52  35  			    l.ID LICENSE_ID, cc.ID CREDIT_CARD_ID
14:33:52  36  			  FROM
14:33:52  37  			    LICENSE l INNER JOIN SUBSCRIPTION s ON L.SUBSCRIPTION_ID = s.ID
14:33:52  38  				      INNER JOIN CREDIT_CARD cc ON S.INSTRUMENT_ID   = cc.ID
14:33:52  39  			  WHERE
14:33:52  40  			    s.INSTRUMENT_TYPE_ID	 = 1
14:33:52  41  			    AND cc.CREDIT_CARD_STATUS_ID = 1
14:33:52  42  			    AND s.SUBSCRIPTION_STATUS_ID = 1
14:33:52  43  			    AND l.LICENSE_STATUS_ID	 = 2
14:33:52  44  			    AND cc.CREDIT_CARD_TYPE_ID IN (2,3)
14:33:52  45  			    AND l.END_DATE BETWEEN var_start_date AND var_end_date
14:33:52  46  			    AND l.ID NOT IN (SELECT LICENSE_ID FROM CC_UPDATE))
14:33:52  47  	   LOOP
14:33:52  48  	     var_license_count := 0;
14:33:52  49  	     SELECT COUNT(1) INTO  var_license_count FROM CC_UPDATE WHERE LICENSE_ID = record.LICENSE_ID;
14:33:52  50  
14:33:52  51  	     IF var_license_count = 0 THEN
14:33:52  52  		INSERT INTO CC_UPDATE (ID,
14:33:52  53  				       CREDIT_CARD_ID,
14:33:52  54  				       LICENSE_ID,
14:33:52  55  				       CC_UPDATE_STATUS,
14:33:52  56  				       CC_REQUEST_FILE_ID,
14:33:52  57  				       CREATE_DATE,
14:33:52  58  				       UPDATE_DATE,
14:33:52  59  				       CREATED_BY,
14:33:52  60  				       UPDATED_BY
14:33:52  61  				       ) VALUES (
14:33:52  62  				       CC_UPDATE_SEQ.NEXTVAL,
14:33:52  63  				       record.CREDIT_CARD_ID,
14:33:52  64  				       record.LICENSE_ID,
14:33:52  65  				       'NOT_ADDED_TO_FILE',
14:33:52  66  				       var_request_file_id,
14:33:52  67  				       var_start_date,
14:33:52  68  				       var_start_date,
14:33:52  69  				       in_creator,
14:33:52  70  				       in_creator
14:33:52  71  				       );
14:33:52  72  	     END IF;
14:33:52  73  	   END LOOP;
14:33:52  74  
14:33:52  75  	   SELECT COUNT(1) INTO var_cc_update_count
14:33:52  76  	   FROM CC_UPDATE
14:33:52  77  	   WHERE CC_REQUEST_FILE_ID = var_request_file_id;
14:33:52  78  	   IF var_cc_update_count <= 0 THEN
14:33:52  79  	     UPDATE CC_REQUEST_FILE
14:33:52  80  	     SET CC_REQUEST_FILE_STATUS = 'EMPTY'
14:33:52  81  	     WHERE ID = var_request_file_id;
14:33:52  82  	   END IF;
14:33:52  83  
14:33:52  84  	END POPULATE_REQUEST_INFO;
14:33:52  85  
14:33:52  86  	/****************************************************************************/
14:33:52  87  
14:33:52  88  	PROCEDURE CHASE_PROFILE_BY_REQ_FILE_ID(
14:33:52  89  	  in_request_file_id IN CC_UPDATE.CC_REQUEST_FILE_ID%TYPE,
14:33:52  90  	  in_start	     IN NUMBER,
14:33:52  91  	  in_end	     IN NUMBER,
14:33:52  92  	  out_result_set     OUT SYS_REFCURSOR
14:33:52  93  	) AS
14:33:52  94  	SPROC_NAME CONSTANT VARCHAR2(32) := 'CHASE_PROFILE_BY_REQ_FILE_ID';
14:33:52  95  	var_range_diff	    NUMBER := 0;
14:33:52  96  	var_upper_bond_diff NUMBER := 0;
14:33:52  97  	var_l_start	    NUMBER := 0;
14:33:52  98  	var_l_end	    NUMBER := 0;
14:33:52  99  	BEGIN
14:33:52 100  	  --Normalize the end points [START]
14:33:52 101  	  IF (in_start IS NULL OR in_start < 0) Then
14:33:52 102  	    var_l_start := 0;
14:33:52 103  	  ELSE
14:33:52 104  	    var_l_start := in_start;
14:33:52 105  	  END IF;
14:33:52 106  
14:33:52 107  	  IF (in_end IS NULL) Then
14:33:52 108  	    var_l_end := 500;
14:33:52 109  	  ELSE
14:33:52 110  	    var_l_end := in_end;
14:33:52 111  	  END IF;
14:33:52 112  
14:33:52 113  	  var_l_start := var_l_start + 1;
14:33:52 114  	  var_l_end   := var_l_end   + 1;
14:33:52 115  
14:33:52 116  	  var_range_diff  := var_l_end - var_l_start;
14:33:52 117  	  var_upper_bond_diff :=  var_range_diff - 1000;
14:33:52 118  
14:33:52 119  	  IF (var_upper_bond_diff > 0) Then
14:33:52 120  	    var_l_end := var_l_end - var_upper_bond_diff;
14:33:52 121  	  END IF;
14:33:52 122  	  --Normalize the end points [END]
14:33:52 123  
14:33:52 124  	  OPEN out_result_set FOR
14:33:52 125  	    SELECT CHASE_PROFILE_ID FROM
14:33:52 126  	      (SELECT rownum rnum, q.* FROM
14:33:52 127  		 (SELECT
14:33:52 128  		    cc.CHASE_PROFILE_ID
14:33:52 129  		  FROM
14:33:52 130  		    CREDIT_CARD cc,
14:33:52 131  		    CC_UPDATE ccu
14:33:52 132  		  WHERE
14:33:52 133  		    ccu.CC_REQUEST_FILE_ID = in_request_file_id
14:33:52 134  		    AND ccu.CREDIT_CARD_ID = cc.id
14:33:52 135  		) Q
14:33:52 136  	      WHERE rownum <= var_l_end)
14:33:52 137  	    WHERE rnum >= var_l_Start;
14:33:52 138  	END CHASE_PROFILE_BY_REQ_FILE_ID;
14:33:52 139  
14:33:52 140  	/****************************************************************************/
14:33:52 141  
14:33:52 142  	PROCEDURE UPDATE_REQUEST_FILE_STATUS(
14:33:52 143  	  in_request_file_id IN CC_REQUEST_FILE.ID%TYPE,
14:33:52 144  	  in_status	     IN CC_REQUEST_FILE.CC_REQUEST_FILE_STATUS%TYPE,
14:33:52 145  	  in_updated_by      IN CC_REQUEST_FILE.UPDATED_BY%TYPE
14:33:52 146  	)AS
14:33:52 147  	SPROC_NAME CONSTANT VARCHAR2(32) := 'UPDATE_REQUEST_FILE_STATUS';
14:33:52 148  	BEGIN
14:33:52 149  	  UPDATE CC_REQUEST_FILE
14:33:52 150  	  SET CC_REQUEST_FILE_STATUS = in_status,
14:33:52 151  	      UPDATE_DATE = SYSDATE,
14:33:52 152  	      UPDATED_BY  = in_updated_by
14:33:52 153  	  WHERE ID = in_request_file_id;
14:33:52 154  	END UPDATE_REQUEST_FILE_STATUS;
14:33:52 155  
14:33:52 156  	/****************************************************************************/
14:33:52 157  
14:33:52 158  	PROCEDURE UPDATE_CC_REQUEST_STATUS(
14:33:52 159  	  in_request_file_id IN CC_UPDATE.CC_REQUEST_FILE_ID%TYPE,
14:33:52 160  	  in_status	     IN CC_UPDATE.CC_UPDATE_STATUS%TYPE,
14:33:52 161  	  in_updated_by      IN CC_UPDATE.UPDATED_BY%TYPE
14:33:52 162  	) AS
14:33:52 163  	SPROC_NAME CONSTANT VARCHAR2(32) := 'UPDATE_CC_REQUEST_STATUS';
14:33:52 164  	BEGIN
14:33:52 165  	  UPDATE CC_UPDATE
14:33:52 166  	  SET CC_UPDATE_STATUS = in_status,
14:33:52 167  	      UPDATE_DATE      = SYSDATE,
14:33:52 168  	      UPDATED_BY       = in_updated_by
14:33:52 169  	  WHERE
14:33:52 170  	    CC_REQUEST_FILE_ID = in_request_file_id;
14:33:52 171  	END UPDATE_CC_REQUEST_STATUS;
14:33:52 172  
14:33:52 173  	/****************************************************************************/
14:33:52 174  
14:33:52 175  	PROCEDURE REQUEST_FILES_BY_STATUS (
14:33:52 176  	  in_status	      IN  CC_REQUEST_FILE.CC_REQUEST_FILE_STATUS%TYPE,
14:33:52 177  	  in_older_than_hours IN  NUMBER DEFAULT -288,
14:33:52 178  	  out_request_files   OUT SYS_REFCURSOR
14:33:52 179  	) AS
14:33:52 180  	var_older_than_hours NUMBER := in_older_than_hours;
14:33:52 181  	BEGIN
14:33:52 182  	 IF (var_older_than_hours IS NULL) THEN
14:33:52 183  	   var_older_than_hours := -288;
14:33:52 184  	 END IF;
14:33:52 185  
14:33:52 186  	 OPEN out_request_files FOR
14:33:52 187  	 SELECT
14:33:52 188  	   ID,
14:33:52 189  	   FILE_NAME
14:33:52 190  	 FROM
14:33:52 191  	   CC_REQUEST_FILE
14:33:52 192  	 WHERE
14:33:52 193  	   CC_REQUEST_FILE_STATUS = in_status
14:33:52 194  	 AND
14:33:52 195  	   UPDATE_DATE < SYSDATE - (var_older_than_hours / 24);
14:33:52 196  	END REQUEST_FILES_BY_STATUS;
14:33:52 197  
14:33:52 198  	/****************************************************************************/
14:33:52 199  
14:33:52 200  	PROCEDURE COUNT_BY_REQUEST_FILE_ID (
14:33:52 201  	  in_id     IN	CC_UPDATE.CC_REQUEST_FILE_ID%TYPE,
14:33:52 202  	  out_count OUT NUMBER
14:33:52 203  	) AS
14:33:52 204  	SPROC_NAME CONSTANT VARCHAR2(32) := 'COUNT_BY_REQUEST_FILE_ID';
14:33:52 205  	BEGIN
14:33:52 206  	  SELECT COUNT(1) INTO out_count
14:33:52 207  	  FROM CC_UPDATE
14:33:52 208  	  WHERE CC_REQUEST_FILE_ID = in_id;
14:33:52 209  	END COUNT_BY_REQUEST_FILE_ID;
14:33:52 210  
14:33:52 211  	/****************************************************************************/
14:33:52 212  
14:33:52 213  	PROCEDURE GET_CREDIT_CARD_INFO (
14:33:52 214  	  in_chase_profile_id  IN  CREDIT_CARD.CHASE_PROFILE_ID%TYPE,
14:33:52 215  	  in_request_filename  IN  CC_REQUEST_FILE.FILE_NAME%TYPE DEFAULT NULL,
14:33:52 216  	  out_card_info        OUT SYS_REFCURSOR
14:33:52 217  	) AS
14:33:52 218  	BEGIN
14:33:52 219  	  OPEN out_card_info FOR
14:33:52 220  	  SELECT
14:33:52 221  	    u.LICENSE_ID,
14:33:52 222  	    cc.ACCOUNT_ID,
14:33:52 223  	    cc.ID CREDIT_CARD_ID,
14:33:52 224  	    cc.CHASE_PROFILE_ID,
14:33:52 225  	    cc.LAST_FOUR_CC CREDIT_CARD_LAST_DIGITS,
14:33:52 226  	    cc.UPDATE_DATE CREDIT_CARD_UPDATE_DATE,
14:33:52 227  	    cc.UPDATED_BY CREDIT_CARD_UPDATED_BY,
14:33:52 228  	    cc.EXPIRATION_DATE CREDIT_CARD_EXPIRATION_DATE,
14:33:52 229  	    u.ID CC_UPDATE_ID,
14:33:52 230  	    DECODE(cc.CREDIT_CARD_STATUS_ID, 1, 1, 0) ACTIVE
14:33:52 231  	  FROM CREDIT_CARD cc, CC_UPDATE u, CC_REQUEST_FILE rf
14:33:52 232  	  WHERE cc.ID = u.CREDIT_CARD_ID
14:33:52 233  	  AND u.CC_REQUEST_FILE_ID = rf.ID
14:33:52 234  	  AND rf.CC_REQUEST_FILE_STATUS in ('SENT', 'RESPONSE_DOWNLOADED', 'REPORT_DOWNLOADED', 'RESPONSE_COMPLETE', 'NO_RESPONSE')
14:33:52 235  	  AND rf.FILE_NAME = NVL(in_request_filename, rf.FILE_NAME)
14:33:52 236  	  AND upper(cc.CHASE_PROFILE_ID) = in_chase_profile_id
14:33:52 237  	  AND u.CC_UPDATE_STATUS NOT IN ('NO_UPDATE', 'UPDATED')
14:33:52 238  	  ORDER BY cc.UPDATE_DATE DESC;
14:33:52 239  	END GET_CREDIT_CARD_INFO;
14:33:52 240  
14:33:52 241  	/****************************************************************************/
14:33:52 242  
14:33:52 243  	PROCEDURE UPDATE_CC_UPDATE(
14:33:52 244  	  in_id 	     IN CC_UPDATE.ID%TYPE,
14:33:52 245  	  in_status	     IN CC_UPDATE.CC_UPDATE_STATUS%TYPE,
14:33:52 246  	  in_action	     IN CC_UPDATE.CC_UPDATE_ACTION%TYPE DEFAULT NULL,
14:33:52 247  	  in_reason	     IN CC_UPDATE.CC_UPDATE_REASON%TYPE DEFAULT NULL,
14:33:52 248  	  in_response_proc_status_code IN CC_UPDATE.RESPONSE_PROC_STATUS_CODE%TYPE DEFAULT NULL,
14:33:52 249  	  in_response_proc_status_msg  IN CC_UPDATE.RESPONSE_PROC_STATUS_MESSAGE%TYPE DEFAULT NULL,
14:33:52 250  	  in_updated_by      IN CC_UPDATE.UPDATED_BY%TYPE
14:33:52 251  	) AS
14:33:52 252  	BEGIN
14:33:52 253  	  UPDATE CC_UPDATE
14:33:52 254  	  SET CC_UPDATE_STATUS = in_status,
14:33:52 255  	  CC_UPDATE_ACTION = NVL(in_action, CC_UPDATE_ACTION),
14:33:52 256  	  CC_UPDATE_REASON = NVL(in_reason, CC_UPDATE_REASON),
14:33:52 257  	  RESPONSE_PROC_STATUS_CODE = NVL(RESPONSE_PROC_STATUS_CODE, in_response_proc_status_code),
14:33:52 258  	  RESPONSE_PROC_STATUS_MESSAGE = NVL(RESPONSE_PROC_STATUS_MESSAGE, in_response_proc_status_msg),
14:33:52 259  	  UPDATE_DATE = SYSDATE,
14:33:52 260  	  UPDATED_BY = in_updated_by
14:33:52 261  	  WHERE ID = in_id;
14:33:52 262  	END UPDATE_CC_UPDATE;
14:33:52 263  
14:33:52 264  	/****************************************************************************/
14:33:52 265  
14:33:52 266  	PROCEDURE UPDATE_CC_UPDATE_STATUS(
14:33:52 267  	  in_id 	IN CC_UPDATE.ID%TYPE,
14:33:52 268  	  in_status	IN CC_UPDATE.CC_UPDATE_STATUS%TYPE,
14:33:52 269  	  in_updated_by IN CC_UPDATE.UPDATED_BY%TYPE
14:33:52 270  	) AS
14:33:52 271  	BEGIN
14:33:52 272  	  UPDATE CC_UPDATE
14:33:52 273  	  SET CC_UPDATE_STATUS = in_status,
14:33:52 274  	  UPDATE_DATE = SYSDATE,
14:33:52 275  	  UPDATED_BY = in_updated_by
14:33:52 276  	  WHERE ID = in_id;
14:33:52 277  	END UPDATE_CC_UPDATE_STATUS;
14:33:52 278  
14:33:52 279  	/****************************************************************************/
14:33:52 280  
14:33:52 281  	PROCEDURE GET_REQUEST_FILE_BY_FILENAME (
14:33:52 282  	  in_request_filename  IN  CC_REQUEST_FILE.FILE_NAME%TYPE,
14:33:52 283  	  out_request_file     OUT SYS_REFCURSOR
14:33:52 284  	) AS
14:33:52 285  	BEGIN
14:33:52 286  	  OPEN out_request_file FOR
14:33:52 287  	  SELECT ID, FILE_NAME
14:33:52 288  	  FROM CC_REQUEST_FILE
14:33:52 289  	  WHERE FILE_NAME = in_request_filename;
14:33:52 290  	END GET_REQUEST_FILE_BY_FILENAME;
14:33:52 291  
14:33:52 292  	/****************************************************************************/
14:33:52 293  
14:33:52 294  	PROCEDURE SUSPEND_CREDIT_CARD (
14:33:52 295  	  in_credit_card_id  IN CREDIT_CARD.ID%TYPE,
14:33:52 296  	  in_updated_by      IN CREDIT_CARD.UPDATED_BY%TYPE
14:33:52 297  	) AS
14:33:52 298  	BEGIN
14:33:52 299  	  -- Create history
14:33:52 300  	  PROCS_HISTORY_V22.CREATE_CREDIT_CARD_HISTORY(
14:33:52 301  	      in_credit_card_id 	   => in_credit_card_id,
14:33:52 302  	      in_system_activity_reason_id => GLOBAL_ENUMS_V22.SAC_SYSTEM_APPLIED_RULE
14:33:52 303  	  );
14:33:52 304  
14:33:52 305  	  UPDATE CREDIT_CARD
14:33:52 306  	  SET UPDATE_DATE = SYSDATE,
14:33:52 307  	  UPDATED_BY = in_updated_by,
14:33:52 308  	  CREDIT_CARD_STATUS_ID = GLOBAL_STATUSES_V22.CREDIT_CARD_DISABLED
14:33:52 309  	  WHERE ID = in_credit_card_id;
14:33:52 310  	END SUSPEND_CREDIT_CARD;
14:33:52 311  
14:33:52 312  	/****************************************************************************/
14:33:52 313  
14:33:52 314  	PROCEDURE UPDATE_CREDIT_CARD (
14:33:52 315  	  in_credit_card_id   IN CREDIT_CARD.ID%TYPE,
14:33:52 316  	  in_last_four_cc     IN CREDIT_CARD.LAST_FOUR_CC%TYPE,
14:33:52 317  	  in_expiration_date  IN CREDIT_CARD.EXPIRATION_DATE%TYPE,
14:33:52 318  	  in_updated_by       IN CREDIT_CARD.UPDATED_BY%TYPE
14:33:52 319  	) AS
14:33:52 320  	BEGIN
14:33:52 321  	  -- Create history
14:33:52 322  	  PROCS_HISTORY_V22.CREATE_CREDIT_CARD_HISTORY(
14:33:52 323  	      in_credit_card_id 	   => in_credit_card_id,
14:33:52 324  	      in_system_activity_reason_id => GLOBAL_ENUMS_V22.SAC_SYSTEM_APPLIED_RULE
14:33:52 325  	  );
14:33:52 326  
14:33:52 327  	  UPDATE CREDIT_CARD
14:33:52 328  	  SET UPDATE_DATE = SYSDATE,
14:33:52 329  	  UPDATED_BY = in_updated_by,
14:33:52 330  	  LAST_FOUR_CC = NVL(in_last_four_cc, LAST_FOUR_CC),
14:33:52 331  	  EXPIRATION_DATE = NVL(in_expiration_date, EXPIRATION_DATE)
14:33:52 332  	  WHERE ID = in_credit_card_id;
14:33:52 333  	END UPDATE_CREDIT_CARD;
14:33:52 334  
14:33:52 335  	/****************************************************************************/
14:33:52 336  
14:33:52 337  	PROCEDURE COMPLETABLE_REQUESTS (
14:33:52 338  	  out_request_files OUT SYS_REFCURSOR
14:33:52 339  	) AS
14:33:52 340  	BEGIN
14:33:52 341  	  OPEN out_request_files FOR
14:33:52 342  	  SELECT DISTINCT rf.ID, rf.FILE_NAME
14:33:52 343  	  FROM CC_REQUEST_FILE rf, CC_UPDATE u
14:33:52 344  	  WHERE CC_REQUEST_FILE_STATUS in ('SENT', 'RESPONSE_DOWNLOADED', 'REPORT_DOWNLOADED', 'RESPONSE_COMPLETE')
14:33:52 345  	  AND rf.ID = u.CC_REQUEST_FILE_ID
14:33:52 346  	  AND u.CC_UPDATE_STATUS IN ('UPDATED', 'NO_UPDATE')
14:33:52 347  	  MINUS
14:33:52 348  	  SELECT rf.ID, rf.FILE_NAME
14:33:52 349  	  FROM CC_REQUEST_FILE rf, CC_UPDATE u
14:33:52 350  	  WHERE CC_REQUEST_FILE_STATUS in ('SENT', 'RESPONSE_DOWNLOADED', 'REPORT_DOWNLOADED', 'RESPONSE_COMPLETE')
14:33:52 351  	  AND rf.ID = u.CC_REQUEST_FILE_ID
14:33:52 352  	  AND u.CC_UPDATE_STATUS NOT IN ('UPDATED', 'NO_UPDATE');
14:33:52 353  	END COMPLETABLE_REQUESTS;
14:33:52 354  
14:33:52 355  	/****************************************************************************/
14:33:52 356  
14:33:52 357  	PROCEDURE COMPLETABLE_REQUESTS_W_FAILS (
14:33:52 358  	  in_max_hours_before_report IN  NUMBER,
14:33:52 359  	  out_request_files	     OUT SYS_REFCURSOR
14:33:52 360  	) AS
14:33:52 361  	BEGIN
14:33:52 362  	  OPEN out_request_files FOR
14:33:52 363  	  SELECT DISTINCT rf.ID, rf.FILE_NAME
14:33:52 364  	  FROM CC_REQUEST_FILE rf, CC_UPDATE u
14:33:52 365  	  WHERE CC_REQUEST_FILE_STATUS in ('SENT', 'RESPONSE_DOWNLOADED', 'REPORT_DOWNLOADED', 'RESPONSE_COMPLETE')
14:33:52 366  	  AND rf.ID = u.CC_REQUEST_FILE_ID
14:33:52 367  	  AND u.CC_UPDATE_STATUS  = 'REQUEST_FAILED'
14:33:52 368  	  AND u.UPDATE_DATE < SYSDATE - (in_max_hours_before_report / 24)
14:33:52 369  	  MINUS
14:33:52 370  	  SELECT rf.ID, rf.FILE_NAME
14:33:52 371  	  FROM CC_REQUEST_FILE rf, CC_UPDATE u
14:33:52 372  	  WHERE CC_REQUEST_FILE_STATUS in ('SENT', 'RESPONSE_DOWNLOADED', 'REPORT_DOWNLOADED', 'RESPONSE_COMPLETE')
14:33:52 373  	  AND rf.ID = u.CC_REQUEST_FILE_ID
14:33:52 374  	  AND u.UPDATE_DATE < SYSDATE - (in_max_hours_before_report / 24)
14:33:52 375  	  AND u.CC_UPDATE_STATUS NOT IN ('UPDATED', 'NO_UPDATE', 'REQUEST_FAILED');
14:33:52 376  	END COMPLETABLE_REQUESTS_W_FAILS;
14:33:52 377  
14:33:52 378  	/****************************************************************************/
14:33:52 379  
14:33:52 380  	PROCEDURE GET_GROUP_ID_BY_ACCOUNT_ID (
14:33:52 381  	  in_account_id IN NUMBER,
14:33:52 382  	  out_group_id	OUT NUMBER
14:33:52 383  	) AS
14:33:52 384  	BEGIN
14:33:52 385  	  PROCS_ACCOUNT_V22.GET_GROUP_ID_BY_ACCOUNT_ID(
14:33:52 386  	    in_account_id => in_account_id,
14:33:52 387  	    out_group_id => out_group_id
14:33:52 388  	  );
14:33:52 389  	END GET_GROUP_ID_BY_ACCOUNT_ID;
14:33:52 390  
14:33:52 391  	/****************************************************************************/
14:33:52 392  
14:33:52 393  	PROCEDURE GET_LICENSE_BY_ID (
14:33:52 394  	  in_license_id  IN NUMBER,
14:33:52 395  	  out_result_set OUT SYS_REFCURSOR
14:33:52 396  	) AS
14:33:52 397  	BEGIN
14:33:52 398  	  PROCS_LICENSE_V22.GET_LICENSE_BY_ID(
14:33:52 399  	    in_license_id => in_license_id,
14:33:52 400  	    out_result_set => out_result_set
14:33:52 401  	  );
14:33:52 402  	END GET_LICENSE_BY_ID;
14:33:52 403  
14:33:52 404  END PROCS_CUPY;
14:33:52 405  .
14:33:52 SQL> /

Package body created.

Elapsed: 00:00:00.50
14:33:52 SQL> 
14:33:52 SQL> CREATE OR REPLACE
14:33:52   2  PACKAGE BODY PROCS_ENTITLEMENT_V22 AS
14:33:52   3  
14:33:52   4  	PROCEDURE GET_ARCHIVE_ENTITLEMENT_URI(
14:33:52   5  	  in_subscription_id IN NUMBER,
14:33:52   6  	  out_uri OUT VARCHAR2)
14:33:52   7  	AS
14:33:52   8  	  SPROC_NAME	  CONSTANT VARCHAR2(30) := 'GET_ARCHIVE_ENTITLEMENT_URI';
14:33:52   9  	  UNKNOWN_ERROR   EXCEPTION;
14:33:52  10  	BEGIN
14:33:52  11  	  SELECT
14:33:52  12  	    POMD.VALUE INTO out_uri
14:33:52  13  	  FROM
14:33:52  14  	     OFFER_PRODUCT_OFFERING OPO,
14:33:52  15  	     PRODUCT_OFFERING PO,
14:33:52  16  	     OFFER_OFFER_CHAIN OOC,
14:33:52  17  	     SUBSCRIPTION S,
14:33:52  18  	     LICENSE LL,
14:33:52  19  	     PRODUCT_OFFERING_META_DATA POMD
14:33:52  20  	  WHERE
14:33:52  21  	     OPO.OFFER_ID = OOC.OFFER_ID AND
14:33:52  22  	     OOC.OFFER_CHAIN_ID = S.OFFER_CHAIN_ID AND
14:33:52  23  	     S.ID = in_subscription_id AND
14:33:52  24  	     PO.ID = OPO.PRODUCT_OFFERING_ID AND
14:33:52  25  	     PO.ID = POMD.PRODUCT_OFFERING_ID AND
14:33:52  26  	     PO.CAPABILITY_ID = 1 AND
14:33:52  27  	     S.ID = LL.SUBSCRIPTION_ID AND
14:33:52  28  	     SYSDATE BETWEEN LL.START_DATE AND LL.ENTITLEMENT_END_DATE AND
14:33:52  29  	     NAME = 'entitlement_uri' AND
14:33:52  30  	     rownum < 2;
14:33:52  31  	EXCEPTION
14:33:52  32  	  WHEN OTHERS THEN
14:33:52  33  	    PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52  34  	      SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52  35  	END GET_ARCHIVE_ENTITLEMENT_URI;
14:33:52  36  
14:33:52  37  	PROCEDURE GET_ALL_ENTITLEMENTS(
14:33:52  38  	  in_group_id	 IN  NUMBER,
14:33:52  39  	  out_result_set OUT SYS_REFCURSOR)
14:33:52  40  	AS
14:33:52  41  	  -- CONSTANTS
14:33:52  42  	  SPROC_NAME	  CONSTANT VARCHAR2(20) := 'GET_ALL_ENTITLEMENTS';
14:33:52  43  	  -- EXCEPTIONS
14:33:52  44  	  NOT_FOUND	  EXCEPTION;
14:33:52  45  	  UNKNOWN_ERROR   EXCEPTION;
14:33:52  46  	  -- VARIABLES
14:33:52  47  	  var_subs	  SYS_REFCURSOR;
14:33:52  48  	BEGIN
14:33:52  49  	  OPEN out_result_set FOR
14:33:52  50  
14:33:52  51  	SELECT
14:33:52  52  	  C.CODE NAME,
14:33:52  53  	  C.DESCRIPTION,
14:33:52  54  	  0 INHERITED,
14:33:52  55  	  C.SHAREABLE,
14:33:52  56  	  MAX(LIC.ENTITLEMENT_END_DATE) EXPIRES
14:33:52  57  	FROM
14:33:52  58  	  SUBSCRIPTION SB
14:33:52  59  	  INNER JOIN ACCOUNT AC ON AC.ID = SB.ACCOUNT_ID
14:33:52  60  	  INNER JOIN LICENSE LIC ON LIC.SUBSCRIPTION_ID = SB.ID
14:33:52  61  	  INNER JOIN OFFER_PRODUCT_OFFERING OPO ON OPO.OFFER_ID = LIC.OFFER_ID
14:33:52  62  	  INNER JOIN PRODUCT_OFFERING PO ON PO.ID = OPO.PRODUCT_OFFERING_ID
14:33:52  63  	  INNER JOIN CAPABILITY C ON PO.CAPABILITY_ID = C.ID
14:33:52  64  	WHERE
14:33:52  65  	  LIC.ENTITLEMENT_END_DATE >= TRUNC(SYSDATE)
14:33:52  66  	  AND LIC.START_DATE <= SYSDATE
14:33:52  67  	  AND AC.GROUP_ID = in_group_id
14:33:52  68  	GROUP BY
14:33:52  69  	  C.CODE, 0, C.SHAREABLE, C.DESCRIPTION
14:33:52  70  UNION ALL
14:33:52  71  	SELECT
14:33:52  72  	  C.CODE NAME,
14:33:52  73  	  C.DESCRIPTION,
14:33:52  74  	  1 INHERITED,
14:33:52  75  	  C.SHAREABLE,
14:33:52  76  	  MAX(LEAST(SS.END_DATE, LIC.ENTITLEMENT_END_DATE)) EXPIRES
14:33:52  77  	FROM
14:33:52  78  	  ACCOUNT BORROWER,
14:33:52  79  	  SUBSCRIPTION S,
14:33:52  80  	  LICENSE LIC,
14:33:52  81  	  OFFER_PRODUCT_OFFERING OPO,
14:33:52  82  	  PRODUCT_OFFERING PO,
14:33:52  83  	  CAPABILITY C,
14:33:52  84  	  GROUP_ACCOUNT GA,
14:33:52  85  	  SUBSCRIPTION_SHARE SS
14:33:52  86  	WHERE
14:33:52  87  	  BORROWER.GROUP_ID = in_group_id
14:33:52  88  	  AND LIC.SUBSCRIPTION_ID = S.ID
14:33:52  89  	  AND OPO.OFFER_ID = LIC.OFFER_ID
14:33:52  90  	  AND PO.ID = OPO.PRODUCT_OFFERING_ID
14:33:52  91  	  AND PO.CAPABILITY_ID = C.ID
14:33:52  92  	  AND GA.SUBSCRIPTION_ID = S.ID
14:33:52  93  	  AND SS.BORROWER_ACCOUNT_ID = BORROWER.ID
14:33:52  94  	  AND SS.GROUP_ACCOUNT_ID = GA.ID
14:33:52  95  	  AND SYSDATE BETWEEN SS.START_DATE AND SS.END_DATE
14:33:52  96  	  AND SYSDATE BETWEEN LIC.START_DATE AND LIC.ENTITLEMENT_END_DATE
14:33:52  97  	  AND C.SHAREABLE = 1
14:33:52  98  	GROUP BY
14:33:52  99  	  C.CODE, 0, C.SHAREABLE, C.DESCRIPTION;
14:33:52 100  
14:33:52 101  	EXCEPTION
14:33:52 102  	  WHEN OTHERS THEN
14:33:52 103  	    PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52 104  	      SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52 105  	END GET_ALL_ENTITLEMENTS;
14:33:52 106  
14:33:52 107  	PROCEDURE GET_ITUNES_ENTITLEMENTS(
14:33:52 108  	  in_product_id IN CORE_OWNER.ITUNES_RECEIPT.PRODUCT_ID%TYPE,
14:33:52 109  	  out_result_set OUT SYS_REFCURSOR)
14:33:52 110  	AS
14:33:52 111  	  -- CONSTANTS
14:33:52 112  	  SPROC_NAME	  CONSTANT VARCHAR2(25) := 'GET_ITUNES_ENTITLEMENTS';
14:33:52 113  	  -- EXCEPTIONS
14:33:52 114  	  NOT_FOUND	  EXCEPTION;
14:33:52 115  	  UNKNOWN_ERROR   EXCEPTION;
14:33:52 116  	  -- VARIABLES
14:33:52 117  	  var_subs	  SYS_REFCURSOR;
14:33:52 118  	BEGIN
14:33:52 119  	  OPEN out_result_set FOR
14:33:52 120  
14:33:52 121  	      SELECT
14:33:52 122  		c.code NAME,
14:33:52 123  		C.DESCRIPTION,
14:33:52 124  		0 INHERITED,
14:33:52 125  		C.SHAREABLE,
14:33:52 126  		sysdate as EXPIRES
14:33:52 127  	      FROM
14:33:52 128  		offer_offer_chain ooc,
14:33:52 129  		offer o,
14:33:52 130  		offer_product_offering opo,
14:33:52 131  		product_offering po,
14:33:52 132  		capability c
14:33:52 133  	      WHERE
14:33:52 134  		o.id = ooc.offer_id AND
14:33:52 135  		opo.offer_id = o.id AND
14:33:52 136  		po.id = opo.product_offering_id AND
14:33:52 137  		c.id = po.capability_id AND
14:33:52 138  		c.id !=0 AND
14:33:52 139  		ooc.offer_chain_id =
14:33:52 140  		(SELECT
14:33:52 141  		    ocmd.offer_chain_id
14:33:52 142  		  FROM
14:33:52 143  		      offer_chain_meta_data ocmd
14:33:52 144  		  WHERE
14:33:52 145  			      ocmd.name = 'ITUNES_PRODUCT_ID' AND
14:33:52 146  		      ocmd.value = in_product_id AND
14:33:52 147  		      rownum < 2
14:33:52 148  		)
14:33:52 149  	      ;
14:33:52 150  
14:33:52 151  	EXCEPTION
14:33:52 152  	  WHEN OTHERS THEN
14:33:52 153  	    PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52 154  	      SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52 155  	END GET_ITUNES_ENTITLEMENTS;
14:33:52 156  
14:33:52 157  END PROCS_ENTITLEMENT_V22;
14:33:52 158  .
14:33:52 SQL> /

Package body created.

Elapsed: 00:00:00.04
14:33:52 SQL> 
14:33:52 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_HISTORY_V22" AS
14:33:52   2  
14:33:52   3  PROCEDURE CREATE_AASR_HISTORY(
14:33:52   4  	in_id			     IN CORE_OWNER.AMAZON_APPSTORE_RECEIPT.ID%TYPE,
14:33:52   5  	in_system_activity_reason_id IN NUMBER,
14:33:52   6  	in_created_by		     IN VARCHAR2
14:33:52   7  ) AS
14:33:52   8  SPROC_NAME CONSTANT VARCHAR2(32) := 'CREATE_AASR_HISTORY';
14:33:52   9  var_id		  AMAZON_APPSTORE_RECEIPT.ID%TYPE;
14:33:52  10  var_subscription_id AMAZON_APPSTORE_RECEIPT.SUBSCRIPTION_ID%TYPE;
14:33:52  11  var_user_id	  AMAZON_APPSTORE_RECEIPT.USER_ID%TYPE;
14:33:52  12  var_item_type	  AMAZON_APPSTORE_RECEIPT.ITEM_TYPE%TYPE;
14:33:52  13  var_start_date	  AMAZON_APPSTORE_RECEIPT.START_DATE%TYPE;
14:33:52  14  var_end_date	  AMAZON_APPSTORE_RECEIPT.END_DATE%TYPE;
14:33:52  15  var_sku		  AMAZON_APPSTORE_RECEIPT.SKU%TYPE;
14:33:52  16  var_purchase_token  AMAZON_APPSTORE_RECEIPT.PURCHASE_TOKEN%TYPE;
14:33:52  17  var_create_date	  AMAZON_APPSTORE_RECEIPT.CREATE_DATE%TYPE;
14:33:52  18  var_created_by	  AMAZON_APPSTORE_RECEIPT.CREATED_BY%TYPE;
14:33:52  19  var_update_date	  AMAZON_APPSTORE_RECEIPT.UPDATE_DATE%TYPE;
14:33:52  20  var_updated_by	  AMAZON_APPSTORE_RECEIPT.UPDATED_BY%TYPE;
14:33:52  21  var_last_check_date AMAZON_APPSTORE_RECEIPT.LAST_CHECK_DATE%TYPE;
14:33:52  22  BEGIN
14:33:52  23  	SELECT
14:33:52  24  	  AMAZON_APPSTORE_RECEIPT.ID,
14:33:52  25  	  AMAZON_APPSTORE_RECEIPT.SUBSCRIPTION_ID,
14:33:52  26  	  AMAZON_APPSTORE_RECEIPT.USER_ID,
14:33:52  27  	  AMAZON_APPSTORE_RECEIPT.ITEM_TYPE,
14:33:52  28  	  AMAZON_APPSTORE_RECEIPT.START_DATE,
14:33:52  29  	  AMAZON_APPSTORE_RECEIPT.END_DATE,
14:33:52  30  	  AMAZON_APPSTORE_RECEIPT.SKU,
14:33:52  31  	  AMAZON_APPSTORE_RECEIPT.PURCHASE_TOKEN,
14:33:52  32  	  AMAZON_APPSTORE_RECEIPT.CREATE_DATE,
14:33:52  33  	  AMAZON_APPSTORE_RECEIPT.CREATED_BY,
14:33:52  34  	  AMAZON_APPSTORE_RECEIPT.UPDATE_DATE,
14:33:52  35  	  AMAZON_APPSTORE_RECEIPT.UPDATED_BY,
14:33:52  36  	  AMAZON_APPSTORE_RECEIPT.LAST_CHECK_DATE
14:33:52  37  	INTO
14:33:52  38  	  var_id,
14:33:52  39  	  var_subscription_id,
14:33:52  40  	  var_user_id,
14:33:52  41  	  var_item_type,
14:33:52  42  	  var_start_date,
14:33:52  43  	  var_end_date,
14:33:52  44  	  var_sku,
14:33:52  45  	  var_purchase_token,
14:33:52  46  	  var_create_date,
14:33:52  47  	  var_created_by,
14:33:52  48  	  var_update_date,
14:33:52  49  	  var_updated_by,
14:33:52  50  	  var_last_check_date
14:33:52  51  	FROM
14:33:52  52  	  AMAZON_APPSTORE_RECEIPT
14:33:52  53  	WHERE
14:33:52  54  	  AMAZON_APPSTORE_RECEIPT.ID = in_id;
14:33:52  55  
14:33:52  56  	CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V22.CREATE_AASR_HISTORY(
14:33:52  57  	    var_id,
14:33:52  58  	    var_subscription_id,
14:33:52  59  	    var_user_id,
14:33:52  60  	    var_item_type,
14:33:52  61  	    var_start_date,
14:33:52  62  	    var_end_date,
14:33:52  63  	    var_sku,
14:33:52  64  	    var_purchase_token,
14:33:52  65  	    var_create_date,
14:33:52  66  	    var_created_by,
14:33:52  67  	    var_update_date,
14:33:52  68  	    var_updated_by,
14:33:52  69  	    in_system_activity_reason_id,
14:33:52  70  	    in_created_by,
14:33:52  71  	    var_last_check_date
14:33:52  72  	);
14:33:52  73  END CREATE_AASR_HISTORY;
14:33:52  74  
14:33:52  75  PROCEDURE CREATE_ADDRESS_HISTORY(
14:33:52  76  	in_address_id		     IN NUMBER,
14:33:52  77  	in_system_activity_reason_id IN NUMBER
14:33:52  78  ) AS
14:33:52  79  SPROC_NAME CONSTANT VARCHAR2(22) := 'CREATE_ADDRESS_HISTORY';
14:33:52  80  -- VARIABLES
14:33:52  81  var_address1    ADDRESS.ADDRESS1%TYPE;
14:33:52  82  var_address2    ADDRESS.ADDRESS2%TYPE;
14:33:52  83  var_city	      ADDRESS.CITY%TYPE;
14:33:52  84  var_state       ADDRESS.STATE%TYPE;
14:33:52  85  var_postal_code ADDRESS.POSTAL_CODE%TYPE;
14:33:52  86  var_country     ADDRESS.COUNTRY%TYPE;
14:33:52  87  var_created_by  ADDRESS.CREATED_BY%TYPE;
14:33:52  88  var_create_date ADDRESS.CREATE_DATE%TYPE;
14:33:52  89  var_updated_by  ADDRESS.UPDATED_BY%TYPE;
14:33:52  90  var_update_date ADDRESS.UPDATE_DATE%TYPE;
14:33:52  91  -- EXCEPTIONS
14:33:52  92  BAD_ADDRESS_ID	     EXCEPTION;
14:33:52  93  CAN_NOT_CREATE_HISTORY EXCEPTION;
14:33:52  94  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:52  95  BEGIN
14:33:52  96  
14:33:52  97  	BEGIN
14:33:52  98  	  SELECT
14:33:52  99  	    ADDRESS.ADDRESS1,
14:33:52 100  	    ADDRESS.ADDRESS2,
14:33:52 101  	    ADDRESS.CITY,
14:33:52 102  	    ADDRESS.STATE,
14:33:52 103  	    ADDRESS.POSTAL_CODE,
14:33:52 104  	    ADDRESS.COUNTRY,
14:33:52 105  	    ADDRESS.CREATED_BY,
14:33:52 106  	    ADDRESS.CREATE_DATE,
14:33:52 107  	    ADDRESS.UPDATED_BY,
14:33:52 108  	    ADDRESS.UPDATE_DATE
14:33:52 109  	    into
14:33:52 110  	    var_address1,
14:33:52 111  	    var_address2,
14:33:52 112  	    var_city,
14:33:52 113  	    var_state,
14:33:52 114  	    var_postal_code,
14:33:52 115  	    var_country,
14:33:52 116  	    var_created_by,
14:33:52 117  	    var_create_date,
14:33:52 118  	    var_updated_by,
14:33:52 119  	    var_update_date
14:33:52 120  	  FROM
14:33:52 121  	    ADDRESS
14:33:52 122  	  WHERE
14:33:52 123  	    ADDRESS.ID = in_address_id;
14:33:52 124  	  EXCEPTION
14:33:52 125  	    WHEN NO_DATA_FOUND THEN
14:33:52 126  	      RAISE BAD_ADDRESS_ID;
14:33:52 127  	END;
14:33:52 128  
14:33:52 129  	BEGIN
14:33:52 130  	  CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V22.CREATE_ADDRESS_HISTORY(
14:33:52 131  	    in_address_id,
14:33:52 132  	    in_system_activity_reason_id,
14:33:52 133  	    var_address1,
14:33:52 134  	    var_address2,
14:33:52 135  	    var_city,
14:33:52 136  	    var_state,
14:33:52 137  	    var_postal_code,
14:33:52 138  	    var_country,
14:33:52 139  	    var_created_by,
14:33:52 140  	    var_create_date,
14:33:52 141  	    var_updated_by,
14:33:52 142  	    var_update_date
14:33:52 143  	  );
14:33:52 144  	  EXCEPTION
14:33:52 145  	    WHEN OTHERS THEN
14:33:52 146  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:52 147  	      RAISE CAN_NOT_CREATE_HISTORY;
14:33:52 148  	END;
14:33:52 149  
14:33:52 150  EXCEPTION
14:33:52 151  WHEN BAD_ADDRESS_ID THEN
14:33:52 152  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:52 153  	  SPROC_NAME, 'Bad recipientAddress id');
14:33:52 154  WHEN CAN_NOT_CREATE_HISTORY THEN
14:33:52 155  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:52 156  	  SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
14:33:52 157  WHEN OTHERS THEN
14:33:52 158  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52 159  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52 160  END CREATE_ADDRESS_HISTORY;
14:33:52 161  
14:33:52 162  /********************************************************************/
14:33:52 163  
14:33:52 164  PROCEDURE CREATE_ACCOUNT_HISTORY(
14:33:52 165  	in_account_id		     IN NUMBER,
14:33:52 166  	in_system_activity_reason_id IN NUMBER
14:33:52 167  ) AS
14:33:52 168  SPROC_NAME CONSTANT VARCHAR2(22) := 'CREATE_ACCOUNT_HISTORY';
14:33:52 169  -- VARIABLES
14:33:52 170  var_account_status_id  NUMBER;
14:33:52 171  var_suspend_date	     DATE;
14:33:52 172  var_group_id	     NUMBER;
14:33:52 173  var_instrument_type_id NUMBER;
14:33:52 174  var_instrument_id      NUMBER;
14:33:52 175  var_updated_by	     VARCHAR2(255);
14:33:52 176  var_update_date	     DATE;
14:33:52 177  -- EXCEPTIONS
14:33:52 178  BAD_ACCOUNT_ID	     EXCEPTION;
14:33:52 179  CAN_NOT_CREATE_HISTORY EXCEPTION;
14:33:52 180  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:52 181  BEGIN
14:33:52 182  
14:33:52 183  	BEGIN
14:33:52 184  	  SELECT
14:33:52 185  	    ACCOUNT.ACCOUNT_STATUS_ID,
14:33:52 186  	    ACCOUNT.GROUP_ID,
14:33:52 187  	    ACCOUNT.INSTRUMENT_TYPE_ID,
14:33:52 188  	    ACCOUNT.INSTRUMENT_ID,
14:33:52 189  	    ACCOUNT.UPDATED_BY,
14:33:52 190  	    ACCOUNT.UPDATE_DATE
14:33:52 191  	    into
14:33:52 192  	    var_account_status_id,
14:33:52 193  	    var_group_id,
14:33:52 194  	    var_instrument_type_id,
14:33:52 195  	    var_instrument_id,
14:33:52 196  	    var_updated_by,
14:33:52 197  	    var_update_date
14:33:52 198  	  FROM
14:33:52 199  	    ACCOUNT
14:33:52 200  	  WHERE
14:33:52 201  	    ACCOUNT.ID = in_account_id;
14:33:52 202  	  EXCEPTION
14:33:52 203  	    WHEN NO_DATA_FOUND THEN
14:33:52 204  	      RAISE BAD_ACCOUNT_ID;
14:33:52 205  	END;
14:33:52 206  
14:33:52 207  	BEGIN
14:33:52 208  	  CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V22.CREATE_ACCOUNT_HISTORY(
14:33:52 209  	    in_account_id,
14:33:52 210  	    var_suspend_date,
14:33:52 211  	    var_group_id,
14:33:52 212  	    var_updated_by,
14:33:52 213  	    var_update_date,
14:33:52 214  	    in_system_activity_reason_id,
14:33:52 215  	    var_account_status_id,
14:33:52 216  	    var_instrument_type_id,
14:33:52 217  	    var_instrument_id
14:33:52 218  	  );
14:33:52 219  	  EXCEPTION
14:33:52 220  	    WHEN OTHERS THEN
14:33:52 221  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:52 222  	      RAISE CAN_NOT_CREATE_HISTORY;
14:33:52 223  	END;
14:33:52 224  
14:33:52 225  EXCEPTION
14:33:52 226  WHEN BAD_ACCOUNT_ID THEN
14:33:52 227  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:52 228  	  SPROC_NAME, 'Bad account id');
14:33:52 229  WHEN CAN_NOT_CREATE_HISTORY THEN
14:33:52 230  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:52 231  	  SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
14:33:52 232  WHEN OTHERS THEN
14:33:52 233  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52 234  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52 235  END CREATE_ACCOUNT_HISTORY;
14:33:52 236  
14:33:52 237  /********************************************************************/
14:33:52 238  
14:33:52 239  PROCEDURE CREATE_SUBSCRIPTION_HISTORY (
14:33:52 240  	in_subscription_id	     IN NUMBER,
14:33:52 241  	in_system_activity_reason_id IN NUMBER
14:33:52 242  ) AS
14:33:52 243  SPROC_NAME CONSTANT VARCHAR2(27) := 'CREATE_SUBSCRIPTION_HISTORY';
14:33:52 244  -- VARIABLES
14:33:52 245  var_account_id		    NUMBER;
14:33:52 246  var_purchase_date 	    DATE;
14:33:52 247  var_offer_chain_id	    NUMBER;
14:33:52 248  var_suspend_date		    DATE;
14:33:52 249  var_termination_date	    DATE;
14:33:52 250  var_days_ramaining_adjustment NUMBER;
14:33:52 251  var_sct_id		    NUMBER;
14:33:52 252  var_updated_by		    VARCHAR2(255);
14:33:52 253  var_update_date		    DATE;
14:33:52 254  -- EXCEPTIONS
14:33:52 255  BAD_SUBSCRIPTION_ID    EXCEPTION;
14:33:52 256  CAN_NOT_CREATE_HISTORY EXCEPTION;
14:33:52 257  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:52 258  BEGIN
14:33:52 259  
14:33:52 260  	BEGIN
14:33:52 261  	  SELECT
14:33:52 262  	    SUBSCRIPTION.account_id,
14:33:52 263  	    SUBSCRIPTION.PURCHASE_DATE,
14:33:52 264  	    SUBSCRIPTION.OFFER_CHAIN_ID,
14:33:52 265  	    SUBSCRIPTION.SUSPEND_DATE,
14:33:52 266  	    SUBSCRIPTION.TERMINATION_DATE,
14:33:52 267  	    SUBSCRIPTION.DAYS_REMAINING_ADJUSTMENT,
14:33:52 268  	    SUBSCRIPTION.SCT_ID,
14:33:52 269  	    SUBSCRIPTION.UPDATED_BY,
14:33:52 270  	    SUBSCRIPTION.UPDATE_DATE
14:33:52 271  	    into
14:33:52 272  	    var_account_id,
14:33:52 273  	    var_purchase_date,
14:33:52 274  	    var_offer_chain_id,
14:33:52 275  	    var_suspend_date,
14:33:52 276  	    var_termination_date,
14:33:52 277  	    var_days_ramaining_adjustment,
14:33:52 278  	    var_sct_id,
14:33:52 279  	    var_updated_by,
14:33:52 280  	    var_update_date
14:33:52 281  	  FROM
14:33:52 282  	    SUBSCRIPTION
14:33:52 283  	  WHERE
14:33:52 284  	    SUBSCRIPTION.ID = in_subscription_id;
14:33:52 285  	  EXCEPTION
14:33:52 286  	    WHEN NO_DATA_FOUND THEN
14:33:52 287  	      RAISE BAD_SUBSCRIPTION_ID;
14:33:52 288  	END;
14:33:52 289  
14:33:52 290  	BEGIN
14:33:52 291  	  CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V22.CREATE_SUBSCRIPTION_HISTORY(
14:33:52 292  	    in_subscription_id,
14:33:52 293  	    var_account_id,
14:33:52 294  	    var_purchase_date,
14:33:52 295  	    var_offer_chain_id,
14:33:52 296  	    var_suspend_date,
14:33:52 297  	    var_termination_date,
14:33:52 298  	    var_days_ramaining_adjustment,
14:33:52 299  	    var_sct_id,
14:33:52 300  	    var_updated_by,
14:33:52 301  	    var_update_date,
14:33:52 302  	    in_system_activity_reason_id
14:33:52 303  	  );
14:33:52 304  	  EXCEPTION
14:33:52 305  	    WHEN OTHERS THEN
14:33:52 306  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:52 307  	      RAISE CAN_NOT_CREATE_HISTORY;
14:33:52 308  	END;
14:33:52 309  
14:33:52 310  EXCEPTION
14:33:52 311  WHEN BAD_SUBSCRIPTION_ID THEN
14:33:52 312  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:52 313  	  SPROC_NAME, 'No such subscription');
14:33:52 314  WHEN CAN_NOT_CREATE_HISTORY THEN
14:33:52 315  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:52 316  	  SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
14:33:52 317  WHEN OTHERS THEN
14:33:52 318  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52 319  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52 320  END CREATE_SUBSCRIPTION_HISTORY;
14:33:52 321  
14:33:52 322  /********************************************************************/
14:33:52 323  
14:33:52 324  PROCEDURE CREATE_CREDIT_CARD_HISTORY(
14:33:52 325  	in_credit_card_id	      IN NUMBER,
14:33:52 326  	in_system_activity_reason_id  IN NUMBER
14:33:52 327  ) AS
14:33:52 328  SPROC_NAME CONSTANT VARCHAR2(26) := 'CREATE_CREDIT_CARD_HISTORY';
14:33:52 329  -- VARIABLES
14:33:52 330  var_account_id		     NUMBER;
14:33:52 331  var_instrument_name	     VARCHAR2(255);
14:33:52 332  var_private_card_holder_name   VARCHAR2(256);
14:33:52 333  var_private_street_address     VARCHAR2(256);
14:33:52 334  var_private_street_address2    VARCHAR2(256);
14:33:52 335  var_state 		     VARCHAR2(50);
14:33:52 336  var_city			     VARCHAR2(50);
14:33:52 337  var_postal_code		     VARCHAR2(20);
14:33:52 338  var_country		     CHAR(2);
14:33:52 339  var_last_four_cc		     VARCHAR2(4);
14:33:52 340  var_expiration_date	     DATE;
14:33:52 341  var_credit_card_type_id	     NUMBER;
14:33:52 342  var_secret_token		     VARCHAR2(255);
14:33:52 343  var_chase_profile_id	     VARCHAR2(255);
14:33:52 344  var_credit_card_status_id      NUMBER;
14:33:52 345  var_updated_by		     VARCHAR2(255);
14:33:52 346  var_update_date		     DATE;
14:33:52 347  -- EXCEPTIONS
14:33:52 348  BAD_CREDIT_CARD_ID     EXCEPTION;
14:33:52 349  CAN_NOT_CREATE_HISTORY EXCEPTION;
14:33:52 350  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:52 351  BEGIN
14:33:52 352  
14:33:52 353  	BEGIN
14:33:52 354  	  SELECT
14:33:52 355  	    ACCOUNT_ID,
14:33:52 356  	    INSTRUMENT_NAME,
14:33:52 357  	    PRIVATE_CARD_HOLDER_NAME,
14:33:52 358  	    PRIVATE_STREET_ADDRESS,
14:33:52 359  	    PRIVATE_STREET_ADDRESS2,
14:33:52 360  	    STATE,
14:33:52 361  	    CITY,
14:33:52 362  	    POSTAL_CODE,
14:33:52 363  	    COUNTRY,
14:33:52 364  	    LAST_FOUR_CC,
14:33:52 365  	    EXPIRATION_DATE,
14:33:52 366  	    CREDIT_CARD_TYPE_ID,
14:33:52 367  	    SECRET_TOKEN,
14:33:52 368  	    CHASE_PROFILE_ID,
14:33:52 369  	    CREDIT_CARD_STATUS_ID,
14:33:52 370  	    UPDATED_BY,
14:33:52 371  	    UPDATE_DATE
14:33:52 372  	    into
14:33:52 373  	    var_account_id,
14:33:52 374  	    var_instrument_name,
14:33:52 375  	    var_private_card_holder_name,
14:33:52 376  	    var_private_street_address,
14:33:52 377  	    var_private_street_address2,
14:33:52 378  	    var_state,
14:33:52 379  	    var_city,
14:33:52 380  	    var_postal_code,
14:33:52 381  	    var_country,
14:33:52 382  	    var_last_four_cc,
14:33:52 383  	    var_expiration_date,
14:33:52 384  	    var_credit_card_type_id,
14:33:52 385  	    var_secret_token,
14:33:52 386  	    var_chase_profile_id,
14:33:52 387  	    var_credit_card_status_id,
14:33:52 388  	    var_updated_by,
14:33:52 389  	    var_update_date
14:33:52 390  	  FROM
14:33:52 391  	    CREDIT_CARD
14:33:52 392  	  WHERE
14:33:52 393  	    CREDIT_CARD.ID = in_credit_card_id;
14:33:52 394  	  EXCEPTION
14:33:52 395  	    WHEN NO_DATA_FOUND THEN
14:33:52 396  	      RAISE BAD_CREDIT_CARD_ID;
14:33:52 397  	END;
14:33:52 398  
14:33:52 399  	BEGIN
14:33:52 400  	  CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V22.CREATE_CREDIT_CARD_HISTORY(
14:33:52 401  	    in_credit_card_id,
14:33:52 402  	    var_account_id,
14:33:52 403  	    var_instrument_name,
14:33:52 404  	    var_private_card_holder_name,
14:33:52 405  	    var_private_street_address,
14:33:52 406  	    var_private_street_address2,
14:33:52 407  	    var_state,
14:33:52 408  	    var_city,
14:33:52 409  	    var_postal_code,
14:33:52 410  	    var_country,
14:33:52 411  	    var_last_four_cc,
14:33:52 412  	    var_expiration_date,
14:33:52 413  	    var_credit_card_type_id,
14:33:52 414  	    var_secret_token,
14:33:52 415  	    var_chase_profile_id,
14:33:52 416  	    var_credit_card_status_id,
14:33:52 417  	    var_updated_by,
14:33:52 418  	    var_update_date,
14:33:52 419  	    in_system_activity_reason_id
14:33:52 420  	  );
14:33:52 421  	  EXCEPTION
14:33:52 422  	    WHEN OTHERS THEN
14:33:52 423  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:52 424  	      RAISE CAN_NOT_CREATE_HISTORY;
14:33:52 425  	END;
14:33:52 426  
14:33:52 427  EXCEPTION
14:33:52 428  WHEN BAD_CREDIT_CARD_ID THEN
14:33:52 429  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:52 430  	  SPROC_NAME, 'No such credit card');
14:33:52 431  WHEN CAN_NOT_CREATE_HISTORY THEN
14:33:52 432  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:52 433  	  SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
14:33:52 434  WHEN OTHERS THEN
14:33:52 435  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52 436  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52 437  END CREATE_CREDIT_CARD_HISTORY;
14:33:52 438  
14:33:52 439  /********************************************************************/
14:33:52 440  
14:33:52 441  PROCEDURE CREATE_PAYPAL_HISTORY(
14:33:52 442  /*
14:33:52 443  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:52 444  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:52 445  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:52 446  */
14:33:52 447  	in_paypal_id		      IN NUMBER,
14:33:52 448  	in_system_activity_reason_id  IN NUMBER
14:33:52 449  ) AS
14:33:52 450  SPROC_NAME CONSTANT VARCHAR(21) := 'CREATE_PAYPAL_HISTORY';
14:33:52 451  -- VARIABLES
14:33:52 452  var_account_id		   PAYPAL.ACCOUNT_ID%TYPE;
14:33:52 453  var_instrument_name	   PAYPAL.INSTRUMENT_NAME%TYPE DEFAULT NULL;
14:33:52 454  var_private_email_address    PAYPAL.PRIVATE_EMAIL_ADDRESS%TYPE DEFAULT NULL;
14:33:52 455  var_created_by		   PAYPAL.CREATED_BY%TYPE;
14:33:52 456  var_paypal_status_id	   PAYPAL.PAYPAL_STATUS_ID%TYPE;
14:33:52 457  var_paypal_prvt_street_addr  PAYPAL.PRIVATE_STREET_ADDRESS%TYPE;
14:33:52 458  var_paypal_prvt_street_addr2 PAYPAL.PRIVATE_STREET_ADDRESS2%TYPE;
14:33:52 459  var_state 		   PAYPAL.STATE%TYPE;
14:33:52 460  var_city			   PAYPAL.CITY%TYPE;
14:33:52 461  var_postal_code		   PAYPAL.POSTAL_CODE%TYPE;
14:33:52 462  var_country		   PAYPAL.COUNTRY%TYPE;
14:33:52 463  var_expiration_date	   PAYPAL.EXPIRATION_DATE%TYPE;
14:33:52 464  var_update_date		   PAYPAL.UPDATE_DATE%TYPE;
14:33:52 465  var_updated_by		   PAYPAL.UPDATED_BY%TYPE;
14:33:52 466  var_secret_token		   PAYPAL.SECRET_TOKEN%TYPE;
14:33:52 467  -- EXCEPTION
14:33:52 468  BAD_PAYPAL_ID	  EXCEPTION;
14:33:52 469  CAN_NOT_ADD_HISTORY EXCEPTION;
14:33:52 470  EXCEPTION_MESSAGE   VARCHAR2(1024);
14:33:52 471  BEGIN
14:33:52 472  
14:33:52 473  	BEGIN
14:33:52 474  	  SELECT
14:33:52 475  	    ACCOUNT_ID,
14:33:52 476  	    INSTRUMENT_NAME,
14:33:52 477  	    PRIVATE_EMAIL_ADDRESS,
14:33:52 478  	    UPDATE_DATE,
14:33:52 479  	    UPDATED_BY,
14:33:52 480  	    PAYPAL_STATUS_ID,
14:33:52 481  	    PRIVATE_STREET_ADDRESS,
14:33:52 482  	    PRIVATE_STREET_ADDRESS2,
14:33:52 483  	    STATE,
14:33:52 484  	    CITY,
14:33:52 485  	    POSTAL_CODE,
14:33:52 486  	    COUNTRY,
14:33:52 487  	    EXPIRATION_DATE,
14:33:52 488  	    SECRET_TOKEN
14:33:52 489  	  INTO
14:33:52 490  	    var_account_id,
14:33:52 491  	    var_instrument_name,
14:33:52 492  	    var_private_email_address,
14:33:52 493  	    var_update_date,
14:33:52 494  	    var_updated_by,
14:33:52 495  	    var_paypal_status_id,
14:33:52 496  	    var_paypal_prvt_street_addr,
14:33:52 497  	    var_paypal_prvt_street_addr2,
14:33:52 498  	    var_state,
14:33:52 499  	    var_city,
14:33:52 500  	    var_postal_code,
14:33:52 501  	    var_country,
14:33:52 502  	    var_expiration_date,
14:33:52 503  	    var_secret_token
14:33:52 504  	  FROM
14:33:52 505  	    PAYPAL
14:33:52 506  	  WHERE
14:33:52 507  	    ID = in_paypal_id;
14:33:52 508  	  EXCEPTION
14:33:52 509  	    WHEN NO_DATA_FOUND THEN
14:33:52 510  	      RAISE BAD_PAYPAL_ID;
14:33:52 511  	END;
14:33:52 512  
14:33:52 513  	BEGIN
14:33:52 514  	  CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V22.CREATE_PAYPAL_HISTORY(
14:33:52 515  	    in_paypal_id,
14:33:52 516  	    var_account_id,
14:33:52 517  	    var_instrument_name,
14:33:52 518  	    var_private_email_address,
14:33:52 519  	    var_updated_by,
14:33:52 520  	    var_update_date,
14:33:52 521  	    var_paypal_status_id,
14:33:52 522  	    var_paypal_prvt_street_addr,
14:33:52 523  	    var_paypal_prvt_street_addr2,
14:33:52 524  	    var_state,
14:33:52 525  	    var_city,
14:33:52 526  	    var_postal_code,
14:33:52 527  	    var_country,
14:33:52 528  	    var_expiration_date,
14:33:52 529  	    in_system_activity_reason_id,
14:33:52 530  	    var_secret_token
14:33:52 531  	  );
14:33:52 532  	  EXCEPTION
14:33:52 533  	    WHEN OTHERS THEN
14:33:52 534  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:52 535  	      RAISE CAN_NOT_ADD_HISTORY;
14:33:52 536  	END;
14:33:52 537  
14:33:52 538  EXCEPTION
14:33:52 539  WHEN BAD_PAYPAL_ID THEN
14:33:52 540  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:52 541  	  SPROC_NAME, 'No such paypal');
14:33:52 542  WHEN CAN_NOT_ADD_HISTORY THEN
14:33:52 543  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:52 544  	  SPROC_NAME, 'Could not add history', EXCEPTION_MESSAGE);
14:33:52 545  WHEN OTHERS THEN
14:33:52 546  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52 547  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52 548  END CREATE_PAYPAL_HISTORY;
14:33:52 549  
14:33:52 550  /********************************************************************/
14:33:52 551  
14:33:52 552  PROCEDURE CREATE_GIFT_CERT_HISTORY(
14:33:52 553  	in_gift_certificate_id	      IN NUMBER,
14:33:52 554  	in_system_activity_reason_id  IN NUMBER
14:33:52 555  ) AS
14:33:52 556  SPROC_NAME CONSTANT VARCHAR2(24) := 'CREATE_GIFT_CERT_HISTORY';
14:33:52 557  -- VARIABLES
14:33:52 558  var_purchaser_group_id	     NUMBER;
14:33:52 559  var_purchase_invoice_id	     NUMBER;
14:33:52 560  var_offer_chain_id	     NUMBER;
14:33:52 561  var_expiration_date	     DATE;
14:33:52 562  var_purchase_date 	     DATE;
14:33:52 563  var_gift_certificate_status_id NUMBER;
14:33:52 564  var_code			     VARCHAR2(255);
14:33:52 565  var_recipient_name	     VARCHAR2(255);
14:33:52 566  var_gift_message		     VARCHAR2(500);
14:33:52 567  var_recipient_email	     VARCHAR2(255);
14:33:52 568  var_finalized_invoice_id	     NUMBER;
14:33:52 569  var_sender_email		     VARCHAR2(50);
14:33:52 570  var_sender_name		     VARCHAR2(50);
14:33:52 571  var_redemption_date	     DATE;
14:33:52 572  var_redeemer_group_id	     NUMBER;
14:33:52 573  var_cancelation_date	     DATE;
14:33:52 574  var_updated_by		     VARCHAR2(255);
14:33:52 575  var_update_date		     DATE;
14:33:52 576  var_recipient_address_id	     NUMBER;
14:33:52 577  var_redeemer_address_id	     NUMBER;
14:33:52 578  var_recipient_notify_date      DATE;
14:33:52 579  -- EXCEPTIONS
14:33:52 580  BAD_GIFT_CERTIFICATE_ID EXCEPTION;
14:33:52 581  CAN_NOT_CREATE_HISTORY  EXCEPTION;
14:33:52 582  EXCEPTION_MESSAGE       VARCHAR2(1024);
14:33:52 583  BEGIN
14:33:52 584  
14:33:52 585  	BEGIN
14:33:52 586  	  SELECT
14:33:52 587  	    GIFT_CERTIFICATE.PURCHASER_GROUP_ID,
14:33:52 588  	    GIFT_CERTIFICATE.PURCHASE_INVOICE_ID,
14:33:52 589  	    GIFT_CERTIFICATE.OFFER_CHAIN_ID,
14:33:52 590  	    GIFT_CERTIFICATE.EXPIRATION_DATE,
14:33:52 591  	    GIFT_CERTIFICATE.PURCHASE_DATE,
14:33:52 592  	    GIFT_CERTIFICATE.GIFT_CERTIFICATE_STATUS_ID,
14:33:52 593  	    GIFT_CERTIFICATE.CODE,
14:33:52 594  	    GIFT_CERTIFICATE.RECIPIENT_NAME,
14:33:52 595  	    GIFT_CERTIFICATE.GIFT_MESSAGE,
14:33:52 596  	    GIFT_CERTIFICATE.RECIPIENT_EMAIL,
14:33:52 597  	    GIFT_CERTIFICATE.FINALIZED_INVOICE_ID,
14:33:52 598  	    GIFT_CERTIFICATE.SENDER_EMAIL,
14:33:52 599  	    GIFT_CERTIFICATE.SENDER_NAME,
14:33:52 600  	    GIFT_CERTIFICATE.REDEMPTION_DATE,
14:33:52 601  	    GIFT_CERTIFICATE.REDEEMER_GROUP_ID,
14:33:52 602  	    GIFT_CERTIFICATE.CANCELATION_DATE,
14:33:52 603  	    GIFT_CERTIFICATE.UPDATED_BY,
14:33:52 604  	    GIFT_CERTIFICATE.UPDATE_DATE,
14:33:52 605  	    GIFT_CERTIFICATE.RECIPIENT_ADDRESS_ID,
14:33:52 606  	    GIFT_CERTIFICATE.REDEEMER_ADDRESS_ID,
14:33:52 607  	    GIFT_CERTIFICATE.RECIPIENT_NOTIFY_DATE
14:33:52 608  	    into
14:33:52 609  	    var_purchaser_group_id,
14:33:52 610  	    var_purchase_invoice_id,
14:33:52 611  	    var_offer_chain_id,
14:33:52 612  	    var_expiration_date,
14:33:52 613  	    var_purchase_date,
14:33:52 614  	    var_gift_certificate_status_id,
14:33:52 615  	    var_code,
14:33:52 616  	    var_recipient_name,
14:33:52 617  	    var_gift_message,
14:33:52 618  	    var_recipient_email,
14:33:52 619  	    var_finalized_invoice_id,
14:33:52 620  	    var_sender_email,
14:33:52 621  	    var_sender_name,
14:33:52 622  	    var_redemption_date,
14:33:52 623  	    var_redeemer_group_id,
14:33:52 624  	    var_cancelation_date,
14:33:52 625  	    var_updated_by,
14:33:52 626  	    var_update_date,
14:33:52 627  	    var_recipient_address_id,
14:33:52 628  	    var_redeemer_address_id,
14:33:52 629  	    var_recipient_notify_date
14:33:52 630  	  FROM
14:33:52 631  	    GIFT_CERTIFICATE
14:33:52 632  	  WHERE
14:33:52 633  	    GIFT_CERTIFICATE.ID = in_gift_certificate_id;
14:33:52 634  	END;
14:33:52 635  
14:33:52 636  	BEGIN
14:33:52 637  	  CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V22.CREATE_GIFT_CERT_HISTORY(
14:33:52 638  	    in_gift_certificate_id,
14:33:52 639  	    var_purchaser_group_id,
14:33:52 640  	    var_purchase_invoice_id,
14:33:52 641  	    var_offer_chain_id,
14:33:52 642  	    var_expiration_date,
14:33:52 643  	    var_purchase_date,
14:33:52 644  	    var_gift_certificate_status_id,
14:33:52 645  	    var_code,
14:33:52 646  	    var_updated_by,
14:33:52 647  	    var_update_date,
14:33:52 648  	    in_system_activity_reason_id,
14:33:52 649  	    var_recipient_name,
14:33:52 650  	    var_gift_message,
14:33:52 651  	    var_recipient_email,
14:33:52 652  	    var_finalized_invoice_id,
14:33:52 653  	    var_sender_email,
14:33:52 654  	    var_sender_name,
14:33:52 655  	    var_redemption_date,
14:33:52 656  	    var_redeemer_group_id,
14:33:52 657  	    var_cancelation_date,
14:33:52 658  	    var_recipient_address_id,
14:33:52 659  	    var_redeemer_address_id,
14:33:52 660  	    var_recipient_notify_date
14:33:52 661  	  );
14:33:52 662  	  EXCEPTION
14:33:52 663  	    WHEN OTHERS THEN
14:33:52 664  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:52 665  	      RAISE CAN_NOT_CREATE_HISTORY;
14:33:52 666  	END;
14:33:52 667  
14:33:52 668  EXCEPTION
14:33:52 669  WHEN BAD_GIFT_CERTIFICATE_ID THEN
14:33:52 670  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:52 671  	  SPROC_NAME, 'No such gift certificate');
14:33:52 672  WHEN CAN_NOT_CREATE_HISTORY THEN
14:33:52 673  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:52 674  	  SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
14:33:52 675  WHEN OTHERS THEN
14:33:52 676  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52 677  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52 678  END CREATE_GIFT_CERT_HISTORY;
14:33:52 679  
14:33:52 680  /********************************************************************/
14:33:52 681  
14:33:52 682  PROCEDURE CREATE_TRANSACTION_HISTORY (
14:33:52 683  	in_transaction_id	     IN NUMBER,
14:33:52 684  	in_system_activity_reason_id IN NUMBER
14:33:52 685  ) AS
14:33:52 686  SPROC_NAME CONSTANT VARCHAR2(26) := 'CREATE_TRANSACTION_HISTORY';
14:33:52 687  -- VARIABLES
14:33:52 688  var_transaction_status_id  TRANSACTION.TRANSACTION_STATUS_ID%TYPE;
14:33:52 689  var_transaction_amount	 TRANSACTION.TRANSACTION_AMOUNT%TYPE;
14:33:52 690  var_updated_by		 TRANSACTION.UPDATED_BY%TYPE;
14:33:52 691  var_update_date		 TRANSACTION.UPDATE_DATE%TYPE;
14:33:52 692  var_order_id		 TRANSACTION.ORDER_ID%TYPE;
14:33:52 693  var_charge_id		 TRANSACTION.CHARGE_ID%TYPE;
14:33:52 694  var_is_refund		 TRANSACTION.IS_REFUND%TYPE;
14:33:52 695  var_is_settled		 TRANSACTION.IS_SETTLED%TYPE;
14:33:52 696  var_transaction_type_code  TRANSACTION.TRANSACTION_TYPE_CODE%TYPE;
14:33:52 697  -- EXCEPTIONS
14:33:52 698  BAD_TRANSACTION_ID     EXCEPTION;
14:33:52 699  CAN_NOT_CREATE_HISTORY EXCEPTION;
14:33:52 700  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:52 701  BEGIN
14:33:52 702  
14:33:52 703  	BEGIN
14:33:52 704  	  SELECT
14:33:52 705  	    TRANSACTION.TRANSACTION_STATUS_ID,
14:33:52 706  	    TRANSACTION.TRANSACTION_AMOUNT,
14:33:52 707  	    TRANSACTION.UPDATED_BY,
14:33:52 708  	    TRANSACTION.UPDATE_DATE,
14:33:52 709  	    TRANSACTION.ORDER_ID,
14:33:52 710  	    TRANSACTION.CHARGE_ID,
14:33:52 711  	    TRANSACTION.IS_REFUND,
14:33:52 712  	    TRANSACTION.IS_SETTLED,
14:33:52 713  	    TRANSACTION.TRANSACTION_TYPE_CODE
14:33:52 714  	    into
14:33:52 715  	    var_transaction_status_id,
14:33:52 716  	    var_transaction_amount,
14:33:52 717  	    var_updated_by,
14:33:52 718  	    var_update_date,
14:33:52 719  	    var_order_id,
14:33:52 720  	    var_charge_id,
14:33:52 721  	    var_is_refund,
14:33:52 722  	    var_is_settled,
14:33:52 723  	    var_transaction_type_code
14:33:52 724  	  FROM
14:33:52 725  	    TRANSACTION
14:33:52 726  	  WHERE
14:33:52 727  	    TRANSACTION.ID = in_transaction_id;
14:33:52 728  	  EXCEPTION
14:33:52 729  	    WHEN NO_DATA_FOUND THEN
14:33:52 730  	      RAISE BAD_TRANSACTION_ID;
14:33:52 731  	END;
14:33:52 732  
14:33:52 733  	BEGIN
14:33:52 734  	  CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V22.CREATE_TRANSACTION_HISTORY(
14:33:52 735  	    in_transaction_id,
14:33:52 736  	    var_transaction_status_id,
14:33:52 737  	    var_transaction_amount,
14:33:52 738  	    var_updated_by,
14:33:52 739  	    var_update_date,
14:33:52 740  	    var_order_id,
14:33:52 741  	    var_charge_id,
14:33:52 742  	    var_is_refund,
14:33:52 743  	    var_is_settled,
14:33:52 744  	    var_transaction_type_code,
14:33:52 745  	    in_system_activity_reason_id
14:33:52 746  	  );
14:33:52 747  	  EXCEPTION
14:33:52 748  	    WHEN OTHERS THEN
14:33:52 749  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:52 750  	      RAISE CAN_NOT_CREATE_HISTORY;
14:33:52 751  	END;
14:33:52 752  
14:33:52 753  EXCEPTION
14:33:52 754  WHEN BAD_TRANSACTION_ID THEN
14:33:52 755  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:52 756  	  SPROC_NAME, 'No such transaction');
14:33:52 757  WHEN CAN_NOT_CREATE_HISTORY THEN
14:33:52 758  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:52 759  	  SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
14:33:52 760  WHEN OTHERS THEN
14:33:52 761  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52 762  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52 763  END CREATE_TRANSACTION_HISTORY;
14:33:52 764  
14:33:52 765  /********************************************************************/
14:33:52 766  
14:33:52 767  PROCEDURE CREATE_INVOICE_HISTORY (
14:33:52 768  /*
14:33:52 769  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:52 770  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:52 771  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:52 772  */
14:33:52 773  	in_invoice_id		     IN NUMBER,
14:33:52 774  	in_system_activity_reason_id IN NUMBER
14:33:52 775  ) AS
14:33:52 776  SPROC_NAME CONSTANT VARCHAR2(22) := 'CREATE_INVOICE_HISTORY';
14:33:52 777  -- VARIABLES
14:33:52 778  var_invoice_status_id NUMBER;
14:33:52 779  var_updated_by	    VARCHAR2(255);
14:33:52 780  var_update_date	    DATE;
14:33:52 781  -- EXCEPTIONS
14:33:52 782  BAD_INVOICE_ID	     EXCEPTION;
14:33:52 783  CAN_NOT_CREATE_HISTORY EXCEPTION;
14:33:52 784  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:52 785  BEGIN
14:33:52 786  
14:33:52 787  	BEGIN
14:33:52 788  	  SELECT
14:33:52 789  	    INVOICE.INVOICE_STATUS_ID,
14:33:52 790  	    INVOICE.UPDATED_BY,
14:33:52 791  	    INVOICE.UPDATE_DATE
14:33:52 792  	    into
14:33:52 793  	    var_invoice_status_id,
14:33:52 794  	    var_updated_by,
14:33:52 795  	    var_update_date
14:33:52 796  	  FROM
14:33:52 797  	    INVOICE
14:33:52 798  	  WHERE
14:33:52 799  	    INVOICE.ID = in_invoice_id;
14:33:52 800  	  EXCEPTION
14:33:52 801  	    WHEN NO_DATA_FOUND THEN
14:33:52 802  	      RAISE BAD_INVOICE_ID;
14:33:52 803  	END;
14:33:52 804  
14:33:52 805  	BEGIN
14:33:52 806  	  CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V22.CREATE_INVOICE_HISTORY(
14:33:52 807  	    in_invoice_id,
14:33:52 808  	    var_invoice_status_id,
14:33:52 809  	    var_updated_by,
14:33:52 810  	    var_update_date,
14:33:52 811  	    in_system_activity_reason_id
14:33:52 812  	  );
14:33:52 813  	  EXCEPTION
14:33:52 814  	    WHEN OTHERS THEN
14:33:52 815  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:52 816  	      RAISE CAN_NOT_CREATE_HISTORY;
14:33:52 817  	END;
14:33:52 818  
14:33:52 819  EXCEPTION
14:33:52 820  WHEN BAD_INVOICE_ID THEN
14:33:52 821  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:52 822  	  SPROC_NAME, 'No such invoice');
14:33:52 823  WHEN CAN_NOT_CREATE_HISTORY THEN
14:33:52 824  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:52 825  	  SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
14:33:52 826  WHEN OTHERS THEN
14:33:52 827  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52 828  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52 829  END CREATE_INVOICE_HISTORY;
14:33:52 830  
14:33:52 831  /********************************************************************/
14:33:52 832  
14:33:52 833  PROCEDURE CREATE_LICENSE_HISTORY (
14:33:52 834  /*
14:33:52 835  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:52 836  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:52 837  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:52 838  */
14:33:52 839  	in_license_id		     IN NUMBER,
14:33:52 840  	in_system_activity_reason_id IN NUMBER
14:33:52 841  ) AS
14:33:52 842  SPROC_NAME CONSTANT VARCHAR2(22) := 'CREATE_LICENSE_HISTORY';
14:33:52 843  -- VARIABLES
14:33:52 844  var_license_status_id	    NUMBER;
14:33:52 845  var_needs_entitlements	    NUMBER;
14:33:52 846  var_start_date		    DATE;
14:33:52 847  var_offer_id		    NUMBER;
14:33:52 848  var_subscription_id	    NUMBER;
14:33:52 849  var_invoice_id		    NUMBER;
14:33:52 850  var_end_date		    DATE;
14:33:52 851  var_is_extension		    NUMBER;
14:33:52 852  var_current_offer_index	    NUMBER;
14:33:52 853  var_current_offer_recurr_num  NUMBER;
14:33:52 854  var_updated_by		    VARCHAR2(255);
14:33:52 855  var_update_date		    DATE;
14:33:52 856  var_entitlement_end_date	    DATE;
14:33:52 857  var_grace_start_date	    DATE;
14:33:52 858  var_grace_end_date	    DATE;
14:33:52 859  -- EXCEPTIONS
14:33:52 860  BAD_LICENSE_ID	     EXCEPTION;
14:33:52 861  CAN_NOT_CREATE_HISTORY EXCEPTION;
14:33:52 862  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:52 863  BEGIN
14:33:52 864  
14:33:52 865  	BEGIN
14:33:52 866  	  SELECT
14:33:52 867  	    LICENSE.LICENSE_STATUS_ID,
14:33:52 868  	    LICENSE.NEEDS_ENTITLEMENTS,
14:33:52 869  	    LICENSE.START_DATE,
14:33:52 870  	    LICENSE.OFFER_ID,
14:33:52 871  	    LICENSE.SUBSCRIPTION_ID,
14:33:52 872  	    LICENSE.INVOICE_ID,
14:33:52 873  	    LICENSE.END_DATE,
14:33:52 874  	    LICENSE.IS_EXTENSION,
14:33:52 875  	    LICENSE.CURRENT_OFFER_INDEX,
14:33:52 876  	    LICENSE.CURRENT_OFFER_RECURR_NUM,
14:33:52 877  	    LICENSE.UPDATED_BY,
14:33:52 878  	    LICENSE.UPDATE_DATE,
14:33:52 879  	    LICENSE.ENTITLEMENT_END_DATE,
14:33:52 880  	    LICENSE.GRACE_START_DATE,
14:33:52 881  	    LICENSE.GRACE_END_DATE
14:33:52 882  	    into
14:33:52 883  	    var_license_status_id,
14:33:52 884  	    var_needs_entitlements,
14:33:52 885  	    var_start_date,
14:33:52 886  	    var_offer_id,
14:33:52 887  	    var_subscription_id,
14:33:52 888  	    var_invoice_id,
14:33:52 889  	    var_end_date,
14:33:52 890  	    var_is_extension,
14:33:52 891  	    var_current_offer_index,
14:33:52 892  	    var_current_offer_recurr_num,
14:33:52 893  	    var_updated_by,
14:33:52 894  	    var_update_date,
14:33:52 895  	    var_entitlement_end_date,
14:33:52 896  	    var_grace_start_date,
14:33:52 897  	    var_grace_end_date
14:33:52 898  	  FROM
14:33:52 899  	    LICENSE
14:33:52 900  	  WHERE
14:33:52 901  	    LICENSE.ID = in_license_id;
14:33:52 902  	  EXCEPTION
14:33:52 903  	    WHEN NO_DATA_FOUND THEN
14:33:52 904  	      RAISE BAD_LICENSE_ID;
14:33:52 905  	END;
14:33:52 906  
14:33:52 907  	BEGIN
14:33:52 908  	  CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V22.CREATE_LICENSE_HISTORY(
14:33:52 909  	    in_license_id,
14:33:52 910  	    var_license_status_id,
14:33:52 911  	    var_needs_entitlements,
14:33:52 912  	    var_start_date,
14:33:52 913  	    var_offer_id,
14:33:52 914  	    var_subscription_id,
14:33:52 915  	    var_invoice_id,
14:33:52 916  	    var_end_date,
14:33:52 917  	    var_updated_by,
14:33:52 918  	    var_update_date,
14:33:52 919  	    var_is_extension,
14:33:52 920  	    var_current_offer_index,
14:33:52 921  	    var_current_offer_recurr_num,
14:33:52 922  	    in_system_activity_reason_id,
14:33:52 923  	    var_entitlement_end_date,
14:33:52 924  	    var_grace_start_date,
14:33:52 925  	    var_grace_end_date
14:33:52 926  	  );
14:33:52 927  	  EXCEPTION
14:33:52 928  	    WHEN OTHERS THEN
14:33:52 929  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:52 930  	      RAISE CAN_NOT_CREATE_HISTORY;
14:33:52 931  	END;
14:33:52 932  
14:33:52 933  EXCEPTION
14:33:52 934  WHEN BAD_LICENSE_ID THEN
14:33:52 935  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:52 936  	  SPROC_NAME, 'No such license');
14:33:52 937  WHEN CAN_NOT_CREATE_HISTORY THEN
14:33:52 938  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:52 939  	  SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
14:33:52 940  WHEN OTHERS THEN
14:33:52 941  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52 942  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52 943  END CREATE_LICENSE_HISTORY;
14:33:52 944  
14:33:52 945  /********************************************************************/
14:33:52 946  
14:33:52 947  PROCEDURE CREATE_CHARGE_HISTORY (
14:33:52 948  /*
14:33:52 949  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:52 950  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:52 951  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:52 952  */
14:33:52 953  	in_charge_id		    IN NUMBER,
14:33:52 954  	in_system_activity_reason_id IN NUMBER
14:33:52 955  ) AS
14:33:52 956  SPROC_NAME CONSTANT VARCHAR2(21) := 'CREATE_CHARGE_HISTORY';
14:33:52 957  -- VARIABLES
14:33:52 958  var_invoice_id	     NUMBER;
14:33:52 959  var_transaction_id     NUMBER;
14:33:52 960  var_instrument_type_id NUMBER;
14:33:52 961  var_instrument_id      NUMBER;
14:33:52 962  var_charge_amount      NUMBER;
14:33:52 963  var_charge_status_id   NUMBER;
14:33:52 964  var_updated_by	     VARCHAR2(255);
14:33:52 965  var_update_date	     DATE;
14:33:52 966  -- EXCEPTIONS
14:33:52 967  BAD_CHARGE_ID	     EXCEPTION;
14:33:52 968  CAN_NOT_CREATE_HISTORY EXCEPTION;
14:33:52 969  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:52 970  BEGIN
14:33:52 971  
14:33:52 972  	BEGIN
14:33:52 973  	  SELECT
14:33:52 974  	    CHARGE.INVOICE_ID,
14:33:52 975  	    CHARGE.TRANSACTION_ID,
14:33:52 976  	    CHARGE.INSTRUMENT_TYPE_ID,
14:33:52 977  	    CHARGE.INSTRUMENT_ID,
14:33:52 978  	    CHARGE.CHARGE_AMOUNT,
14:33:52 979  	    CHARGE.CHARGE_STATUS_ID,
14:33:52 980  	    CHARGE.UPDATED_BY,
14:33:52 981  	    CHARGE.UPDATE_DATE
14:33:52 982  	    into
14:33:52 983  	    var_invoice_id,
14:33:52 984  	    var_transaction_id,
14:33:52 985  	    var_instrument_type_id,
14:33:52 986  	    var_instrument_id,
14:33:52 987  	    var_charge_amount,
14:33:52 988  	    var_charge_status_id,
14:33:52 989  	    var_updated_by,
14:33:52 990  	    var_update_date
14:33:52 991  	  FROM
14:33:52 992  	    CHARGE
14:33:52 993  	  WHERE
14:33:52 994  	    CHARGE.ID = in_charge_id;
14:33:52 995  	  EXCEPTION
14:33:52 996  	    WHEN NO_DATA_FOUND THEN
14:33:52 997  	      RAISE BAD_CHARGE_ID;
14:33:52 998  	END;
14:33:52 999  
14:33:52 1000  	 BEGIN
14:33:52 1001  	   CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V22.CREATE_CHARGE_HISTORY (
14:33:52 1002  	     in_charge_id,
14:33:52 1003  	     var_invoice_id,
14:33:52 1004  	     var_transaction_id,
14:33:52 1005  	     var_instrument_type_id,
14:33:52 1006  	     var_instrument_id,
14:33:52 1007  	     var_charge_amount,
14:33:52 1008  	     var_updated_by,
14:33:52 1009  	     var_update_date,
14:33:52 1010  	     var_charge_status_id,
14:33:52 1011  	     in_system_activity_reason_id
14:33:52 1012  	   );
14:33:52 1013  	   EXCEPTION
14:33:52 1014  	     WHEN OTHERS THEN
14:33:52 1015  	       EXCEPTION_MESSAGE := SQLERRM;
14:33:52 1016  	       RAISE CAN_NOT_CREATE_HISTORY;
14:33:52 1017  	 END;
14:33:52 1018  
14:33:52 1019  EXCEPTION
14:33:52 1020  WHEN BAD_CHARGE_ID THEN
14:33:52 1021  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:52 1022  	   SPROC_NAME, 'No such license');
14:33:52 1023  WHEN CAN_NOT_CREATE_HISTORY THEN
14:33:52 1024  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:52 1025  	   SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
14:33:52 1026  WHEN OTHERS THEN
14:33:52 1027  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52 1028  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52 1029  END CREATE_CHARGE_HISTORY;
14:33:52 1030  
14:33:52 1031  PROCEDURE CREATE_INVOICE_ADJ_HISTORY (
14:33:52 1032  /*
14:33:52 1033  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:52 1034  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:52 1035  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:52 1036  */
14:33:52 1037  	 in_invoice_adjustment_id  IN NUMBER,
14:33:52 1038  	 in_system_activity_reason_id IN NUMBER
14:33:52 1039  ) AS
14:33:52 1040  SPROC_NAME CONSTANT VARCHAR(32) := 'CREATE_INVOICE_ADJ_HISTORY';
14:33:52 1041  --VARIABLED
14:33:52 1042  var_invoice_adj_id	   INVOICE_ADJUSTMENT.ID%TYPE;
14:33:52 1043  var_invoice_id		   INVOICE_ADJUSTMENT.INVOICE_ID%TYPE;
14:33:52 1044  var_is_credit		   INVOICE_ADJUSTMENT.IS_CREDIT%TYPE;
14:33:52 1045  var_charge_id		   INVOICE_ADJUSTMENT.CHARGE_ID%TYPE;
14:33:52 1046  var_adjustment_date	   INVOICE_ADJUSTMENT.ADJUSTMENT_DATE%TYPE;
14:33:52 1047  var_create_date		   INVOICE_ADJUSTMENT.CREATE_DATE%TYPE;
14:33:52 1048  var_created_by		   INVOICE_ADJUSTMENT.CREATED_BY%TYPE;
14:33:52 1049  var_invoice_adj_reason_id INVOICE_ADJUSTMENT.INVOICE_ADJUSTMENT_REASON_ID%TYPE;
14:33:52 1050  var_update_date		   INVOICE_ADJUSTMENT.UPDATE_DATE%TYPE;
14:33:52 1051  var_updated_by		   INVOICE_ADJUSTMENT.UPDATED_BY%TYPE;
14:33:52 1052  BAD_INVOICE_ADJ_ID	   EXCEPTION;
14:33:52 1053  CAN_NOT_CREATE_HISTORY	   EXCEPTION;
14:33:52 1054  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:52 1055  BEGIN
14:33:52 1056  
14:33:52 1057  	 BEGIN
14:33:52 1058  	   SELECT
14:33:52 1059  	     INVOICE_ADJUSTMENT.ID,
14:33:52 1060  	     INVOICE_ADJUSTMENT.INVOICE_ID,
14:33:52 1061  	     INVOICE_ADJUSTMENT.IS_CREDIT,
14:33:52 1062  	     INVOICE_ADJUSTMENT.CHARGE_ID,
14:33:52 1063  	     INVOICE_ADJUSTMENT.ADJUSTMENT_DATE,
14:33:52 1064  	     INVOICE_ADJUSTMENT.CREATE_DATE,
14:33:52 1065  	     INVOICE_ADJUSTMENT.CREATED_BY,
14:33:52 1066  	     INVOICE_ADJUSTMENT.INVOICE_ADJUSTMENT_REASON_ID,
14:33:52 1067  	     INVOICE_ADJUSTMENT.UPDATE_DATE,
14:33:52 1068  	     INVOICE_ADJUSTMENT.UPDATED_BY
14:33:52 1069  	     into
14:33:52 1070  	     var_invoice_adj_id,
14:33:52 1071  	     var_invoice_id,
14:33:52 1072  	     var_is_credit,
14:33:52 1073  	     var_charge_id,
14:33:52 1074  	     var_adjustment_date,
14:33:52 1075  	     var_create_date,
14:33:52 1076  	     var_created_by,
14:33:52 1077  	     var_invoice_adj_reason_id,
14:33:52 1078  	     var_update_date,
14:33:52 1079  	     var_updated_by
14:33:52 1080  	   FROM
14:33:52 1081  	     INVOICE_ADJUSTMENT
14:33:52 1082  	   WHERE
14:33:52 1083  	     INVOICE_ADJUSTMENT.ID = in_invoice_adjustment_id;
14:33:52 1084  	   EXCEPTION
14:33:52 1085  	     WHEN NO_DATA_FOUND THEN
14:33:52 1086  	       RAISE BAD_INVOICE_ADJ_ID;
14:33:52 1087  	 END;
14:33:52 1088  
14:33:52 1089  	 BEGIN
14:33:52 1090  	   CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V22.CREATE_INVOICE_ADJ_HISTORY (
14:33:52 1091  	     var_invoice_adj_id,
14:33:52 1092  	     var_invoice_id,
14:33:52 1093  	     var_is_credit,
14:33:52 1094  	     var_charge_id,
14:33:52 1095  	     var_adjustment_date,
14:33:52 1096  	     var_create_date,
14:33:52 1097  	     var_created_by,
14:33:52 1098  	     var_invoice_adj_reason_id,
14:33:52 1099  	     var_update_date,
14:33:52 1100  	     var_updated_by
14:33:52 1101  	   );
14:33:52 1102  	   EXCEPTION
14:33:52 1103  	     WHEN OTHERS THEN
14:33:52 1104  	       EXCEPTION_MESSAGE := SQLERRM;
14:33:52 1105  	       RAISE CAN_NOT_CREATE_HISTORY;
14:33:52 1106  	 END;
14:33:52 1107  
14:33:52 1108  EXCEPTION
14:33:52 1109  WHEN BAD_INVOICE_ADJ_ID THEN
14:33:52 1110  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:52 1111  	   SPROC_NAME, 'No such invoice adjustment');
14:33:52 1112  WHEN CAN_NOT_CREATE_HISTORY THEN
14:33:52 1113  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:52 1114  	   SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
14:33:52 1115  WHEN OTHERS THEN
14:33:52 1116  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52 1117  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52 1118  END CREATE_INVOICE_ADJ_HISTORY;
14:33:52 1119  
14:33:52 1120  END PROCS_HISTORY_V22;
14:33:52 1121  .
14:33:52 SQL> /

Package body created.

Elapsed: 00:00:00.07
14:33:52 SQL> 
14:33:52 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_ITUNES_RECEIPT_V22" AS
14:33:52   2  
14:33:52   3  PROCEDURE ITUNES_RECEIPT_SUBSCRIPTION (
14:33:52   4  /*
14:33:52   5  Throws exceptions:
14:33:52   6  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:52   7  */
14:33:52   8  	in_original_transaction_id IN ITUNES_RECEIPT.ORIGINAL_TRANSACTION_ID%TYPE,
14:33:52   9  	out_result_set	    OUT SYS_REFCURSOR
14:33:52  10  ) AS
14:33:52  11  SPROC_NAME CONSTANT VARCHAR2(28) := 'ITUNES_RECEIPT_SUBSCRIPTION';
14:33:52  12  BEGIN
14:33:52  13  OPEN out_result_set FOR
14:33:52  14  	      SELECT
14:33:52  15  	      i.id as ITUNES_RECEIPT_ID,
14:33:52  16  	      s.id as SUBSCRIPTION_ID,
14:33:52  17  	      s.SUBSCRIPTION_STATUS_ID,
14:33:52  18  	      i.STATUS,
14:33:52  19  	      a.GROUP_ID
14:33:52  20  	      FROM ITUNES_RECEIPT i, SUBSCRIPTION s, ACCOUNT a
14:33:52  21  	      WHERE i.ORIGINAL_TRANSACTION_ID = in_original_transaction_id
14:33:52  22  	      AND s.ID(+) = i.SUBSCRIPTION_ID
14:33:52  23  	      AND a.ID(+) = s.ACCOUNT_ID;
14:33:52  24  END ITUNES_RECEIPT_SUBSCRIPTION;
14:33:52  25  
14:33:52  26  
14:33:52  27  PROCEDURE CREATE_RECEIPT(
14:33:52  28  /*
14:33:52  29  Throws exceptions:
14:33:52  30  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:52  31  */
14:33:52  32  	  out_id      OUT NUMBER,
14:33:52  33  	  in_subscription_id  IN ITUNES_RECEIPT.SUBSCRIPTION_ID%TYPE,
14:33:52  34  	  in_receipt	      IN ITUNES_RECEIPT.RECEIPT%TYPE,
14:33:52  35  	  in_status	      IN ITUNES_RECEIPT.STATUS%TYPE,
14:33:52  36  	  in_quantity	      IN ITUNES_RECEIPT.QUANTITY%TYPE,
14:33:52  37  	  in_product_id       IN ITUNES_RECEIPT.PRODUCT_ID%TYPE,
14:33:52  38  	  in_transaction_id   IN ITUNES_RECEIPT.TRANSACTION_ID%TYPE,
14:33:52  39  	  in_purchase_date    IN ITUNES_RECEIPT.PURCHASE_DATE%TYPE,
14:33:52  40  	  in_original_transaction_id IN ITUNES_RECEIPT.ORIGINAL_TRANSACTION_ID%TYPE,
14:33:52  41  	  in_original_purchase_date IN ITUNES_RECEIPT.ORIGINAL_PURCHASE_DATE%TYPE,
14:33:52  42  	  in_app_item_id      IN ITUNES_RECEIPT.APP_ITEM_ID%TYPE,
14:33:52  43  	  in_version_external_id IN ITUNES_RECEIPT.VERSION_EXTERNAL_ID%TYPE,
14:33:52  44  	  in_bid	      IN ITUNES_RECEIPT.BID%TYPE,
14:33:52  45  	  in_bvrs	      IN ITUNES_RECEIPT.BVRS%TYPE,
14:33:52  46  	  in_expires_date     IN ITUNES_RECEIPT.EXPIRES_DATE%TYPE,
14:33:52  47  	  in_created_by       IN ITUNES_RECEIPT.CREATED_BY%TYPE
14:33:52  48  ) AS
14:33:52  49  -- VARIABLES
14:33:52  50  SPROC_NAME	 CONSTANT VARCHAR2(14) := 'CREATE_RECEIPT';
14:33:52  51  -- EXCEPTIONS
14:33:52  52  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:52  53  BEGIN
14:33:52  54  
14:33:52  55  	CORE_OWNER.PROCS_ITUNES_RECEIPT_CRU_V22.CREATE_RECEIPT(
14:33:52  56  	  out_id	      =>  out_id,
14:33:52  57  	  in_subscription_id  =>  in_subscription_id,
14:33:52  58  	  in_receipt	      =>  in_receipt,
14:33:52  59  	  in_status	      =>  in_status,
14:33:52  60  	  in_quantity	      =>  in_quantity,
14:33:52  61  	  in_product_id       =>  in_product_id,
14:33:52  62  	  in_transaction_id   =>  in_transaction_id,
14:33:52  63  	  in_purchase_date    =>  in_purchase_date,
14:33:52  64  	  in_original_transaction_id  =>  in_original_transaction_id,
14:33:52  65  	  in_original_purchase_date => in_original_purchase_date,
14:33:52  66  	  in_app_item_id      =>  in_app_item_id,
14:33:52  67  	  in_version_external_id  =>  in_version_external_id,
14:33:52  68  	  in_bid	      =>  in_bid,
14:33:52  69  	  in_bvrs	      =>  in_bvrs,
14:33:52  70  	  in_expires_date     =>  in_expires_date,
14:33:52  71  	  in_created_by       =>  in_created_by
14:33:52  72  	);
14:33:52  73  
14:33:52  74  END CREATE_RECEIPT;
14:33:52  75  
14:33:52  76  PROCEDURE UPDATE_RECEIPT(
14:33:52  77  /*
14:33:52  78  Throws exceptions:
14:33:52  79  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:52  80  */
14:33:52  81  	  in_id 	      IN ITUNES_RECEIPT.ID%TYPE,
14:33:52  82  	  in_receipt	      IN ITUNES_RECEIPT.RECEIPT%TYPE,
14:33:52  83  	  in_status	      IN ITUNES_RECEIPT.STATUS%TYPE,
14:33:52  84  	  in_quantity	      IN ITUNES_RECEIPT.QUANTITY%TYPE,
14:33:52  85  	  in_product_id       IN ITUNES_RECEIPT.PRODUCT_ID%TYPE,
14:33:52  86  	  in_transaction_id   IN ITUNES_RECEIPT.TRANSACTION_ID%TYPE,
14:33:52  87  	  in_purchase_date    IN ITUNES_RECEIPT.PURCHASE_DATE%TYPE,
14:33:52  88  	  in_original_transaction_id IN ITUNES_RECEIPT.ORIGINAL_TRANSACTION_ID%TYPE,
14:33:52  89  	  in_original_purchase_date IN ITUNES_RECEIPT.ORIGINAL_PURCHASE_DATE%TYPE,
14:33:52  90  	  in_app_item_id      IN ITUNES_RECEIPT.APP_ITEM_ID%TYPE,
14:33:52  91  	  in_version_external_id IN ITUNES_RECEIPT.VERSION_EXTERNAL_ID%TYPE,
14:33:52  92  	  in_bid	      IN ITUNES_RECEIPT.BID%TYPE,
14:33:52  93  	  in_bvrs	      IN ITUNES_RECEIPT.BVRS%TYPE,
14:33:52  94  	  in_expires_date     IN ITUNES_RECEIPT.EXPIRES_DATE%TYPE,
14:33:52  95  	  in_updated_by       IN ITUNES_RECEIPT.UPDATED_BY%TYPE,
14:33:52  96  	  in_is_expired       IN NUMBER
14:33:52  97  ) AS
14:33:52  98  CANCEL_DATE DATE;
14:33:52  99  BEGIN
14:33:52 100  	-- see if cancel date is already set
14:33:52 101  	BEGIN
14:33:52 102  	  SELECT
14:33:52 103  	    IR.CANCEL_DATE INTO CANCEL_DATE
14:33:52 104  	  FROM
14:33:52 105  	    ITUNES_RECEIPT IR
14:33:52 106  	  WHERE
14:33:52 107  	    IR.ID = in_id;
14:33:52 108  	EXCEPTION
14:33:52 109  	  WHEN NO_DATA_FOUND THEN
14:33:52 110  	    CANCEL_DATE := NULL;
14:33:52 111  	END;
14:33:52 112  
14:33:52 113  	-- only update cancel date if it isn't already set and the receipt is expired
14:33:52 114  	IF in_is_expired = 1 THEN
14:33:52 115  	  IF CANCEL_DATE IS NULL THEN
14:33:52 116  	    CANCEL_DATE := SYSDATE;
14:33:52 117  	  END IF;
14:33:52 118  	ELSE
14:33:52 119  	  CANCEL_DATE := NULL;
14:33:52 120  	END IF;
14:33:52 121  
14:33:52 122  	CORE_OWNER.PROCS_ITUNES_RECEIPT_CRU_V22.UPDATE_RECEIPT(
14:33:52 123  	  in_id => in_id,
14:33:52 124  	  in_receipt => in_receipt,
14:33:52 125  	  in_status => in_status,
14:33:52 126  	  in_quantity => in_quantity,
14:33:52 127  	  in_product_id => in_product_id,
14:33:52 128  	  in_transaction_id => in_transaction_id,
14:33:52 129  	  in_purchase_date => in_purchase_date,
14:33:52 130  	  in_original_transaction_id => in_original_transaction_id,
14:33:52 131  	  in_original_purchase_date => in_original_purchase_date,
14:33:52 132  	  in_app_item_id => in_app_item_id,
14:33:52 133  	  in_version_external_id => in_version_external_id,
14:33:52 134  	  in_bid => in_bid,
14:33:52 135  	  in_bvrs => in_bvrs,
14:33:52 136  	  in_expires_date => in_expires_date,
14:33:52 137  	  in_updated_by => in_updated_by,
14:33:52 138  	  in_cancel_date => CANCEL_DATE
14:33:52 139  	);
14:33:52 140  END UPDATE_RECEIPT;
14:33:52 141  
14:33:52 142  PROCEDURE LINK_ITUNES_RECEIPT(
14:33:52 143  /*
14:33:52 144  Throws exceptions:
14:33:52 145  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:52 146  */
14:33:52 147  	  in_id 	      IN ITUNES_RECEIPT.ID%TYPE,
14:33:52 148  	  in_subscription_id  IN ITUNES_RECEIPT.SUBSCRIPTION_ID%TYPE,
14:33:52 149  	  in_updated_by       IN ITUNES_RECEIPT.UPDATED_BY%TYPE
14:33:52 150  ) AS
14:33:52 151  BEGIN
14:33:52 152  	      CORE_OWNER.PROCS_ITUNES_RECEIPT_CRU_V22.LINK_ITUNES_RECEIPT(
14:33:52 153  		      in_id => in_id,
14:33:52 154  		      in_subscription_id => in_subscription_id,
14:33:52 155  		      in_updated_by => in_updated_by
14:33:52 156  		      );
14:33:52 157  END LINK_ITUNES_RECEIPT;
14:33:52 158  
14:33:52 159  PROCEDURE MARK_RECEIPT_CHECKED(
14:33:52 160  /*
14:33:52 161  Throws exceptions:
14:33:52 162  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:52 163  */
14:33:52 164  	  in_id       IN ITUNES_RECEIPT.ID%TYPE
14:33:52 165  ) AS
14:33:52 166  BEGIN
14:33:52 167  	CORE_OWNER.PROCS_ITUNES_RECEIPT_CRU_V22.MARK_RECEIPT_CHECKED(
14:33:52 168  	  in_id => in_id
14:33:52 169  	);
14:33:52 170  END MARK_RECEIPT_CHECKED;
14:33:52 171  
14:33:52 172  PROCEDURE GET_ITUNES_RECEIPTS (
14:33:52 173  /*
14:33:52 174  Throws exceptions:
14:33:52 175  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:52 176  */
14:33:52 177  	out_result_set	    OUT SYS_REFCURSOR,
14:33:52 178  	in_row_number	    IN NUMBER DEFAULT 500
14:33:52 179  ) AS
14:33:52 180  SPROC_NAME CONSTANT VARCHAR2(26) := 'GET_ITUNES_RECEIPTS';
14:33:52 181  BEGIN
14:33:52 182  OPEN out_result_set FOR
14:33:52 183  SELECT * FROM
14:33:52 184  (
14:33:52 185  	SELECT * FROM
14:33:52 186  	(
14:33:52 187  	  SELECT
14:33:52 188  	    IR.ID,
14:33:52 189  	    IR.SUBSCRIPTION_ID,
14:33:52 190  	    IR.RECEIPT,
14:33:52 191  	    IR.STATUS,
14:33:52 192  	    IR.QUANTITY,
14:33:52 193  	    IR.PRODUCT_ID,
14:33:52 194  	    IR.TRANSACTION_ID,
14:33:52 195  	    IR.PURCHASE_DATE,
14:33:52 196  	    IR.ORIGINAL_TRANSACTION_ID,
14:33:52 197  	    IR.ORIGINAL_PURCHASE_DATE,
14:33:52 198  	    IR.APP_ITEM_ID,
14:33:52 199  	    IR.VERSION_EXTERNAL_ID,
14:33:52 200  	    IR.BID,
14:33:52 201  	    IR.BVRS,
14:33:52 202  	    IR.EXPIRES_DATE,
14:33:52 203  	    IR.CREATE_DATe,
14:33:52 204  	    IR.CREATED_BY,
14:33:52 205  	    IR.UPDATE_DATE,
14:33:52 206  	    IR.UPDATED_BY,
14:33:52 207  	    IR.LAST_CHECK_DATE,
14:33:52 208  	    OC.VENDOR_SOURCE_ID
14:33:52 209  	  FROM
14:33:52 210  	    CORE_OWNER.ITUNES_RECEIPT IR
14:33:52 211  	    LEFT JOIN CORE_OWNER.SUBSCRIPTION S ON IR.subscription_id = S.id
14:33:52 212  	    LEFT JOIN CORE_OWNER.OFFER_CHAIN OC ON S.offer_chain_id = OC.id
14:33:52 213  	  WHERE
14:33:52 214  	    NOT EXISTS
14:33:52 215  	    (
14:33:52 216  	      SELECT NULL
14:33:52 217  	      FROM PROCESS_RETRY_THROTTLE
14:33:52 218  	      WHERE PROCESS_NAME = SPROC_NAME
14:33:52 219  		AND GENERIC_ID = IR.ID
14:33:52 220  	    ) AND
14:33:52 221  	    (S.subscription_status_id in (GLOBAL_STATUSES_V22.SUBSCRIPTION_SUSPENDED, GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE) or (S.subscription_status_id is null and IR.status != 21006)) AND
14:33:52 222  	    ROWNUM <= in_row_number*10
14:33:52 223  	)
14:33:52 224  	ORDER BY dbms_random.value
14:33:52 225  )
14:33:52 226  WHERE
14:33:52 227  	ROWNUM <= in_row_number;
14:33:52 228  
14:33:52 229  END GET_ITUNES_RECEIPTS;
14:33:52 230  
14:33:52 231  PROCEDURE GET_VENDOR_FROM_ITUNES_PID(
14:33:52 232  /*
14:33:52 233  Throws exceptions:
14:33:52 234  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:52 235  */
14:33:52 236  	  out_vendor_source_id OUT OFFER_CHAIN.VENDOR_SOURCE_ID%TYPE,
14:33:52 237  	  in_itunes_pid        IN ITUNES_RECEIPT.PRODUCT_ID%TYPE
14:33:52 238  ) AS
14:33:52 239  BEGIN
14:33:52 240  
14:33:52 241  SELECT
14:33:52 242  	  oc.vendor_source_id
14:33:52 243  INTO
14:33:52 244  	  out_vendor_source_id
14:33:52 245  FROM
14:33:52 246  	  offer_chain_meta_data ocmd
14:33:52 247  JOIN
14:33:52 248  	  offer_chain oc
14:33:52 249  ON
14:33:52 250  	  ocmd.offer_chain_id = oc.id
14:33:52 251  WHERE
14:33:52 252  	  ocmd.name = 'ITUNES_PRODUCT_ID'
14:33:52 253  AND ocmd.value = in_itunes_pid
14:33:52 254  AND rownum <= 1;
14:33:52 255  
14:33:52 256  END GET_VENDOR_FROM_ITUNES_PID;
14:33:52 257  
14:33:52 258  END PROCS_ITUNES_RECEIPT_V22;
14:33:52 259  .
14:33:52 SQL> /

Package body created.

Elapsed: 00:00:00.03
14:33:52 SQL> 
14:33:52 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_LINE_ITEMS_V22" AS
14:33:52   2  
14:33:52   3  PROCEDURE ADD_LINE_ITEMS(
14:33:52   4  /*
14:33:52   5  Throws exceptions:
14:33:52   6  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:52   7  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:52   8  */
14:33:52   9  	in_invoice_id IN NUMBER,
14:33:52  10  	in_offer_id   IN NUMBER,
14:33:52  11  	in_created_by IN VARCHAR2
14:33:52  12  ) AS
14:33:52  13  -- VARIABLES
14:33:52  14  SPROC_NAME      CONSTANT VARCHAR2(14) := 'ADD_LINE_ITEMS';
14:33:52  15  temp_invoice_id NUMBER;
14:33:52  16  temp_offer_id   NUMBER;
14:33:52  17  
14:33:52  18  var_line_item_data SYS_REFCURSOR;
14:33:52  19  var_new_line_item_id NUMBER;
14:33:52  20  var_product_unit_price NUMBER (10,6);
14:33:52  21  var_product_offering_price NUMBER(10,6);
14:33:52  22  var_product_offering_oprice NUMBER(10,6);
14:33:52  23  var_product_quantity NUMBER;
14:33:52  24  var_product_offering_id NUMBER;
14:33:52  25  
14:33:52  26  var_line_item_price	  NUMBER(10,2);
14:33:52  27  var_discount_fixed_amount   NUMBER(10,6);
14:33:52  28  var_discount_percent_amount NUMBER(10,2);
14:33:52  29  
14:33:52  30  
14:33:52  31  -- EXCEPTIONS
14:33:52  32  BAD_INVOICE_ID EXCEPTION;
14:33:52  33  BAD_OFFER_ID EXCEPTION;
14:33:52  34  BAD_DISCOUNT EXCEPTION;
14:33:52  35  BEGIN
14:33:52  36  
14:33:52  37  	-- Check that given invoice exists
14:33:52  38  	BEGIN
14:33:52  39  	  SELECT
14:33:52  40  	    INVOICE.ID into temp_invoice_id
14:33:52  41  	  FROM
14:33:52  42  	    INVOICE
14:33:52  43  	  WHERE
14:33:52  44  	    INVOICE.ID = in_invoice_id;
14:33:52  45  
14:33:52  46  	  EXCEPTION
14:33:52  47  	    WHEN NO_DATA_FOUND THEN
14:33:52  48  	      RAISE BAD_INVOICE_ID;
14:33:52  49  	END;
14:33:52  50  
14:33:52  51  	-- Check that given offer exists
14:33:52  52  	BEGIN
14:33:52  53  	  SELECT
14:33:52  54  	    OFFER.ID into temp_offer_id
14:33:52  55  	  FROM
14:33:52  56  	    OFFER
14:33:52  57  	  WHERE
14:33:52  58  	    OFFER.ID = in_offer_id;
14:33:52  59  
14:33:52  60  	  EXCEPTION
14:33:52  61  	    WHEN NO_DATA_FOUND THEN
14:33:52  62  	      RAISE BAD_OFFER_ID;
14:33:52  63  	END;
14:33:52  64  
14:33:52  65  	-- Get product_offering data
14:33:52  66  	OPEN var_line_item_data FOR
14:33:52  67  	SELECT
14:33:52  68  	  PRODUCT_OFFERING.ID,
14:33:52  69  	  PRODUCT_OFFERING.UNIT_PRICE,
14:33:52  70  	  PRODUCT_OFFERING.QUANTITY
14:33:52  71  	FROM
14:33:52  72  	  OFFER_PRODUCT_OFFERING
14:33:52  73  	  INNER JOIN PRODUCT_OFFERING ON OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = PRODUCT_OFFERING.ID
14:33:52  74  	WHERE
14:33:52  75  	  OFFER_PRODUCT_OFFERING.OFFER_ID = in_offer_id;
14:33:52  76  
14:33:52  77  	-- insert line items
14:33:52  78  	-- add discounts to line items
14:33:52  79  	LOOP
14:33:52  80  	  FETCH var_line_item_data INTO
14:33:52  81  	    var_product_offering_id,
14:33:52  82  	    var_product_unit_price,
14:33:52  83  	    var_product_quantity;
14:33:52  84  	  EXIT WHEN var_line_item_data%NOTFOUND;
14:33:52  85  
14:33:52  86  	  var_product_offering_oprice := var_product_unit_price * var_product_quantity;
14:33:52  87  	  var_product_offering_price := var_product_offering_oprice;
14:33:52  88  
14:33:52  89  	  -- Apply discounts to line_item
14:33:52  90  	  BEGIN
14:33:52  91  	    SELECT
14:33:52  92  	      SUM (DISCOUNT.FIXED_AMOUNT) into var_discount_fixed_amount
14:33:52  93  	    FROM
14:33:52  94  	      DISCOUNT_PRODUCT_OFFERING
14:33:52  95  	      INNER JOIN DISCOUNT ON DISCOUNT_PRODUCT_OFFERING.DISCOUNT_ID = DISCOUNT.ID
14:33:52  96  	    WHERE
14:33:52  97  	      DISCOUNT_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = var_product_offering_id
14:33:52  98  	      AND DISCOUNT.FIXED_AMOUNT IS NOT NULL;
14:33:52  99  	    EXCEPTION
14:33:52 100  	    WHEN NO_DATA_FOUND THEN
14:33:52 101  	      var_discount_fixed_amount := NULL;
14:33:52 102  	  END;
14:33:52 103  
14:33:52 104  	  BEGIN
14:33:52 105  	    SELECT
14:33:52 106  	      SUM (DISCOUNT.PERCENT_AMOUNT) into var_discount_percent_amount
14:33:52 107  	    FROM
14:33:52 108  	      DISCOUNT_PRODUCT_OFFERING
14:33:52 109  	      INNER JOIN DISCOUNT ON DISCOUNT_PRODUCT_OFFERING.DISCOUNT_ID = DISCOUNT.ID
14:33:52 110  	    WHERE
14:33:52 111  	      DISCOUNT_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = var_product_offering_id
14:33:52 112  	      AND DISCOUNT.PERCENT_AMOUNT IS NOT NULL;
14:33:52 113  	    EXCEPTION
14:33:52 114  	    WHEN NO_DATA_FOUND THEN
14:33:52 115  	      var_discount_percent_amount := NULL;
14:33:52 116  	  END;
14:33:52 117  
14:33:52 118  	  IF (var_discount_percent_amount IS NOT NULL) THEN
14:33:52 119  	    var_product_offering_price := var_product_offering_price * ( 1 - var_discount_percent_amount / 100 );
14:33:52 120  	  END IF;
14:33:52 121  
14:33:52 122  	  IF (var_discount_fixed_amount IS NOT NULL) THEN
14:33:52 123  	    var_product_offering_price := var_product_offering_price - var_discount_fixed_amount;
14:33:52 124  	  END IF;
14:33:52 125  
14:33:52 126  	  var_line_item_price := PROCS_COMMON_V22.ROUND_10_6_TO_10_2(var_product_offering_price);
14:33:52 127  
14:33:52 128  	  IF (var_line_item_price < 0) THEN
14:33:52 129  	      RAISE BAD_DISCOUNT;
14:33:52 130  	  END IF;
14:33:52 131  
14:33:52 132  	  var_new_line_item_id := NULL;
14:33:52 133  	  PROCS_LINE_ITEMS_CRU_V22.CREATE_LINE_ITEM(
14:33:52 134  	    inout_line_item_id	=> var_new_line_item_id,
14:33:52 135  	    in_product_offer_id => var_product_offering_id,
14:33:52 136  	    in_invoice_id	=> in_invoice_id,
14:33:52 137  	    in_amount		=> var_line_item_price,
14:33:52 138  	    in_created_by	=> in_created_by,
14:33:52 139  	    in_discount_amount	=> var_product_offering_oprice - var_line_item_price,
14:33:52 140  	    in_taxes_amount	=> NULL
14:33:52 141  	  );
14:33:52 142  
14:33:52 143  	  FOR f_discount IN (
14:33:52 144  	    SELECT
14:33:52 145  	      DISCOUNT.ID
14:33:52 146  	    FROM
14:33:52 147  	      DISCOUNT_PRODUCT_OFFERING
14:33:52 148  	      INNER JOIN DISCOUNT ON DISCOUNT_PRODUCT_OFFERING.DISCOUNT_ID = DISCOUNT.ID
14:33:52 149  	    WHERE
14:33:52 150  	      DISCOUNT_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = var_product_offering_id
14:33:52 151  	  )
14:33:52 152  	  LOOP
14:33:52 153  	    PROCS_LINE_ITEMS_CRU_V22.CREATE_DISCOUNT_LINE_ITEM(
14:33:52 154  	      in_discount_id =>  f_discount.ID,
14:33:52 155  	      in_line_item_id => var_new_line_item_id
14:33:52 156  	    );
14:33:52 157  	  END LOOP;
14:33:52 158  	END LOOP;
14:33:52 159  
14:33:52 160  EXCEPTION
14:33:52 161  WHEN BAD_INVOICE_ID THEN
14:33:52 162  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:52 163  	  SPROC_NAME, 'No such license');
14:33:52 164  WHEN BAD_OFFER_ID THEN
14:33:52 165  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:52 166  	  SPROC_NAME, 'No such offer');
14:33:52 167  WHEN BAD_DISCOUNT THEN
14:33:52 168  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52 169  	  SPROC_NAME, 'Bad Discount');
14:33:52 170  WHEN OTHERS THEN
14:33:52 171  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52 172  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52 173  END ADD_LINE_ITEMS;
14:33:52 174  
14:33:52 175  /******************************************************************************/
14:33:52 176  
14:33:52 177  PROCEDURE UPDATE_LINE_ITEM_AMOUNT (
14:33:52 178  	in_line_item_id    IN NUMBER,
14:33:52 179  	in_amount	   IN NUMBER,
14:33:52 180  	in_discount_amount IN NUMBER,
14:33:52 181  	in_taxes_amount    IN NUMBER
14:33:52 182  ) AS
14:33:52 183  SPROC_NAME CONSTANT VARCHAR2(24) := 'UPDATE_LINE_ITEM_AMOUNTS';
14:33:52 184  -- VARIABLES
14:33:52 185  temp_line_item_id NUMBER;
14:33:52 186  -- EXCEPTIONS
14:33:52 187  BAD_LINE_ITEM_ID EXCEPTION;
14:33:52 188  BEGIN
14:33:52 189  
14:33:52 190  	-- Check that line item exists
14:33:52 191  	BEGIN
14:33:52 192  	  SELECT
14:33:52 193  	    LINE_ITEM.ID into temp_line_item_id
14:33:52 194  	  FROM
14:33:52 195  	    LINE_ITEM
14:33:52 196  	  WHERE
14:33:52 197  	    LINE_ITEM.ID = in_line_item_id;
14:33:52 198  	  EXCEPTION
14:33:52 199  	    WHEN NO_DATA_FOUND THEN
14:33:52 200  	      RAISE BAD_LINE_ITEM_ID;
14:33:52 201  	END;
14:33:52 202  
14:33:52 203  	-- Update line item
14:33:52 204  	PROCS_LINE_ITEMS_CRU_V22.UPDATE_LINE_ITEM(
14:33:52 205  	  in_line_item_id    => in_line_item_id,
14:33:52 206  	  in_amount	     => in_amount,
14:33:52 207  	  in_discount_amount => in_discount_amount,
14:33:52 208  	  in_taxes_amount    => in_taxes_amount
14:33:52 209  	);
14:33:52 210  
14:33:52 211  EXCEPTION
14:33:52 212  WHEN BAD_LINE_ITEM_ID THEN
14:33:52 213  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:52 214  	  SPROC_NAME, 'No such line item');
14:33:52 215  WHEN OTHERS THEN
14:33:52 216  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52 217  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52 218  END UPDATE_LINE_ITEM_AMOUNT;
14:33:52 219  
14:33:52 220  /******************************************************************************/
14:33:52 221  
14:33:52 222  PROCEDURE GET_INVOICE_LINE_ITEMS (
14:33:52 223  /*
14:33:52 224  Throws exceptions:
14:33:52 225  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:52 226  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:52 227  */
14:33:52 228  	in_invoice_id  IN NUMBER,
14:33:52 229  	out_result_set OUT SYS_REFCURSOR
14:33:52 230  ) AS
14:33:52 231  -- VARIABLES
14:33:52 232  SPROC_NAME      CONSTANT VARCHAR2(22) := 'GET_INVOICE_LINE_ITEMS';
14:33:52 233  temp_invoice_id NUMBER;
14:33:52 234  
14:33:52 235  -- EXCEPTIONS
14:33:52 236  BAD_INVOICE_ID EXCEPTION;
14:33:52 237  BEGIN
14:33:52 238  
14:33:52 239  	-- Check that given invoice exists
14:33:52 240  	BEGIN
14:33:52 241  	  SELECT
14:33:52 242  	    INVOICE.ID into temp_invoice_id
14:33:52 243  	  FROM
14:33:52 244  	    INVOICE
14:33:52 245  	  WHERE
14:33:52 246  	    INVOICE.ID = in_invoice_id;
14:33:52 247  	  EXCEPTION
14:33:52 248  	    WHEN NO_DATA_FOUND THEN
14:33:52 249  	      RAISE BAD_INVOICE_ID;
14:33:52 250  	END;
14:33:52 251  
14:33:52 252  	-- Select line items
14:33:52 253  	OPEN out_result_set FOR
14:33:52 254  	SELECT
14:33:52 255  	  LINE_ITEM.ID,
14:33:52 256  	  LINE_ITEM.AMOUNT,
14:33:52 257  	  LINE_ITEM.CREATE_DATE,
14:33:52 258  	  LINE_ITEM.CREATED_BY,
14:33:52 259  	  LINE_ITEM.INVOICE_ID,
14:33:52 260  	  LINE_ITEM.DISCOUNT_AMOUNT,
14:33:52 261  	  LINE_ITEM.TAXES_AMOUNT,
14:33:52 262  	  LINE_ITEM.PRODUCT_OFFER_ID
14:33:52 263  	FROM
14:33:52 264  	  LINE_ITEM
14:33:52 265  	WHERE
14:33:52 266  	  LINE_ITEM.INVOICE_ID = in_invoice_id;
14:33:52 267  
14:33:52 268  EXCEPTION
14:33:52 269  WHEN BAD_INVOICE_ID THEN
14:33:52 270  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:52 271  	  SPROC_NAME, 'No such invoice');
14:33:52 272  WHEN OTHERS THEN
14:33:52 273  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52 274  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52 275  END GET_INVOICE_LINE_ITEMS;
14:33:52 276  
14:33:52 277  /******************************************************************************/
14:33:52 278  
14:33:52 279  PROCEDURE GET_LINE_ITEM_TAXES (
14:33:52 280  /*
14:33:52 281  Throws exceptions:
14:33:52 282  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:52 283  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:52 284  */
14:33:52 285  	in_line_item_id IN  NUMBER,
14:33:52 286  	out_result_set	OUT SYS_REFCURSOR
14:33:52 287  ) AS
14:33:52 288  -- VARIABLES
14:33:52 289  SPROC_NAME	CONSTANT VARCHAR2(19) := 'GET_LINE_ITEM_TAXES';
14:33:52 290  temp_line_item_id NUMBER;
14:33:52 291  -- EXCEPTIONS
14:33:52 292  BAD_LINE_ITEM_ID EXCEPTION;
14:33:52 293  BEGIN
14:33:52 294  
14:33:52 295  	-- Check that line item exists
14:33:52 296  	BEGIN
14:33:52 297  	  SELECT
14:33:52 298  	    LINE_ITEM.ID into temp_line_item_id
14:33:52 299  	  FROM
14:33:52 300  	    LINE_ITEM
14:33:52 301  	  WHERE
14:33:52 302  	    LINE_ITEM.ID = in_line_item_id;
14:33:52 303  	  EXCEPTION
14:33:52 304  	    WHEN NO_DATA_FOUND THEN
14:33:52 305  	      RAISE BAD_LINE_ITEM_ID;
14:33:52 306  	END;
14:33:52 307  
14:33:52 308  	-- Get all taxes for given line item
14:33:52 309  	OPEN out_result_set FOR
14:33:52 310  	SELECT
14:33:52 311  	  TAX.ID,
14:33:52 312  	  TAX.CALCULATED_AMOUNT,
14:33:52 313  	  TAX.CREATE_DATE,
14:33:52 314  	  TAX.CREATED_BY,
14:33:52 315  	  TAX.EFFECTIVE_RATE,
14:33:52 316  	  TAX.EXT_RESULT,
14:33:52 317  	  TAX.EXT_TAX_TYPE,
14:33:52 318  	  TAX.IMPOSITION,
14:33:52 319  	  TAX.IMPOSITION_TYPE,
14:33:52 320  	  TAX.JURISDICTION_ID,
14:33:52 321  	  TAX.JURISDICTION_LEVEL_ID,
14:33:52 322  	  TAX.JURISDICTION_NAME,
14:33:52 323  	  TAX.LINE_ITEM_ID,
14:33:52 324  	  TAX.TAX_RULE_ID,
14:33:52 325  	  TAX.TAX_TYPE_ID,
14:33:52 326  	  TAX.TAXABLE_AMOUNT
14:33:52 327  	FROM
14:33:52 328  	  TAX
14:33:52 329  	WHERE
14:33:52 330  	  TAX.LINE_ITEM_ID = in_line_item_id;
14:33:52 331  
14:33:52 332  EXCEPTION
14:33:52 333  WHEN BAD_LINE_ITEM_ID THEN
14:33:52 334  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:52 335  	  SPROC_NAME, 'No such line item');
14:33:52 336  WHEN OTHERS THEN
14:33:52 337  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52 338  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52 339  END GET_LINE_ITEM_TAXES;
14:33:52 340  
14:33:52 341  -- norlov: #38770
14:33:52 342  PROCEDURE GET_LINE_ITEM_DISCOUNTS (
14:33:52 343  /*
14:33:52 344  Throws exceptions:
14:33:52 345  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:52 346  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:52 347  */
14:33:52 348  	in_line_item_id IN  NUMBER,
14:33:52 349  	out_result_set	OUT SYS_REFCURSOR
14:33:52 350  ) AS
14:33:52 351  -- VARIABLES
14:33:52 352  SPROC_NAME	CONSTANT VARCHAR2(23) := 'GET_LINE_ITEM_DISCOUNTS';
14:33:52 353  temp_line_item_id NUMBER;
14:33:52 354  -- EXCEPTIONS
14:33:52 355  BAD_LINE_ITEM_ID EXCEPTION;
14:33:52 356  BEGIN
14:33:52 357  
14:33:52 358  	-- Check that line item exists
14:33:52 359  	BEGIN
14:33:52 360  	  SELECT
14:33:52 361  	    LINE_ITEM.ID into temp_line_item_id
14:33:52 362  	  FROM
14:33:52 363  	    LINE_ITEM
14:33:52 364  	  WHERE
14:33:52 365  	    LINE_ITEM.ID = in_line_item_id;
14:33:52 366  	  EXCEPTION
14:33:52 367  	    WHEN NO_DATA_FOUND THEN
14:33:52 368  	      RAISE BAD_LINE_ITEM_ID;
14:33:52 369  	END;
14:33:52 370  
14:33:52 371  	-- Get all discounts for given line item
14:33:52 372  	OPEN out_result_set FOR
14:33:52 373  	SELECT
14:33:52 374  	  DISCOUNT.FIXED_AMOUNT,
14:33:52 375  	  DISCOUNT.NAME,
14:33:52 376  	  DISCOUNT.ID,
14:33:52 377  	  DISCOUNT.PERCENT_AMOUNT
14:33:52 378  	FROM
14:33:52 379  	  DISCOUNT_LINE_ITEM
14:33:52 380  	  INNER JOIN DISCOUNT ON DISCOUNT_LINE_ITEM.DISCOUNT_ID = DISCOUNT.ID
14:33:52 381  	WHERE
14:33:52 382  	  DISCOUNT_LINE_ITEM.LINE_ITEM_ID = in_line_item_id;
14:33:52 383  
14:33:52 384  EXCEPTION
14:33:52 385  WHEN BAD_LINE_ITEM_ID THEN
14:33:52 386  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:52 387  	  SPROC_NAME, 'No such line item');
14:33:52 388  WHEN OTHERS THEN
14:33:52 389  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52 390  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52 391  END GET_LINE_ITEM_DISCOUNTS;
14:33:52 392  /******************************************************************************/
14:33:52 393  
14:33:52 394  PROCEDURE CALCULATE_LINE_ITEM_AMOUNT (
14:33:52 395  /*
14:33:52 396  Throws exceptions:
14:33:52 397  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:52 398  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:52 399  */
14:33:52 400  	in_line_item_id     IN	NUMBER,
14:33:52 401  	out_amount	    OUT NUMBER
14:33:52 402  ) AS
14:33:52 403  -- VARIABLES
14:33:52 404  SPROC_NAME CONSTANT VARCHAR2(26) := 'CALCULATE_LINE_ITEM_AMOUNT';
14:33:52 405  -- EXCEPTIONS
14:33:52 406  BAD_LINE_ITEM_ID EXCEPTION;
14:33:52 407  BEGIN
14:33:52 408  
14:33:52 409  	BEGIN
14:33:52 410  	  SELECT
14:33:52 411  	    LINE_ITEM.AMOUNT into out_amount
14:33:52 412  	  FROM
14:33:52 413  	    LINE_ITEM
14:33:52 414  	  WHERE
14:33:52 415  	    LINE_ITEM.ID = in_line_item_id;
14:33:52 416  	  EXCEPTION
14:33:52 417  	    WHEN NO_DATA_FOUND THEN
14:33:52 418  	      RAISE BAD_LINE_ITEM_ID;
14:33:52 419  	END;
14:33:52 420  
14:33:52 421  EXCEPTION
14:33:52 422  WHEN BAD_LINE_ITEM_ID THEN
14:33:52 423  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:52 424  	  SPROC_NAME, 'No such line item');
14:33:52 425  WHEN OTHERS THEN
14:33:52 426  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:52 427  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:52 428  END CALCULATE_LINE_ITEM_AMOUNT;
14:33:52 429  
14:33:52 430  /******************************************************************************/
14:33:52 431  
14:33:52 432  FUNCTION F_CALCULATE_LINE_ITEM_AMOUNT (
14:33:52 433  /*
14:33:52 434  Throws exceptions:
14:33:52 435  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:52 436  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:52 437  */
14:33:52 438  	in_line_item_id     IN	NUMBER
14:33:52 439  ) RETURN NUMBER AS
14:33:52 440  var_invoice_amount NUMBER(10, 2);
14:33:52 441  BEGIN
14:33:52 442  	PROCS_LINE_ITEMS_V22.CALCULATE_LINE_ITEM_AMOUNT(in_line_item_id, var_invoice_amount);
14:33:52 443  	RETURN var_invoice_amount;
14:33:52 444  END F_CALCULATE_LINE_ITEM_AMOUNT;
14:33:52 445  
14:33:52 446  END PROCS_LINE_ITEMS_V22;
14:33:52 447  .
14:33:52 SQL> /

Package body created.

Elapsed: 00:00:00.05
14:33:53 SQL> 
14:33:53 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_LOCKING_V22" AS
14:33:53   2  
14:33:53   3  /*
14:33:53   4  PROCEDURE INITIALIZE_SYSTEM AS
14:33:53   5  SPROC_NAME CONSTANT VARCHAR2(17) := 'INITIALIZE_SYSTEM';
14:33:53   6  -- VARIABLES
14:33:53   7  var_account_ids SYS_REFCURSOR;
14:33:53   8  var_account_id  NUMBER;
14:33:53   9  BEGIN
14:33:53  10  
14:33:53  11  	OPEN var_account_ids FOR
14:33:53  12  	SELECT
14:33:53  13  	  ACCOUNT.ID
14:33:53  14  	FROM
14:33:53  15  	  ACCOUNT;
14:33:53  16  
14:33:53  17  	LOOP
14:33:53  18  	  FETCH var_account_ids into var_account_id;
14:33:53  19  	  EXIT WHEN var_account_ids%NOTFOUND;
14:33:53  20  	  BEGIN
14:33:53  21  	    INITIALIZE_ACCOUNT(var_account_id);
14:33:53  22  	    EXCEPTION
14:33:53  23  	      WHEN OTHERS THEN
14:33:53  24  		NULL;
14:33:53  25  	  END;
14:33:53  26  	END LOOP;
14:33:53  27  
14:33:53  28  END INITIALIZE_SYSTEM;
14:33:53  29  
14:33:53  30  PROCEDURE INITIALIZE_ACCOUNT (
14:33:53  31  	in_account_id IN NUMBER
14:33:53  32  ) AS
14:33:53  33  SPROC_NAME CONSTANT VARCHAR2(18) := 'INITIALIZE_ACCOUNT';
14:33:53  34  -- EXCEPTIONS
14:33:53  35  ACCOUNT_ALREADY_INITIALIZED EXCEPTION;
14:33:53  36  BEGIN
14:33:53  37  
14:33:53  38  	BEGIN
14:33:53  39  	  INSERT INTO ACCOUNT_LOCK(
14:33:53  40  	    ACCOUNT_ID,
14:33:53  41  	    LOCK_KEY,
14:33:53  42  	    END_DATE,
14:33:53  43  	    CREATED_BY,
14:33:53  44  	    REASON
14:33:53  45  	  ) VALUES (
14:33:53  46  	    in_account_id,
14:33:53  47  	    'initialization key',
14:33:53  48  	    SYSDATE,
14:33:53  49  	    'system',
14:33:53  50  	    'initialization'
14:33:53  51  	  );
14:33:53  52  	  EXCEPTION
14:33:53  53  	    WHEN DUP_VAL_ON_INDEX THEN
14:33:53  54  	      RAISE ACCOUNT_ALREADY_INITIALIZED;
14:33:53  55  	END;
14:33:53  56  
14:33:53  57  EXCEPTION
14:33:53  58  WHEN ACCOUNT_ALREADY_INITIALIZED THEN
14:33:53  59  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:53  60  	  SPROC_NAME, 'Account already initialized');
14:33:53  61  WHEN OTHERS THEN
14:33:53  62  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53  63  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53  64  END;
14:33:53  65  
14:33:53  66  PROCEDURE INITIALIZE_GROUP (
14:33:53  67  	in_group_id IN NUMBER
14:33:53  68  ) AS
14:33:53  69  SPROC_NAME CONSTANT VARCHAR2(16) := 'INITIALIZE_GROUP';
14:33:53  70  -- VARIABLES
14:33:53  71  var_account_id NUMBER;
14:33:53  72  -- EXCEPTIONS
14:33:53  73  BAD_GROUP_ID		EXCEPTION;
14:33:53  74  GROUP_ALREADY_INITIALIZED EXCEPTION;
14:33:53  75  BEGIN
14:33:53  76  
14:33:53  77  	BEGIN
14:33:53  78  	  SELECT
14:33:53  79  	    ACCOUNT.ID into var_account_id
14:33:53  80  	  FROM
14:33:53  81  	    ACCOUNT
14:33:53  82  	  WHERE
14:33:53  83  	    ACCOUNT.GROUP_ID = in_group_id;
14:33:53  84  	  EXCEPTION
14:33:53  85  	    WHEN NO_DATA_FOUND THEN
14:33:53  86  	     RAISE BAD_GROUP_ID;
14:33:53  87  	END;
14:33:53  88  
14:33:53  89  	BEGIN
14:33:53  90  	  INSERT INTO ACCOUNT_LOCK (
14:33:53  91  	    ACCOUNT_ID,
14:33:53  92  	    LOCK_KEY,
14:33:53  93  	    END_DATE,
14:33:53  94  	    CREATED_BY,
14:33:53  95  	    REASON
14:33:53  96  	  ) VALUES (
14:33:53  97  	    var_account_id,
14:33:53  98  	    'initialization key',
14:33:53  99  	    SYSDATE,
14:33:53 100  	    'system',
14:33:53 101  	    'initialization'
14:33:53 102  	  );
14:33:53 103  	  EXCEPTION
14:33:53 104  	    WHEN DUP_VAL_ON_INDEX THEN
14:33:53 105  	      RAISE GROUP_ALREADY_INITIALIZED;
14:33:53 106  	END;
14:33:53 107  
14:33:53 108  EXCEPTION
14:33:53 109  WHEN BAD_GROUP_ID THEN
14:33:53 110  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 111  	  SPROC_NAME, 'No such account with given group id');
14:33:53 112  WHEN GROUP_ALREADY_INITIALIZED THEN
14:33:53 113  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:53 114  	  SPROC_NAME, 'Group already initialized');
14:33:53 115  WHEN OTHERS THEN
14:33:53 116  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 117  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 118  END INITIALIZE_GROUP;
14:33:53 119  */
14:33:53 120  
14:33:53 121  PROCEDURE LOCK_ACCOUNT (
14:33:53 122  	in_group_id    IN NUMBER,
14:33:53 123  	in_lock_key    IN VARCHAR2,
14:33:53 124  	in_seconds_num IN NUMBER,
14:33:53 125  	in_created_by  IN VARCHAR2,
14:33:53 126  	in_reason      IN VARCHAR2
14:33:53 127  ) AS
14:33:53 128  SPROC_NAME CONSTANT VARCHAR2(12) := 'LOCK_ACCOUNT';
14:33:53 129  -- CONSTANTS
14:33:53 130  one_second_interval CONSTANT INTERVAL DAY TO SECOND := INTERVAL '0 00:00:01' DAY TO SECOND;
14:33:53 131  -- VARIABLES
14:33:53 132  var_account_id NUMBER;
14:33:53 133  -- arosolovskiy: using data variable instead of direct get data calls (#38860)
14:33:53 134  var_date		DATE := SYSDATE;
14:33:53 135  var_lock_end_date DATE;
14:33:53 136  -- EXCEPTIONS
14:33:53 137  BAD_GROUP_ID   EXCEPTION;
14:33:53 138  ALREADY_LOCKED EXCEPTION;
14:33:53 139  BEGIN
14:33:53 140  
14:33:53 141  	BEGIN
14:33:53 142  	  SELECT
14:33:53 143  	    ACCOUNT.ID into var_account_id
14:33:53 144  	  FROM
14:33:53 145  	    ACCOUNT
14:33:53 146  	  WHERE
14:33:53 147  	    ACCOUNT.GROUP_ID = in_group_id;
14:33:53 148  	  EXCEPTION
14:33:53 149  	    WHEN NO_DATA_FOUND THEN
14:33:53 150  	      RAISE BAD_GROUP_ID;
14:33:53 151  	END;
14:33:53 152  
14:33:53 153  	var_lock_end_date := var_date + ( in_seconds_num * one_second_interval );
14:33:53 154  
14:33:53 155  	BEGIN
14:33:53 156  
14:33:53 157  	  INSERT INTO ACCOUNT_LOCK (
14:33:53 158  	    ACCOUNT_ID,
14:33:53 159  	    LOCK_KEY,
14:33:53 160  	    END_DATE,
14:33:53 161  	    CREATED_BY,
14:33:53 162  	    REASON
14:33:53 163  	  ) VALUES (
14:33:53 164  	    var_account_id,
14:33:53 165  	    in_lock_key,
14:33:53 166  	    var_lock_end_date,
14:33:53 167  	    in_created_by,
14:33:53 168  	    in_reason
14:33:53 169  	  );
14:33:53 170  
14:33:53 171  	  EXCEPTION
14:33:53 172  	    WHEN DUP_VAL_ON_INDEX THEN
14:33:53 173  	      -- This rows was created before... I will try to update it
14:33:53 174  	      BEGIN
14:33:53 175  
14:33:53 176  		UPDATE
14:33:53 177  		  ACCOUNT_LOCK
14:33:53 178  		SET
14:33:53 179  		  ACCOUNT_LOCK.LOCK_KEY = in_lock_key,
14:33:53 180  		  ACCOUNT_LOCK.END_DATE = var_lock_end_date,
14:33:53 181  		  ACCOUNT_LOCK.CREATED_BY = in_created_by,
14:33:53 182  		  ACCOUNT_LOCK.REASON = in_reason
14:33:53 183  		WHERE
14:33:53 184  		  ACCOUNT_LOCK.ACCOUNT_ID = var_account_id
14:33:53 185  		  AND ACCOUNT_LOCK.END_DATE <= var_date;
14:33:53 186  
14:33:53 187  		IF SQL%ROWCOUNT = 0 THEN
14:33:53 188  		  RAISE ALREADY_LOCKED;
14:33:53 189  		END IF;
14:33:53 190  
14:33:53 191  	      END;
14:33:53 192  	END;
14:33:53 193  
14:33:53 194  EXCEPTION
14:33:53 195  WHEN BAD_GROUP_ID THEN
14:33:53 196  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 197  	  SPROC_NAME, 'No such group id');
14:33:53 198  WHEN ALREADY_LOCKED THEN
14:33:53 199  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:53 200  	  SPROC_NAME, 'Account already locked');
14:33:53 201  WHEN OTHERS THEN
14:33:53 202  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 203  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 204  END LOCK_ACCOUNT;
14:33:53 205  
14:33:53 206  /******************************************************************************/
14:33:53 207  
14:33:53 208  PROCEDURE RELEASE_LOCK (
14:33:53 209  	in_group_id IN NUMBER,
14:33:53 210  	in_lock_key IN VARCHAR2
14:33:53 211  ) AS
14:33:53 212  SPROC_NAME CONSTANT VARCHAR2(12) := 'RELEASE_LOCK';
14:33:53 213  -- VARIABLES
14:33:53 214  var_account_id NUMBER;
14:33:53 215  -- arosolovskiy: using data variable instead of direct get data calls (#38860)
14:33:53 216  var_date DATE := SYSDATE;
14:33:53 217  -- EXCEPTIONS
14:33:53 218  BAD_GROUP_ID		EXCEPTION;
14:33:53 219  COULD_NOT_RELEASE_ACCOUNT EXCEPTION;
14:33:53 220  BEGIN
14:33:53 221  
14:33:53 222  	BEGIN
14:33:53 223  	  SELECT
14:33:53 224  	    ACCOUNT.ID into var_account_id
14:33:53 225  	  FROM
14:33:53 226  	    ACCOUNT
14:33:53 227  	  WHERE
14:33:53 228  	    ACCOUNT.GROUP_ID = in_group_id;
14:33:53 229  	  EXCEPTION
14:33:53 230  	    WHEN NO_DATA_FOUND THEN
14:33:53 231  	      RAISE BAD_GROUP_ID;
14:33:53 232  	END;
14:33:53 233  
14:33:53 234  	UPDATE
14:33:53 235  	  ACCOUNT_LOCK
14:33:53 236  	SET
14:33:53 237  	  ACCOUNT_LOCK.END_DATE = var_date
14:33:53 238  	WHERE
14:33:53 239  	  ACCOUNT_LOCK.ACCOUNT_ID = var_account_id
14:33:53 240  	  -- AND ACCOUNT_LOCK.END_DATE > var_date
14:33:53 241  	  AND ACCOUNT_LOCK.LOCK_KEY = in_lock_key;
14:33:53 242  
14:33:53 243  	IF SQL%ROWCOUNT = 0 THEN
14:33:53 244  	  RAISE COULD_NOT_RELEASE_ACCOUNT;
14:33:53 245  	END IF;
14:33:53 246  
14:33:53 247  EXCEPTION
14:33:53 248  WHEN BAD_GROUP_ID THEN
14:33:53 249  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 250  	  SPROC_NAME, 'No such group id');
14:33:53 251  WHEN COULD_NOT_RELEASE_ACCOUNT THEN
14:33:53 252  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:53 253  	  SPROC_NAME, 'Could not release account. Maybe you are not owner of this lock, or lock is expired');
14:33:53 254  WHEN OTHERS THEN
14:33:53 255  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 256  	  SPROC_NAME, 'Unknown error');
14:33:53 257  END RELEASE_LOCK;
14:33:53 258  
14:33:53 259  END PROCS_LOCKING_V22;
14:33:53 260  .
14:33:53 SQL> /

Package body created.

Elapsed: 00:00:00.03
14:33:53 SQL> 
14:33:53 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_OFFER_CHAIN_V22" AS
14:33:53   2  
14:33:53   3  PROCEDURE OC_ID_BY_ITUNES_PRODUCT_ID(
14:33:53   4  	in_itunes_product_id IN  OFFER_CHAIN.ITUNES_PRODUCT_ID%TYPE,
14:33:53   5  	out_data	     OUT OFFER_CHAIN.ID%TYPE
14:33:53   6  ) AS
14:33:53   7  	SPROC_NAME CONSTANT VARCHAR2(32) := 'OC_ID_BY_ITUNES_PRODUCT_ID';
14:33:53   8  BEGIN
14:33:53   9  	SELECT
14:33:53  10  	  ID INTO out_data
14:33:53  11  	FROM
14:33:53  12  	  OFFER_CHAIN
14:33:53  13  	WHERE
14:33:53  14  	  ITUNES_PRODUCT_ID = in_itunes_product_id;
14:33:53  15  EXCEPTION
14:33:53  16  	WHEN NO_DATA_FOUND THEN NULL;
14:33:53  17  END OC_ID_BY_ITUNES_PRODUCT_ID;
14:33:53  18  
14:33:53  19  PROCEDURE OFFER_CHAIN_ID_BY_AMAZON_SKU(
14:33:53  20  	in_amazon_appstore_sku IN  OFFER_CHAIN.AMAZON_APPSTORE_SKU%TYPE,
14:33:53  21  	out_data	       OUT OFFER_CHAIN.ID%TYPE
14:33:53  22  ) AS
14:33:53  23  SPROC_NAME CONSTANT VARCHAR2(32) := 'OFFER_CHAIN_ID_BY_AMAZON_SKU';
14:33:53  24  BEGIN
14:33:53  25  	SELECT
14:33:53  26  	  ID INTO out_data
14:33:53  27  	FROM
14:33:53  28  	  OFFER_CHAIN
14:33:53  29  	WHERE
14:33:53  30  	  AMAZON_APPSTORE_SKU = in_amazon_appstore_sku;
14:33:53  31  EXCEPTION
14:33:53  32  	WHEN NO_DATA_FOUND THEN NULL;
14:33:53  33  END OFFER_CHAIN_ID_BY_AMAZON_SKU;
14:33:53  34  
14:33:53  35  PROCEDURE GET_OFFER_CHAIN_BY_ID (
14:33:53  36  	in_offer_chain_id IN   NUMBER,
14:33:53  37  	out_result_set	  OUT  SYS_REFCURSOR
14:33:53  38  ) AS
14:33:53  39  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_OFFER_CHAIN_BY_ID';
14:33:53  40  BEGIN
14:33:53  41  
14:33:53  42  	-- Get offer chain informations
14:33:53  43  	OPEN out_result_set FOR
14:33:53  44  	  SELECT
14:33:53  45  	    OC.ID,
14:33:53  46  	    OC.NAME,
14:33:53  47  	    OC.ADOPTABILITY_WINDOW_START_DATE,
14:33:53  48  	    OC.ADOPTABILITY_WINDOW_END_DATE,
14:33:53  49  	    OC.DESCRIPTION,
14:33:53  50  	    OC.IS_GIFT_CERTIFICATE,
14:33:53  51  	    OC.OFFER_CHAIN_STATUS_ID,
14:33:53  52  	    OC.PRODUCT_URI,
14:33:53  53  	    OC.BILLING_SOURCE_ID,
14:33:53  54  	    OC.VENDOR_SOURCE_ID,
14:33:53  55  	    OC.GROUP_ACCOUNT_TYPE_ID,
14:33:53  56  	    DECODE(OC.IS_ADDRESS_REQUIRED,1,'true','false') IS_ADDRESS_REQUIRED,
14:33:53  57  	    OC.AMAZON_APPSTORE_SKU,
14:33:53  58  	    OC.ITUNES_PRODUCT_ID
14:33:53  59  	  FROM
14:33:53  60  	    OFFER_CHAIN OC
14:33:53  61  	  WHERE
14:33:53  62  	    OC.ID = in_offer_chain_id
14:33:53  63  	    AND ROWNUM <= 1;
14:33:53  64  
14:33:53  65  EXCEPTION
14:33:53  66  WHEN OTHERS THEN
14:33:53  67  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53  68  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53  69  END GET_OFFER_CHAIN_BY_ID;
14:33:53  70  
14:33:53  71  PROCEDURE GET_OFFER_CHAINS_BY_IDS (
14:33:53  72  	in_offer_chain_ids IN core_owner.NUMBER_TABLE,
14:33:53  73  	out_result_set	   OUT SYS_REFCURSOR
14:33:53  74  ) AS
14:33:53  75  SPROC_NAME CONSTANT VARCHAR2(23) := 'GET_OFFER_CHAINS_BY_IDS';
14:33:53  76  -- EXCEPTIONS
14:33:53  77  BAD_OFFER_CHAINS_IDS EXCEPTION;
14:33:53  78  BEGIN
14:33:53  79  
14:33:53  80  	IF (in_offer_chain_ids IS NULL) THEN
14:33:53  81  	  RAISE BAD_OFFER_CHAINS_IDS;
14:33:53  82  	END IF;
14:33:53  83  
14:33:53  84  	OPEN out_result_set FOR
14:33:53  85  	SELECT
14:33:53  86  	  OCH.ID,
14:33:53  87  	  OCH.NAME,
14:33:53  88  	  OCH.DESCRIPTION,
14:33:53  89  	  OCH.OFFER_CHAIN_STATUS_ID,
14:33:53  90  	  OCH.ADOPTABILITY_WINDOW_START_DATE,
14:33:53  91  	  OCH.ADOPTABILITY_WINDOW_END_DATE,
14:33:53  92  	  OCH.IS_GIFT_CERTIFICATE,
14:33:53  93  	  PROCS_OFFER_CHAIN_V22.CALCULATE_OFFER_CHAIN_AMOUNT(OCH.ID) AS PRICE,
14:33:53  94  	  PROCS_OFFER_CHAIN_V22.IS_OFFER_CHAIN_CANCELABLE(OCH.ID) AS IS_CANCELABLE,
14:33:53  95  	  OCH.VENDOR_SOURCE_ID,
14:33:53  96  	  DECODE(OCH.IS_ADDRESS_REQUIRED,1,'true','false') IS_ADDRESS_REQUIRED
14:33:53  97  	FROM
14:33:53  98  	  OFFER_CHAIN OCH
14:33:53  99  	WHERE
14:33:53 100  	  OCH.ID IN (SELECT * FROM TABLE(in_offer_chain_ids));
14:33:53 101  
14:33:53 102  EXCEPTION
14:33:53 103  WHEN BAD_OFFER_CHAINS_IDS THEN
14:33:53 104  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:53 105  	  SPROC_NAME, 'Invalid offer chains ids');
14:33:53 106  WHEN OTHERS THEN
14:33:53 107  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 108  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 109  END GET_OFFER_CHAINS_BY_IDS;
14:33:53 110  
14:33:53 111  PROCEDURE GET_OFFER_CHAINS_PRODUCTS (
14:33:53 112  	in_offer_chain_ids IN core_owner.NUMBER_TABLE,
14:33:53 113  	out_result_set	   OUT SYS_REFCURSOR
14:33:53 114  ) AS
14:33:53 115  SPROC_NAME CONSTANT VARCHAR2(25) := 'GET_OFFER_CHAINS_PRODUCTS';
14:33:53 116  -- EXCEPTIONS
14:33:53 117  BAD_OFFER_CHAINS_IDS EXCEPTION;
14:33:53 118  BEGIN
14:33:53 119  
14:33:53 120  	IF (in_offer_chain_ids IS NULL) THEN
14:33:53 121  	  RAISE BAD_OFFER_CHAINS_IDS;
14:33:53 122  	END IF;
14:33:53 123  
14:33:53 124  	OPEN out_result_set FOR
14:33:53 125  	SELECT
14:33:53 126  	  OOCH.OFFER_CHAIN_ID,
14:33:53 127  	  PO.PRODUCT_ID
14:33:53 128  	FROM
14:33:53 129  	  PRODUCT_OFFERING PO
14:33:53 130  	  INNER JOIN OFFER_PRODUCT_OFFERING OPO ON OPO.PRODUCT_OFFERING_ID = PO.ID
14:33:53 131  	  INNER JOIN OFFER_OFFER_CHAIN OOCH ON OOCH.OFFER_ID = OPO.OFFER_ID
14:33:53 132  	WHERE
14:33:53 133  	  OOCH.OFFER_CHAIN_ID IN (SELECT * FROM TABLE (in_offer_chain_ids));
14:33:53 134  
14:33:53 135  EXCEPTION
14:33:53 136  WHEN BAD_OFFER_CHAINS_IDS THEN
14:33:53 137  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:53 138  	  SPROC_NAME, 'Invalid offer chains ids');
14:33:53 139  WHEN OTHERS THEN
14:33:53 140  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 141  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 142  END GET_OFFER_CHAINS_PRODUCTS;
14:33:53 143  
14:33:53 144  PROCEDURE GET_OFFER_CHAINS_OFFERS (
14:33:53 145  	in_offer_chain_ids IN core_owner.NUMBER_TABLE,
14:33:53 146  	out_result_set	   OUT SYS_REFCURSOR
14:33:53 147  ) AS
14:33:53 148  SPROC_NAME CONSTANT VARCHAR2(23) := 'GET_OFFER_CHAINS_OFFERS';
14:33:53 149  -- EXCEPTIONS
14:33:53 150  BAD_OFFER_CHAINS_IDS EXCEPTION;
14:33:53 151  BEGIN
14:33:53 152  
14:33:53 153  	IF (in_offer_chain_ids IS NULL) THEN
14:33:53 154  	  RAISE BAD_OFFER_CHAINS_IDS;
14:33:53 155  	END IF;
14:33:53 156  
14:33:53 157  	OPEN out_result_set FOR
14:33:53 158  	SELECT
14:33:53 159  	  OOCH.OFFER_CHAIN_ID,
14:33:53 160  	  OOCH.OFFER_ID,
14:33:53 161  	  OOCH.INDEX_VALUE,
14:33:53 162  	  OOCH.NUM_RECURRENCES,
14:33:53 163  	  O.ENTITLEMENT_DURATION,
14:33:53 164  	  PROCS_OFFER_CHAIN_V22.CALCULATE_OFFER_AMOUNT(OOCH.OFFER_ID) AS PRICE
14:33:53 165  	FROM
14:33:53 166  	  OFFER O
14:33:53 167  	  INNER JOIN OFFER_OFFER_CHAIN OOCH ON OOCH.OFFER_ID = O.ID
14:33:53 168  	WHERE
14:33:53 169  	  OOCH.OFFER_CHAIN_ID IN (SELECT * FROM TABLE (in_offer_chain_ids));
14:33:53 170  
14:33:53 171  EXCEPTION
14:33:53 172  WHEN BAD_OFFER_CHAINS_IDS THEN
14:33:53 173  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:53 174  	  SPROC_NAME, 'Invalid offer chains ids');
14:33:53 175  WHEN OTHERS THEN
14:33:53 176  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 177  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 178  END GET_OFFER_CHAINS_OFFERS;
14:33:53 179  
14:33:53 180  PROCEDURE GET_OFFER_CHAINS_BY_PRODUCT (
14:33:53 181  	in_product_id  IN  NUMBER,
14:33:53 182  	out_result_set OUT SYS_REFCURSOR
14:33:53 183  )AS
14:33:53 184  -- VARIBLES
14:33:53 185  SPROC_NAME      CONSTANT VARCHAR2(27) := 'GET_OFFER_CHAINS_BY_PRODUCT';
14:33:53 186  temp_product_id NUMBER;
14:33:53 187  
14:33:53 188  -- EXCEPTIONS
14:33:53 189  BAD_PRODUCT_ID EXCEPTION;
14:33:53 190  BEGIN
14:33:53 191  
14:33:53 192  	-- Check that given product exists
14:33:53 193  	BEGIN
14:33:53 194  	  SELECT
14:33:53 195  	    PRODUCT.ID into temp_product_id
14:33:53 196  	  FROM
14:33:53 197  	    PRODUCT
14:33:53 198  	  WHERE
14:33:53 199  	    PRODUCT.ID = in_product_id;
14:33:53 200  	  EXCEPTION
14:33:53 201  	    WHEN NO_DATA_FOUND THEN
14:33:53 202  	      RAISE BAD_PRODUCT_ID;
14:33:53 203  	END;
14:33:53 204  
14:33:53 205  	-- Select all offer chains that contains given product
14:33:53 206  	OPEN out_result_set FOR
14:33:53 207  	SELECT
14:33:53 208  	  OFFER_CHAIN.ID,
14:33:53 209  	  OFFER_CHAIN.NAME,
14:33:53 210  	  OFFER_CHAIN.DESCRIPTION,
14:33:53 211  	  OFFER_CHAIN.ADOPTABILITY_WINDOW_START_DATE,
14:33:53 212  	  OFFER_CHAIN.ADOPTABILITY_WINDOW_END_DATE,
14:33:53 213  	  OFFER_CHAIN.OFFER_CHAIN_STATUS_ID,
14:33:53 214  	  OFFER_CHAIN.IS_GIFT_CERTIFICATE
14:33:53 215  	FROM
14:33:53 216  	  OFFER_CHAIN
14:33:53 217  	WHERE
14:33:53 218  	  OFFER_CHAIN.ID IN (
14:33:53 219  	    SELECT DISTINCT
14:33:53 220  	      OFFER_OFFER_CHAIN.OFFER_CHAIN_ID
14:33:53 221  	    FROM
14:33:53 222  	      OFFER_OFFER_CHAIN
14:33:53 223  	    WHERE
14:33:53 224  	      OFFER_OFFER_CHAIN.OFFER_ID IN (
14:33:53 225  		SELECT DISTINCT
14:33:53 226  		  OFFER_PRODUCT_OFFERING.OFFER_ID
14:33:53 227  		FROM
14:33:53 228  		  OFFER_PRODUCT_OFFERING
14:33:53 229  		WHERE
14:33:53 230  		  OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = in_product_id
14:33:53 231  	      )
14:33:53 232  	  );
14:33:53 233  
14:33:53 234  EXCEPTION
14:33:53 235  WHEN BAD_PRODUCT_ID THEN
14:33:53 236  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 237  	  SPROC_NAME, 'No such product');
14:33:53 238  WHEN OTHERS THEN
14:33:53 239  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 240  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 241  END GET_OFFER_CHAINS_BY_PRODUCT;
14:33:53 242  
14:33:53 243  PROCEDURE GET_OFFER_CHAIN_PRICE (
14:33:53 244  	in_offer_chain_id IN NUMBER,
14:33:53 245  	out_price	  OUT NUMBER
14:33:53 246  ) AS
14:33:53 247  -- VARIABLES
14:33:53 248  SPROC_NAME	  CONSTANT VARCHAR2(21) := 'GET_OFFER_CHAIN_PRICE';
14:33:53 249  temp_offer_chain_id NUMBER;
14:33:53 250  
14:33:53 251  -- EXCEPTION
14:33:53 252  BAD_OFFER_CHAIN_ID       EXCEPTION;
14:33:53 253  CAN_NOT_CALCULATE_AMOUNT EXCEPTION;
14:33:53 254  EXCEPTION_MESSAGE        VARCHAR2(1024);
14:33:53 255  BEGIN
14:33:53 256  
14:33:53 257  	-- Check that given offer chain exists
14:33:53 258  	BEGIN
14:33:53 259  	  SELECT
14:33:53 260  	    OFFER_CHAIN.ID into temp_offer_chain_id
14:33:53 261  	  FROM
14:33:53 262  	    OFFER_CHAIN
14:33:53 263  	  WHERE
14:33:53 264  	    OFFER_CHAIN.ID = in_offer_chain_id;
14:33:53 265  
14:33:53 266  	  EXCEPTION
14:33:53 267  	  WHEN NO_DATA_FOUND THEN
14:33:53 268  	    RAISE BAD_OFFER_CHAIN_ID;
14:33:53 269  	END;
14:33:53 270  
14:33:53 271  	BEGIN
14:33:53 272  	  out_price := CALCULATE_OFFER_CHAIN_AMOUNT(in_offer_chain_id);
14:33:53 273  	  EXCEPTION
14:33:53 274  	    WHEN OTHERS THEN
14:33:53 275  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:53 276  	      RAISE CAN_NOT_CALCULATE_AMOUNT;
14:33:53 277  	END;
14:33:53 278  
14:33:53 279  EXCEPTION
14:33:53 280  WHEN BAD_OFFER_CHAIN_ID THEN
14:33:53 281  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 282  	  SPROC_NAME, 'Bad offer chain id');
14:33:53 283  WHEN CAN_NOT_CALCULATE_AMOUNT THEN
14:33:53 284  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 285  	  SPROC_NAME, 'Caould not calculate offer chain amount', EXCEPTION_MESSAGE);
14:33:53 286  WHEN OTHERS THEN
14:33:53 287  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 288  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 289  END GET_OFFER_CHAIN_PRICE;
14:33:53 290  
14:33:53 291  PROCEDURE GET_FIRST_OFFER(
14:33:53 292  	in_offer_chain_id IN  NUMBER,
14:33:53 293  	out_offer_id	  OUT NUMBER
14:33:53 294  ) AS
14:33:53 295  SPROC_NAME CONSTANT VARCHAR2(15) := 'GET_FIRST_OFFER';
14:33:53 296  BEGIN
14:33:53 297  	-- Seect first offer in offer chain
14:33:53 298  	SELECT
14:33:53 299  	  OFFER_ID into out_offer_id
14:33:53 300  	FROM (
14:33:53 301  	  SELECT
14:33:53 302  	    OFFER_OFFER_CHAIN.OFFER_ID
14:33:53 303  	  FROM
14:33:53 304  	    OFFER_OFFER_CHAIN
14:33:53 305  	  WHERE
14:33:53 306  	    OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_id
14:33:53 307  	  ORDER BY
14:33:53 308  	    OFFER_OFFER_CHAIN.INDEX_VALUE ASC
14:33:53 309  	)
14:33:53 310  	WHERE
14:33:53 311  	  ROWNUM <= 1;
14:33:53 312  
14:33:53 313  EXCEPTION
14:33:53 314  WHEN NO_DATA_FOUND THEN
14:33:53 315  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 316  	  SPROC_NAME, 'No such offer chain');
14:33:53 317  WHEN OTHERS THEN
14:33:53 318  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 319  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 320  END GET_FIRST_OFFER;
14:33:53 321  
14:33:53 322  PROCEDURE GET_ACTIVE_OFFER_CHAINS (
14:33:53 323  	out_result_set OUT SYS_REFCURSOR
14:33:53 324  ) AS
14:33:53 325  SPROC_NAME CONSTANT VARCHAR2(23) := 'GET_ACTIVE_OFFER_CHAINS';
14:33:53 326  BEGIN
14:33:53 327  	OPEN out_result_set FOR
14:33:53 328  	SELECT
14:33:53 329  	  OFFER_CHAIN.ID,
14:33:53 330  	  OFFER_CHAIN.NAME,
14:33:53 331  	  OFFER_CHAIN.DESCRIPTION,
14:33:53 332  	  OFFER_CHAIN.ADOPTABILITY_WINDOW_START_DATE,
14:33:53 333  	  OFFER_CHAIN.ADOPTABILITY_WINDOW_END_DATE,
14:33:53 334  	  OFFER_CHAIN.OFFER_CHAIN_STATUS_ID,
14:33:53 335  	  OFFER_CHAIN.IS_GIFT_CERTIFICATE,
14:33:53 336  	  PROCS_OFFER_CHAIN_V22.IS_OFFER_CHAIN_CANCELABLE(OFFER_CHAIN.ID) AS "IS_CANCELABLE",
14:33:53 337  	  PRODUCT_OFFERING.PRODUCT_ID
14:33:53 338  	FROM
14:33:53 339  	  OFFER_CHAIN,
14:33:53 340  	  OFFER_OFFER_CHAIN,
14:33:53 341  	  OFFER_PRODUCT_OFFERING,
14:33:53 342  	  PRODUCT_OFFERING
14:33:53 343  	WHERE
14:33:53 344  	  OFFER_CHAIN.ID = OFFER_OFFER_CHAIN.OFFER_CHAIN_ID
14:33:53 345  	  and OFFER_OFFER_CHAIN.OFFER_ID = OFFER_PRODUCT_OFFERING.OFFER_ID
14:33:53 346  	  and OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = PRODUCT_OFFERING.ID
14:33:53 347  	  and OFFER_CHAIN.OFFER_CHAIN_STATUS_ID = GLOBAL_STATUSES_V22.OFFER_CHAIN_ACTIVE;
14:33:53 348  
14:33:53 349  EXCEPTION
14:33:53 350  WHEN OTHERS THEN
14:33:53 351  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 352  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 353  END GET_ACTIVE_OFFER_CHAINS;
14:33:53 354  
14:33:53 355  PROCEDURE GET_OFFER_CHAIN_PRODUCTS (
14:33:53 356  	in_offer_chain_id IN NUMBER,
14:33:53 357  	out_result_set	  OUT SYS_REFCURSOR
14:33:53 358  ) AS
14:33:53 359  -- VARIABLES
14:33:53 360  SPROC_NAME	  CONSTANT VARCHAR2(24) := 'GET_OFFER_CHAIN_PRODUCTS';
14:33:53 361  temp_offer_chain_id NUMBER;
14:33:53 362  
14:33:53 363  -- EXCEPTIONS
14:33:53 364  BAD_OFFER_CHAIN EXCEPTION;
14:33:53 365  BEGIN
14:33:53 366  
14:33:53 367  	-- Check that offer chain exists
14:33:53 368  	BEGIN
14:33:53 369  	  SELECT
14:33:53 370  	    OFFER_CHAIN.ID into temp_offer_chain_id
14:33:53 371  	  FROM
14:33:53 372  	    OFFER_CHAIN
14:33:53 373  	  WHERE
14:33:53 374  	    OFFER_CHAIN.ID = in_offer_chain_id
14:33:53 375  	    AND ROWNUM <= 1;
14:33:53 376  
14:33:53 377  	  EXCEPTION
14:33:53 378  	    WHEN OTHERS THEN
14:33:53 379  	      RAISE BAD_OFFER_CHAIN;
14:33:53 380  	END;
14:33:53 381  
14:33:53 382  	-- Select all products for given offer chain
14:33:53 383  	OPEN out_result_set FOR
14:33:53 384  	SELECT DISTINCT
14:33:53 385  	  PRODUCT_OFFERING.PRODUCT_ID
14:33:53 386  	FROM
14:33:53 387  	  PRODUCT_OFFERING
14:33:53 388  	WHERE
14:33:53 389  	  PRODUCT_OFFERING.ID IN (
14:33:53 390  	    SELECT DISTINCT
14:33:53 391  	      OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID
14:33:53 392  	    FROM
14:33:53 393  	      OFFER_PRODUCT_OFFERING
14:33:53 394  	    WHERE
14:33:53 395  	      OFFER_PRODUCT_OFFERING.OFFER_ID IN (
14:33:53 396  		SELECT
14:33:53 397  		  OFFER_OFFER_CHAIN.OFFER_ID
14:33:53 398  		FROM
14:33:53 399  		  OFFER_OFFER_CHAIN
14:33:53 400  		WHERE
14:33:53 401  		  OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_id
14:33:53 402  	      )
14:33:53 403  	  );
14:33:53 404  
14:33:53 405  EXCEPTION
14:33:53 406  WHEN BAD_OFFER_CHAIN THEN
14:33:53 407  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 408  	  SPROC_NAME, 'No such offer chain');
14:33:53 409  WHEN OTHERS THEN
14:33:53 410  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 411  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 412  END GET_OFFER_CHAIN_PRODUCTS;
14:33:53 413  
14:33:53 414  FUNCTION CALCULATE_OFFER_CHAIN_END_DATE (
14:33:53 415  	in_offer_chain_id	  IN NUMBER,
14:33:53 416  	in_offer_chain_start_date IN DATE
14:33:53 417  ) RETURN DATE AS
14:33:53 418  -- VARIABLES
14:33:53 419  SPROC_NAME	     CONSTANT VARCHAR2(30) := 'CALCULATE_OFFER_CHAIN_END_DATE';
14:33:53 420  temp_offer_chain_id    NUMBER;
14:33:53 421  var_offer_chain_length NUMBER;
14:33:53 422  var_offer_duration     VARCHAR2(30);
14:33:53 423  var_offer_recurrences  NUMBER;
14:33:53 424  var_end_date	     DATE;
14:33:53 425  
14:33:53 426  var_offer_ym_interval INTERVAL YEAR TO MONTH;
14:33:53 427  var_offer_ds_interval INTERVAL DAY(3) TO SECOND;
14:33:53 428  var_offer_years	    NUMBER;
14:33:53 429  var_offer_months	    NUMBER;
14:33:53 430  var_offer_days	    NUMBER;
14:33:53 431  var_infinity_offers_count NUMBER;
14:33:53 432  
14:33:53 433  var_offers_set SYS_REFCURSOR;
14:33:53 434  
14:33:53 435  -- EXCEPTIONS
14:33:53 436  BAD_OFFER_CHAIN_ID EXCEPTION;
14:33:53 437  BEGIN
14:33:53 438  
14:33:53 439  	var_end_date := in_offer_chain_start_date;
14:33:53 440  
14:33:53 441  	-- Check that offer chain exists
14:33:53 442  	BEGIN
14:33:53 443  	  SELECT
14:33:53 444  	    OFFER_CHAIN.ID into temp_offer_chain_id
14:33:53 445  	  FROM
14:33:53 446  	    OFFER_CHAIN
14:33:53 447  	  WHERE
14:33:53 448  	    OFFER_CHAIN.ID = in_offer_chain_id;
14:33:53 449  	  EXCEPTION
14:33:53 450  	    WHEN NO_DATA_FOUND
14:33:53 451  	      THEN RAISE BAD_OFFER_CHAIN_ID;
14:33:53 452  	END;
14:33:53 453  
14:33:53 454  	SELECT
14:33:53 455  	  COUNT(*) into var_infinity_offers_count
14:33:53 456  	FROM
14:33:53 457  	  OFFER_OFFER_CHAIN
14:33:53 458  	WHERE
14:33:53 459  	  OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_id
14:33:53 460  	  AND OFFER_OFFER_CHAIN.NUM_RECURRENCES = GLOBAL_ENUMS_V22.OFFER_REC_INFINITY;
14:33:53 461  
14:33:53 462  	IF var_infinity_offers_count > 0 THEN
14:33:53 463  	  -- Offer chain contains offers with infinity num of recurrences
14:33:53 464  	  RETURN NULL;
14:33:53 465  	END IF;
14:33:53 466  
14:33:53 467  	-- Select offers durations
14:33:53 468  	OPEN var_offers_set FOR
14:33:53 469  	SELECT
14:33:53 470  	  OFFER.ENTITLEMENT_DURATION,
14:33:53 471  	  OFFER_OFFER_CHAIN.NUM_RECURRENCES
14:33:53 472  	FROM
14:33:53 473  	  OFFER_OFFER_CHAIN
14:33:53 474  	  INNER JOIN OFFER ON OFFER_OFFER_CHAIN.OFFER_ID = OFFER.ID
14:33:53 475  	WHERE
14:33:53 476  	  OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_id;
14:33:53 477  
14:33:53 478  	-- Calculate sum of offers durations
14:33:53 479  	LOOP
14:33:53 480  	  FETCH var_offers_set INTO var_offer_duration, var_offer_recurrences;
14:33:53 481  	  EXIT WHEN var_offers_set%NOTFOUND;
14:33:53 482  	  PROCS_COMMON_V22.ISO8601DURATION_TO_INTERVALS(var_offer_duration, var_offer_years, var_offer_months, var_offer_days);
14:33:53 483  	  var_offer_ym_interval := var_offer_years||'-'||var_offer_months;
14:33:53 484  	  var_offer_ds_interval := var_offer_days||' 0:0:0';
14:33:53 485  	  var_end_date := var_end_date + ( var_offer_ym_interval * ( var_offer_recurrences + 1) ) + ( var_offer_ds_interval * ( var_offer_recurrences + 1) );
14:33:53 486  	END LOOP;
14:33:53 487  
14:33:53 488  	RETURN var_end_date;
14:33:53 489  
14:33:53 490  EXCEPTION
14:33:53 491  WHEN BAD_OFFER_CHAIN_ID THEN
14:33:53 492  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 493  	  SPROC_NAME, 'No such offer chain');
14:33:53 494  WHEN OTHERS THEN
14:33:53 495  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 496  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 497  END CALCULATE_OFFER_CHAIN_END_DATE;
14:33:53 498  
14:33:53 499  FUNCTION CALCULATE_OFFER_AMOUNT (
14:33:53 500  	in_offer_id IN NUMBER
14:33:53 501  ) RETURN NUMBER AS
14:33:53 502  -- VARIABLES
14:33:53 503  SPROC_NAME    CONSTANT VARCHAR2(22) := 'CALCULATE_OFFER_AMOUNT';
14:33:53 504  temp_offer_id NUMBER;
14:33:53 505  
14:33:53 506  var_product_offering_set	    SYS_REFCURSOR;
14:33:53 507  var_product_offering_id	    NUMBER;
14:33:53 508  var_product_offering_price    NUMBER(10,6);
14:33:53 509  var_product_offering_t_amount NUMBER(10,6);
14:33:53 510  var_product_offering_quantity NUMBER;
14:33:53 511  
14:33:53 512  var_total_amount NUMBER(10,6);
14:33:53 513  var_final_amount NUMBER(10,2);
14:33:53 514  
14:33:53 515  var_percent_discount NUMBER(10,2);
14:33:53 516  var_fixed_discount NUMBER(10,6);
14:33:53 517  
14:33:53 518  -- EXCEPTIONS
14:33:53 519  BAD_OFFER_ID EXCEPTION;
14:33:53 520  BEGIN
14:33:53 521  
14:33:53 522  	BEGIN
14:33:53 523  	  SELECT
14:33:53 524  	    OFFER.ID into temp_offer_id
14:33:53 525  	  FROM
14:33:53 526  	    OFFER
14:33:53 527  	  WHERE
14:33:53 528  	    OFFER.ID = in_offer_id;
14:33:53 529  	  EXCEPTION
14:33:53 530  	    WHEN NO_DATA_FOUND THEN
14:33:53 531  	      RAISE BAD_OFFER_ID;
14:33:53 532  	END;
14:33:53 533  
14:33:53 534  	OPEN var_product_offering_set FOR
14:33:53 535  	SELECT
14:33:53 536  	  OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID,
14:33:53 537  	  PRODUCT_OFFERING.UNIT_PRICE,
14:33:53 538  	  PRODUCT_OFFERING.QUANTITY
14:33:53 539  	FROM
14:33:53 540  	  OFFER_PRODUCT_OFFERING
14:33:53 541  	  INNER JOIN PRODUCT_OFFERING ON OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = PRODUCT_OFFERING.ID
14:33:53 542  	WHERE
14:33:53 543  	  OFFER_PRODUCT_OFFERING.OFFER_ID = in_offer_id;
14:33:53 544  
14:33:53 545  	var_total_amount := 0;
14:33:53 546  
14:33:53 547  	LOOP
14:33:53 548  	  FETCH var_product_offering_set into
14:33:53 549  	    var_product_offering_id,
14:33:53 550  	    var_product_offering_price,
14:33:53 551  	    var_product_offering_quantity;
14:33:53 552  	  EXIT WHEN var_product_offering_set%NOTFOUND;
14:33:53 553  
14:33:53 554  	  SELECT
14:33:53 555  	    SUM(DISCOUNT.FIXED_AMOUNT) into var_fixed_discount
14:33:53 556  	  FROM
14:33:53 557  	    DISCOUNT_PRODUCT_OFFERING
14:33:53 558  	    INNER JOIN DISCOUNT ON DISCOUNT_PRODUCT_OFFERING.DISCOUNT_ID = DISCOUNT.ID
14:33:53 559  	  WHERE
14:33:53 560  	    DISCOUNT_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = var_product_offering_id
14:33:53 561  	    AND DISCOUNT.FIXED_AMOUNT IS NOT NULL;
14:33:53 562  
14:33:53 563  	  SELECT
14:33:53 564  	    SUM(DISCOUNT.PERCENT_AMOUNT) into var_percent_discount
14:33:53 565  	  FROM
14:33:53 566  	    DISCOUNT_PRODUCT_OFFERING
14:33:53 567  	    INNER JOIN DISCOUNT ON DISCOUNT_PRODUCT_OFFERING.DISCOUNT_ID = DISCOUNT.ID
14:33:53 568  	  WHERE
14:33:53 569  	    DISCOUNT_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = var_product_offering_id
14:33:53 570  	    AND DISCOUNT.PERCENT_AMOUNT IS NOT NULL;
14:33:53 571  
14:33:53 572  	  var_product_offering_t_amount := var_product_offering_price * var_product_offering_quantity;
14:33:53 573  
14:33:53 574  	  IF var_percent_discount IS NOT NULL THEN
14:33:53 575  	    var_product_offering_t_amount := var_product_offering_t_amount - ( var_product_offering_t_amount * var_percent_discount / 100 );
14:33:53 576  	  END IF;
14:33:53 577  
14:33:53 578  	  IF var_fixed_discount IS NOT NULL THEN
14:33:53 579  	    var_product_offering_t_amount := var_product_offering_t_amount - var_fixed_discount;
14:33:53 580  	  END IF;
14:33:53 581  
14:33:53 582  	  var_total_amount := var_total_amount + var_product_offering_t_amount;
14:33:53 583  	END LOOP;
14:33:53 584  	var_final_amount := var_total_amount;
14:33:53 585  	RETURN var_final_amount;
14:33:53 586  
14:33:53 587  EXCEPTION
14:33:53 588  WHEN BAD_OFFER_ID THEN
14:33:53 589  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 590  	  SPROC_NAME, 'No such offer');
14:33:53 591  WHEN OTHERS THEN
14:33:53 592  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 593  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 594  END CALCULATE_OFFER_AMOUNT;
14:33:53 595  
14:33:53 596  FUNCTION CALCULATE_OFFER_CHAIN_AMOUNT (
14:33:53 597  	in_offer_chain_id IN NUMBER
14:33:53 598  ) RETURN NUMBER AS
14:33:53 599  -- VARIABLES
14:33:53 600  SPROC_NAME	     CONSTANT VARCHAR2(28) := 'CALCULATE_OFFER_CHAIN_AMOUNT';
14:33:53 601  temp_offer_chain_id    NUMBER;
14:33:53 602  var_first_offer_id     NUMBER;
14:33:53 603  -- EXCEPTIONS
14:33:53 604  BAD_OFFER_CHAIN_ID      EXCEPTION;
14:33:53 605  CAN_NOT_GET_FIRST_OFFER EXCEPTION;
14:33:53 606  EXCEPTION_MESSAGE       VARCHAR2(1024);
14:33:53 607  BEGIN
14:33:53 608  
14:33:53 609  	BEGIN
14:33:53 610  	  SELECT
14:33:53 611  	    OFFER_CHAIN.ID into temp_offer_chain_id
14:33:53 612  	  FROM
14:33:53 613  	    OFFER_CHAIN
14:33:53 614  	  WHERE
14:33:53 615  	    OFFER_CHAIN.ID = in_offer_chain_id;
14:33:53 616  	  EXCEPTION
14:33:53 617  	    WHEN NO_DATA_FOUND THEN
14:33:53 618  	      RAISE BAD_OFFER_CHAIN_ID;
14:33:53 619  	END;
14:33:53 620  
14:33:53 621  	BEGIN
14:33:53 622  	  PROCS_OFFER_CHAIN_V22.GET_FIRST_OFFER(
14:33:53 623  	    in_offer_chain_id => in_offer_chain_id,
14:33:53 624  	    out_offer_id      => var_first_offer_id
14:33:53 625  	  );
14:33:53 626  	  EXCEPTION
14:33:53 627  	    WHEN OTHERS THEN
14:33:53 628  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:53 629  	      RAISE CAN_NOT_GET_FIRST_OFFER;
14:33:53 630  	END;
14:33:53 631  
14:33:53 632  	RETURN CALCULATE_OFFER_AMOUNT(var_first_offer_id);
14:33:53 633  
14:33:53 634  EXCEPTION
14:33:53 635  WHEN BAD_OFFER_CHAIN_ID THEN
14:33:53 636  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 637  	  SPROC_NAME, 'No such offer chain');
14:33:53 638  WHEN CAN_NOT_GET_FIRST_OFFER THEN
14:33:53 639  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 640  	  SPROC_NAME, 'Could not find first offer', EXCEPTION_MESSAGE);
14:33:53 641  WHEN OTHERS THEN
14:33:53 642  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 643  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 644  END CALCULATE_OFFER_CHAIN_AMOUNT;
14:33:53 645  
14:33:53 646  FUNCTION GET_FIRST_OFFER_INDEX (
14:33:53 647  	in_offer_chain_id IN NUMBER
14:33:53 648  ) RETURN NUMBER AS
14:33:53 649  -- VARIABLES
14:33:53 650  SPROC_NAME	    CONSTANT VARCHAR2(21) := 'GET_FIRST_OFFER_INDEX';
14:33:53 651  var_first_offer_index NUMBER;
14:33:53 652  BEGIN
14:33:53 653  
14:33:53 654  	SELECT
14:33:53 655  	  INDEX_VALUE into var_first_offer_index
14:33:53 656  	FROM (
14:33:53 657  	  SELECT
14:33:53 658  	    OFFER_OFFER_CHAIN.INDEX_VALUE
14:33:53 659  	  FROM
14:33:53 660  	    OFFER_OFFER_CHAIN
14:33:53 661  	  WHERE
14:33:53 662  	    OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_id
14:33:53 663  	  ORDER BY
14:33:53 664  	    OFFER_OFFER_CHAIN.INDEX_VALUE ASC
14:33:53 665  	)
14:33:53 666  	WHERE
14:33:53 667  	  ROWNUM <= 1;
14:33:53 668  
14:33:53 669  	RETURN var_first_offer_index;
14:33:53 670  
14:33:53 671  EXCEPTION
14:33:53 672  WHEN NO_DATA_FOUND THEN
14:33:53 673  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 674  	  SPROC_NAME, 'No such offer chain');
14:33:53 675  WHEN OTHERS THEN
14:33:53 676  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 677  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 678  END GET_FIRST_OFFER_INDEX;
14:33:53 679  
14:33:53 680  FUNCTION GET_NEXT_OFFER_INDEX (
14:33:53 681  	in_offer_chain_id	     IN NUMBER,
14:33:53 682  	in_offer_chain_current_index IN NUMBER
14:33:53 683  ) RETURN NUMBER AS
14:33:53 684  -- VARIABLES
14:33:53 685  SPROC_NAME		     CONSTANT VARCHAR2(20) := 'GET_NEXT_OFFER_INDEX';
14:33:53 686  temp_offer_chain_id	     NUMBER;
14:33:53 687  temp_offer_chain_current_index NUMBER;
14:33:53 688  var_result		     NUMBER;
14:33:53 689  -- EXCEPTIONS
14:33:53 690  BAD_OFFER_CHAIN_ID      EXCEPTION;
14:33:53 691  BAD_CURRENT_INDEX_VALUE EXCEPTION;
14:33:53 692  BEGIN
14:33:53 693  
14:33:53 694  	-- Check that offer chain exists
14:33:53 695  	BEGIN
14:33:53 696  	  SELECT
14:33:53 697  	    OFFER_CHAIN.ID into temp_offer_chain_id
14:33:53 698  	  FROM
14:33:53 699  	    OFFER_CHAIN
14:33:53 700  	  WHERE
14:33:53 701  	    OFFER_CHAIN.ID = in_offer_chain_id;
14:33:53 702  	  EXCEPTION
14:33:53 703  	    WHEN NO_DATA_FOUND THEN
14:33:53 704  	      RAISE BAD_OFFER_CHAIN_ID;
14:33:53 705  	END;
14:33:53 706  
14:33:53 707  	-- Check that current offer index exists
14:33:53 708  	BEGIN
14:33:53 709  	  SELECT
14:33:53 710  	    OFFER_OFFER_CHAIN.INDEX_VALUE into temp_offer_chain_current_index
14:33:53 711  	  FROM
14:33:53 712  	    OFFER_OFFER_CHAIN
14:33:53 713  	  WHERE
14:33:53 714  	    OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_id
14:33:53 715  	    AND OFFER_OFFER_CHAIN.INDEX_VALUE = in_offer_chain_current_index
14:33:53 716  	    -- TODO: delete next line
14:33:53 717  	    AND ROWNUM <= 1;
14:33:53 718  	  EXCEPTION
14:33:53 719  	    WHEN NO_DATA_FOUND THEN
14:33:53 720  	      RAISE BAD_CURRENT_INDEX_VALUE;
14:33:53 721  	END;
14:33:53 722  
14:33:53 723  	-- Get next offer index
14:33:53 724  	BEGIN
14:33:53 725  	  SELECT
14:33:53 726  	    INDEX_VALUE into var_result
14:33:53 727  	  FROM (
14:33:53 728  	    SELECT
14:33:53 729  	      OFFER_OFFER_CHAIN.INDEX_VALUE
14:33:53 730  	    FROM
14:33:53 731  	      OFFER_OFFER_CHAIN
14:33:53 732  	    WHERE
14:33:53 733  	      OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_id
14:33:53 734  	      AND OFFER_OFFER_CHAIN.INDEX_VALUE > in_offer_chain_current_index
14:33:53 735  	    ORDER BY
14:33:53 736  	      OFFER_OFFER_CHAIN.INDEX_VALUE ASC
14:33:53 737  	  )
14:33:53 738  	  WHERE
14:33:53 739  	    ROWNUM <= 1;
14:33:53 740  	  EXCEPTION
14:33:53 741  	    WHEN NO_DATA_FOUND THEN
14:33:53 742  	      var_result := NULL;
14:33:53 743  	END;
14:33:53 744  
14:33:53 745  	RETURN var_result;
14:33:53 746  
14:33:53 747  EXCEPTION
14:33:53 748  WHEN BAD_OFFER_CHAIN_ID THEN
14:33:53 749  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 750  	  SPROC_NAME, 'No such offer chain');
14:33:53 751  WHEN BAD_CURRENT_INDEX_VALUE THEN
14:33:53 752  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 753  	  SPROC_NAME, 'Bad current index value');
14:33:53 754  WHEN OTHERS THEN
14:33:53 755  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 756  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 757  END GET_NEXT_OFFER_INDEX;
14:33:53 758  
14:33:53 759  PROCEDURE P_GET_NEXT_OFFER_INDEX (
14:33:53 760  	in_offer_chain_id	     IN NUMBER,
14:33:53 761  	in_offer_chain_current_index IN NUMBER,
14:33:53 762  	out_next_offer_index	     OUT NUMBER
14:33:53 763  ) AS
14:33:53 764  BEGIN
14:33:53 765  	out_next_offer_index := GET_NEXT_OFFER_INDEX(
14:33:53 766  	  in_offer_chain_id,
14:33:53 767  	  in_offer_chain_current_index
14:33:53 768  	);
14:33:53 769  END P_GET_NEXT_OFFER_INDEX;
14:33:53 770  
14:33:53 771  PROCEDURE GET_NEXT_OFFER_INDEX_BY_LCNS (
14:33:53 772  	in_license_id		     IN NUMBER,
14:33:53 773  	in_offer_chain_current_index IN NUMBER,
14:33:53 774  	out_next_offer_index	     OUT NUMBER
14:33:53 775  ) AS
14:33:53 776  -- VARIABLES
14:33:53 777  SPROC_NAME	 CONSTANT VARCHAR2(28) := 'GET_NEXT_OFFER_INDEX_BY_LCNS';
14:33:53 778  var_offer_chain_id NUMBER;
14:33:53 779  -- EXCEPTIONS
14:33:53 780  BAD_LICENSE_ID		   EXCEPTION;
14:33:53 781  CAN_NOT_GET_NEXT_OFFER_INDEX EXCEPTION;
14:33:53 782  EXCEPTION_MESSAGE 	   VARCHAR2(1024);
14:33:53 783  BEGIN
14:33:53 784  
14:33:53 785  	BEGIN
14:33:53 786  	  SELECT
14:33:53 787  	    SUBSCRIPTION.OFFER_CHAIN_ID into var_offer_chain_id
14:33:53 788  	  FROM
14:33:53 789  	    SUBSCRIPTION
14:33:53 790  	  WHERE
14:33:53 791  	    SUBSCRIPTION.ID = (
14:33:53 792  	      SELECT
14:33:53 793  		LICENSE.SUBSCRIPTION_ID
14:33:53 794  	      FROM
14:33:53 795  		LICENSE
14:33:53 796  	      WHERE
14:33:53 797  		LICENSE.ID = in_license_id
14:33:53 798  	    );
14:33:53 799  	  EXCEPTION
14:33:53 800  	    WHEN NO_DATA_FOUND THEN
14:33:53 801  	      RAISE BAD_LICENSE_ID;
14:33:53 802  	END;
14:33:53 803  
14:33:53 804  	BEGIN
14:33:53 805  	  out_next_offer_index := GET_NEXT_OFFER_INDEX(
14:33:53 806  	    var_offer_chain_id,
14:33:53 807  	    in_offer_chain_current_index
14:33:53 808  	  );
14:33:53 809  	  EXCEPTION
14:33:53 810  	    WHEN OTHERS THEN
14:33:53 811  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:53 812  	      RAISE CAN_NOT_GET_NEXT_OFFER_INDEX;
14:33:53 813  	END;
14:33:53 814  
14:33:53 815  EXCEPTION
14:33:53 816  WHEN BAD_LICENSE_ID THEN
14:33:53 817  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 818  	  SPROC_NAME, 'No such license');
14:33:53 819  WHEN CAN_NOT_GET_NEXT_OFFER_INDEX THEN
14:33:53 820  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 821  	  SPROC_NAME, 'Could not get next offer index', EXCEPTION_MESSAGE);
14:33:53 822  WHEN OTHERS THEN
14:33:53 823  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 824  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 825  END GET_NEXT_OFFER_INDEX_BY_LCNS;
14:33:53 826  
14:33:53 827  FUNCTION IS_OFFER_INDEX_EXISTS (
14:33:53 828  	in_offer_chain_id	   IN NUMBER,
14:33:53 829  	in_offer_chain_offer_index IN NUMBER
14:33:53 830  ) RETURN NUMBER AS
14:33:53 831  -- VARIABLES
14:33:53 832  SPROC_NAME CONSTANT VARCHAR2(21) := 'IS_OFFER_INDEX_EXISTS';
14:33:53 833  temp_count NUMBER;
14:33:53 834  BEGIN
14:33:53 835  
14:33:53 836  	SELECT
14:33:53 837  	  COUNT(*) into temp_count
14:33:53 838  	FROM
14:33:53 839  	  OFFER_OFFER_CHAIN
14:33:53 840  	WHERE
14:33:53 841  	  OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_id
14:33:53 842  	  AND OFFER_OFFER_CHAIN.INDEX_VALUE = in_offer_chain_offer_index;
14:33:53 843  
14:33:53 844  	IF temp_count > 0 THEN
14:33:53 845  	  RETURN GLOBAL_CONSTANTS_V22.TRUE;
14:33:53 846  	ELSE
14:33:53 847  	  RETURN GLOBAL_CONSTANTS_V22.FALSE;
14:33:53 848  	END IF;
14:33:53 849  
14:33:53 850  EXCEPTION
14:33:53 851  WHEN OTHERS THEN
14:33:53 852  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 853  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 854  END IS_OFFER_INDEX_EXISTS;
14:33:53 855  
14:33:53 856  PROCEDURE GET_OFFER_LENGTH (
14:33:53 857  	in_offer_id IN NUMBER,
14:33:53 858  	out_years   OUT NUMBER,
14:33:53 859  	out_months  OUT NUMBER,
14:33:53 860  	out_days    OUT NUMBER
14:33:53 861  ) AS
14:33:53 862  -- VARIABLES
14:33:53 863  var_offer_duration VARCHAR2(30);
14:33:53 864  SPROC_NAME	 CONSTANT VARCHAR2(16) := 'GET_OFFER_LENGTH';
14:33:53 865  -- EXCEPTIONS
14:33:53 866  BAD_OFFER_ID	     EXCEPTION;
14:33:53 867  CAN_NOT_PARSE_DURATION EXCEPTION;
14:33:53 868  EXCEPTION_MESSAGE       VARCHAR2(1024);
14:33:53 869  BEGIN
14:33:53 870  
14:33:53 871  	BEGIN
14:33:53 872  	  SELECT
14:33:53 873  	    OFFER.ENTITLEMENT_DURATION into var_offer_duration
14:33:53 874  	  FROM
14:33:53 875  	    OFFER
14:33:53 876  	  WHERE
14:33:53 877  	    OFFER.ID = in_offer_id;
14:33:53 878  	  EXCEPTION
14:33:53 879  	    WHEN NO_DATA_FOUND THEN
14:33:53 880  	      RAISE BAD_OFFER_ID;
14:33:53 881  	END;
14:33:53 882  
14:33:53 883  	BEGIN
14:33:53 884  	  PROCS_COMMON_V22.ISO8601DURATION_TO_INTERVALS(
14:33:53 885  	    var_offer_duration,
14:33:53 886  	    out_years,
14:33:53 887  	    out_months,
14:33:53 888  	    out_days
14:33:53 889  	  );
14:33:53 890  	  EXCEPTION
14:33:53 891  	    WHEN OTHERS THEN
14:33:53 892  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:53 893  	      RAISE CAN_NOT_PARSE_DURATION;
14:33:53 894  	END;
14:33:53 895  
14:33:53 896  EXCEPTION
14:33:53 897  WHEN BAD_OFFER_ID THEN
14:33:53 898  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 899  	  SPROC_NAME, 'No such offer');
14:33:53 900  WHEN CAN_NOT_PARSE_DURATION THEN
14:33:53 901  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 902  	  SPROC_NAME, 'Can not parse offer duration', EXCEPTION_MESSAGE);
14:33:53 903  WHEN OTHERS THEN
14:33:53 904  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 905  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 906  END GET_OFFER_LENGTH;
14:33:53 907  
14:33:53 908  PROCEDURE GET_OFFER_LENGTH_IN_DAYS (
14:33:53 909  	in_offer_id   IN NUMBER,
14:33:53 910  	in_start_date IN DATE DEFAULT SYSDATE,
14:33:53 911  	out_days      OUT NUMBER
14:33:53 912  ) AS
14:33:53 913  SPROC_NAME CONSTANT VARCHAR2(24) := 'GET_OFFER_LENGTH_IN_DAYS';
14:33:53 914  -- VARIABLES
14:33:53 915  var_offer_duration VARCHAR2(30);
14:33:53 916  var_offer_years	 NUMBER;
14:33:53 917  var_offer_months	 NUMBER;
14:33:53 918  var_offer_days	 NUMBER;
14:33:53 919  var_offer_end_date DATE;
14:33:53 920  -- EXCEPTIONS
14:33:53 921  BAD_OFFER_ID EXCEPTION;
14:33:53 922  BEGIN
14:33:53 923  
14:33:53 924  	BEGIN
14:33:53 925  	  SELECT
14:33:53 926  	    OFFER.ENTITLEMENT_DURATION into var_offer_duration
14:33:53 927  	  FROM
14:33:53 928  	    OFFER
14:33:53 929  	  WHERE
14:33:53 930  	    OFFER.ID = in_offer_id;
14:33:53 931  	  EXCEPTION
14:33:53 932  	    WHEN NO_DATA_FOUND THEN
14:33:53 933  	      RAISE BAD_OFFER_ID;
14:33:53 934  	END;
14:33:53 935  
14:33:53 936  	PROCS_COMMON_V22.ISO8601DURATION_TO_INTERVALS (
14:33:53 937  	  var_offer_duration,
14:33:53 938  	  var_offer_years,
14:33:53 939  	  var_offer_months,
14:33:53 940  	  var_offer_days
14:33:53 941  	);
14:33:53 942  
14:33:53 943  	var_offer_end_date := ( ( in_start_date
14:33:53 944  	  + GLOBAL_CONSTANTS_V22.ONE_DAY_INTERVAL * var_offer_days )
14:33:53 945  	  + GLOBAL_CONSTANTS_V22.ONE_MONTH_INTERVAL * var_offer_months )
14:33:53 946  	  + GLOBAL_CONSTANTS_V22.ONE_YEAR_INTERVAL * var_offer_years;
14:33:53 947  
14:33:53 948  	out_days := var_offer_end_date - in_start_date;
14:33:53 949  
14:33:53 950  EXCEPTION
14:33:53 951  WHEN BAD_OFFER_ID THEN
14:33:53 952  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 953  	  SPROC_NAME, 'No such offer');
14:33:53 954  WHEN OTHERS THEN
14:33:53 955  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 956  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 957  END GET_OFFER_LENGTH_IN_DAYS;
14:33:53 958  
14:33:53 959  PROCEDURE GET_OFFER_PRODUCTS (
14:33:53 960  	in_offer_id    IN NUMBER,
14:33:53 961  	out_result_set OUT SYS_REFCURSOR
14:33:53 962  ) AS
14:33:53 963  -- VARIABLES
14:33:53 964  SPROC_NAME     CONSTANT VARCHAR2(18) := 'GET_OFFER_PRODUCTS';
14:33:53 965  temp_offerr_id NUMBER;
14:33:53 966  -- EXCEPTIONS
14:33:53 967  BAD_OFFER_ID EXCEPTION;
14:33:53 968  BEGIN
14:33:53 969  
14:33:53 970  	BEGIN
14:33:53 971  	  SELECT
14:33:53 972  	    OFFER.ID into temp_offerr_id
14:33:53 973  	  FROM
14:33:53 974  	    OFFER
14:33:53 975  	  WHERE
14:33:53 976  	    OFFER.ID = in_offer_id;
14:33:53 977  	  EXCEPTION
14:33:53 978  	    WHEN NO_DATA_FOUND THEN
14:33:53 979  	      RAISE BAD_OFFER_ID;
14:33:53 980  	END;
14:33:53 981  
14:33:53 982  	OPEN out_result_set FOR
14:33:53 983  	SELECT DISTINCT
14:33:53 984  	  PRODUCT.ID,
14:33:53 985  	  PRODUCT.NAME
14:33:53 986  	FROM
14:33:53 987  	  PRODUCT
14:33:53 988  	WHERE
14:33:53 989  	  PRODUCT.ID IN (
14:33:53 990  	      SELECT
14:33:53 991  		PRODUCT_OFFERING.PRODUCT_ID
14:33:53 992  	      FROM
14:33:53 993  		OFFER_PRODUCT_OFFERING
14:33:53 994  		INNER JOIN PRODUCT_OFFERING ON OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = PRODUCT_OFFERING.ID
14:33:53 995  	      WHERE
14:33:53 996  		OFFER_PRODUCT_OFFERING.OFFER_ID = in_offer_id
14:33:53 997  	    );
14:33:53 998  
14:33:53 999  EXCEPTION
14:33:53 1000  WHEN BAD_OFFER_ID THEN
14:33:53 1001  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1002  	   SPROC_NAME, 'No such offer');
14:33:53 1003  WHEN OTHERS THEN
14:33:53 1004  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1005  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1006  END GET_OFFER_PRODUCTS;
14:33:53 1007  
14:33:53 1008  PROCEDURE GET_OFFER_CHAIN_PROD_OFFERINGS (
14:33:53 1009  	 in_offer_chain_id IN NUMBER,
14:33:53 1010  	 out_result_set    OUT SYS_REFCURSOR
14:33:53 1011  ) AS
14:33:53 1012  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_OFFER_CHAIN_PROD_OFFERINGS';
14:33:53 1013  -- VARIABLES
14:33:53 1014  temp_offer_chain_id NUMBER;
14:33:53 1015  -- EXCEPTIONS
14:33:53 1016  BAD_OFFER_CHAIN_ID EXCEPTION;
14:33:53 1017  BEGIN
14:33:53 1018  
14:33:53 1019  	 BEGIN
14:33:53 1020  	   SELECT
14:33:53 1021  	     OFFER_CHAIN.ID into temp_offer_chain_id
14:33:53 1022  	   FROM
14:33:53 1023  	     OFFER_CHAIN
14:33:53 1024  	   WHERE
14:33:53 1025  	     OFFER_CHAIN.ID = in_offer_chain_id;
14:33:53 1026  	   EXCEPTION
14:33:53 1027  	     WHEN NO_DATA_FOUND THEN
14:33:53 1028  	       RAISE BAD_OFFER_CHAIN_ID;
14:33:53 1029  	 END;
14:33:53 1030  
14:33:53 1031  	 OPEN out_result_set FOR
14:33:53 1032  	 SELECT
14:33:53 1033  	   PRODUCT_OFFERING.ID,
14:33:53 1034  	   PRODUCT_OFFERING.PRODUCT_ID,
14:33:53 1035  	   PRODUCT_OFFERING.TAX_CATEGORY_ID,
14:33:53 1036  	   PRODUCT_OFFERING.UNIT_PRICE,
14:33:53 1037  	   PRODUCT_OFFERING.QUANTITY,
14:33:53 1038  	   PRODUCT_OFFERING.CREATE_DATE,
14:33:53 1039  	   PRODUCT_OFFERING.CREATED_BY,
14:33:53 1040  	   PRODUCT.NAME,
14:33:53 1041  	   PRODUCT.PRODUCT_URI,
14:33:53 1042  	   CAPABILITY.ID CAP_ID,
14:33:53 1043  	   CAPABILITY.CODE CAP_CODE,
14:33:53 1044  	   CAPABILITY.DESCRIPTION CAP_DESCRIPTION,
14:33:53 1045  	   CAPABILITY.SHAREABLE CAP_SHAREABLE
14:33:53 1046  	 FROM
14:33:53 1047  	   PRODUCT_OFFERING
14:33:53 1048  	   INNER JOIN PRODUCT ON PRODUCT_OFFERING.PRODUCT_ID = PRODUCT.ID
14:33:53 1049  	   INNER JOIN CAPABILITY ON PRODUCT_OFFERING.CAPABILITY_ID = CAPABILITY.ID
14:33:53 1050  	 WHERE
14:33:53 1051  	   PRODUCT_OFFERING.ID IN (
14:33:53 1052  	     SELECT DISTINCT
14:33:53 1053  	       PRODUCT_OFFERING_ID
14:33:53 1054  	     FROM
14:33:53 1055  	       OFFER_PRODUCT_OFFERING
14:33:53 1056  	     WHERE
14:33:53 1057  	       OFFER_PRODUCT_OFFERING.OFFER_ID IN (
14:33:53 1058  		 SELECT DISTINCT
14:33:53 1059  		   OFFER_ID
14:33:53 1060  		 FROM
14:33:53 1061  		   OFFER_OFFER_CHAIN
14:33:53 1062  		 WHERE
14:33:53 1063  		   OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_id
14:33:53 1064  	       )
14:33:53 1065  	   );
14:33:53 1066  
14:33:53 1067  EXCEPTION
14:33:53 1068  WHEN BAD_OFFER_CHAIN_ID THEN
14:33:53 1069  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1070  	   SPROC_NAME, 'Bad offer chain id');
14:33:53 1071  WHEN OTHERS THEN
14:33:53 1072  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1073  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1074  END GET_OFFER_CHAIN_PROD_OFFERINGS;
14:33:53 1075  
14:33:53 1076  FUNCTION CHECK_FOR_SAME_PRODUCTS (
14:33:53 1077  	 in_offer_chain_1	  IN OFFER_CHAIN.ID%TYPE,
14:33:53 1078  	 in_offer_chain_2	  IN OFFER_CHAIN.ID%TYPE,
14:33:53 1079  	 in_use_eligibility_rules IN NUMBER DEFAULT GLOBAL_CONSTANTS_V22.FALSE
14:33:53 1080  ) RETURN NUMBER AS
14:33:53 1081  SPROC_NAME CONSTANT VARCHAR2(23) := 'CHECK_FOR_SAME_PRODUCTS';
14:33:53 1082  -- CONSTANTS
14:33:53 1083  PRODUCT_ELIGIBILITY_NAME CONSTANT VARCHAR2(19) := 'MAX_CONCURRENT_SUBS';
14:33:53 1084  -- VARIABLES
14:33:53 1085  temp_offer_chain_id	OFFER_CHAIN.ID%TYPE;
14:33:53 1086  var_same_products	SYS_REFCURSOR;
14:33:53 1087  var_same_product_id	NUMBER;
14:33:53 1088  same_product_count	NUMBER;
14:33:53 1089  var_product_eligibility_limit NUMBER;
14:33:53 1090  s_product_eligibility_limit   VARCHAR2(100);
14:33:53 1091  -- EXCEPTIONS
14:33:53 1092  BAD_FIRST_OFFER_CHAIN	      EXCEPTION;
14:33:53 1093  BAD_SECOND_OFFER_CHAIN	      EXCEPTION;
14:33:53 1094  BEGIN
14:33:53 1095  
14:33:53 1096  	 -- Check that first offer chain exists
14:33:53 1097  	 BEGIN
14:33:53 1098  	   SELECT
14:33:53 1099  	     OFFER_CHAIN.ID into temp_offer_chain_id
14:33:53 1100  	   FROM
14:33:53 1101  	     OFFER_CHAIN
14:33:53 1102  	   WHERE
14:33:53 1103  	     OFFER_CHAIN.ID = in_offer_chain_1;
14:33:53 1104  	   EXCEPTION
14:33:53 1105  	     WHEN NO_DATA_FOUND THEN
14:33:53 1106  	       RAISE BAD_FIRST_OFFER_CHAIN;
14:33:53 1107  	 END;
14:33:53 1108  
14:33:53 1109  	 -- Check that second offer chain exists
14:33:53 1110  	 BEGIN
14:33:53 1111  	   SELECT
14:33:53 1112  	     OFFER_CHAIN.ID into temp_offer_chain_id
14:33:53 1113  	   FROM
14:33:53 1114  	     OFFER_CHAIN
14:33:53 1115  	   WHERE
14:33:53 1116  	     OFFER_CHAIN.ID = in_offer_chain_2;
14:33:53 1117  	   EXCEPTION
14:33:53 1118  	     WHEN NO_DATA_FOUND THEN
14:33:53 1119  	       RAISE BAD_SECOND_OFFER_CHAIN;
14:33:53 1120  	 END;
14:33:53 1121  
14:33:53 1122  	 PROCS_OFFER_CHAIN_V22.GET_OFF_CHAINS_SAME_PRODUCTS(
14:33:53 1123  	   in_offer_chain_1 => in_offer_chain_1,
14:33:53 1124  	   in_offer_chain_2 => in_offer_chain_2,
14:33:53 1125  	   out_result_set   => var_same_products
14:33:53 1126  	 );
14:33:53 1127  
14:33:53 1128  	 LOOP
14:33:53 1129  	   FETCH var_same_products INTO var_same_product_id, same_product_count;
14:33:53 1130  	   EXIT WHEN var_same_products%NOTFOUND;
14:33:53 1131  
14:33:53 1132  	   IF in_use_eligibility_rules = GLOBAL_CONSTANTS_V22.FALSE THEN
14:33:53 1133  	     -- Return false because this offer chains having same products
14:33:53 1134  	     RETURN GLOBAL_CONSTANTS_V22.TRUE;
14:33:53 1135  	   ELSE
14:33:53 1136  
14:33:53 1137  	     -- Get eligibility rule for given product
14:33:53 1138  	     BEGIN
14:33:53 1139  	       SELECT
14:33:53 1140  		 PRODUCT_ELIGIBILITY.VALUE into s_product_eligibility_limit
14:33:53 1141  	       FROM
14:33:53 1142  		 PRODUCT_ELIGIBILITY
14:33:53 1143  	       WHERE
14:33:53 1144  		 PRODUCT_ELIGIBILITY.PRODUCT_ID = var_same_product_id
14:33:53 1145  		 AND PRODUCT_ELIGIBILITY.NAME = PRODUCT_ELIGIBILITY_NAME;
14:33:53 1146  
14:33:53 1147  	       -- REVU: What should to be here? 1?
14:33:53 1148  	       EXCEPTION
14:33:53 1149  		 WHEN NO_DATA_FOUND THEN
14:33:53 1150  		   s_product_eligibility_limit := '1';
14:33:53 1151  	     END;
14:33:53 1152  
14:33:53 1153  	     IF UPPER(s_product_eligibility_limit) = GLOBAL_CONSTANTS_V22.MAX_CONSURRENT_PRD_UNLIM THEN
14:33:53 1154  	       RETURN GLOBAL_CONSTANTS_V22.FALSE;
14:33:53 1155  	     END IF;
14:33:53 1156  
14:33:53 1157  	     var_product_eligibility_limit := TO_NUMBER(s_product_eligibility_limit);
14:33:53 1158  
14:33:53 1159  	     -- Check for limit
14:33:53 1160  	     IF var_product_eligibility_limit < same_product_count THEN
14:33:53 1161  	       RETURN GLOBAL_CONSTANTS_V22.TRUE;
14:33:53 1162  	     END IF;
14:33:53 1163  
14:33:53 1164  	   END IF;
14:33:53 1165  	 END LOOP;
14:33:53 1166  
14:33:53 1167  	 RETURN GLOBAL_CONSTANTS_V22.FALSE;
14:33:53 1168  
14:33:53 1169  EXCEPTION
14:33:53 1170  WHEN BAD_FIRST_OFFER_CHAIN THEN
14:33:53 1171  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1172  	   SPROC_NAME, 'First offer chain not found');
14:33:53 1173  WHEN BAD_SECOND_OFFER_CHAIN THEN
14:33:53 1174  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1175  	   SPROC_NAME, 'Second offer chain not found');
14:33:53 1176  WHEN OTHERS THEN
14:33:53 1177  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1178  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1179  END CHECK_FOR_SAME_PRODUCTS;
14:33:53 1180  
14:33:53 1181  FUNCTION IS_OFFER_CHAIN_CANCELABLE (
14:33:53 1182  	 in_offer_chain_id IN NUMBER
14:33:53 1183  ) RETURN NUMBER AS
14:33:53 1184  SPROC_NAME CONSTANT VARCHAR2(25) := 'IS_OFFER_CHAIN_CANCELABLE';
14:33:53 1185  -- VARIABLES
14:33:53 1186  var_is_cancelable_str VARCHAR2(1);
14:33:53 1187  var_is_cancelable     NUMBER;
14:33:53 1188  BEGIN
14:33:53 1189  
14:33:53 1190  	 BEGIN
14:33:53 1191  	   SELECT
14:33:53 1192  	     VALUE INTO var_is_cancelable_str
14:33:53 1193  	   FROM (
14:33:53 1194  	     SELECT
14:33:53 1195  	       VALUE, NAME
14:33:53 1196  	     FROM
14:33:53 1197  	       OFFER_CHAIN_META_DATA
14:33:53 1198  	     WHERE
14:33:53 1199  	       OFFER_CHAIN_ID = in_offer_chain_id
14:33:53 1200  	     )
14:33:53 1201  	   WHERE
14:33:53 1202  	     UPPER(NAME) = 'CANCELABLE';
14:33:53 1203  	   var_is_cancelable := TO_NUMBER(var_is_cancelable_str);
14:33:53 1204  	   EXCEPTION
14:33:53 1205  	     WHEN NO_DATA_FOUND THEN
14:33:53 1206  	       var_is_cancelable := GLOBAL_CONSTANTS_V22.FALSE;
14:33:53 1207  	 END;
14:33:53 1208  
14:33:53 1209  	 IF var_is_cancelable = GLOBAL_CONSTANTS_V22.FALSE THEN
14:33:53 1210  	   RETURN GLOBAL_CONSTANTS_V22.FALSE;
14:33:53 1211  	 END IF;
14:33:53 1212  
14:33:53 1213  	 RETURN GLOBAL_CONSTANTS_V22.TRUE;
14:33:53 1214  
14:33:53 1215  EXCEPTION
14:33:53 1216  WHEN OTHERS THEN
14:33:53 1217  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1218  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1219  END IS_OFFER_CHAIN_CANCELABLE;
14:33:53 1220  
14:33:53 1221  FUNCTION GET_OFFER_CHAIN_MAX_CONC_SUBSC (
14:33:53 1222  	 in_offer_chain_id IN NUMBER
14:33:53 1223  ) RETURN NUMBER AS
14:33:53 1224  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_OFFER_CHAIN_MAX_CONC_SUBSC';
14:33:53 1225  -- VARIABLES
14:33:53 1226  var_max_concurrent_subs_str VARCHAR2(100);
14:33:53 1227  var_max_concurrent_subs	   NUMBER;
14:33:53 1228  BEGIN
14:33:53 1229  
14:33:53 1230  	 BEGIN
14:33:53 1231  	   SELECT
14:33:53 1232  	     VALUE into var_max_concurrent_subs_str
14:33:53 1233  	   FROM
14:33:53 1234  	     (
14:33:53 1235  	       SELECT
14:33:53 1236  		 NAME,
14:33:53 1237  		 VALUE
14:33:53 1238  	       FROM
14:33:53 1239  		 OFFER_CHAIN_ELIGIBILITY
14:33:53 1240  	       WHERE
14:33:53 1241  		 OFFER_CHAIN_ID = in_offer_chain_id
14:33:53 1242  	     )
14:33:53 1243  	   WHERE
14:33:53 1244  	     NAME LIKE GLOBAL_CONSTANTS_V22.MAX_CONCURRENT_SUBS;
14:33:53 1245  
14:33:53 1246  	   IF var_max_concurrent_subs_str = GLOBAL_CONSTANTS_V22.MAX_CONCURRENT_SUBS_UNLIM THEN
14:33:53 1247  	     var_max_concurrent_subs := GLOBAL_CONSTANTS_V22.INFINITY;
14:33:53 1248  	   ELSE
14:33:53 1249  	     var_max_concurrent_subs := TO_NUMBER(var_max_concurrent_subs_str);
14:33:53 1250  	   END IF;
14:33:53 1251  
14:33:53 1252  	   EXCEPTION
14:33:53 1253  	     WHEN NO_DATA_FOUND THEN
14:33:53 1254  	       var_max_concurrent_subs := 1;
14:33:53 1255  	 END;
14:33:53 1256  
14:33:53 1257  	 RETURN var_max_concurrent_subs;
14:33:53 1258  
14:33:53 1259  EXCEPTION
14:33:53 1260  WHEN OTHERS THEN
14:33:53 1261  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1262  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1263  END GET_OFFER_CHAIN_MAX_CONC_SUBSC;
14:33:53 1264  
14:33:53 1265  PROCEDURE GET_OFFER_CHAIN_ELIGIBILITY (
14:33:53 1266  	 in_offer_chain_id   IN NUMBER,
14:33:53 1267  	 in_eligibility_name IN VARCHAR2,
14:33:53 1268  	 out_result_set      OUT SYS_REFCURSOR
14:33:53 1269  ) AS
14:33:53 1270  SPROC_NAME CONSTANT VARCHAR2(27) := 'GET_OFFER_CHAIN_ELIGIBILITY';
14:33:53 1271  -- VARIABLES
14:33:53 1272  temp_offer_chain_id NUMBER;
14:33:53 1273  var_eligibility_name OFFER_CHAIN_ELIGIBILITY.NAME%TYPE;
14:33:53 1274  -- EXCEPTIONS
14:33:53 1275  BAD_OFFER_CHAIN_ID EXCEPTION;
14:33:53 1276  BEGIN
14:33:53 1277  
14:33:53 1278  	 BEGIN
14:33:53 1279  	   SELECT
14:33:53 1280  	     OFFER_CHAIN.ID into temp_offer_chain_id
14:33:53 1281  	   FROM
14:33:53 1282  	     OFFER_CHAIN
14:33:53 1283  	   WHERE
14:33:53 1284  	     OFFER_CHAIN.ID = in_offer_chain_id;
14:33:53 1285  	   EXCEPTION
14:33:53 1286  	     WHEN NO_DATA_FOUND THEN
14:33:53 1287  	       RAISE BAD_OFFER_CHAIN_ID;
14:33:53 1288  	 END;
14:33:53 1289  
14:33:53 1290  	 var_eligibility_name := UPPER(in_eligibility_name);
14:33:53 1291  
14:33:53 1292  	 OPEN out_result_set FOR
14:33:53 1293  	 SELECT
14:33:53 1294  	   OFFER_CHAIN_ELIGIBILITY.ID,
14:33:53 1295  	   OFFER_CHAIN_ELIGIBILITY.NAME,
14:33:53 1296  	   OFFER_CHAIN_ELIGIBILITY.VALUE,
14:33:53 1297  	   OFFER_CHAIN_ELIGIBILITY.OFFER_CHAIN_ID,
14:33:53 1298  	   OFFER_CHAIN_ELIGIBILITY.CREATE_DATE,
14:33:53 1299  	   OFFER_CHAIN_ELIGIBILITY.CREATED_BY
14:33:53 1300  	 FROM
14:33:53 1301  	   OFFER_CHAIN_ELIGIBILITY
14:33:53 1302  	 WHERE
14:33:53 1303  	   OFFER_CHAIN_ELIGIBILITY.OFFER_CHAIN_ID = in_offer_chain_id
14:33:53 1304  	   AND UPPER(OFFER_CHAIN_ELIGIBILITY.NAME) = var_eligibility_name;
14:33:53 1305  
14:33:53 1306  EXCEPTION
14:33:53 1307  WHEN BAD_OFFER_CHAIN_ID THEN
14:33:53 1308  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1309  	   SPROC_NAME, 'No such offer chain');
14:33:53 1310  WHEN OTHERS THEN
14:33:53 1311  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1312  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1313  END GET_OFFER_CHAIN_ELIGIBILITY;
14:33:53 1314  
14:33:53 1315  PROCEDURE GET_OFFER_CHAINS_ELIGIBILITY (
14:33:53 1316  	 in_offer_chain_ids  IN VARCHAR2,
14:33:53 1317  	 in_eligibility_name IN VARCHAR2,
14:33:53 1318  	 out_result_set      OUT SYS_REFCURSOR
14:33:53 1319  ) AS
14:33:53 1320  SPROC_NAME CONSTANT VARCHAR2(28) := 'GET_OFFER_CHAINS_ELIGIBILITY';
14:33:53 1321  -- VARIABLES
14:33:53 1322  var_eligibility_name OFFER_CHAIN_ELIGIBILITY.NAME%TYPE;
14:33:53 1323  BEGIN
14:33:53 1324  
14:33:53 1325  	 var_eligibility_name := UPPER(in_eligibility_name);
14:33:53 1326  
14:33:53 1327  	 -- TODO: Reveiw this procedure and fine a normal way to implement this feature
14:33:53 1328  
14:33:53 1329  	 open out_result_set for
14:33:53 1330  	 'SELECT
14:33:53 1331  	   ID,
14:33:53 1332  	   NAME,
14:33:53 1333  	   VALUE,
14:33:53 1334  	   OFFER_CHAIN_ID,
14:33:53 1335  	   CREATE_DATE,
14:33:53 1336  	   CREATED_BY
14:33:53 1337  	 FROM
14:33:53 1338  	   OFFER_CHAIN_ELIGIBILITY
14:33:53 1339  	 WHERE
14:33:53 1340  	   OFFER_CHAIN_ID in ( '|| in_offer_chain_ids ||' )
14:33:53 1341  	   AND UPPER(NAME) = :1'
14:33:53 1342  	 using var_eligibility_name;
14:33:53 1343  
14:33:53 1344  EXCEPTION
14:33:53 1345  WHEN OTHERS THEN
14:33:53 1346  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1347  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1348  END GET_OFFER_CHAINS_ELIGIBILITY;
14:33:53 1349  
14:33:53 1350  PROCEDURE GET_OFFER_CHAINS_META_DATA (
14:33:53 1351  	 in_offer_chain_ids IN VARCHAR2,
14:33:53 1352  	 in_meta_data_name  IN VARCHAR2,
14:33:53 1353  	 out_result_set     OUT SYS_REFCURSOR
14:33:53 1354  ) AS
14:33:53 1355  SPROC_NAME CONSTANT VARCHAR2(28) := 'GET_OFFER_CHAINS_META_DATA';
14:33:53 1356  -- VARIABLES
14:33:53 1357  var_meta_data_name  OFFER_CHAIN_META_DATA.NAME%TYPE;
14:33:53 1358  BEGIN
14:33:53 1359  
14:33:53 1360  	 var_meta_data_name := UPPER(in_meta_data_name);
14:33:53 1361  
14:33:53 1362  	 open out_result_set for
14:33:53 1363  	 'select
14:33:53 1364  	   ID,
14:33:53 1365  	   NAME,
14:33:53 1366  	   VALUE,
14:33:53 1367  	   OFFER_CHAIN_ID,
14:33:53 1368  	   CREATED_BY,
14:33:53 1369  	   CREATE_DATE
14:33:53 1370  	 from
14:33:53 1371  	   OFFER_CHAIN_META_DATA
14:33:53 1372  	 where
14:33:53 1373  	   OFFER_CHAIN_ID in ( '||in_offer_chain_ids||' )
14:33:53 1374  	   and UPPER(OFFER_CHAIN_META_DATA.NAME) = :1'
14:33:53 1375  	 using var_meta_data_name;
14:33:53 1376  
14:33:53 1377  EXCEPTION
14:33:53 1378  WHEN OTHERS THEN
14:33:53 1379  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1380  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1381  END GET_OFFER_CHAINS_META_DATA;
14:33:53 1382  
14:33:53 1383  PROCEDURE GET_OFFER_CHAIN_META_DATA (
14:33:53 1384  	 in_offer_chain_id IN NUMBER,
14:33:53 1385  	 in_meta_data_name IN VARCHAR2,
14:33:53 1386  	 out_result_set    OUT SYS_REFCURSOR
14:33:53 1387  ) AS
14:33:53 1388  SPROC_NAME CONSTANT VARCHAR2(27) := 'GET_OFFER_CHAIN_META_DATA';
14:33:53 1389  -- VARIABLES
14:33:53 1390  temp_offer_chain_id NUMBER;
14:33:53 1391  var_meta_data_name  OFFER_CHAIN_META_DATA.NAME%TYPE;
14:33:53 1392  -- EXCEPTIONS
14:33:53 1393  BAD_OFFER_CHAIN_ID EXCEPTION;
14:33:53 1394  BEGIN
14:33:53 1395  
14:33:53 1396  	 BEGIN
14:33:53 1397  	   SELECT
14:33:53 1398  	     OFFER_CHAIN.ID into temp_offer_chain_id
14:33:53 1399  	   FROM
14:33:53 1400  	     OFFER_CHAIN
14:33:53 1401  	   WHERE
14:33:53 1402  	     OFFER_CHAIN.ID = in_offer_chain_id;
14:33:53 1403  	   EXCEPTION
14:33:53 1404  	     WHEN NO_DATA_FOUND THEN
14:33:53 1405  	       RAISE BAD_OFFER_CHAIN_ID;
14:33:53 1406  	 END;
14:33:53 1407  
14:33:53 1408  	 var_meta_data_name := UPPER(in_meta_data_name);
14:33:53 1409  
14:33:53 1410  	 OPEN out_result_set FOR
14:33:53 1411  	 SELECT
14:33:53 1412  	   OFFER_CHAIN_META_DATA.ID,
14:33:53 1413  	   OFFER_CHAIN_META_DATA.NAME,
14:33:53 1414  	   OFFER_CHAIN_META_DATA.VALUE,
14:33:53 1415  	   OFFER_CHAIN_META_DATA.OFFER_CHAIN_ID,
14:33:53 1416  	   OFFER_CHAIN_META_DATA.CREATED_BY,
14:33:53 1417  	   OFFER_CHAIN_META_DATA.CREATE_DATE
14:33:53 1418  	 FROM
14:33:53 1419  	   OFFER_CHAIN_META_DATA
14:33:53 1420  	 WHERE
14:33:53 1421  	   OFFER_CHAIN_META_DATA.OFFER_CHAIN_ID = in_offer_chain_id
14:33:53 1422  	   AND UPPER(OFFER_CHAIN_META_DATA.NAME) = var_meta_data_name;
14:33:53 1423  
14:33:53 1424  EXCEPTION
14:33:53 1425  WHEN BAD_OFFER_CHAIN_ID THEN
14:33:53 1426  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1427  	   SPROC_NAME, 'No such offer chain');
14:33:53 1428  WHEN OTHERS THEN
14:33:53 1429  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1430  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1431  END GET_OFFER_CHAIN_META_DATA;
14:33:53 1432  
14:33:53 1433  PROCEDURE GET_PROD_OFFERINGS_BY_OFFER_ID (
14:33:53 1434  	 in_offer_id	IN NUMBER,
14:33:53 1435  	 out_result_set OUT SYS_REFCURSOR
14:33:53 1436  ) AS
14:33:53 1437  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_PROD_OFFERINGS_BY_OFFER_ID';
14:33:53 1438  -- VARIABLES
14:33:53 1439  temp_offer_id NUMBER;
14:33:53 1440  -- EXCEPTIONS
14:33:53 1441  BAD_OFFER_ID EXCEPTION;
14:33:53 1442  BEGIN
14:33:53 1443  
14:33:53 1444  	 BEGIN
14:33:53 1445  	   SELECT
14:33:53 1446  	     OFFER.ID into temp_offer_id
14:33:53 1447  	   FROM
14:33:53 1448  	     OFFER
14:33:53 1449  	   WHERE
14:33:53 1450  	     OFFER.ID = in_offer_id;
14:33:53 1451  	   EXCEPTION
14:33:53 1452  	     WHEN NO_DATA_FOUND THEN
14:33:53 1453  	       RAISE BAD_OFFER_ID;
14:33:53 1454  	 END;
14:33:53 1455  
14:33:53 1456  	 OPEN out_result_set FOR
14:33:53 1457  	 SELECT DISTINCT
14:33:53 1458  	   PRODUCT_OFFERING.ID,
14:33:53 1459  	   PRODUCT_OFFERING.PRODUCT_ID,
14:33:53 1460  	   PRODUCT_OFFERING.TAX_CATEGORY_ID,
14:33:53 1461  	   PRODUCT_OFFERING.UNIT_PRICE,
14:33:53 1462  	   PRODUCT_OFFERING.QUANTITY,
14:33:53 1463  	   PRODUCT_OFFERING.CREATE_DATE,
14:33:53 1464  	   PRODUCT_OFFERING.CREATED_BY,
14:33:53 1465  	   CAPABILITY.ID CAP_ID,
14:33:53 1466  	   CAPABILITY.CODE CAP_CODE,
14:33:53 1467  	   CAPABILITY.DESCRIPTION CAP_DESCRIPTION,
14:33:53 1468  	   CAPABILITY.SHAREABLE CAP_SHAREABLE
14:33:53 1469  	 FROM
14:33:53 1470  	   OFFER_PRODUCT_OFFERING
14:33:53 1471  	   INNER JOIN PRODUCT_OFFERING ON PRODUCT_OFFERING.ID = OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID
14:33:53 1472  	   INNER JOIN CAPABILITY ON PRODUCT_OFFERING.CAPABILITY_ID = CAPABILITY.ID
14:33:53 1473  	 WHERE
14:33:53 1474  	   OFFER_PRODUCT_OFFERING.OFFER_ID = in_offer_id;
14:33:53 1475  
14:33:53 1476  EXCEPTION
14:33:53 1477  WHEN BAD_OFFER_ID THEN
14:33:53 1478  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1479  	   SPROC_NAME, 'No such offer');
14:33:53 1480  WHEN OTHERS THEN
14:33:53 1481  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1482  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1483  END GET_PROD_OFFERINGS_BY_OFFER_ID;
14:33:53 1484  
14:33:53 1485  PROCEDURE GET_PRODUCT_OFFERING_META_DATA (
14:33:53 1486  	 in_product_offering_id IN NUMBER,
14:33:53 1487  	 in_meta_data_name	IN VARCHAR2 DEFAULT NULL,
14:33:53 1488  	 out_result_set 	OUT SYS_REFCURSOR
14:33:53 1489  ) AS
14:33:53 1490  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_PRODUCT_OFFERING_META_DATA';
14:33:53 1491  -- VARIABLES
14:33:53 1492  temp_product_offering_id NUMBER;
14:33:53 1493  -- EXCEPTIONS
14:33:53 1494  BAD_PRODUCT_OFFERING_ID EXCEPTION;
14:33:53 1495  BEGIN
14:33:53 1496  
14:33:53 1497  	 BEGIN
14:33:53 1498  	   SELECT
14:33:53 1499  	     PRODUCT_OFFERING.ID into temp_product_offering_id
14:33:53 1500  	   FROM
14:33:53 1501  	     PRODUCT_OFFERING
14:33:53 1502  	   WHERE
14:33:53 1503  	     PRODUCT_OFFERING.ID = in_product_offering_id;
14:33:53 1504  	   EXCEPTION
14:33:53 1505  	     WHEN NO_DATA_FOUND THEN
14:33:53 1506  	       RAISE BAD_PRODUCT_OFFERING_ID;
14:33:53 1507  	 END;
14:33:53 1508  
14:33:53 1509  	 OPEN out_result_set FOR
14:33:53 1510  	 SELECT
14:33:53 1511  	   PRODUCT_OFFERING_META_DATA.ID,
14:33:53 1512  	   PRODUCT_OFFERING_META_DATA.NAME,
14:33:53 1513  	   PRODUCT_OFFERING_META_DATA.VALUE,
14:33:53 1514  	   PRODUCT_OFFERING_META_DATA.PRODUCT_OFFERING_ID,
14:33:53 1515  	   PRODUCT_OFFERING_META_DATA.CREATE_DATE,
14:33:53 1516  	   PRODUCT_OFFERING_META_DATA.CREATED_BY
14:33:53 1517  	 FROM
14:33:53 1518  	   PRODUCT_OFFERING_META_DATA
14:33:53 1519  	 WHERE
14:33:53 1520  	   PRODUCT_OFFERING_META_DATA.PRODUCT_OFFERING_ID = in_product_offering_id
14:33:53 1521  	   AND UPPER(PRODUCT_OFFERING_META_DATA.NAME) = UPPER(NVL(in_meta_data_name, PRODUCT_OFFERING_META_DATA.NAME));
14:33:53 1522  
14:33:53 1523  EXCEPTION
14:33:53 1524  WHEN BAD_PRODUCT_OFFERING_ID THEN
14:33:53 1525  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1526  	   SPROC_NAME, 'No such product offering');
14:33:53 1527  END GET_PRODUCT_OFFERING_META_DATA;
14:33:53 1528  
14:33:53 1529  PROCEDURE GET_OFF_CHAINS_SAME_PRODUCTS (
14:33:53 1530  	 in_offer_chain_1 IN NUMBER,
14:33:53 1531  	 in_offer_chain_2 IN NUMBER,
14:33:53 1532  	 out_result_set   OUT SYS_REFCURSOR
14:33:53 1533  ) AS
14:33:53 1534  BEGIN
14:33:53 1535  
14:33:53 1536  	 OPEN out_result_set FOR
14:33:53 1537  	 SELECT
14:33:53 1538  	   PRODUCT_ID_IN_OFFER_CH_1 AS "PRODUCT_ID",
14:33:53 1539  	   COUNT_1 + COUNT_2	    AS "COUNT"
14:33:53 1540  	 FROM
14:33:53 1541  	   (
14:33:53 1542  	     SELECT
14:33:53 1543  	       PRODUCT_OFFERING.PRODUCT_ID as "PRODUCT_ID_IN_OFFER_CH_1",
14:33:53 1544  	       COUNT(*) 		   as "COUNT_1"
14:33:53 1545  	     FROM
14:33:53 1546  	       (
14:33:53 1547  		 SELECT OFFER_ID as "OFFER_OFFER_CHAIN_OFFER_ID" FROM OFFER_OFFER_CHAIN WHERE OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_1
14:33:53 1548  	       )
14:33:53 1549  	       INNER JOIN OFFER_PRODUCT_OFFERING ON OFFER_OFFER_CHAIN_OFFER_ID = OFFER_PRODUCT_OFFERING.OFFER_ID
14:33:53 1550  	       INNER JOIN PRODUCT_OFFERING ON OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = PRODUCT_OFFERING.ID
14:33:53 1551  	     GROUP BY
14:33:53 1552  	       PRODUCT_OFFERING.PRODUCT_ID
14:33:53 1553  	   )
14:33:53 1554  	   INNER JOIN
14:33:53 1555  	   (
14:33:53 1556  	     SELECT
14:33:53 1557  	       PRODUCT_OFFERING.PRODUCT_ID as "PRODUCT_ID_IN_OFFER_CH_2",
14:33:53 1558  	       COUNT(*) 		   as "COUNT_2"
14:33:53 1559  	     FROM
14:33:53 1560  	       (
14:33:53 1561  		 SELECT OFFER_ID as "OFFER_OFFER_CHAIN_OFFER_ID" FROM OFFER_OFFER_CHAIN WHERE OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_2
14:33:53 1562  	       )
14:33:53 1563  	       INNER JOIN OFFER_PRODUCT_OFFERING ON OFFER_OFFER_CHAIN_OFFER_ID = OFFER_PRODUCT_OFFERING.OFFER_ID
14:33:53 1564  	       INNER JOIN PRODUCT_OFFERING ON OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = PRODUCT_OFFERING.ID
14:33:53 1565  	     GROUP BY
14:33:53 1566  	       PRODUCT_OFFERING.PRODUCT_ID
14:33:53 1567  	   ) ON PRODUCT_ID_IN_OFFER_CH_1 = PRODUCT_ID_IN_OFFER_CH_2;
14:33:53 1568  
14:33:53 1569  END GET_OFF_CHAINS_SAME_PRODUCTS;
14:33:53 1570  
14:33:53 1571  PROCEDURE GET_OFFER_CHAIN_MD_VALUE (
14:33:53 1572  	 in_offer_chain_id IN NUMBER,
14:33:53 1573  	 in_meta_data_name IN VARCHAR2,
14:33:53 1574  	 out_value	   OUT VARCHAR2
14:33:53 1575  ) AS
14:33:53 1576  BEGIN
14:33:53 1577  	 BEGIN
14:33:53 1578  	   SELECT
14:33:53 1579  	     OFFER_CHAIN_META_DATA.VALUE into out_value
14:33:53 1580  	   FROM
14:33:53 1581  	     OFFER_CHAIN_META_DATA
14:33:53 1582  	   WHERE
14:33:53 1583  	     OFFER_CHAIN_META_DATA.OFFER_CHAIN_ID = in_offer_chain_id
14:33:53 1584  	     AND UPPER(OFFER_CHAIN_META_DATA.NAME) = UPPER(in_meta_data_name);
14:33:53 1585  
14:33:53 1586  	   EXCEPTION
14:33:53 1587  	     WHEN NO_DATA_FOUND THEN
14:33:53 1588  	       out_value := NULL;
14:33:53 1589  	 END;
14:33:53 1590  END GET_OFFER_CHAIN_MD_VALUE;
14:33:53 1591  
14:33:53 1592  PROCEDURE GET_OFFER_CHAIN_EL_VALUE (
14:33:53 1593  	 in_offer_chain_id   IN NUMBER,
14:33:53 1594  	 in_eligibility_name IN VARCHAR2,
14:33:53 1595  	 out_value	     OUT VARCHAR2
14:33:53 1596  ) AS
14:33:53 1597  BEGIN
14:33:53 1598  	 BEGIN
14:33:53 1599  	   SELECT
14:33:53 1600  	     OFFER_CHAIN_ELIGIBILITY.VALUE into out_value
14:33:53 1601  	   FROM
14:33:53 1602  	     OFFER_CHAIN_ELIGIBILITY
14:33:53 1603  	   WHERE
14:33:53 1604  	     OFFER_CHAIN_ELIGIBILITY.OFFER_CHAIN_ID = in_offer_chain_id
14:33:53 1605  	     AND UPPER(OFFER_CHAIN_ELIGIBILITY.NAME) = UPPER(in_eligibility_name);
14:33:53 1606  
14:33:53 1607  	   EXCEPTION
14:33:53 1608  	     WHEN NO_DATA_FOUND THEN
14:33:53 1609  	       out_value := NULL;
14:33:53 1610  	 END;
14:33:53 1611  END GET_OFFER_CHAIN_EL_VALUE;
14:33:53 1612  
14:33:53 1613  PROCEDURE GET_OFFER_PRODUCT_OFFERINGS (
14:33:53 1614  	 in_offer_id	IN NUMBER,
14:33:53 1615  	 out_result_set OUT SYS_REFCURSOR
14:33:53 1616  ) AS
14:33:53 1617  SPROC_NAME CONSTANT VARCHAR2(27) := 'GET_OFFER_PRODUCT_OFFERINGS';
14:33:53 1618  -- VARIABLES
14:33:53 1619  temp_offer_id NUMBER;
14:33:53 1620  -- EXCEPTIONS
14:33:53 1621  BAD_OFFER_ID EXCEPTION;
14:33:53 1622  BEGIN
14:33:53 1623  
14:33:53 1624  	 BEGIN
14:33:53 1625  	   SELECT
14:33:53 1626  	     OFFER.ID into temp_offer_id
14:33:53 1627  	   FROM
14:33:53 1628  	     OFFER
14:33:53 1629  	   WHERE
14:33:53 1630  	     OFFER.ID = in_offer_id;
14:33:53 1631  	   EXCEPTION
14:33:53 1632  	     WHEN NO_DATA_FOUND THEN
14:33:53 1633  	       RAISE BAD_OFFER_ID;
14:33:53 1634  	 END;
14:33:53 1635  
14:33:53 1636  	 OPEN out_result_set FOR
14:33:53 1637  	 SELECT
14:33:53 1638  	   PRODUCT_OFFERING.ID,
14:33:53 1639  	   PRODUCT_OFFERING.PRODUCT_ID,
14:33:53 1640  	   PRODUCT_OFFERING.TAX_CATEGORY_ID,
14:33:53 1641  	   PRODUCT_OFFERING.UNIT_PRICE,
14:33:53 1642  	   PRODUCT_OFFERING.QUANTITY,
14:33:53 1643  	   PRODUCT_OFFERING.CREATE_DATE,
14:33:53 1644  	   PRODUCT_OFFERING.CREATED_BY,
14:33:53 1645  	   PRODUCT_OFFERING.TAX_POLICY_TYPE_ID
14:33:53 1646  	 FROM
14:33:53 1647  	   PRODUCT_OFFERING
14:33:53 1648  	   INNER JOIN OFFER_PRODUCT_OFFERING ON PRODUCT_OFFERING.ID = OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID
14:33:53 1649  	 WHERE
14:33:53 1650  	   OFFER_PRODUCT_OFFERING.OFFER_ID = in_offer_id;
14:33:53 1651  
14:33:53 1652  EXCEPTION
14:33:53 1653  WHEN BAD_OFFER_ID THEN
14:33:53 1654  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1655  	   SPROC_NAME, 'No such offer');
14:33:53 1656  WHEN OTHERS THEN
14:33:53 1657  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1658  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1659  END GET_OFFER_PRODUCT_OFFERINGS;
14:33:53 1660  
14:33:53 1661  PROCEDURE GET_OFFER_CHAINS_BY_META_DATA (
14:33:53 1662  	 in_meta_data_name  IN VARCHAR2,
14:33:53 1663  	 in_meta_data_value IN VARCHAR2,
14:33:53 1664  	 out_result_set     OUT SYS_REFCURSOR
14:33:53 1665  ) AS
14:33:53 1666  SPROC_NAME CONSTANT VARCHAR2(29) := 'GET_OFFER_CHAINS_BY_META_DATA';
14:33:53 1667  -- VARIABLES
14:33:53 1668  v_meta_data_name  CONSTANT OFFER_CHAIN_META_DATA.NAME%TYPE  := UPPER(in_meta_data_name);
14:33:53 1669  v_meta_data_value CONSTANT OFFER_CHAIN_META_DATA.VALUE%TYPE := UPPER(in_meta_data_value);
14:33:53 1670  BEGIN
14:33:53 1671  
14:33:53 1672  	 OPEN out_result_set FOR
14:33:53 1673  	 SELECT
14:33:53 1674  	   och.ID,
14:33:53 1675  	   och.NAME,
14:33:53 1676  	   och.DESCRIPTION,
14:33:53 1677  	   och.OFFER_CHAIN_STATUS_ID,
14:33:53 1678  	   PROCS_OFFER_CHAIN_V22.CALCULATE_OFFER_CHAIN_AMOUNT(och.id) as amount,
14:33:53 1679  	   och.ADOPTABILITY_WINDOW_START_DATE,
14:33:53 1680  	   och.ADOPTABILITY_WINDOW_END_DATE,
14:33:53 1681  	   PROCS_OFFER_CHAIN_V22.IS_OFFER_CHAIN_CANCELABLE(och.id) as is_cancelable,
14:33:53 1682  	   och.IS_GIFT_CERTIFICATE,
14:33:53 1683  	   'false' as comf_offer_chain, -- TODO
14:33:53 1684  	   po.PRODUCT_ID,
14:33:53 1685  	   och.GROUP_ACCOUNT_TYPE_ID
14:33:53 1686  	 FROM
14:33:53 1687  	   OFFER_CHAIN och,
14:33:53 1688  	   OFFER_OFFER_CHAIN ooch,
14:33:53 1689  	   OFFER_PRODUCT_OFFERING opo,
14:33:53 1690  	   PRODUCT_OFFERING po
14:33:53 1691  	 WHERE
14:33:53 1692  	   och.ID = ooch.OFFER_CHAIN_ID
14:33:53 1693  	   and ooch.OFFER_ID = opo.OFFER_ID
14:33:53 1694  	   and opo.PRODUCT_OFFERING_ID = po.ID
14:33:53 1695  	   and och.OFFER_CHAIN_STATUS_ID = GLOBAL_STATUSES_V22.OFFER_CHAIN_ACTIVE
14:33:53 1696  	   and och.id in (
14:33:53 1697  	     SELECT DISTINCT
14:33:53 1698  	       och2.id
14:33:53 1699  	     from
14:33:53 1700  	       offer_chain och2
14:33:53 1701  	       inner join offer_chain_meta_data ochmd on och2.id = ochmd.offer_chain_id
14:33:53 1702  	     where
14:33:53 1703  	       UPPER(ochmd.name) = v_meta_data_name
14:33:53 1704  	       AND UPPER(ochmd.value) = v_meta_data_value
14:33:53 1705  	   );
14:33:53 1706  
14:33:53 1707  EXCEPTION
14:33:53 1708  WHEN OTHERS THEN
14:33:53 1709  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1710  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1711  END GET_OFFER_CHAINS_BY_META_DATA;
14:33:53 1712  
14:33:53 1713  PROCEDURE GET_ALL_META_DATA (
14:33:53 1714  	 in_offer_chain_id IN NUMBER,
14:33:53 1715  	 out_result_set    OUT SYS_REFCURSOR
14:33:53 1716  ) AS
14:33:53 1717  SPROC_NAME CONSTANT VARCHAR2(17) := 'GET_ALL_META_DATA';
14:33:53 1718  -- Variables
14:33:53 1719  temp_offer_chain_id NUMBER;
14:33:53 1720  -- Exceptions
14:33:53 1721  BAD_OFFER_CHAIN_ID EXCEPTION;
14:33:53 1722  BEGIN
14:33:53 1723  
14:33:53 1724  	 BEGIN
14:33:53 1725  	   SELECT
14:33:53 1726  	     OCH.ID into temp_offer_chain_id
14:33:53 1727  	   FROM
14:33:53 1728  	     OFFER_CHAIN OCH
14:33:53 1729  	   WHERE
14:33:53 1730  	     OCH.ID = in_offer_chain_id;
14:33:53 1731  	   EXCEPTION
14:33:53 1732  	     WHEN NO_DATA_FOUND THEN
14:33:53 1733  	       RAISE BAD_OFFER_CHAIN_ID;
14:33:53 1734  	 END;
14:33:53 1735  
14:33:53 1736  	 OPEN out_result_set FOR
14:33:53 1737  	 SELECT
14:33:53 1738  	   OCHMD.ID,
14:33:53 1739  	   OCHMD.OFFER_CHAIN_ID,
14:33:53 1740  	   OCHMD.NAME,
14:33:53 1741  	   OCHMD.VALUE,
14:33:53 1742  	   OCHMD.CREATE_DATE,
14:33:53 1743  	   OCHMD.CREATED_BY
14:33:53 1744  	 FROM
14:33:53 1745  	   OFFER_CHAIN_META_DATA OCHMD
14:33:53 1746  	 WHERE
14:33:53 1747  	   OCHMD.OFFER_CHAIN_ID = in_offer_chain_id;
14:33:53 1748  
14:33:53 1749  EXCEPTION
14:33:53 1750  WHEN BAD_OFFER_CHAIN_ID THEN
14:33:53 1751  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1752  	   SPROC_NAME, 'No such offer chain', SQLERRM);
14:33:53 1753  WHEN OTHERS THEN
14:33:53 1754  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1755  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1756  END GET_ALL_META_DATA;
14:33:53 1757  
14:33:53 1758  PROCEDURE CHECK_PRODUCT_ELIGIBILITY (
14:33:53 1759  	 in_group_id	   IN NUMBER,
14:33:53 1760  	 in_offer_chain_id IN NUMBER,
14:33:53 1761  	 out_is_eligible   OUT NUMBER,
14:33:53 1762  	 out_concurrent_subscription_id OUT NUMBER
14:33:53 1763  ) AS
14:33:53 1764  SPROC_NAME CONSTANT VARCHAR2(25) := 'CHECK_PRODUCT_ELIGIBILITY';
14:33:53 1765  -- Variables
14:33:53 1766  var_account_id  NUMBER;
14:33:53 1767  var_is_eligible NUMBER;
14:33:53 1768  var_is_gc       NUMBER;
14:33:53 1769  -- Exceptions
14:33:53 1770  BAD_GROUP_ID		   EXCEPTION;
14:33:53 1771  CAN_NOT_CHECK_SAME_PRODUCTS EXCEPTION;
14:33:53 1772  BAD_OC_ID		   EXCEPTION;
14:33:53 1773  EXCEPTION_MESSAGE	   VARCHAR(1024);
14:33:53 1774  BEGIN
14:33:53 1775  
14:33:53 1776  	 var_is_eligible := GLOBAL_CONSTANTS_V22.TRUE;
14:33:53 1777  
14:33:53 1778  	 out_concurrent_subscription_id := NULL;
14:33:53 1779  
14:33:53 1780  	 BEGIN
14:33:53 1781  	   SELECT
14:33:53 1782  	     OC.IS_GIFT_CERTIFICATE into var_is_gc
14:33:53 1783  	   FROM
14:33:53 1784  	     OFFER_CHAIN OC
14:33:53 1785  	   WHERE
14:33:53 1786  	     OC.ID = in_offer_chain_id;
14:33:53 1787  	   EXCEPTION
14:33:53 1788  	     WHEN NO_DATA_FOUND THEN
14:33:53 1789  	       RAISE BAD_OC_ID;
14:33:53 1790  	 END;
14:33:53 1791  
14:33:53 1792  	 -- only check eligibility if this is not a gift certificate
14:33:53 1793  	 IF (var_is_gc IS NULL OR var_is_gc != 1) THEN
14:33:53 1794  	   BEGIN
14:33:53 1795  	     SELECT
14:33:53 1796  	       A.ID into var_account_id
14:33:53 1797  	     FROM
14:33:53 1798  	       ACCOUNT A
14:33:53 1799  	     WHERE
14:33:53 1800  	       A.GROUP_ID = in_group_id;
14:33:53 1801  	     EXCEPTION
14:33:53 1802  	       WHEN NO_DATA_FOUND THEN
14:33:53 1803  		 RAISE BAD_GROUP_ID;
14:33:53 1804  	   END;
14:33:53 1805  
14:33:53 1806  
14:33:53 1807  	   FOR f_offer_chain IN (
14:33:53 1808  	       SELECT
14:33:53 1809  		 S.ID as SUBSCRIPTION_ID,
14:33:53 1810  		 S.OFFER_CHAIN_ID
14:33:53 1811  	       FROM
14:33:53 1812  		 SUBSCRIPTION S
14:33:53 1813  	       WHERE
14:33:53 1814  		 S.ACCOUNT_ID = var_account_id
14:33:53 1815  		 AND (S.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE
14:33:53 1816  		      OR S.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_IN_GRACE_PERIOD)
14:33:53 1817  	   )
14:33:53 1818  	   LOOP
14:33:53 1819  	     BEGIN
14:33:53 1820  	       IF (
14:33:53 1821  		 PROCS_OFFER_CHAIN_V22.CHECK_FOR_SAME_PRODUCTS(
14:33:53 1822  		   in_offer_chain_id,
14:33:53 1823  		   f_offer_chain.offer_chain_id,
14:33:53 1824  		   GLOBAL_CONSTANTS_V22.TRUE
14:33:53 1825  		 ) = GLOBAL_CONSTANTS_V22.TRUE
14:33:53 1826  	       ) THEN
14:33:53 1827  		 var_is_eligible := GLOBAL_CONSTANTS_V22.FALSE;
14:33:53 1828  		 out_concurrent_subscription_id := f_offer_chain.SUBSCRIPTION_ID;
14:33:53 1829  	       END IF;
14:33:53 1830  	       EXCEPTION
14:33:53 1831  		 WHEN OTHERS THEN
14:33:53 1832  		   EXCEPTION_MESSAGE := SQLERRM;
14:33:53 1833  		   RAISE CAN_NOT_CHECK_SAME_PRODUCTS;
14:33:53 1834  	     END;
14:33:53 1835  	   END LOOP;
14:33:53 1836  	 END IF;
14:33:53 1837  	 out_is_eligible := var_is_eligible;
14:33:53 1838  
14:33:53 1839  EXCEPTION
14:33:53 1840  WHEN BAD_GROUP_ID THEN
14:33:53 1841  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1842  	   SPROC_NAME, 'No such offer chain', SQLERRM);
14:33:53 1843  WHEN BAD_OC_ID THEN
14:33:53 1844  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1845  	   SPROC_NAME, 'No such offer chain', SQLERRM);
14:33:53 1846  WHEN CAN_NOT_CHECK_SAME_PRODUCTS THEN
14:33:53 1847  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 1848  	   SPROC_NAME, 'Could not check offers for same products', EXCEPTION_MESSAGE);
14:33:53 1849  WHEN OTHERS THEN
14:33:53 1850  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1851  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1852  END CHECK_PRODUCT_ELIGIBILITY;
14:33:53 1853  
14:33:53 1854  PROCEDURE GET_NOTIFICATION_TYPE_ID (
14:33:53 1855  	 in_offer_chain_id	  IN NUMBER,
14:33:53 1856  	 in_action_name 	  IN VARCHAR2,
14:33:53 1857  	 out_notification_type_id OUT NUMBER
14:33:53 1858  ) AS
14:33:53 1859  SPROC_NAME CONSTANT VARCHAR2(28) := 'GET_NOTIFICATION_TEMPLATE_ID';
14:33:53 1860  -- Variables
14:33:53 1861  var_action_id NUMBER;
14:33:53 1862  -- Exceptions
14:33:53 1863  BAD_ACTION_NAME	      EXCEPTION;
14:33:53 1864  MULTIPLY_ACTIONS_FOUND EXCEPTION;
14:33:53 1865  BEGIN
14:33:53 1866  
14:33:53 1867  	 BEGIN
14:33:53 1868  	   SELECT
14:33:53 1869  	     A.ID into var_action_id
14:33:53 1870  	   FROM
14:33:53 1871  	     ACTION A
14:33:53 1872  	   WHERE
14:33:53 1873  	     UPPER(A.NAME) = UPPER(in_action_name);
14:33:53 1874  	   EXCEPTION
14:33:53 1875  	     WHEN NO_DATA_FOUND THEN
14:33:53 1876  	       RAISE BAD_ACTION_NAME;
14:33:53 1877  	     WHEN TOO_MANY_ROWS THEN
14:33:53 1878  	       RAISE MULTIPLY_ACTIONS_FOUND;
14:33:53 1879  	 END;
14:33:53 1880  
14:33:53 1881  	 SELECT
14:33:53 1882  	   OCNT.NOTIFICATION_TYPE_ID into out_notification_type_id
14:33:53 1883  	 FROM
14:33:53 1884  	   OFFER_CHAIN_NOTIFICATION_TYPE OCNT
14:33:53 1885  	 WHERE
14:33:53 1886  	   OCNT.OFFER_CHAIN_ID = in_offer_chain_id
14:33:53 1887  	   AND OCNT.ACTION_ID = var_action_id;
14:33:53 1888  
14:33:53 1889  EXCEPTION
14:33:53 1890  WHEN NO_DATA_FOUND THEN
14:33:53 1891  	 out_notification_type_id := NULL;
14:33:53 1892  WHEN BAD_ACTION_NAME THEN
14:33:53 1893  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:53 1894  	   SPROC_NAME, 'Bad action name', SQLERRM);
14:33:53 1895  WHEN MULTIPLY_ACTIONS_FOUND THEN
14:33:53 1896  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 1897  	   SPROC_NAME, 'Found more then one action with given name', SQLERRM);
14:33:53 1898  WHEN OTHERS THEN
14:33:53 1899  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1900  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1901  END GET_NOTIFICATION_TYPE_ID;
14:33:53 1902  
14:33:53 1903  END PROCS_OFFER_CHAIN_V22;
14:33:53 1904  .
14:33:53 SQL> /

Package body created.

Elapsed: 00:00:00.18
14:33:53 SQL> 
14:33:53 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_POLLING_SYNC"
14:33:53   2  AS
14:33:53   3  	  --------------------------------------------------------------------------------
14:33:53   4  PROCEDURE GATHER_SYNC_EVENTS
14:33:53   5  	  (
14:33:53   6  	      in_last_timestamp TIMESTAMP,
14:33:53   7  	      out_new_timestamp OUT TIMESTAMP)
14:33:53   8  IS
14:33:53   9  BEGIN
14:33:53  10  	  out_new_timestamp := systimestamp;
14:33:53  11  	  GATHER_SYNC_EVENTS_RANGE(in_last_timestamp, out_new_timestamp, (3 / 24 / 60));
14:33:53  12  END;
14:33:53  13  	  --------------------------------------------------------------------------------
14:33:53  14  PROCEDURE GATHER_SYNC_EVENTS_RANGE(in_start_ts timestamp, in_end_ts timestamp, in_offset number)
14:33:53  15  IS
14:33:53  16  BEGIN
14:33:53  17  	  INSERT
14:33:53  18  	  INTO
14:33:53  19  	      core_owner.polling_sync
14:33:53  20  	      (
14:33:53  21  		  account_id,
14:33:53  22  		  group_id,
14:33:53  23  		  event_type,
14:33:53  24  		  event_date
14:33:53  25  	      )
14:33:53  26  	  select id, group_id, event_type, event_date from (
14:33:53  27  	      SELECT
14:33:53  28  		  a.id,
14:33:53  29  		  a.group_id,
14:33:53  30  		  'I' event_type,
14:33:53  31  		  in_end_ts event_date,
14:33:53  32  		  max(cl.change_time) last_change_time
14:33:53  33  	      FROM
14:33:53  34  		  core_hist_owner.change_log cl,
14:33:53  35  		  core_owner.credit_card cc,
14:33:53  36  		  core_owner.account a
14:33:53  37  	      WHERE
14:33:53  38  		  cl.change_time between in_start_ts-in_offset and in_end_ts
14:33:53  39  	      AND cl.item = 'CREDIT_CARD'
14:33:53  40  	      AND cl.id = cc.id
14:33:53  41  	      AND cc.account_id = a.id
14:33:53  42  	      GROUP BY a.id, a.group_id
14:33:53  43  	      UNION ALL
14:33:53  44  	      SELECT
14:33:53  45  		  a.id,
14:33:53  46  		  a.group_id,
14:33:53  47  		  'I',
14:33:53  48  		  in_end_ts,
14:33:53  49  		  max(cl.change_time) last_change_time
14:33:53  50  	      FROM
14:33:53  51  		  core_hist_owner.change_log cl,
14:33:53  52  		  core_owner.paypal p,
14:33:53  53  		  core_owner.account a
14:33:53  54  	      WHERE
14:33:53  55  		  cl.change_time between in_start_ts-in_offset and in_end_ts
14:33:53  56  	      AND cl.item = 'PAYPAL'
14:33:53  57  	      AND cl.id = p.id
14:33:53  58  	      AND p.account_id = a.id
14:33:53  59  	      GROUP BY a.id, a.group_id
14:33:53  60  	      UNION ALL
14:33:53  61  	      SELECT
14:33:53  62  		  a.id,
14:33:53  63  		  a.group_id,
14:33:53  64  		  'S',
14:33:53  65  		  in_end_ts,
14:33:53  66  		  max(cl.change_time) last_change_time
14:33:53  67  	      FROM
14:33:53  68  		  core_hist_owner.change_log cl,
14:33:53  69  		  core_owner.subscription s,
14:33:53  70  		  core_owner.account a
14:33:53  71  	      WHERE
14:33:53  72  		  cl.change_time between in_start_ts-in_offset and in_end_ts
14:33:53  73  	      AND cl.item = 'SUBSCRIPTION'
14:33:53  74  	      AND cl.id = s.id
14:33:53  75  	      AND s.account_id = a.id
14:33:53  76  	      GROUP BY a.id, a.group_id
14:33:53  77  	      UNION ALL
14:33:53  78  	      SELECT
14:33:53  79  		  a.id,
14:33:53  80  		  a.group_id,
14:33:53  81  		  'G',
14:33:53  82  		  in_end_ts,
14:33:53  83  		  max(cl.change_time) last_change_time
14:33:53  84  	      FROM
14:33:53  85  		  core_hist_owner.change_log cl,
14:33:53  86  		  core_owner.gift_certificate gc,
14:33:53  87  		  core_owner.account a
14:33:53  88  	      WHERE
14:33:53  89  		  cl.change_time between in_start_ts-in_offset and in_end_ts
14:33:53  90  	      AND cl.item = 'GIFT_CERTIFICATE'
14:33:53  91  	      AND cl.id = gc.id
14:33:53  92  	      AND gc.purchaser_group_id = a.group_id
14:33:53  93  	      GROUP BY a.id, a.group_id
14:33:53  94  	  ) t
14:33:53  95  	  where not exists (
14:33:53  96  	      select 1 --ps.account_id, ps.group_id, ps.event_type
14:33:53  97  	      from polling_sync ps
14:33:53  98  	      where ps.account_id = t.id
14:33:53  99  		and ps.group_id = t.group_id
14:33:53 100  		and ps.event_type = t.event_type
14:33:53 101  		and ps.event_date >= t.last_change_time
14:33:53 102  	  )
14:33:53 103  	  ;
14:33:53 104  END;
14:33:53 105  --------------------------------------------------------------------------------
14:33:53 106  FUNCTION CREATE_NEW_TRANSFER_SET
14:33:53 107  	  (
14:33:53 108  	      in_set_maximum NUMBER)
14:33:53 109  	  RETURN core_owner.polling_sync.set_id%type
14:33:53 110  IS
14:33:53 111  	  pragma autonomous_transaction;
14:33:53 112  	  v_set_id core_owner.polling_sync.set_id%type;
14:33:53 113  BEGIN
14:33:53 114  	  SELECT
14:33:53 115  	      pollsync_setid_seq.nextval
14:33:53 116  	  INTO
14:33:53 117  	      v_set_id
14:33:53 118  	  FROM
14:33:53 119  	      dual;
14:33:53 120  	  update
14:33:53 121  	    core_owner.polling_sync ps
14:33:53 122  	  set
14:33:53 123  	    ps.set_id = v_set_id
14:33:53 124  	  where
14:33:53 125  	    ps.set_id IS NULL and
14:33:53 126  	    rownum <= in_set_maximum
14:33:53 127  	  ;
14:33:53 128  	  COMMIT;
14:33:53 129  	  RETURN v_set_id;
14:33:53 130  END;
14:33:53 131  --------------------------------------------------------------------------------
14:33:53 132  FUNCTION RETREIVE_TRANSFER_SET
14:33:53 133  	  (
14:33:53 134  	      in_set_id core_owner.polling_sync.set_id%type)
14:33:53 135  	  RETURN sys_refcursor
14:33:53 136  IS
14:33:53 137  	  v_refcursor sys_refcursor;
14:33:53 138  BEGIN
14:33:53 139  	  UPDATE
14:33:53 140  	      core_owner.polling_sync ps
14:33:53 141  	  SET
14:33:53 142  	      ps.last_send_date = sysdate,
14:33:53 143  	      ps.num_calls = ps.num_calls + 1
14:33:53 144  	  WHERE
14:33:53 145  	      ps.set_id = in_set_id ;
14:33:53 146  	  OPEN v_refcursor FOR
14:33:53 147  	  SELECT
14:33:53 148  	      ps.set_id,
14:33:53 149  	      ps.group_id,
14:33:53 150  	      ps.event_type,
14:33:53 151  	      ps.event_date
14:33:53 152  	  FROM
14:33:53 153  	      core_owner.polling_sync ps
14:33:53 154  	  WHERE
14:33:53 155  	      ps.set_id = in_set_id
14:33:53 156  	  AND ps.group_id IS NOT NULL ;
14:33:53 157  	  RETURN v_refcursor;
14:33:53 158  END;
14:33:53 159  --------------------------------------------------------------------------------
14:33:53 160  PROCEDURE GET_TRANSFER_SET
14:33:53 161  	  (
14:33:53 162  	      in_set_maximum NUMBER,
14:33:53 163  	      in_max_retries NUMBER,
14:33:53 164  	      out_refcursor OUT sys_refcursor)
14:33:53 165  IS
14:33:53 166  	  v_set_id core_owner.polling_sync.set_id%type;
14:33:53 167  BEGIN
14:33:53 168  	  /* Look for previously sent but unconfirmed sets and
14:33:53 169  	  send again until max_retries calls */
14:33:53 170  	  FOR x IN
14:33:53 171  	  (
14:33:53 172  	      SELECT
14:33:53 173  		  ps.set_id,
14:33:53 174  		  COUNT( *) set_size
14:33:53 175  	      FROM
14:33:53 176  		  core_owner.polling_sync ps
14:33:53 177  	      WHERE
14:33:53 178  		  ps.event_date > sysdate - 14
14:33:53 179  	      AND ps.confirm_date IS NULL
14:33:53 180  	      AND ps.last_send_date IS NOT NULL
14:33:53 181  	      AND ps.num_calls < in_max_retries
14:33:53 182  	      GROUP BY
14:33:53 183  		  ps.set_id
14:33:53 184  	      ORDER BY
14:33:53 185  		  ps.set_id
14:33:53 186  	  )
14:33:53 187  	  LOOP
14:33:53 188  	      out_refcursor := Retreive_Transfer_Set(x.set_id) ;
14:33:53 189  	      RETURN;
14:33:53 190  	  END LOOP;
14:33:53 191  	  v_set_id := Create_New_Transfer_Set(in_set_maximum) ;
14:33:53 192  	  out_refcursor := Retreive_Transfer_Set(v_set_id) ;
14:33:53 193  	  RETURN;
14:33:53 194  END;
14:33:53 195  --------------------------------------------------------------------------------
14:33:53 196  PROCEDURE CONFIRM_TRANSFER_SET
14:33:53 197  	  (
14:33:53 198  	      in_set_id core_owner.polling_sync.set_id%type)
14:33:53 199  IS
14:33:53 200  	  v_unconfirmable EXCEPTION;
14:33:53 201  BEGIN
14:33:53 202  	  UPDATE
14:33:53 203  	      core_owner.polling_sync ps
14:33:53 204  	  SET
14:33:53 205  	      ps.confirm_date = systimestamp
14:33:53 206  	  WHERE
14:33:53 207  	      ps.set_id = in_set_id
14:33:53 208  	  AND ps.confirm_date IS NULL ;
14:33:53 209  	  IF(sql%rowcount < 1) THEN
14:33:53 210  	      raise v_unconfirmable;
14:33:53 211  	  END IF;
14:33:53 212  END;
14:33:53 213  PROCEDURE SET_LAST_RUN(ts in timestamp)
14:33:53 214  IS
14:33:53 215  BEGIN
14:33:53 216  	  UPDATE POLLING_SYNC_LASTRUN
14:33:53 217  	  SET last_run = current_timestamp;
14:33:53 218  	  IF ( sql%rowcount = 0 )
14:33:53 219  	  THEN
14:33:53 220  	    INSERT INTO POLLING_SYNC_LASTRUN VALUES (ts);
14:33:53 221  	  END if;
14:33:53 222  	  COMMIT;
14:33:53 223  END;
14:33:53 224  PROCEDURE GET_LAST_RUN(ts out timestamp)
14:33:53 225  IS
14:33:53 226  BEGIN
14:33:53 227  	  SELECT LAST_RUN INTO ts
14:33:53 228  	  FROM POLLING_SYNC_LASTRUN
14:33:53 229  	  WHERE ROWNUM < 2;
14:33:53 230  EXCEPTION
14:33:53 231  	WHEN NO_DATA_FOUND
14:33:53 232  	THEN
14:33:53 233  	  ts := current_timestamp;
14:33:53 234  END;
14:33:53 235  END PROCS_POLLING_SYNC;
14:33:53 236  .
14:33:53 SQL> /

Package body created.

Elapsed: 00:00:00.05
14:33:53 SQL> 
14:33:53 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_PRODUCT_V22" AS
14:33:53   2  
14:33:53   3  PROCEDURE GET_PRODUCTS (
14:33:53   4  /*
14:33:53   5  Throws exceptions:
14:33:53   6  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53   7  */
14:33:53   8  	in_status_id   IN  NUMBER,
14:33:53   9  	out_result_set OUT SYS_REFCURSOR
14:33:53  10  ) AS
14:33:53  11  SPROC_NAME CONSTANT VARCHAR2(12) := 'GET_PRODUCTS';
14:33:53  12  BEGIN
14:33:53  13  	OPEN out_result_set FOR
14:33:53  14  	SELECT
14:33:53  15  	  PRODUCT.ID,
14:33:53  16  	  PRODUCT.NAME,
14:33:53  17  	  PRODUCT.UNIT_PRICE,
14:33:53  18  	  PRODUCT.PRODUCTION_COST,
14:33:53  19  	  PRODUCT.CREATE_DATE,
14:33:53  20  	  PRODUCT.CREATED_BY,
14:33:53  21  	  PRODUCT.PRODUCT_STATUS_ID,
14:33:53  22  	  PRODUCT.PRODUCT_URI
14:33:53  23  	FROM
14:33:53  24  	  PRODUCT
14:33:53  25   WHERE
14:33:53  26  	  PRODUCT.PRODUCT_STATUS_ID = NVL(in_status_id, PRODUCT.PRODUCT_STATUS_ID);
14:33:53  27  EXCEPTION
14:33:53  28  WHEN OTHERS THEN
14:33:53  29  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53  30  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53  31  END GET_PRODUCTS;
14:33:53  32  
14:33:53  33  /******************************************************************************/
14:33:53  34  
14:33:53  35  PROCEDURE GET_PRODUCT_OFFERING_META_DATA (
14:33:53  36  	in_product_offering_id	IN NUMBER,
14:33:53  37  	out_result_set OUT SYS_REFCURSOR
14:33:53  38  ) AS
14:33:53  39  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_PRODUCT_OFFERING_META_DATA';
14:33:53  40  -- VARIABLES
14:33:53  41  temp_product_offering_id NUMBER;
14:33:53  42  -- EXCEPTIONS
14:33:53  43  BAD_PRODUCT_OFFERING_ID EXCEPTION;
14:33:53  44  BEGIN
14:33:53  45  
14:33:53  46  	-- Check that product offering exists
14:33:53  47  	BEGIN
14:33:53  48  	  SELECT
14:33:53  49  	    PRODUCT_OFFERING.ID into temp_product_offering_id
14:33:53  50  	  FROM
14:33:53  51  	    PRODUCT_OFFERING
14:33:53  52  	  WHERE
14:33:53  53  	    PRODUCT_OFFERING.ID = in_product_offering_id;
14:33:53  54  	  EXCEPTION
14:33:53  55  	    WHEN NO_DATA_FOUND THEN
14:33:53  56  	      RAISE BAD_PRODUCT_OFFERING_ID;
14:33:53  57  	END;
14:33:53  58  
14:33:53  59  	OPEN out_result_set FOR
14:33:53  60  	SELECT
14:33:53  61  	  PRODUCT_OFFERING_META_DATA.ID,
14:33:53  62  	  PRODUCT_OFFERING_META_DATA.NAME,
14:33:53  63  	  PRODUCT_OFFERING_META_DATA.VALUE,
14:33:53  64  	  PRODUCT_OFFERING_META_DATA.CREATED_BY,
14:33:53  65  	  PRODUCT_OFFERING_META_DATA.CREATE_DATE
14:33:53  66  	FROM
14:33:53  67  	  PRODUCT_OFFERING_META_DATA
14:33:53  68  	WHERE
14:33:53  69  	  PRODUCT_OFFERING_META_DATA.PRODUCT_OFFERING_ID = in_product_offering_id;
14:33:53  70  
14:33:53  71  EXCEPTION
14:33:53  72  WHEN BAD_PRODUCT_OFFERING_ID THEN
14:33:53  73  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53  74  	  SPROC_NAME, 'No such product offering id');
14:33:53  75  WHEN OTHERS THEN
14:33:53  76  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53  77  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53  78  END GET_PRODUCT_OFFERING_META_DATA;
14:33:53  79  
14:33:53  80  /******************************************************************************/
14:33:53  81  
14:33:53  82  PROCEDURE GET_PRODUCT_ELIGIBIL_BY_NAME (
14:33:53  83  /*
14:33:53  84  Throws exceptions:
14:33:53  85  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53  86  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53  87  */
14:33:53  88  	in_product_id	    IN NUMBER,
14:33:53  89  	in_eligibility_name IN VARCHAR2 DEFAULT NULL,
14:33:53  90  	out_result_set	    OUT SYS_REFCURSOR
14:33:53  91  ) AS
14:33:53  92  SPROC_NAME CONSTANT VARCHAR2(28) := 'GET_PRODUCT_ELIGIBIL_BY_NAME';
14:33:53  93  -- VARIABLES
14:33:53  94  temp_product_id NUMBER;
14:33:53  95  -- EXCEPTIONS
14:33:53  96  BAD_PRODUCT_ID EXCEPTION;
14:33:53  97  BEGIN
14:33:53  98  
14:33:53  99  	BEGIN
14:33:53 100  	  SELECT
14:33:53 101  	    PRODUCT.ID into temp_product_id
14:33:53 102  	  FROM
14:33:53 103  	    PRODUCT
14:33:53 104  	  WHERE
14:33:53 105  	    PRODUCT.ID = in_product_id;
14:33:53 106  	  EXCEPTION
14:33:53 107  	    WHEN NO_DATA_FOUND THEN
14:33:53 108  	      RAISE BAD_PRODUCT_ID;
14:33:53 109  	END;
14:33:53 110  
14:33:53 111  	OPEN out_result_set FOR
14:33:53 112  	SELECT
14:33:53 113  	  PRODUCT_ELIGIBILITY.ID
14:33:53 114  	FROM
14:33:53 115  	  PRODUCT_ELIGIBILITY
14:33:53 116  	WHERE
14:33:53 117  	  PRODUCT_ELIGIBILITY.ID = in_product_id
14:33:53 118  	  AND UPPER(PRODUCT_ELIGIBILITY.NAME) = UPPER(NVL(in_eligibility_name, PRODUCT_ELIGIBILITY.NAME));
14:33:53 119  
14:33:53 120  EXCEPTION
14:33:53 121  WHEN BAD_PRODUCT_ID THEN
14:33:53 122  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 123  	  SPROC_NAME, 'No such product');
14:33:53 124  WHEN OTHERS THEN
14:33:53 125  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 126  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 127  END GET_PRODUCT_ELIGIBIL_BY_NAME;
14:33:53 128  
14:33:53 129  /******************************************************************************/
14:33:53 130  
14:33:53 131  PROCEDURE GET_PRODUCT_BY_ID (
14:33:53 132  	in_product_id  IN NUMBER,
14:33:53 133  	out_result_set OUT SYS_REFCURSOR
14:33:53 134  ) AS
14:33:53 135  SPROC_NAME CONSTANT VARCHAR2(17) := 'GET_PRODUCT_BY_ID';
14:33:53 136  -- VARIABLES
14:33:53 137  temp_product_id NUMBER;
14:33:53 138  -- EXCEPTIONS
14:33:53 139  BAD_PRODUCT_ID EXCEPTION;
14:33:53 140  BEGIN
14:33:53 141  
14:33:53 142  	BEGIN
14:33:53 143  	  SELECT
14:33:53 144  	    PRODUCT.ID into temp_product_id
14:33:53 145  	  FROM
14:33:53 146  	    PRODUCT
14:33:53 147  	  WHERE
14:33:53 148  	    PRODUCT.ID = in_product_id;
14:33:53 149  	  EXCEPTION
14:33:53 150  	    WHEN NO_DATA_FOUND THEN
14:33:53 151  	      RAISE BAD_PRODUCT_ID;
14:33:53 152  	END;
14:33:53 153  
14:33:53 154  	OPEN out_result_set FOR
14:33:53 155  	SELECT
14:33:53 156  	  PRODUCT.ID,
14:33:53 157  	  PRODUCT.NAME,
14:33:53 158  	  PRODUCT.PRODUCT_STATUS_ID,
14:33:53 159  	  PRODUCT.PRODUCT_URI,
14:33:53 160  	  PRODUCT.PRODUCTION_COST,
14:33:53 161  	  PRODUCT.UNIT_PRICE,
14:33:53 162  	  PRODUCT.CREATE_DATE,
14:33:53 163  	  PRODUCT.CREATED_BY
14:33:53 164  	FROM
14:33:53 165  	  PRODUCT
14:33:53 166  	WHERE
14:33:53 167  	  PRODUCT.ID = in_product_id;
14:33:53 168  
14:33:53 169  EXCEPTION
14:33:53 170  WHEN BAD_PRODUCT_ID THEN
14:33:53 171  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 172  	  SPROC_NAME, 'No such product');
14:33:53 173  WHEN OTHERS THEN
14:33:53 174  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 175  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 176  END GET_PRODUCT_BY_ID;
14:33:53 177  
14:33:53 178  /******************************************************************************/
14:33:53 179  
14:33:53 180  PROCEDURE GET_PRD_OFFERING_BY_LINE_IT_ID (
14:33:53 181  	in_line_item_id IN NUMBER,
14:33:53 182  	out_result_set	OUT SYS_REFCURSOR
14:33:53 183  ) AS
14:33:53 184  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_PRD_OFFERING_BY_LINE_IT_ID';
14:33:53 185  -- VARIABLES
14:33:53 186  temp_line_item_id NUMBER;
14:33:53 187  -- EXCEPTIONS
14:33:53 188  BAD_LINE_ITEM_ID EXCEPTION;
14:33:53 189  BEGIN
14:33:53 190  
14:33:53 191  	BEGIN
14:33:53 192  	  SELECT
14:33:53 193  	    LINE_ITEM.ID into temp_line_item_id
14:33:53 194  	  FROM
14:33:53 195  	    LINE_ITEM
14:33:53 196  	  WHERE
14:33:53 197  	    LINE_ITEM.ID = in_line_item_id;
14:33:53 198  	  EXCEPTION
14:33:53 199  	    WHEN NO_DATA_FOUND THEN
14:33:53 200  	      RAISE BAD_LINE_ITEM_ID;
14:33:53 201  	END;
14:33:53 202  
14:33:53 203  	OPEN out_result_set FOR
14:33:53 204  	SELECT
14:33:53 205  	  PRODUCT_OFFERING.ID,
14:33:53 206  	  PRODUCT_OFFERING.PRODUCT_ID,
14:33:53 207  	  PRODUCT_OFFERING.QUANTITY,
14:33:53 208  	  PRODUCT_OFFERING.UNIT_PRICE,
14:33:53 209  	  PRODUCT_OFFERING.TAX_CATEGORY_ID,
14:33:53 210  	  PRODUCT_OFFERING.CREATE_DATE,
14:33:53 211  	  PRODUCT_OFFERING.CREATED_BY,
14:33:53 212  	  PRODUCT_OFFERING.TAX_POLICY_TYPE_ID,
14:33:53 213  	  CAPABILITY.ID CAP_ID,
14:33:53 214  	  CAPABILITY.CODE CAP_CODE,
14:33:53 215  	  CAPABILITY.DESCRIPTION CAP_DESCRIPTION,
14:33:53 216  	  CAPABILITY.SHAREABLE CAP_SHAREABLE
14:33:53 217  	FROM
14:33:53 218  	  PRODUCT_OFFERING
14:33:53 219  	  INNER JOIN LINE_ITEM ON LINE_ITEM.PRODUCT_OFFER_ID = PRODUCT_OFFERING.ID
14:33:53 220  	  INNER JOIN CAPABILITY ON PRODUCT_OFFERING.CAPABILITY_ID = CAPABILITY.ID
14:33:53 221  	WHERE
14:33:53 222  	  LINE_ITEM.ID = in_line_item_id;
14:33:53 223  
14:33:53 224  EXCEPTION
14:33:53 225  WHEN BAD_LINE_ITEM_ID THEN
14:33:53 226  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 227  	  SPROC_NAME, 'No such line item');
14:33:53 228  WHEN OTHERS THEN
14:33:53 229  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 230  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 231  END GET_PRD_OFFERING_BY_LINE_IT_ID;
14:33:53 232  
14:33:53 233  /******************************************************************************/
14:33:53 234  
14:33:53 235  PROCEDURE GET_PRD_OFFERING_BY_ID (
14:33:53 236  	in_product_offering_id IN NUMBER,
14:33:53 237  	out_result_set	OUT SYS_REFCURSOR
14:33:53 238  ) AS
14:33:53 239  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_PRD_OFFERING_BY_ID';
14:33:53 240  BEGIN
14:33:53 241  	OPEN out_result_set FOR
14:33:53 242  	SELECT
14:33:53 243  	  PRODUCT_OFFERING.ID,
14:33:53 244  	  PRODUCT_OFFERING.PRODUCT_ID,
14:33:53 245  	  PRODUCT_OFFERING.QUANTITY,
14:33:53 246  	  PRODUCT_OFFERING.UNIT_PRICE,
14:33:53 247  	  PRODUCT_OFFERING.TAX_CATEGORY_ID,
14:33:53 248  	  PRODUCT_OFFERING.CREATE_DATE,
14:33:53 249  	  PRODUCT_OFFERING.CREATED_BY,
14:33:53 250  	  CAPABILITY.ID CAP_ID,
14:33:53 251  	  CAPABILITY.CODE CAP_CODE,
14:33:53 252  	  CAPABILITY.DESCRIPTION CAP_DESCRIPTION,
14:33:53 253  	  CAPABILITY.SHAREABLE CAP_SHAREABLE
14:33:53 254  	FROM
14:33:53 255  	  PRODUCT_OFFERING
14:33:53 256  	  INNER JOIN CAPABILITY ON PRODUCT_OFFERING.CAPABILITY_ID = CAPABILITY.ID
14:33:53 257  	WHERE
14:33:53 258  	  PRODUCT_OFFERING.ID = in_product_offering_id;
14:33:53 259  
14:33:53 260  EXCEPTION
14:33:53 261  WHEN OTHERS THEN
14:33:53 262  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 263  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 264  END GET_PRD_OFFERING_BY_ID;
14:33:53 265  
14:33:53 266  /******************************************************************************/
14:33:53 267  
14:33:53 268  PROCEDURE GET_PRODUCT_OFFERING_DISCOUNTS(
14:33:53 269  	in_product_offering_id IN NUMBER,
14:33:53 270  	out_result_set	       OUT SYS_REFCURSOR
14:33:53 271  ) AS
14:33:53 272  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_PRODUCT_OFFERING_DISCOUNTS';
14:33:53 273  -- VARIABLES
14:33:53 274  temp_product_offering_id NUMBER;
14:33:53 275  -- EXCEPTIONS
14:33:53 276  BAD_PRODUCT_OFFERING_ID EXCEPTION;
14:33:53 277  BEGIN
14:33:53 278  
14:33:53 279  	BEGIN
14:33:53 280  	  SELECT
14:33:53 281  	    PRODUCT_OFFERING.ID into temp_product_offering_id
14:33:53 282  	  FROM
14:33:53 283  	    PRODUCT_OFFERING
14:33:53 284  	  WHERE
14:33:53 285  	    PRODUCT_OFFERING.ID = in_product_offering_id;
14:33:53 286  	  EXCEPTION
14:33:53 287  	    WHEN NO_DATA_FOUND THEN
14:33:53 288  	      RAISE BAD_PRODUCT_OFFERING_ID;
14:33:53 289  	END;
14:33:53 290  
14:33:53 291  	OPEN out_result_set FOR
14:33:53 292  	SELECT
14:33:53 293  	  DISCOUNT.ID,
14:33:53 294  	  DISCOUNT.NAME,
14:33:53 295  	  DISCOUNT.FIXED_AMOUNT,
14:33:53 296  	  DISCOUNT.PERCENT_AMOUNT,
14:33:53 297  	  DISCOUNT.DISCOUNT_TYPE_ID,
14:33:53 298  	  DISCOUNT.CREATE_DATE,
14:33:53 299  	  DISCOUNT.CREATED_BY,
14:33:53 300  	  DISCOUNT.DESCRIPTION
14:33:53 301  	FROM
14:33:53 302  	  DISCOUNT
14:33:53 303  	  INNER JOIN DISCOUNT_PRODUCT_OFFERING on DISCOUNT.ID = DISCOUNT_PRODUCT_OFFERING.DISCOUNT_ID
14:33:53 304  	WHERE
14:33:53 305  	  DISCOUNT_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = in_product_offering_id;
14:33:53 306  
14:33:53 307  EXCEPTION
14:33:53 308  WHEN BAD_PRODUCT_OFFERING_ID THEN
14:33:53 309  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 310  	  SPROC_NAME, 'No such product offering');
14:33:53 311  WHEN OTHERS THEN
14:33:53 312  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 313  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 314  END GET_PRODUCT_OFFERING_DISCOUNTS;
14:33:53 315  
14:33:53 316  END PROCS_PRODUCT_V22;
14:33:53 317  .
14:33:53 SQL> /

Package body created.

Elapsed: 00:00:00.03
14:33:53 SQL> 
14:33:53 SQL> CREATE OR REPLACE
14:33:53   2  PACKAGE BODY PROCS_REPORTING AS
14:33:53   3  
14:33:53   4  ----
14:33:53   5  --------------------------------------------------------------------------------
14:33:53   6  ----
14:33:53   7  	  procedure ext_charge(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53   8  	  is
14:33:53   9  	  begin
14:33:53  10  	      open out_cursor for
14:33:53  11  		  with ids as ( select id from change_log cl where cl.item = 'CHARGE' and cl.change_time between in_start_date and in_end_date group by id )
14:33:53  12  		  select c.id charge_id, c.invoice_id, c.transaction_id, c.instrument_type_id, it.value instrument_type
14:33:53  13  			,c.instrument_id, c.charge_amount, c.charge_status_id, cs.value charge_status
14:33:53  14  			,c.create_date, c.update_date
14:33:53  15  		  from charge c
14:33:53  16  		      ,charge_status cs
14:33:53  17  		      ,instrument_type it
14:33:53  18  		      ,ids
14:33:53  19  		  where c.id = ids.id
14:33:53  20  		    and c.charge_status_id = cs.id
14:33:53  21  		    and c.instrument_type_id = it.id
14:33:53  22  	      ;
14:33:53  23  	  end;
14:33:53  24  ----
14:33:53  25  --------------------------------------------------------------------------------
14:33:53  26  ----
14:33:53  27  	  procedure ext_license(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53  28  	  is
14:33:53  29  	  begin
14:33:53  30  	      open out_cursor for
14:33:53  31  		  with ids as (select id from change_log cl where cl.item = 'LICENSE' and cl.change_time between in_start_date and in_end_date group by id)
14:33:53  32  		  select l.id license_id, l.start_date, l.end_date, l.offer_id, l.subscription_id, l.invoice_id
14:33:53  33  			,l.license_status_id, ls.value license_status ,l.create_date, l.update_date
14:33:53  34  			,l.current_offer_index, l.current_offer_recurr_num, l.entitlement_end_date, l.grace_start_date, l.grace_end_date
14:33:53  35  		  from license l
14:33:53  36  		      ,license_status ls
14:33:53  37  		      ,ids
14:33:53  38  		  where l.id = ids.id
14:33:53  39  		    and l.license_status_id = ls.id
14:33:53  40  	      ;
14:33:53  41  	  end;
14:33:53  42  ----
14:33:53  43  --------------------------------------------------------------------------------
14:33:53  44  ----
14:33:53  45  	  procedure ext_invoice(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53  46  	  is
14:33:53  47  	  begin
14:33:53  48  	      open out_cursor for
14:33:53  49  		  with ids as ( select id from change_log cl where cl.item = 'INVOICE' and cl.change_time between in_start_date and in_end_date group by id )
14:33:53  50  		  select
14:33:53  51  		    i.id invoice_id,
14:33:53  52  		    i.create_date,
14:33:53  53  		    i.update_date,
14:33:53  54  		    i.invoice_status_id,
14:33:53  55  		    istat.value invoice_status,
14:33:53  56  		    NVL(
14:33:53  57  		       (select offer_chain_id from gift_certificate g where g.purchase_invoice_id = i.id and rownum <= 1),
14:33:53  58  		       (select offer_chain_id from subscription s, license l where l.subscription_id = s.id and l.invoice_id = i.id and rownum <= 1)
14:33:53  59  		    ) offer_chain_id
14:33:53  60  		  from	   invoice i
14:33:53  61  		      join invoice_status istat ON istat.id = i.invoice_status_id
14:33:53  62  		      join ids			on ids.id = i.id
14:33:53  63  		  where 1 = 1
14:33:53  64  	      ;
14:33:53  65  	  end;
14:33:53  66  ----
14:33:53  67  --------------------------------------------------------------------------------
14:33:53  68  ----
14:33:53  69  	  procedure ext_line_item(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53  70  	  is
14:33:53  71  	  begin
14:33:53  72  	      open out_cursor for
14:33:53  73  		  with ids as ( select id from change_log cl where cl.item = 'LINE_ITEM' and cl.change_time between in_start_date and in_end_date group by id )
14:33:53  74  		  select li.id line_item_id, li.invoice_id, li.product_offer_id, li.amount, li.quantity
14:33:53  75  		    ,li.discount_amount, li.taxes_amount, li.create_date
14:33:53  76  		  from line_item li
14:33:53  77  		    , ids
14:33:53  78  		  where li.id = ids.id
14:33:53  79  	      ;
14:33:53  80  	  end;
14:33:53  81  ----
14:33:53  82  --------------------------------------------------------------------------------
14:33:53  83  ----
14:33:53  84  	  procedure ext_account(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53  85  	  is
14:33:53  86  	  begin
14:33:53  87  	      open out_cursor for
14:33:53  88  		  with ids as (select id from change_log cl where cl.item = 'ACCOUNT' and cl.change_time between in_start_date and in_end_date group by id)
14:33:53  89  		  select a.id account_id, a.account_status_id, astat.value account_status, a.group_id, a.suspend_date
14:33:53  90  			,a.create_date, a.update_date, a.instrument_type_id, it.value instrument_type
14:33:53  91  			,a.instrument_id, a.tax_exempt_id
14:33:53  92  			-- need system category??
14:33:53  93  		  from account a
14:33:53  94  		      ,account_status astat
14:33:53  95  		      ,instrument_type it
14:33:53  96  		      , ids
14:33:53  97  		  where a.id = ids.id
14:33:53  98  		    and astat.id = a.account_status_id
14:33:53  99  		    and a.instrument_type_id = it.id(+)
14:33:53 100  	      ;
14:33:53 101  	  end;
14:33:53 102  ----
14:33:53 103  --------------------------------------------------------------------------------
14:33:53 104  ----
14:33:53 105  	  procedure ext_subscription(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53 106  	  is
14:33:53 107  	  begin
14:33:53 108  	      open out_cursor for
14:33:53 109  		  with ids as (select id from change_log cl where cl.item = 'SUBSCRIPTION' and cl.change_time between in_start_date and in_end_date group by id)
14:33:53 110  		  select s.id subscription_id, s.account_id, s.purchase_date, s.offer_chain_id
14:33:53 111  			,s.cancellation_date, sct.value cancellation_reason,0 cancellation_is_credit
14:33:53 112  			,s.create_date, s.update_date, s.subscription_status_id, ss.value subscription_status
14:33:53 113  			,s.instrument_type_id, it.value instrument_type, s.instrument_id, s.updated_by
14:33:53 114  		  from subscription s
14:33:53 115  		      ,subscription_status ss
14:33:53 116  		      ,subscription_cancel_reason sct
14:33:53 117  		      ,instrument_type it
14:33:53 118  		      , ids
14:33:53 119  		  where s.id = ids.id
14:33:53 120  		    and ss.id = s.subscription_status_id
14:33:53 121  		    and s.instrument_type_id = it.id
14:33:53 122  		    and sct.id(+) = s.sct_id
14:33:53 123  	      ;
14:33:53 124  	  end;
14:33:53 125  ----
14:33:53 126  --------------------------------------------------------------------------------
14:33:53 127  ----
14:33:53 128  	  procedure ext_transaction(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53 129  	  is
14:33:53 130  	  begin
14:33:53 131  	      open out_cursor for
14:33:53 132  		  with ids as (select id from change_log cl where cl.item = 'TRANSACTION' and cl.change_time between in_start_date and in_end_date group by id)
14:33:53 133  		  select t.id transaction_id, t.transaction_amount
14:33:53 134  			,t.transaction_status_id, ts.value transaction_status, t.order_id
14:33:53 135  			,t.create_date, t.update_date, t.is_settled
14:33:53 136  		  from transaction t
14:33:53 137  		      ,transaction_status ts
14:33:53 138  		      , ids
14:33:53 139  		  where t.id = ids.id
14:33:53 140  		    and t.transaction_status_id = ts.id
14:33:53 141  	      ;
14:33:53 142  	  end;
14:33:53 143  ----
14:33:53 144  --------------------------------------------------------------------------------
14:33:53 145  ----
14:33:53 146  	  procedure ext_offer_chain(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53 147  	  is
14:33:53 148  	  begin
14:33:53 149  	      open out_cursor for
14:33:53 150  		  with ids as (select id from change_log cl where cl.item = 'OFFER_CHAIN' and cl.change_time between in_start_date and in_end_date group by id)
14:33:53 151  		  select oc.id offer_chain_id, oc.name, oc.description, oc.offer_chain_status_id, ocs.value offer_chain_status
14:33:53 152  			,oc.adoptability_window_start_date adoptability_start_date, oc.adoptability_window_end_date adoptability_end_date
14:33:53 153  			,oc.is_gift_certificate, oc.product_uri, oc.create_date, oc.update_date, oc.vendor_source_id, vs.name vendor_source_name
14:33:53 154  			,oc.billing_source_id, bs.name billing_source_name
14:33:53 155  			,oc.is_seat_license,oc.group_account_type_id
14:33:53 156  		  from offer_chain oc
14:33:53 157  		      , offer_chain_status ocs
14:33:53 158  		      , ids
14:33:53 159  		      , vendor_source vs
14:33:53 160  		      , billing_source bs
14:33:53 161  		  where oc.id = ids.id
14:33:53 162  		    and oc.offer_chain_status_id = ocs.id
14:33:53 163  		    and oc.vendor_source_id = vs.id
14:33:53 164  		    and oc.billing_source_id = bs.id
14:33:53 165  	      ;
14:33:53 166  	  end;
14:33:53 167  ----
14:33:53 168  --------------------------------------------------------------------------------
14:33:53 169  ----
14:33:53 170  	  procedure ext_offer_offer_chain(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53 171  	  is
14:33:53 172  	  begin
14:33:53 173  	      open out_cursor for
14:33:53 174  		  with ids as (select combined_id id from change_log cl where cl.item = 'OFFER_OFFER_CHAIN' and cl.change_time between in_start_date and in_end_date group by combined_id)
14:33:53 175  		  select ooc.offer_id||'~'||ooc.offer_chain_id offer_offer_chain_id, ooc.offer_id, ooc.offer_chain_id
14:33:53 176  			,ooc.index_value, ooc.num_recurrences, ooc.create_date, ooc.update_date
14:33:53 177  		  from offer_offer_chain ooc
14:33:53 178  		  , ids
14:33:53 179  		  where ooc.offer_id||'~'||ooc.offer_chain_id = ids.id
14:33:53 180  	      ;
14:33:53 181  	  end;
14:33:53 182  ----
14:33:53 183  --------------------------------------------------------------------------------
14:33:53 184  ----
14:33:53 185  	  procedure ext_offer(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53 186  	  is
14:33:53 187  	  begin
14:33:53 188  	      open out_cursor for
14:33:53 189  		  with ids as (select id from change_log cl where cl.item = 'OFFER' and cl.change_time between in_start_date and in_end_date group by id)
14:33:53 190  		  select o.id offer_id, o.offer_status_id, os.value offer_status, o.entitlement_duration, o.create_date, o.update_date
14:33:53 191  		  from offer o
14:33:53 192  		      ,offer_status os
14:33:53 193  		      , ids
14:33:53 194  		  where o.id = ids.id
14:33:53 195  		    and o.offer_status_id = os.id
14:33:53 196  	      ;
14:33:53 197  	  end;
14:33:53 198  ----
14:33:53 199  --------------------------------------------------------------------------------
14:33:53 200  ----
14:33:53 201  	  procedure ext_gift_certificate(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53 202  	  is
14:33:53 203  	  begin
14:33:53 204  	      open out_cursor for
14:33:53 205  		  with ids as (select id from change_log cl where cl.item = 'GIFT_CERTIFICATE' and cl.change_time between in_start_date and in_end_date group by id)
14:33:53 206  		  select  gc.id gift_certificate_id, gc.purchaser_group_id, gc.purchase_invoice_id, gc.offer_chain_id
14:33:53 207  			 ,gc.expiration_date, gc.purchase_date
14:33:53 208  			 ,gc.gift_certificate_status_id, gcs.value gift_certificate_status, gc.redeemer_group_id
14:33:53 209  			 ,gc.finalized_invoice_id, gc.create_date, gc.update_date
14:33:53 210  			 ,recipient_address_id
14:33:53 211  			 ,redeemer_address_id
14:33:53 212  			 ,recipient_notify_date
14:33:53 213  			 ,recipient_name
14:33:53 214  			 ,redemption_date
14:33:53 215  			 ,recipient_email
14:33:53 216  		  from gift_certificate gc
14:33:53 217  		      ,gift_certificate_status gcs
14:33:53 218  		      , ids
14:33:53 219  		  where gc.id = ids.id
14:33:53 220  		    and gc.gift_certificate_status_id = gcs.id
14:33:53 221  	      ;
14:33:53 222  	  end;
14:33:53 223  ----
14:33:53 224  --------------------------------------------------------------------------------
14:33:53 225  ----
14:33:53 226  	  procedure ext_product_offering(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53 227  	  is
14:33:53 228  	  begin
14:33:53 229  	      open out_cursor for
14:33:53 230  		  with ids as (select id from change_log cl where cl.item = 'PRODUCT_OFFERING' and cl.change_time between in_start_date and in_end_date group by id)
14:33:53 231  		  select po.id product_offering_id, po.product_id, po.unit_price, po.quantity, po.create_date
14:33:53 232  		  from product_offering po
14:33:53 233  		  , ids
14:33:53 234  		  where po.id = ids.id
14:33:53 235  	      ;
14:33:53 236  	  end;
14:33:53 237  ----
14:33:53 238  --------------------------------------------------------------------------------
14:33:53 239  ----
14:33:53 240  	  procedure ext_product(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53 241  	  is
14:33:53 242  	  begin
14:33:53 243  	      open out_cursor for
14:33:53 244  		  with ids as (select id from change_log cl where cl.item = 'PRODUCT' and cl.change_time between in_start_date and in_end_date group by id)
14:33:53 245  		  select p.id product_id, p.name, p.unit_price, p.production_cost, p.product_status_id, ps.value product_status
14:33:53 246  			,product_uri, p.create_date
14:33:53 247  		  from product p
14:33:53 248  		      ,product_status ps
14:33:53 249  		      , ids
14:33:53 250  		  where p.id = ids.id
14:33:53 251  		    and p.product_status_id = ps.id
14:33:53 252  	      ;
14:33:53 253  	  end;
14:33:53 254  ----
14:33:53 255  --------------------------------------------------------------------------------
14:33:53 256  ----
14:33:53 257  	  procedure ext_offer_product_offering(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53 258  	  is
14:33:53 259  	  begin
14:33:53 260  	      open out_cursor for
14:33:53 261  		  with ids as (select combined_id id from change_log cl where cl.item = 'OFFER_PRODUCT_OFFERING' and cl.change_time between in_start_date and in_end_date group by combined_id)
14:33:53 262  		  select opo.product_offering_id||'~'||opo.offer_id, opo.product_offering_id, opo.offer_id, opo.create_date
14:33:53 263  		  from offer_product_offering opo
14:33:53 264  		  , ids
14:33:53 265  		  where opo.product_offering_id||'~'||opo.offer_id = ids.id
14:33:53 266  	      ;
14:33:53 267  	  end;
14:33:53 268  ----
14:33:53 269  --------------------------------------------------------------------------------
14:33:53 270  ----
14:33:53 271  	  procedure ext_discount_product_offering(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53 272  	  is
14:33:53 273  	  begin
14:33:53 274  	      open out_cursor for
14:33:53 275  		  with ids as (select combined_id id from change_log cl where cl.item = 'DISCOUNT_PRODUCT_OFFERING' and cl.change_time between in_start_date and in_end_date group by combined_id)
14:33:53 276  		  select dpo.discount_id||'~'||dpo.product_offering_id, dpo.discount_id, dpo.product_offering_id, dpo.create_date
14:33:53 277  		  from discount_product_offering dpo
14:33:53 278  		  , ids
14:33:53 279  		  where dpo.discount_id||'~'||dpo.product_offering_id = ids.id
14:33:53 280  	      ;
14:33:53 281  	  end;
14:33:53 282  ----
14:33:53 283  --------------------------------------------------------------------------------
14:33:53 284  ----
14:33:53 285  	  procedure ext_discount(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53 286  	  is
14:33:53 287  	  begin
14:33:53 288  	      open out_cursor for
14:33:53 289  		  with ids as (select id from change_log cl where cl.item = 'DISCOUNT' and cl.change_time between in_start_date and in_end_date group by id)
14:33:53 290  		  select d.id discount_id, d.name, d.description, d.fixed_amount, d.percent_amount
14:33:53 291  			,d.discount_type_id, dt.value discount_type, d.create_date
14:33:53 292  		  from discount d
14:33:53 293  		      ,discount_type dt
14:33:53 294  		      , ids
14:33:53 295  		  where d.id = ids.id
14:33:53 296  		    and d.discount_type_id = dt.id
14:33:53 297  	      ;
14:33:53 298  	  end;
14:33:53 299  ----
14:33:53 300  --------------------------------------------------------------------------------
14:33:53 301  ----
14:33:53 302  	  procedure ext_product_eligibility(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53 303  	  is
14:33:53 304  	  begin
14:33:53 305  	      open out_cursor for
14:33:53 306  		  with ids as (select id from change_log cl where cl.item = 'PRODUCT_ELIGIBILITY' and cl.change_time between in_start_date and in_end_date group by id)
14:33:53 307  		  select pg.id product_eligibility_id, pg.product_id, pg.name, pg.value, pg.create_date
14:33:53 308  		  from product_eligibility pg
14:33:53 309  		  , ids
14:33:53 310  		  where pg.id = ids.id
14:33:53 311  	      ;
14:33:53 312  	  end;
14:33:53 313  ----
14:33:53 314  --------------------------------------------------------------------------------
14:33:53 315  ----
14:33:53 316  	  procedure ext_offer_chain_eligibility(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53 317  	  is
14:33:53 318  	  begin
14:33:53 319  	      open out_cursor for
14:33:53 320  		  with ids as (select id from change_log cl where cl.item = 'OFFER_CHAIN_ELIGIBILITY' and cl.change_time between in_start_date and in_end_date group by id)
14:33:53 321  		  select oce.id offer_chain_eligibility_id, oce.offer_chain_id, oce.name, oce.value, oce.create_date
14:33:53 322  		  from offer_chain_eligibility oce
14:33:53 323  		  , ids
14:33:53 324  		  where oce.id = ids.id
14:33:53 325  	      ;
14:33:53 326  	  end;
14:33:53 327  ----
14:33:53 328  --------------------------------------------------------------------------------
14:33:53 329  ----
14:33:53 330  	  procedure ext_offer_chain_metadata(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53 331  	  is
14:33:53 332  	  begin
14:33:53 333  	      open out_cursor for
14:33:53 334  		  with ids as (select id from change_log cl where cl.item = 'OFFER_CHAIN_META_DATA' and cl.change_time between in_start_date and in_end_date group by id)
14:33:53 335  		  select ocm.id offer_chain_meta_data_id, ocm.offer_chain_id, ocm.name, ocm.value, ocm.create_date
14:33:53 336  		  from offer_chain_meta_data ocm
14:33:53 337  		  , ids
14:33:53 338  		  where ocm.id = ids.id
14:33:53 339  	      ;
14:33:53 340  	  end;
14:33:53 341  ----
14:33:53 342  --------------------------------------------------------------------------------
14:33:53 343  ----
14:33:53 344  	  procedure ext_product_offering_metadata(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53 345  	  is
14:33:53 346  	  begin
14:33:53 347  	      open out_cursor for
14:33:53 348  		  with ids as (select id from change_log cl where cl.item = 'PRODUCT_OFFERING_META_DATA' and cl.change_time between in_start_date and in_end_date group by id)
14:33:53 349  		  select pom.id prod_offer_meta_data_id, pom.product_offering_id, pom.name, pom.value, pom.create_date
14:33:53 350  		  from product_offering_meta_data pom
14:33:53 351  		  , ids
14:33:53 352  		  where pom.id = ids.id
14:33:53 353  	      ;
14:33:53 354  	  end;
14:33:53 355  ----
14:33:53 356  --------------------------------------------------------------------------------
14:33:53 357  ----
14:33:53 358  	  procedure ext_subscription_metadata(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53 359  	  is
14:33:53 360  	  begin
14:33:53 361  	      open out_cursor for
14:33:53 362  		  with ids as (select id from change_log cl where cl.item = 'SUBSCRIPTION_META_DATA' and cl.change_time between in_start_date and in_end_date group by id)
14:33:53 363  		  select sm.id subscription_meta_data_id, sm.subscription_id, sm.name, sm.value, sm.create_date
14:33:53 364  		  from subscription_meta_data sm
14:33:53 365  		  , ids
14:33:53 366  		  where sm.id = ids.id
14:33:53 367  	      ;
14:33:53 368  	  end;
14:33:53 369  ----
14:33:53 370  --------------------------------------------------------------------------------
14:33:53 371  ----
14:33:53 372  	  procedure ext_credit_card(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53 373  	  is
14:33:53 374  	  begin
14:33:53 375  	      open out_cursor for
14:33:53 376  		  with ids as (select id from change_log cl where cl.item = 'CREDIT_CARD' and cl.change_time between in_start_date and in_end_date group by id)
14:33:53 377  		  select cc.id credit_card_id, cc.account_id, cc.instrument_name, cc.state, cc.city, cc.postal_code
14:33:53 378  			,cc.country, cc.expiration_date, cc.credit_card_type_id, cct.value credit_card_type
14:33:53 379  			,cc.credit_card_status_id, ccs.value credit_card_status, cc.create_date, cc.update_date
14:33:53 380  		  from credit_card cc
14:33:53 381  		      ,credit_card_type cct
14:33:53 382  		      ,credit_card_status ccs
14:33:53 383  		      , ids
14:33:53 384  		  where cc.id = ids.id
14:33:53 385  		    and cc.credit_card_type_id = cct.id(+)
14:33:53 386  		    and cc.credit_card_status_id = ccs.id
14:33:53 387  	      ;
14:33:53 388  	  end;
14:33:53 389  ----
14:33:53 390  --------------------------------------------------------------------------------
14:33:53 391  ----
14:33:53 392  	  procedure ext_transaction_attempt(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53 393  	  is
14:33:53 394  	  begin
14:33:53 395  	      open out_cursor for
14:33:53 396  		  with ids as (select id from change_log cl where cl.item = 'TRANSACTION_ATTEMPT' and cl.change_time between in_start_date and in_end_date group by id)
14:33:53 397  		  select ta.id transaction_attempt_id, ta.transaction_id, ta.external_transaction_id
14:33:53 398  			,ta.transaction_start_time, ta.external_status_code, ta.external_status_message
14:33:53 399  			,ta.transaction_attempt_status_id trans_attempt_status_id, tas.value transaction_attempt_status
14:33:53 400  			,ta.create_date
14:33:53 401  		  from transaction_attempt ta
14:33:53 402  		      ,transaction_attempt_status tas
14:33:53 403  		      , ids
14:33:53 404  		  where ta.id = ids.id
14:33:53 405  		    and ta.transaction_attempt_status_id = tas.id
14:33:53 406  	      ;
14:33:53 407  	  end;
14:33:53 408  ----
14:33:53 409  --------------------------------------------------------------------------------
14:33:53 410  ----
14:33:53 411  	  procedure ext_invoice_adjustment(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53 412  	  is
14:33:53 413  	  begin
14:33:53 414  	      open out_cursor for
14:33:53 415  		  with ids as (select id from change_log cl where cl.item = 'INVOICE_ADJUSTMENT' and cl.change_time between in_start_date and in_end_date group by id)
14:33:53 416  		  select ia.id invoice_adjustment_id, ia.invoice_id, ia.is_credit, ir.value adjustment_reason, ia.charge_id
14:33:53 417  			,ia.adjustment_date, ia.create_date
14:33:53 418  		  from invoice_adjustment ia, invoice_adjustment_reason ir
14:33:53 419  		  , ids
14:33:53 420  		  where ia.id = ids.id
14:33:53 421  		  and ir.id = ia.invoice_adjustment_reason_id
14:33:53 422  	      ;
14:33:53 423  	  end;
14:33:53 424  ----
14:33:53 425  --------------------------------------------------------------------------------
14:33:53 426  ----
14:33:53 427  
14:33:53 428  	  procedure ext_line_item_adjustment(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53 429  	  is
14:33:53 430  	  begin
14:33:53 431  	      open out_cursor for
14:33:53 432  		  with ids as (select id from change_log cl where cl.item = 'LINE_ITEM_ADJUSTMENT' and cl.change_time between in_start_date and in_end_date group by id)
14:33:53 433  		  select lia.id line_item_adjustment_id, lia.line_item_id, lia.invoice_adjustment_id, lia.amount, lia.tax, lia.discount, lia.create_date
14:33:53 434  		  from line_item_adjustment lia
14:33:53 435  		  , ids
14:33:53 436  		  where lia.id = ids.id
14:33:53 437  	      ;
14:33:53 438  	  end;
14:33:53 439  ----
14:33:53 440  --------------------------------------------------------------------------------
14:33:53 441  ----
14:33:53 442  
14:33:53 443  	  procedure ext_tax(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53 444  	  is
14:33:53 445  	  begin
14:33:53 446  	      open out_cursor for
14:33:53 447  		  with ids as (select id from change_log cl where cl.item = 'TAX' and cl.change_time between in_start_date and in_end_date group by id)
14:33:53 448  		  select
14:33:53 449  		    tax.id tax_id,
14:33:53 450  		    ttype.code tax_type,
14:33:53 451  		    tax.calculated_amount,
14:33:53 452  		    tax.create_date,
14:33:53 453  		    tax.line_item_id,
14:33:53 454  		    tax.effective_rate,
14:33:53 455  		    tax.taxable_amount,
14:33:53 456  		    tax.tax_rule_id,
14:33:53 457  		    j.name jurisdiction_level,
14:33:53 458  		    tax.jurisdiction_name,
14:33:53 459  		    tax.jurisdiction_id,
14:33:53 460  		    tax.ext_tax_type,
14:33:53 461  		    tax.ext_result,
14:33:53 462  		    tax.imposition_type,
14:33:53 463  		    tax.imposition
14:33:53 464  		  from tax
14:33:53 465  		  , tax_type ttype
14:33:53 466  		  , jurisdiction_level j
14:33:53 467  		  , ids
14:33:53 468  		  where tax.id = ids.id and ttype.id = tax.tax_type_id and j.id = tax.jurisdiction_level_id
14:33:53 469  	      ;
14:33:53 470  	  end;
14:33:53 471  ----
14:33:53 472  --------------------------------------------------------------------------------
14:33:53 473  ----
14:33:53 474  	  procedure ext_tax_adjustment(in_start_date date, in_end_date date, out_cursor out sys_refcursor)
14:33:53 475  	  is
14:33:53 476  	  begin
14:33:53 477  	      open out_cursor for
14:33:53 478  		  with ids as (select id from change_log cl where cl.item = 'TAX_ADJUSTMENT' and cl.change_time between in_start_date and in_end_date group by id)
14:33:53 479  		  select
14:33:53 480  		    tax.id tad_adjustment_id,
14:33:53 481  		    tax.tax_id tax_id,
14:33:53 482  		    tax.line_item_adjustment_id line_item_adjustment_id,
14:33:53 483  		    tax.amount tax_amount,
14:33:53 484  		    tax.create_date create_date
14:33:53 485  		  from tax_adjustment tax
14:33:53 486  		  , ids
14:33:53 487  		  where tax.id = ids.id
14:33:53 488  	      ;
14:33:53 489  	  end;
14:33:53 490  ----
14:33:53 491  --------------------------------------------------------------------------------
14:33:53 492  ----
14:33:53 493  /**/
14:33:53 494  	  procedure ext_rcn_ext_source_log(in_start_date date, in_end_date date, out_cursor out sys_refcursor) IS
14:33:53 495  	  BEGIN
14:33:53 496  	    OPEN OUT_CURSOR FOR
14:33:53 497  	    with ids As ( SELECT cl.id FROM change_log cl where cl.item = 'RCN_EXT_SOURCE_LOG' and change_time between in_start_date and in_end_date group by cl.id )
14:33:53 498  	    SELECT
14:33:53 499  		t.id rcn_ext_source_log_id
14:33:53 500  	      , t.extraction_timestamp
14:33:53 501  	      , t.report_date
14:33:53 502  	      , t.report_generation_datetime
14:33:53 503  	      , t.record_type
14:33:53 504  	      , t.report_file_name
14:33:53 505  	      , t.create_date
14:33:53 506  	      , t.created_by
14:33:53 507  	    FROM rcn_ext_source_log t, ids
14:33:53 508  	    WHERE ids.id = t.id;
14:33:53 509  	  END;
14:33:53 510  
14:33:53 511  	  procedure ext_rcn_cpt_svc_chg_dtl(in_start_date date, in_end_date date, out_cursor out sys_refcursor) IS
14:33:53 512  	  BEGIN
14:33:53 513  	    OPEN OUT_CURSOR FOR
14:33:53 514  	    with ids As ( SELECT cl.id FROM change_log cl where cl.item = 'RCN_CPT_SERVICE_CHARGE_DETAIL' and change_time between in_start_date and in_end_date group by cl.id )
14:33:53 515  	    SELECT
14:33:53 516  		t.id rcn_cpt_svc_chg_dtl_id
14:33:53 517  	      , t.rcn_ext_source_log_id
14:33:53 518  	      , t.record_type
14:33:53 519  	      , t.category
14:33:53 520  	      , t.sub_category
14:33:53 521  	      , t.entity_type
14:33:53 522  	      , t.entity_number
14:33:53 523  	      , t.funds_transfer_inst_number
14:33:53 524  	      , t.secure_ba_number
14:33:53 525  	      , t.settlement_currency
14:33:53 526  	      , t.fee_schedule
14:33:53 527  	      , t.mop
14:33:53 528  	      , t.interchange_qualification
14:33:53 529  	      , t.fee_type_description
14:33:53 530  	      , t.action_type
14:33:53 531  	      , t.unit_quantity
14:33:53 532  	      , t.unit_fee
14:33:53 533  	      , t.amount
14:33:53 534  	      , t.percentage_rate
14:33:53 535  	      , t.total_charge
14:33:53 536  	      , t.create_date
14:33:53 537  	      , t.created_by
14:33:53 538  	    FROM rcn_cpt_service_charge_detail t, ids
14:33:53 539  	    WHERE ids.id = t.id;
14:33:53 540  	  END;
14:33:53 541  ----
14:33:53 542  --------------------------------------------------------------------------------
14:33:53 543  ----
14:33:53 544  
14:33:53 545  	  procedure ext_rcn_cpt_excpt_dtl(in_start_date date, in_end_date date, out_cursor out sys_refcursor) IS
14:33:53 546  	  BEGIN
14:33:53 547  	    OPEN OUT_CURSOR FOR
14:33:53 548  	    with ids As ( SELECT cl.id FROM change_log cl where cl.item = 'RCN_CPT_EXCEPTION_DETAIL' and change_time between in_start_date and in_end_date group by cl.id )
14:33:53 549  	    SELECT
14:33:53 550  		t.id rcn_cpt_excp_dtl_id
14:33:53 551  	      , t.rcn_ext_source_log_id
14:33:53 552  	      , t.record_type
14:33:53 553  	      , t.submission_date
14:33:53 554  	      , t.pid_number
14:33:53 555  	      , t.pid_short_name
14:33:53 556  	      , t.submission_number
14:33:53 557  	      , t.record_number
14:33:53 558  	      , t.entity_type
14:33:53 559  	      , t.entity_number
14:33:53 560  	      , t.presentment_currency
14:33:53 561  	      , t.merchant_order_number
14:33:53 562  	      , t.rdfi_number
14:33:53 563  	      , t.account_number
14:33:53 564  	      , t.expiration_date
14:33:53 565  	      , t.amount
14:33:53 566  	      , t.mop
14:33:53 567  	      , t.action_code
14:33:53 568  	      , t.auth_date
14:33:53 569  	      , t.auth_code
14:33:53 570  	      , t.auth_response_code
14:33:53 571  	      , t.trace_number
14:33:53 572  	      , t.consumer_country_code
14:33:53 573  	      , t.category
14:33:53 574  	      , t.mcc
14:33:53 575  	      , t.reject_code
14:33:53 576  	      , t.submission_status
14:33:53 577  	      , t.create_date
14:33:53 578  	      , t.created_by
14:33:53 579  	    FROM rcn_cpt_exception_detail t, ids
14:33:53 580  	    WHERE ids.id = t.id;
14:33:53 581  	  END;
14:33:53 582  ----
14:33:53 583  --------------------------------------------------------------------------------
14:33:53 584  ----
14:33:53 585  
14:33:53 586  	  procedure ext_rcn_cpt_dpst_dtl(in_start_date date, in_end_date date, out_cursor out sys_refcursor) IS
14:33:53 587  	  BEGIN
14:33:53 588  	    OPEN OUT_CURSOR FOR
14:33:53 589  	    with ids As ( SELECT cl.id FROM change_log cl where cl.item = 'RCN_CPT_DEPOSIT_DETAIL' and change_time between in_start_date and in_end_date group by cl.id )
14:33:53 590  	      SELECT
14:33:53 591  		t.id rcn_cpt_deposit_dtl_id
14:33:53 592  	      , t.rcn_ext_source_log_id
14:33:53 593  	      , t.record_type
14:33:53 594  	      , t.submission_date
14:33:53 595  	      , t.pid_number
14:33:53 596  	      , t.pid_short_name
14:33:53 597  	      , t.submission_number
14:33:53 598  	      , t.record_number
14:33:53 599  	      , t.entity_type
14:33:53 600  	      , t.entity_number
14:33:53 601  	      , t.presentment_currency
14:33:53 602  	      , t.merchant_order_number
14:33:53 603  	      , t.rdfi_number
14:33:53 604  	      , t.account_number
14:33:53 605  	      , t.expiration_date
14:33:53 606  	      , t.amount
14:33:53 607  	      , t.mop
14:33:53 608  	      , t.action_code
14:33:53 609  	      , t.auth_date
14:33:53 610  	      , t.auth_code
14:33:53 611  	      , t.auth_response_code
14:33:53 612  	      , t.trace_number
14:33:53 613  	      , t.consumer_country_code
14:33:53 614  	      , t.mcc
14:33:53 615  	      , t.create_date
14:33:53 616  	      , t.created_by
14:33:53 617  	      , t.fee_code
14:33:53 618  	      , t.unit_fee
14:33:53 619  	      , t.percent_fee
14:33:53 620  	      , t.total_interchange_fee
14:33:53 621  	      , t.total_assessment_fee
14:33:53 622  	      , t.other_fee
14:33:53 623  	    FROM rcn_cpt_deposit_detail t, ids
14:33:53 624  	    WHERE ids.id = t.id;
14:33:53 625  	  END;
14:33:53 626  ----
14:33:53 627  --------------------------------------------------------------------------------
14:33:53 628  ----
14:33:53 629  
14:33:53 630  	  procedure ext_rcn_cpt_chgbk_act_dtl(in_start_date date, in_end_date date, out_cursor out sys_refcursor) IS
14:33:53 631  	  BEGIN
14:33:53 632  	    OPEN OUT_CURSOR FOR
14:33:53 633  	    with ids As ( SELECT cl.id FROM change_log cl where cl.item = 'RCN_CPT_CHARGEBACK_ACT_DETAIL' and change_time between in_start_date and in_end_date group by cl.id )
14:33:53 634  	    SELECT
14:33:53 635  		t.id rcn_cpt_chgbk_act_dtl_id
14:33:53 636  	      , t.rcn_ext_source_log_id
14:33:53 637  	      , t.record_type
14:33:53 638  	      , t.entity_type
14:33:53 639  	      , t.entity_number
14:33:53 640  	      , t.chargeback_amount_issuer
14:33:53 641  	      , t.prev_partial_representment
14:33:53 642  	      , t.presentment_currency
14:33:53 643  	      , t.chargeback_category
14:33:53 644  	      , t.status_flag
14:33:53 645  	      , t.sequence_number
14:33:53 646  	      , t.merchant_order_number
14:33:53 647  	      , t.account_number
14:33:53 648  	      , t.reason_code
14:33:53 649  	      , t.transaction_date
14:33:53 650  	      , t.chargeback_date
14:33:53 651  	      , t.activity_date
14:33:53 652  	      , t.chargeback_amount_action
14:33:53 653  	      , t.fee_amount
14:33:53 654  	      , t.usage_code
14:33:53 655  	      , t.mop_code
14:33:53 656  	      , t.authorization_date
14:33:53 657  	      , t.chargeback_due_date
14:33:53 658  	      , t.create_date
14:33:53 659  	      , t.created_by
14:33:53 660  	    FROM rcn_cpt_chargeback_act_detail t, ids
14:33:53 661  	    WHERE ids.id = t.id;
14:33:53 662  	  END;
14:33:53 663  ----
14:33:53 664  --------------------------------------------------------------------------------
14:33:53 665  ----
14:33:53 666  
14:33:53 667  	  procedure ext_rcn_pp_sttlmnt(in_start_date date, in_end_date date, out_cursor out sys_refcursor) IS
14:33:53 668  	  BEGIN
14:33:53 669  	    OPEN OUT_CURSOR FOR
14:33:53 670  	    with ids As ( SELECT cl.id FROM change_log cl where cl.item = 'RCN_PP_SETTLEMENT' and change_time between in_start_date and in_end_date group by cl.id )
14:33:53 671  	    SELECT
14:33:53 672  		t.id rcn_pp_settlement_id
14:33:53 673  	      , t.rcn_ext_source_log_id
14:33:53 674  	      , t.transaction_id
14:33:53 675  	      , t.invoice_id
14:33:53 676  	      , t.pp_ref_id
14:33:53 677  	      , t.pp_ref_id_type
14:33:53 678  	      , t.trans_event_code
14:33:53 679  	      , t.trans_init_date
14:33:53 680  	      , t.trans_comp_date
14:33:53 681  	      , t.trans_deb_or_cred
14:33:53 682  	      , t.gross_trans_amount
14:33:53 683  	      , t.gross_trans_currency
14:33:53 684  	      , t.fee_deb_or_cred
14:33:53 685  	      , t.fee_amount
14:33:53 686  	      , t.fee_currency
14:33:53 687  	      , t.custom_field
14:33:53 688  	      , t.create_date
14:33:53 689  	      , t.created_by
14:33:53 690  	    FROM rcn_pp_settlement t, ids
14:33:53 691  	    WHERE ids.id = t.id;
14:33:53 692  	  END;
14:33:53 693  ----
14:33:53 694  --------------------------------------------------------------------------------
14:33:53 695  ----
14:33:53 696  
14:33:53 697  	  procedure ext_rcn_pp_dispute(in_start_date date, in_end_date date, out_cursor out sys_refcursor) IS
14:33:53 698  	  BEGIN
14:33:53 699  	    OPEN OUT_CURSOR FOR
14:33:53 700  	    with ids As ( SELECT cl.id FROM change_log cl where cl.item = 'RCN_PP_DISPUTE' and change_time between in_start_date and in_end_date group by cl.id )
14:33:53 701  	    SELECT
14:33:53 702  		t.id rcn_pp_dispute_id
14:33:53 703  	      , t.rcn_ext_source_log_id
14:33:53 704  	      , t.dispute_type
14:33:53 705  	      , t.claimant_name
14:33:53 706  	      , t.claimant_email
14:33:53 707  	      , t.transaction_id
14:33:53 708  	      , t.trans_date
14:33:53 709  	      , t.disputed_amount
14:33:53 710  	      , t.disputed_amount_currency
14:33:53 711  	      , t.dispute_reason
14:33:53 712  	      , t.dispute_filing_date
14:33:53 713  	      , t.dispute_status
14:33:53 714  	      , t.dispute_case_id
14:33:53 715  	      , t.invoice_id
14:33:53 716  	      , t.create_date
14:33:53 717  	      , t.created_by
14:33:53 718  	    FROM
14:33:53 719  	    rcn_pp_dispute t, ids
14:33:53 720  	    WHERE ids.id = t.id;
14:33:53 721  	  END;
14:33:53 722  ----
14:33:53 723  --------------------------------------------------------------------------------
14:33:53 724  ----
14:33:53 725  
14:33:53 726  	  procedure ext_rcn_pp_trns_dtl(in_start_date date, in_end_date date, out_cursor out sys_refcursor) IS
14:33:53 727  	  BEGIN
14:33:53 728  	    OPEN OUT_CURSOR FOR
14:33:53 729  	    with ids As ( SELECT cl.id FROM change_log cl where cl.item = 'RCN_PP_TRANS_DETAIL' and change_time between in_start_date and in_end_date group by cl.id )
14:33:53 730  	    SELECT
14:33:53 731  		t.id rcn_pp_trans_dtl_id
14:33:53 732  	      , t.rcn_ext_source_log_id
14:33:53 733  	      , t.transaction_id
14:33:53 734  	      , t.invoice_id
14:33:53 735  	      , t.pp_ref_id
14:33:53 736  	      , t.trans_event_code
14:33:53 737  	      , t.trans_init_date
14:33:53 738  	      , t.trans_comp_date
14:33:53 739  	      , t.trans_deb_or_cred
14:33:53 740  	      , t.gross_trans_amount
14:33:53 741  	      , t.gross_trans_currency
14:33:53 742  	      , t.fee_deb_or_cred
14:33:53 743  	      , t.fee_amount
14:33:53 744  	      , t.fee_currency
14:33:53 745  	      , t.trans_status
14:33:53 746  	      , t.insurance_amount
14:33:53 747  	      , t.sales_tax_amount
14:33:53 748  	      , t.shipping_amount
14:33:53 749  	      , t.trans_subject
14:33:53 750  	      , t.trans_note
14:33:53 751  	      , t.payer_acct_id
14:33:53 752  	      , t.payer_addr_status
14:33:53 753  	      , t.item_name
14:33:53 754  	      , t.item_id
14:33:53 755  	      , t.option_1_name
14:33:53 756  	      , t.option_1_value
14:33:53 757  	      , t.option_2_name
14:33:53 758  	      , t.option_2_value
14:33:53 759  	      , t.auction_site
14:33:53 760  	      , t.auction_buyer_id
14:33:53 761  	      , t.auction_closing_date
14:33:53 762  	      , t.shipping_addr_line_1
14:33:53 763  	      , t.shipping_addr_line_2
14:33:53 764  	      , t.shipping_addr_city
14:33:53 765  	      , t.shipping_addr_state
14:33:53 766  	      , t.shipping_addr_zip
14:33:53 767  	      , t.shipping_addr_country
14:33:53 768  	      , t.custom_field
14:33:53 769  	      , t.create_date
14:33:53 770  	      , t.created_by
14:33:53 771  	    FROM rcn_pp_trans_detail t, ids
14:33:53 772  	    WHERE ids.id = t.id;
14:33:53 773  	  END;
14:33:53 774  ----
14:33:53 775  --------------------------------------------------------------------------------
14:33:53 776  ----
14:33:53 777  	  procedure ext_rcn_amex_chargeback(in_start_date date, in_end_date date, out_cursor out sys_refcursor) IS
14:33:53 778  	  BEGIN
14:33:53 779  	    OPEN OUT_CURSOR FOR
14:33:53 780  	    with ids As ( SELECT cl.id FROM change_log cl where cl.item = 'RCN_AMEX_CHARGEBACK' and change_time between in_start_date and in_end_date group by cl.id )
14:33:53 781  	    SELECT
14:33:53 782  	      rac.id
14:33:53 783  	    , rac.rcn_ext_source_log_id
14:33:53 784  	    , rac.resolution
14:33:53 785  	    , rac.from_system
14:33:53 786  	    , rac.rejects_to_system
14:33:53 787  	    , rac.disputes_to_system
14:33:53 788  	    , rac.date_of_adjustment
14:33:53 789  	    , rac.date_of_charge
14:33:53 790  	    , rac.case_type
14:33:53 791  	    , rac.cb_reas_code
14:33:53 792  	    , rac.cb_amount
14:33:53 793  	    , rac.cb_adjustment_number
14:33:53 794  	    , rac.billed_amount
14:33:53 795  	    , rac.soc_amount
14:33:53 796  	    , rac.foreign_amount
14:33:53 797  	    , rac.currency
14:33:53 798  	    , rac.note1
14:33:53 799  	    , rac.note2
14:33:53 800  	    , rac.note3
14:33:53 801  	    , rac.note4
14:33:53 802  	    , rac.note5
14:33:53 803  	    , rac.note6
14:33:53 804  	    , rac.note7
14:33:53 805  	    , rac.ind_ref_number
14:33:53 806  	    , rac.create_date
14:33:53 807  	    , rac.created_by
14:33:53 808  	    , rac.update_date
14:33:53 809  	    , rac.updated_by
14:33:53 810  	    FROM rcn_amex_chargeback rac, ids
14:33:53 811  	    WHERE ids.id = rac.id;
14:33:53 812  	  END;
14:33:53 813  ----
14:33:53 814  --------------------------------------------------------------------------------
14:33:53 815  ----
14:33:53 816  	  procedure ext_paypal(in_start_date date, in_end_date date, out_cursor out sys_refcursor) IS
14:33:53 817  	  BEGIN
14:33:53 818  	    OPEN OUT_CURSOR FOR
14:33:53 819  	    with ids as ( SELECT cl.id FROM change_log cl where cl.item = 'PAYPAL' and change_time between in_start_date and in_end_date group by cl.id )
14:33:53 820  	    SELECT
14:33:53 821  		t.ID PAYPAL_ID
14:33:53 822  	      , ACCOUNT_ID
14:33:53 823  	      , INSTRUMENT_NAME
14:33:53 824  	      , CREATE_DATE
14:33:53 825  	      , CREATED_BY
14:33:53 826  	      , UPDATE_DATE
14:33:53 827  	      , UPDATED_BY
14:33:53 828  	      , s.value PAYPAL_STATUS
14:33:53 829  	      , STATE
14:33:53 830  	      , CITY
14:33:53 831  	      , POSTAL_CODE
14:33:53 832  	      , COUNTRY
14:33:53 833  	      , EXPIRATION_DATE
14:33:53 834  	    FROM paypal t, paypal_status s, ids
14:33:53 835  	    WHERE ids.id = t.id and t.paypal_status_id = s.id;
14:33:53 836  	  END;
14:33:53 837  ----
14:33:53 838  --------------------------------------------------------------------------------
14:33:53 839  ----
14:33:53 840  	  procedure ext_address(in_start_date date, in_end_date date, out_cursor out sys_refcursor) IS
14:33:53 841  	  BEGIN
14:33:53 842  	    OPEN OUT_CURSOR FOR
14:33:53 843  	    with ids as ( SELECT cl.id FROM change_log cl where cl.item = 'ADDRESS' and change_time between in_start_date and in_end_date group by cl.id )
14:33:53 844  	    SELECT
14:33:53 845  	      a.id ADDRESS_ID,
14:33:53 846  	      address1,
14:33:53 847  	      address2,
14:33:53 848  	      city,
14:33:53 849  	      state,
14:33:53 850  	      postal_code,
14:33:53 851  	      country,
14:33:53 852  	      create_date,
14:33:53 853  	      created_by,
14:33:53 854  	      update_date,
14:33:53 855  	      updated_by
14:33:53 856  	    FROM address a, ids
14:33:53 857  	    WHERE ids.id = a.id;
14:33:53 858  	  END;
14:33:53 859  ----
14:33:53 860  --------------------------------------------------------------------------------
14:33:53 861  ----
14:33:53 862  /**/
14:33:53 863  END PROCS_REPORTING;
14:33:53 864  .
14:33:53 SQL> /

Package body created.

Elapsed: 00:00:00.11
14:33:53 SQL> 
14:33:53 SQL> create or replace PACKAGE BODY		  "PROCS_REPORTING_1A" AS
14:33:53   2  
14:33:53   3  ----
14:33:53   4  --------------------------------------------------------------------------------
14:33:53   5  ----
14:33:53   6  	  function getDiscountAmount(in_line_item_id line_item.id%type)
14:33:53   7  	      return line_item.amount%type
14:33:53   8  	  is
14:33:53   9  	      v_discount  line_item.amount%type := 0;
14:33:53  10  	  begin
14:33:53  11  	      for x in (
14:33:53  12  		  select d.id discount_id
14:33:53  13  			,nvl(d.fixed_amount, d.percent_amount * (po.quantity * po.unit_price)) discount_amount
14:33:53  14  		  from discount d
14:33:53  15  		      join discount_line_item dli	      on dli.discount_id = d.id
14:33:53  16  		      join discount_product_offering dop      on dop.discount_id = d.id
14:33:53  17  		      join product_offering po		      on po.id = dop.product_offering_id
14:33:53  18  		      join line_item li 		      on li.id = dli.line_item_id and li.product_offer_id = po.id
14:33:53  19  		  where dli.line_item_id = in_line_item_id
14:33:53  20  	      )
14:33:53  21  	      loop
14:33:53  22  		  v_discount := v_discount + x.discount_amount;
14:33:53  23  	      end loop;
14:33:53  24  
14:33:53  25  	      return v_discount;
14:33:53  26  	  end;
14:33:53  27  ----
14:33:53  28  --------------------------------------------------------------------------------
14:33:53  29  ----
14:33:53  30  	  function getRefundAmount(in_line_item_id line_item.id%type)
14:33:53  31  	      return line_item.amount%type
14:33:53  32  	  is
14:33:53  33  	      v_li_total  line_item.amount%type;
14:33:53  34  	      v_inv_total line_item.amount%type;
14:33:53  35  	      v_ref_total line_item.amount%type;
14:33:53  36  	  begin
14:33:53  37  
14:33:53  38  	      for li in (
14:33:53  39  		  select li.invoice_id, po.*
14:33:53  40  		  from line_item li
14:33:53  41  			  join core_owner.product_offering po on li.product_offer_id = po.id
14:33:53  42  		  where li.id = in_line_item_id
14:33:53  43  	      )
14:33:53  44  	      loop
14:33:53  45  		  v_li_total := (li.quantity * li.unit_price) - getDiscountAmount(in_line_item_id);
14:33:53  46  
14:33:53  47  		  v_inv_total := 0;
14:33:53  48  		  v_ref_total := 0;
14:33:53  49  		  for x in (
14:33:53  50  		      select case when c.charge_amount < 0 then -1 else 1 end type, sum(c.charge_amount) total
14:33:53  51  		      from charge c
14:33:53  52  		      where c.invoice_id = li.invoice_id
14:33:53  53  		      group by case when c.charge_amount < 0 then -1 else 1 end
14:33:53  54  		  )
14:33:53  55  		  loop
14:33:53  56  		      if (x.type = 1) then
14:33:53  57  			  v_inv_total := x.total;
14:33:53  58  		      else
14:33:53  59  			  v_ref_total := x.total;
14:33:53  60  		      end if;
14:33:53  61  		  end loop;
14:33:53  62  
14:33:53  63  		  if (v_inv_total > 0) then
14:33:53  64  		      return (v_ref_total / v_inv_total) * v_li_total;
14:33:53  65  		  else
14:33:53  66  		      return 0;
14:33:53  67  		  end if;
14:33:53  68  
14:33:53  69  	      end loop;
14:33:53  70  
14:33:53  71  	      return 0;
14:33:53  72  	  end;
14:33:53  73  ----
14:33:53  74  --------------------------------------------------------------------------------
14:33:53  75  ----
14:33:53  76  	PROCEDURE EXTRACT_LINE_ITEMS(
14:33:53  77  	  in_lower_date_bound DATE,
14:33:53  78  	  in_upper_date_bound DATE,
14:33:53  79  	  out_lic_cur OUT sys_refcursor
14:33:53  80  	) AS
14:33:53  81  	BEGIN
14:33:53  82  	  OPEN out_lic_cur FOR
14:33:53  83  	  with liq as (
14:33:53  84  		SELECT li2.id
14:33:53  85  		      FROM
14:33:53  86  			   line_item li2
14:33:53  87  		      WHERE
14:33:53  88  		      TRUNC(li2.create_date, 'HH') BETWEEN TRUNC(in_lower_date_bound,'HH') AND TRUNC(in_upper_date_bound,'HH')
14:33:53  89  		UNION
14:33:53  90  		SELECT li2.id
14:33:53  91  		      FROM
14:33:53  92  			   line_item li2
14:33:53  93  		      JOIN invoice i2 ON i2.id = li2.invoice_id
14:33:53  94  		      WHERE
14:33:53  95  		      TRUNC(i2.create_date, 'HH') BETWEEN TRUNC(in_lower_date_bound,'HH') AND TRUNC(in_upper_date_bound,'HH')
14:33:53  96  		UNION
14:33:53  97  		SELECT li2.id
14:33:53  98  		      FROM
14:33:53  99  			   line_item li2
14:33:53 100  		      JOIN license l2 ON li2.invoice_id = l2.invoice_id
14:33:53 101  		      WHERE
14:33:53 102  		      TRUNC(l2.create_date, 'HH') BETWEEN TRUNC(in_lower_date_bound,'HH') AND TRUNC(in_upper_date_bound,'HH')
14:33:53 103  		UNION
14:33:53 104  		SELECT li2.id
14:33:53 105  		      FROM
14:33:53 106  			   line_item li2
14:33:53 107  		      JOIN license l2 ON li2.invoice_id = l2.invoice_id
14:33:53 108  		      JOIN subscription s2 ON s2.id = l2.subscription_id
14:33:53 109  		      WHERE
14:33:53 110  		      TRUNC(s2.create_date, 'HH') BETWEEN TRUNC(in_lower_date_bound,'HH') AND TRUNC(in_upper_date_bound,'HH')
14:33:53 111  		UNION
14:33:53 112  		SELECT li2.id
14:33:53 113  		      FROM
14:33:53 114  			   line_item li2
14:33:53 115  		      JOIN invoice i2 ON i2.id = li2.invoice_id
14:33:53 116  		      JOIN charge c2 ON i2.id = c2.invoice_id
14:33:53 117  		      WHERE
14:33:53 118  		      TRUNC(c2.create_date, 'HH') BETWEEN TRUNC(in_lower_date_bound,'HH') AND TRUNC(in_upper_date_bound,'HH')
14:33:53 119  		UNION
14:33:53 120  		SELECT li2.id
14:33:53 121  		      FROM
14:33:53 122  			   line_item li2
14:33:53 123  		      JOIN invoice i2 ON i2.id = li2.invoice_id
14:33:53 124  		      JOIN charge c2 ON i2.id = c2.invoice_id
14:33:53 125  		      JOIN transaction t2 ON t2.id = c2.transaction_id
14:33:53 126  		      WHERE
14:33:53 127  		      TRUNC(t2.create_date, 'HH') BETWEEN TRUNC(in_lower_date_bound,'HH') AND TRUNC(in_upper_date_bound,'HH')
14:33:53 128  	  )
14:33:53 129  	  SELECT distinct
14:33:53 130  	    line_item.id				 line_item_id
14:33:53 131  	  , product.name				 product_name
14:33:53 132  	  , product.unit_price				 product_unit_price
14:33:53 133  	  , product.production_cost			 product_production_cost
14:33:53 134  	  , offer_chain.name				 offer_chain_name
14:33:53 135  	  , offer_chain_meta_data.value 		 offer_chain_metadata
14:33:53 136  	  , gclicense.purchase_date			 subscription_start_date
14:33:53 137  	  , gclicense.start_date			 license_start_date
14:33:53 138  	  , gclicense.end_date				 license_end_date
14:33:53 139  	  , credit_card.city				 cc_city
14:33:53 140  	  , credit_card.state				 cc_state
14:33:53 141  	  , credit_card.postal_code			 cc_postal_code
14:33:53 142  	  , line_item.create_date			 line_item_purchase_date
14:33:53 143  	  , gclicense.account_regi_id
14:33:53 144  	  , product_offering.quantity			 purchase_quantity
14:33:53 145  	  , case when charge.charge_amount > 0 then charge.charge_amount else 0 end purchase_amount
14:33:53 146  	  , PROCS_REPORTING_1A.getDiscountAmount(line_item.id) discount_amount
14:33:53 147  	  , PROCS_REPORTING_1A.getRefundAmount(line_item.id) refund_amount
14:33:53 148  	  , decode(gclicense.sct_id,null,0, 1)		 is_refund_cancel
14:33:53 149  	  , 0						 purchase_tax_amount
14:33:53 150  	  , transaction_attempt.external_transaction_id  external_transaction_id
14:33:53 151  	  , invoice.id					 invoice_number
14:33:53 152  	  , NVL2(transaction.id, 1, 0)			 has_transaction
14:33:53 153  	  , NVL2(credit_card.id, 1, 0)			 is_cc_transaction
14:33:53 154  	  , NVL2(gift_certificate.id, 1, 0)		 is_gc_transaction
14:33:53 155  	  FROM
14:33:53 156  	       line_item
14:33:53 157  	  JOIN invoice				ON invoice.id	       = line_item.invoice_id
14:33:53 158  	  JOIN product_offering 		ON product_offering.id = line_item.product_offer_id
14:33:53 159  	  JOIN product				ON product.id	       = product_offering.product_id
14:33:53 160  	  join (
14:33:53 161  		select license.invoice_id, subscription.offer_chain_id, subscription.purchase_date
14:33:53 162  		      ,subscription.sct_id, license.start_date, license.end_date
14:33:53 163  		      ,account.group_id account_regi_id
14:33:53 164  		from	 license
14:33:53 165  		    join subscription ON subscription.id = license.subscription_id
14:33:53 166  		    join account      ON account.id	 = subscription.account_id
14:33:53 167  		union all
14:33:53 168  		select gc.purchase_invoice_id invoice_id, gc.offer_chain_id, gc.purchase_date
14:33:53 169  		      ,null sct_id, gc.purchase_date start_date, gc.expiration_date end_date
14:33:53 170  		      ,gc.purchaser_group_id account_regi_id
14:33:53 171  		from	 gift_certificate gc
14:33:53 172  		where
14:33:53 173  		      TRUNC(gc.create_date, 'HH') between TRUNC(in_lower_date_bound,'HH') AND TRUNC(in_upper_date_bound,'HH')
14:33:53 174  
14:33:53 175  	  ) gclicense
14:33:53 176  						on gclicense.invoice_id = invoice.id
14:33:53 177  	  JOIN offer_chain			ON offer_chain.id      = gclicense.offer_chain_id
14:33:53 178  	  JOIN charge				ON invoice.id	       = charge.invoice_id and charge.charge_status_id = 2
14:33:53 179  	  JOIN transaction			ON transaction.id      = charge.transaction_id and transaction.transaction_status_id = 2
14:33:53 180  	  JOIN transaction_attempt		ON transaction.id	= transaction_attempt.transaction_id AND transaction_attempt.transaction_attempt_status_id = 2
14:33:53 181  	  LEFT OUTER JOIN credit_card		ON charge.instrument_id = credit_card.id AND charge.instrument_type_id = 1
14:33:53 182  	  LEFT OUTER JOIN gift_certificate	ON charge.instrument_id = gift_certificate.id AND charge.instrument_type_id = 3
14:33:53 183  	  LEFT OUTER JOIN offer_chain_meta_data ON offer_chain.id	= offer_chain_meta_data.offer_chain_id
14:33:53 184  	  join liq				on line_item.id 	= liq.id
14:33:53 185  	    ;
14:33:53 186  	END EXTRACT_LINE_ITEMS;
14:33:53 187  ----
14:33:53 188  --------------------------------------------------------------------------------
14:33:53 189  ----
14:33:53 190  END PROCS_REPORTING_1A;
14:33:53 191  .
14:33:53 SQL> /

Package body created.

Elapsed: 00:00:00.03
14:33:53 SQL> 
14:33:53 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_REPORTS_V22" AS
14:33:53   2  
14:33:53   3  FUNCTION GET_PRODUCT_NAMES(
14:33:53   4  	in_offer_id IN NUMBER
14:33:53   5  ) RETURN VARCHAR2 AS
14:33:53   6  var_result_names VARCHAR2(1024);
14:33:53   7  BEGIN
14:33:53   8  
14:33:53   9  	var_result_names := NULL;
14:33:53  10  
14:33:53  11  	FOR f_product IN (
14:33:53  12  	  SELECT
14:33:53  13  	    PRODUCT.NAME
14:33:53  14  	  FROM
14:33:53  15  	    PRODUCT
14:33:53  16  	    INNER JOIN PRODUCT_OFFERING ON PRODUCT_OFFERING.PRODUCT_ID = PRODUCT.ID
14:33:53  17  	    INNER JOIN OFFER_PRODUCT_OFFERING ON OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID = PRODUCT_OFFERING.ID
14:33:53  18  	  WHERE
14:33:53  19  	    OFFER_PRODUCT_OFFERING.OFFER_ID = in_offer_id
14:33:53  20  	)
14:33:53  21  	LOOP
14:33:53  22  
14:33:53  23  	  IF var_result_names IS NULL THEN
14:33:53  24  	    var_result_names := f_product.NAME;
14:33:53  25  	  ELSE
14:33:53  26  	    var_result_names := var_result_names || ',' || CHR(13) || f_product.NAME;
14:33:53  27  	  END IF;
14:33:53  28  
14:33:53  29  	END LOOP;
14:33:53  30  
14:33:53  31  	RETURN var_result_names;
14:33:53  32  
14:33:53  33  END GET_PRODUCT_NAMES;
14:33:53  34  
14:33:53  35  /******************************************************************************/
14:33:53  36  
14:33:53  37  PROCEDURE GET_FULL_FLASH_REPORT_PURCH (
14:33:53  38  	in_start_date  IN DATE,
14:33:53  39  	in_end_date    IN DATE,
14:33:53  40  	out_result_set OUT SYS_REFCURSOR
14:33:53  41  ) AS
14:33:53  42  -- CONSTANTS
14:33:53  43  const_license_process_name CONSTANT VARCHAR2(9) := 'LICENSING';
14:33:53  44  BEGIN
14:33:53  45  
14:33:53  46  	OPEN out_result_set FOR
14:33:53  47  	SELECT
14:33:53  48  	  GET_PRODUCT_NAMES("Offer_Id") as "Product_Names",
14:33:53  49  	  "Offer_Id",
14:33:53  50  	  "New_Purchases_Num",
14:33:53  51  	  "Number_Of_renewals",
14:33:53  52  	  FLR_TOTAL_DOLLAR_VALUE("Offer_Id", in_start_date, in_end_date) as "Total_Dollar_Value",
14:33:53  53  	  FLR_UNIQUE_PURCHASERS("Offer_Id", in_start_date, in_end_date) as "Unique_Purchasers_num"
14:33:53  54  	FROM (
14:33:53  55  	  SELECT
14:33:53  56  	    "Offer_Id",
14:33:53  57  	    "Number_Of_renewals",
14:33:53  58  	    "New_Purchases_Num"
14:33:53  59  	  FROM (
14:33:53  60  	    SELECT
14:33:53  61  	      OFFER.ID as "Offer_Id",
14:33:53  62  	      FLR_RENEWALS_NUM(offer.id, in_start_date, in_end_date) as "Number_Of_renewals",
14:33:53  63  	      FLR_NEW_PURCHASERS_NUM(offer.id, in_start_date, in_end_date) as "New_Purchases_Num"
14:33:53  64  	    FROM
14:33:53  65  	      OFFER
14:33:53  66  	  )
14:33:53  67  	  WHERE
14:33:53  68  	    "New_Purchases_Num" > 0
14:33:53  69  	    OR "Number_Of_renewals" > 0
14:33:53  70  	);
14:33:53  71  
14:33:53  72  	/*
14:33:53  73  	OPEN out_result_set FOR
14:33:53  74  	SELECT
14:33:53  75  	  "Product_Names",
14:33:53  76  	  "Offer_Id",
14:33:53  77  	  "New_Purchases_Num",
14:33:53  78  	  "Number_Of_renewals",
14:33:53  79  	  "Total_Dollar_Value",
14:33:53  80  	  "Unique_Purchasers_num"
14:33:53  81  	FROM (
14:33:53  82  	  SELECT
14:33:53  83  	    GET_PRODUCT_NAMES(offer.id) as "Product_Names",
14:33:53  84  	    offer.id as "Offer_Id",
14:33:53  85  	    FLR_NEW_PURCHASERS_NUM(offer.id, in_start_date, in_end_date) as "New_Purchases_Num",
14:33:53  86  	    FLR_RENEWALS_NUM(offer.id, in_start_date, in_end_date) as "Number_Of_renewals",
14:33:53  87  	    FLR_TOTAL_DOLLAR_VALUE(offer.id, in_start_date, in_end_date) as "Total_Dollar_Value",
14:33:53  88  	    FLR_UNIQUE_PURCHASERS(offer.id, in_start_date, in_end_date) as "Unique_Purchasers_num"
14:33:53  89  	  FROM
14:33:53  90  	    OFFER
14:33:53  91  	)
14:33:53  92  	WHERE
14:33:53  93  	  "New_Purchases_Num" > 0
14:33:53  94  	  OR "Number_Of_renewals" > 0
14:33:53  95  	  OR "Total_Dollar_Value" > 0
14:33:53  96  	  OR "Unique_Purchasers_num" > 0;
14:33:53  97  	*/
14:33:53  98  
14:33:53  99  END GET_FULL_FLASH_REPORT_PURCH;
14:33:53 100  
14:33:53 101  /******************************************************************************/
14:33:53 102  
14:33:53 103  PROCEDURE GET_FLASH_REPORT_PURCHASES (
14:33:53 104  	in_offer_id	       IN NUMBER,
14:33:53 105  	in_start_date	       IN DATE,
14:33:53 106  	in_end_date	       IN DATE,
14:33:53 107  	out_new_purchasers_num OUT NUMBER,
14:33:53 108  	out_renewals_num       OUT NUMBER,
14:33:53 109  	out_product_names      OUT VARCHAR2,
14:33:53 110  	out_total_dollar_value OUT NUMBER,
14:33:53 111  	out_unique_purchasers  OUT NUMBER
14:33:53 112  ) AS
14:33:53 113  -- CONSTANTS
14:33:53 114  const_license_process_name CONSTANT VARCHAR2(9) := 'LICENSING';
14:33:53 115  BEGIN
14:33:53 116  
14:33:53 117  	out_product_names := GET_PRODUCT_NAMES(in_offer_id);
14:33:53 118  
14:33:53 119  	out_total_dollar_value := FLR_TOTAL_DOLLAR_VALUE(
14:33:53 120  	  in_offer_id,
14:33:53 121  	  in_start_date,
14:33:53 122  	  in_end_date
14:33:53 123  	);
14:33:53 124  
14:33:53 125  	out_new_purchasers_num := FLR_NEW_PURCHASERS_NUM(
14:33:53 126  	  in_offer_id,
14:33:53 127  	  in_start_date,
14:33:53 128  	  in_end_date
14:33:53 129  	);
14:33:53 130  
14:33:53 131  	out_renewals_num := FLR_RENEWALS_NUM(
14:33:53 132  	  in_offer_id,
14:33:53 133  	  in_start_date,
14:33:53 134  	  in_end_date
14:33:53 135  	);
14:33:53 136  
14:33:53 137  	out_unique_purchasers := FLR_UNIQUE_PURCHASERS(
14:33:53 138  	  in_offer_id,
14:33:53 139  	  in_start_date,
14:33:53 140  	  in_end_date
14:33:53 141  	);
14:33:53 142  
14:33:53 143  END GET_FLASH_REPORT_PURCHASES;
14:33:53 144  
14:33:53 145  /******************************************************************************/
14:33:53 146  
14:33:53 147  FUNCTION FLR_NEW_PURCHASERS_NUM (
14:33:53 148  	in_offer_id	       IN NUMBER,
14:33:53 149  	in_start_date	       IN DATE,
14:33:53 150  	in_end_date	       IN DATE
14:33:53 151  ) RETURN NUMBER AS
14:33:53 152  -- CONSTANTS
14:33:53 153  const_license_process_name CONSTANT VARCHAR2(9) := 'LICENSING';
14:33:53 154  -- VARIABLES
14:33:53 155  var_new_purchases_num NUMBER;
14:33:53 156  BEGIN
14:33:53 157  	SELECT
14:33:53 158  	  COUNT(LICENSE.ID)
14:33:53 159  	  into
14:33:53 160  	  var_new_purchases_num
14:33:53 161  	FROM
14:33:53 162  	  LICENSE
14:33:53 163  	  INNER JOIN CHARGE ON LICENSE.INVOICE_ID = CHARGE.INVOICE_ID
14:33:53 164  	WHERE
14:33:53 165  	  LICENSE.CREATED_BY NOT LIKE const_license_process_name
14:33:53 166  	  AND LICENSE.OFFER_ID = in_offer_id
14:33:53 167  	  AND CHARGE.CHARGE_AMOUNT > 0
14:33:53 168  	  AND PROCS_CHARGE_V22.IS_CHARGE_COLLECTED(CHARGE.ID) = 1 -- GLOBAL_CONSTANTS_V22.TRUE
14:33:53 169  	  AND LICENSE.START_DATE BETWEEN in_start_date AND in_end_date;
14:33:53 170  
14:33:53 171  	RETURN var_new_purchases_num;
14:33:53 172  END FLR_NEW_PURCHASERS_NUM;
14:33:53 173  
14:33:53 174  /******************************************************************************/
14:33:53 175  
14:33:53 176  FUNCTION FLR_RENEWALS_NUM (
14:33:53 177  	in_offer_id	       IN NUMBER,
14:33:53 178  	in_start_date	       IN DATE,
14:33:53 179  	in_end_date	       IN DATE
14:33:53 180  ) RETURN NUMBER AS
14:33:53 181  -- CONSTANTS
14:33:53 182  const_license_process_name CONSTANT VARCHAR2(9) := 'LICENSING';
14:33:53 183  -- VARIABLES
14:33:53 184  var_renewals_num NUMBER;
14:33:53 185  BEGIN
14:33:53 186  	SELECT
14:33:53 187  	  COUNT(LICENSE.ID)
14:33:53 188  	  into
14:33:53 189  	  var_renewals_num
14:33:53 190  	FROM
14:33:53 191  	  LICENSE
14:33:53 192  	  INNER JOIN CHARGE ON LICENSE.INVOICE_ID = CHARGE.INVOICE_ID
14:33:53 193  	WHERE
14:33:53 194  	  LICENSE.CREATED_BY LIKE const_license_process_name
14:33:53 195  	  AND LICENSE.OFFER_ID = in_offer_id
14:33:53 196  	  AND CHARGE.CHARGE_AMOUNT > 0
14:33:53 197  	  AND PROCS_CHARGE_V22.IS_CHARGE_COLLECTED(CHARGE.ID) = 1 -- GLOBAL_CONSTANTS_V22.TRUE
14:33:53 198  	  AND LICENSE.START_DATE BETWEEN in_start_date AND in_end_date;
14:33:53 199  
14:33:53 200  	RETURN var_renewals_num;
14:33:53 201  END FLR_RENEWALS_NUM;
14:33:53 202  
14:33:53 203  /******************************************************************************/
14:33:53 204  
14:33:53 205  FUNCTION FLR_TOTAL_DOLLAR_VALUE (
14:33:53 206  	in_offer_id	       IN NUMBER,
14:33:53 207  	in_start_date	       IN DATE,
14:33:53 208  	in_end_date	       IN DATE
14:33:53 209  ) RETURN NUMBER AS
14:33:53 210  var_dollar_value NUMBER(10,2);
14:33:53 211  BEGIN
14:33:53 212  	SELECT
14:33:53 213  	  SUM(CHARGE.CHARGE_AMOUNT)
14:33:53 214  	  into
14:33:53 215  	  var_dollar_value
14:33:53 216  	FROM
14:33:53 217  	  LICENSE
14:33:53 218  	  INNER JOIN CHARGE ON LICENSE.INVOICE_ID = CHARGE.INVOICE_ID
14:33:53 219  	WHERE
14:33:53 220  	  LICENSE.OFFER_ID = in_offer_id
14:33:53 221  	  AND CHARGE.CHARGE_AMOUNT > 0
14:33:53 222  	  AND PROCS_CHARGE_V22.IS_CHARGE_COLLECTED(CHARGE.ID) = 1 -- GLOBAL_CONSTANTS_V22.TRUE
14:33:53 223  	  AND LICENSE.START_DATE BETWEEN in_start_date AND in_end_date;
14:33:53 224  
14:33:53 225  	RETURN var_dollar_value;
14:33:53 226  END FLR_TOTAL_DOLLAR_VALUE;
14:33:53 227  
14:33:53 228  /******************************************************************************/
14:33:53 229  
14:33:53 230  FUNCTION FLR_UNIQUE_PURCHASERS (
14:33:53 231  	in_offer_id	       IN NUMBER,
14:33:53 232  	in_start_date	       IN DATE,
14:33:53 233  	in_end_date	       IN DATE
14:33:53 234  ) RETURN NUMBER AS
14:33:53 235  -- CONSTANTS
14:33:53 236  const_license_process_name CONSTANT VARCHAR2(9) := 'LICENSING';
14:33:53 237  -- VARIABLES
14:33:53 238  var_unique_purchasers NUMBER;
14:33:53 239  BEGIN
14:33:53 240  	SELECT
14:33:53 241  	  COUNT(DISTINCT SUBSCRIPTION.ACCOUNT_ID) into var_unique_purchasers
14:33:53 242  	FROM
14:33:53 243  	  LICENSE
14:33:53 244  	  INNER JOIN CHARGE ON LICENSE.INVOICE_ID = CHARGE.INVOICE_ID
14:33:53 245  	  INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
14:33:53 246  	WHERE
14:33:53 247  	  LICENSE.CREATED_BY NOT LIKE const_license_process_name
14:33:53 248  	  AND LICENSE.OFFER_ID = in_offer_id
14:33:53 249  	  AND CHARGE.CHARGE_AMOUNT > 0
14:33:53 250  	  AND PROCS_CHARGE_V22.IS_CHARGE_COLLECTED(CHARGE.ID) = 1 -- GLOBAL_CONSTANTS_V22.TRUE
14:33:53 251  	  AND LICENSE.START_DATE BETWEEN in_start_date AND in_end_date;
14:33:53 252  
14:33:53 253  	RETURN var_unique_purchasers;
14:33:53 254  END;
14:33:53 255  
14:33:53 256  END PROCS_REPORTS_V22;
14:33:53 257  .
14:33:53 SQL> /

Package body created.

Elapsed: 00:00:00.04
14:33:53 SQL> 
14:33:53 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_SYSTEM_V22" AS
14:33:53   2  
14:33:53   3  PROCEDURE INCREMENT_VERSION
14:33:53   4  /*
14:33:53   5  Throws exceptions:
14:33:53   6  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53   7  */
14:33:53   8  AS
14:33:53   9  BEGIN
14:33:53  10  
14:33:53  11  	UPDATE SYS_VERSION SET version=version+1;
14:33:53  12  
14:33:53  13  END INCREMENT_VERSION;
14:33:53  14  
14:33:53  15  /*************************************************************/
14:33:53  16  
14:33:53  17  PROCEDURE CHECK_VERSION(
14:33:53  18  	  in_vers    IN NUMBER,
14:33:53  19  	  out_result OUT NUMBER
14:33:53  20  ) AS
14:33:53  21  	current_version NUMBER;
14:33:53  22  BEGIN
14:33:53  23  	SELECT version INTO current_version FROM SYS_VERSION;
14:33:53  24  	IF(current_version != in_vers) THEN
14:33:53  25  	  out_result := 1;
14:33:53  26  	ELSE
14:33:53  27  	  out_result := 0;
14:33:53  28  	END IF;
14:33:53  29  END CHECK_VERSION;
14:33:53  30  
14:33:53  31  END PROCS_SYSTEM_V22;
14:33:53  32  .
14:33:53 SQL> /

Package body created.

Elapsed: 00:00:00.02
14:33:53 SQL> 
14:33:53 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_TAXES_V22" AS
14:33:53   2  
14:33:53   3  PROCEDURE ADD_TAX (
14:33:53   4  	in_tax_type_id		 IN NUMBER,
14:33:53   5  	in_calculated_amount	 IN NUMBER,
14:33:53   6  	in_created_by		 IN VARCHAR2,
14:33:53   7  	in_line_item_id 	 IN NUMBER,
14:33:53   8  	in_effective_rate	 IN VARCHAR2,
14:33:53   9  	in_taxable_amount	 IN NUMBER,
14:33:53  10  	in_tax_rule_id		 IN NUMBER,
14:33:53  11  	in_jurisdiction_level_id IN NUMBER,
14:33:53  12  	in_jurisdiction_name	 IN VARCHAR2,
14:33:53  13  	in_jurisdiction_id	 IN VARCHAR2,
14:33:53  14  	in_ext_tax_type 	 IN VARCHAR2,
14:33:53  15  	in_ext_result		 IN VARCHAR2,
14:33:53  16  	in_imposition_type	 IN VARCHAR2,
14:33:53  17  	in_imposition		 IN VARCHAR2
14:33:53  18  ) AS
14:33:53  19  SPROC_NAME CONSTANT VARCHAR2(7) := 'ADD_TAX';
14:33:53  20  -- VARIABLES
14:33:53  21  var_new_tax_id	NUMBER;
14:33:53  22  temp_line_item_id NUMBER;
14:33:53  23  -- EXCEPTIONS
14:33:53  24  BAD_LINE_ITEM_ID EXCEPTION;
14:33:53  25  BEGIN
14:33:53  26  
14:33:53  27  	BEGIN
14:33:53  28  	  SELECT
14:33:53  29  	    LINE_ITEM.ID into temp_line_item_id
14:33:53  30  	  FROM
14:33:53  31  	    LINE_ITEM
14:33:53  32  	  WHERE
14:33:53  33  	    LINE_ITEM.ID = in_line_item_id;
14:33:53  34  	  EXCEPTION
14:33:53  35  	    WHEN NO_DATA_FOUND THEN
14:33:53  36  	      RAISE BAD_LINE_ITEM_ID;
14:33:53  37  	END;
14:33:53  38  
14:33:53  39  	var_new_tax_id := NULL;
14:33:53  40  
14:33:53  41  	PROCS_TAXES_CRU_V22.CREATE_TAX(
14:33:53  42  	  var_new_tax_id,
14:33:53  43  	  in_tax_type_id,
14:33:53  44  	  in_calculated_amount,
14:33:53  45  	  in_created_by,
14:33:53  46  	  in_line_item_id,
14:33:53  47  	  in_effective_rate,
14:33:53  48  	  in_taxable_amount,
14:33:53  49  	  in_tax_rule_id,
14:33:53  50  	  in_jurisdiction_level_id,
14:33:53  51  	  in_jurisdiction_name,
14:33:53  52  	  in_jurisdiction_id,
14:33:53  53  	  in_ext_tax_type,
14:33:53  54  	  in_ext_result,
14:33:53  55  	  in_imposition_type,
14:33:53  56  	  in_imposition
14:33:53  57  	);
14:33:53  58  
14:33:53  59  EXCEPTION
14:33:53  60  WHEN BAD_LINE_ITEM_ID THEN
14:33:53  61  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53  62  	  SPROC_NAME, 'No such line item');
14:33:53  63  WHEN OTHERS THEN
14:33:53  64  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53  65  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53  66  END ADD_TAX;
14:33:53  67  
14:33:53  68  /******************************************************************************/
14:33:53  69  
14:33:53  70  PROCEDURE CHECK_COUNTRY_FOR_EXCLUSION (
14:33:53  71  	in_country_code IN CHAR,
14:33:53  72  	in_check_date IN DATE,
14:33:53  73  	out_is_founded	OUT NUMBER -- GLOBAL_CONSTANT.TRUE of GLOBAL_CONSTANTS_V22.FALSE
14:33:53  74  ) AS
14:33:53  75  SPROC_NAME CONSTANT VARCHAR2(27) := 'CHECK_COUNTRY_FOR_EXCLUSION';
14:33:53  76  -- VARIABLES
14:33:53  77  var_countries_count NUMBER;
14:33:53  78  var_result	  NUMBER;
14:33:53  79  BEGIN
14:33:53  80  
14:33:53  81  	SELECT
14:33:53  82  	  COUNT(1) into var_countries_count
14:33:53  83  	FROM
14:33:53  84  	  TAX_COUNTRY_EXCLUSION_LIST
14:33:53  85  	WHERE
14:33:53  86  	  country_code = in_country_code
14:33:53  87  	  AND TRUNC(EFFECTIVE_DATE) <= TRUNC(in_check_date)
14:33:53  88  	  AND (
14:33:53  89  	    end_date is null
14:33:53  90  	    OR TRUNC(END_DATE) >= TRUNC(in_check_date)
14:33:53  91  	  );
14:33:53  92  
14:33:53  93  	IF var_countries_count > 1 THEN
14:33:53  94  	  -- [REVU] Should not happen. DB structure error
14:33:53  95  	  var_result := GLOBAL_CONSTANTS_V22.TRUE;
14:33:53  96  	ELSIF var_countries_count = 1 THEN
14:33:53  97  	  var_result := GLOBAL_CONSTANTS_V22.TRUE;
14:33:53  98  	ELSE
14:33:53  99  	  var_result := GLOBAL_CONSTANTS_V22.FALSE;
14:33:53 100  	END IF;
14:33:53 101  
14:33:53 102  	out_is_founded := var_result;
14:33:53 103  
14:33:53 104  EXCEPTION
14:33:53 105  WHEN OTHERS THEN
14:33:53 106  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 107  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 108  END CHECK_COUNTRY_FOR_EXCLUSION;
14:33:53 109  
14:33:53 110  /******************************************************************************/
14:33:53 111  
14:33:53 112  PROCEDURE GET_TAX_CATEGORY (
14:33:53 113  	in_tax_category_id IN NUMBER,
14:33:53 114  	out_result_set	   OUT SYS_REFCURSOR
14:33:53 115  ) AS
14:33:53 116  SPROC_NAME CONSTANT VARCHAR2(16) := 'GET_TAX_CATEGORY';
14:33:53 117  BEGIN
14:33:53 118  
14:33:53 119  	OPEN out_result_set FOR
14:33:53 120  	SELECT
14:33:53 121  	  ID,
14:33:53 122  	  CODE,
14:33:53 123  	  DESCRIPTION
14:33:53 124  	FROM
14:33:53 125  	  TAX_CATEGORY
14:33:53 126  	WHERE
14:33:53 127  	  ID = in_tax_category_id;
14:33:53 128  
14:33:53 129  EXCEPTION
14:33:53 130  WHEN OTHERS THEN
14:33:53 131  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 132  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 133  END GET_TAX_CATEGORY;
14:33:53 134  
14:33:53 135  END PROCS_TAXES_V22;
14:33:53 136  .
14:33:53 SQL> /

Package body created.

Elapsed: 00:00:00.02
14:33:53 SQL> 
14:33:53 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_TRANSACTION_V22" AS
14:33:53   2  
14:33:53   3  PROCEDURE CREATE_TRANSACTION (
14:33:53   4  /*
14:33:53   5  Throws exceptions:
14:33:53   6  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53   7  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53   8  */
14:33:53   9  	in_transaction_id	  IN NUMBER,
14:33:53  10  	in_status_id		  IN NUMBER,
14:33:53  11  	in_amount		  IN NUMBER,
14:33:53  12  	in_created_by		  IN VARCHAR2,
14:33:53  13  	in_order_id		  IN VARCHAR2,
14:33:53  14  	in_is_refund		  IN NUMBER DEFAULT GLOBAL_CONSTANTS_V22.FALSE,
14:33:53  15  	in_transaction_type_code  IN VARCHAR2 DEFAULT NULL,
14:33:53  16  	out_transaction_id	  OUT NUMBER
14:33:53  17  ) AS
14:33:53  18  -- VARIABLES
14:33:53  19  SPROC_NAME	     CONSTANT VARCHAR2(18) := 'CREATE_TRANSACTION';
14:33:53  20  var_transaction_count  NUMBER;
14:33:53  21  -- EXCEPTIONS
14:33:53  22  BAD_TRANSACTION_ID     EXCEPTION;
14:33:53  23  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:53  24  BEGIN
14:33:53  25  
14:33:53  26  	IF in_transaction_id IS NOT NULL THEN
14:33:53  27  	  SELECT
14:33:53  28  	    COUNT(*) into var_transaction_count
14:33:53  29  	  FROM
14:33:53  30  	    TRANSACTION
14:33:53  31  	  WHERE
14:33:53  32  	    TRANSACTION.ID = in_transaction_id;
14:33:53  33  	  IF var_transaction_count > 0 THEN
14:33:53  34  	    RAISE BAD_TRANSACTION_ID;
14:33:53  35  	  END IF;
14:33:53  36  	END IF;
14:33:53  37  
14:33:53  38  	PROCS_TRANSACTION_CRU_V22.CREATE_TRANSACTION(
14:33:53  39  	  out_transaction_id	   => out_transaction_id,
14:33:53  40  	  in_transaction_id	   => in_transaction_id,
14:33:53  41  	  in_transaction_status_id => in_status_id,
14:33:53  42  	  in_transaction_amount    => in_amount,
14:33:53  43  	  in_created_by 	   => in_created_by,
14:33:53  44  	  in_order_id		   => in_order_id,
14:33:53  45  	  in_is_refund		   => in_is_refund,
14:33:53  46  	  in_transaction_type_code => in_transaction_type_code
14:33:53  47  	);
14:33:53  48  
14:33:53  49  EXCEPTION
14:33:53  50  WHEN BAD_TRANSACTION_ID THEN
14:33:53  51  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.DUPLICATE_ERROR,
14:33:53  52  	  SPROC_NAME, 'Transaction with given id already exists');
14:33:53  53  WHEN OTHERS THEN
14:33:53  54  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53  55  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53  56  END CREATE_TRANSACTION;
14:33:53  57  
14:33:53  58  /******************************************************************************/
14:33:53  59  
14:33:53  60  PROCEDURE CREATE_TRANSACTION_ATTEMPT (
14:33:53  61  /*
14:33:53  62  Throws exceptions:
14:33:53  63  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53  64  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53  65  */
14:33:53  66  	in_transaction_id	   IN NUMBER,
14:33:53  67  	in_trans_attempt_status    IN NUMBER,
14:33:53  68  	in_external_status_code    IN VARCHAR2,
14:33:53  69  	in_external_status_message IN VARCHAR2,
14:33:53  70  	in_created_by		   IN VARCHAR2,
14:33:53  71  	in_ext_transaction_id	   IN VARCHAR2,
14:33:53  72  	out_transaction_attempt_id OUT NUMBER
14:33:53  73  ) AS
14:33:53  74  -- VARIABLES
14:33:53  75  SPROC_NAME		 CONSTANT VARCHAR2(26) := 'CREATE_TRANSACTION_ATTEMPT';
14:33:53  76  var_transaction_create_date DATE;
14:33:53  77  var_transaction_attempt_id  NUMBER;
14:33:53  78  
14:33:53  79  -- EXCEPTIONS
14:33:53  80  BAD_TRANS_ATTEMPT_STATUS EXCEPTION;
14:33:53  81  BAD_TRANSACTION_ID       EXCEPTION;
14:33:53  82  BEGIN
14:33:53  83  
14:33:53  84  	-- Check that transaction exists
14:33:53  85  	BEGIN
14:33:53  86  	  SELECT
14:33:53  87  	    TRANSACTION.CREATE_DATE into var_transaction_create_date
14:33:53  88  	  FROM
14:33:53  89  	    TRANSACTION
14:33:53  90  	  WHERE
14:33:53  91  	    TRANSACTION.ID = in_transaction_id;
14:33:53  92  	  EXCEPTION
14:33:53  93  	    WHEN OTHERS THEN
14:33:53  94  	      RAISE BAD_TRANSACTION_ID;
14:33:53  95  	END;
14:33:53  96  
14:33:53  97  	-- Check that transaction status is correct
14:33:53  98  	IF in_trans_attempt_status != GLOBAL_STATUSES_V22.TRANS_ATTEMPT_IN_PROGRESS
14:33:53  99  	  AND in_trans_attempt_status != GLOBAL_STATUSES_V22.TRANS_ATTEMPT_SUCCESS
14:33:53 100  	  AND in_trans_attempt_status != GLOBAL_STATUSES_V22.TRANS_ATTEMPT_FAILED THEN
14:33:53 101  	  RAISE BAD_TRANS_ATTEMPT_STATUS;
14:33:53 102  	END IF;
14:33:53 103  
14:33:53 104  	var_transaction_attempt_id := NULL;
14:33:53 105  	PROCS_TRANSACTION_CRU_V22.CREATE_TRANSACTION_ATTEMPT(
14:33:53 106  	  inout_transaction_attempt_id => var_transaction_attempt_id,
14:33:53 107  	  in_transaction_id	       => in_transaction_id,
14:33:53 108  	  in_external_status_code      => in_external_status_code,
14:33:53 109  	  in_external_status_message   => in_external_status_message,
14:33:53 110  	  in_created_by 	       => in_created_by,
14:33:53 111  	  in_external_transaction_id   => in_ext_transaction_id,
14:33:53 112  	  in_transaction_start_time    => var_transaction_create_date,
14:33:53 113  	  in_status_id		       => in_trans_attempt_status
14:33:53 114  	);
14:33:53 115  
14:33:53 116  	PROCS_TRANSACTION_CRU_V22.UPDATE_TRANSACTION(
14:33:53 117  	  in_transaction_id => in_transaction_id,
14:33:53 118  	  in_updated_by     => in_created_by
14:33:53 119  	);
14:33:53 120  
14:33:53 121  	out_transaction_attempt_id := var_transaction_attempt_id;
14:33:53 122  
14:33:53 123  EXCEPTION
14:33:53 124  WHEN BAD_TRANSACTION_ID THEN
14:33:53 125  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 126  	  SPROC_NAME, 'No such transaction');
14:33:53 127  WHEN BAD_TRANS_ATTEMPT_STATUS THEN
14:33:53 128  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:53 129  	  SPROC_NAME, 'Bad transaction attempt status');
14:33:53 130  WHEN OTHERS THEN
14:33:53 131  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 132  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 133  END CREATE_TRANSACTION_ATTEMPT;
14:33:53 134  
14:33:53 135  /******************************************************************************/
14:33:53 136  
14:33:53 137  PROCEDURE UPDATE_TRANSACTION_STATUS (
14:33:53 138  /*
14:33:53 139  Throws exceptions:
14:33:53 140  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 141  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 142  */
14:33:53 143  	in_transaction_id	 IN NUMBER,
14:33:53 144  	in_updated_by		 IN VARCHAR2,
14:33:53 145  	in_transaction_status_id IN NUMBER
14:33:53 146  ) AS
14:33:53 147  -- VARIABLES
14:33:53 148  SPROC_NAME	  CONSTANT VARCHAR2(25) := 'UPDATE_TRANSACTION_STATUS';
14:33:53 149  temp_transaction_id NUMBER;
14:33:53 150  
14:33:53 151  -- EXCEPTIONS
14:33:53 152  BAD_TRANSACTION_ID     EXCEPTION;
14:33:53 153  BAD_TRANSACTION_STATUS EXCEPTION;
14:33:53 154  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:53 155  BEGIN
14:33:53 156  
14:33:53 157  	-- Check that transaction exists
14:33:53 158  	BEGIN
14:33:53 159  	  SELECT
14:33:53 160  	    TRANSACTION.ID into temp_transaction_id
14:33:53 161  	  FROM
14:33:53 162  	    TRANSACTION
14:33:53 163  	  WHERE
14:33:53 164  	    TRANSACTION.ID = in_transaction_id;
14:33:53 165  	  EXCEPTION
14:33:53 166  	    WHEN OTHERS THEN
14:33:53 167  	      RAISE BAD_TRANSACTION_ID;
14:33:53 168  	END;
14:33:53 169  
14:33:53 170  	-- Check that transaction status is correct
14:33:53 171  	IF    in_transaction_status_id != GLOBAL_STATUSES_V22.TRANSACTION_PENDING
14:33:53 172  	  AND in_transaction_status_id != GLOBAL_STATUSES_V22.TRANSACTION_CLOSED
14:33:53 173  	  AND in_transaction_status_id != GLOBAL_STATUSES_V22.TRANSACTION_CHARGEBACK
14:33:53 174  	  AND in_transaction_status_id != GLOBAL_STATUSES_V22.TRANSACTION_DECLINED THEN
14:33:53 175  	  RAISE BAD_TRANSACTION_STATUS;
14:33:53 176  	END IF;
14:33:53 177  
14:33:53 178  	PROCS_TRANSACTION_CRU_V22.UPDATE_TRANSACTION(
14:33:53 179  	  in_transaction_id	   => in_transaction_id,
14:33:53 180  	  in_updated_by 	   => in_updated_by,
14:33:53 181  	  in_transaction_status_id => in_transaction_status_id
14:33:53 182  	);
14:33:53 183  
14:33:53 184  EXCEPTION
14:33:53 185  WHEN BAD_TRANSACTION_ID THEN
14:33:53 186  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 187  	  SPROC_NAME, 'No such transaction');
14:33:53 188  WHEN BAD_TRANSACTION_STATUS THEN
14:33:53 189  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:53 190  	  SPROC_NAME, 'Bad transaction status');
14:33:53 191  WHEN OTHERS THEN
14:33:53 192  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 193  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 194  END UPDATE_TRANSACTION_STATUS;
14:33:53 195  
14:33:53 196  /******************************************************************************/
14:33:53 197  
14:33:53 198  PROCEDURE UPDATE_TRANSACTION_SETTLED (
14:33:53 199  /*
14:33:53 200  Throws exceptions:
14:33:53 201  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 202  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 203  */
14:33:53 204  	in_transaction_id	 IN NUMBER,
14:33:53 205  	in_updated_by		 IN VARCHAR2,
14:33:53 206  	in_is_settled		 IN NUMBER
14:33:53 207  ) AS
14:33:53 208  -- VARIABLES
14:33:53 209  SPROC_NAME	  CONSTANT VARCHAR2(26) := 'UPDATE_TRANSACTION_SETTLED';
14:33:53 210  temp_transaction_id NUMBER;
14:33:53 211  
14:33:53 212  -- EXCEPTIONS
14:33:53 213  BAD_TRANSACTION_ID     EXCEPTION;
14:33:53 214  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:53 215  BEGIN
14:33:53 216  
14:33:53 217  	-- Check that transaction exists
14:33:53 218  	BEGIN
14:33:53 219  	  SELECT
14:33:53 220  	    TRANSACTION.ID into temp_transaction_id
14:33:53 221  	  FROM
14:33:53 222  	    TRANSACTION
14:33:53 223  	  WHERE
14:33:53 224  	    TRANSACTION.ID = in_transaction_id;
14:33:53 225  	  EXCEPTION
14:33:53 226  	    WHEN OTHERS THEN
14:33:53 227  	      RAISE BAD_TRANSACTION_ID;
14:33:53 228  	END;
14:33:53 229  
14:33:53 230  	PROCS_TRANSACTION_CRU_V22.UPDATE_TRANSACTION(
14:33:53 231  	  in_transaction_id	   => in_transaction_id,
14:33:53 232  	  in_updated_by 	   => in_updated_by,
14:33:53 233  	  in_is_settled 	   => in_is_settled
14:33:53 234  	);
14:33:53 235  
14:33:53 236  EXCEPTION
14:33:53 237  WHEN BAD_TRANSACTION_ID THEN
14:33:53 238  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 239  	  SPROC_NAME, 'No such transaction');
14:33:53 240  WHEN OTHERS THEN
14:33:53 241  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 242  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 243  END UPDATE_TRANSACTION_SETTLED;
14:33:53 244  
14:33:53 245  /******************************************************************************/
14:33:53 246  
14:33:53 247  PROCEDURE UPDATE_TRNSCTN_ATTEMPT_TIME (
14:33:53 248  /*
14:33:53 249  Throws exceptions:
14:33:53 250  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 251  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 252  */
14:33:53 253  	in_transaction_attempt_id IN NUMBER,
14:33:53 254  	in_updated_by		  IN VARCHAR2
14:33:53 255  ) AS
14:33:53 256  SPROC_NAME CONSTANT VARCHAR2(27) := 'UPDATE_TRNSCTN_ATTEMPT_TIME';
14:33:53 257  -- VARIABLES
14:33:53 258  var_transaction_id NUMBER;
14:33:53 259  -- EXCEPTION
14:33:53 260  BAD_TRANSACTION_ATTEMPT_ID EXCEPTION;
14:33:53 261  BEGIN
14:33:53 262  
14:33:53 263  	BEGIN
14:33:53 264  	  SELECT
14:33:53 265  	    TRANSACTION_ATTEMPT.TRANSACTION_ID into var_transaction_id
14:33:53 266  	  FROM
14:33:53 267  	    TRANSACTION_ATTEMPT
14:33:53 268  	  WHERE
14:33:53 269  	    TRANSACTION_ATTEMPT.ID = in_transaction_attempt_id;
14:33:53 270  	  EXCEPTION
14:33:53 271  	    WHEN NO_DATA_FOUND THEN
14:33:53 272  	      RAISE BAD_TRANSACTION_ATTEMPT_ID;
14:33:53 273  	END;
14:33:53 274  
14:33:53 275  	PROCS_TRANSACTION_CRU_V22.UPDATE_TRANSACTION(
14:33:53 276  	  in_transaction_id => var_transaction_id,
14:33:53 277  	  in_updated_by     => in_updated_by
14:33:53 278  	);
14:33:53 279  
14:33:53 280  EXCEPTION
14:33:53 281  WHEN BAD_TRANSACTION_ATTEMPT_ID THEN
14:33:53 282  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 283  	  SPROC_NAME, 'No such transaction attempt');
14:33:53 284  WHEN OTHERS THEN
14:33:53 285  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 286  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 287  END UPDATE_TRNSCTN_ATTEMPT_TIME;
14:33:53 288  
14:33:53 289  /******************************************************************************/
14:33:53 290  
14:33:53 291  PROCEDURE UPDATE_TRNSCTN_ATTEMPT_STATUS (
14:33:53 292  /*
14:33:53 293  Throws exceptions:
14:33:53 294  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 295  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 296  */
14:33:53 297  	in_transaction_attempt_id     IN NUMBER,
14:33:53 298  	in_transaction_attempt_status IN NUMBER
14:33:53 299  ) AS
14:33:53 300  -- VARIABLES
14:33:53 301  SPROC_NAME		  CONSTANT VARCHAR2(29) := 'UPDATE_TRNSCTN_ATTEMPT_STATUS';
14:33:53 302  temp_transaction_attempt_id NUMBER;
14:33:53 303  
14:33:53 304  -- EXCEPTION
14:33:53 305  BAD_TRANSACTION_ATTEMPT_ID EXCEPTION;
14:33:53 306  BAD_TRANS_ATTEMPT_STATUS	 EXCEPTION;
14:33:53 307  BEGIN
14:33:53 308  
14:33:53 309  	-- Check that transaction attempt exists
14:33:53 310  	BEGIN
14:33:53 311  	  SELECT
14:33:53 312  	    TRANSACTION_ATTEMPT.ID into temp_transaction_attempt_id
14:33:53 313  	  FROM
14:33:53 314  	    TRANSACTION_ATTEMPT
14:33:53 315  	  WHERE
14:33:53 316  	    TRANSACTION_ATTEMPT.ID = in_transaction_attempt_id;
14:33:53 317  	  EXCEPTION
14:33:53 318  	    WHEN NO_DATA_FOUND THEN
14:33:53 319  	      RAISE BAD_TRANSACTION_ATTEMPT_ID;
14:33:53 320  	END;
14:33:53 321  
14:33:53 322  	-- Check that transaction attempt is correct
14:33:53 323  	IF in_transaction_attempt_status != GLOBAL_STATUSES_V22.TRANS_ATTEMPT_IN_PROGRESS
14:33:53 324  	  AND in_transaction_attempt_status != GLOBAL_STATUSES_V22.TRANS_ATTEMPT_SUCCESS
14:33:53 325  	  AND in_transaction_attempt_status != GLOBAL_STATUSES_V22.TRANS_ATTEMPT_FAILED THEN
14:33:53 326  	  RAISE BAD_TRANS_ATTEMPT_STATUS;
14:33:53 327  	END IF;
14:33:53 328  
14:33:53 329  	PROCS_TRANSACTION_CRU_V22.UPDATE_TRANSACTION_ATTEMPT(
14:33:53 330  	  in_transaction_attempt_id => in_transaction_attempt_id,
14:33:53 331  	  in_status_id		    => in_transaction_attempt_status
14:33:53 332  	);
14:33:53 333  
14:33:53 334  EXCEPTION
14:33:53 335  WHEN BAD_TRANSACTION_ATTEMPT_ID THEN
14:33:53 336  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 337  	  SPROC_NAME, 'No such transaction attempt');
14:33:53 338  WHEN BAD_TRANS_ATTEMPT_STATUS THEN
14:33:53 339  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:53 340  	  SPROC_NAME, 'Bad transaction attempt status');
14:33:53 341  WHEN OTHERS THEN
14:33:53 342  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 343  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 344  END UPDATE_TRNSCTN_ATTEMPT_STATUS;
14:33:53 345  
14:33:53 346  /******************************************************************************/
14:33:53 347  
14:33:53 348  PROCEDURE GET_TRNSCTN_ATTEMPTS_BY_STATUS (
14:33:53 349  /*
14:33:53 350  Throws exceptions:
14:33:53 351  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 352  */
14:33:53 353  	in_transaction_id	      IN NUMBER,
14:33:53 354  	in_transaction_attempt_status IN NUMBER,
14:33:53 355  	out_result_set		      OUT SYS_REFCURSOR
14:33:53 356  ) AS
14:33:53 357  -- VARIABLES
14:33:53 358  SPROC_NAME	  CONSTANT VARCHAR2(30) := 'GET_TRNSCTN_ATTEMPTS_BY_STATUS';
14:33:53 359  temp_transaction_id NUMBER;
14:33:53 360  -- EXCEPTIONS
14:33:53 361  BAD_TRANSACTION_ID       EXCEPTION;
14:33:53 362  BAD_TRANS_ATTEMPT_STATUS EXCEPTION;
14:33:53 363  BEGIN
14:33:53 364  
14:33:53 365  	-- Check that transaction exists
14:33:53 366  	BEGIN
14:33:53 367  	  SELECT
14:33:53 368  	    TRANSACTION.ID into temp_transaction_id
14:33:53 369  	  FROM
14:33:53 370  	    TRANSACTION
14:33:53 371  	  WHERE
14:33:53 372  	    TRANSACTION.ID = in_transaction_id;
14:33:53 373  	  EXCEPTION
14:33:53 374  	    WHEN OTHERS THEN
14:33:53 375  	      RAISE BAD_TRANSACTION_ID;
14:33:53 376  	END;
14:33:53 377  
14:33:53 378  	-- Check that transaction attempt status is correct
14:33:53 379  	IF in_transaction_attempt_status != GLOBAL_STATUSES_V22.TRANS_ATTEMPT_IN_PROGRESS
14:33:53 380  	  AND in_transaction_attempt_status != GLOBAL_STATUSES_V22.TRANS_ATTEMPT_SUCCESS
14:33:53 381  	  AND in_transaction_attempt_status != GLOBAL_STATUSES_V22.TRANS_ATTEMPT_FAILED THEN
14:33:53 382  	  RAISE BAD_TRANS_ATTEMPT_STATUS;
14:33:53 383  	END IF;
14:33:53 384  
14:33:53 385  	OPEN out_result_set FOR
14:33:53 386  	SELECT
14:33:53 387  	  TRANSACTION_ATTEMPT.ID,
14:33:53 388  	  TRANSACTION_ATTEMPT.EXTERNAL_STATUS_CODE,
14:33:53 389  	  TRANSACTION_ATTEMPT.EXTERNAL_STATUS_MESSAGE,
14:33:53 390  	  TRANSACTION_ATTEMPT.CREATE_DATE,
14:33:53 391  	  TRANSACTION_ATTEMPT.CREATED_BY,
14:33:53 392  	  TRANSACTION_ATTEMPT.EXTERNAL_TRANSACTION_ID,
14:33:53 393  	  TRANSACTION_ATTEMPT.TRANSACTION_START_TIME,
14:33:53 394  	  TRANSACTION.TRANSACTION_AMOUNT,
14:33:53 395  	  TRANSACTION.ID as "TRANSACTION_ID",
14:33:53 396  	  TRANSACTION.UPDATE_DATE as "TRANSACTION_UPDATE_TIME"
14:33:53 397  	FROM
14:33:53 398  	  TRANSACTION_ATTEMPT
14:33:53 399  	  INNER JOIN TRANSACTION ON TRANSACTION_ATTEMPT.TRANSACTION_ID = TRANSACTION.ID
14:33:53 400  	WHERE
14:33:53 401  	  TRANSACTION_ATTEMPT.TRANSACTION_ID = in_transaction_id
14:33:53 402  	  AND TRANSACTION_ATTEMPT.TRANSACTION_ATTEMPT_STATUS_ID = in_transaction_attempt_status;
14:33:53 403  
14:33:53 404  EXCEPTION
14:33:53 405  WHEN BAD_TRANSACTION_ID THEN
14:33:53 406  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 407  	  SPROC_NAME, 'No such transaction');
14:33:53 408  WHEN BAD_TRANS_ATTEMPT_STATUS THEN
14:33:53 409  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:53 410  	  SPROC_NAME, 'Bad transaction attempt status');
14:33:53 411  WHEN OTHERS THEN
14:33:53 412  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 413  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 414  END GET_TRNSCTN_ATTEMPTS_BY_STATUS;
14:33:53 415  
14:33:53 416  /******************************************************************************/
14:33:53 417  
14:33:53 418  PROCEDURE UPDATE_TRANSACTION_ATTEMPT_INF (
14:33:53 419  /*
14:33:53 420  Throws exceptions:
14:33:53 421  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 422  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 423  */
14:33:53 424  	in_transaction_attempt_id IN NUMBER,
14:33:53 425  	in_ext_status_code	  IN VARCHAR2,
14:33:53 426  	in_ext_status_message	  IN VARCHAR2,
14:33:53 427  	in_ext_transaction_id	  IN VARCHAR2
14:33:53 428  ) AS
14:33:53 429  -- VARIABLES
14:33:53 430  SPROC_NAME	       CONSTANT VARCHAR2(30) := 'UPDATE_TRANSACTION_ATTEMPT_INF';
14:33:53 431  temp_trans_attempt_count NUMBER;
14:33:53 432  -- EXCEPTIONS
14:33:53 433  BAD_ATTEMPT_ID EXCEPTION;
14:33:53 434  BEGIN
14:33:53 435  
14:33:53 436  	SELECT
14:33:53 437  	  COUNT(*) into temp_trans_attempt_count
14:33:53 438  	FROM
14:33:53 439  	  TRANSACTION_ATTEMPT
14:33:53 440  	WHERE
14:33:53 441  	  TRANSACTION_ATTEMPT.ID = in_transaction_attempt_id;
14:33:53 442  
14:33:53 443  	IF temp_trans_attempt_count = 0 THEN
14:33:53 444  	  RAISE BAD_ATTEMPT_ID;
14:33:53 445  	END IF;
14:33:53 446  
14:33:53 447  	PROCS_TRANSACTION_CRU_V22.UPDATE_TRANSACTION_ATTEMPT(
14:33:53 448  	  in_transaction_attempt_id  => in_transaction_attempt_id,
14:33:53 449  	  in_external_status_code    => in_ext_status_code,
14:33:53 450  	  in_external_status_message => in_ext_status_message,
14:33:53 451  	  in_external_transaction_id => in_ext_transaction_id
14:33:53 452  	);
14:33:53 453  
14:33:53 454  EXCEPTION
14:33:53 455  WHEN BAD_ATTEMPT_ID THEN
14:33:53 456  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 457  	  SPROC_NAME, 'No such attempt');
14:33:53 458  WHEN OTHERS THEN
14:33:53 459  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 460  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 461  END UPDATE_TRANSACTION_ATTEMPT_INF;
14:33:53 462  
14:33:53 463  /******************************************************************************/
14:33:53 464  
14:33:53 465  PROCEDURE GET_FAILED_ATTEMPTS_NUMBER (
14:33:53 466  /*
14:33:53 467  Throws exceptions:
14:33:53 468  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 469  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 470  */
14:33:53 471  	in_transaction_id IN  NUMBER,
14:33:53 472  	out_attempts_num  OUT NUMBER
14:33:53 473  ) AS
14:33:53 474  -- VARIABLES
14:33:53 475  SPROC_NAME	     CONSTANT VARCHAR2(26) := 'GET_FAILED_ATTEMPTS_NUMBER';
14:33:53 476  temp_transaction_count NUMBER;
14:33:53 477  
14:33:53 478  -- EXCEPTIONS
14:33:53 479  BAD_TRANSACTION_ID EXCEPTION;
14:33:53 480  BEGIN
14:33:53 481  
14:33:53 482  	SELECT
14:33:53 483  	  COUNT(*) into temp_transaction_count
14:33:53 484  	FROM
14:33:53 485  	  TRANSACTION
14:33:53 486  	WHERE
14:33:53 487  	  TRANSACTION.ID = in_transaction_id;
14:33:53 488  
14:33:53 489  	IF temp_transaction_count = 0 THEN
14:33:53 490  	  RAISE BAD_TRANSACTION_ID;
14:33:53 491  	END IF;
14:33:53 492  
14:33:53 493  	SELECT
14:33:53 494  	  COUNT(*) into out_attempts_num
14:33:53 495  	FROM
14:33:53 496  	  TRANSACTION_ATTEMPT
14:33:53 497  	WHERE
14:33:53 498  	  TRANSACTION_ATTEMPT.TRANSACTION_ID = in_transaction_id
14:33:53 499  	  AND TRANSACTION_ATTEMPT.TRANSACTION_ATTEMPT_STATUS_ID = GLOBAL_STATUSES_V22.TRANS_ATTEMPT_FAILED;
14:33:53 500  
14:33:53 501  EXCEPTION
14:33:53 502  WHEN BAD_TRANSACTION_ID THEN
14:33:53 503  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 504  	  SPROC_NAME, 'No such transaction');
14:33:53 505  WHEN OTHERS THEN
14:33:53 506  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 507  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 508  END GET_FAILED_ATTEMPTS_NUMBER;
14:33:53 509  /******************************************************************************/
14:33:53 510  
14:33:53 511  PROCEDURE IS_TRANSACTION_SUCCESSFULL (
14:33:53 512  /*
14:33:53 513  Throws exceptions:
14:33:53 514  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 515  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 516  */
14:33:53 517  	in_transaction_id IN  NUMBER,
14:33:53 518  	out_is_successfull  OUT NUMBER
14:33:53 519  ) AS
14:33:53 520  -- VARIABLES
14:33:53 521  SPROC_NAME	     CONSTANT VARCHAR2(26) := 'IS_TRANSACTION_SUCCESSFULL';
14:33:53 522  temp_transaction_count NUMBER;
14:33:53 523  
14:33:53 524  -- EXCEPTIONS
14:33:53 525  BAD_TRANSACTION_ID EXCEPTION;
14:33:53 526  BEGIN
14:33:53 527  
14:33:53 528  	SELECT
14:33:53 529  	  COUNT(*) into temp_transaction_count
14:33:53 530  	FROM
14:33:53 531  	  TRANSACTION
14:33:53 532  	WHERE
14:33:53 533  	  TRANSACTION.ID = in_transaction_id;
14:33:53 534  
14:33:53 535  	IF temp_transaction_count = 0 THEN
14:33:53 536  	  RAISE BAD_TRANSACTION_ID;
14:33:53 537  	END IF;
14:33:53 538  
14:33:53 539  	SELECT
14:33:53 540  	  COUNT(*) into out_is_successfull
14:33:53 541  	FROM
14:33:53 542  	  TRANSACTION_ATTEMPT
14:33:53 543  	WHERE
14:33:53 544  	  TRANSACTION_ATTEMPT.TRANSACTION_ID = in_transaction_id
14:33:53 545  	  AND TRANSACTION_ATTEMPT.TRANSACTION_ATTEMPT_STATUS_ID = GLOBAL_STATUSES_V22.TRANS_ATTEMPT_SUCCESS;
14:33:53 546  
14:33:53 547  EXCEPTION
14:33:53 548  WHEN BAD_TRANSACTION_ID THEN
14:33:53 549  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 550  	  SPROC_NAME, 'No such transaction');
14:33:53 551  WHEN OTHERS THEN
14:33:53 552  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 553  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 554  END IS_TRANSACTION_SUCCESSFULL;
14:33:53 555  /******************************************************************************/
14:33:53 556  
14:33:53 557  PROCEDURE GET_TRANSACTION_AMOUNT (
14:33:53 558  /*
14:33:53 559  Throws exceptions:
14:33:53 560  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 561  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 562  */
14:33:53 563  	in_transaction_id      IN  NUMBER,
14:33:53 564  	out_transaction_amount OUT NUMBER
14:33:53 565  ) AS
14:33:53 566  SPROC_NAME CONSTANT VARCHAR2(22) := 'GET_TRANSACTION_AMOUNT';
14:33:53 567  BEGIN
14:33:53 568  
14:33:53 569  	SELECT
14:33:53 570  	  TRANSACTION.TRANSACTION_AMOUNT into out_transaction_amount
14:33:53 571  	FROM
14:33:53 572  	  TRANSACTION
14:33:53 573  	WHERE
14:33:53 574  	  TRANSACTION.ID = in_transaction_id;
14:33:53 575  
14:33:53 576  EXCEPTION
14:33:53 577  WHEN NO_DATA_FOUND THEN
14:33:53 578  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 579  	  SPROC_NAME, 'No such transaction');
14:33:53 580  WHEN OTHERS THEN
14:33:53 581  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 582  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 583  END GET_TRANSACTION_AMOUNT;
14:33:53 584  
14:33:53 585  /******************************************************************************/
14:33:53 586  
14:33:53 587  PROCEDURE GET_TRANSACTIONS_BY_CHARGE_ID (
14:33:53 588  /*
14:33:53 589  Throws exceptions:
14:33:53 590  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 591  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 592  */
14:33:53 593  	in_charge_id   IN  NUMBER,
14:33:53 594  	out_result_set OUT SYS_REFCURSOR
14:33:53 595  ) AS
14:33:53 596  -- VARIABLES
14:33:53 597  SPROC_NAME     CONSTANT VARCHAR2(29) := 'GET_TRANSACTIONS_BY_CHARGE_ID';
14:33:53 598  temp_charge_id NUMBER;
14:33:53 599  -- EXCEPTIONS
14:33:53 600  BAD_CHARGE_ID EXCEPTION;
14:33:53 601  BEGIN
14:33:53 602  
14:33:53 603  	BEGIN
14:33:53 604  	  SELECT
14:33:53 605  	    CHARGE.ID into temp_charge_id
14:33:53 606  	  FROM
14:33:53 607  	    CHARGE
14:33:53 608  	  WHERE
14:33:53 609  	    CHARGE.ID = in_charge_id;
14:33:53 610  	  EXCEPTION
14:33:53 611  	    WHEN NO_DATA_FOUND THEN
14:33:53 612  	      RAISE BAD_CHARGE_ID;
14:33:53 613  	END;
14:33:53 614  
14:33:53 615  	OPEN out_result_set FOR
14:33:53 616  	SELECT DISTINCT
14:33:53 617  	  TRANSACTION.ID,
14:33:53 618  	  TRANSACTION.TRANSACTION_STATUS_ID,
14:33:53 619  	  TRANSACTION.CREATE_DATE,
14:33:53 620  	  TRANSACTION.TRANSACTION_AMOUNT,
14:33:53 621  	  TRANSACTION.IS_REFUND,
14:33:53 622  	  TRANSACTION.ORDER_ID
14:33:53 623  	FROM
14:33:53 624  	  CHARGE INNER JOIN TRANSACTION ON
14:33:53 625  	      CHARGE.TRANSACTION_ID = TRANSACTION.ID
14:33:53 626  	WHERE
14:33:53 627  	  CHARGE.ID = in_charge_id;
14:33:53 628  
14:33:53 629  EXCEPTION
14:33:53 630  WHEN BAD_CHARGE_ID THEN
14:33:53 631  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 632  	  SPROC_NAME, 'No such charge');
14:33:53 633  WHEN OTHERS THEN
14:33:53 634  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 635  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 636  END GET_TRANSACTIONS_BY_CHARGE_ID;
14:33:53 637  /******************************************************************************/
14:33:53 638  
14:33:53 639  PROCEDURE GET_TRANSACTION_BY_ORDER_ID (
14:33:53 640  /*
14:33:53 641  Throws exceptions:
14:33:53 642  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 643  */
14:33:53 644  	in_order_id   IN  TRANSACTION.ORDER_ID%TYPE,
14:33:53 645  	out_result_set OUT SYS_REFCURSOR
14:33:53 646  ) AS
14:33:53 647  -- VARIABLES
14:33:53 648  SPROC_NAME     CONSTANT VARCHAR2(27) := 'GET_TRANSACTION_BY_ORDER_ID';
14:33:53 649  BEGIN
14:33:53 650  	OPEN out_result_set FOR
14:33:53 651  	SELECT DISTINCT
14:33:53 652  	  TRANSACTION.ID
14:33:53 653  	FROM
14:33:53 654  	  TRANSACTION
14:33:53 655  	WHERE
14:33:53 656  	  TRANSACTION.ORDER_ID = in_order_id;
14:33:53 657  
14:33:53 658  EXCEPTION
14:33:53 659  WHEN OTHERS THEN
14:33:53 660  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 661  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 662  END GET_TRANSACTION_BY_ORDER_ID;
14:33:53 663  /******************************************************************************/
14:33:53 664  
14:33:53 665  PROCEDURE GET_TRANSACTIONS_BY_ORDER_ID (
14:33:53 666  /*
14:33:53 667  Throws exceptions:
14:33:53 668  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 669  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 670  */
14:33:53 671  	in_order_id   IN  TRANSACTION.ORDER_ID%TYPE,
14:33:53 672  	out_result_set OUT SYS_REFCURSOR
14:33:53 673  ) AS
14:33:53 674  -- VARIABLES
14:33:53 675  SPROC_NAME     CONSTANT VARCHAR2(28) := 'GET_TRANSACTIONS_BY_ORDER_ID';
14:33:53 676  temp_order_id TRANSACTION.ORDER_ID%TYPE;
14:33:53 677  -- EXCEPTIONS
14:33:53 678  BAD_ORDER_ID EXCEPTION;
14:33:53 679  BEGIN
14:33:53 680  
14:33:53 681  	--TODO BOO, REMOVE ME
14:33:53 682  	BEGIN
14:33:53 683  	  SELECT
14:33:53 684  	    distinct TRANSACTION.ORDER_ID INTO temp_order_id
14:33:53 685  	  FROM
14:33:53 686  	    TRANSACTION
14:33:53 687  	  WHERE
14:33:53 688  	    TRANSACTION.ORDER_ID = in_order_id;
14:33:53 689  	  EXCEPTION
14:33:53 690  	    WHEN NO_DATA_FOUND THEN
14:33:53 691  	      RAISE BAD_ORDER_ID;
14:33:53 692  	END;
14:33:53 693  
14:33:53 694  	OPEN out_result_set FOR
14:33:53 695  	SELECT c.ID CHARGE_ID,
14:33:53 696  	  c.CHARGE_AMOUNT,
14:33:53 697  	  c.CHARGE_STATUS_ID,
14:33:53 698  	  c.INSTRUMENT_ID,
14:33:53 699  	  c.INSTRUMENT_TYPE_ID,
14:33:53 700  	  c.INVOICE_ID,
14:33:53 701  	  t.ID TRANSACTION_ID,
14:33:53 702  	  t.IS_REFUND,
14:33:53 703  	  t.IS_SETTLED,
14:33:53 704  	  t.ORDER_ID,
14:33:53 705  	  t.TRANSACTION_AMOUNT,
14:33:53 706  	  t.TRANSACTION_STATUS_ID,
14:33:53 707  	  t.CREATE_DATE TRANSACTION_CREATE_DATE,
14:33:53 708  	  t.CREATED_BY TRANSACTION_CREATED_BY,
14:33:53 709  	  t.UPDATE_DATE TRANSACTION_UPDATE_DATE,
14:33:53 710  	  t.UPDATED_BY TRANSACTION_UPDATED_BY
14:33:53 711  	FROM CHARGE c
14:33:53 712  	JOIN TRANSACTION t ON c.TRANSACTION_ID = t.ID
14:33:53 713  	WHERE TRANSACTION_ID IN (
14:33:53 714  	  SELECT ID FROM TRANSACTION WHERE ORDER_ID = in_order_id
14:33:53 715  	);
14:33:53 716  
14:33:53 717  EXCEPTION
14:33:53 718  WHEN BAD_ORDER_ID THEN
14:33:53 719  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 720  	  SPROC_NAME, 'No such order');
14:33:53 721  WHEN OTHERS THEN
14:33:53 722  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 723  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 724  END GET_TRANSACTIONS_BY_ORDER_ID;
14:33:53 725  /******************************************************************************/
14:33:53 726  
14:33:53 727  PROCEDURE GET_CLOSED_REFUNDS_BY_INVOICE (
14:33:53 728  /*
14:33:53 729  Throws exceptions:
14:33:53 730  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 731  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 732  */
14:33:53 733  	in_invoice_id	IN  NUMBER,
14:33:53 734  	out_result_set OUT SYS_REFCURSOR
14:33:53 735  ) AS
14:33:53 736  -- VARIABLES
14:33:53 737  SPROC_NAME     CONSTANT VARCHAR2(29) := 'GET_CLOSED_REFUNDS_BY_INVOICE';
14:33:53 738  temp_invoice_id NUMBER;
14:33:53 739  -- EXCEPTIONS
14:33:53 740  BAD_INVOICE_ID EXCEPTION;
14:33:53 741  BEGIN
14:33:53 742  
14:33:53 743  	BEGIN
14:33:53 744  	  SELECT
14:33:53 745  	    INVOICE.ID into temp_invoice_id
14:33:53 746  	  FROM
14:33:53 747  	    INVOICE
14:33:53 748  	  WHERE
14:33:53 749  	    INVOICE.ID = in_invoice_id;
14:33:53 750  	  EXCEPTION
14:33:53 751  	    WHEN NO_DATA_FOUND THEN
14:33:53 752  	      RAISE BAD_INVOICE_ID;
14:33:53 753  	END;
14:33:53 754  
14:33:53 755  	OPEN out_result_set FOR
14:33:53 756  	SELECT DISTINCT
14:33:53 757  	  TRANSACTION.ID,
14:33:53 758  	  TRANSACTION.TRANSACTION_STATUS_ID,
14:33:53 759  	  TRANSACTION.CREATE_DATE,
14:33:53 760  	  TRANSACTION.UPDATE_DATE,
14:33:53 761  	  TRANSACTION.ORDER_ID,
14:33:53 762  	  TRANSACTION.TRANSACTION_AMOUNT
14:33:53 763  	FROM
14:33:53 764  	  INVOICE INNER JOIN CHARGE ON	(INVOICE.ID = CHARGE.INVOICE_ID)
14:33:53 765  	  INNER JOIN TRANSACTION ON (CHARGE.TRANSACTION_ID = TRANSACTION.ID)
14:33:53 766  	WHERE
14:33:53 767  	  INVOICE.ID = in_invoice_id
14:33:53 768  	  AND TRANSACTION.IS_REFUND = GLOBAL_CONSTANTS_V22.TRUE
14:33:53 769  	  AND TRANSACTION.TRANSACTION_AMOUNT <= 0
14:33:53 770  	  AND TRANSACTION.TRANSACTION_STATUS_ID = GLOBAL_STATUSES_V22.TRANSACTION_CLOSED;
14:33:53 771  
14:33:53 772  EXCEPTION
14:33:53 773  WHEN BAD_INVOICE_ID THEN
14:33:53 774  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 775  	  SPROC_NAME, 'No such invoice');
14:33:53 776  WHEN OTHERS THEN
14:33:53 777  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 778  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 779  END GET_CLOSED_REFUNDS_BY_INVOICE;
14:33:53 780  
14:33:53 781  /******************************************************************************/
14:33:53 782  
14:33:53 783  PROCEDURE GET_TRANSACTION_ATTEMPTS (
14:33:53 784  /*
14:33:53 785  Throws exceptions:
14:33:53 786  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 787  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 788  */
14:33:53 789  	in_transaction_id IN  NUMBER,
14:33:53 790  	out_result_set	  OUT SYS_REFCURSOR
14:33:53 791  ) AS
14:33:53 792  -- VARIABLES
14:33:53 793  SPROC_NAME	  CONSTANT VARCHAR2(24) := 'GET_TRANSACTION_ATTEMPTS';
14:33:53 794  temp_transaction_id NUMBER;
14:33:53 795  -- EXCEPTIONS
14:33:53 796  BAD_TRANSACTION_ID EXCEPTION;
14:33:53 797  BEGIN
14:33:53 798  
14:33:53 799  	BEGIN
14:33:53 800  	  SELECT
14:33:53 801  	    TRANSACTION.ID into temp_transaction_id
14:33:53 802  	  FROM
14:33:53 803  	    TRANSACTION
14:33:53 804  	  WHERE
14:33:53 805  	    TRANSACTION.ID = in_transaction_id;
14:33:53 806  	  EXCEPTION
14:33:53 807  	    WHEN NO_DATA_FOUND THEN
14:33:53 808  	      RAISE BAD_TRANSACTION_ID;
14:33:53 809  	END;
14:33:53 810  
14:33:53 811  	OPEN out_result_set FOR
14:33:53 812  	SELECT
14:33:53 813  	  TRANSACTION_ATTEMPT.TRANSACTION_ATTEMPT_STATUS_ID,
14:33:53 814  	  TRANSACTION_ATTEMPT.EXTERNAL_STATUS_CODE,
14:33:53 815  	  TRANSACTION_ATTEMPT.EXTERNAL_STATUS_MESSAGE,
14:33:53 816  	  TRANSACTION_ATTEMPT.CREATE_DATE,
14:33:53 817  	  TRANSACTION_ATTEMPT.EXTERNAL_TRANSACTION_ID
14:33:53 818  	FROM
14:33:53 819  	  TRANSACTION_ATTEMPT
14:33:53 820  	WHERE
14:33:53 821  	  TRANSACTION_ATTEMPT.TRANSACTION_ID = in_transaction_id;
14:33:53 822  
14:33:53 823  EXCEPTION
14:33:53 824  WHEN BAD_TRANSACTION_ID THEN
14:33:53 825  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 826  	  SPROC_NAME, 'No such transaction');
14:33:53 827  WHEN OTHERS THEN
14:33:53 828  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 829  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 830  END GET_TRANSACTION_ATTEMPTS;
14:33:53 831  
14:33:53 832  /******************************************************************************/
14:33:53 833  
14:33:53 834  PROCEDURE RESERVE_TRANSACTION_ID (
14:33:53 835  /*
14:33:53 836  Throws exceptions:
14:33:53 837  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 838  */
14:33:53 839  	out_transaction_id OUT NUMBER
14:33:53 840  ) AS
14:33:53 841  SPROC_NAME CONSTANT VARCHAR2(22) := 'RESERVE_TRANSACTION_ID';
14:33:53 842  BEGIN
14:33:53 843  	SELECT
14:33:53 844  	  TRN_ID_SEQ.nextVal into out_transaction_id
14:33:53 845  	FROM DUAL;
14:33:53 846  EXCEPTION
14:33:53 847  WHEN OTHERS THEN
14:33:53 848  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 849  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 850  END RESERVE_TRANSACTION_ID;
14:33:53 851  
14:33:53 852  /******************************************************************************/
14:33:53 853  
14:33:53 854  PROCEDURE GET_TRANSACTION_BY_ID (
14:33:53 855  /*
14:33:53 856  Throws exceptions:
14:33:53 857  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 858  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 859  */
14:33:53 860  	in_transaction_id IN NUMBER,
14:33:53 861  	out_result_set	  OUT SYS_REFCURSOR
14:33:53 862  ) AS
14:33:53 863  SPROC_NAME CONSTANT VARCHAR2(21) := 'GET_TRANSACTION_BY_ID';
14:33:53 864  -- VARIABLES
14:33:53 865  temp_transaction_id NUMBER;
14:33:53 866  -- EXCPTIONS
14:33:53 867  BAD_TRANSACTION_ID EXCEPTION;
14:33:53 868  BEGIN
14:33:53 869  	BEGIN
14:33:53 870  	  SELECT
14:33:53 871  	    TRANSACTION.ID into temp_transaction_id
14:33:53 872  	  FROM
14:33:53 873  	    TRANSACTION
14:33:53 874  	  WHERE
14:33:53 875  	    TRANSACTION.ID = in_transaction_id;
14:33:53 876  	  EXCEPTION
14:33:53 877  	    WHEN NO_DATA_FOUND THEN
14:33:53 878  	      RAISE BAD_TRANSACTION_ID;
14:33:53 879  	END;
14:33:53 880  
14:33:53 881  	PROCS_TRANSACTION_CRU_V22.READ_TRANSACTION(
14:33:53 882  	  in_transaction_id => in_transaction_id,
14:33:53 883  	  out_result_set    => out_result_set
14:33:53 884  	);
14:33:53 885  
14:33:53 886  EXCEPTION
14:33:53 887  WHEN NO_DATA_FOUND THEN
14:33:53 888  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 889  	  SPROC_NAME, 'No such transaction');
14:33:53 890  WHEN OTHERS THEN
14:33:53 891  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 892  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 893  END GET_TRANSACTION_BY_ID;
14:33:53 894  
14:33:53 895  PROCEDURE UPDATE_TRANSACTION_ORDER_ID (
14:33:53 896  /*
14:33:53 897  Throws exceptions:
14:33:53 898  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 899  APP_EXCEPTION_CODES_V22.INTRNAL_ERROR
14:33:53 900  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 901  */
14:33:53 902  	in_transaction_id IN TRANSACTION.ID%TYPE,
14:33:53 903  	in_order_id	  IN TRANSACTION.ORDER_ID%TYPE,
14:33:53 904  	in_updated_by	  IN TRANSACTION.UPDATED_BY%TYPE
14:33:53 905  ) AS
14:33:53 906  SPROC_NAME CONSTANT VARCHAR2(27) := 'UPDATE_TRANSACTION_ORDER_ID';
14:33:53 907  -- VARIABLES
14:33:53 908  temp_transaction_id TRANSACTION.ID%TYPE;
14:33:53 909  -- EXCEPTIONS
14:33:53 910  BAD_TRANSACTION_ID   EXCEPTION;
14:33:53 911  ORDER_ID_IS_NOT_NULL EXCEPTION;
14:33:53 912  CRU_UNKNOWN_ERROR    EXCEPTION;
14:33:53 913  EXCEPTION_MESSAGE VARCHAR2(1024);
14:33:53 914  BEGIN
14:33:53 915  	BEGIN
14:33:53 916  	  SELECT
14:33:53 917  	    TRANSACTION.ID into temp_transaction_id
14:33:53 918  	  FROM
14:33:53 919  	    TRANSACTION
14:33:53 920  	  WHERE
14:33:53 921  	    TRANSACTION.ID = in_transaction_id;
14:33:53 922  	  EXCEPTION
14:33:53 923  	    WHEN NO_DATA_FOUND THEN
14:33:53 924  	      RAISE BAD_TRANSACTION_ID;
14:33:53 925  	END;
14:33:53 926  
14:33:53 927  	BEGIN
14:33:53 928  	  PROCS_TRANSACTION_CRU_V22.UPDATE_TRANSACTION_ORDER_ID(
14:33:53 929  	    in_transaction_id => in_transaction_id,
14:33:53 930  	    in_order_id       => in_order_id,
14:33:53 931  	    in_updated_by     => in_updated_by
14:33:53 932  	  );
14:33:53 933  	  EXCEPTION
14:33:53 934  	    WHEN OTHERS THEN
14:33:53 935  	      IF SQLCODE = APP_EXCEPTION_CODES_V22.NOT_FOUND THEN
14:33:53 936  		RAISE ORDER_ID_IS_NOT_NULL;
14:33:53 937  	      ELSE
14:33:53 938  		EXCEPTION_MESSAGE := SQLERRM;
14:33:53 939  		RAISE CRU_UNKNOWN_ERROR;
14:33:53 940  	      END IF;
14:33:53 941  	END;
14:33:53 942  
14:33:53 943  EXCEPTION
14:33:53 944  WHEN BAD_TRANSACTION_ID THEN
14:33:53 945  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 946  	  SPROC_NAME, 'No such transaction');
14:33:53 947  WHEN ORDER_ID_IS_NOT_NULL THEN
14:33:53 948  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 949  	  SPROC_NAME, 'Order id is not null');
14:33:53 950  WHEN CRU_UNKNOWN_ERROR THEN
14:33:53 951  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:53 952  	  SPROC_NAME, 'Unknown error while updating order id', EXCEPTION_MESSAGE);
14:33:53 953  WHEN OTHERS THEN
14:33:53 954  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 955  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 956  END UPDATE_TRANSACTION_ORDER_ID;
14:33:53 957  
14:33:53 958  /******************************************************************************/
14:33:53 959  
14:33:53 960  FUNCTION GET_TRANSACTION_TAX_AMOUNT (
14:33:53 961  	in_transaction_id IN NUMBER
14:33:53 962  ) RETURN NUMBER AS
14:33:53 963  SPROC_NAME CONSTANT VARCHAR2(26) := 'GET_TRANSACTION_TAX_AMOUNT';
14:33:53 964  -- Variables
14:33:53 965  var_tax_amount NUMBER(10,2);
14:33:53 966  BEGIN
14:33:53 967  
14:33:53 968  	SELECT
14:33:53 969  	  SUM(LI.TAXES_AMOUNT) into var_tax_amount
14:33:53 970  	FROM
14:33:53 971  	  LINE_ITEM LI
14:33:53 972  	  INNER JOIN INVOICE I ON LI.INVOICE_ID = I.ID
14:33:53 973  	  INNER JOIN CHARGE CH ON CH.INVOICE_ID = I.ID
14:33:53 974  	WHERE
14:33:53 975  	  CH.TRANSACTION_ID = in_transaction_id;
14:33:53 976  
14:33:53 977  	IF var_tax_amount IS NULL THEN
14:33:53 978  	  var_tax_amount := 0;
14:33:53 979  	END IF;
14:33:53 980  
14:33:53 981  	RETURN var_tax_amount;
14:33:53 982  
14:33:53 983  END GET_TRANSACTION_TAX_AMOUNT;
14:33:53 984  
14:33:53 985  /******************************************************************************/
14:33:53 986  
14:33:53 987  FUNCTION GET_TRANSACTION_INTRL_TAXES (
14:33:53 988  	in_transaction_id IN NUMBER
14:33:53 989  ) RETURN NUMBER AS
14:33:53 990  SPROC_NAME CONSTANT VARCHAR2(27) := 'GET_TRANSACTION_INTRL_TAXES';
14:33:53 991  -- Variables
14:33:53 992  var_intrl_tax_amount NUMBER(10, 2);
14:33:53 993  BEGIN
14:33:53 994  
14:33:53 995  	SELECT SUM(T.CALCULATED_AMOUNT) into var_intrl_tax_amount
14:33:53 996  	FROM
14:33:53 997  	  LINE_ITEM LI
14:33:53 998  	  INNER JOIN INVOICE I ON LI.INVOICE_ID = I.ID
14:33:53 999  	  INNER JOIN CHARGE CH ON CH.INVOICE_ID=  I.ID
14:33:53 1000  	   INNER JOIN TAX T ON T.LINE_ITEM_ID = LI.ID
14:33:53 1001  	 WHERE
14:33:53 1002  	   CH.TRANSACTION_ID = in_transaction_id
14:33:53 1003  	   AND T.TAX_TYPE_ID IN (
14:33:53 1004  	     SELECT GLOBAL_ENUMS_V22.TAX_TYPE_VAT FROM DUAL
14:33:53 1005  	   );
14:33:53 1006  
14:33:53 1007  	 IF var_intrl_tax_amount IS NULL THEN
14:33:53 1008  	   var_intrl_tax_amount := 0;
14:33:53 1009  	 END IF;
14:33:53 1010  
14:33:53 1011  	 RETURN var_intrl_tax_amount;
14:33:53 1012  
14:33:53 1013  END GET_TRANSACTION_INTRL_TAXES;
14:33:53 1014  
14:33:53 1015  /******************************************************************************/
14:33:53 1016  -- norlov: #38796
14:33:53 1017  PROCEDURE GET_TRANSACTIONS (
14:33:53 1018  /*
14:33:53 1019  Throws exceptions:
14:33:53 1020  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 1021  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 1022  */
14:33:53 1023  	 in_group_id	       IN  NUMBER,
14:33:53 1024  	 in_invoice_id	       IN NUMBER DEFAULT NULL,
14:33:53 1025  	 in_subscription_id    IN NUMBER DEFAULT NULL,
14:33:53 1026  	 in_start_date	       IN TRANSACTION.CREATE_DATE%TYPE DEFAULT NULL,
14:33:53 1027  	 in_end_date	       IN TRANSACTION.CREATE_DATE%TYPE DEFAULT NULL,
14:33:53 1028  	 in_transaction_status IN NUMBER DEFAULT NULL,
14:33:53 1029  	 out_result_set        OUT SYS_REFCURSOR
14:33:53 1030  ) AS
14:33:53 1031  SPROC_NAME CONSTANT VARCHAR2(16) := 'GET_TRANSACTIONS';
14:33:53 1032  -- VARIABLES
14:33:53 1033  var_account_id ACCOUNT.ID%TYPE;
14:33:53 1034  statement VARCHAR2(2000);
14:33:53 1035  -- EXCEPTIONS
14:33:53 1036  BAD_GROUP_ID   EXCEPTION;
14:33:53 1037  BEGIN
14:33:53 1038  	-- check group id
14:33:53 1039  	BEGIN
14:33:53 1040  	   SELECT
14:33:53 1041  	     ACCOUNT.ID into var_account_id
14:33:53 1042  	   FROM
14:33:53 1043  	     ACCOUNT
14:33:53 1044  	   WHERE
14:33:53 1045  	     ACCOUNT.GROUP_ID = in_group_id;
14:33:53 1046  	   EXCEPTION
14:33:53 1047  	     WHEN NO_DATA_FOUND THEN
14:33:53 1048  	       RAISE BAD_GROUP_ID;
14:33:53 1049  	 END;
14:33:53 1050  
14:33:53 1051  	 OPEN out_result_set FOR
14:33:53 1052  	 SELECT
14:33:53 1053  	   TRANSACTION.ID,
14:33:53 1054  	   TRANSACTION.TRANSACTION_STATUS_ID,
14:33:53 1055  	   TRANSACTION.TRANSACTION_AMOUNT,
14:33:53 1056  	   TRANSACTION.CREATE_DATE,
14:33:53 1057  	   TRANSACTION.CREATED_BY,
14:33:53 1058  	   TRANSACTION.IS_REFUND,
14:33:53 1059  	   GET_TRANSACTION_TAX_AMOUNT(TRANSACTION.ID) as TRANSACTION_TAX_AMOUNT,
14:33:53 1060  	   GET_TRANSACTION_INTRL_TAXES(TRANSACTION.ID) as INTERNATIONAL_TOTAL
14:33:53 1061  	 FROM
14:33:53 1062  	   TRANSACTION
14:33:53 1063  	   INNER JOIN CHARGE ON TRANSACTION.ID = CHARGE.TRANSACTION_ID
14:33:53 1064  	   INNER JOIN INVOICE ON INVOICE.ID = CHARGE.INVOICE_ID
14:33:53 1065  	 WHERE
14:33:53 1066  	   -- Filter by invoice ID
14:33:53 1067  	   (
14:33:53 1068  	     INVOICE.ID IN (
14:33:53 1069  	       -- Gift certificate invoices
14:33:53 1070  	       SELECT
14:33:53 1071  		 GIFT_CERTIFICATE.PURCHASE_INVOICE_ID
14:33:53 1072  	       FROM
14:33:53 1073  		 GIFT_CERTIFICATE
14:33:53 1074  	       WHERE
14:33:53 1075  		 GIFT_CERTIFICATE.PURCHASER_GROUP_ID = in_group_id
14:33:53 1076  		 -- If subscription_id is set then return nothing
14:33:53 1077  		 AND EXISTS (SELECT 1 FROM DUAL WHERE in_subscription_id IS NULL)
14:33:53 1078  	     )
14:33:53 1079  	     OR
14:33:53 1080  	     INVOICE.ID IN (
14:33:53 1081  	       SELECT
14:33:53 1082  		 LICENSE.INVOICE_ID
14:33:53 1083  	       FROM
14:33:53 1084  		 LICENSE
14:33:53 1085  		 INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
14:33:53 1086  	       WHERE
14:33:53 1087  		 SUBSCRIPTION.ACCOUNT_ID = var_account_id
14:33:53 1088  		 -- Filter by subscription id
14:33:53 1089  		 AND SUBSCRIPTION.ID = NVL(in_subscription_id, SUBSCRIPTION.ID)
14:33:53 1090  	     )
14:33:53 1091  	   )
14:33:53 1092  	   -- Filter by invoice id
14:33:53 1093  	   AND INVOICE.ID = NVL(in_invoice_id, INVOICE.ID)
14:33:53 1094  	   -- Filter by start date
14:33:53 1095  	   AND TRANSACTION.CREATE_DATE >= NVL(in_start_date, TRANSACTION.CREATE_DATE)
14:33:53 1096  	   -- Filter by end date
14:33:53 1097  	   AND TRANSACTION.CREATE_DATE <= NVL(in_end_date, TRANSACTION.CREATE_DATE)
14:33:53 1098  	   -- Filter by transaction status
14:33:53 1099  	   AND TRANSACTION.TRANSACTION_STATUS_ID IN ( SELECT NVL(in_transaction_status, TRANSACTION.TRANSACTION_STATUS_ID) FROM DUAL);
14:33:53 1100  
14:33:53 1101  /*
14:33:53 1102  
14:33:53 1103  statement :=  'select distinct '||CHR(10)
14:33:53 1104  || ' TRANSACTION.ID,'||CHR(10)
14:33:53 1105  || ' TRANSACTION.TRANSACTION_STATUS_ID, '||CHR(10)
14:33:53 1106  || ' TRANSACTION.TRANSACTION_AMOUNT, '||CHR(10)
14:33:53 1107  || ' TRANSACTION.CREATE_DATE, '||CHR(10)
14:33:53 1108  || ' TRANSACTION.CREATED_BY, '||CHR(10)
14:33:53 1109  || ' TRANSACTION.IS_REFUND from TRANSACTION '||CHR(10)
14:33:53 1110  || ' inner join CHARGE on (CHARGE.TRANSACTION_ID = TRANSACTION.ID)'||CHR(10)
14:33:53 1111  || ' inner join INVOICE on (INVOICE.ID = CHARGE.INVOICE_ID)'||CHR(10)
14:33:53 1112  || ' inner join LICENSE on (LICENSE.INVOICE_ID = INVOICE.ID)'||CHR(10)
14:33:53 1113  || ' inner join SUBSCRIPTION on (SUBSCRIPTION.ID = LICENSE.SUBSCRIPTION_ID)'||CHR(10)
14:33:53 1114  || ' inner join ACCOUNT on (ACCOUNT.ID = SUBSCRIPTION.ACCOUNT_ID)'||CHR(10)
14:33:53 1115  || ' where ACCOUNT.GROUP_ID = '||in_group_id;
14:33:53 1116  
14:33:53 1117  IF (in_transaction_status IS NOT NULL) THEN
14:33:53 1118  	 statement := statement || CHR(10) || 'AND TRANSACTION.TRANSACTION_STATUS_ID=' || in_transaction_status;
14:33:53 1119  END IF;
14:33:53 1120  
14:33:53 1121  IF (in_invoice_id IS NOT NULL) THEN
14:33:53 1122  	 statement := statement || CHR(10) || 'AND INVOICE.ID=' || in_invoice_id;
14:33:53 1123  END IF;
14:33:53 1124  
14:33:53 1125  IF (in_subscription_id IS NOT NULL) THEN
14:33:53 1126  	 statement := statement || CHR(10) || 'AND SUBSCRIPTION.ID=' || in_subscription_id;
14:33:53 1127  END IF;
14:33:53 1128  
14:33:53 1129  IF (in_start_date IS NOT NULL) THEN
14:33:53 1130  	 statement := statement || CHR(10) || 'AND TRANSACTION.CREATE_DATE>= TO_DATE(''' || TO_CHAR(in_start_date,'yyyy/mm/dd:hh:mi:ss') || ''',''yyyy/mm/dd:hh:mi:ss'')';  -- norlov: ??
14:33:53 1131  END IF;
14:33:53 1132  
14:33:53 1133  IF (in_end_date IS NOT NULL) THEN
14:33:53 1134  	 statement := statement || CHR(10) || 'AND TRANSACTION.CREATE_DATE<= TO_DATE(''' || TO_CHAR(in_end_date,'yyyy/mm/dd:hh:mi:ss') || ''',''yyyy/mm/dd:hh:mi:ss'')'; -- norlov: ??
14:33:53 1135  END IF;
14:33:53 1136  dbms_output.put_line(statement);
14:33:53 1137  OPEN out_result_set FOR statement;
14:33:53 1138  
14:33:53 1139  */
14:33:53 1140  
14:33:53 1141  EXCEPTION
14:33:53 1142  WHEN BAD_GROUP_ID THEN
14:33:53 1143  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1144  	   SPROC_NAME, 'No such group');
14:33:53 1145  WHEN OTHERS THEN
14:33:53 1146  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1147  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1148  END GET_TRANSACTIONS;
14:33:53 1149  
14:33:53 1150  FUNCTION IS_TRANSACTION_COLLECTED (
14:33:53 1151  /*
14:33:53 1152  Throws:
14:33:53 1153  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 1154  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 1155  Returns:
14:33:53 1156  GLOBAL_CONST.TRUE if transaction collected,
14:33:53 1157  GLOBAL_CONST.FALSE else
14:33:53 1158  */
14:33:53 1159  	 in_transaction_id IN NUMBER
14:33:53 1160  ) RETURN NUMBER AS
14:33:53 1161  SPROC_NAME CONSTANT VARCHAR2(24) := 'IS_TRANSACTION_COLLECTED';
14:33:53 1162  -- VARIABLES
14:33:53 1163  temp_transaction_id     NUMBER;
14:33:53 1164  var_success_attemps_num NUMBER;
14:33:53 1165  -- EXCEPTIONS
14:33:53 1166  BAD_TRANSACTION_ID EXCEPTION;
14:33:53 1167  BEGIN
14:33:53 1168  
14:33:53 1169  	 BEGIN
14:33:53 1170  	   SELECT
14:33:53 1171  	     TRANSACTION.ID into temp_transaction_id
14:33:53 1172  	   FROM
14:33:53 1173  	     TRANSACTION
14:33:53 1174  	   WHERE
14:33:53 1175  	     TRANSACTION.ID = in_transaction_id;
14:33:53 1176  	   EXCEPTION
14:33:53 1177  	     WHEN NO_DATA_FOUND THEN
14:33:53 1178  	       RAISE BAD_TRANSACTION_ID;
14:33:53 1179  	 END;
14:33:53 1180  
14:33:53 1181  	 SELECT
14:33:53 1182  	   COUNT(*) into var_success_attemps_num
14:33:53 1183  	 FROM
14:33:53 1184  	   TRANSACTION_ATTEMPT
14:33:53 1185  	 WHERE
14:33:53 1186  	   TRANSACTION_ATTEMPT.TRANSACTION_ID = in_transaction_id
14:33:53 1187  	   AND TRANSACTION_ATTEMPT.TRANSACTION_ATTEMPT_STATUS_ID IN ( SELECT GLOBAL_STATUSES_V22.TRANS_ATTEMPT_SUCCESS FROM DUAL );
14:33:53 1188  
14:33:53 1189  	 IF var_success_attemps_num > 0 THEN
14:33:53 1190  	   RETURN GLOBAL_CONSTANTS_V22.TRUE;
14:33:53 1191  	 ELSE
14:33:53 1192  	   RETURN GLOBAL_CONSTANTS_V22.FALSE;
14:33:53 1193  	 END IF;
14:33:53 1194  
14:33:53 1195  EXCEPTION
14:33:53 1196  WHEN BAD_TRANSACTION_ID THEN
14:33:53 1197  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1198  	   SPROC_NAME, 'No such transaction');
14:33:53 1199  WHEN OTHERS THEN
14:33:53 1200  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1201  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1202  END IS_TRANSACTION_COLLECTED;
14:33:53 1203  
14:33:53 1204  
14:33:53 1205  /******************************************************************************/
14:33:53 1206  PROCEDURE GET_NEXT_ATTEMPT_NUMBER (
14:33:53 1207  /*
14:33:53 1208  Throws exceptions:
14:33:53 1209  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 1210  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 1211  */
14:33:53 1212  	 in_charge_id	in  number,
14:33:53 1213  	 out_attempt_count OUT NUMBER
14:33:53 1214  ) AS
14:33:53 1215  -- VARIABLES
14:33:53 1216  SPROC_NAME     CONSTANT VARCHAR2(29) := 'GET_NEXT_ATTEMPT_NUMBER';
14:33:53 1217  temp_transaction_id NUMBER;
14:33:53 1218  -- EXCEPTIONS
14:33:53 1219  BAD_CHARGE_ID EXCEPTION;
14:33:53 1220  BEGIN
14:33:53 1221  
14:33:53 1222  	 BEGIN
14:33:53 1223  	   SELECT
14:33:53 1224  	     TRANSACTION_ID into temp_transaction_id
14:33:53 1225  	   FROM
14:33:53 1226  	     CHARGE
14:33:53 1227  	   WHERE
14:33:53 1228  	     CHARGE.ID = in_charge_id;
14:33:53 1229  	   EXCEPTION
14:33:53 1230  	     WHEN NO_DATA_FOUND THEN
14:33:53 1231  	       RAISE BAD_CHARGE_ID;
14:33:53 1232  	 END;
14:33:53 1233  
14:33:53 1234  	 select
14:33:53 1235  	   count(1)
14:33:53 1236  	 into
14:33:53 1237  	   out_attempt_count
14:33:53 1238  	 from
14:33:53 1239  	   transaction tr
14:33:53 1240  	 inner join
14:33:53 1241  	   transaction_attempt ta
14:33:53 1242  	 on (tr.id = ta.transaction_id)
14:33:53 1243  	 where
14:33:53 1244  	   tr.ID = temp_transaction_id;
14:33:53 1245  
14:33:53 1246  	 out_attempt_count := out_attempt_count + 1;
14:33:53 1247  
14:33:53 1248  EXCEPTION
14:33:53 1249  WHEN BAD_CHARGE_ID THEN
14:33:53 1250  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1251  	   SPROC_NAME, 'No such charge');
14:33:53 1252  WHEN OTHERS THEN
14:33:53 1253  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1254  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1255  end GET_NEXT_ATTEMPT_NUMBER;
14:33:53 1256  /******************************************************************************/
14:33:53 1257  
14:33:53 1258  END PROCS_TRANSACTION_V22;
14:33:53 1259  .
14:33:53 SQL> /

Package body created.

Elapsed: 00:00:00.08
14:33:53 SQL> 
14:33:53 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_LICENSE_V22" AS
14:33:53   2  
14:33:53   3  PROCEDURE CREATE_LICENSE(
14:33:53   4  /*
14:33:53   5  Throws exceptions:
14:33:53   6  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53   7  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53   8  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:53   9  */
14:33:53  10  	in_status_id		    IN NUMBER,
14:33:53  11  	in_needs_entitlements	    IN NUMBER,
14:33:53  12  	in_start_date		    IN DATE,
14:33:53  13  	in_end_date		    IN DATE,
14:33:53  14  	in_offer_id		    IN NUMBER,
14:33:53  15  	in_subscription_id	    IN NUMBER,
14:33:53  16  	in_invoice_id		    IN NUMBER,
14:33:53  17  	in_created_by		    IN VARCHAR2,
14:33:53  18  	in_is_extension 	    IN NUMBER,
14:33:53  19  	in_current_offer_index	    IN NUMBER,
14:33:53  20  	in_current_offer_recurr_num IN NUMBER,
14:33:53  21  	out_license_id		    OUT NUMBER
14:33:53  22  ) AS
14:33:53  23  -- VARIABLES
14:33:53  24  SPROC_NAME	   CONSTANT VARCHAR2(14) := 'CREATE_LICENSE';
14:33:53  25  temp_offer_id	   NUMBER;
14:33:53  26  temp_subscription_id NUMBER;
14:33:53  27  temp_invoice_id	   NUMBER;
14:33:53  28  
14:33:53  29  var_new_license_id NUMBER;
14:33:53  30  var_offer_duration VARCHAR2(30);
14:33:53  31  
14:33:53  32  var_offer_ym_interval INTERVAL YEAR TO MONTH;
14:33:53  33  var_offer_ds_interval INTERVAL DAY(3) TO SECOND;
14:33:53  34  var_offer_years	    NUMBER;
14:33:53  35  var_offer_months	    NUMBER;
14:33:53  36  var_offer_days	    NUMBER;
14:33:53  37  
14:33:53  38  -- EXCEPTIONS
14:33:53  39  BAD_OFFER_ID	     EXCEPTION;
14:33:53  40  BAD_SUBSCRIPTION_ID    EXCEPTION;
14:33:53  41  BAD_INVOICE_ID	     EXCEPTION;
14:33:53  42  BAD_OFFER_DURATION     EXCEPTION;
14:33:53  43  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:53  44  BEGIN
14:33:53  45  
14:33:53  46  	-- TODO:
14:33:53  47  	---- check incoming data: in_current_offer_index, in_current_offer_recurr_num, in_is_extension
14:33:53  48  
14:33:53  49  	out_license_id := NULL;
14:33:53  50  
14:33:53  51  	-- get offer id and offer entitlement duration
14:33:53  52  	BEGIN
14:33:53  53  	  SELECT
14:33:53  54  	    OFFER.ID,
14:33:53  55  	    OFFER.ENTITLEMENT_DURATION
14:33:53  56  	    into
14:33:53  57  	    temp_offer_id,
14:33:53  58  	    var_offer_duration
14:33:53  59  	  FROM
14:33:53  60  	    OFFER
14:33:53  61  	  WHERE
14:33:53  62  	    OFFER.ID = in_offer_id;
14:33:53  63  	  EXCEPTION
14:33:53  64  	  WHEN NO_DATA_FOUND THEN
14:33:53  65  	    RAISE BAD_OFFER_ID;
14:33:53  66  	END;
14:33:53  67  
14:33:53  68  	-- Check that subscription exists
14:33:53  69  	BEGIN
14:33:53  70  	  SELECT
14:33:53  71  	    SUBSCRIPTION.ID into temp_subscription_id
14:33:53  72  	  FROM
14:33:53  73  	    SUBSCRIPTION
14:33:53  74  	  WHERE
14:33:53  75  	    SUBSCRIPTION.ID = in_subscription_id;
14:33:53  76  	  EXCEPTION
14:33:53  77  	  WHEN NO_DATA_FOUND THEN
14:33:53  78  	    RAISE BAD_SUBSCRIPTION_ID;
14:33:53  79  	END;
14:33:53  80  
14:33:53  81  	-- Check that invoice exists
14:33:53  82  	BEGIN
14:33:53  83  	  SELECT
14:33:53  84  	    INVOICE.ID into temp_invoice_id
14:33:53  85  	  FROM
14:33:53  86  	    INVOICE
14:33:53  87  	  WHERE
14:33:53  88  	    INVOICE.ID = in_invoice_id;
14:33:53  89  	  EXCEPTION
14:33:53  90  	  WHEN NO_DATA_FOUND THEN
14:33:53  91  	    RAISE BAD_INVOICE_ID;
14:33:53  92  	END;
14:33:53  93  
14:33:53  94  	-- convert offer duration into intervals
14:33:53  95  	BEGIN
14:33:53  96  	  PROCS_COMMON_V22.ISO8601DURATION_TO_INTERVALS(
14:33:53  97  	    var_offer_duration,
14:33:53  98  	    var_offer_years,
14:33:53  99  	    var_offer_months,
14:33:53 100  	    var_offer_days);
14:33:53 101  	  var_offer_ym_interval := var_offer_years||'-'||var_offer_months;
14:33:53 102  	  var_offer_ds_interval := var_offer_days||' 0:0:0';
14:33:53 103  	  EXCEPTION
14:33:53 104  	    WHEN OTHERS THEN
14:33:53 105  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:53 106  	      RAISE BAD_OFFER_DURATION;
14:33:53 107  	END;
14:33:53 108  
14:33:53 109  	-- insert new row into license table
14:33:53 110  	PROCS_LICENSE_CRU_V22.CREATE_LICENSE(
14:33:53 111  	  out_license_id	      => var_new_license_id,
14:33:53 112  	  in_license_status_id	      => in_status_id,
14:33:53 113  	  in_needs_entitlements       => in_needs_entitlements,
14:33:53 114  	  in_start_date 	      => in_start_date,
14:33:53 115  	  in_offer_id		      => in_offer_id,
14:33:53 116  	  in_subscription_id	      => in_subscription_id,
14:33:53 117  	  in_invoice_id 	      => in_invoice_id,
14:33:53 118  	  in_end_date		      => NVL(in_end_date, in_start_date + var_offer_ym_interval + var_offer_ds_interval),
14:33:53 119  	  in_created_by 	      => in_created_by,
14:33:53 120  	  in_is_extension	      => in_is_extension,
14:33:53 121  	  in_current_offer_index      => in_current_offer_index,
14:33:53 122  	  in_current_offer_recurr_num => in_current_offer_recurr_num
14:33:53 123  	);
14:33:53 124  
14:33:53 125  	out_license_id := var_new_license_id;
14:33:53 126  
14:33:53 127  EXCEPTION
14:33:53 128  WHEN BAD_OFFER_DURATION THEN
14:33:53 129  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 130  	  SPROC_NAME, 'Bad offer duration format', EXCEPTION_MESSAGE);
14:33:53 131  WHEN BAD_OFFER_ID THEN
14:33:53 132  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 133  	  SPROC_NAME, 'No such offer');
14:33:53 134  WHEN BAD_SUBSCRIPTION_ID THEN
14:33:53 135  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 136  	  SPROC_NAME, 'No such subscription');
14:33:53 137  WHEN BAD_INVOICE_ID THEN
14:33:53 138  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 139  	  SPROC_NAME, 'No such invoice');
14:33:53 140  WHEN OTHERS THEN
14:33:53 141  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 142  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 143  END;
14:33:53 144  
14:33:53 145  /******************************************************************************/
14:33:53 146  
14:33:53 147  PROCEDURE UPDATE_LICENSE_STATUS(
14:33:53 148  	  in_license_id     IN NUMBER,
14:33:53 149  	  in_license_status IN NUMBER,
14:33:53 150  	  in_updated_by     IN VARCHAR2,
14:33:53 151  	  in_ent_end	    IN NUMBER DEFAULT GLOBAL_CONSTANTS_V22.FALSE
14:33:53 152  ) AS
14:33:53 153  SPROC_NAME CONSTANT VARCHAR2(21) := 'UPDATE_LICENSE_STATUS';
14:33:53 154  -- VARIABLES
14:33:53 155  temp_license_id NUMBER;
14:33:53 156  -- EXCEPTIONS
14:33:53 157  BAD_LICENSE_ID	     EXCEPTION;
14:33:53 158  BAD_LICENSE_STATUS     EXCEPTION;
14:33:53 159  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:53 160  BEGIN
14:33:53 161  
14:33:53 162  	BEGIN
14:33:53 163  	  SELECT
14:33:53 164  	    ID into temp_license_id
14:33:53 165  	  FROM
14:33:53 166  	    LICENSE
14:33:53 167  	  WHERE
14:33:53 168  	    LICENSE.ID = in_license_id;
14:33:53 169  	  EXCEPTION
14:33:53 170  	    WHEN NO_DATA_FOUND THEN
14:33:53 171  	      RAISE BAD_LICENSE_ID;
14:33:53 172  	END;
14:33:53 173  
14:33:53 174  	IF in_license_status != GLOBAL_STATUSES_V22.LICENSE_CLOSED
14:33:53 175  	   AND in_license_status != GLOBAL_STATUSES_V22.LICENSE_ACTIVE
14:33:53 176  	   AND in_license_status != GLOBAL_STATUSES_V22.LICENSE_IN_GRACE_PERIOD THEN
14:33:53 177  	  RAISE BAD_LICENSE_STATUS;
14:33:53 178  	END IF;
14:33:53 179  
14:33:53 180  	IF (in_ent_end is not null and in_ent_end = GLOBAL_CONSTANTS_V22.TRUE) then
14:33:53 181  	  PROCS_LICENSE_CRU_V22.UPDATE_LICENSE(
14:33:53 182  	    in_license_id	 => in_license_id,
14:33:53 183  	    in_updated_by	 => in_updated_by,
14:33:53 184  	    in_license_status_id => in_license_status,
14:33:53 185  	    in_entitlement_end_date	 => sysdate
14:33:53 186  	  );
14:33:53 187  	ELSE
14:33:53 188  	  PROCS_LICENSE_CRU_V22.UPDATE_LICENSE(
14:33:53 189  	    in_license_id	 => in_license_id,
14:33:53 190  	    in_updated_by	 => in_updated_by,
14:33:53 191  	    in_license_status_id => in_license_status
14:33:53 192  	  );
14:33:53 193  	END IF;
14:33:53 194  
14:33:53 195  EXCEPTION
14:33:53 196  WHEN BAD_LICENSE_STATUS THEN
14:33:53 197  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:53 198  	  SPROC_NAME, 'Bad status id');
14:33:53 199  WHEN BAD_LICENSE_ID THEN
14:33:53 200  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 201  	  SPROC_NAME, 'No such license');
14:33:53 202  WHEN OTHERS THEN
14:33:53 203  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 204  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 205  END UPDATE_LICENSE_STATUS;
14:33:53 206  
14:33:53 207  /******************************************************************************/
14:33:53 208  
14:33:53 209  PROCEDURE GET_ENDING_LICENSES (
14:33:53 210  	in_hours_number IN NUMBER,
14:33:53 211  	out_result_set	OUT SYS_REFCURSOR
14:33:53 212  ) AS
14:33:53 213  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_ENDING_LICENSES';
14:33:53 214  -- VARIABLES
14:33:53 215  var_days		NUMBER;
14:33:53 216  var_hours 	NUMBER;
14:33:53 217  var_time_interval INTERVAL DAY (3) TO SECOND;
14:33:53 218  BEGIN
14:33:53 219  
14:33:53 220  	var_hours := mod(in_hours_number,24);
14:33:53 221  	var_days := (in_hours_number - var_hours) / 24;
14:33:53 222  	var_time_interval := var_days||' '||var_hours||':0:0';
14:33:53 223  
14:33:53 224  	OPEN out_result_set FOR
14:33:53 225  SELECT * FROM
14:33:53 226  (
14:33:53 227  	SELECT
14:33:53 228  	  LICENSE.ID,
14:33:53 229  	  LICENSE.CREATE_DATE,
14:33:53 230  	  LICENSE.CREATED_BY,
14:33:53 231  	  LICENSE.CURRENT_OFFER_INDEX,
14:33:53 232  	  LICENSE.CURRENT_OFFER_RECURR_NUM,
14:33:53 233  	  LICENSE.END_DATE,
14:33:53 234  	  LICENSE.ENTITLEMENT_END_DATE,
14:33:53 235  	  LICENSE.INVOICE_ID,
14:33:53 236  	  LICENSE.IS_EXTENSION,
14:33:53 237  	  LICENSE.LICENSE_STATUS_ID,
14:33:53 238  	  LICENSE.OFFER_ID,
14:33:53 239  	  LICENSE.START_DATE,
14:33:53 240  	  LICENSE.SUBSCRIPTION_ID,
14:33:53 241  	  LICENSE.UPDATE_DATE,
14:33:53 242  	  LICENSE.UPDATED_BY
14:33:53 243  	FROM
14:33:53 244  	  LICENSE
14:33:53 245  	WHERE
14:33:53 246  	  TO_DATE(LICENSE.END_DATE) <= (current_timestamp + var_time_interval)
14:33:53 247  	  AND LICENSE.LICENSE_STATUS_ID = GLOBAL_STATUSES_V22.LICENSE_ACTIVE
14:33:53 248  	  AND NOT EXISTS
14:33:53 249  	  (
14:33:53 250  	    SELECT NULL
14:33:53 251  	    FROM PROCESS_RETRY_THROTTLE
14:33:53 252  	    WHERE PROCESS_NAME = SPROC_NAME
14:33:53 253  	      AND GENERIC_ID = LICENSE.ID
14:33:53 254  	  )
14:33:53 255  	  AND ROWNUM <= 10000
14:33:53 256  	  ORDER BY dbms_random.value
14:33:53 257  ) WHERE
14:33:53 258  	  ROWNUM <= 1000
14:33:53 259  	  ;
14:33:53 260  EXCEPTION
14:33:53 261  WHEN OTHERS THEN
14:33:53 262  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 263  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 264  END GET_ENDING_LICENSES;
14:33:53 265  
14:33:53 266  
14:33:53 267  /******************************************************************************/
14:33:53 268  
14:33:53 269  PROCEDURE GET_ENDING_LICENSES_CC (
14:33:53 270  	in_hours_number IN NUMBER,
14:33:53 271  	out_result_set	OUT SYS_REFCURSOR,
14:33:53 272  	in_process_name IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE
14:33:53 273  ) AS
14:33:53 274  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_ENDING_LICENSES_CC';
14:33:53 275  -- VARIABLES
14:33:53 276  var_days		NUMBER;
14:33:53 277  var_hours 	NUMBER;
14:33:53 278  var_time_interval INTERVAL DAY (3) TO SECOND;
14:33:53 279  BEGIN
14:33:53 280  
14:33:53 281  	var_hours := mod(in_hours_number,24);
14:33:53 282  	var_days := (in_hours_number - var_hours) / 24;
14:33:53 283  	var_time_interval := var_days||' '||var_hours||':0:0';
14:33:53 284  
14:33:53 285  	OPEN out_result_set FOR
14:33:53 286  SELECT * FROM
14:33:53 287  (
14:33:53 288  	SELECT
14:33:53 289  	  LICENSE.ID,
14:33:53 290  	  LICENSE.CREATE_DATE,
14:33:53 291  	  LICENSE.CREATED_BY,
14:33:53 292  	  LICENSE.CURRENT_OFFER_INDEX,
14:33:53 293  	  LICENSE.CURRENT_OFFER_RECURR_NUM,
14:33:53 294  	  LICENSE.END_DATE,
14:33:53 295  	  LICENSE.ENTITLEMENT_END_DATE,
14:33:53 296  	  LICENSE.INVOICE_ID,
14:33:53 297  	  LICENSE.IS_EXTENSION,
14:33:53 298  	  LICENSE.LICENSE_STATUS_ID,
14:33:53 299  	  LICENSE.OFFER_ID,
14:33:53 300  	  LICENSE.START_DATE,
14:33:53 301  	  LICENSE.SUBSCRIPTION_ID,
14:33:53 302  	  LICENSE.UPDATE_DATE,
14:33:53 303  	  LICENSE.UPDATED_BY
14:33:53 304  	FROM
14:33:53 305  	  LICENSE
14:33:53 306  	WHERE
14:33:53 307  	  TO_DATE(LICENSE.END_DATE) <= (current_timestamp + var_time_interval)
14:33:53 308  	  AND LICENSE.LICENSE_STATUS_ID = GLOBAL_STATUSES_V22.LICENSE_ACTIVE
14:33:53 309  	  AND NOT EXISTS
14:33:53 310  	  (
14:33:53 311  	    SELECT NULL
14:33:53 312  	    FROM PROCESS_RETRY_THROTTLE
14:33:53 313  	    WHERE PROCESS_NAME = in_process_name
14:33:53 314  	      AND GENERIC_ID = LICENSE.INVOICE_ID
14:33:53 315  	  )
14:33:53 316  	  AND ROWNUM <= 10000
14:33:53 317  	  ORDER BY dbms_random.value
14:33:53 318  ) WHERE
14:33:53 319  	  ROWNUM <= 1000
14:33:53 320  	  ;
14:33:53 321  EXCEPTION
14:33:53 322  WHEN OTHERS THEN
14:33:53 323  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 324  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 325  END GET_ENDING_LICENSES_CC;
14:33:53 326  
14:33:53 327  /******************************************************************************/
14:33:53 328  
14:33:53 329  PROCEDURE GET_RECURRING_OFFER (
14:33:53 330  	in_license_id  IN NUMBER,
14:33:53 331  	out_result_set OUT SYS_REFCURSOR
14:33:53 332  ) AS
14:33:53 333  -- VARIABLES
14:33:53 334  SPROC_NAME		    CONSTANT VARCHAR2(19) := 'GET_RECURRING_OFFER';
14:33:53 335  var_offer_chain_id	    NUMBER;
14:33:53 336  var_offer_id		    NUMBER;
14:33:53 337  var_offer_num_recurrences     NUMBER;
14:33:53 338  var_license_cur_offer_rec_num NUMBER;
14:33:53 339  var_offer_index		    NUMBER;
14:33:53 340  -- EXCEPTIONS
14:33:53 341  BAD_LICENSE_ID	     EXCEPTION;
14:33:53 342  CAN_NOT_GET_OFFER_INFO EXCEPTION;
14:33:53 343  BEGIN
14:33:53 344  
14:33:53 345  	BEGIN
14:33:53 346  	  SELECT
14:33:53 347  	    SUBSCRIPTION.OFFER_CHAIN_ID,
14:33:53 348  	    LICENSE.OFFER_ID,
14:33:53 349  	    LICENSE.CURRENT_OFFER_RECURR_NUM
14:33:53 350  	    into
14:33:53 351  	    var_offer_chain_id,
14:33:53 352  	    var_offer_id,
14:33:53 353  	    var_license_cur_offer_rec_num
14:33:53 354  	  FROM
14:33:53 355  	    LICENSE
14:33:53 356  	    INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
14:33:53 357  	  WHERE
14:33:53 358  	    LICENSE.ID = in_license_id;
14:33:53 359  	  EXCEPTION
14:33:53 360  	    WHEN NO_DATA_FOUND THEN
14:33:53 361  	      RAISE BAD_LICENSE_ID;
14:33:53 362  	END;
14:33:53 363  
14:33:53 364  	BEGIN
14:33:53 365  	  SELECT
14:33:53 366  	    OFFER_OFFER_CHAIN.NUM_RECURRENCES,
14:33:53 367  	    OFFER_OFFER_CHAIN.INDEX_VALUE
14:33:53 368  	    into
14:33:53 369  	    var_offer_num_recurrences,
14:33:53 370  	    var_offer_index
14:33:53 371  	  FROM
14:33:53 372  	    OFFER_OFFER_CHAIN
14:33:53 373  	    INNER JOIN OFFER ON OFFER_OFFER_CHAIN.OFFER_ID = OFFER.ID
14:33:53 374  	  WHERE
14:33:53 375  	    OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = var_offer_chain_id
14:33:53 376  	    AND OFFER_OFFER_CHAIN.OFFER_ID = var_offer_id;
14:33:53 377  	  EXCEPTION
14:33:53 378  	    WHEN NO_DATA_FOUND THEN
14:33:53 379  	      RAISE CAN_NOT_GET_OFFER_INFO;
14:33:53 380  	END;
14:33:53 381  
14:33:53 382  	IF var_offer_num_recurrences = 0 THEN
14:33:53 383  	  --out_result_set := NULL;
14:33:53 384  	  -- TODO: Remove this hardcode
14:33:53 385  	  OPEN out_result_set FOR
14:33:53 386  	  SELECT
14:33:53 387  	    OFFER.ID,
14:33:53 388  	    OFFER.OFFER_STATUS_ID,
14:33:53 389  	    OFFER.ENTITLEMENT_DURATION,
14:33:53 390  	    OFFER.CREATED_BY,
14:33:53 391  	    OFFER.CREATE_DATE,
14:33:53 392  	    OFFER.UPDATED_BY,
14:33:53 393  	    OFFER.UPDATE_DATE,
14:33:53 394  	    var_offer_num_recurrences as "RECURRENCE_NUMBER",
14:33:53 395  	    var_offer_index as "OFFER_INDEX"
14:33:53 396  	  FROM
14:33:53 397  	    OFFER_OFFER_CHAIN
14:33:53 398  	    INNER JOIN OFFER ON OFFER_OFFER_CHAIN.OFFER_ID = OFFER.ID
14:33:53 399  	  WHERE ROWNUM = 0;
14:33:53 400  	ELSIF var_license_cur_offer_rec_num = var_offer_num_recurrences THEN
14:33:53 401  	  --out_result_set := NULL;
14:33:53 402  	  -- TODO: Remove this hardcode
14:33:53 403  	  OPEN out_result_set FOR
14:33:53 404  	  SELECT
14:33:53 405  	    OFFER.ID,
14:33:53 406  	    OFFER.OFFER_STATUS_ID,
14:33:53 407  	    OFFER.ENTITLEMENT_DURATION,
14:33:53 408  	    OFFER.CREATED_BY,
14:33:53 409  	    OFFER.CREATE_DATE,
14:33:53 410  	    OFFER.UPDATED_BY,
14:33:53 411  	    OFFER.UPDATE_DATE,
14:33:53 412  	    var_offer_num_recurrences as "RECURRENCE_NUMBER",
14:33:53 413  	    var_offer_index as "OFFER_INDEX"
14:33:53 414  	  FROM
14:33:53 415  	    OFFER_OFFER_CHAIN
14:33:53 416  	    INNER JOIN OFFER ON OFFER_OFFER_CHAIN.OFFER_ID = OFFER.ID
14:33:53 417  	  WHERE ROWNUM = 0;
14:33:53 418  	ELSE
14:33:53 419  	  OPEN out_result_set FOR
14:33:53 420  	  SELECT
14:33:53 421  	    OFFER.ID,
14:33:53 422  	    OFFER.OFFER_STATUS_ID,
14:33:53 423  	    OFFER.ENTITLEMENT_DURATION,
14:33:53 424  	    OFFER.CREATED_BY,
14:33:53 425  	    OFFER.CREATE_DATE,
14:33:53 426  	    OFFER.UPDATED_BY,
14:33:53 427  	    OFFER.UPDATE_DATE,
14:33:53 428  	    var_offer_num_recurrences as "RECURRENCE_NUMBER",
14:33:53 429  	    var_offer_index as "OFFER_INDEX"
14:33:53 430  	  FROM
14:33:53 431  	    OFFER
14:33:53 432  	  WHERE
14:33:53 433  	    OFFER.ID = var_offer_id;
14:33:53 434  	END IF;
14:33:53 435  
14:33:53 436  EXCEPTION
14:33:53 437  WHEN BAD_LICENSE_ID THEN
14:33:53 438  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 439  	  SPROC_NAME, 'No such license');
14:33:53 440  WHEN CAN_NOT_GET_OFFER_INFO THEN
14:33:53 441  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 442  	  SPROC_NAME, 'Could not get offer information. Offer id = '||var_offer_id||', Offer chain id = '||var_offer_chain_id);
14:33:53 443  WHEN OTHERS THEN
14:33:53 444  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 445  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 446  END GET_RECURRING_OFFER;
14:33:53 447  
14:33:53 448  /******************************************************************************/
14:33:53 449  
14:33:53 450  PROCEDURE GET_NEXT_OFFER (
14:33:53 451  /*
14:33:53 452  Throws exceptions:
14:33:53 453  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 454  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 455  */
14:33:53 456  	in_license_id  IN NUMBER,
14:33:53 457  	out_result_set OUT SYS_REFCURSOR
14:33:53 458  ) AS
14:33:53 459  -- VARIABLES
14:33:53 460  SPROC_NAME		CONSTANT VARCHAR2(14) := 'GET_NEXT_OFFER';
14:33:53 461  var_offer_chain_id	NUMBER;
14:33:53 462  var_offer_id		NUMBER;
14:33:53 463  var_license_current_index NUMBER;
14:33:53 464  var_next_offer_index	NUMBER;
14:33:53 465  -- EXCEPTIONS
14:33:53 466  BAD_LICENSE_ID	      EXCEPTION;
14:33:53 467  CAN_NOT_FIND_NEXT_OFFER EXCEPTION;
14:33:53 468  EXCEPTION_MESSAGE       VARCHAR2(1024);
14:33:53 469  BEGIN
14:33:53 470  
14:33:53 471  	BEGIN
14:33:53 472  	  SELECT
14:33:53 473  	    SUBSCRIPTION.OFFER_CHAIN_ID,
14:33:53 474  	    LICENSE.OFFER_ID,
14:33:53 475  	    LICENSE.CURRENT_OFFER_INDEX
14:33:53 476  	    into
14:33:53 477  	    var_offer_chain_id,
14:33:53 478  	    var_offer_id,
14:33:53 479  	    var_license_current_index
14:33:53 480  	  FROM
14:33:53 481  	    LICENSE
14:33:53 482  	    INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
14:33:53 483  	  WHERE
14:33:53 484  	    LICENSE.ID = in_license_id;
14:33:53 485  	  EXCEPTION
14:33:53 486  	    WHEN NO_DATA_FOUND THEN
14:33:53 487  	      RAISE BAD_LICENSE_ID;
14:33:53 488  	END;
14:33:53 489  
14:33:53 490  	BEGIN
14:33:53 491  	  var_next_offer_index := PROCS_OFFER_CHAIN_V22.GET_NEXT_OFFER_INDEX(
14:33:53 492  	    var_offer_chain_id,
14:33:53 493  	    var_license_current_index
14:33:53 494  	  );
14:33:53 495  	  EXCEPTION
14:33:53 496  	    WHEN OTHERS THEN
14:33:53 497  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:53 498  	      RAISE CAN_NOT_FIND_NEXT_OFFER;
14:33:53 499  	END;
14:33:53 500  
14:33:53 501  	IF var_next_offer_index IS NULL THEN
14:33:53 502  	  -- RETURN NULL;
14:33:53 503  	  -- TODO: Remove this hardcode
14:33:53 504  	  OPEN out_result_set FOR
14:33:53 505  	  SELECT
14:33:53 506  	    OFFER.ID,
14:33:53 507  	    OFFER.OFFER_STATUS_ID,
14:33:53 508  	    OFFER.ENTITLEMENT_DURATION,
14:33:53 509  	    OFFER.CREATED_BY,
14:33:53 510  	    OFFER.CREATE_DATE,
14:33:53 511  	    OFFER.UPDATED_BY,
14:33:53 512  	    OFFER.UPDATE_DATE,
14:33:53 513  	    OFFER_OFFER_CHAIN.NUM_RECURRENCES as "RECURRENCE_NUMBER"
14:33:53 514  	  FROM
14:33:53 515  	    OFFER_OFFER_CHAIN
14:33:53 516  	    INNER JOIN OFFER ON OFFER_OFFER_CHAIN.OFFER_ID = OFFER.ID
14:33:53 517  	  WHERE
14:33:53 518  	    1=2;
14:33:53 519  	ELSE
14:33:53 520  	  OPEN out_result_set FOR
14:33:53 521  	  SELECT
14:33:53 522  	    OFFER.ID,
14:33:53 523  	    OFFER.OFFER_STATUS_ID,
14:33:53 524  	    OFFER.ENTITLEMENT_DURATION,
14:33:53 525  	    OFFER.CREATED_BY,
14:33:53 526  	    OFFER.CREATE_DATE,
14:33:53 527  	    OFFER.UPDATED_BY,
14:33:53 528  	    OFFER.UPDATE_DATE,
14:33:53 529  	    OFFER_OFFER_CHAIN.NUM_RECURRENCES as "RECURRENCE_NUMBER"
14:33:53 530  	  FROM
14:33:53 531  	    OFFER_OFFER_CHAIN
14:33:53 532  	    INNER JOIN OFFER ON OFFER_OFFER_CHAIN.OFFER_ID = OFFER.ID
14:33:53 533  	  WHERE
14:33:53 534  	    OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = var_offer_chain_id
14:33:53 535  	    AND OFFER_OFFER_CHAIN.INDEX_VALUE = var_next_offer_index;
14:33:53 536  	END IF;
14:33:53 537  
14:33:53 538  EXCEPTION
14:33:53 539  WHEN BAD_LICENSE_ID THEN
14:33:53 540  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 541  	  SPROC_NAME, 'No such license');
14:33:53 542  WHEN CAN_NOT_FIND_NEXT_OFFER THEN
14:33:53 543  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 544  	  SPROC_NAME, 'Could not find next offer', EXCEPTION_MESSAGE);
14:33:53 545  WHEN OTHERS THEN
14:33:53 546  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 547  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 548  END GET_NEXT_OFFER;
14:33:53 549  
14:33:53 550  /******************************************************************************/
14:33:53 551  
14:33:53 552  PROCEDURE GET_GROUP_ID_BY_LICENSE_ID (
14:33:53 553  	in_license_id IN NUMBER,
14:33:53 554  	out_group_id  OUT NUMBER
14:33:53 555  ) AS
14:33:53 556  -- VARIABLES
14:33:53 557  SPROC_NAME	  CONSTANT VARCHAR2(26) := 'GET_GROUP_ID_BY_LICENSE_ID';
14:33:53 558  var_subscription_id NUMBER;
14:33:53 559  var_group_id	  NUMBER;
14:33:53 560  -- EXCEPTIONS
14:33:53 561  BAD_LICENSE_ID	   EXCEPTION;
14:33:53 562  CAN_NOT_GET_GROUP_ID EXCEPTION;
14:33:53 563  BEGIN
14:33:53 564  
14:33:53 565  	-- Get subscription id
14:33:53 566  	BEGIN
14:33:53 567  	  SELECT
14:33:53 568  	    LICENSE.SUBSCRIPTION_ID into var_subscription_id
14:33:53 569  	  FROM
14:33:53 570  	    LICENSE
14:33:53 571  	  WHERE
14:33:53 572  	    LICENSE.ID = in_license_id;
14:33:53 573  	  EXCEPTION
14:33:53 574  	    WHEN NO_DATA_FOUND THEN
14:33:53 575  	      RAISE BAD_LICENSE_ID;
14:33:53 576  	END;
14:33:53 577  
14:33:53 578  	-- Get group id
14:33:53 579  	BEGIN
14:33:53 580  	  SELECT
14:33:53 581  	    ACCOUNT.GROUP_ID into var_group_id
14:33:53 582  	  FROM
14:33:53 583  	    SUBSCRIPTION
14:33:53 584  	    INNER JOIN ACCOUNT ON SUBSCRIPTION.ACCOUNT_ID = ACCOUNT.ID
14:33:53 585  	  WHERE
14:33:53 586  	    SUBSCRIPTION.ID = var_subscription_id;
14:33:53 587  	  EXCEPTION
14:33:53 588  	    WHEN NO_DATA_FOUND THEN
14:33:53 589  	      RAISE CAN_NOT_GET_GROUP_ID;
14:33:53 590  	END;
14:33:53 591  
14:33:53 592  	out_group_id := var_group_id;
14:33:53 593  
14:33:53 594  EXCEPTION
14:33:53 595  WHEN BAD_LICENSE_ID THEN
14:33:53 596  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 597  	  SPROC_NAME, 'No such license');
14:33:53 598  WHEN CAN_NOT_GET_GROUP_ID THEN
14:33:53 599  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 600  	  SPROC_NAME, 'Could not get group id');
14:33:53 601  WHEN OTHERS THEN
14:33:53 602  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 603  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 604  END GET_GROUP_ID_BY_LICENSE_ID;
14:33:53 605  
14:33:53 606  /******************************************************************************/
14:33:53 607  
14:33:53 608  PROCEDURE GET_NEED_ENTITLEMENTS_LICENSES (
14:33:53 609  	out_result_set OUT SYS_REFCURSOR
14:33:53 610  ) AS
14:33:53 611  BEGIN
14:33:53 612  	OPEN out_result_set FOR
14:33:53 613  SELECT * FROM
14:33:53 614  (
14:33:53 615  	SELECT
14:33:53 616  	  LICENSE.ID,
14:33:53 617  	  LICENSE.INVOICE_ID,
14:33:53 618  	  LICENSE.IS_EXTENSION,
14:33:53 619  	  LICENSE.START_DATE,
14:33:53 620  	  LICENSE.END_DATE,
14:33:53 621  	  LICENSE.ENTITLEMENT_END_DATE,
14:33:53 622  	  LICENSE.CURRENT_OFFER_INDEX,
14:33:53 623  	  LICENSE.CURRENT_OFFER_RECURR_NUM,
14:33:53 624  	  LICENSE.CREATE_DATE,
14:33:53 625  	  LICENSE.CREATED_BY,
14:33:53 626  	  LICENSE.LICENSE_STATUS_ID,
14:33:53 627  	  LICENSE.OFFER_ID,
14:33:53 628  	  LICENSE.SUBSCRIPTION_ID,
14:33:53 629  	  LICENSE.UPDATE_DATE,
14:33:53 630  	  LICENSE.UPDATED_BY,
14:33:53 631  	  LICENSE.NEEDS_ENTITLEMENTS
14:33:53 632  	FROM
14:33:53 633  	  LICENSE
14:33:53 634  	WHERE
14:33:53 635  	  LICENSE.NEEDS_ENTITLEMENTS = GLOBAL_CONSTANTS_V22.TRUE
14:33:53 636  	AND ROWNUM <= 5000
14:33:53 637  	ORDER BY dbms_random.value
14:33:53 638  ) WHERE
14:33:53 639  	ROWNUM <= 500;
14:33:53 640  
14:33:53 641  END GET_NEED_ENTITLEMENTS_LICENSES;
14:33:53 642  
14:33:53 643  /******************************************************************************/
14:33:53 644  
14:33:53 645  PROCEDURE UPDATE_NEED_ENTITLEMENTS_FLAG (
14:33:53 646  	in_license_id	      IN NUMBER,
14:33:53 647  	in_needs_entitlements IN NUMBER,
14:33:53 648  	in_updated_by	      IN VARCHAR2
14:33:53 649  ) AS
14:33:53 650  SPROC_NAME CONSTANT VARCHAR2(29) := 'UPDATE_NEED_ENTITLEMENTS_FLAG';
14:33:53 651  -- VARIABLES
14:33:53 652  temp_license_id NUMBER;
14:33:53 653  -- EXCEPTIONS
14:33:53 654  BAD_LICENSE_ID	     EXCEPTION;
14:33:53 655  BAD_ENTITLEMENTS_FLAG  EXCEPTION;
14:33:53 656  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:53 657  BEGIN
14:33:53 658  
14:33:53 659  	IF in_needs_entitlements != GLOBAL_CONSTANTS_V22.TRUE
14:33:53 660  	  AND in_needs_entitlements != GLOBAL_CONSTANTS_V22.FALSE THEN
14:33:53 661  	  RAISE BAD_ENTITLEMENTS_FLAG;
14:33:53 662  	END IF;
14:33:53 663  
14:33:53 664  	BEGIN
14:33:53 665  	  SELECT
14:33:53 666  	    LICENSE.ID into temp_license_id
14:33:53 667  	  FROM
14:33:53 668  	    LICENSE
14:33:53 669  	  WHERE
14:33:53 670  	    LICENSE.ID = in_license_id;
14:33:53 671  	  EXCEPTION
14:33:53 672  	    WHEN NO_DATA_FOUND THEN
14:33:53 673  	      RAISE BAD_LICENSE_ID;
14:33:53 674  	END;
14:33:53 675  
14:33:53 676  	PROCS_LICENSE_CRU_V22.UPDATE_LICENSE(
14:33:53 677  	  in_license_id 	=> in_license_id,
14:33:53 678  	  in_needs_entitlements => in_needs_entitlements,
14:33:53 679  	  in_updated_by 	=> in_updated_by
14:33:53 680  	);
14:33:53 681  
14:33:53 682  EXCEPTION
14:33:53 683  WHEN BAD_ENTITLEMENTS_FLAG THEN
14:33:53 684  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:53 685  	  SPROC_NAME, 'Bad entitlements flag value');
14:33:53 686  WHEN BAD_LICENSE_ID THEN
14:33:53 687  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 688  	  SPROC_NAME, 'No such license');
14:33:53 689  WHEN OTHERS THEN
14:33:53 690  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 691  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 692  END UPDATE_NEED_ENTITLEMENTS_FLAG;
14:33:53 693  
14:33:53 694  
14:33:53 695  /******************************************************************************/
14:33:53 696  
14:33:53 697  PROCEDURE GET_ENDED_GC_LICENSES (
14:33:53 698  	out_result_set		OUT SYS_REFCURSOR,
14:33:53 699  	in_hours_number 	IN NUMBER DEFAULT 14*24,
14:33:53 700  	in_num_rows		IN NUMBER DEFAULT 10000,
14:33:53 701  	in_process_name IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE
14:33:53 702  ) AS
14:33:53 703  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_ENDED_GC_INVOICES';
14:33:53 704  var_days		NUMBER;
14:33:53 705  var_hours 	NUMBER;
14:33:53 706  var_time_interval INTERVAL DAY (3) TO SECOND;
14:33:53 707  BEGIN
14:33:53 708  	var_hours := mod(in_hours_number,24);
14:33:53 709  	var_days := (in_hours_number - var_hours) / 24;
14:33:53 710  	var_time_interval := var_days||' '||var_hours||':0:0';
14:33:53 711  	OPEN out_result_set FOR
14:33:53 712  SELECT * FROM
14:33:53 713  (
14:33:53 714  	SELECT
14:33:53 715  	  l.ID,
14:33:53 716  	  l.CREATE_DATE,
14:33:53 717  	  l.CREATED_BY,
14:33:53 718  	  l.CURRENT_OFFER_INDEX,
14:33:53 719  	  l.CURRENT_OFFER_RECURR_NUM,
14:33:53 720  	  l.END_DATE,
14:33:53 721  	  l.ENTITLEMENT_END_DATE,
14:33:53 722  	  l.INVOICE_ID,
14:33:53 723  	  l.IS_EXTENSION,
14:33:53 724  	  l.LICENSE_STATUS_ID,
14:33:53 725  	  l.OFFER_ID,
14:33:53 726  	  l.START_DATE,
14:33:53 727  	  l.SUBSCRIPTION_ID,
14:33:53 728  	  l.UPDATE_DATE,
14:33:53 729  	  l.UPDATED_BY
14:33:53 730  	FROM
14:33:53 731  	  GIFT_CERTIFICATE gc
14:33:53 732  	  INNER JOIN INVOICE i ON i.id = gc.PURCHASE_INVOICE_ID
14:33:53 733  	  INNER JOIN LICENSE l ON l.invoice_id = i.id
14:33:53 734  	  LEFT JOIN SUBSCRIPTION s ON s.id = l.subscription_id
14:33:53 735  	WHERE
14:33:53 736  	  l.LICENSE_STATUS_ID != GLOBAL_STATUSES_V22.LICENSE_ACTIVE
14:33:53 737  	  AND l.ENTITLEMENT_END_DATE <= (current_timestamp)
14:33:53 738  	  AND l.ENTITLEMENT_END_DATE > (current_timestamp - var_time_interval)
14:33:53 739  	  AND s.subscription_status_id = GLOBAL_STATUSES_V22.SUBSCRIPTION_CLOSED
14:33:53 740  	  AND NOT EXISTS (
14:33:53 741  	    SELECT NULL
14:33:53 742  	    FROM PROCESS_RETRY_THROTTLE
14:33:53 743  	    WHERE PROCESS_NAME = in_process_name
14:33:53 744  	      AND GENERIC_ID = l.ID
14:33:53 745  	  )
14:33:53 746  	  AND ROWNUM <= in_num_rows*10
14:33:53 747  	  ORDER BY dbms_random.value
14:33:53 748  ) WHERE
14:33:53 749  	  ROWNUM <= in_num_rows
14:33:53 750  	  GROUP BY SUBSCRIPTION_ID;
14:33:53 751  EXCEPTION
14:33:53 752  WHEN OTHERS THEN
14:33:53 753  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 754  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 755  END GET_ENDED_GC_LICENSES;
14:33:53 756  
14:33:53 757  PROCEDURE GET_LICENSE_BY_ID (
14:33:53 758  	in_license_id  IN NUMBER,
14:33:53 759  	out_result_set OUT SYS_REFCURSOR
14:33:53 760  ) AS
14:33:53 761  SPROC_NAME CONSTANT VARCHAR2(17) := 'GET_LICENSE_BY_ID';
14:33:53 762  -- VARIABLES
14:33:53 763  temp_license_id NUMBER;
14:33:53 764  -- EXCEPTIONS
14:33:53 765  BAD_LICENSE_ID EXCEPTION;
14:33:53 766  BEGIN
14:33:53 767  
14:33:53 768  	BEGIN
14:33:53 769  	  SELECT
14:33:53 770  	    l.id into temp_license_id
14:33:53 771  	  FROM
14:33:53 772  	    license l
14:33:53 773  	  WHERE
14:33:53 774  	    l.id = in_license_id;
14:33:53 775  	  EXCEPTION
14:33:53 776  	    WHEN NO_DATA_FOUND THEN
14:33:53 777  	      RAISE BAD_LICENSE_ID;
14:33:53 778  	END;
14:33:53 779  
14:33:53 780  	OPEN out_result_set FOR
14:33:53 781  	SELECT
14:33:53 782  	  l.id,
14:33:53 783  	  l.license_status_id,
14:33:53 784  	  l.subscription_id,
14:33:53 785  	  l.invoice_id,
14:33:53 786  	  l.offer_id,
14:33:53 787  	  l.start_date,
14:33:53 788  	  l.end_date,
14:33:53 789  	  l.entitlement_end_date,
14:33:53 790  	  l.is_extension,
14:33:53 791  	  l.create_date,
14:33:53 792  	  l.created_by,
14:33:53 793  	  l.update_date,
14:33:53 794  	  l.updated_by,
14:33:53 795  	  l.current_offer_index,
14:33:53 796  	  l.current_offer_recurr_num,
14:33:53 797  	  l.needs_entitlements
14:33:53 798  	FROM
14:33:53 799  	  LICENSE l
14:33:53 800  	WHERE
14:33:53 801  	  l.id = in_license_id;
14:33:53 802  
14:33:53 803  EXCEPTION
14:33:53 804  WHEN BAD_LICENSE_ID THEN
14:33:53 805  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 806  	  SPROC_NAME, 'No such license');
14:33:53 807  WHEN OTHERS THEN
14:33:53 808  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 809  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 810  END GET_LICENSE_BY_ID;
14:33:53 811  
14:33:53 812  PROCEDURE UP_LATEST_LICE_END_BY_SUBID (
14:33:53 813  	in_subscription_id IN NUMBER,
14:33:53 814  	in_end_date IN DATE,
14:33:53 815  	in_updated_by IN VARCHAR2
14:33:53 816  ) AS
14:33:53 817  SPROC_NAME CONSTANT VARCHAR2(32) := 'UP_LATEST_LICE_END_BY_SUBID';
14:33:53 818  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:53 819  var_latest_lice NUMBER;
14:33:53 820  BEGIN
14:33:53 821  	SELECT max(id)
14:33:53 822  	INTO  var_latest_lice
14:33:53 823  	FROM LICENSE
14:33:53 824  	WHERE
14:33:53 825  	  subscription_id = in_subscription_id
14:33:53 826  	;
14:33:53 827  
14:33:53 828  	PROCS_LICENSE_CRU_V22.UPDATE_LICENSE(
14:33:53 829  	  in_license_id        => var_latest_lice,
14:33:53 830  	  in_updated_by        => in_updated_by,
14:33:53 831  	  in_needs_entitlements => GLOBAL_CONSTANTS_V22.TRUE,
14:33:53 832  	  in_end_date	       => in_end_date,
14:33:53 833  	  in_entitlement_end_date => in_end_date
14:33:53 834  	);
14:33:53 835  
14:33:53 836  EXCEPTION
14:33:53 837  WHEN NO_DATA_FOUND THEN
14:33:53 838  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 839  	  SPROC_NAME, 'No licenses from subscription', SQLERRM);
14:33:53 840  WHEN OTHERS THEN
14:33:53 841  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 842  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 843  END UP_LATEST_LICE_END_BY_SUBID;
14:33:53 844  
14:33:53 845  PROCEDURE GET_GRACE_LICE_FOR_FINAL_TRANS (
14:33:53 846  	in_days_before_close	 IN NUMBER,
14:33:53 847  	in_num_licenses_to_fetch IN NUMBER,
14:33:53 848  	out_result_set		 OUT SYS_REFCURSOR
14:33:53 849  ) AS
14:33:53 850  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GRACE_LICE_FOR_FINAL_TRANS';
14:33:53 851  BEGIN
14:33:53 852  	OPEN out_result_set FOR
14:33:53 853  	SELECT
14:33:53 854  	    *
14:33:53 855  	FROM
14:33:53 856  	    (
14:33:53 857  		SELECT
14:33:53 858  		    l.id
14:33:53 859  		FROM
14:33:53 860  		    license l
14:33:53 861  		JOIN
14:33:53 862  		    invoice i
14:33:53 863  		ON
14:33:53 864  		    l.invoice_id = i.id
14:33:53 865  		WHERE
14:33:53 866  		    i.invoice_status_id = GLOBAL_STATUSES_V22.INVOICE_OPEN
14:33:53 867  		AND l.license_status_id = GLOBAL_STATUSES_V22.LICENSE_IN_GRACE_PERIOD
14:33:53 868  		AND SYSDATE + in_days_before_close >= l.grace_end_date
14:33:53 869  		AND NOT EXISTS
14:33:53 870  		    (
14:33:53 871  			SELECT
14:33:53 872  			    1
14:33:53 873  			FROM
14:33:53 874  			    charge c
14:33:53 875  			WHERE
14:33:53 876  			    c.invoice_id = i.id
14:33:53 877  			AND c.charge_status_id = GLOBAL_STATUSES_V22.CHARGE_OPENED)
14:33:53 878  		AND rownum <= in_num_licenses_to_fetch * 10
14:33:53 879  		ORDER BY
14:33:53 880  		    dbms_random.value)
14:33:53 881  	WHERE
14:33:53 882  	    rownum <= in_num_licenses_to_fetch;
14:33:53 883  END GET_GRACE_LICE_FOR_FINAL_TRANS;
14:33:53 884  
14:33:53 885  END PROCS_LICENSE_V22;
14:33:53 886  .
14:33:53 SQL> /

Package body created.

Elapsed: 00:00:00.06
14:33:53 SQL> 
14:33:53 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_CHARGE_V22" AS
14:33:53   2  
14:33:53   3  PROCEDURE CREATE_CHARGE(
14:33:53   4  /*
14:33:53   5  Throws exceptions:
14:33:53   6  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53   7  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53   8  */
14:33:53   9  	in_invoice_id	      IN NUMBER,
14:33:53  10  	in_transaction_id     IN NUMBER,
14:33:53  11  	in_instrument_type_id IN NUMBER,
14:33:53  12  	in_instrument_id      IN NUMBER,
14:33:53  13  	in_charge_amount      IN NUMBER,
14:33:53  14  	in_created_by	      IN VARCHAR2,
14:33:53  15  	in_charge_status_id   IN NUMBER,
14:33:53  16  	out_charge_id	      OUT NUMBER
14:33:53  17  ) AS
14:33:53  18  PROCS_NAME	  CONSTANT VARCHAR2(13) := 'CREATE_CHARGE';
14:33:53  19  -- VARIABLES
14:33:53  20  temp_invoice_id	  NUMBER;
14:33:53  21  temp_transaction_id NUMBER;
14:33:53  22  var_new_charge_id   NUMBER;
14:33:53  23  -- EXCEPTIONS
14:33:53  24  BAD_INVOICE_ID	     EXCEPTION;
14:33:53  25  BAD_TRANSACTION_ID     EXCEPTION;
14:33:53  26  BAD_PAYPAL_ID	     EXCEPTION;
14:33:53  27  BAD_CREDIT_CARD_ID     EXCEPTION;
14:33:53  28  BAD_INSTRUMENT_TYPE    EXCEPTION;
14:33:53  29  BAD_CHARGE_STATUS_ID   EXCEPTION;
14:33:53  30  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:53  31  BEGIN
14:33:53  32  	-- Check that incoming data is correct
14:33:53  33  	IF in_instrument_type_id != GLOBAL_ENUMS_V22.INSTRUMENT_CREDIT_CARD
14:33:53  34  	  AND in_instrument_type_id != GLOBAL_ENUMS_V22.INSTRUMENT_PAYPAL THEN
14:33:53  35  	  RAISE BAD_INSTRUMENT_TYPE;
14:33:53  36  	END IF;
14:33:53  37  
14:33:53  38  	-- Check that status is correct
14:33:53  39  	IF in_charge_status_id != GLOBAL_STATUSES_V22.CHARGE_OPENED
14:33:53  40  	  AND in_charge_status_id != GLOBAL_STATUSES_V22.CHARGE_PROCESSED
14:33:53  41  	  AND in_charge_status_id != GLOBAL_STATUSES_V22.CHARGE_CANCELED THEN
14:33:53  42  	  RAISE BAD_CHARGE_STATUS_ID;
14:33:53  43  	END IF;
14:33:53  44  
14:33:53  45  	-- Check that invoice exists
14:33:53  46  	BEGIN
14:33:53  47  	  SELECT
14:33:53  48  	    INVOICE.ID into temp_invoice_id
14:33:53  49  	  FROM
14:33:53  50  	    INVOICE
14:33:53  51  	  WHERE
14:33:53  52  	    INVOICE.ID = in_invoice_id;
14:33:53  53  	  EXCEPTION
14:33:53  54  	    WHEN NO_DATA_FOUND THEN
14:33:53  55  	      RAISE BAD_INVOICE_ID;
14:33:53  56  	END;
14:33:53  57  
14:33:53  58  	-- Check that transaction exists
14:33:53  59  	BEGIN
14:33:53  60  	  SELECT
14:33:53  61  	    TRANSACTION.ID into temp_transaction_id
14:33:53  62  	  FROM
14:33:53  63  	    TRANSACTION
14:33:53  64  	  WHERE
14:33:53  65  	    TRANSACTION.ID = in_transaction_id;
14:33:53  66  	  EXCEPTION
14:33:53  67  	    WHEN NO_DATA_FOUND THEN
14:33:53  68  	      RAISE BAD_TRANSACTION_ID;
14:33:53  69  	END;
14:33:53  70  
14:33:53  71  	-- Check that instrument exists
14:33:53  72  	IF in_instrument_type_id = GLOBAL_ENUMS_V22.INSTRUMENT_CREDIT_CARD THEN
14:33:53  73  	  IF PROCS_FIN_INSTRUMENTS_V22.IS_CREDIT_CARD_EXISTS(in_instrument_id) = GLOBAL_CONSTANTS_V22.FALSE THEN
14:33:53  74  	    RAISE BAD_CREDIT_CARD_ID;
14:33:53  75  	  END IF;
14:33:53  76  	ELSIF in_instrument_type_id = GLOBAL_ENUMS_V22.INSTRUMENT_PAYPAL THEN
14:33:53  77  	  IF PROCS_FIN_INSTRUMENTS_V22.IS_PAYPAL_EXISTS(in_instrument_id) = GLOBAL_CONSTANTS_V22.FALSE THEN
14:33:53  78  	    RAISE BAD_PAYPAL_ID;
14:33:53  79  	  END IF;
14:33:53  80  	END IF;
14:33:53  81  
14:33:53  82  	-- Create new charge
14:33:53  83  	PROCS_CHARGE_CRU_V22.CREATE_CHARGE(
14:33:53  84  	  out_charge_id 	=> var_new_charge_id,
14:33:53  85  	  in_invoice_id 	=> in_invoice_id,
14:33:53  86  	  in_transaction_id	=> in_transaction_id,
14:33:53  87  	  in_instrument_type_id => in_instrument_type_id,
14:33:53  88  	  in_instrument_id	=> in_instrument_id,
14:33:53  89  	  in_charge_amount	=> in_charge_amount,
14:33:53  90  	  in_charge_status_id	=> in_charge_status_id,
14:33:53  91  	  in_created_by 	=> in_created_by
14:33:53  92  	);
14:33:53  93  
14:33:53  94  	out_charge_id := var_new_charge_id;
14:33:53  95  
14:33:53  96  EXCEPTION
14:33:53  97  WHEN BAD_CHARGE_STATUS_ID THEN
14:33:53  98  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:53  99  	  PROCS_NAME, 'Bad charge status: '||in_charge_status_id);
14:33:53 100  WHEN BAD_INSTRUMENT_TYPE THEN
14:33:53 101  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:53 102  	  PROCS_NAME, 'Bad instrument type id');
14:33:53 103  WHEN BAD_INVOICE_ID THEN
14:33:53 104  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 105  	  PROCS_NAME, 'No such invoice');
14:33:53 106  WHEN BAD_TRANSACTION_ID THEN
14:33:53 107  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 108  	  PROCS_NAME, 'No such transaction');
14:33:53 109  WHEN BAD_PAYPAL_ID THEN
14:33:53 110  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 111  	  PROCS_NAME, 'No such paypal');
14:33:53 112  WHEN BAD_CREDIT_CARD_ID THEN
14:33:53 113  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 114  	  PROCS_NAME, 'No such credit card');
14:33:53 115  WHEN OTHERS THEN
14:33:53 116  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 117  	  PROCS_NAME, 'Unknown error', SQLERRM);
14:33:53 118  END CREATE_CHARGE;
14:33:53 119  
14:33:53 120  /********************************************************/
14:33:53 121  -- norlov #38562 :
14:33:53 122  PROCEDURE GET_PENDING_REFUND_CHARGES (
14:33:53 123  /*
14:33:53 124  Throws exceptions:
14:33:53 125  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 126  */
14:33:53 127  	out_result_set	    OUT SYS_REFCURSOR,
14:33:53 128  	in_row_number	    IN NUMBER DEFAULT NULL
14:33:53 129  ) AS
14:33:53 130  SPROC_NAME CONSTANT VARCHAR2(26) := 'GET_PENDING_REFUND_CHARGES';
14:33:53 131  -- COMSTANTS
14:33:53 132  DEFAULT_ROW_NUMBER CONSTANT NUMBER := 1;
14:33:53 133  -- VARIABLES
14:33:53 134  var_row_number NUMBER;
14:33:53 135  BEGIN
14:33:53 136  	IF in_row_number IS NULL THEN
14:33:53 137  	  var_row_number := DEFAULT_ROW_NUMBER;
14:33:53 138  	ELSE
14:33:53 139  	  var_row_number := in_row_number;
14:33:53 140  	END IF;
14:33:53 141  
14:33:53 142  	-- Select charges
14:33:53 143  	OPEN out_result_set FOR
14:33:53 144  SELECT * FROM
14:33:53 145  (
14:33:53 146  	SELECT
14:33:53 147  	  CHARGE.ID,
14:33:53 148  	  CHARGE.TRANSACTION_ID,
14:33:53 149  	  CHARGE.INSTRUMENT_ID,
14:33:53 150  	  CHARGE.INSTRUMENT_TYPE_ID,
14:33:53 151  	  CHARGE.CHARGE_AMOUNT,
14:33:53 152  	  CHARGE.CREATE_DATE,
14:33:53 153  	  CHARGE.CREATED_BY,
14:33:53 154  	  CHARGE.INVOICE_ID
14:33:53 155  	FROM
14:33:53 156  	  CHARGE
14:33:53 157  	  INNER JOIN TRANSACTION ON CHARGE.TRANSACTION_ID = TRANSACTION.ID
14:33:53 158  	WHERE
14:33:53 159  	  TRANSACTION.TRANSACTION_STATUS_ID = GLOBAL_STATUSES_V22.TRANSACTION_PENDING
14:33:53 160  	  AND TRANSACTION.IS_REFUND = GLOBAL_CONSTANTS_V22.TRUE
14:33:53 161  	  AND TRANSACTION.TRANSACTION_AMOUNT < 0
14:33:53 162  	  AND NOT EXISTS
14:33:53 163  	  (
14:33:53 164  	    SELECT NULL
14:33:53 165  	    FROM PROCESS_RETRY_THROTTLE
14:33:53 166  	    WHERE PROCESS_NAME = SPROC_NAME
14:33:53 167  	      AND GENERIC_ID = CHARGE.ID
14:33:53 168  	  )
14:33:53 169  	  AND ROWNUM <= var_row_number*10
14:33:53 170  	  ORDER BY dbms_random.value
14:33:53 171  ) WHERE
14:33:53 172  	  ROWNUM <= var_row_number;
14:33:53 173  
14:33:53 174  END GET_PENDING_REFUND_CHARGES;
14:33:53 175  /******************************************************************************/
14:33:53 176  
14:33:53 177  PROCEDURE GET_UNPROCESSED_CHARGES (
14:33:53 178  /*
14:33:53 179  Throws exceptions:
14:33:53 180  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 181  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 182  */
14:33:53 183  	in_invoice_id  IN NUMBER,
14:33:53 184  	out_result_set OUT SYS_REFCURSOR
14:33:53 185  ) AS
14:33:53 186  SPROC_NAME      CONSTANT VARCHAR2(24) := 'GET_UNPROCESSED_CHARGES';
14:33:53 187  -- VARIABLES
14:33:53 188  temp_invoice_id NUMBER;
14:33:53 189  -- EXCEPTIONS
14:33:53 190  BAD_INVOICE_ID EXCEPTION;
14:33:53 191  BEGIN
14:33:53 192  
14:33:53 193  	-- Check that invoice exists
14:33:53 194  	BEGIN
14:33:53 195  	  SELECT
14:33:53 196  	    INVOICE.ID into temp_invoice_id
14:33:53 197  	  FROM
14:33:53 198  	    INVOICE
14:33:53 199  	  WHERE
14:33:53 200  	    INVOICE.ID = in_invoice_id;
14:33:53 201  	  EXCEPTION
14:33:53 202  	    WHEN NO_DATA_FOUND THEN
14:33:53 203  	      RAISE BAD_INVOICE_ID;
14:33:53 204  	END;
14:33:53 205  
14:33:53 206  	-- Select charges
14:33:53 207  	OPEN out_result_set FOR
14:33:53 208  	SELECT
14:33:53 209  	  CHARGE.ID,
14:33:53 210  	  CHARGE.TRANSACTION_ID,
14:33:53 211  	  CHARGE.INSTRUMENT_ID,
14:33:53 212  	  CHARGE.INSTRUMENT_TYPE_ID,
14:33:53 213  	  CHARGE.CHARGE_AMOUNT,
14:33:53 214  	  CHARGE.CREATE_DATE,
14:33:53 215  	  CHARGE.CREATED_BY,
14:33:53 216  	  CHARGE.INVOICE_ID
14:33:53 217  	FROM
14:33:53 218  	  CHARGE
14:33:53 219  	  INNER JOIN TRANSACTION ON CHARGE.TRANSACTION_ID = TRANSACTION.ID
14:33:53 220  	WHERE
14:33:53 221  	  CHARGE.INVOICE_ID = in_invoice_id
14:33:53 222  	  AND CHARGE.CHARGE_STATUS_ID = GLOBAL_STATUSES_V22.CHARGE_OPENED
14:33:53 223  	  AND
14:33:53 224  	    TRANSACTION.TRANSACTION_STATUS_ID = GLOBAL_STATUSES_V22.TRANSACTION_PENDING;
14:33:53 225  
14:33:53 226  EXCEPTION
14:33:53 227  WHEN BAD_INVOICE_ID THEN
14:33:53 228  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 229  	  SPROC_NAME, 'No such invoice');
14:33:53 230  WHEN OTHERS THEN
14:33:53 231  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 232  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 233  END GET_UNPROCESSED_CHARGES;
14:33:53 234  
14:33:53 235  /******************************************************************************/
14:33:53 236  
14:33:53 237  PROCEDURE GET_PROCESSED_CHARGES (
14:33:53 238  /*
14:33:53 239  Throws exceptions:
14:33:53 240  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 241  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 242  */
14:33:53 243  	in_invoice_id  IN NUMBER,
14:33:53 244  	out_result_set OUT SYS_REFCURSOR
14:33:53 245  ) AS
14:33:53 246  SPROC_NAME      CONSTANT VARCHAR2(21) := 'GET_PROCESSED_CHARGES';
14:33:53 247  -- VARIABLES
14:33:53 248  temp_invoice_id NUMBER;
14:33:53 249  -- EXCEPTIONS
14:33:53 250  BAD_INVOICE_ID  EXCEPTION;
14:33:53 251  BEGIN
14:33:53 252  
14:33:53 253  	-- Check that invoice exists
14:33:53 254  	BEGIN
14:33:53 255  	  SELECT
14:33:53 256  	    INVOICE.ID into temp_invoice_id
14:33:53 257  	  FROM
14:33:53 258  	    INVOICE
14:33:53 259  	  WHERE
14:33:53 260  	    INVOICE.ID = in_invoice_id;
14:33:53 261  	  EXCEPTION
14:33:53 262  	    WHEN NO_DATA_FOUND THEN
14:33:53 263  	      RAISE BAD_INVOICE_ID;
14:33:53 264  	END;
14:33:53 265  
14:33:53 266  	-- Select charges
14:33:53 267  	OPEN out_result_set FOR
14:33:53 268  	SELECT /*+ STAR_TRANSFORMATION */
14:33:53 269  	  CHARGE.ID,
14:33:53 270  	  CHARGE.TRANSACTION_ID,
14:33:53 271  	  CHARGE.INSTRUMENT_ID,
14:33:53 272  	  CHARGE.INSTRUMENT_TYPE_ID,
14:33:53 273  	  CHARGE.CHARGE_AMOUNT,
14:33:53 274  	  CHARGE.CREATE_DATE,
14:33:53 275  	  CHARGE.CREATED_BY,
14:33:53 276  	  CHARGE.INVOICE_ID
14:33:53 277  	FROM
14:33:53 278  	  CHARGE
14:33:53 279  	  INNER JOIN TRANSACTION ON CHARGE.TRANSACTION_ID = TRANSACTION.ID
14:33:53 280  	WHERE
14:33:53 281  	  CHARGE.INVOICE_ID = in_invoice_id
14:33:53 282  	  AND CHARGE.CHARGE_STATUS_ID = GLOBAL_STATUSES_V22.CHARGE_PROCESSED
14:33:53 283  	  AND TRANSACTION.TRANSACTION_STATUS_ID = GLOBAL_STATUSES_V22.TRANSACTION_CLOSED;
14:33:53 284  
14:33:53 285  EXCEPTION
14:33:53 286  WHEN BAD_INVOICE_ID THEN
14:33:53 287  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 288  	  SPROC_NAME, 'No such invoice');
14:33:53 289  WHEN OTHERS THEN
14:33:53 290  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 291  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 292  END GET_PROCESSED_CHARGES;
14:33:53 293  
14:33:53 294  /******************************************************************************/
14:33:53 295  
14:33:53 296  PROCEDURE GET_SUBSCR_ID_BY_CHARGE_ID (
14:33:53 297  /*
14:33:53 298  Throws exceptions:
14:33:53 299  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 300  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 301  */
14:33:53 302  	in_charge_id	    IN NUMBER,
14:33:53 303  	out_subscription_id OUT NUMBER
14:33:53 304  ) AS
14:33:53 305  SPROC_NAME	  CONSTANT VARCHAR2(26) := 'GET_SUBSCR_ID_BY_CHARGE_ID';
14:33:53 306  -- VARIABLES
14:33:53 307  var_invoice_id	  NUMBER;
14:33:53 308  var_subscription_id NUMBER;
14:33:53 309  -- EXCEPTIONS
14:33:53 310  BAD_CHARGE_ID		EXCEPTION;
14:33:53 311  CAN_NOT_FIND_SUBSCRIPTION EXCEPTION;
14:33:53 312  BEGIN
14:33:53 313  
14:33:53 314  	BEGIN
14:33:53 315  	  SELECT
14:33:53 316  	    CHARGE.INVOICE_ID into var_invoice_id
14:33:53 317  	  FROM
14:33:53 318  	    CHARGE
14:33:53 319  	  WHERE
14:33:53 320  	    CHARGE.ID = in_charge_id;
14:33:53 321  	  EXCEPTION
14:33:53 322  	    WHEN NO_DATA_FOUND THEN
14:33:53 323  	      RAISE BAD_CHARGE_ID;
14:33:53 324  	END;
14:33:53 325  
14:33:53 326  	BEGIN
14:33:53 327  	  SELECT
14:33:53 328  	    LICENSE.SUBSCRIPTION_ID into var_subscription_id
14:33:53 329  	  FROM
14:33:53 330  	    LICENSE
14:33:53 331  	  WHERE
14:33:53 332  	    LICENSE.INVOICE_ID = var_invoice_id
14:33:53 333  	    AND ROWNUM <= 1; -- That's because many licenses could be pointed to the same invoice
14:33:53 334  	  EXCEPTION
14:33:53 335  	    WHEN NO_DATA_FOUND THEN
14:33:53 336  	      RAISE CAN_NOT_FIND_SUBSCRIPTION;
14:33:53 337  	END;
14:33:53 338  
14:33:53 339  	out_subscription_id := var_subscription_id;
14:33:53 340  
14:33:53 341  EXCEPTION
14:33:53 342  WHEN BAD_CHARGE_ID THEN
14:33:53 343  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 344  	  SPROC_NAME, 'No such charge');
14:33:53 345  WHEN CAN_NOT_FIND_SUBSCRIPTION THEN
14:33:53 346  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 347  	  SPROC_NAME, 'Could not find subscription for given charge');
14:33:53 348  WHEN OTHERS THEN
14:33:53 349  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 350  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 351  END GET_SUBSCR_ID_BY_CHARGE_ID;
14:33:53 352  
14:33:53 353  /******************************************************************************/
14:33:53 354  
14:33:53 355  PROCEDURE UPDATE_CHARGE_STATUS (
14:33:53 356  /*
14:33:53 357  Throws exceptions:
14:33:53 358  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 359  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 360  */
14:33:53 361  	in_charge_id	    IN CHARGE.ID%TYPE,
14:33:53 362  	in_charge_status_id IN CHARGE.CHARGE_STATUS_ID%TYPE,
14:33:53 363  	in_updated_by	    IN CHARGE.UPDATED_BY%TYPE
14:33:53 364  ) AS
14:33:53 365  SPROC_NAME CONSTANT VARCHAR2(20) := 'UPDATE_CHARGE_STATUS';
14:33:53 366  -- EXCEPTIONS
14:33:53 367  BAD_CHARGE_ID	     EXCEPTION;
14:33:53 368  BAD_STATUS_ID	     EXCEPTION;
14:33:53 369  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:53 370  BEGIN
14:33:53 371  
14:33:53 372  	IF in_charge_status_id != GLOBAL_STATUSES_V22.CHARGE_OPENED
14:33:53 373  	  AND in_charge_status_id != GLOBAL_STATUSES_V22.CHARGE_PROCESSED
14:33:53 374  	  AND in_charge_status_id != GLOBAL_STATUSES_V22.CHARGE_CANCELED THEN
14:33:53 375  	  RAISE BAD_STATUS_ID;
14:33:53 376  	END IF;
14:33:53 377  
14:33:53 378  	PROCS_CHARGE_CRU_V22.UPDATE_CHARGE(
14:33:53 379  	  in_charge_id	      => in_charge_id,
14:33:53 380  	  in_charge_status_id => in_charge_status_id,
14:33:53 381  	  in_updated_by       => in_updated_by
14:33:53 382  	);
14:33:53 383  
14:33:53 384  	IF SQL%ROWCOUNT = 0 THEN
14:33:53 385  	  RAISE BAD_CHARGE_ID;
14:33:53 386  	END IF;
14:33:53 387  
14:33:53 388  EXCEPTION
14:33:53 389  WHEN BAD_CHARGE_ID THEN
14:33:53 390  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 391  	  SPROC_NAME, 'No such charge');
14:33:53 392  WHEN BAD_STATUS_ID THEN
14:33:53 393  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:53 394  	  SPROC_NAME, 'Bad status id');
14:33:53 395  WHEN OTHERS THEN
14:33:53 396  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 397  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 398  END UPDATE_CHARGE_STATUS;
14:33:53 399  
14:33:53 400  FUNCTION IS_CHARGE_COLLECTED (
14:33:53 401  /*
14:33:53 402  Throws:
14:33:53 403  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 404  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 405  Returns:
14:33:53 406  GLOBAL_CONST.TRUE if transaction collected,
14:33:53 407  GLOBAL_CONST.FALSE else
14:33:53 408  */
14:33:53 409  	in_charge_id IN NUMBER
14:33:53 410  ) RETURN NUMBER AS
14:33:53 411  SPROC_NAME CONSTANT VARCHAR2(19) := 'IS_CHARGE_COLLECTED';
14:33:53 412  -- VARIABLES
14:33:53 413  var_transaction_id NUMBER;
14:33:53 414  is_transaction_collected NUMBER;
14:33:53 415  -- EXCEPTIONS
14:33:53 416  BAD_CHARGE_ID	       EXCEPTION;
14:33:53 417  CAN_NOT_CHECK_TRANSACTION EXCEPTION;
14:33:53 418  EXCEPTION_MESSAGE        VARCHAR2(1024);
14:33:53 419  BEGIN
14:33:53 420  
14:33:53 421  	BEGIN
14:33:53 422  	  SELECT
14:33:53 423  	    CHARGE.TRANSACTION_ID into var_transaction_id
14:33:53 424  	  FROM
14:33:53 425  	    CHARGE
14:33:53 426  	  WHERE
14:33:53 427  	    CHARGE.ID = in_charge_id;
14:33:53 428  	  EXCEPTION
14:33:53 429  	    WHEN NO_DATA_FOUND THEN
14:33:53 430  	      RAISE BAD_CHARGE_ID;
14:33:53 431  	END;
14:33:53 432  
14:33:53 433  	BEGIN
14:33:53 434  	  is_transaction_collected := PROCS_TRANSACTION_V22.IS_TRANSACTION_COLLECTED(var_transaction_id);
14:33:53 435  	  EXCEPTION
14:33:53 436  	    WHEN OTHERS THEN
14:33:53 437  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:53 438  	      RAISE CAN_NOT_CHECK_TRANSACTION;
14:33:53 439  	END;
14:33:53 440  
14:33:53 441  	RETURN is_transaction_collected;
14:33:53 442  
14:33:53 443  EXCEPTION
14:33:53 444  WHEN BAD_CHARGE_ID THEN
14:33:53 445  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 446  	  SPROC_NAME, 'No such charge');
14:33:53 447  WHEN CAN_NOT_CHECK_TRANSACTION THEN
14:33:53 448  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 449  	  SPROC_NAME, 'Could not check if transaction was collected', EXCEPTION_MESSAGE);
14:33:53 450  WHEN OTHERS THEN
14:33:53 451  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 452  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 453  END;
14:33:53 454  
14:33:53 455  PROCEDURE GET_COLLECTED_CHARGES (
14:33:53 456  /*
14:33:53 457  Throws exceptions:
14:33:53 458  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 459  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 460  */
14:33:53 461  	in_invoice_id  IN NUMBER,
14:33:53 462  	out_result_set OUT SYS_REFCURSOR
14:33:53 463  ) AS
14:33:53 464  SPROC_NAME      CONSTANT VARCHAR2(21) := 'GET_COLLECTED_CHARGES';
14:33:53 465  -- VARIABLES
14:33:53 466  temp_invoice_id NUMBER;
14:33:53 467  -- EXCEPTIONS
14:33:53 468  BAD_INVOICE_ID  EXCEPTION;
14:33:53 469  BEGIN
14:33:53 470  
14:33:53 471  	-- Check that invoice exists
14:33:53 472  	BEGIN
14:33:53 473  	  SELECT
14:33:53 474  	    INVOICE.ID into temp_invoice_id
14:33:53 475  	  FROM
14:33:53 476  	    INVOICE
14:33:53 477  	  WHERE
14:33:53 478  	    INVOICE.ID = in_invoice_id;
14:33:53 479  	  EXCEPTION
14:33:53 480  	    WHEN NO_DATA_FOUND THEN
14:33:53 481  	      RAISE BAD_INVOICE_ID;
14:33:53 482  	END;
14:33:53 483  
14:33:53 484  	-- Select charges
14:33:53 485  	OPEN out_result_set FOR
14:33:53 486  	SELECT
14:33:53 487  	  CHARGE.ID,
14:33:53 488  	  CHARGE.TRANSACTION_ID,
14:33:53 489  	  CHARGE.INSTRUMENT_ID,
14:33:53 490  	  CHARGE.INSTRUMENT_TYPE_ID,
14:33:53 491  	  CHARGE.CHARGE_AMOUNT,
14:33:53 492  	  CHARGE.CREATE_DATE,
14:33:53 493  	  CHARGE.CREATED_BY,
14:33:53 494  	  CHARGE.INVOICE_ID
14:33:53 495  	FROM
14:33:53 496  	  CHARGE
14:33:53 497  	  INNER JOIN TRANSACTION ON CHARGE.TRANSACTION_ID = TRANSACTION.ID
14:33:53 498  	WHERE
14:33:53 499  	  CHARGE.INVOICE_ID = in_invoice_id
14:33:53 500  	  AND CHARGE.CHARGE_STATUS_ID IN (SELECT GLOBAL_STATUSES_V22.CHARGE_PROCESSED FROM DUAL)
14:33:53 501  	  AND PROCS_CHARGE_V22.IS_CHARGE_COLLECTED(CHARGE.ID) = GLOBAL_CONSTANTS_V22.TRUE;
14:33:53 502  
14:33:53 503  EXCEPTION
14:33:53 504  WHEN BAD_INVOICE_ID THEN
14:33:53 505  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 506  	  SPROC_NAME, 'No such invoice');
14:33:53 507  WHEN OTHERS THEN
14:33:53 508  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 509  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 510  END GET_COLLECTED_CHARGES;
14:33:53 511  
14:33:53 512  END PROCS_CHARGE_V22;
14:33:53 513  .
14:33:53 SQL> /

Package body created.

Elapsed: 00:00:00.04
14:33:53 SQL> 
14:33:53 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_SUBSCRIPTION_V22" AS
14:33:53   2  
14:33:53   3  PROCEDURE START_GRACE_BY_INVOICE_ID(
14:33:53   4  	in_invoice_id	     IN LICENSE.INVOICE_ID%TYPE,
14:33:53   5  	in_updater	     IN VARCHAR2,
14:33:53   6  	in_duration_in_hours IN NUMBER
14:33:53   7  ) AS
14:33:53   8  SPROC_NAME CONSTANT VARCHAR2(32) := 'START_GRACE_BY_INVOICE_ID';
14:33:53   9  var_subs_id	  SUBSCRIPTION.ID%TYPE;
14:33:53  10  var_lic_id	  LICENSE.ID%TYPE;
14:33:53  11  var_grace_start	  DATE;
14:33:53  12  var_grace_end	  DATE;
14:33:53  13  BEGIN
14:33:53  14  	SELECT
14:33:53  15  	  ID,
14:33:53  16  	  SUBSCRIPTION_ID,
14:33:53  17  	  START_DATE,
14:33:53  18  	  START_DATE + (in_duration_in_hours / 24)
14:33:53  19  	INTO var_lic_id, var_subs_id, var_grace_start, var_grace_end
14:33:53  20  	FROM
14:33:53  21  	  LICENSE
14:33:53  22  	WHERE
14:33:53  23  	  INVOICE_ID = in_invoice_id
14:33:53  24  	  AND ROWNUM <= 1;
14:33:53  25  
14:33:53  26  	PROCS_LICENSE_CRU_V22.UPDATE_LICENSE(
14:33:53  27  	    in_license_id	    => var_lic_id,
14:33:53  28  	    in_updated_by	    => in_updater,
14:33:53  29  	    in_grace_start_date     => var_grace_start,
14:33:53  30  	    in_grace_end_date	    => var_grace_end,
14:33:53  31  	    in_entitlement_end_date => var_grace_end,
14:33:53  32  	    in_license_status_id    => GLOBAL_STATUSES_V22.LICENSE_IN_GRACE_PERIOD
14:33:53  33  	);
14:33:53  34  
14:33:53  35  	PROCS_SUBSCRIPTION_CRU_V22.UPDATE_SUBSCRIPTION(
14:33:53  36  	    in_subscription_id	      => var_subs_id,
14:33:53  37  	    in_updated_by	      => in_updater,
14:33:53  38  	    in_subscription_status_id => GLOBAL_STATUSES_V22.SUBSCRIPTION_IN_GRACE_PERIOD
14:33:53  39  	  );
14:33:53  40  END START_GRACE_BY_INVOICE_ID;
14:33:53  41  
14:33:53  42  PROCEDURE STOP_GRACE_BY_INVOICE_ID(
14:33:53  43  	in_invoice_id IN LICENSE.INVOICE_ID%TYPE,
14:33:53  44  	in_updater    IN VARCHAR2
14:33:53  45  ) AS
14:33:53  46  SPROC_NAME CONSTANT VARCHAR2(32) := 'START_GRACE_BY_INVOICE_ID';
14:33:53  47  var_subs_id	  SUBSCRIPTION.ID%TYPE;
14:33:53  48  var_lic_id	  LICENSE.ID%TYPE;
14:33:53  49  var_lic_end_date	  DATE;
14:33:53  50  BEGIN
14:33:53  51  	SELECT
14:33:53  52  	  ID,
14:33:53  53  	  SUBSCRIPTION_ID,
14:33:53  54  	  END_DATE
14:33:53  55  	INTO var_lic_id, var_subs_id, var_lic_end_date
14:33:53  56  	FROM
14:33:53  57  	  LICENSE
14:33:53  58  	WHERE
14:33:53  59  	  INVOICE_ID = in_invoice_id
14:33:53  60  	  AND ROWNUM <= 1;
14:33:53  61  
14:33:53  62  	PROCS_LICENSE_CRU_V22.UPDATE_LICENSE(
14:33:53  63  	    in_license_id	    => var_lic_id,
14:33:53  64  	    in_updated_by	    => in_updater,
14:33:53  65  	    in_grace_end_date	    => SYSDATE,
14:33:53  66  	    in_entitlement_end_date => var_lic_end_date,
14:33:53  67  	    in_license_status_id    => GLOBAL_STATUSES_V22.LICENSE_ACTIVE
14:33:53  68  	);
14:33:53  69  
14:33:53  70  	PROCS_SUBSCRIPTION_CRU_V22.UPDATE_SUBSCRIPTION(
14:33:53  71  	    in_subscription_id	      => var_subs_id,
14:33:53  72  	    in_updated_by	      => in_updater,
14:33:53  73  	    in_subscription_status_id => GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE
14:33:53  74  	);
14:33:53  75  END STOP_GRACE_BY_INVOICE_ID;
14:33:53  76  
14:33:53  77  
14:33:53  78  PROCEDURE START_SUBSCRIPTION_CREATION (
14:33:53  79  	in_group_id	      IN NUMBER,
14:33:53  80  	in_created_by	      IN VARCHAR2,
14:33:53  81  	in_offer_chain_id     IN NUMBER,
14:33:53  82  	in_instrument_type_id IN NUMBER,
14:33:53  83  	in_instrument_id      IN NUMBER,
14:33:53  84  	in_agent_id	      IN NUMBER,
14:33:53  85  	in_note 	      IN VARCHAR2,
14:33:53  86  	out_subscription_id   OUT NUMBER,
14:33:53  87  	out_invoice_id	      OUT NUMBER,
14:33:53  88  	out_new_license_id    OUT NUMBER,
14:33:53  89  	in_check_dupe_products	 IN NUMBER DEFAULT GLOBAL_CONSTANTS_V22.TRUE
14:33:53  90  ) AS
14:33:53  91  SPROC_NAME CONSTANT VARCHAR2(27) := 'START_SUBSCRIPTION_CREATION';
14:33:53  92  -- VARIABLES
14:33:53  93  var_account_id		 NUMBER;
14:33:53  94  var_account_status	 NUMBER;
14:33:53  95  var_offer_chain_status_id  NUMBER;
14:33:53  96  var_is_gift_certificate	 NUMBER;
14:33:53  97  var_is_for_redemption	 NUMBER;
14:33:53  98  var_same_offer_chains_num  NUMBER;
14:33:53  99  var_max_concurrent_subscrs NUMBER;
14:33:53 100  var_first_offer_id	 NUMBER;
14:33:53 101  var_new_invoice_id	 NUMBER;
14:33:53 102  var_new_subscription_id	 NUMBER;
14:33:53 103  var_date			 DATE := SYSDATE;
14:33:53 104  var_account_tax_exempt_id  VARCHAR2(255);
14:33:53 105  var_concur_subscription_id NUMBER;
14:33:53 106  -- EXCEPTIONS
14:33:53 107  BAD_GROUP_ID		    EXCEPTION;
14:33:53 108  CAN_NOT_CREATE_FOR_DISABLE    EXCEPTION;
14:33:53 109  BAD_OFFER_CHAIN		    EXCEPTION;
14:33:53 110  BAD_OFFER_CHAIN_STATUS	    EXCEPTION;
14:33:53 111  CAN_NOT_SUBSCRIBE_TO_GC	    EXCEPTION;
14:33:53 112  CAN_NOT_SUBSCRIBE_TO_RGC	    EXCEPTION;
14:33:53 113  LIMIT_REACHED		    EXCEPTION;
14:33:53 114  PRODUCT_ALREADY_PURCHASED     EXCEPTION;
14:33:53 115  CAN_NOT_GET_FIRST_OFFER_CHAIN EXCEPTION;
14:33:53 116  CAN_NOT_CREATE_INVOICE	    EXCEPTION;
14:33:53 117  CAN_NOT_CREATE_LINE_ITEMS     EXCEPTION;
14:33:53 118  CAN_NOT_CREATE_LICENSE	    EXCEPTION;
14:33:53 119  CAN_NOT_CREATE_NOTE	    EXCEPTION;
14:33:53 120  
14:33:53 121  EXCEPTION_MESSAGE VARCHAR2(1024);
14:33:53 122  BEGIN
14:33:53 123  
14:33:53 124  	-- Get account id and status
14:33:53 125  	BEGIN
14:33:53 126  	  SELECT
14:33:53 127  	    ACCOUNT.ID,
14:33:53 128  	    ACCOUNT.ACCOUNT_STATUS_ID,
14:33:53 129  	    ACCOUNT.TAX_EXEMPT_ID
14:33:53 130  	    into
14:33:53 131  	    var_account_id,
14:33:53 132  	    var_account_status,
14:33:53 133  	    var_account_tax_exempt_id
14:33:53 134  	  FROM
14:33:53 135  	    ACCOUNT
14:33:53 136  	  WHERE
14:33:53 137  	    ACCOUNT.GROUP_ID = in_group_id;
14:33:53 138  	  EXCEPTION
14:33:53 139  	  WHEN NO_DATA_FOUND THEN
14:33:53 140  	    RAISE BAD_GROUP_ID;
14:33:53 141  	END;
14:33:53 142  
14:33:53 143  	-- Could not create subscription for disabled account
14:33:53 144  	IF var_account_status = GLOBAL_STATUSES_V22.ACCOUNT_DISABLED THEN
14:33:53 145  	  RAISE CAN_NOT_CREATE_FOR_DISABLE;
14:33:53 146  	END IF;
14:33:53 147  
14:33:53 148  	-- Get offer chain status
14:33:53 149  	BEGIN
14:33:53 150  	  SELECT
14:33:53 151  	    OFFER_CHAIN.OFFER_CHAIN_STATUS_ID,
14:33:53 152  	    OFFER_CHAIN.IS_GIFT_CERTIFICATE
14:33:53 153  	    into
14:33:53 154  	    var_offer_chain_status_id,
14:33:53 155  	    var_is_gift_certificate
14:33:53 156  	  FROM
14:33:53 157  	    OFFER_CHAIN
14:33:53 158  	  WHERE
14:33:53 159  	    OFFER_CHAIN.ID = in_offer_chain_id;
14:33:53 160  
14:33:53 161  	  EXCEPTION
14:33:53 162  	    WHEN NO_DATA_FOUND THEN
14:33:53 163  	      RAISE BAD_OFFER_CHAIN;
14:33:53 164  	END;
14:33:53 165  
14:33:53 166  	-- Could not subscribe to inactive/disabled offer chain
14:33:53 167  	IF var_offer_chain_status_id != GLOBAL_STATUSES_V22.OFFER_CHAIN_ACTIVE THEN
14:33:53 168  	  RAISE BAD_OFFER_CHAIN_STATUS;
14:33:53 169  	END IF;
14:33:53 170  
14:33:53 171  	-- Can not subscribe to Offer Chain for a Gift Certfiicate
14:33:53 172  	IF var_is_gift_certificate = GLOBAL_CONSTANTS_V22.TRUE THEN
14:33:53 173  	  RAISE CAN_NOT_SUBSCRIBE_TO_GC;
14:33:53 174  	END IF;
14:33:53 175  
14:33:53 176  	-- check if the OC is for Redemption:
14:33:53 177  	SELECT
14:33:53 178  	  COUNT(*) into var_is_for_redemption
14:33:53 179  	FROM
14:33:53 180  	  OFFER_CHAIN_ELIGIBILITY
14:33:53 181  	WHERE
14:33:53 182  	  OFFER_CHAIN_ELIGIBILITY.OFFER_CHAIN_ID = in_offer_chain_id
14:33:53 183  	  AND OFFER_CHAIN_ELIGIBILITY.NAME = GLOBAL_CONSTANTS_V22.GIFT_CERTIFICATE_REQUIRED
14:33:53 184  	  AND OFFER_CHAIN_ELIGIBILITY.VALUE = GLOBAL_CONSTANTS_V22.ELIGIBILITY_FLAG_SET;
14:33:53 185  
14:33:53 186  	IF var_is_for_redemption > 0 THEN
14:33:53 187  	  RAISE CAN_NOT_SUBSCRIBE_TO_RGC;
14:33:53 188  	END IF;
14:33:53 189  
14:33:53 190  	SELECT
14:33:53 191  	  COUNT(*) into var_same_offer_chains_num
14:33:53 192  	FROM
14:33:53 193  	  SUBSCRIPTION
14:33:53 194  	WHERE
14:33:53 195  	  SUBSCRIPTION.ACCOUNT_ID = var_account_id
14:33:53 196  	  AND SUBSCRIPTION.OFFER_CHAIN_ID = in_offer_chain_id
14:33:53 197  	  AND (SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE
14:33:53 198  	       OR SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_IN_GRACE_PERIOD);
14:33:53 199  
14:33:53 200  	-- ELIGIBILITY LOGIC CHANGED TO:
14:33:53 201  	-- FOR EACH offer chain eligibility rule in OC:
14:33:53 202  	--   IF offer chain eligibility rule fails:
14:33:53 203  	--     deny purchase;
14:33:53 204  	--   END IF
14:33:53 205  	-- END FOR
14:33:53 206  	-- FOR EACH product eligibility rule in OC:
14:33:53 207  	--   IF product eligibilty rule fails:
14:33:53 208  	--     deny purchase;
14:33:53 209  	--   END IF
14:33:53 210  	-- END FOR
14:33:53 211  	-- allow purchase;
14:33:53 212  
14:33:53 213  	-- if user have any active existing subscriptions to the offer chain
14:33:53 214  	-- and if MAX_CONCURRENT_SUBS <= [user's subscription count for the offer chain]
14:33:53 215  	-- then deny purchase
14:33:53 216  	var_max_concurrent_subscrs := PROCS_OFFER_CHAIN_V22.GET_OFFER_CHAIN_MAX_CONC_SUBSC(in_offer_chain_id);
14:33:53 217  	IF var_max_concurrent_subscrs != GLOBAL_CONSTANTS_V22.INFINITY
14:33:53 218  	  AND var_max_concurrent_subscrs <= var_same_offer_chains_num THEN
14:33:53 219  	  -- Find first concurrent subscription id:
14:33:53 220  	  SELECT
14:33:53 221  	    ID into var_concur_subscription_id
14:33:53 222  	  FROM (
14:33:53 223  	    SELECT
14:33:53 224  	      ID
14:33:53 225  	    FROM
14:33:53 226  	      SUBSCRIPTION
14:33:53 227  	    WHERE
14:33:53 228  	      SUBSCRIPTION.ACCOUNT_ID = var_account_id
14:33:53 229  	      AND SUBSCRIPTION.OFFER_CHAIN_ID = in_offer_chain_id
14:33:53 230  	      AND (SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE
14:33:53 231  		   OR SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_IN_GRACE_PERIOD)
14:33:53 232  	    ORDER BY
14:33:53 233  	      ID
14:33:53 234  	  )
14:33:53 235  	  WHERE
14:33:53 236  	    ROWNUM <= 1;
14:33:53 237  	  RAISE LIMIT_REACHED;
14:33:53 238  	END IF;
14:33:53 239  
14:33:53 240  	-- if user does not have any active existing subscriptions to the offer chain
14:33:53 241  	-- and if product from the offer chain is already owned from another offer chain
14:33:53 242  	-- then deny purchase
14:33:53 243  	IF (in_check_dupe_products != GLOBAL_CONSTANTS_V22.FALSE) THEN
14:33:53 244  	  FOR f_account_offer_chains IN (
14:33:53 245  	    SELECT DISTINCT
14:33:53 246  	      OFFER_CHAIN_ID
14:33:53 247  	    FROM
14:33:53 248  	      SUBSCRIPTION
14:33:53 249  	    WHERE
14:33:53 250  	      ACCOUNT_ID = var_account_id
14:33:53 251  	      AND (
14:33:53 252  		SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE
14:33:53 253  		OR SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_SUSPENDED
14:33:53 254  		OR SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_IN_GRACE_PERIOD)
14:33:53 255  	  )
14:33:53 256  	  LOOP
14:33:53 257  	    IF PROCS_OFFER_CHAIN_V22.CHECK_FOR_SAME_PRODUCTS(
14:33:53 258  	      in_offer_chain_1	       => in_offer_chain_id,
14:33:53 259  	      in_offer_chain_2	       => f_account_offer_chains.OFFER_CHAIN_ID,
14:33:53 260  	      in_use_eligibility_rules => GLOBAL_CONSTANTS_V22.TRUE
14:33:53 261  	    ) = GLOBAL_CONSTANTS_V22.TRUE THEN
14:33:53 262  
14:33:53 263  	      -- Find first concurrent subscription id:
14:33:53 264  	      SELECT
14:33:53 265  		ID into var_concur_subscription_id
14:33:53 266  	      FROM (
14:33:53 267  		SELECT
14:33:53 268  		  ID
14:33:53 269  		FROM
14:33:53 270  		  SUBSCRIPTION
14:33:53 271  		WHERE
14:33:53 272  		  SUBSCRIPTION.ACCOUNT_ID = var_account_id
14:33:53 273  		  AND SUBSCRIPTION.OFFER_CHAIN_ID = f_account_offer_chains.OFFER_CHAIN_ID
14:33:53 274  		  AND (
14:33:53 275  		    SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE
14:33:53 276  		    OR SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_SUSPENDED
14:33:53 277  		    OR SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_IN_GRACE_PERIOD)
14:33:53 278  		ORDER BY
14:33:53 279  		  ID
14:33:53 280  	      )
14:33:53 281  	      WHERE
14:33:53 282  		ROWNUM <= 1;
14:33:53 283  
14:33:53 284  	      RAISE PRODUCT_ALREADY_PURCHASED;
14:33:53 285  	    END IF;
14:33:53 286  	  END LOOP;
14:33:53 287  	END IF;
14:33:53 288  
14:33:53 289  	BEGIN
14:33:53 290  	  PROCS_OFFER_CHAIN_V22.GET_FIRST_OFFER(in_offer_chain_id, var_first_offer_id);
14:33:53 291  	  EXCEPTION
14:33:53 292  	    WHEN OTHERS THEN
14:33:53 293  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:53 294  	      RAISE CAN_NOT_GET_FIRST_OFFER_CHAIN;
14:33:53 295  	END;
14:33:53 296  
14:33:53 297  	BEGIN
14:33:53 298  	  PROCS_INVOICE_V22.CREATE_INVOICE(
14:33:53 299  	    in_invoice_status => GLOBAL_STATUSES_V22.INVOICE_OPEN,
14:33:53 300  	    in_created_by     => in_created_by,
14:33:53 301  	    in_tax_exempt_id  => var_account_tax_exempt_id,
14:33:53 302  	    out_invoice_id    => var_new_invoice_id
14:33:53 303  	  );
14:33:53 304  	  EXCEPTION
14:33:53 305  	    WHEN OTHERS THEN
14:33:53 306  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:53 307  	      RAISE CAN_NOT_CREATE_INVOICE;
14:33:53 308  	END;
14:33:53 309  
14:33:53 310  	BEGIN
14:33:53 311  	  PROCS_LINE_ITEMS_V22.ADD_LINE_ITEMS(
14:33:53 312  	    in_invoice_id => var_new_invoice_id,
14:33:53 313  	    in_offer_id   => var_first_offer_id,
14:33:53 314  	    in_created_by => in_created_by
14:33:53 315  	  );
14:33:53 316  	  EXCEPTION
14:33:53 317  	    WHEN OTHERS THEN
14:33:53 318  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:53 319  	      RAISE CAN_NOT_CREATE_LINE_ITEMS;
14:33:53 320  	END;
14:33:53 321  
14:33:53 322  	PROCS_SUBSCRIPTION_CRU_V22.CREATE_SUBSCRIPTION(
14:33:53 323  	  out_subscription_id	    => var_new_subscription_id,
14:33:53 324  	  in_account_id 	    => var_account_id,
14:33:53 325  	  in_purchase_date	    => var_date,
14:33:53 326  	  in_offer_chain_id	    => in_offer_chain_id,
14:33:53 327  	  in_created_by 	    => in_created_by,
14:33:53 328  	  in_instrument_type_id     => in_instrument_type_id,
14:33:53 329  	  in_instrument_id	    => in_instrument_id,
14:33:53 330  	  in_subscription_status_id => GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE
14:33:53 331  	);
14:33:53 332  
14:33:53 333  	BEGIN
14:33:53 334  	  PROCS_SUBSCRIPTION_V22.ANNOTATE_SUBSCRIPTION(
14:33:53 335  	    in_subscription_id => var_new_subscription_id,
14:33:53 336  	    in_agent_id        => in_agent_id,
14:33:53 337  	    in_note	       => in_note,
14:33:53 338  	    in_created_by      => in_created_by
14:33:53 339  	  );
14:33:53 340  	  EXCEPTION
14:33:53 341  	   WHEN OTHERS THEN
14:33:53 342  	     EXCEPTION_MESSAGE := SQLERRM;
14:33:53 343  	     RAISE CAN_NOT_CREATE_NOTE;
14:33:53 344  	END;
14:33:53 345  
14:33:53 346  	BEGIN
14:33:53 347  	  PROCS_LICENSE_V22.CREATE_LICENSE(
14:33:53 348  	    in_status_id		=> GLOBAL_STATUSES_V22.LICENSE_ACTIVE,
14:33:53 349  	    in_needs_entitlements	=> GLOBAL_CONSTANTS_V22.TRUE,
14:33:53 350  	    in_start_date		=> var_date,
14:33:53 351  	    in_end_date 		=> NULL, -- Will be calculated automatically
14:33:53 352  	    in_offer_id 		=> var_first_offer_id,
14:33:53 353  	    in_subscription_id		=> var_new_subscription_id,
14:33:53 354  	    in_invoice_id		=> var_new_invoice_id,
14:33:53 355  	    in_created_by		=> in_created_by,
14:33:53 356  	    in_is_extension		=> GLOBAL_CONSTANTS_V22.FALSE,
14:33:53 357  	    in_current_offer_index	=> PROCS_OFFER_CHAIN_V22.GET_FIRST_OFFER_INDEX(in_offer_chain_id),
14:33:53 358  	    in_current_offer_recurr_num => 1,
14:33:53 359  	    out_license_id		=> out_new_license_id
14:33:53 360  	  );
14:33:53 361  	  EXCEPTION
14:33:53 362  	    WHEN OTHERS THEN
14:33:53 363  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:53 364  	      RAISE CAN_NOT_CREATE_LICENSE;
14:33:53 365  	END;
14:33:53 366  
14:33:53 367  	out_subscription_id := var_new_subscription_id;
14:33:53 368  	out_invoice_id := var_new_invoice_id;
14:33:53 369  
14:33:53 370  EXCEPTION
14:33:53 371  WHEN BAD_OFFER_CHAIN_STATUS THEN
14:33:53 372  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:53 373  	  SPROC_NAME, 'Offer chain is not active');
14:33:53 374  WHEN LIMIT_REACHED THEN
14:33:53 375  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.CONFLICT_ERROR,
14:33:53 376  	  SPROC_NAME, 'Limit reached for given offer chain. Concurrent subscription id: ' || var_concur_subscription_id);
14:33:53 377  WHEN CAN_NOT_CREATE_FOR_DISABLE THEN
14:33:53 378  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:53 379  	  SPROC_NAME, 'Can not create subsscription for disabled account');
14:33:53 380  WHEN CAN_NOT_SUBSCRIBE_TO_GC THEN
14:33:53 381  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:53 382  	  SPROC_NAME, 'Can not subscribe to Offer Chain for Gift Certificate');
14:33:53 383  WHEN CAN_NOT_SUBSCRIBE_TO_RGC THEN
14:33:53 384  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:53 385  	  SPROC_NAME, 'Can not subscribe to Offer Chain that is for redemption');
14:33:53 386  WHEN BAD_OFFER_CHAIN THEN
14:33:53 387  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 388  	  SPROC_NAME, 'No such offer chain');
14:33:53 389  WHEN PRODUCT_ALREADY_PURCHASED THEN
14:33:53 390  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.CONFLICT_ERROR,
14:33:53 391  	  SPROC_NAME, 'User already subscribed to some product in given offer chain. Concurrent subscription id: ' || var_concur_subscription_id);
14:33:53 392  WHEN CAN_NOT_GET_FIRST_OFFER_CHAIN THEN
14:33:53 393  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 394  	  SPROC_NAME, 'Could not find first offer in offer chain', EXCEPTION_MESSAGE);
14:33:53 395  WHEN CAN_NOT_CREATE_INVOICE THEN
14:33:53 396  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 397  	  SPROC_NAME, 'Could not create invoice', EXCEPTION_MESSAGE);
14:33:53 398  WHEN CAN_NOT_CREATE_LINE_ITEMS THEN
14:33:53 399  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 400  	  SPROC_NAME, 'Could not create line items', EXCEPTION_MESSAGE);
14:33:53 401  WHEN CAN_NOT_CREATE_LICENSE THEN
14:33:53 402  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 403  	  SPROC_NAME, 'Could not create new license', EXCEPTION_MESSAGE);
14:33:53 404  WHEN BAD_GROUP_ID THEN
14:33:53 405  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 406  	  SPROC_NAME, 'Bad group id');
14:33:53 407  WHEN CAN_NOT_CREATE_NOTE THEN
14:33:53 408  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 409  	  SPROC_NAME, 'Could not annotate subscription', EXCEPTION_MESSAGE);
14:33:53 410  WHEN OTHERS THEN
14:33:53 411  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 412  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 413  END START_SUBSCRIPTION_CREATION;
14:33:53 414  
14:33:53 415  /******************************************************************************/
14:33:53 416  
14:33:53 417  PROCEDURE FINALIZE_SUBSCRIPTION_CREATION (
14:33:53 418  	in_subscription_id    IN NUMBER,
14:33:53 419  	in_invoice_id	      IN NUMBER,
14:33:53 420  	in_instrument_type_id IN NUMBER,
14:33:53 421  	in_instrument_id      IN NUMBER,
14:33:53 422  	in_created_by	      IN VARCHAR2
14:33:53 423  ) AS
14:33:53 424  SPROC_NAME CONSTANT VARCHAR2(30) := 'FINALIZE_SUBSCRIPTION_CREATION';
14:33:53 425  -- VARIABLES
14:33:53 426  var_invoice_amount     NUMBER(10, 2);
14:33:53 427  var_new_transaction_id NUMBER;
14:33:53 428  var_new_charge_id      NUMBER;
14:33:53 429  -- EXCEPTIONS
14:33:53 430  CAN_NOT_USE_FCINSTR	  EXCEPTION;
14:33:53 431  CAN_NOT_CALC_INVOICE_AMOUNT EXCEPTION;
14:33:53 432  CAN_NOT_CREATE_TRANSACTION  EXCEPTION;
14:33:53 433  CAN_NOT_CREATE_CHARGE	  EXCEPTION;
14:33:53 434  
14:33:53 435  EXCEPTION_MESSAGE VARCHAR2(1024);
14:33:53 436  BEGIN
14:33:53 437  
14:33:53 438  	-- Calculate invoice amount ( + discounts, taxes)
14:33:53 439  	BEGIN
14:33:53 440  	  PROCS_INVOICE_V22.CALCULATE_INVOICE_AMOUNT(
14:33:53 441  	    in_invoice_id => in_invoice_id,
14:33:53 442  	    out_amount	  => var_invoice_amount
14:33:53 443  	  );
14:33:53 444  	  EXCEPTION
14:33:53 445  	   WHEN OTHERS THEN
14:33:53 446  	     EXCEPTION_MESSAGE := SQLERRM;
14:33:53 447  	     RAISE CAN_NOT_CALC_INVOICE_AMOUNT;
14:33:53 448  	END;
14:33:53 449  
14:33:53 450  	IF in_instrument_type_id = GLOBAL_ENUMS_V22.INSTRUMENT_ZCI_INSTRUMENT
14:33:53 451  	  AND var_invoice_amount > 0 THEN
14:33:53 452  	  RAISE CAN_NOT_USE_FCINSTR;
14:33:53 453  	END IF;
14:33:53 454  
14:33:53 455  	IF var_invoice_amount = 0 THEN
14:33:53 456  	  -- UPDATE INVOICE. SET STATUS TO PROCESSED
14:33:53 457  	  PROCS_INVOICE_CRU_V22.UPDATE_INVOICE(
14:33:53 458  	    in_invoice_id		   => in_invoice_id,
14:33:53 459  	    in_updated_by		   => in_created_by,
14:33:53 460  	    in_invoice_status_id	   => GLOBAL_STATUSES_V22.INVOICE_CLOSED
14:33:53 461  	  );
14:33:53 462  	ELSE
14:33:53 463  	  -- Create transaction and charge
14:33:53 464  	  BEGIN
14:33:53 465  	    PROCS_TRANSACTION_V22.CREATE_TRANSACTION(
14:33:53 466  	      in_transaction_id 	=> NULL,
14:33:53 467  	      in_status_id		=> GLOBAL_STATUSES_V22.TRANSACTION_PENDING,
14:33:53 468  	      in_amount 		=> var_invoice_amount,
14:33:53 469  	      in_created_by		=> in_created_by,
14:33:53 470  	      in_order_id		=> NULL,
14:33:53 471  	      in_transaction_type_code	=> 'START_SUBSCRIPTION',
14:33:53 472  	      out_transaction_id	=> var_new_transaction_id
14:33:53 473  	    );
14:33:53 474  	    EXCEPTION
14:33:53 475  	      WHEN OTHERS THEN
14:33:53 476  		EXCEPTION_MESSAGE := SQLERRM;
14:33:53 477  		RAISE CAN_NOT_CREATE_TRANSACTION;
14:33:53 478  	  END;
14:33:53 479  
14:33:53 480  	  BEGIN
14:33:53 481  	    PROCS_CHARGE_V22.CREATE_CHARGE(
14:33:53 482  	      in_invoice_id	    => in_invoice_id,
14:33:53 483  	      in_transaction_id     => var_new_transaction_id,
14:33:53 484  	      in_instrument_type_id => in_instrument_type_id,
14:33:53 485  	      in_instrument_id	    => in_instrument_id,
14:33:53 486  	      in_charge_amount	    => var_invoice_amount,
14:33:53 487  	      in_created_by	    => in_created_by,
14:33:53 488  	      in_charge_status_id   => GLOBAL_STATUSES_V22.CHARGE_OPENED,
14:33:53 489  	      out_charge_id	    => var_new_charge_id
14:33:53 490  	    );
14:33:53 491  	    EXCEPTION
14:33:53 492  	      WHEN OTHERS THEN
14:33:53 493  		EXCEPTION_MESSAGE := SQLERRM;
14:33:53 494  		RAISE CAN_NOT_CREATE_CHARGE;
14:33:53 495  	  END;
14:33:53 496  	END IF;
14:33:53 497  
14:33:53 498  EXCEPTION
14:33:53 499  WHEN CAN_NOT_USE_FCINSTR THEN
14:33:53 500  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:53 501  	  SPROC_NAME, 'Could not use "free charge instrument" for non-zero invoice');
14:33:53 502  WHEN CAN_NOT_CALC_INVOICE_AMOUNT THEN
14:33:53 503  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 504  	  SPROC_NAME, 'Could not calculate invoice amount', EXCEPTION_MESSAGE);
14:33:53 505  WHEN CAN_NOT_CREATE_TRANSACTION THEN
14:33:53 506  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 507  	  SPROC_NAME, 'Could not create transaction', EXCEPTION_MESSAGE);
14:33:53 508  WHEN CAN_NOT_CREATE_CHARGE THEN
14:33:53 509  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 510  	  SPROC_NAME, 'Could not create charge', EXCEPTION_MESSAGE);
14:33:53 511  WHEN OTHERS THEN
14:33:53 512  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 513  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 514  END FINALIZE_SUBSCRIPTION_CREATION;
14:33:53 515  
14:33:53 516  /******************************************************************************/
14:33:53 517  
14:33:53 518  PROCEDURE SUSPEND_SUBSCRIPTION(
14:33:53 519  /*
14:33:53 520  Throws exceptions:
14:33:53 521  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 522  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:53 523  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 524  */
14:33:53 525  	  in_subs_id	IN NUMBER,
14:33:53 526  	  in_updated_by IN VARCHAR2
14:33:53 527  ) AS
14:33:53 528  SPROC_NAME		  CONSTANT VARCHAR2(20) := 'SUSPEND_SUBSCRIPTION';
14:33:53 529  var_subscription_status_id  NUMBER;
14:33:53 530  var_license_id		  NUMBER;
14:33:53 531  var_offer_id		  NUMBER;
14:33:53 532  var_license_start_date	  DATE;
14:33:53 533  var_license_end_date	  DATE;
14:33:53 534  
14:33:53 535  var_entitlement_dupration   VARCHAR2(30);
14:33:53 536  var_d_entitlement_dupration NUMBER;
14:33:53 537  
14:33:53 538  var_ym_interval INTERVAL YEAR TO MONTH;
14:33:53 539  var_ds_interval INTERVAL DAY(3) TO SECOND;
14:33:53 540  
14:33:53 541  -- EXCEPTIONS
14:33:53 542  BAD_SUBSCRIPTION_ID     EXCEPTION;
14:33:53 543  BAD_SUBSCRIPTION_STATUS EXCEPTION;
14:33:53 544  NO_LICENSE_FOUND	      EXCEPTION;
14:33:53 545  NO_OFFER_FOUND	      EXCEPTION;
14:33:53 546  EXCEPTION_MESSAGE       VARCHAR2(1024);
14:33:53 547  BEGIN
14:33:53 548  	-- TODO: Finish this prcedure (in Phase II)
14:33:53 549  
14:33:53 550  	-- Get subscription by id. FAULT if no such subscription.
14:33:53 551  	-- begin TX
14:33:53 552  	--   Get for update associated license (subscription.license_id). FAULT if not found.
14:33:53 553  	--   Set status to PROCESSED.
14:33:53 554  	--   updated record.
14:33:53 555  	--   compute days remaining in the subscription: original end_date - today = days_remaining_adjustment
14:33:53 556  	--   new subscription status is SUSPENDED.
14:33:53 557  	--   suspend_date is now.
14:33:53 558  	--   update subscription record.
14:33:53 559  	-- end TX
14:33:53 560  
14:33:53 561  	BEGIN
14:33:53 562  	  SELECT
14:33:53 563  	    SUBSCRIPTION.SUBSCRIPTION_STATUS_ID into var_subscription_status_id
14:33:53 564  	  FROM
14:33:53 565  	    SUBSCRIPTION
14:33:53 566  	  WHERE
14:33:53 567  	    SUBSCRIPTION.ID = in_subs_id;
14:33:53 568  	  EXCEPTION
14:33:53 569  	  WHEN NO_DATA_FOUND THEN
14:33:53 570  	    RAISE BAD_SUBSCRIPTION_ID;
14:33:53 571  	END;
14:33:53 572  
14:33:53 573  	IF var_subscription_status_id != GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE THEN
14:33:53 574  	  RAISE BAD_SUBSCRIPTION_STATUS;
14:33:53 575  	END IF;
14:33:53 576  
14:33:53 577  	BEGIN
14:33:53 578  	  SELECT
14:33:53 579  	    LICENSE.ID,
14:33:53 580  	    LICENSE.OFFER_ID,
14:33:53 581  	    LICENSE.START_DATE
14:33:53 582  	    into
14:33:53 583  	    var_license_id,
14:33:53 584  	    var_offer_id,
14:33:53 585  	    var_license_start_date
14:33:53 586  	  FROM
14:33:53 587  	    LICENSE
14:33:53 588  	  WHERE
14:33:53 589  	    LICENSE.SUBSCRIPTION_ID = in_subs_id
14:33:53 590  	      AND LICENSE.LICENSE_STATUS_ID = GLOBAL_STATUSES_V22.LICENSE_ACTIVE;
14:33:53 591  	  EXCEPTION
14:33:53 592  	  WHEN NO_DATA_FOUND THEN
14:33:53 593  	    RAISE NO_LICENSE_FOUND;
14:33:53 594  	END;
14:33:53 595  
14:33:53 596  	PROCS_LICENSE_CRU_V22.UPDATE_LICENSE(
14:33:53 597  	  in_license_id        => var_license_id,
14:33:53 598  	  in_updated_by        => in_updated_by,
14:33:53 599  	  in_license_status_id => GLOBAL_STATUSES_V22.LICENSE_CLOSED
14:33:53 600  	);
14:33:53 601  
14:33:53 602  	BEGIN
14:33:53 603  	  SELECT
14:33:53 604  	    OFFER.ENTITLEMENT_DURATION into var_entitlement_dupration
14:33:53 605  	  FROM
14:33:53 606  	    OFFER
14:33:53 607  	  WHERE
14:33:53 608  	    OFFER.ID = var_offer_id;
14:33:53 609  	  EXCEPTION
14:33:53 610  	  WHEN NO_DATA_FOUND THEN
14:33:53 611  	    RAISE NO_OFFER_FOUND;
14:33:53 612  	END;
14:33:53 613  
14:33:53 614  	var_ym_interval := substr(var_entitlement_dupration, 0, 4);
14:33:53 615  	var_ds_interval := substr(var_entitlement_dupration, 4);
14:33:53 616  
14:33:53 617  	var_license_end_date := var_license_start_date + var_ym_interval + var_ds_interval;
14:33:53 618  
14:33:53 619  	var_d_entitlement_dupration := var_license_end_date - current_date;
14:33:53 620  
14:33:53 621  	PROCS_SUBSCRIPTION_CRU_V22.UPDATE_SUBSCRIPTION(
14:33:53 622  	  in_subscription_id	       => in_subs_id,
14:33:53 623  	  in_updated_by 	       => in_updated_by,
14:33:53 624  	  in_suspend_date	       => SYSDATE,
14:33:53 625  	  in_subscription_status_id    => GLOBAL_STATUSES_V22.SUBSCRIPTION_SUSPENDED,
14:33:53 626  	  in_days_remainning_ajustment => var_d_entitlement_dupration
14:33:53 627  	);
14:33:53 628  
14:33:53 629  EXCEPTION
14:33:53 630  WHEN BAD_SUBSCRIPTION_ID THEN
14:33:53 631  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 632  	  SPROC_NAME, 'No such subscription');
14:33:53 633  WHEN BAD_SUBSCRIPTION_STATUS THEN
14:33:53 634  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:53 635  	  SPROC_NAME, 'Subscription is not active');
14:33:53 636  WHEN NO_LICENSE_FOUND THEN
14:33:53 637  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 638  	  SPROC_NAME, 'Can not find license associated with given subscription ID');
14:33:53 639  WHEN NO_OFFER_FOUND THEN
14:33:53 640  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 641  	  SPROC_NAME, 'Can not find offer associated with given subscription ID');
14:33:53 642  WHEN OTHERS THEN
14:33:53 643  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 644  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 645  END SUSPEND_SUBSCRIPTION;
14:33:53 646  
14:33:53 647  /******************************************************************************/
14:33:53 648  
14:33:53 649  PROCEDURE REACTIVATE_SUBSCRIPTION (
14:33:53 650  	in_subscription_id IN  NUMBER,
14:33:53 651  	in_updated_by	   IN  VARCHAR2
14:33:53 652  ) AS
14:33:53 653  BEGIN
14:33:53 654  	-- TODO: finish this function (in Phase II)
14:33:53 655  	NULL;
14:33:53 656  END REACTIVATE_SUBSCRIPTION;
14:33:53 657  
14:33:53 658  /******************************************************************************/
14:33:53 659  
14:33:53 660  PROCEDURE GET_SUBSCRIPTION_INFO (
14:33:53 661  /*
14:33:53 662  Throws exceptions:
14:33:53 663  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 664  */
14:33:53 665  	  in_subscription_id  IN  NUMBER,
14:33:53 666  	  out_result_set      OUT SYS_REFCURSOR
14:33:53 667  ) AS
14:33:53 668  SPROC_NAME CONSTANT VARCHAR2(21) := 'GET_SUBSCRIPTION_INFO';
14:33:53 669  -- VARIABLES
14:33:53 670  temp_subscription_id NUMBER;
14:33:53 671  -- EXCEPTIONS
14:33:53 672  BAD_SUBSCRIPTION_ID EXCEPTION;
14:33:53 673  BEGIN
14:33:53 674  	-- Find subscription by id
14:33:53 675  	-- Return its details
14:33:53 676  
14:33:53 677  	BEGIN
14:33:53 678  	  SELECT
14:33:53 679  	    SUBSCRIPTION.ID into temp_subscription_id
14:33:53 680  	  FROM
14:33:53 681  	    SUBSCRIPTION
14:33:53 682  	  WHERE
14:33:53 683  	    SUBSCRIPTION.ID = in_subscription_id;
14:33:53 684  	  EXCEPTION
14:33:53 685  	    WHEN NO_DATA_FOUND THEN
14:33:53 686  	      RAISE BAD_SUBSCRIPTION_ID;
14:33:53 687  	END;
14:33:53 688  
14:33:53 689  	OPEN out_result_set FOR
14:33:53 690  	SELECT
14:33:53 691  	  SUBSCRIPTION.ID AS "SUBSCRIPTION_ID",
14:33:53 692  	  SUBSCRIPTION.SUBSCRIPTION_STATUS_ID,
14:33:53 693  	  SUBSCRIPTION.PURCHASE_DATE,
14:33:53 694  	  SUBSCRIPTION.SUSPEND_DATE,
14:33:53 695  	  SUBSCRIPTION.REACTIVATION_DATE,
14:33:53 696  	  SUBSCRIPTION.CANCELLATION_DATE,
14:33:53 697  	  SUBSCRIPTION_CANCEL_REASON.VALUE as "CANCEL_TYPE",
14:33:53 698  	  OFFER_CHAIN.ID AS "OFFER_CHAIN_ID",
14:33:53 699  	  OFFER_CHAIN.NAME,
14:33:53 700  	  OFFER_CHAIN.DESCRIPTION,
14:33:53 701  	  OFFER_CHAIN.PRODUCT_URI,
14:33:53 702  	  SUBSCRIPTION.INSTRUMENT_ID,
14:33:53 703  	  SUBSCRIPTION.INSTRUMENT_TYPE_ID,
14:33:53 704  	  PROCS_SUBSCRIPTION_V22.CALC_SUBSCRIPTION_END_DATE(SUBSCRIPTION.ID) as "END_DATE",
14:33:53 705  	  PROCS_SUBSCRIPTION_V22.GET_RECENT_CHARGE(SUBSCRIPTION.ID) AS "RECENT_CHARGE",
14:33:53 706  	  PROCS_SUBSCRIPTION_V22.GET_RENEWAL_DATE(SUBSCRIPTION.ID) AS "RENEWAL_DATE",
14:33:53 707  	  PROCS_SUBSCRIPTION_V22.GET_BILLING_CYCLE(SUBSCRIPTION.ID) AS "BILLING_CYCLE",
14:33:53 708  	  (
14:33:53 709  	    SELECT
14:33:53 710  	      ACCOUNT.GROUP_ID
14:33:53 711  	      FROM ACCOUNT
14:33:53 712  	      WHERE ACCOUNT.ID = SUBSCRIPTION.ACCOUNT_ID
14:33:53 713  	  ) as "GROUP_ID",
14:33:53 714  	  (
14:33:53 715  	    SELECT
14:33:53 716  	      MAX(ENTITLEMENT_END_DATE)
14:33:53 717  	      FROM LICENSE
14:33:53 718  	      WHERE LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
14:33:53 719  	  )
14:33:53 720  	  as "ENT_END_DATE",
14:33:53 721  	  (
14:33:53 722  	    SELECT
14:33:53 723  	      MIN(START_DATE)
14:33:53 724  	      FROM LICENSE
14:33:53 725  	      WHERE LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
14:33:53 726  	  )
14:33:53 727  	  as "ENT_START_DATE",
14:33:53 728  	  PROCS_SUBSCRIPTION_V22.IS_SUBSCRIPTION_CANCELABLE(SUBSCRIPTION.ID) AS "IS_CANCELABLE",
14:33:53 729  	  ITUNES_RECEIPT.ID AS "ITUNES_RECEIPT_ID",
14:33:53 730  	  GROUP_ACCOUNT.ID GA_ID,
14:33:53 731  	  GROUP_ACCOUNT.SUBSCRIPTION_ID GA_SUBSCRIPTION_ID,
14:33:53 732  	  GROUP_ACCOUNT.GROUP_NAME GA_GROUP_NAME,
14:33:53 733  	  GROUP_ACCOUNT.FIRST_NAME GA_FIRST_NAME,
14:33:53 734  	  GROUP_ACCOUNT.LAST_NAME GA_LAST_NAME,
14:33:53 735  	  GROUP_ACCOUNT.EMAIL GA_EMAIL,
14:33:53 736  	  GROUP_ACCOUNT.PHONE GA_PHONE,
14:33:53 737  	  GROUP_ACCOUNT.ORGANIZATION_TYPE GA_ORGANIZATION_TYPE,
14:33:53 738  	  GROUP_ACCOUNT.SEATS GA_SEATS,
14:33:53 739  	  PROCS_GROUP_ACCOUNT_V22.F_GET_NUM_OCCUPIED_GROUP_SEATS(GROUP_ACCOUNT.ID) GA_SEATS_USED,
14:33:53 740  	  GROUP_ACCOUNT.IP GA_IP,
14:33:53 741  	  PROCS_SUBSCRIPTION_V22.GET_GIFT_CERT_CODE_BY_SUB_ID(SUBSCRIPTION.ID) gift_certificate_code,
14:33:53 742  	  PROCS_ACCOUNT_V22.GET_GRACE_START_DATE(SUBSCRIPTION.ID) GRACE_START_DATE,
14:33:53 743  	  PROCS_ACCOUNT_V22.GET_GRACE_END_DATE(SUBSCRIPTION.ID) GRACE_END_DATE
14:33:53 744  	FROM
14:33:53 745  	  SUBSCRIPTION
14:33:53 746  	  INNER JOIN OFFER_CHAIN ON SUBSCRIPTION.OFFER_CHAIN_ID = OFFER_CHAIN.ID
14:33:53 747  	  LEFT JOIN SUBSCRIPTION_CANCEL_REASON ON SUBSCRIPTION.SCT_ID = SUBSCRIPTION_CANCEL_REASON.ID
14:33:53 748  	  LEFT JOIN ITUNES_RECEIPT ON SUBSCRIPTION.ID = ITUNES_RECEIPT.SUBSCRIPTION_ID
14:33:53 749  	  LEFT JOIN GROUP_ACCOUNT ON SUBSCRIPTION.ID = GROUP_ACCOUNT.SUBSCRIPTION_ID
14:33:53 750  	WHERE
14:33:53 751  	  SUBSCRIPTION.ID = in_subscription_id;
14:33:53 752  
14:33:53 753  EXCEPTION
14:33:53 754  WHEN BAD_SUBSCRIPTION_ID THEN
14:33:53 755  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 756  	  SPROC_NAME, 'No such subscription');
14:33:53 757  WHEN OTHERS THEN
14:33:53 758  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 759  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 760  END GET_SUBSCRIPTION_INFO;
14:33:53 761  
14:33:53 762  /******************************************************************************/
14:33:53 763  
14:33:53 764  PROCEDURE GET_SUBSCRIPTION_INVOICES (
14:33:53 765  /*
14:33:53 766  Throws exceptions:
14:33:53 767  APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 768  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 769  */
14:33:53 770  	in_subscription_id  IN	NUMBER,
14:33:53 771  	out_result_set	    OUT SYS_REFCURSOR
14:33:53 772  ) AS
14:33:53 773  SPROC_NAME	   CONSTANT VARCHAR2(25) := 'GET_SUBSCRIPTION_INVOICES';
14:33:53 774  temp_subscription_id NUMBER;
14:33:53 775  BEGIN
14:33:53 776  	-- Note: A subscription has one or more associated licenses, each of which has an associated invoice.
14:33:53 777  	-- Find associated LICENSES for the subscription by "LICENSE.subscription_id"
14:33:53 778  	--   for each license
14:33:53 779  	--     get associated invoice
14:33:53 780  	--     add to results list
14:33:53 781  	--   end loop
14:33:53 782  	-- end
14:33:53 783  
14:33:53 784  	SELECT
14:33:53 785  	  SUBSCRIPTION.ID into temp_subscription_id
14:33:53 786  	FROM
14:33:53 787  	  SUBSCRIPTION
14:33:53 788  	WHERE
14:33:53 789  	  SUBSCRIPTION.ID = in_subscription_id;
14:33:53 790  
14:33:53 791  	OPEN out_result_set FOR
14:33:53 792  	SELECT
14:33:53 793  	  INVOICE.ID,
14:33:53 794  	  INVOICE.INVOICE_STATUS_ID,
14:33:53 795  	  INVOICE.CREATE_DATE,
14:33:53 796  	  INVOICE.CREATED_BY,
14:33:53 797  	  INVOICE.UPDATE_DATE,
14:33:53 798  	  INVOICE.UPDATED_BY,
14:33:53 799  	  INVOICE.TAX_EXEMPT_ID
14:33:53 800  	FROM
14:33:53 801  	  LICENSE
14:33:53 802  	    INNER JOIN INVOICE ON LICENSE.INVOICE_ID = INVOICE.ID
14:33:53 803  	WHERE
14:33:53 804  	  LICENSE.SUBSCRIPTION_ID = in_subscription_id;
14:33:53 805  
14:33:53 806  EXCEPTION
14:33:53 807  WHEN NO_DATA_FOUND THEN
14:33:53 808  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 809  	  SPROC_NAME, 'Could not find subscription with given ID');
14:33:53 810  WHEN OTHERS THEN
14:33:53 811  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 812  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 813  END GET_SUBSCRIPTION_INVOICES;
14:33:53 814  
14:33:53 815  /******************************************************************************/
14:33:53 816  
14:33:53 817  PROCEDURE GET_SUBSCRIPTION_NOTES (
14:33:53 818  /*
14:33:53 819  Throws exceptions:
14:33:53 820  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 821  */
14:33:53 822  	in_subscription_id  IN	NUMBER,
14:33:53 823  	out_result_set	    OUT SYS_REFCURSOR
14:33:53 824  ) AS
14:33:53 825  -- VARIABLES
14:33:53 826  SPROC_NAME	   CONSTANT VARCHAR2(22) := 'GET_SUBSCRIPTION_NOTES';
14:33:53 827  temp_subscription_id NUMBER;
14:33:53 828  -- EXCEPTIONS
14:33:53 829  BAD_SUBSCRIPTION_ID EXCEPTION;
14:33:53 830  BEGIN
14:33:53 831  
14:33:53 832  	-- Check that subscription exists
14:33:53 833  	BEGIN
14:33:53 834  	  SELECT
14:33:53 835  	    SUBSCRIPTION.ID into temp_subscription_id
14:33:53 836  	  FROM
14:33:53 837  	    SUBSCRIPTION
14:33:53 838  	  WHERE
14:33:53 839  	    SUBSCRIPTION.ID = in_subscription_id;
14:33:53 840  	  EXCEPTION
14:33:53 841  	    WHEN NO_DATA_FOUND THEN
14:33:53 842  	      RAISE BAD_SUBSCRIPTION_ID;
14:33:53 843  	END;
14:33:53 844  
14:33:53 845  	OPEN out_result_set FOR
14:33:53 846  	SELECT
14:33:53 847  	  SUBSCRIPTION_NOTE.NOTE,
14:33:53 848  	  SUBSCRIPTION_NOTE.CREATED_BY,
14:33:53 849  	  SUBSCRIPTION_NOTE.CREATE_DATE
14:33:53 850  	FROM
14:33:53 851  	  SUBSCRIPTION_NOTE
14:33:53 852  	WHERE
14:33:53 853  	  SUBSCRIPTION_NOTE.SUBSCRIPTION_ID = in_subscription_id
14:33:53 854  	ORDER BY
14:33:53 855  	  SUBSCRIPTION_NOTE.CREATE_DATE ASC;
14:33:53 856  
14:33:53 857  EXCEPTION
14:33:53 858  WHEN BAD_SUBSCRIPTION_ID THEN
14:33:53 859  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 860  	  SPROC_NAME, 'No such subscription');
14:33:53 861  WHEN OTHERS THEN
14:33:53 862  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 863  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 864  END GET_SUBSCRIPTION_NOTES;
14:33:53 865  
14:33:53 866  /******************************************************************************/
14:33:53 867  
14:33:53 868  PROCEDURE ANNOTATE_SUBSCRIPTION (
14:33:53 869  /*
14:33:53 870  Throws exceptions:
14:33:53 871  APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 872  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 873  */
14:33:53 874  	in_subscription_id IN  NUMBER,
14:33:53 875  	in_agent_id	   IN  NUMBER,
14:33:53 876  	in_note 	   IN  VARCHAR2,
14:33:53 877  	in_created_by	   IN  VARCHAR2
14:33:53 878  ) AS
14:33:53 879  -- VARIABLES
14:33:53 880  SPROC_NAME	       CONSTANT VARCHAR2(21) := 'ANNOTATE_SUBSCRIPTION';
14:33:53 881  temp_subscription_id     NUMBER;
14:33:53 882  var_subscription_note_id NUMBER;
14:33:53 883  -- EXCEPTIONS
14:33:53 884  BAD_SUBSCRIPTION_ID EXCEPTION;
14:33:53 885  BEGIN
14:33:53 886  
14:33:53 887  	-- Check that subscription exists
14:33:53 888  	BEGIN
14:33:53 889  	  SELECT
14:33:53 890  	    SUBSCRIPTION.ID into temp_subscription_id
14:33:53 891  	  FROM
14:33:53 892  	    SUBSCRIPTION
14:33:53 893  	  WHERE
14:33:53 894  	    SUBSCRIPTION.ID = in_subscription_id;
14:33:53 895  	  EXCEPTION
14:33:53 896  	    WHEN NO_DATA_FOUND THEN
14:33:53 897  	      RAISE BAD_SUBSCRIPTION_ID;
14:33:53 898  	END;
14:33:53 899  
14:33:53 900  	PROCS_SUBSCRIPTION_CRU_V22.CREATE_SUBSCRIPTION_NOTE(
14:33:53 901  	  inout_subscription_note_id => var_subscription_note_id,
14:33:53 902  	  in_agent_id		     => in_agent_id,
14:33:53 903  	  in_subscription_id	     => in_subscription_id,
14:33:53 904  	  in_note		     => in_note,
14:33:53 905  	  in_created_by 	     => in_created_by
14:33:53 906  	);
14:33:53 907  
14:33:53 908  EXCEPTION
14:33:53 909  WHEN BAD_SUBSCRIPTION_ID THEN
14:33:53 910  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 911  	  SPROC_NAME, 'No such subscription');
14:33:53 912  WHEN OTHERS THEN
14:33:53 913  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 914  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 915  END ANNOTATE_SUBSCRIPTION;
14:33:53 916  
14:33:53 917  /******************************************************************************/
14:33:53 918  
14:33:53 919  PROCEDURE GET_CANCEL_REASONS (
14:33:53 920  	out_result_set	  OUT SYS_REFCURSOR
14:33:53 921  ) AS
14:33:53 922  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_CANCEL_REASONS';
14:33:53 923  BEGIN
14:33:53 924  	OPEN out_result_set FOR
14:33:53 925  	SELECT
14:33:53 926  	  SUBSCRIPTION_CANCEL_REASON.ID,
14:33:53 927  	  SUBSCRIPTION_CANCEL_REASON.VALUE,
14:33:53 928  	  SUBSCRIPTION_CANCEL_REASON.DESCRIPTION,
14:33:53 929  	  SUBSCRIPTION_CANCEL_REASON.CANCELATION_STATUS_ID AS STATUS_ID
14:33:53 930  	FROM
14:33:53 931  	  SUBSCRIPTION_CANCEL_REASON;
14:33:53 932  
14:33:53 933  END GET_CANCEL_REASONS;
14:33:53 934  
14:33:53 935  /******************************************************************************/
14:33:53 936  
14:33:53 937  FUNCTION GET_RENEWAL_DATE (
14:33:53 938  /*
14:33:53 939  Throws exceptions:
14:33:53 940  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 941  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 942  */
14:33:53 943  	in_subscription_id in NUMBER
14:33:53 944  ) RETURN DATE AS
14:33:53 945  -- VARIABLES
14:33:53 946  SPROC_NAME	      CONSTANT VARCHAR2(16) := 'GET_RENEWAL_DATE';
14:33:53 947  var_subscription_status NUMBER;
14:33:53 948  var_licenses_count      NUMBER;
14:33:53 949  var_license_end_date    DATE;
14:33:53 950  var_last_offer_id       NUMBER;
14:33:53 951  var_offer_chain_id      NUMBER;
14:33:53 952  var_last_license_id     NUMBER;
14:33:53 953  var_current_offer_index NUMBER;
14:33:53 954  var_current_offer_recurr_num NUMBER;
14:33:53 955  var_offer_recurr_num    NUMBER;
14:33:53 956  -- EXCEPTIONS
14:33:53 957  BAD_SUBSCRIPTION_ID EXCEPTION;
14:33:53 958  NO_LICENSES_FOUND EXCEPTION;
14:33:53 959  BEGIN
14:33:53 960  
14:33:53 961  	-- Get subscription id and offer chain id
14:33:53 962  	BEGIN
14:33:53 963  	  SELECT
14:33:53 964  	    SUBSCRIPTION.SUBSCRIPTION_STATUS_ID,
14:33:53 965  	    SUBSCRIPTION.OFFER_CHAIN_ID
14:33:53 966  	    into
14:33:53 967  	    var_subscription_status,
14:33:53 968  	    var_offer_chain_id
14:33:53 969  	  FROM
14:33:53 970  	    SUBSCRIPTION
14:33:53 971  	  WHERE
14:33:53 972  	    SUBSCRIPTION.ID = in_subscription_id;
14:33:53 973  	  EXCEPTION
14:33:53 974  	    WHEN NO_DATA_FOUND THEN
14:33:53 975  	      RAISE BAD_SUBSCRIPTION_ID;
14:33:53 976  	END;
14:33:53 977  
14:33:53 978  	IF var_subscription_status != GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE THEN
14:33:53 979  	  -- TODO: Is suspended subscription has renewal date? (For the phase II)
14:33:53 980  	  -- AND var_subscription_status != GLOBAL_STATUSES_V22.SUBSCRIPTION_SUSPENDED THEN
14:33:53 981  	  RETURN NULL;
14:33:53 982  	END IF;
14:33:53 983  
14:33:53 984  	BEGIN
14:33:53 985  	  SELECT
14:33:53 986  	    LICENSE_ID,
14:33:53 987  	    END_DATE,
14:33:53 988  	    OFFER_ID,
14:33:53 989  	    CURRENT_OFFER_INDEX,
14:33:53 990  	    CURRENT_OFFER_RECURR_NUM
14:33:53 991  	    into
14:33:53 992  	    var_last_license_id,
14:33:53 993  	    var_license_end_date,
14:33:53 994  	    var_last_offer_id,
14:33:53 995  	    var_current_offer_index,
14:33:53 996  	    var_current_offer_recurr_num
14:33:53 997  	  FROM
14:33:53 998  	    (
14:33:53 999  	      SELECT
14:33:53 1000  		 LICENSE.ID as "LICENSE_ID",
14:33:53 1001  		 LICENSE.END_DATE,
14:33:53 1002  		 LICENSE.OFFER_ID,
14:33:53 1003  		 LICENSE.CURRENT_OFFER_INDEX,
14:33:53 1004  		 LICENSE.CURRENT_OFFER_RECURR_NUM
14:33:53 1005  	       FROM
14:33:53 1006  		 LICENSE
14:33:53 1007  	       WHERE
14:33:53 1008  		 LICENSE.LICENSE_STATUS_ID = GLOBAL_STATUSES_V22.LICENSE_ACTIVE
14:33:53 1009  		 AND LICENSE.SUBSCRIPTION_ID = in_subscription_id
14:33:53 1010  	       ORDER BY END_DATE DESC
14:33:53 1011  	     )
14:33:53 1012  	     INNER JOIN OFFER ON OFFER_ID = OFFER.ID
14:33:53 1013  	   WHERE
14:33:53 1014  	     ROWNUM <= 1;
14:33:53 1015  
14:33:53 1016  	   EXCEPTION
14:33:53 1017  	     WHEN NO_DATA_FOUND THEN
14:33:53 1018  	       -- RAISE NO_LICENSES_FOUND;
14:33:53 1019  	       RETURN NULL;
14:33:53 1020  	 END;
14:33:53 1021  
14:33:53 1022  	 SELECT
14:33:53 1023  	   OFFER_OFFER_CHAIN.NUM_RECURRENCES into var_offer_recurr_num
14:33:53 1024  	 FROM
14:33:53 1025  	   OFFER_OFFER_CHAIN
14:33:53 1026  	 WHERE
14:33:53 1027  	   OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = var_offer_chain_id
14:33:53 1028  	   AND OFFER_OFFER_CHAIN.OFFER_ID = var_last_offer_id;
14:33:53 1029  
14:33:53 1030  	 IF PROCS_OFFER_CHAIN_V22.GET_NEXT_OFFER_INDEX(var_offer_chain_id, var_current_offer_index) IS NULL
14:33:53 1031  	   AND var_offer_recurr_num = var_current_offer_recurr_num THEN
14:33:53 1032  	   -- There is no next offer for this subscription
14:33:53 1033  	   RETURN NULL;
14:33:53 1034  	 END IF;
14:33:53 1035  
14:33:53 1036  	 RETURN var_license_end_date;
14:33:53 1037  
14:33:53 1038  EXCEPTION
14:33:53 1039  WHEN BAD_SUBSCRIPTION_ID THEN
14:33:53 1040  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1041  	   SPROC_NAME, 'No such subscription');
14:33:53 1042  WHEN NO_LICENSES_FOUND THEN
14:33:53 1043  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1044  	   SPROC_NAME, 'No licenses found');
14:33:53 1045  WHEN OTHERS THEN
14:33:53 1046  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1047  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1048  END GET_RENEWAL_DATE;
14:33:53 1049  
14:33:53 1050  /******************************************************************************/
14:33:53 1051  
14:33:53 1052  FUNCTION GET_RECENT_CHARGE (
14:33:53 1053  /*
14:33:53 1054  Throws exceptions:
14:33:53 1055  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 1056  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 1057  */
14:33:53 1058  	 in_subscription_id IN NUMBER
14:33:53 1059  ) RETURN NUMBER AS
14:33:53 1060  -- VARIABLES
14:33:53 1061  SPROC_NAME	    CONSTANT VARCHAR2(17) := 'GET_RECENT_CHARGE';
14:33:53 1062  temp_subscription_id NUMBER;
14:33:53 1063  var_recent_charge    NUMBER(10,2);
14:33:53 1064  
14:33:53 1065  -- EXCEPTIONS
14:33:53 1066  BAD_SUBSCRIPTION_ID EXCEPTION;
14:33:53 1067  BEGIN
14:33:53 1068  
14:33:53 1069  	 BEGIN
14:33:53 1070  	   SELECT
14:33:53 1071  	     SUBSCRIPTION.ID into temp_subscription_id
14:33:53 1072  	   FROM
14:33:53 1073  	     SUBSCRIPTION
14:33:53 1074  	   WHERE
14:33:53 1075  	     SUBSCRIPTION.ID = in_subscription_id;
14:33:53 1076  	   EXCEPTION
14:33:53 1077  	     WHEN NO_DATA_FOUND THEN
14:33:53 1078  	       RAISE BAD_SUBSCRIPTION_ID;
14:33:53 1079  	 END;
14:33:53 1080  
14:33:53 1081  	 BEGIN
14:33:53 1082  	   SELECT
14:33:53 1083  	     CHARGE.CHARGE_AMOUNT into var_recent_charge
14:33:53 1084  	   FROM
14:33:53 1085  	     LICENSE
14:33:53 1086  	     INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
14:33:53 1087  	     INNER JOIN INVOICE ON LICENSE.INVOICE_ID = INVOICE.ID
14:33:53 1088  	     INNER JOIN CHARGE ON CHARGE.INVOICE_ID = INVOICE.ID
14:33:53 1089  	   WHERE
14:33:53 1090  	     -- TODO: Review
14:33:53 1091  	     -- LICENSE.LICENSE_STATUS_ID = GLOBAL_STATUSES_V22.LICENSE_PROCESSED
14:33:53 1092  	     -- AND
14:33:53 1093  	     SUBSCRIPTION.ID = in_subscription_id
14:33:53 1094  	     AND CHARGE.CHARGE_AMOUNT >= 0
14:33:53 1095  	     AND ROWNUM <= 1
14:33:53 1096  	   ORDER BY
14:33:53 1097  	     LICENSE.ID ASC, CHARGE.ID DESC;
14:33:53 1098  	   EXCEPTION
14:33:53 1099  	     WHEN NO_DATA_FOUND THEN
14:33:53 1100  	       var_recent_charge := 0;
14:33:53 1101  	 END;
14:33:53 1102  
14:33:53 1103  	 RETURN var_recent_charge;
14:33:53 1104  
14:33:53 1105  EXCEPTION
14:33:53 1106  WHEN BAD_SUBSCRIPTION_ID THEN
14:33:53 1107  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1108  	   SPROC_NAME, 'No such subscription');
14:33:53 1109  WHEN OTHERS THEN
14:33:53 1110  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1111  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1112  END GET_RECENT_CHARGE;
14:33:53 1113  
14:33:53 1114  /******************************************************************************/
14:33:53 1115  
14:33:53 1116  FUNCTION GET_BILLING_CYCLE (
14:33:53 1117  	 in_subscription_id IN NUMBER
14:33:53 1118  ) RETURN VARCHAR2 AS
14:33:53 1119  -- VARIABLES
14:33:53 1120  SPROC_NAME	    CONSTANT VARCHAR2(17) := 'GET_BILLING_CYCLE';
14:33:53 1121  temp_subscription_id NUMBER;
14:33:53 1122  var_offer_duration   VARCHAR2(30);
14:33:53 1123  
14:33:53 1124  -- EXCEPTIONS
14:33:53 1125  BAD_SUBSCRIPTION_ID EXCEPTION;
14:33:53 1126  BEGIN
14:33:53 1127  
14:33:53 1128  	 BEGIN
14:33:53 1129  	   SELECT
14:33:53 1130  	     SUBSCRIPTION.ID into temp_subscription_id
14:33:53 1131  	   FROM
14:33:53 1132  	     SUBSCRIPTION
14:33:53 1133  	   WHERE
14:33:53 1134  	     SUBSCRIPTION.ID = in_subscription_id;
14:33:53 1135  	   EXCEPTION
14:33:53 1136  	     WHEN NO_DATA_FOUND THEN
14:33:53 1137  	       RAISE BAD_SUBSCRIPTION_ID;
14:33:53 1138  	 END;
14:33:53 1139  
14:33:53 1140  	 SELECT
14:33:53 1141  	   OFFER.ENTITLEMENT_DURATION into var_offer_duration
14:33:53 1142  	 FROM
14:33:53 1143  	   LICENSE
14:33:53 1144  	   INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
14:33:53 1145  	   INNER JOIN OFFER ON LICENSE.OFFER_ID = OFFER.ID
14:33:53 1146  	 WHERE
14:33:53 1147  	   --LICENSE.LICENSE_STATUS_ID = GLOBAL_STATUSES_V22.LICENSE_PROCESSED
14:33:53 1148  	   --AND
14:33:53 1149  	   SUBSCRIPTION.ID = in_subscription_id
14:33:53 1150  	   AND ROWNUM <= 1
14:33:53 1151  	 ORDER BY
14:33:53 1152  	   LICENSE.ID ASC;
14:33:53 1153  
14:33:53 1154  	 RETURN var_offer_duration;
14:33:53 1155  
14:33:53 1156  EXCEPTION
14:33:53 1157  WHEN BAD_SUBSCRIPTION_ID THEN
14:33:53 1158  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1159  	   SPROC_NAME, 'No such subscription');
14:33:53 1160  WHEN OTHERS THEN
14:33:53 1161  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1162  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1163  END GET_BILLING_CYCLE;
14:33:53 1164  
14:33:53 1165  /******************************************************************************/
14:33:53 1166  
14:33:53 1167  PROCEDURE REFUND_SUBSCRIPTION (
14:33:53 1168  /*
14:33:53 1169  Throws exceptions:
14:33:53 1170  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 1171  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 1172  */
14:33:53 1173  	 in_subscription_id IN NUMBER,
14:33:53 1174  	 in_invoice_id	    IN NUMBER,
14:33:53 1175  	 in_refund_amount   IN NUMBER,
14:33:53 1176  	 in_note	    IN VARCHAR2,
14:33:53 1177  	 in_created_by	    IN VARCHAR2,
14:33:53 1178  	 out_charge_id	    OUT NUMBER
14:33:53 1179  ) AS
14:33:53 1180  -- VARIABLES
14:33:53 1181  SPROC_NAME	      CONSTANT VARCHAR2(19) := 'REFUND_SUBSCRIPTION';
14:33:53 1182  var_invoice_status_id  NUMBER;
14:33:53 1183  var_account_id	      NUMBER;
14:33:53 1184  var_account_status_id  NUMBER;
14:33:53 1185  var_new_transaction_id NUMBER;
14:33:53 1186  var_instrument_type_id NUMBER;
14:33:53 1187  var_instrument_id      NUMBER;
14:33:53 1188  var_new_charge_id      NUMBER;
14:33:53 1189  var_invoice_amount     NUMBER(10,2);
14:33:53 1190  var_refunds_before     NUMBER(10,2);
14:33:53 1191  var_charges_amount     NUMBER(10,2);
14:33:53 1192  -- EXCEPTIONS
14:33:53 1193  BAD_SUBSCRIPTION_ID	     EXCEPTION;
14:33:53 1194  ACCOUNT_IS_FROZEN	     EXCEPTION;
14:33:53 1195  BAD_INVOICE_ID		     EXCEPTION;
14:33:53 1196  CAN_NOT_CREATE_TRANSACTION    EXCEPTION;
14:33:53 1197  CAN_NOT_CREATE_CHARGE	     EXCEPTION;
14:33:53 1198  CAN_NOT_CALC_INVOICE_AMOUNT   EXCEPTION;
14:33:53 1199  REFUND_IS_GREATER_THAN_ANOUNT EXCEPTION;
14:33:53 1200  CAN_NOT_ANNOTATE_SUBSCRIPTION EXCEPTION;
14:33:53 1201  TOT_REF_IS_GREATER_THAN_ANOUNT EXCEPTION;
14:33:53 1202  INVOICE_IS_NOT_CLOSED	     EXCEPTION;
14:33:53 1203  TOT_REF_IS_GRATER_THAN_CHARGES EXCEPTION;
14:33:53 1204  EXCEPTION_MESSAGE	      VARCHAR2(1024);
14:33:53 1205  BEGIN
14:33:53 1206  
14:33:53 1207  	 BEGIN
14:33:53 1208  	   SELECT
14:33:53 1209  	     SUBSCRIPTION.INSTRUMENT_ID,
14:33:53 1210  	     SUBSCRIPTION.INSTRUMENT_TYPE_ID,
14:33:53 1211  	     SUBSCRIPTION.ACCOUNT_ID
14:33:53 1212  	     into
14:33:53 1213  	     var_instrument_id,
14:33:53 1214  	     var_instrument_type_id,
14:33:53 1215  	     var_account_id
14:33:53 1216  	   FROM
14:33:53 1217  	     SUBSCRIPTION
14:33:53 1218  	   WHERE
14:33:53 1219  	     SUBSCRIPTION.ID = in_subscription_id;
14:33:53 1220  	   EXCEPTION
14:33:53 1221  	     WHEN NO_DATA_FOUND THEN
14:33:53 1222  	       RAISE BAD_SUBSCRIPTION_ID;
14:33:53 1223  	 END;
14:33:53 1224  
14:33:53 1225  	 -- Check account status. It should not to be frozen
14:33:53 1226  	 SELECT
14:33:53 1227  	   ACCOUNT.ACCOUNT_STATUS_ID into var_account_status_id
14:33:53 1228  	 FROM
14:33:53 1229  	   ACCOUNT
14:33:53 1230  	 WHERE
14:33:53 1231  	   ACCOUNT.ID = var_account_id;
14:33:53 1232  
14:33:53 1233  	 IF var_account_status_id = GLOBAL_STATUSES_V22.ACCOUNT_FROZEN THEN
14:33:53 1234  	   RAISE ACCOUNT_IS_FROZEN;
14:33:53 1235  	 END IF;
14:33:53 1236  
14:33:53 1237  	 BEGIN
14:33:53 1238  	   SELECT
14:33:53 1239  	     INVOICE.INVOICE_STATUS_ID into var_invoice_status_id
14:33:53 1240  	   FROM
14:33:53 1241  	     INVOICE
14:33:53 1242  	   WHERE
14:33:53 1243  	     INVOICE.ID = in_invoice_id;
14:33:53 1244  	   EXCEPTION
14:33:53 1245  	     WHEN NO_DATA_FOUND THEN
14:33:53 1246  	       RAISE BAD_INVOICE_ID;
14:33:53 1247  	 END;
14:33:53 1248  
14:33:53 1249  	 IF var_invoice_status_id != GLOBAL_STATUSES_V22.INVOICE_CLOSED THEN
14:33:53 1250  	   RAISE INVOICE_IS_NOT_CLOSED;
14:33:53 1251  	 END IF;
14:33:53 1252  
14:33:53 1253  	 BEGIN
14:33:53 1254  	   PROCS_INVOICE_V22.CALCULATE_INVOICE_AMOUNT (
14:33:53 1255  	     in_invoice_id => in_invoice_id,
14:33:53 1256  	     out_amount    => var_invoice_amount
14:33:53 1257  	   );
14:33:53 1258  	   EXCEPTION
14:33:53 1259  	     WHEN OTHERS THEN
14:33:53 1260  	       EXCEPTION_MESSAGE := SQLERRM;
14:33:53 1261  	       RAISE CAN_NOT_CALC_INVOICE_AMOUNT;
14:33:53 1262  	 END;
14:33:53 1263  
14:33:53 1264  	 IF ( in_refund_amount > var_invoice_amount ) THEN
14:33:53 1265  	   RAISE REFUND_IS_GREATER_THAN_ANOUNT;
14:33:53 1266  	 END IF;
14:33:53 1267  
14:33:53 1268  	 SELECT /*+ STAR_TRANSFORMATION */
14:33:53 1269  	   SUM(CHARGE.CHARGE_AMOUNT) into var_refunds_before
14:33:53 1270  	 FROM
14:33:53 1271  	   CHARGE
14:33:53 1272  	 WHERE
14:33:53 1273  	   CHARGE.INVOICE_ID = in_invoice_id
14:33:53 1274  	   AND (
14:33:53 1275  	     CHARGE.CHARGE_STATUS_ID = GLOBAL_STATUSES_V22.CHARGE_OPENED
14:33:53 1276  	     OR CHARGE.CHARGE_STATUS_ID = GLOBAL_STATUSES_V22.CHARGE_PROCESSED
14:33:53 1277  	   )
14:33:53 1278  	   AND CHARGE.CHARGE_AMOUNT < 0;
14:33:53 1279  
14:33:53 1280  	 -- Refunds are negative
14:33:53 1281  	 var_refunds_before := -var_refunds_before;
14:33:53 1282  
14:33:53 1283  	 var_charges_amount := 0;
14:33:53 1284  
14:33:53 1285  	 FOR f_processed_charges IN (
14:33:53 1286  	   SELECT
14:33:53 1287  	     CHARGE.CHARGE_AMOUNT
14:33:53 1288  	   FROM
14:33:53 1289  	     CHARGE
14:33:53 1290  	   WHERE
14:33:53 1291  	     CHARGE.INVOICE_ID = in_invoice_id
14:33:53 1292  	     AND CHARGE.CHARGE_STATUS_ID IN (SELECT GLOBAL_STATUSES_V22.CHARGE_PROCESSED FROM DUAL)
14:33:53 1293  	 )
14:33:53 1294  	 LOOP
14:33:53 1295  	   IF f_processed_charges.CHARGE_AMOUNT > 0 THEN
14:33:53 1296  	     var_charges_amount := var_charges_amount + f_processed_charges.CHARGE_AMOUNT;
14:33:53 1297  	   END IF;
14:33:53 1298  	 END LOOP;
14:33:53 1299  
14:33:53 1300  	 IF (in_refund_amount + var_refunds_before > var_invoice_amount) THEN
14:33:53 1301  	   RAISE TOT_REF_IS_GREATER_THAN_ANOUNT;
14:33:53 1302  	 END IF;
14:33:53 1303  
14:33:53 1304  	 IF (in_refund_amount + var_refunds_before > var_charges_amount) THEN
14:33:53 1305  	   RAISE TOT_REF_IS_GRATER_THAN_CHARGES;
14:33:53 1306  	 END IF;
14:33:53 1307  
14:33:53 1308  	 BEGIN
14:33:53 1309  	   PROCS_TRANSACTION_V22.CREATE_TRANSACTION(
14:33:53 1310  	     in_transaction_id	       => NULL,
14:33:53 1311  	     in_status_id	       => GLOBAL_STATUSES_V22.TRANSACTION_PREPARE,
14:33:53 1312  	     in_amount		       => -in_refund_amount,
14:33:53 1313  	     in_created_by	       => in_created_by,
14:33:53 1314  	     in_order_id	       => NULL,
14:33:53 1315  	     in_is_refund	       => GLOBAL_CONSTANTS_V22.TRUE,
14:33:53 1316  	     in_transaction_type_code  => 'REFUND',
14:33:53 1317  	     out_transaction_id        => var_new_transaction_id
14:33:53 1318  	   );
14:33:53 1319  	   EXCEPTION
14:33:53 1320  	     WHEN OTHERS THEN
14:33:53 1321  	       EXCEPTION_MESSAGE := SQLERRM;
14:33:53 1322  	       RAISE CAN_NOT_CREATE_TRANSACTION;
14:33:53 1323  	 END;
14:33:53 1324  
14:33:53 1325  	 BEGIN
14:33:53 1326  	   PROCS_CHARGE_V22.CREATE_CHARGE(
14:33:53 1327  	     in_invoice_id	   => in_invoice_id,
14:33:53 1328  	     in_transaction_id	   => var_new_transaction_id,
14:33:53 1329  	     in_instrument_type_id => var_instrument_type_id,
14:33:53 1330  	     in_instrument_id	   => var_instrument_id,
14:33:53 1331  	     in_charge_amount	   => -in_refund_amount,
14:33:53 1332  	     in_created_by	   => in_created_by,
14:33:53 1333  	     in_charge_status_id   => GLOBAL_STATUSES_V22.CHARGE_OPENED,
14:33:53 1334  	     out_charge_id	   => var_new_charge_id
14:33:53 1335  	   );
14:33:53 1336  	   EXCEPTION
14:33:53 1337  	     WHEN OTHERS THEN
14:33:53 1338  	       EXCEPTION_MESSAGE := SQLERRM;
14:33:53 1339  	       RAISE CAN_NOT_CREATE_CHARGE;
14:33:53 1340  	 END;
14:33:53 1341  
14:33:53 1342  	 IF in_note IS NOT NULL THEN
14:33:53 1343  	   BEGIN
14:33:53 1344  	     PROCS_SUBSCRIPTION_V22.ANNOTATE_SUBSCRIPTION(
14:33:53 1345  	       in_subscription_id => in_subscription_id,
14:33:53 1346  	       in_agent_id	  => 0, -- AGENT_ID??
14:33:53 1347  	       in_note		  => in_note,
14:33:53 1348  	       in_created_by	  => in_created_by
14:33:53 1349  	     );
14:33:53 1350  	     EXCEPTION
14:33:53 1351  	       WHEN OTHERS THEN
14:33:53 1352  		 EXCEPTION_MESSAGE := SQLERRM;
14:33:53 1353  		 RAISE CAN_NOT_ANNOTATE_SUBSCRIPTION;
14:33:53 1354  	   END;
14:33:53 1355  	 END IF;
14:33:53 1356  
14:33:53 1357  	 out_charge_id := var_new_charge_id;
14:33:53 1358  
14:33:53 1359  EXCEPTION
14:33:53 1360  WHEN INVOICE_IS_NOT_CLOSED THEN
14:33:53 1361  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:53 1362  	   SPROC_NAME, 'Invoice is not closed');
14:33:53 1363  WHEN BAD_SUBSCRIPTION_ID THEN
14:33:53 1364  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1365  	   SPROC_NAME, 'No such subscription');
14:33:53 1366  WHEN ACCOUNT_IS_FROZEN THEN
14:33:53 1367  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:53 1368  	   SPROC_NAME, 'Could not refund subscription for frozen account');
14:33:53 1369  WHEN BAD_INVOICE_ID THEN
14:33:53 1370  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1371  	   SPROC_NAME, 'No such invoice');
14:33:53 1372  WHEN CAN_NOT_CALC_INVOICE_AMOUNT THEN
14:33:53 1373  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 1374  	   SPROC_NAME, 'Could not calculate invoice amount', EXCEPTION_MESSAGE);
14:33:53 1375  WHEN REFUND_IS_GREATER_THAN_ANOUNT THEN
14:33:53 1376  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:53 1377  	   SPROC_NAME, 'Refund is greater than amount');
14:33:53 1378  WHEN TOT_REF_IS_GREATER_THAN_ANOUNT THEN
14:33:53 1379  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:53 1380  	   SPROC_NAME, 'There were refunds before and sum of all refunds and new refund more than invoice amount');
14:33:53 1381  WHEN TOT_REF_IS_GRATER_THAN_CHARGES THEN
14:33:53 1382  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:53 1383  	   SPROC_NAME, 'Total refund amount is greater than sum of processed charges');
14:33:53 1384  WHEN CAN_NOT_CREATE_TRANSACTION THEN
14:33:53 1385  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 1386  	   SPROC_NAME, 'Could not create transaction', EXCEPTION_MESSAGE);
14:33:53 1387  WHEN CAN_NOT_CREATE_CHARGE THEN
14:33:53 1388  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 1389  	   SPROC_NAME, 'Could not create charge', EXCEPTION_MESSAGE);
14:33:53 1390  WHEN CAN_NOT_ANNOTATE_SUBSCRIPTION THEN
14:33:53 1391  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 1392  	   SPROC_NAME, 'Could not annotate subscription', EXCEPTION_MESSAGE);
14:33:53 1393  WHEN OTHERS THEN
14:33:53 1394  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1395  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1396  END REFUND_SUBSCRIPTION;
14:33:53 1397  
14:33:53 1398  /******************************************************************************/
14:33:53 1399  
14:33:53 1400  PROCEDURE ADD_SUBSCRIPTION_EXTENSION (
14:33:53 1401  /*
14:33:53 1402  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 1403  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:53 1404  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 1405  */
14:33:53 1406  	 in_subscription_id	 IN NUMBER,
14:33:53 1407  	 in_effective_start_date IN DATE,
14:33:53 1408  	 in_effective_end_date	 IN DATE,
14:33:53 1409  	 in_note		 IN VARCHAR2,
14:33:53 1410  	 in_updated_by		 IN VARCHAR2
14:33:53 1411  ) AS
14:33:53 1412  -- VARIABLES
14:33:53 1413  SPROC_NAME		    CONSTANT VARCHAR2(26) := 'ADD_SUBSCRIPTION_EXTENSION';
14:33:53 1414  temp_subscription_id	    NUMBER;
14:33:53 1415  var_current_license_id	    NUMBER;
14:33:53 1416  var_current_license_start_date DATE;
14:33:53 1417  var_current_license_end_date DATE;
14:33:53 1418  var_current_offer_id	    NUMBER;
14:33:53 1419  var_current_invoice_id	    NUMBER;
14:33:53 1420  var_current_date 	    DATE;
14:33:53 1421  var_current_offer_index	    NUMBER;
14:33:53 1422  var_current_offer_recurr_num NUMBER;
14:33:53 1423  var_account_tax_exempt_id    VARCHAR2(255);
14:33:53 1424  
14:33:53 1425  var_free_invoice_id NUMBER;
14:33:53 1426  var_free_license_id NUMBER;
14:33:53 1427  var_new_license_id  NUMBER;
14:33:53 1428  var_ext_license_id  NUMBER;
14:33:53 1429  -- EXCEPTIONS
14:33:53 1430  BAD_SUBSCRIPTION_ID	     EXCEPTION;
14:33:53 1431  CAN_NOT_FIND_OFFER_OR_LICENSE EXCEPTION;
14:33:53 1432  CAN_NOT_CHANGE_LICENSE_STATUS EXCEPTION;
14:33:53 1433  CAN_NOT_CREATE_INVOICE	     EXCEPTION;
14:33:53 1434  CAN_NOT_CREATE_NEW_LICENSE    EXCEPTION;
14:33:53 1435  CAN_NOT_CREATE_END_LICENSE    EXCEPTION;
14:33:53 1436  CAN_NOT_ANNOTATE_SUBSCRIPTION EXCEPTION;
14:33:53 1437  EXTENS_START_DATE_IS_TOO_FAR  EXCEPTION;
14:33:53 1438  EXT_START_DATE_LATER_THEN_END EXCEPTION;
14:33:53 1439  EXTENS_START_DATE_IS_TOO_SMALL EXCEPTION;
14:33:53 1440  EXCEPTION_MESSAGE	     VARCHAR2(1024);
14:33:53 1441  BEGIN
14:33:53 1442  
14:33:53 1443  	 var_current_date := PROCS_COMMON_V22.NORMALIZE_DATE(SYSDATE);
14:33:53 1444  
14:33:53 1445  	 -- Check that subscription exists
14:33:53 1446  	 BEGIN
14:33:53 1447  	   SELECT
14:33:53 1448  	     SUBSCRIPTION.ID into temp_subscription_id
14:33:53 1449  	   FROM
14:33:53 1450  	     SUBSCRIPTION
14:33:53 1451  	   WHERE
14:33:53 1452  	     SUBSCRIPTION.ID = in_subscription_id;
14:33:53 1453  	   EXCEPTION
14:33:53 1454  	     WHEN NO_DATA_FOUND THEN
14:33:53 1455  	       RAISE BAD_SUBSCRIPTION_ID;
14:33:53 1456  	 END;
14:33:53 1457  
14:33:53 1458  	 -- Get account tax exempt id
14:33:53 1459  	 SELECT DISTINCT
14:33:53 1460  	   ACCOUNT.TAX_EXEMPT_ID into var_account_tax_exempt_id
14:33:53 1461  	 FROM
14:33:53 1462  	   ACCOUNT
14:33:53 1463  	   INNER JOIN SUBSCRIPTION ON SUBSCRIPTION.ACCOUNT_ID = ACCOUNT.ID
14:33:53 1464  	 WHERE
14:33:53 1465  	   SUBSCRIPTION.ID = in_subscription_id;
14:33:53 1466  
14:33:53 1467  	 -- Select current data
14:33:53 1468  	 BEGIN
14:33:53 1469  	   SELECT
14:33:53 1470  	     LICENSE.ID,
14:33:53 1471  	     LICENSE.START_DATE,
14:33:53 1472  	     LICENSE.END_DATE,
14:33:53 1473  	     LICENSE.CURRENT_OFFER_INDEX,
14:33:53 1474  	     LICENSE.CURRENT_OFFER_RECURR_NUM,
14:33:53 1475  	     OFFER.ID,
14:33:53 1476  	     INVOICE.ID
14:33:53 1477  	   INTO
14:33:53 1478  	     var_current_license_id,
14:33:53 1479  	     var_current_license_start_date,
14:33:53 1480  	     var_current_license_end_date,
14:33:53 1481  	     var_current_offer_index,
14:33:53 1482  	     var_current_offer_recurr_num,
14:33:53 1483  	     var_current_offer_id,
14:33:53 1484  	     var_current_invoice_id
14:33:53 1485  	   FROM
14:33:53 1486  	     LICENSE
14:33:53 1487  	     INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
14:33:53 1488  	     INNER JOIN OFFER ON LICENSE.OFFER_ID = OFFER.ID
14:33:53 1489  	     INNER JOIN INVOICE ON LICENSE.INVOICE_ID = INVOICE.ID
14:33:53 1490  	   WHERE
14:33:53 1491  	     SUBSCRIPTION.ID = in_subscription_id
14:33:53 1492  	     AND PROCS_COMMON_V22.NORMALIZE_DATE(LICENSE.END_DATE) > var_current_date
14:33:53 1493  	     AND PROCS_COMMON_V22.NORMALIZE_DATE(LICENSE.START_DATE) <= var_current_date
14:33:53 1494  	     AND ROWNUM <= 1
14:33:53 1495  	   ORDER BY
14:33:53 1496  	     LICENSE.ID DESC;
14:33:53 1497  	   EXCEPTION
14:33:53 1498  	     WHEN NO_DATA_FOUND THEN
14:33:53 1499  	       RAISE CAN_NOT_FIND_OFFER_OR_LICENSE;
14:33:53 1500  	 END;
14:33:53 1501  
14:33:53 1502  	 IF var_current_license_end_date < in_effective_start_date THEN
14:33:53 1503  	   RAISE EXTENS_START_DATE_IS_TOO_FAR;
14:33:53 1504  	 END IF;
14:33:53 1505  
14:33:53 1506  	 IF var_current_license_start_date > in_effective_start_date THEN
14:33:53 1507  	   RAISE EXTENS_START_DATE_IS_TOO_SMALL;
14:33:53 1508  	 END IF;
14:33:53 1509  
14:33:53 1510  	 IF in_effective_start_date > in_effective_end_date THEN
14:33:53 1511  	   RAISE EXT_START_DATE_LATER_THEN_END;
14:33:53 1512  	 END IF;
14:33:53 1513  
14:33:53 1514  	 -- Closing curent license
14:33:53 1515  	 BEGIN
14:33:53 1516  	   PROCS_LICENSE_CRU_V22.UPDATE_LICENSE(
14:33:53 1517  	     in_license_id	   => var_current_license_id,
14:33:53 1518  	     in_updated_by	   => in_updated_by,
14:33:53 1519  	     in_license_status_id  => GLOBAL_STATUSES_V22.LICENSE_CLOSED,
14:33:53 1520  	     in_end_date	   => in_effective_start_date,
14:33:53 1521  	     in_needs_entitlements => GLOBAL_CONSTANTS_V22.TRUE
14:33:53 1522  	   );
14:33:53 1523  	   EXCEPTION
14:33:53 1524  	     WHEN OTHERS THEN
14:33:53 1525  	       EXCEPTION_MESSAGE := SQLERRM;
14:33:53 1526  	       RAISE CAN_NOT_CHANGE_LICENSE_STATUS;
14:33:53 1527  	 END;
14:33:53 1528  
14:33:53 1529  	 -- Creating new "free" invoice
14:33:53 1530  	 BEGIN
14:33:53 1531  	   PROCS_INVOICE_V22.CREATE_INVOICE(
14:33:53 1532  	     in_invoice_status => GLOBAL_STATUSES_V22.INVOICE_CLOSED,
14:33:53 1533  	     in_created_by     => in_updated_by,
14:33:53 1534  	     in_tax_exempt_id  => var_account_tax_exempt_id,
14:33:53 1535  	     out_invoice_id    => var_free_invoice_id
14:33:53 1536  	   );
14:33:53 1537  	   EXCEPTION
14:33:53 1538  	     WHEN OTHERS THEN
14:33:53 1539  	       EXCEPTION_MESSAGE := SQLERRM;
14:33:53 1540  	       RAISE CAN_NOT_CREATE_INVOICE;
14:33:53 1541  	 END;
14:33:53 1542  
14:33:53 1543  	 -- Creating new "free" license
14:33:53 1544  	 BEGIN
14:33:53 1545  	   PROCS_LICENSE_V22.CREATE_LICENSE (
14:33:53 1546  	     in_status_id		 => GLOBAL_STATUSES_V22.LICENSE_ACTIVE,
14:33:53 1547  	     in_needs_entitlements	 => GLOBAL_CONSTANTS_V22.TRUE,
14:33:53 1548  	     in_start_date		 => in_effective_start_date,
14:33:53 1549  	     in_end_date		 => in_effective_end_date,
14:33:53 1550  	     in_offer_id		 => var_current_offer_id,
14:33:53 1551  	     in_subscription_id 	 => in_subscription_id,
14:33:53 1552  	     in_invoice_id		 => var_free_invoice_id,
14:33:53 1553  	     in_created_by		 => in_updated_by,
14:33:53 1554  	     in_is_extension		 => GLOBAL_CONSTANTS_V22.TRUE,
14:33:53 1555  	     in_current_offer_index	 => var_current_offer_index,
14:33:53 1556  	     in_current_offer_recurr_num => var_current_offer_recurr_num,
14:33:53 1557  	     out_license_id		 => var_free_license_id
14:33:53 1558  	   );
14:33:53 1559  	   EXCEPTION
14:33:53 1560  	     WHEN OTHERS THEN
14:33:53 1561  	       EXCEPTION_MESSAGE := SQLERRM;
14:33:53 1562  	       RAISE CAN_NOT_CREATE_NEW_LICENSE;
14:33:53 1563  	 END;
14:33:53 1564  
14:33:53 1565  	 -- Creating new license
14:33:53 1566  	 IF PROCS_COMMON_V22.NORMALIZE_DATE(var_current_license_end_date) >
14:33:53 1567  	    PROCS_COMMON_V22.NORMALIZE_DATE(in_effective_start_date) THEN
14:33:53 1568  	   BEGIN
14:33:53 1569  	     PROCS_LICENSE_V22.CREATE_LICENSE (
14:33:53 1570  	       in_status_id		   => GLOBAL_STATUSES_V22.LICENSE_ACTIVE,
14:33:53 1571  	       in_needs_entitlements	   => GLOBAL_CONSTANTS_V22.TRUE,
14:33:53 1572  	       in_start_date		   => in_effective_end_date,
14:33:53 1573  	       in_end_date		   => var_current_license_end_date + (in_effective_end_date - in_effective_start_date),
14:33:53 1574  	       in_offer_id		   => var_current_offer_id,
14:33:53 1575  	       in_subscription_id	   => in_subscription_id,
14:33:53 1576  	       in_invoice_id		   => var_current_invoice_id,
14:33:53 1577  	       in_created_by		   => in_updated_by,
14:33:53 1578  	       in_is_extension		   => GLOBAL_CONSTANTS_V22.FALSE,
14:33:53 1579  	       in_current_offer_index	   => var_current_offer_index,
14:33:53 1580  	       in_current_offer_recurr_num => var_current_offer_recurr_num,
14:33:53 1581  	       out_license_id		   => var_ext_license_id
14:33:53 1582  	     );
14:33:53 1583  	     EXCEPTION
14:33:53 1584  	       WHEN OTHERS THEN
14:33:53 1585  		 EXCEPTION_MESSAGE := SQLERRM;
14:33:53 1586  		 RAISE CAN_NOT_CREATE_END_LICENSE;
14:33:53 1587  	   END;
14:33:53 1588  	 END IF;
14:33:53 1589  
14:33:53 1590  	 -- Create new note for subscription
14:33:53 1591  	 BEGIN
14:33:53 1592  	   PROCS_SUBSCRIPTION_V22.ANNOTATE_SUBSCRIPTION (
14:33:53 1593  	     in_subscription_id => in_subscription_id,
14:33:53 1594  	     in_agent_id	=> 0, -- FIXME: What should to be here (agent id)?
14:33:53 1595  	     in_note		=> in_note,
14:33:53 1596  	     in_created_by	=> in_updated_by
14:33:53 1597  	   );
14:33:53 1598  	   EXCEPTION
14:33:53 1599  	     WHEN OTHERS THEN
14:33:53 1600  	       EXCEPTION_MESSAGE := SQLERRM;
14:33:53 1601  	       RAISE CAN_NOT_ANNOTATE_SUBSCRIPTION;
14:33:53 1602  	 END;
14:33:53 1603  
14:33:53 1604  EXCEPTION
14:33:53 1605  WHEN EXT_START_DATE_LATER_THEN_END THEN
14:33:53 1606  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:53 1607  	   SPROC_NAME, 'Extension start date is bigger then end date');
14:33:53 1608  WHEN EXTENS_START_DATE_IS_TOO_FAR THEN
14:33:53 1609  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:53 1610  	   SPROC_NAME, 'Extension start date is too far');
14:33:53 1611  WHEN EXTENS_START_DATE_IS_TOO_SMALL THEN
14:33:53 1612  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:53 1613  	   SPROC_NAME, 'Extension start date is too small');
14:33:53 1614  WHEN BAD_SUBSCRIPTION_ID THEN
14:33:53 1615  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1616  	   SPROC_NAME, 'No such subscription');
14:33:53 1617  WHEN CAN_NOT_FIND_OFFER_OR_LICENSE THEN
14:33:53 1618  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1619  	   SPROC_NAME, 'Could not find license and/or offer for given subscription');
14:33:53 1620  WHEN CAN_NOT_CHANGE_LICENSE_STATUS THEN
14:33:53 1621  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 1622  	   SPROC_NAME, 'Could not change license status', EXCEPTION_MESSAGE);
14:33:53 1623  WHEN CAN_NOT_CREATE_INVOICE THEN
14:33:53 1624  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 1625  	   SPROC_NAME, 'Could not create new invoice', EXCEPTION_MESSAGE);
14:33:53 1626  WHEN CAN_NOT_CREATE_NEW_LICENSE THEN
14:33:53 1627  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 1628  	   SPROC_NAME, 'Could not create new license', EXCEPTION_MESSAGE);
14:33:53 1629  WHEN CAN_NOT_CREATE_END_LICENSE THEN
14:33:53 1630  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 1631  	   SPROC_NAME, 'Could not create last license', EXCEPTION_MESSAGE);
14:33:53 1632  WHEN CAN_NOT_ANNOTATE_SUBSCRIPTION THEN
14:33:53 1633  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 1634  	   SPROC_NAME, 'Could not create new note for subscription', EXCEPTION_MESSAGE);
14:33:53 1635  WHEN OTHERS THEN
14:33:53 1636  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1637  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1638  END ADD_SUBSCRIPTION_EXTENSION;
14:33:53 1639  
14:33:53 1640  /******************************************************************************/
14:33:53 1641  
14:33:53 1642  FUNCTION CALC_SUBSCRIPTION_END_DATE (
14:33:53 1643  /*
14:33:53 1644  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 1645  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:53 1646  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 1647  Returns:
14:33:53 1648  NULL if it is impossible to calculate end date (for example,
14:33:53 1649  	 offer chain includes offer with infinity recurrences number)
14:33:53 1650  DATE else
14:33:53 1651  */
14:33:53 1652  	 in_subscription_id IN NUMBER
14:33:53 1653  ) RETURN DATE AS
14:33:53 1654  -- VARIABLES
14:33:53 1655  SPROC_NAME		     CONSTANT VARCHAR2(26) := 'CALC_SUBSCRIPTION_END_DATE';
14:33:53 1656  last_license_id		     NUMBER;
14:33:53 1657  last_license_end_date	     DATE;
14:33:53 1658  last_license_offer_id	     NUMBER;
14:33:53 1659  last_license_offer_index      NUMBER;
14:33:53 1660  last_license_offer_recurr_num NUMBER;
14:33:53 1661  var_last_license_id	     NUMBER;
14:33:53 1662  var_offer_chain_id	     NUMBER;
14:33:53 1663  var_current_offer_rec_number  NUMBER;
14:33:53 1664  var_next_offers_set	     SYS_REFCURSOR;
14:33:53 1665  var_next_offer_duration	     VARCHAR2(30);
14:33:53 1666  var_next_offer_recur	     NUMBER;
14:33:53 1667  var_infinity_offers_number    NUMBER;
14:33:53 1668  
14:33:53 1669  var_result_date DATE;
14:33:53 1670  
14:33:53 1671  var_ym_interval	INTERVAL YEAR TO MONTH;
14:33:53 1672  var_ds_interval	INTERVAL DAY(3) TO SECOND;
14:33:53 1673  var_offer_years	NUMBER;
14:33:53 1674  var_offer_months NUMBER;
14:33:53 1675  var_offer_days	NUMBER;
14:33:53 1676  
14:33:53 1677  -- EXCEPTIONS
14:33:53 1678  BAD_SUBSCRIPTION_ID	  EXCEPTION;
14:33:53 1679  CAN_NOT_FIND_LAST_LICENSE  EXCEPTION;
14:33:53 1680  CAN_NOT_CALC_OFFER_LENGTH  EXCEPTION;
14:33:53 1681  CAN_NOT_CALC_OFFER_LENGTH2 EXCEPTION;
14:33:53 1682  EXCEPTION_MESSAGE	  VARCHAR2(1024);
14:33:53 1683  BEGIN
14:33:53 1684  
14:33:53 1685  	 BEGIN
14:33:53 1686  	   SELECT
14:33:53 1687  	     SUBSCRIPTION.OFFER_CHAIN_ID into var_offer_chain_id
14:33:53 1688  	   FROM
14:33:53 1689  	     SUBSCRIPTION
14:33:53 1690  	   WHERE
14:33:53 1691  	     SUBSCRIPTION.ID = in_subscription_id;
14:33:53 1692  	   EXCEPTION
14:33:53 1693  	     WHEN NO_DATA_FOUND THEN
14:33:53 1694  	       RAISE BAD_SUBSCRIPTION_ID;
14:33:53 1695  	 END;
14:33:53 1696  
14:33:53 1697  	 BEGIN
14:33:53 1698  	   SELECT
14:33:53 1699  	     ID into var_last_license_id
14:33:53 1700  	   FROM
14:33:53 1701  	     (
14:33:53 1702  	       SELECT
14:33:53 1703  		 LICENSE.ID
14:33:53 1704  	       FROM
14:33:53 1705  		 LICENSE
14:33:53 1706  	       WHERE
14:33:53 1707  		 LICENSE.SUBSCRIPTION_ID = in_subscription_id
14:33:53 1708  	       ORDER BY
14:33:53 1709  		 LICENSE.END_DATE DESC
14:33:53 1710  	     )
14:33:53 1711  	   WHERE
14:33:53 1712  	     ROWNUM <= 1;
14:33:53 1713  	   EXCEPTION
14:33:53 1714  	     WHEN NO_DATA_FOUND THEN
14:33:53 1715  	       RAISE CAN_NOT_FIND_LAST_LICENSE;
14:33:53 1716  	 END;
14:33:53 1717  
14:33:53 1718  	 SELECT
14:33:53 1719  	   COUNT(*) into var_infinity_offers_number
14:33:53 1720  	 FROM
14:33:53 1721  	   OFFER_OFFER_CHAIN
14:33:53 1722  	 WHERE
14:33:53 1723  	   OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = var_offer_chain_id
14:33:53 1724  	   AND OFFER_OFFER_CHAIN.NUM_RECURRENCES = GLOBAL_ENUMS_V22.OFFER_REC_INFINITY;
14:33:53 1725  
14:33:53 1726  	 IF var_infinity_offers_number > 0 THEN
14:33:53 1727  	   RETURN NULL;
14:33:53 1728  	 END IF;
14:33:53 1729  
14:33:53 1730  	 BEGIN
14:33:53 1731  	   SELECT
14:33:53 1732  	     LICENSE.ID,
14:33:53 1733  	     LICENSE.END_DATE,
14:33:53 1734  	     LICENSE.CURRENT_OFFER_INDEX,
14:33:53 1735  	     LICENSE.CURRENT_OFFER_RECURR_NUM,
14:33:53 1736  	     LICENSE.OFFER_ID
14:33:53 1737  	     into
14:33:53 1738  	     last_license_id,
14:33:53 1739  	     last_license_end_date,
14:33:53 1740  	     last_license_offer_index,
14:33:53 1741  	     last_license_offer_recurr_num,
14:33:53 1742  	     last_license_offer_id
14:33:53 1743  	   FROM
14:33:53 1744  	     LICENSE
14:33:53 1745  	   WHERE
14:33:53 1746  	     LICENSE.ID = var_last_license_id;
14:33:53 1747  	   EXCEPTION
14:33:53 1748  	     WHEN NO_DATA_FOUND THEN
14:33:53 1749  	       RAISE CAN_NOT_FIND_LAST_LICENSE;
14:33:53 1750  	 END;
14:33:53 1751  
14:33:53 1752  	 var_result_date := last_license_end_date;
14:33:53 1753  
14:33:53 1754  	 -- Find current recurrence number
14:33:53 1755  	 SELECT
14:33:53 1756  	   OFFER_OFFER_CHAIN.NUM_RECURRENCES into var_current_offer_rec_number
14:33:53 1757  	 FROM
14:33:53 1758  	   OFFER_OFFER_CHAIN
14:33:53 1759  	 WHERE
14:33:53 1760  	   OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = var_offer_chain_id
14:33:53 1761  	   AND OFFER_OFFER_CHAIN.OFFER_ID = last_license_offer_id
14:33:53 1762  	   AND OFFER_OFFER_CHAIN.INDEX_VALUE = last_license_offer_index;
14:33:53 1763  
14:33:53 1764  	 IF var_current_offer_rec_number > last_license_offer_recurr_num THEN
14:33:53 1765  	   BEGIN
14:33:53 1766  	     PROCS_OFFER_CHAIN_V22.GET_OFFER_LENGTH(
14:33:53 1767  	       last_license_offer_id,
14:33:53 1768  	       var_offer_years,
14:33:53 1769  	       var_offer_months,
14:33:53 1770  	       var_offer_days
14:33:53 1771  	     );
14:33:53 1772  
14:33:53 1773  	     var_ym_interval := var_offer_years||'-'||var_offer_months;
14:33:53 1774  	     var_ds_interval := var_offer_days||' 0:0:0';
14:33:53 1775  
14:33:53 1776  	     var_result_date := var_result_date
14:33:53 1777  	       + ( var_ym_interval * ( var_current_offer_rec_number - last_license_offer_recurr_num ) )
14:33:53 1778  	       + ( var_ds_interval * ( var_current_offer_rec_number - last_license_offer_recurr_num ) );
14:33:53 1779  	     EXCEPTION
14:33:53 1780  	       WHEN OTHERS THEN
14:33:53 1781  		 EXCEPTION_MESSAGE := SQLERRM;
14:33:53 1782  		 RAISE CAN_NOT_CALC_OFFER_LENGTH;
14:33:53 1783  	   END;
14:33:53 1784  	 END IF;
14:33:53 1785  
14:33:53 1786  	 OPEN var_next_offers_set FOR
14:33:53 1787  	 SELECT
14:33:53 1788  	   OFFER.ENTITLEMENT_DURATION,
14:33:53 1789  	   OFFER_OFFER_CHAIN.NUM_RECURRENCES
14:33:53 1790  	 FROM
14:33:53 1791  	   OFFER_OFFER_CHAIN
14:33:53 1792  	   INNER JOIN OFFER ON OFFER_OFFER_CHAIN.OFFER_ID = OFFER.ID
14:33:53 1793  	 WHERE
14:33:53 1794  	   OFFER_OFFER_CHAIN.INDEX_VALUE > last_license_offer_index
14:33:53 1795  	   AND OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = var_offer_chain_id;
14:33:53 1796  
14:33:53 1797  	 LOOP
14:33:53 1798  	   FETCH var_next_offers_set into var_next_offer_duration, var_next_offer_recur;
14:33:53 1799  	   EXIT WHEN var_next_offers_set%NOTFOUND;
14:33:53 1800  	   BEGIN
14:33:53 1801  	     PROCS_COMMON_V22.ISO8601DURATION_TO_INTERVALS(
14:33:53 1802  	       var_next_offer_duration,
14:33:53 1803  	       var_offer_years,
14:33:53 1804  	       var_offer_months,
14:33:53 1805  	       var_offer_days
14:33:53 1806  	     );
14:33:53 1807  
14:33:53 1808  	     var_ym_interval := var_offer_years||'-'||var_offer_months;
14:33:53 1809  	     var_ds_interval := var_offer_days||' 0:0:0';
14:33:53 1810  
14:33:53 1811  	     var_result_date := var_result_date
14:33:53 1812  	       + ( var_ym_interval * var_next_offer_recur )
14:33:53 1813  	       + ( var_ds_interval * var_next_offer_recur );
14:33:53 1814  	     EXCEPTION
14:33:53 1815  	       WHEN OTHERS THEN
14:33:53 1816  		 EXCEPTION_MESSAGE := SQLERRM;
14:33:53 1817  		 RAISE CAN_NOT_CALC_OFFER_LENGTH2;
14:33:53 1818  	   END;
14:33:53 1819  	 END LOOP;
14:33:53 1820  
14:33:53 1821  	 RETURN var_result_date;
14:33:53 1822  
14:33:53 1823  EXCEPTION
14:33:53 1824  WHEN BAD_SUBSCRIPTION_ID THEN
14:33:53 1825  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1826  	   SPROC_NAME, 'No such subscription');
14:33:53 1827  WHEN CAN_NOT_FIND_LAST_LICENSE THEN
14:33:53 1828  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1829  	   SPROC_NAME, 'Could not find last license for given subscription');
14:33:53 1830  WHEN CAN_NOT_CALC_OFFER_LENGTH THEN
14:33:53 1831  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 1832  	   SPROC_NAME, 'Could not calculate offer length', EXCEPTION_MESSAGE);
14:33:53 1833  WHEN CAN_NOT_CALC_OFFER_LENGTH2 THEN
14:33:53 1834  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 1835  	   SPROC_NAME, 'Could not calculate last offer length', EXCEPTION_MESSAGE);
14:33:53 1836  WHEN OTHERS THEN
14:33:53 1837  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1838  	   SPROC_NAME, 'Unkown error', SQLERRM);
14:33:53 1839  END CALC_SUBSCRIPTION_END_DATE;
14:33:53 1840  
14:33:53 1841  /******************************************************************************/
14:33:53 1842  
14:33:53 1843  PROCEDURE HAS_FUTURE_LICENSE (
14:33:53 1844  /*
14:33:53 1845  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 1846  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 1847  --
14:33:53 1848  RETURNS:
14:33:53 1849  GLOBAL_CONSTANTS_V22.TRUE - if has,
14:33:53 1850  GLOBAL_CONSTANTS_V22.FALSE - else
14:33:53 1851  */
14:33:53 1852  	 in_license_id IN  NUMBER,
14:33:53 1853  	 out_result    OUT NUMBER
14:33:53 1854  ) AS
14:33:53 1855  -- VARIABLES
14:33:53 1856  SPROC_NAME		 CONSTANT VARCHAR2(18) := 'HAS_FUTURE_LICENSE';
14:33:53 1857  var_subscription_id	 NUMBER;
14:33:53 1858  var_future_licenses_count NUMBER;
14:33:53 1859  -- EXCEPTIONS
14:33:53 1860  BAD_LICENSE_ID	    EXCEPTION;
14:33:53 1861  BEGIN
14:33:53 1862  
14:33:53 1863  	 BEGIN
14:33:53 1864  	   SELECT
14:33:53 1865  	     LICENSE.SUBSCRIPTION_ID into var_subscription_id
14:33:53 1866  	   FROM
14:33:53 1867  	     LICENSE
14:33:53 1868  	   WHERE
14:33:53 1869  	     LICENSE.ID = in_license_id;
14:33:53 1870  	   EXCEPTION
14:33:53 1871  	     WHEN NO_DATA_FOUND THEN
14:33:53 1872  	       RAISE BAD_LICENSE_ID;
14:33:53 1873  	 END;
14:33:53 1874  
14:33:53 1875  	 SELECT
14:33:53 1876  	   COUNT(*) into var_future_licenses_count
14:33:53 1877  	 FROM
14:33:53 1878  	   LICENSE
14:33:53 1879  	 WHERE
14:33:53 1880  	   LICENSE.ID != in_license_id
14:33:53 1881  	   AND LICENSE.SUBSCRIPTION_ID = var_subscription_id
14:33:53 1882  	   AND LICENSE.END_DATE > sysdate;
14:33:53 1883  
14:33:53 1884  	 IF var_future_licenses_count > 0 THEN
14:33:53 1885  	   out_result := GLOBAL_CONSTANTS_V22.TRUE;
14:33:53 1886  	 ELSE
14:33:53 1887  	   out_result := GLOBAL_CONSTANTS_V22.FALSE;
14:33:53 1888  	 END IF;
14:33:53 1889  
14:33:53 1890  EXCEPTION
14:33:53 1891  WHEN BAD_LICENSE_ID THEN
14:33:53 1892  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1893  	   SPROC_NAME, 'No such license');
14:33:53 1894  WHEN OTHERS THEN
14:33:53 1895  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1896  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1897  END HAS_FUTURE_LICENSE;
14:33:53 1898  
14:33:53 1899  /******************************************************************************/
14:33:53 1900  
14:33:53 1901  PROCEDURE CLOSE_SUBSCRIPTION (
14:33:53 1902  	 in_subscription_id IN NUMBER,
14:33:53 1903  	 in_updated_by	    IN VARCHAR2
14:33:53 1904  ) AS
14:33:53 1905  -- VARIABLES
14:33:53 1906  SPROC_NAME	    CONSTANT VARCHAR2(18) := 'CLOSE_SUBSCRIPTION';
14:33:53 1907  temp_subscription_id NUMBER;
14:33:53 1908  var_licenses_count   NUMBER;
14:33:53 1909  -- EXCEPTIONS
14:33:53 1910  BAD_SUBSCRIPTION_ID    EXCEPTION;
14:33:53 1911  ACTIVE_LICENSES_FOUND  EXCEPTION;
14:33:53 1912  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:53 1913  BEGIN
14:33:53 1914  
14:33:53 1915  	 BEGIN
14:33:53 1916  	   SELECT
14:33:53 1917  	     SUBSCRIPTION.ID into temp_subscription_id
14:33:53 1918  	   FROM
14:33:53 1919  	     SUBSCRIPTION
14:33:53 1920  	   WHERE
14:33:53 1921  	     SUBSCRIPTION.ID = in_subscription_id;
14:33:53 1922  	   EXCEPTION
14:33:53 1923  	     WHEN NO_DATA_FOUND THEN
14:33:53 1924  	       RAISE BAD_SUBSCRIPTION_ID;
14:33:53 1925  	 END;
14:33:53 1926  
14:33:53 1927  	 SELECT
14:33:53 1928  	   COUNT(*) into var_licenses_count
14:33:53 1929  	 FROM
14:33:53 1930  	   LICENSE
14:33:53 1931  	 WHERE
14:33:53 1932  	   LICENSE.SUBSCRIPTION_ID = in_subscription_id
14:33:53 1933  	   AND LICENSE.LICENSE_STATUS_ID = GLOBAL_STATUSES_V22.LICENSE_ACTIVE;
14:33:53 1934  
14:33:53 1935  	 IF var_licenses_count > 0 THEN
14:33:53 1936  	   RAISE ACTIVE_LICENSES_FOUND;
14:33:53 1937  	 END IF;
14:33:53 1938  
14:33:53 1939  	 PROCS_SUBSCRIPTION_V22.UPDATE_SUBSCRIPTION_STATUS(
14:33:53 1940  	   in_subscription_id	     => in_subscription_id,
14:33:53 1941  	   in_updated_by	     => in_updated_by,
14:33:53 1942  	   in_subscription_status_id => GLOBAL_STATUSES_V22.SUBSCRIPTION_CLOSED
14:33:53 1943  	 );
14:33:53 1944  
14:33:53 1945  EXCEPTION
14:33:53 1946  WHEN BAD_SUBSCRIPTION_ID THEN
14:33:53 1947  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1948  	   SPROC_NAME, 'No such subscription');
14:33:53 1949  WHEN ACTIVE_LICENSES_FOUND THEN
14:33:53 1950  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:53 1951  	   SPROC_NAME, 'Active licenses found');
14:33:53 1952  WHEN OTHERS THEN
14:33:53 1953  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1954  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1955  END CLOSE_SUBSCRIPTION;
14:33:53 1956  
14:33:53 1957  /******************************************************************************/
14:33:53 1958  
14:33:53 1959  PROCEDURE GET_GROUP_ID_BY_SBSCRPTN_ID (
14:33:53 1960  	 in_subscription_id IN NUMBER,
14:33:53 1961  	 out_group_id	    OUT NUMBER
14:33:53 1962  ) AS
14:33:53 1963  SPROC_NAME CONSTANT VARCHAR2(27) := 'GET_GROUP_ID_BY_SBSCRPTN_ID';
14:33:53 1964  BEGIN
14:33:53 1965  	 SELECT
14:33:53 1966  	   ACCOUNT.GROUP_ID into out_group_id
14:33:53 1967  	 FROM
14:33:53 1968  	   SUBSCRIPTION
14:33:53 1969  	   INNER JOIN ACCOUNT ON SUBSCRIPTION.ACCOUNT_ID = ACCOUNT.ID
14:33:53 1970  	 WHERE
14:33:53 1971  	   SUBSCRIPTION.ID = in_subscription_id;
14:33:53 1972  EXCEPTION
14:33:53 1973  WHEN NO_DATA_FOUND THEN
14:33:53 1974  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 1975  	   SPROC_NAME, 'No such subscription');
14:33:53 1976  WHEN OTHERS THEN
14:33:53 1977  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 1978  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 1979  END GET_GROUP_ID_BY_SBSCRPTN_ID;
14:33:53 1980  
14:33:53 1981  /******************************************************************************/
14:33:53 1982  
14:33:53 1983  PROCEDURE GET_SUBSCRIPTION_PRODUCTS (
14:33:53 1984  /*
14:33:53 1985  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 1986  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 1987  */
14:33:53 1988  	 in_subscription_id IN NUMBER,
14:33:53 1989  	 out_result_set     OUT SYS_REFCURSOR
14:33:53 1990  ) AS
14:33:53 1991  SPROC_NAME CONSTANT VARCHAR2(25) := 'GET_SUBSCRIPTION_PRODUCTS';
14:33:53 1992  -- VARIABLES
14:33:53 1993  var_offer_chain NUMBER;
14:33:53 1994  -- EXCEPTIONS
14:33:53 1995  BAD_SUBSCRIPTION_ID EXCEPTION;
14:33:53 1996  BEGIN
14:33:53 1997  	 BEGIN
14:33:53 1998  	   SELECT
14:33:53 1999  	     SUBSCRIPTION.OFFER_CHAIN_ID into var_offer_chain
14:33:53 2000  	   FROM
14:33:53 2001  	     SUBSCRIPTION
14:33:53 2002  	   WHERE
14:33:53 2003  	     SUBSCRIPTION.ID = in_subscription_id;
14:33:53 2004  	   EXCEPTION
14:33:53 2005  	     WHEN NO_DATA_FOUND THEN
14:33:53 2006  	       RAISE BAD_SUBSCRIPTION_ID;
14:33:53 2007  	 END;
14:33:53 2008  
14:33:53 2009  	 OPEN out_result_set FOR
14:33:53 2010  	 SELECT DISTINCT
14:33:53 2011  	   PRODUCT.ID,
14:33:53 2012  	   PRODUCT.NAME
14:33:53 2013  	 FROM
14:33:53 2014  	   PRODUCT
14:33:53 2015  	 WHERE
14:33:53 2016  	   PRODUCT.ID IN (
14:33:53 2017  	     SELECT DISTINCT
14:33:53 2018  	       PRODUCT_OFFERING.PRODUCT_ID
14:33:53 2019  	     FROM
14:33:53 2020  	       PRODUCT_OFFERING
14:33:53 2021  	     WHERE
14:33:53 2022  	       PRODUCT_OFFERING.ID IN (
14:33:53 2023  		 SELECT DISTINCT
14:33:53 2024  		   OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID
14:33:53 2025  		 FROM
14:33:53 2026  		   OFFER_PRODUCT_OFFERING
14:33:53 2027  		 WHERE
14:33:53 2028  		   OFFER_PRODUCT_OFFERING.OFFER_ID IN (
14:33:53 2029  		     SELECT DISTINCT
14:33:53 2030  		       OFFER_OFFER_CHAIN.OFFER_ID
14:33:53 2031  		     FROM
14:33:53 2032  		       OFFER_OFFER_CHAIN
14:33:53 2033  		     WHERE
14:33:53 2034  		       OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = var_offer_chain
14:33:53 2035  		   )
14:33:53 2036  	       )
14:33:53 2037  	   );
14:33:53 2038  
14:33:53 2039  EXCEPTION
14:33:53 2040  WHEN BAD_SUBSCRIPTION_ID THEN
14:33:53 2041  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 2042  	   SPROC_NAME, 'No such subscription');
14:33:53 2043  WHEN OTHERS THEN
14:33:53 2044  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 2045  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 2046  END GET_SUBSCRIPTION_PRODUCTS;
14:33:53 2047  
14:33:53 2048  /******************************************************************************/
14:33:53 2049  
14:33:53 2050  PROCEDURE UPDATE_SUBSCRIPTION_STATUS (
14:33:53 2051  	 in_subscription_id	   IN SUBSCRIPTION.ID%TYPE,
14:33:53 2052  	 in_subscription_status_id IN SUBSCRIPTION.SUBSCRIPTION_STATUS_ID%TYPE,
14:33:53 2053  	 in_updated_by		   IN SUBSCRIPTION.UPDATED_BY%TYPE
14:33:53 2054  ) AS
14:33:53 2055  SPROC_NAME CONSTANT VARCHAR2(26) := 'UPDATE_SUBSCRIPTION_STATUS';
14:33:53 2056  BEGIN
14:33:53 2057  	 PROCS_SUBSCRIPTION_CRU_V22.UPDATE_SUBSCRIPTION(
14:33:53 2058  	   in_subscription_id	     => in_subscription_id,
14:33:53 2059  	   in_subscription_status_id => in_subscription_status_id,
14:33:53 2060  	   in_updated_by	     => in_updated_by
14:33:53 2061  	 );
14:33:53 2062  END UPDATE_SUBSCRIPTION_STATUS;
14:33:53 2063  
14:33:53 2064  /******************************************************************************/
14:33:53 2065  
14:33:53 2066  PROCEDURE GET_ACTIVE_INVOICES_IDS (
14:33:53 2067  /*
14:33:53 2068  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 2069  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 2070  */
14:33:53 2071  --  in_subscription_id IN SUBSCRIPTION.ID%TYPE,
14:33:53 2072  	 in_subscription_id IN NUMBER,
14:33:53 2073  	 out_result_set     OUT SYS_REFCURSOR
14:33:53 2074  ) AS
14:33:53 2075  SPROC_NAME CONSTANT VARCHAR2(23) := 'GET_ACTIVE_INVOICES_IDS';
14:33:53 2076  -- VARIABLES
14:33:53 2077  temp_subscription_id SUBSCRIPTION.ID%TYPE;
14:33:53 2078  -- EXCEPTIONS
14:33:53 2079  BAD_SUBSCRIPTION_ID EXCEPTION;
14:33:53 2080  BEGIN
14:33:53 2081  
14:33:53 2082  	 BEGIN
14:33:53 2083  	   SELECT
14:33:53 2084  	     SUBSCRIPTION.ID into temp_subscription_id
14:33:53 2085  	   FROM
14:33:53 2086  	     SUBSCRIPTION
14:33:53 2087  	   WHERE
14:33:53 2088  	     SUBSCRIPTION.ID = in_subscription_id;
14:33:53 2089  	   EXCEPTION
14:33:53 2090  	     WHEN NO_DATA_FOUND THEN
14:33:53 2091  	       RAISE BAD_SUBSCRIPTION_ID;
14:33:53 2092  	 END;
14:33:53 2093  
14:33:53 2094  	 OPEN out_result_set FOR
14:33:53 2095  	 SELECT DISTINCT
14:33:53 2096  	   LICENSE.INVOICE_ID as "ID"
14:33:53 2097  	 FROM
14:33:53 2098  	   LICENSE
14:33:53 2099  	 WHERE
14:33:53 2100  	   LICENSE.LICENSE_STATUS_ID in (GLOBAL_STATUSES_V22.LICENSE_ACTIVE, GLOBAL_STATUSES_V22.LICENSE_IN_GRACE_PERIOD)
14:33:53 2101  	   AND LICENSE.SUBSCRIPTION_ID = in_subscription_id;
14:33:53 2102  
14:33:53 2103  EXCEPTION
14:33:53 2104  WHEN BAD_SUBSCRIPTION_ID THEN
14:33:53 2105  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 2106  	   SPROC_NAME, 'No such subscription');
14:33:53 2107  WHEN OTHERS THEN
14:33:53 2108  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 2109  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 2110  END GET_ACTIVE_INVOICES_IDS;
14:33:53 2111  
14:33:53 2112  /******************************************************************************/
14:33:53 2113  
14:33:53 2114  PROCEDURE CANCEL_SUBSCRIPTION_INVOICE (
14:33:53 2115  /*
14:33:53 2116  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 2117  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 2118  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:53 2119  */
14:33:53 2120  	 in_invoice_id	      IN NUMBER,
14:33:53 2121  	 in_updated_by	      IN VARCHAR2,
14:33:53 2122  	 in_refundable	      IN NUMBER DEFAULT GLOBAL_CONSTANTS_V22.FALSE
14:33:53 2123  ) AS
14:33:53 2124  SPROC_NAME CONSTANT VARCHAR2(27) := 'CANCEL_SUBSCRIPTION_INVOICE';
14:33:53 2125  -- VARIABLES
14:33:53 2126  temp_invoice_id	      INVOICE.ID%TYPE;
14:33:53 2127  var_chargeback_amount  NUMBER(10,2);
14:33:53 2128  ver_refund_charge_id   NUMBER;
14:33:53 2129  -- EXCEPTIONS
14:33:53 2130  BAD_INVOICE_ID		    EXCEPTION;
14:33:53 2131  CAN_NOT_CALCULATE_CHARGEBACK EXCEPTION;
14:33:53 2132  CAN_NOT_APPLY_CHARGEBACK     EXCEPTION;
14:33:53 2133  EXCEPTION_MESSAGE	    VARCHAR2(1024);
14:33:53 2134  -- STUB
14:33:53 2135  var_now DATE;
14:33:53 2136  var_revoke NUMBER;
14:33:53 2137  var_refund NUMBER;
14:33:53 2138  var_billed NUMBER;
14:33:53 2139  var_subscription_in_grace NUMBER;
14:33:53 2140  BEGIN
14:33:53 2141  
14:33:53 2142  	 var_now := sysdate;
14:33:53 2143  
14:33:53 2144  	 -- Check that invoice exists
14:33:53 2145  	 BEGIN
14:33:53 2146  	   SELECT
14:33:53 2147  	     INVOICE.ID into temp_invoice_id
14:33:53 2148  	   FROM
14:33:53 2149  	     INVOICE
14:33:53 2150  	   WHERE
14:33:53 2151  	     INVOICE.ID = in_invoice_id;
14:33:53 2152  	   EXCEPTION
14:33:53 2153  	     WHEN NO_DATA_FOUND THEN
14:33:53 2154  	       RAISE BAD_INVOICE_ID;
14:33:53 2155  	 END;
14:33:53 2156  
14:33:53 2157  	 select decode(count(1), 0, GLOBAL_CONSTANTS_V22.FALSE, GLOBAL_CONSTANTS_V22.TRUE) into var_revoke
14:33:53 2158  	 from license l, subscription s, offer_chain oc
14:33:53 2159  	 where
14:33:53 2160  	   l.subscription_id = s.id and
14:33:53 2161  	   s.offer_chain_id = oc.id and
14:33:53 2162  	   l.invoice_id = in_invoice_id and
14:33:53 2163  	   oc.revoke_entitlements = GLOBAL_CONSTANTS_V22.TRUE and
14:33:53 2164  	   rownum < 2;
14:33:53 2165  
14:33:53 2166  	 select
14:33:53 2167  	   decode(s.subscription_status_id, GLOBAL_STATUSES_V22.SUBSCRIPTION_IN_GRACE_PERIOD, 1, 0)
14:33:53 2168  	 into
14:33:53 2169  	   var_subscription_in_grace
14:33:53 2170  	 from license l, subscription s
14:33:53 2171  	 where
14:33:53 2172  	   l.subscription_id = s.id and
14:33:53 2173  	   l.invoice_id = in_invoice_id and
14:33:53 2174  	   rownum < 2;
14:33:53 2175  
14:33:53 2176  	 var_billed := PROCS_INVOICE_V22.IS_INVOICE_PAYING_STARTED(in_invoice_id);
14:33:53 2177  	 var_refund := GLOBAL_CONSTANTS_V22.FALSE;
14:33:53 2178  
14:33:53 2179  	 -- Check that transaction for given invoice not started
14:33:53 2180  	 -- if refund enabled calculate and apply chargeback
14:33:53 2181  	 IF (
14:33:53 2182  	     var_billed = GLOBAL_CONSTANTS_V22.TRUE
14:33:53 2183  	   )THEN
14:33:53 2184  	   if (in_refundable = GLOBAL_CONSTANTS_V22.TRUE) then
14:33:53 2185  	     -- If started then we need to calculate refund
14:33:53 2186  	     BEGIN
14:33:53 2187  	       PROCS_INVOICE_V22.CALCULATE_INVOICE_CHARGEBACK(
14:33:53 2188  		 in_invoice_id,
14:33:53 2189  		 var_now,
14:33:53 2190  		 var_chargeback_amount
14:33:53 2191  	       );
14:33:53 2192  	       EXCEPTION
14:33:53 2193  		 WHEN OTHERS THEN
14:33:53 2194  		   EXCEPTION_MESSAGE := SQLERRM;
14:33:53 2195  		   RAISE CAN_NOT_CALCULATE_CHARGEBACK;
14:33:53 2196  	     END;
14:33:53 2197  	     IF var_chargeback_amount > 0 THEN
14:33:53 2198  	       BEGIN
14:33:53 2199  		 PROCS_INVOICE_V22.APPLY_REFUND(
14:33:53 2200  		   in_invoice_id,
14:33:53 2201  		   var_chargeback_amount,
14:33:53 2202  		   in_updated_by,
14:33:53 2203  		   ver_refund_charge_id
14:33:53 2204  		 );
14:33:53 2205  		 EXCEPTION
14:33:53 2206  		   WHEN OTHERS THEN
14:33:53 2207  		     EXCEPTION_MESSAGE := SQLERRM;
14:33:53 2208  		     RAISE CAN_NOT_APPLY_CHARGEBACK;
14:33:53 2209  	       END;
14:33:53 2210  	       var_refund := GLOBAL_CONSTANTS_V22.TRUE;
14:33:53 2211  	     END IF;
14:33:53 2212  	   end if;
14:33:53 2213  	 ELSE
14:33:53 2214  
14:33:53 2215  	   FOR f_transaction_to_close IN (
14:33:53 2216  	     SELECT DISTINCT CHARGE.TRANSACTION_ID AS "ID" FROM CHARGE WHERE CHARGE.INVOICE_ID = in_invoice_id and CHARGE.CHARGE_STATUS_ID = GLOBAL_STATUSES_V22.CHARGE_OPENED
14:33:53 2217  	   )
14:33:53 2218  	   LOOP
14:33:53 2219  	     PROCS_TRANSACTION_V22.UPDATE_TRANSACTION_STATUS(
14:33:53 2220  	       in_transaction_id	=> f_transaction_to_close.ID,
14:33:53 2221  	       in_updated_by		=> in_updated_by,
14:33:53 2222  	       in_transaction_status_id => GLOBAL_STATUSES_V22.TRANSACTION_CLOSED
14:33:53 2223  	     );
14:33:53 2224  	   END LOOP;
14:33:53 2225  	   -- Needs to close charges. No refund.
14:33:53 2226  	   FOR f_charge_to_close IN (
14:33:53 2227  	     SELECT CHARGE.ID FROM CHARGE WHERE CHARGE.INVOICE_ID = in_invoice_id and CHARGE.CHARGE_STATUS_ID = GLOBAL_STATUSES_V22.CHARGE_OPENED
14:33:53 2228  	   )
14:33:53 2229  	   LOOP
14:33:53 2230  	     PROCS_CHARGE_V22.UPDATE_CHARGE_STATUS(
14:33:53 2231  	       in_charge_id	   => f_charge_to_close.ID,
14:33:53 2232  	       in_updated_by	   => in_updated_by,
14:33:53 2233  	       in_charge_status_id => GLOBAL_STATUSES_V22.CHARGE_CANCELED
14:33:53 2234  	     );
14:33:53 2235  	   END LOOP;
14:33:53 2236  
14:33:53 2237  	   PROCS_INVOICE_V22.UPDATE_INVOICE_STATUS(
14:33:53 2238  	     in_invoice_id		    => in_invoice_id,
14:33:53 2239  	     in_updated_by		    => in_updated_by,
14:33:53 2240  	     in_invoice_status_id	    => GLOBAL_STATUSES_V22.INVOICE_CLOSED
14:33:53 2241  	   );
14:33:53 2242  
14:33:53 2243  	 END IF;
14:33:53 2244  	 -- update licenses
14:33:53 2245  	 IF(var_revoke = GLOBAL_CONSTANTS_V22.TRUE OR var_chargeback_amount > 0 OR (var_subscription_in_grace = GLOBAL_CONSTANTS_V22.FALSE AND var_billed = GLOBAL_CONSTANTS_V22.FALSE)) THEN
14:33:53 2246  	   FOR f_license_to_cancel IN (
14:33:53 2247  	     SELECT LICENSE.ID FROM LICENSE WHERE LICENSE.INVOICE_ID = in_invoice_id AND LICENSE.LICENSE_STATUS_ID = GLOBAL_STATUSES_V22.LICENSE_ACTIVE
14:33:53 2248  	   )
14:33:53 2249  	   LOOP
14:33:53 2250  	     PROCS_LICENSE_CRU_V22.UPDATE_LICENSE(
14:33:53 2251  	       in_license_id	     => f_license_to_cancel.ID,
14:33:53 2252  	       in_license_status_id  => GLOBAL_STATUSES_V22.LICENSE_CLOSED,
14:33:53 2253  	       in_needs_entitlements => GLOBAL_CONSTANTS_V22.TRUE,
14:33:53 2254  	       in_updated_by	     => in_updated_by,
14:33:53 2255  	       in_entitlement_end_date => var_now
14:33:53 2256  	     );
14:33:53 2257  	   END LOOP;
14:33:53 2258  	 ELSE
14:33:53 2259  	   FOR f_license_to_cancel IN (
14:33:53 2260  	     SELECT LICENSE.ID FROM LICENSE WHERE LICENSE.INVOICE_ID = in_invoice_id AND LICENSE.LICENSE_STATUS_ID in (GLOBAL_STATUSES_V22.LICENSE_ACTIVE, GLOBAL_STATUSES_V22.LICENSE_IN_GRACE_PERIOD)
14:33:53 2261  	   )
14:33:53 2262  	   LOOP
14:33:53 2263  	     PROCS_LICENSE_CRU_V22.UPDATE_LICENSE(
14:33:53 2264  	       in_license_id	     => f_license_to_cancel.ID,
14:33:53 2265  	       in_license_status_id  => GLOBAL_STATUSES_V22.LICENSE_CLOSED,
14:33:53 2266  	       in_updated_by	     => in_updated_by
14:33:53 2267  	     );
14:33:53 2268  	   END LOOP;
14:33:53 2269  	 END IF;
14:33:53 2270  
14:33:53 2271  
14:33:53 2272  EXCEPTION
14:33:53 2273  WHEN BAD_INVOICE_ID THEN
14:33:53 2274  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 2275  	   SPROC_NAME, 'No such invoice');
14:33:53 2276  WHEN CAN_NOT_CALCULATE_CHARGEBACK THEN
14:33:53 2277  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 2278  	   SPROC_NAME, 'Could not calculate invoice refund', EXCEPTION_MESSAGE);
14:33:53 2279  WHEN CAN_NOT_APPLY_CHARGEBACK THEN
14:33:53 2280  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 2281  	   SPROC_NAME, 'Could not apply chargeback', EXCEPTION_MESSAGE);
14:33:53 2282  WHEN OTHERS THEN
14:33:53 2283  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 2284  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 2285  END CANCEL_SUBSCRIPTION_INVOICE;
14:33:53 2286  
14:33:53 2287  /******************************************************************************/
14:33:53 2288  
14:33:53 2289  PROCEDURE FINALIZE_CANCELATION (
14:33:53 2290  /*
14:33:53 2291  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 2292  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 2293  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:53 2294  */
14:33:53 2295  --  in_subscription_id	 IN SUBSCRIPTION.ID%TYPE,
14:33:53 2296  --  in_cancelation_reason IN SUBSCRIPTION_CANCEL_REASON.VALUE%TYPE,
14:33:53 2297  --  in_cancelation_date	 IN SUBSCRIPTION.CANCELLATION_DATE%TYPE,
14:33:53 2298  --  in_note		 IN SUBSCRIPTION_NOTE.NOTE%TYPE,
14:33:53 2299  --  in_agent_id		 IN SUBSCRIPTION_NOTE.AGENT_ID%TYPE,
14:33:53 2300  --  in_updated_by	 IN SUBSCRIPTION.UPDATED_BY%TYPE
14:33:53 2301  	 in_subscription_id    IN NUMBER,
14:33:53 2302  	 in_cancelation_reason IN VARCHAR2,
14:33:53 2303  	 in_cancelation_date   IN DATE,
14:33:53 2304  	 in_note	       IN VARCHAR2,
14:33:53 2305  	 in_agent_id	       IN NUMBER,
14:33:53 2306  	 in_updated_by	       IN VARCHAR2
14:33:53 2307  ) AS
14:33:53 2308  SPROC_NAME CONSTANT VARCHAR2(20) := 'FINALIZE_CANCELATION';
14:33:53 2309  -- VARIABLES
14:33:53 2310  var_current_subscr_status SUBSCRIPTION.SUBSCRIPTION_STATUS_ID%TYPE;
14:33:53 2311  var_sct_id		 SUBSCRIPTION.SCT_ID%TYPE;
14:33:53 2312  var_active_invoices_count NUMBER;
14:33:53 2313  var_license_to_disgrace	 LICENSE.ID%TYPE;
14:33:53 2314  var_now			 DATE := SYSDATE;
14:33:53 2315  -- EXCEPTIONS
14:33:53 2316  BAD_SUBSCRIPTION_ID	   EXCEPTION;
14:33:53 2317  BAD_SUBSCRIPTION_STATUS	   EXCEPTION;
14:33:53 2318  BAD_CANCELATION_REASON	   EXCEPTION;
14:33:53 2319  CAN_NOT_UPDATE_SUBSCRIPTION EXCEPTION;
14:33:53 2320  ACTIVE_INVOICES_FOUND	   EXCEPTION;
14:33:53 2321  CAN_NOT_CREATE_NOTE	   EXCEPTION;
14:33:53 2322  EXCEPTION_MESSAGE	   VARCHAR2(1024);
14:33:53 2323  BEGIN
14:33:53 2324  
14:33:53 2325  	 -- Get current subscription status
14:33:53 2326  	 BEGIN
14:33:53 2327  	   SELECT
14:33:53 2328  	     SUBSCRIPTION.SUBSCRIPTION_STATUS_ID into var_current_subscr_status
14:33:53 2329  	   FROM
14:33:53 2330  	     SUBSCRIPTION
14:33:53 2331  	   WHERE
14:33:53 2332  	     SUBSCRIPTION.ID = in_subscription_id;
14:33:53 2333  	   EXCEPTION
14:33:53 2334  	     WHEN NO_DATA_FOUND THEN
14:33:53 2335  	       RAISE BAD_SUBSCRIPTION_ID;
14:33:53 2336  	 END;
14:33:53 2337  
14:33:53 2338  	 -- Check that subscription reason is correct
14:33:53 2339  	 BEGIN
14:33:53 2340  	   SELECT
14:33:53 2341  	     SUBSCRIPTION_CANCEL_REASON.ID into var_sct_id
14:33:53 2342  	   FROM
14:33:53 2343  	     SUBSCRIPTION_CANCEL_REASON
14:33:53 2344  	   WHERE
14:33:53 2345  	     SUBSCRIPTION_CANCEL_REASON.VALUE LIKE in_cancelation_reason
14:33:53 2346  	     AND ROWNUM <= 1;
14:33:53 2347  	   EXCEPTION
14:33:53 2348  	     WHEN NO_DATA_FOUND THEN
14:33:53 2349  	       RAISE BAD_CANCELATION_REASON;
14:33:53 2350  	 END;
14:33:53 2351  
14:33:53 2352  	 -- Check for invoices with active licenses
14:33:53 2353  	 SELECT
14:33:53 2354  	   COUNT(*) into var_active_invoices_count
14:33:53 2355  	 FROM
14:33:53 2356  	   LICENSE
14:33:53 2357  	   INNER JOIN INVOICE ON LICENSE.INVOICE_ID = INVOICE.ID
14:33:53 2358  	 WHERE
14:33:53 2359  	   LICENSE.LICENSE_STATUS_ID in (GLOBAL_STATUSES_V22.LICENSE_ACTIVE, GLOBAL_STATUSES_V22.LICENSE_IN_GRACE_PERIOD)
14:33:53 2360  	   AND LICENSE.SUBSCRIPTION_ID = in_subscription_id;
14:33:53 2361  
14:33:53 2362  	 IF var_active_invoices_count > 0 THEN
14:33:53 2363  	   RAISE ACTIVE_INVOICES_FOUND;
14:33:53 2364  	 END IF;
14:33:53 2365  
14:33:53 2366  	 -- Check that subscription is active
14:33:53 2367  	 IF var_current_subscr_status != GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE AND
14:33:53 2368  	    var_current_subscr_status != GLOBAL_STATUSES_V22.SUBSCRIPTION_SUSPENDED AND
14:33:53 2369  	    var_current_subscr_status != GLOBAL_STATUSES_V22.SUBSCRIPTION_IN_GRACE_PERIOD THEN
14:33:53 2370  	   RAISE BAD_SUBSCRIPTION_STATUS;
14:33:53 2371  	 END IF;
14:33:53 2372  
14:33:53 2373  	 -- Update subscription data
14:33:53 2374  	 BEGIN
14:33:53 2375  	   PROCS_SUBSCRIPTION_CRU_V22.UPDATE_SUBSCRIPTION(
14:33:53 2376  	     in_subscription_id        => in_subscription_id,
14:33:53 2377  	     in_subscription_status_id => GLOBAL_STATUSES_V22.SUBSCRIPTION_CANCELED,
14:33:53 2378  	     in_cancelation_date       => in_cancelation_date,
14:33:53 2379  	     in_updated_by	       => in_updated_by,
14:33:53 2380  	     in_sct_id		       => var_sct_id
14:33:53 2381  	   );
14:33:53 2382  	   EXCEPTION
14:33:53 2383  	     WHEN OTHERS THEN
14:33:53 2384  	       EXCEPTION_MESSAGE := SQLERRM;
14:33:53 2385  	       RAISE CAN_NOT_UPDATE_SUBSCRIPTION;
14:33:53 2386  	 END;
14:33:53 2387  
14:33:53 2388  	 -- Terminate grace period for licenses in grace [SAR-31]
14:33:53 2389  	 BEGIN
14:33:53 2390  	   SELECT
14:33:53 2391  	     LICENSE.ID into var_license_to_disgrace
14:33:53 2392  	   FROM
14:33:53 2393  	     LICENSE
14:33:53 2394  	   WHERE
14:33:53 2395  	     LICENSE.SUBSCRIPTION_ID = in_subscription_id
14:33:53 2396  	     AND LICENSE.LICENSE_STATUS_ID = GLOBAL_STATUSES_V22.LICENSE_IN_GRACE_PERIOD
14:33:53 2397  	     AND ROWNUM <= 1
14:33:53 2398  	   ORDER BY
14:33:53 2399  	     CREATE_DATE DESC;
14:33:53 2400  	 EXCEPTION
14:33:53 2401  	   WHEN NO_DATA_FOUND THEN
14:33:53 2402  	     var_license_to_disgrace := NULL;
14:33:53 2403  	 END;
14:33:53 2404  
14:33:53 2405  	 IF var_license_to_disgrace IS NOT NULL THEN
14:33:53 2406  	   PROCS_LICENSE_CRU_V22.UPDATE_LICENSE(
14:33:53 2407  	     in_license_id	     => var_license_to_disgrace,
14:33:53 2408  	     in_license_status_id    => GLOBAL_STATUSES_V22.LICENSE_CLOSED,
14:33:53 2409  	     in_updated_by	     => in_updated_by
14:33:53 2410  	   );
14:33:53 2411  	 END IF;
14:33:53 2412  
14:33:53 2413  	 -- Annotate subscription
14:33:53 2414  	 IF in_note IS NOT NULL THEN
14:33:53 2415  	   BEGIN
14:33:53 2416  	     PROCS_SUBSCRIPTION_V22.ANNOTATE_SUBSCRIPTION(
14:33:53 2417  	       in_subscription_id,
14:33:53 2418  	       in_agent_id,
14:33:53 2419  	       in_note,
14:33:53 2420  	       in_updated_by
14:33:53 2421  	     );
14:33:53 2422  	     EXCEPTION
14:33:53 2423  	      WHEN OTHERS THEN
14:33:53 2424  		EXCEPTION_MESSAGE := SQLERRM;
14:33:53 2425  		RAISE CAN_NOT_CREATE_NOTE;
14:33:53 2426  	   END;
14:33:53 2427  	 END IF;
14:33:53 2428  
14:33:53 2429  EXCEPTION
14:33:53 2430  WHEN BAD_SUBSCRIPTION_ID THEN
14:33:53 2431  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 2432  	   SPROC_NAME, 'No such subscription');
14:33:53 2433  WHEN BAD_SUBSCRIPTION_STATUS THEN
14:33:53 2434  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:53 2435  	   SPROC_NAME, 'Bad current subscription status');
14:33:53 2436  WHEN BAD_CANCELATION_REASON THEN
14:33:53 2437  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:53 2438  	   SPROC_NAME, 'Bad cancellation reason');
14:33:53 2439  WHEN CAN_NOT_UPDATE_SUBSCRIPTION THEN
14:33:53 2440  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 2441  	   SPROC_NAME, 'Could not update subscription data', EXCEPTION_MESSAGE);
14:33:53 2442  WHEN ACTIVE_INVOICES_FOUND THEN
14:33:53 2443  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:53 2444  	   SPROC_NAME, 'Invoices with active licenses found');
14:33:53 2445  WHEN CAN_NOT_CREATE_NOTE THEN
14:33:53 2446  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 2447  	   SPROC_NAME, 'Could not annotate subscription', EXCEPTION_MESSAGE);
14:33:53 2448  --WHEN OTHERS THEN
14:33:53 2449  --  PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 2450  --    SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 2451  END FINALIZE_CANCELATION;
14:33:53 2452  
14:33:53 2453  /******************************************************************************/
14:33:53 2454  
14:33:53 2455  PROCEDURE FINALIZE_FALSE_START (
14:33:53 2456  /*
14:33:53 2457  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 2458  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 2459  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:53 2460  */
14:33:53 2461  --  in_subscription_id	 IN SUBSCRIPTION.ID%TYPE,
14:33:53 2462  --  in_cancelation_date	 IN SUBSCRIPTION.CANCELLATION_DATE%TYPE,
14:33:53 2463  --  in_note		 IN SUBSCRIPTION_NOTE.NOTE%TYPE,
14:33:53 2464  --  in_agent_id		 IN SUBSCRIPTION_NOTE.AGENT_ID%TYPE,
14:33:53 2465  --  in_updated_by	 IN SUBSCRIPTION.UPDATED_BY%TYPE
14:33:53 2466  	 in_subscription_id    IN NUMBER,
14:33:53 2467  	 in_cancelation_date   IN DATE,
14:33:53 2468  	 in_note	       IN VARCHAR2,
14:33:53 2469  	 in_agent_id	       IN NUMBER,
14:33:53 2470  	 in_updated_by	       IN VARCHAR2
14:33:53 2471  ) AS
14:33:53 2472  SPROC_NAME CONSTANT VARCHAR2(20) := 'FINALIZE_FALSE_START';
14:33:53 2473  FALSE_START_REASON CONSTANT NUMBER := 41;
14:33:53 2474  -- VARIABLES
14:33:53 2475  var_current_subscr_status SUBSCRIPTION.SUBSCRIPTION_STATUS_ID%TYPE;
14:33:53 2476  var_active_invoices_count NUMBER;
14:33:53 2477  -- EXCEPTIONS
14:33:53 2478  BAD_SUBSCRIPTION_ID	   EXCEPTION;
14:33:53 2479  BAD_SUBSCRIPTION_STATUS	   EXCEPTION;
14:33:53 2480  CAN_NOT_UPDATE_SUBSCRIPTION EXCEPTION;
14:33:53 2481  ACTIVE_INVOICES_FOUND	   EXCEPTION;
14:33:53 2482  CAN_NOT_CREATE_NOTE	   EXCEPTION;
14:33:53 2483  EXCEPTION_MESSAGE	   VARCHAR2(1024);
14:33:53 2484  BEGIN
14:33:53 2485  
14:33:53 2486  	 -- Get current subscription status
14:33:53 2487  	 BEGIN
14:33:53 2488  	   SELECT
14:33:53 2489  	     SUBSCRIPTION.SUBSCRIPTION_STATUS_ID into var_current_subscr_status
14:33:53 2490  	   FROM
14:33:53 2491  	     SUBSCRIPTION
14:33:53 2492  	   WHERE
14:33:53 2493  	     SUBSCRIPTION.ID = in_subscription_id;
14:33:53 2494  	   EXCEPTION
14:33:53 2495  	     WHEN NO_DATA_FOUND THEN
14:33:53 2496  	       RAISE BAD_SUBSCRIPTION_ID;
14:33:53 2497  	 END;
14:33:53 2498  
14:33:53 2499  	 -- Check for invoices with active licenses
14:33:53 2500  	 SELECT
14:33:53 2501  	   COUNT(*) into var_active_invoices_count
14:33:53 2502  	 FROM
14:33:53 2503  	   LICENSE
14:33:53 2504  	   INNER JOIN INVOICE ON LICENSE.INVOICE_ID = INVOICE.ID
14:33:53 2505  	 WHERE
14:33:53 2506  	   LICENSE.LICENSE_STATUS_ID = GLOBAL_STATUSES_V22.LICENSE_ACTIVE
14:33:53 2507  	   AND LICENSE.SUBSCRIPTION_ID = in_subscription_id;
14:33:53 2508  
14:33:53 2509  	 IF var_active_invoices_count > 0 THEN
14:33:53 2510  	   RAISE ACTIVE_INVOICES_FOUND;
14:33:53 2511  	 END IF;
14:33:53 2512  
14:33:53 2513  	 -- Check that subscription is active
14:33:53 2514  	 IF var_current_subscr_status != GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE
14:33:53 2515  	    AND var_current_subscr_status != GLOBAL_STATUSES_V22.SUBSCRIPTION_SUSPENDED THEN
14:33:53 2516  	   RAISE BAD_SUBSCRIPTION_STATUS;
14:33:53 2517  	 END IF;
14:33:53 2518  
14:33:53 2519  	 -- Update subscription data
14:33:53 2520  	 BEGIN
14:33:53 2521  	   PROCS_SUBSCRIPTION_CRU_V22.UPDATE_SUBSCRIPTION(
14:33:53 2522  	     in_subscription_id        => in_subscription_id,
14:33:53 2523  	     in_subscription_status_id => GLOBAL_STATUSES_V22.SUBSCRIPTION_FALSE_START,
14:33:53 2524  	     in_cancelation_date       => in_cancelation_date,
14:33:53 2525  	     in_updated_by	       => in_updated_by,
14:33:53 2526  	     in_sct_id		       => FALSE_START_REASON
14:33:53 2527  	   );
14:33:53 2528  	   EXCEPTION
14:33:53 2529  	     WHEN OTHERS THEN
14:33:53 2530  	       EXCEPTION_MESSAGE := SQLERRM;
14:33:53 2531  	       RAISE CAN_NOT_UPDATE_SUBSCRIPTION;
14:33:53 2532  	 END;
14:33:53 2533  
14:33:53 2534  	 -- Annotate subscription
14:33:53 2535  	 IF in_note IS NOT NULL THEN
14:33:53 2536  	   BEGIN
14:33:53 2537  	     PROCS_SUBSCRIPTION_V22.ANNOTATE_SUBSCRIPTION(
14:33:53 2538  	       in_subscription_id,
14:33:53 2539  	       in_agent_id,
14:33:53 2540  	       in_note,
14:33:53 2541  	       in_updated_by
14:33:53 2542  	     );
14:33:53 2543  	     EXCEPTION
14:33:53 2544  	      WHEN OTHERS THEN
14:33:53 2545  		EXCEPTION_MESSAGE := SQLERRM;
14:33:53 2546  		RAISE CAN_NOT_CREATE_NOTE;
14:33:53 2547  	   END;
14:33:53 2548  	 END IF;
14:33:53 2549  
14:33:53 2550  EXCEPTION
14:33:53 2551  WHEN BAD_SUBSCRIPTION_ID THEN
14:33:53 2552  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 2553  	   SPROC_NAME, 'No such subscription');
14:33:53 2554  WHEN BAD_SUBSCRIPTION_STATUS THEN
14:33:53 2555  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:53 2556  	   SPROC_NAME, 'Bad current subscription status');
14:33:53 2557  WHEN CAN_NOT_UPDATE_SUBSCRIPTION THEN
14:33:53 2558  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 2559  	   SPROC_NAME, 'Could not update subscription data', EXCEPTION_MESSAGE);
14:33:53 2560  WHEN ACTIVE_INVOICES_FOUND THEN
14:33:53 2561  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:53 2562  	   SPROC_NAME, 'Invoices with active licenses found');
14:33:53 2563  WHEN CAN_NOT_CREATE_NOTE THEN
14:33:53 2564  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 2565  	   SPROC_NAME, 'Could not annotate subscription', EXCEPTION_MESSAGE);
14:33:53 2566  WHEN OTHERS THEN
14:33:53 2567  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 2568  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 2569  END FINALIZE_FALSE_START;
14:33:53 2570  
14:33:53 2571  /******************************************************************************/
14:33:53 2572  
14:33:53 2573  FUNCTION IS_SUBSCRIPTION_CANCELABLE (
14:33:53 2574  	 in_subscription_id IN NUMBER
14:33:53 2575  ) RETURN NUMBER AS
14:33:53 2576  SPROC_NAME CONSTANT VARCHAR2(26) := 'IS_SUBSCRIPTION_CANCELABLE';
14:33:53 2577  -- VARIABLES
14:33:53 2578  var_is_offer_chain_cancelable NUMBER;
14:33:53 2579  --64603
14:33:53 2580  var_end_date date;
14:33:53 2581  today_date date := current_date;
14:33:53 2582  offer_id number;
14:33:53 2583  -- EXCEPTIONS
14:33:53 2584  COULD_NOT_CHECK	   EXCEPTION;
14:33:53 2585  BAD_SUBSCRIPTION_ID EXCEPTION;
14:33:53 2586  EXCEPTION_MESSAGE   VARCHAR2(1024);
14:33:53 2587  BEGIN
14:33:53 2588  
14:33:53 2589  	 BEGIN
14:33:53 2590  	   -- find offer_chain_id for given in_subscription_id
14:33:53 2591  	   SELECT OFFER_CHAIN_ID into offer_id
14:33:53 2592  	   FROM SUBSCRIPTION
14:33:53 2593  	   WHERE ID = in_subscription_id;
14:33:53 2594  	   EXCEPTION
14:33:53 2595  	     WHEN NO_DATA_FOUND THEN
14:33:53 2596  	       RAISE BAD_SUBSCRIPTION_ID;
14:33:53 2597  	     WHEN OTHERS THEN
14:33:53 2598  	       EXCEPTION_MESSAGE := SQLERRM;
14:33:53 2599  	       RAISE COULD_NOT_CHECK;
14:33:53 2600  	 END;
14:33:53 2601  
14:33:53 2602  	 -- find if it was redeemed from a gift certificate
14:33:53 2603  	 BEGIN
14:33:53 2604  	   SELECT l.end_date INTO var_end_date
14:33:53 2605  	   FROM LICENSE l, GIFT_CERTIFICATE g
14:33:53 2606  	   WHERE l.invoice_id = g.finalized_invoice_id
14:33:53 2607  	   AND l.subscription_id = in_subscription_id;
14:33:53 2608  
14:33:53 2609  	   -- if the license end_date is bigger than today, we are in the
14:33:53 2610  	   -- first period, so we cannot cancel; otherwise can cancel
14:33:53 2611  	   IF var_end_date > today_date THEN
14:33:53 2612  	       RETURN GLOBAL_CONSTANTS_V22.FALSE;
14:33:53 2613  	   ELSE
14:33:53 2614  	       RETURN GLOBAL_CONSTANTS_V22.TRUE;
14:33:53 2615  	   END IF;
14:33:53 2616  
14:33:53 2617  	   EXCEPTION
14:33:53 2618  	       -- not coming from a gift certificate,
14:33:53 2619  	       -- use old logic
14:33:53 2620  	       WHEN NO_DATA_FOUND THEN
14:33:53 2621  		   SELECT
14:33:53 2622  		       PROCS_OFFER_CHAIN_V22.IS_OFFER_CHAIN_CANCELABLE(offer_id)
14:33:53 2623  		       INTO var_is_offer_chain_cancelable
14:33:53 2624  		   FROM DUAL;
14:33:53 2625  		   RETURN var_is_offer_chain_cancelable;
14:33:53 2626  	 END;
14:33:53 2627  
14:33:53 2628  EXCEPTION
14:33:53 2629  WHEN BAD_SUBSCRIPTION_ID THEN
14:33:53 2630  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 2631  	   SPROC_NAME, 'No such subscription');
14:33:53 2632  WHEN COULD_NOT_CHECK THEN
14:33:53 2633  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:53 2634  	   SPROC_NAME, 'Could not check if offer chain calcelable', EXCEPTION_MESSAGE);
14:33:53 2635  WHEN OTHERS THEN
14:33:53 2636  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 2637  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 2638  
14:33:53 2639  END IS_SUBSCRIPTION_CANCELABLE;
14:33:53 2640  /******************************************************************************/
14:33:53 2641  
14:33:53 2642  PROCEDURE GET_SUBSCR_PROD_OFFERRINGS (
14:33:53 2643  /*
14:33:53 2644  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 2645  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 2646  */
14:33:53 2647  	 in_subscription_id IN NUMBER,
14:33:53 2648  	 out_result_set     OUT SYS_REFCURSOR
14:33:53 2649  ) AS
14:33:53 2650  SPROC_NAME CONSTANT VARCHAR2(26) := 'GET_SUBSCR_PROD_OFFERRINGS';
14:33:53 2651  -- VARIABLES
14:33:53 2652  var_offer NUMBER;
14:33:53 2653  -- EXCEPTIONS
14:33:53 2654  BAD_SUBSCRIPTION_ID EXCEPTION;
14:33:53 2655  BEGIN
14:33:53 2656  
14:33:53 2657  	 OPEN out_result_set FOR
14:33:53 2658  	 SELECT DISTINCT
14:33:53 2659  	   PRODUCT_OFFERING.ID,
14:33:53 2660  	   PRODUCT_OFFERING.PRODUCT_ID,
14:33:53 2661  	   PRODUCT_OFFERING.TAX_CATEGORY_ID,
14:33:53 2662  	   PRODUCT_OFFERING.UNIT_PRICE,
14:33:53 2663  	   PRODUCT_OFFERING.QUANTITY,
14:33:53 2664  	   PRODUCT_OFFERING.CREATE_DATE,
14:33:53 2665  	   PRODUCT_OFFERING.CREATED_BY,
14:33:53 2666  	   CAPABILITY.ID CAP_ID,
14:33:53 2667  	   CAPABILITY.CODE CAP_CODE,
14:33:53 2668  	   CAPABILITY.DESCRIPTION CAP_DESCRIPTION,
14:33:53 2669  	   CAPABILITY.SHAREABLE CAP_SHAREABLE
14:33:53 2670  	 FROM
14:33:53 2671  	   OFFER_PRODUCT_OFFERING
14:33:53 2672  	   INNER JOIN PRODUCT_OFFERING ON PRODUCT_OFFERING.ID = OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID
14:33:53 2673  	   INNER JOIN CAPABILITY ON PRODUCT_OFFERING.CAPABILITY_ID = CAPABILITY.ID
14:33:53 2674  	 WHERE
14:33:53 2675  	   OFFER_PRODUCT_OFFERING.OFFER_ID IN (
14:33:53 2676  	     SELECT
14:33:53 2677  	       LICENSE.OFFER_ID
14:33:53 2678  	     FROM
14:33:53 2679  	       SUBSCRIPTION
14:33:53 2680  	       JOIN LICENSE ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID AND LICENSE.NEEDS_ENTITLEMENTS = GLOBAL_CONSTANTS_V22.TRUE
14:33:53 2681  	     WHERE
14:33:53 2682  	       SUBSCRIPTION.ID = in_subscription_id
14:33:53 2683  	   );
14:33:53 2684  
14:33:53 2685  EXCEPTION
14:33:53 2686  WHEN BAD_SUBSCRIPTION_ID THEN
14:33:53 2687  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 2688  	   SPROC_NAME, 'No such subscription');
14:33:53 2689  WHEN OTHERS THEN
14:33:53 2690  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 2691  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 2692  END GET_SUBSCR_PROD_OFFERRINGS;
14:33:53 2693  
14:33:53 2694  
14:33:53 2695  PROCEDURE RETRIEVE_SUB_PROD_OFFER (
14:33:53 2696  /*
14:33:53 2697  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 2698  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 2699  */
14:33:53 2700  	 in_subscription_id IN NUMBER,
14:33:53 2701  	 out_result_set     OUT SYS_REFCURSOR
14:33:53 2702  ) AS
14:33:53 2703  SPROC_NAME CONSTANT VARCHAR2(27) := 'RETRIEVE_SUB_PROD_OFFER';
14:33:53 2704  -- VARIABLES
14:33:53 2705  var_offer NUMBER;
14:33:53 2706  -- EXCEPTIONS
14:33:53 2707  BAD_SUBSCRIPTION_ID EXCEPTION;
14:33:53 2708  BEGIN
14:33:53 2709  
14:33:53 2710  	 OPEN out_result_set FOR
14:33:53 2711  	 SELECT DISTINCT
14:33:53 2712  	   PRODUCT_OFFERING.ID,
14:33:53 2713  	   PRODUCT_OFFERING.PRODUCT_ID,
14:33:53 2714  	   PRODUCT_OFFERING.TAX_CATEGORY_ID,
14:33:53 2715  	   PRODUCT_OFFERING.UNIT_PRICE,
14:33:53 2716  	   PRODUCT_OFFERING.QUANTITY,
14:33:53 2717  	   PRODUCT_OFFERING.CREATE_DATE,
14:33:53 2718  	   PRODUCT_OFFERING.CREATED_BY,
14:33:53 2719  	   CAPABILITY.ID CAP_ID,
14:33:53 2720  	   CAPABILITY.CODE CAP_CODE,
14:33:53 2721  	   CAPABILITY.DESCRIPTION CAP_DESCRIPTION,
14:33:53 2722  	   CAPABILITY.SHAREABLE CAP_SHAREABLE
14:33:53 2723  	 FROM
14:33:53 2724  	   OFFER_PRODUCT_OFFERING
14:33:53 2725  	   INNER JOIN PRODUCT_OFFERING ON PRODUCT_OFFERING.ID = OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID
14:33:53 2726  	   INNER JOIN CAPABILITY ON PRODUCT_OFFERING.CAPABILITY_ID = CAPABILITY.ID
14:33:53 2727  	 WHERE
14:33:53 2728  	   OFFER_PRODUCT_OFFERING.OFFER_ID IN (
14:33:53 2729  	     SELECT
14:33:53 2730  	       LICENSE.OFFER_ID
14:33:53 2731  	     FROM
14:33:53 2732  	       SUBSCRIPTION
14:33:53 2733  	       JOIN LICENSE ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
14:33:53 2734  	     WHERE
14:33:53 2735  	       SUBSCRIPTION.ID = in_subscription_id
14:33:53 2736  	   );
14:33:53 2737  
14:33:53 2738  EXCEPTION
14:33:53 2739  WHEN BAD_SUBSCRIPTION_ID THEN
14:33:53 2740  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 2741  	   SPROC_NAME, 'No such subscription');
14:33:53 2742  WHEN OTHERS THEN
14:33:53 2743  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 2744  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 2745  END RETRIEVE_SUB_PROD_OFFER;
14:33:53 2746  /******************************************************************************/
14:33:53 2747  
14:33:53 2748  
14:33:53 2749  
14:33:53 2750  
14:33:53 2751  PROCEDURE GET_SUBSCR_LIC_OFFER(
14:33:53 2752  /*
14:33:53 2753  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 2754  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 2755  */
14:33:53 2756  	 in_subscription_id IN NUMBER,
14:33:53 2757  	 out_result_set     OUT SYS_REFCURSOR
14:33:53 2758  ) AS
14:33:53 2759  SPROC_NAME CONSTANT VARCHAR2(26) := 'GET_SUBSCR_LIC_OFFER';
14:33:53 2760  -- VARIABLES
14:33:53 2761  var_offer_chain NUMBER;
14:33:53 2762  -- EXCEPTIONS
14:33:53 2763  BAD_SUBSCRIPTION_ID EXCEPTION;
14:33:53 2764  BEGIN
14:33:53 2765  	 BEGIN
14:33:53 2766  	   SELECT
14:33:53 2767  	     SUBSCRIPTION.OFFER_CHAIN_ID into var_offer_chain
14:33:53 2768  	   FROM
14:33:53 2769  	     SUBSCRIPTION
14:33:53 2770  	   WHERE
14:33:53 2771  	     SUBSCRIPTION.ID = in_subscription_id;
14:33:53 2772  	   EXCEPTION
14:33:53 2773  	     WHEN NO_DATA_FOUND THEN
14:33:53 2774  	       RAISE BAD_SUBSCRIPTION_ID;
14:33:53 2775  	 END;
14:33:53 2776  
14:33:53 2777  	 OPEN out_result_set FOR
14:33:53 2778  	 SELECT DISTINCT
14:33:53 2779  	   po.ID po_id,
14:33:53 2780  	   po.PRODUCT_ID po_product_id,
14:33:53 2781  	   po.TAX_CATEGORY_ID po_tax_category_id,
14:33:53 2782  	   po.UNIT_PRICE po_unit_price,
14:33:53 2783  	   po.QUANTITY po_quantity,
14:33:53 2784  	   po.CREATE_DATE po_create_date,
14:33:53 2785  	   po.CREATED_BY po_created_by,
14:33:53 2786  	   l.ID l_id,
14:33:53 2787  	   l.license_status_id l_license_status_id,
14:33:53 2788  	   l.start_date l_start_date,
14:33:53 2789  	   l.offer_id l_offer_id,
14:33:53 2790  	   l.subscription_id l_subscription_id,
14:33:53 2791  	   l.invoice_id l_invoice_id,
14:33:53 2792  	   l.end_date l_end_date,
14:33:53 2793  	   l.entitlement_end_date l_entitlement_end_date,
14:33:53 2794  	   l.create_date l_create_date,
14:33:53 2795  	   l.created_by l_created_by,
14:33:53 2796  	   l.is_extension l_is_extension,
14:33:53 2797  	   l.current_offer_index l_current_offer_index,
14:33:53 2798  	   l.current_offer_recurr_num l_current_offer_recurr_num,
14:33:53 2799  	   l.needs_entitlements l_needs_entitlements
14:33:53 2800  	 FROM
14:33:53 2801  	   OFFER_PRODUCT_OFFERING opo,
14:33:53 2802  	   PRODUCT_OFFERING po,
14:33:53 2803  	   SUBSCRIPTION s,
14:33:53 2804  	   LICENSE l
14:33:53 2805  	 WHERE
14:33:53 2806  	   opo.product_offering_id = po.id
14:33:53 2807  	   and po.id = l.offer_id
14:33:53 2808  	   and l.subscription_id = s.id
14:33:53 2809  	   and l.license_status_id = GLOBAL_STATUSES_V22.LICENSE_ACTIVE
14:33:53 2810  	   and s.id = in_subscription_id
14:33:53 2811  	 ;
14:33:53 2812  EXCEPTION
14:33:53 2813  WHEN BAD_SUBSCRIPTION_ID THEN
14:33:53 2814  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 2815  	   SPROC_NAME, 'No such subscription');
14:33:53 2816  WHEN OTHERS THEN
14:33:53 2817  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 2818  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 2819  END GET_SUBSCR_LIC_OFFER;
14:33:53 2820  
14:33:53 2821  /******************************************************************************/
14:33:53 2822  
14:33:53 2823  PROCEDURE ARE_REFUNDS_PENDING_FOR_SUBSCR (
14:33:53 2824  /*
14:33:53 2825  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 2826  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 2827  */
14:33:53 2828  	 in_subscription_id IN NUMBER,
14:33:53 2829  	 out_result	    OUT NUMBER
14:33:53 2830  ) AS
14:33:53 2831  SPROC_NAME CONSTANT VARCHAR2(30) := 'ARE_REFUNDS_PENDING_FOR_SUBSCR';
14:33:53 2832  -- VARIABLES
14:33:53 2833  temp_subscription_id NUMBER;
14:33:53 2834  var_local_result     NUMBER;
14:33:53 2835  -- EXCEPTIONS
14:33:53 2836  BAD_SUBSCRIPTION_ID EXCEPTION;
14:33:53 2837  BEGIN
14:33:53 2838  
14:33:53 2839  	 -- Check that subscription exists
14:33:53 2840  	 BEGIN
14:33:53 2841  	   SELECT
14:33:53 2842  	     SUBSCRIPTION.ID into temp_subscription_id
14:33:53 2843  	   FROM
14:33:53 2844  	     SUBSCRIPTION
14:33:53 2845  	   WHERE
14:33:53 2846  	     SUBSCRIPTION.ID = in_subscription_id;
14:33:53 2847  	   EXCEPTION
14:33:53 2848  	     WHEN NO_DATA_FOUND THEN
14:33:53 2849  	       RAISE BAD_SUBSCRIPTION_ID;
14:33:53 2850  	 END;
14:33:53 2851  
14:33:53 2852  	 var_local_result := NULL;
14:33:53 2853  
14:33:53 2854  	 -- Check charges for each invoice associated with gived subscription
14:33:53 2855  	 FOR f_invoice IN (
14:33:53 2856  	   SELECT DISTINCT
14:33:53 2857  	     LICENSE.INVOICE_ID as "ID"
14:33:53 2858  	   FROM
14:33:53 2859  	     LICENSE
14:33:53 2860  	   WHERE
14:33:53 2861  	     LICENSE.SUBSCRIPTION_ID = in_subscription_id
14:33:53 2862  	     AND LICENSE.LICENSE_STATUS_ID IN ( SELECT GLOBAL_STATUSES_V22.LICENSE_ACTIVE FROM DUAL )
14:33:53 2863  	 )
14:33:53 2864  	 LOOP
14:33:53 2865  
14:33:53 2866  	   -- Check each charge in invoice
14:33:53 2867  	   FOR f_charge IN (
14:33:53 2868  	     SELECT
14:33:53 2869  	       CHARGE.ID,
14:33:53 2870  	       CHARGE.CHARGE_STATUS_ID,
14:33:53 2871  	       CHARGE.CHARGE_AMOUNT
14:33:53 2872  	     FROM
14:33:53 2873  	       CHARGE
14:33:53 2874  	     WHERE
14:33:53 2875  	       CHARGE.INVOICE_ID = f_invoice.ID
14:33:53 2876  	   )
14:33:53 2877  	   LOOP
14:33:53 2878  
14:33:53 2879  	     -- Charge amount < 0     => it is a refund
14:33:53 2880  	     -- Charge status is OPEN => means that it is not processed yet
14:33:53 2881  	     IF f_charge.CHARGE_AMOUNT < 0
14:33:53 2882  		AND f_charge.CHARGE_STATUS_ID = GLOBAL_STATUSES_V22.CHARGE_OPENED THEN
14:33:53 2883  	       var_local_result := GLOBAL_CONSTANTS_V22.TRUE;
14:33:53 2884  	     END IF;
14:33:53 2885  
14:33:53 2886  	   END LOOP;
14:33:53 2887  
14:33:53 2888  	 END LOOP;
14:33:53 2889  
14:33:53 2890  	 IF var_local_result IS NULL THEN
14:33:53 2891  	   out_result := GLOBAL_CONSTANTS_V22.FALSE;
14:33:53 2892  	 ELSE
14:33:53 2893  	   out_result := GLOBAL_CONSTANTS_V22.TRUE;
14:33:53 2894  	 END IF;
14:33:53 2895  
14:33:53 2896  EXCEPTION
14:33:53 2897  WHEN BAD_SUBSCRIPTION_ID THEN
14:33:53 2898  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 2899  	   SPROC_NAME, 'No such transaction id');
14:33:53 2900  WHEN OTHERS THEN
14:33:53 2901  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 2902  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 2903  END ARE_REFUNDS_PENDING_FOR_SUBSCR;
14:33:53 2904  
14:33:53 2905  PROCEDURE GET_EXISTING_SUBSCR_NUMBER (
14:33:53 2906  /*
14:33:53 2907  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 2908  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 2909  */
14:33:53 2910  	 in_group_id	    IN NUMBER,
14:33:53 2911  	 in_offer_chain_id  IN NUMBER,
14:33:53 2912  	 out_result	    OUT NUMBER
14:33:53 2913  ) AS
14:33:53 2914  SPROC_NAME CONSTANT VARCHAR2(28) := 'GET_EXISTING_SUBSCR_NUMBER';
14:33:53 2915  -- VARIABLES
14:33:53 2916  temp_acct_id	    NUMBER;
14:33:53 2917  temp_oc_id	    NUMBER;
14:33:53 2918  -- EXCEPTIONS
14:33:53 2919  BAD_GROUP_ID EXCEPTION;
14:33:53 2920  BAD_OFFER_CHAIN_ID EXCEPTION;
14:33:53 2921  BEGIN
14:33:53 2922  	 -- Check that group id exists
14:33:53 2923  	 BEGIN
14:33:53 2924  	   SELECT
14:33:53 2925  	     ACCOUNT.ID into temp_acct_id
14:33:53 2926  	   FROM
14:33:53 2927  	     ACCOUNT
14:33:53 2928  	   WHERE
14:33:53 2929  	     ACCOUNT.GROUP_ID = in_group_id;
14:33:53 2930  	   EXCEPTION
14:33:53 2931  	     WHEN NO_DATA_FOUND THEN
14:33:53 2932  	       RAISE BAD_GROUP_ID;
14:33:53 2933  	 END;
14:33:53 2934  	 -- Check that offer chain id exists
14:33:53 2935  	 BEGIN
14:33:53 2936  	   SELECT
14:33:53 2937  	     OFFER_CHAIN.ID into temp_oc_id
14:33:53 2938  	   FROM
14:33:53 2939  	     OFFER_CHAIN
14:33:53 2940  	   WHERE
14:33:53 2941  	     OFFER_CHAIN.ID = in_offer_chain_id;
14:33:53 2942  	   EXCEPTION
14:33:53 2943  	     WHEN NO_DATA_FOUND THEN
14:33:53 2944  	       RAISE BAD_OFFER_CHAIN_ID;
14:33:53 2945  	 END;
14:33:53 2946  	 SELECT
14:33:53 2947  	   COUNT(*) into out_result
14:33:53 2948  	 FROM
14:33:53 2949  	   SUBSCRIPTION
14:33:53 2950  	     INNER JOIN ACCOUNT ON SUBSCRIPTION.ACCOUNT_ID = ACCOUNT.ID
14:33:53 2951  	 WHERE
14:33:53 2952  	   ACCOUNT.GROUP_ID = in_group_id
14:33:53 2953  	   AND SUBSCRIPTION.OFFER_CHAIN_ID = in_offer_chain_id
14:33:53 2954  	   AND (
14:33:53 2955  	     SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE
14:33:53 2956  	     OR SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_IN_GRACE_PERIOD);
14:33:53 2957  
14:33:53 2958  EXCEPTION
14:33:53 2959  WHEN BAD_GROUP_ID THEN
14:33:53 2960  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 2961  	   SPROC_NAME, 'No such transaction id');
14:33:53 2962  WHEN BAD_OFFER_CHAIN_ID THEN
14:33:53 2963  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 2964  	   SPROC_NAME, 'No such offer chain id');
14:33:53 2965  WHEN OTHERS THEN
14:33:53 2966  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 2967  	   sproc_name, 'Unknown error', sqlerrm);
14:33:53 2968  END GET_EXISTING_SUBSCR_NUMBER;
14:33:53 2969  
14:33:53 2970  PROCEDURE GET_EXISTING_SUBSCR_IDS (
14:33:53 2971  /*
14:33:53 2972  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 2973  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 2974  */
14:33:53 2975  	 in_group_id	    IN NUMBER,
14:33:53 2976  	 in_offer_chain_id  IN NUMBER,
14:33:53 2977  	 out_result_set     OUT SYS_REFCURSOR
14:33:53 2978  ) AS
14:33:53 2979  SPROC_NAME CONSTANT VARCHAR2(26) := 'GET_EXISTING_SUBSCR_NUMBER';
14:33:53 2980  -- VARIABLES
14:33:53 2981  temp_acct_id	    NUMBER;
14:33:53 2982  temp_oc_id	    NUMBER;
14:33:53 2983  -- EXCEPTIONS
14:33:53 2984  BAD_GROUP_ID EXCEPTION;
14:33:53 2985  BAD_OFFER_CHAIN_ID EXCEPTION;
14:33:53 2986  BEGIN
14:33:53 2987  
14:33:53 2988  	 -- Check that group id exists
14:33:53 2989  	 BEGIN
14:33:53 2990  	   SELECT
14:33:53 2991  	     ACCOUNT.ID into temp_acct_id
14:33:53 2992  	   FROM
14:33:53 2993  	     ACCOUNT
14:33:53 2994  	   WHERE
14:33:53 2995  	     ACCOUNT.GROUP_ID = in_group_id;
14:33:53 2996  	   EXCEPTION
14:33:53 2997  	     WHEN NO_DATA_FOUND THEN
14:33:53 2998  	       RAISE BAD_GROUP_ID;
14:33:53 2999  	 END;
14:33:53 3000  	 -- Check that offer chain id exists
14:33:53 3001  	 BEGIN
14:33:53 3002  	   SELECT
14:33:53 3003  	     OFFER_CHAIN.ID into temp_oc_id
14:33:53 3004  	   FROM
14:33:53 3005  	     OFFER_CHAIN
14:33:53 3006  	   WHERE
14:33:53 3007  	     OFFER_CHAIN.ID = in_offer_chain_id;
14:33:53 3008  	   EXCEPTION
14:33:53 3009  	     WHEN NO_DATA_FOUND THEN
14:33:53 3010  	       RAISE BAD_OFFER_CHAIN_ID;
14:33:53 3011  	 END;
14:33:53 3012  
14:33:53 3013  	 OPEN out_result_set FOR
14:33:53 3014  	 SELECT
14:33:53 3015  	   SUBSCRIPTION.ID
14:33:53 3016  	 FROM
14:33:53 3017  	   SUBSCRIPTION
14:33:53 3018  	   INNER JOIN ACCOUNT ON SUBSCRIPTION.ACCOUNT_ID = ACCOUNT.ID
14:33:53 3019  	 WHERE
14:33:53 3020  	   ACCOUNT.GROUP_ID = in_group_id
14:33:53 3021  	   AND SUBSCRIPTION.OFFER_CHAIN_ID = in_offer_chain_id
14:33:53 3022  	   AND (
14:33:53 3023  	     SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE
14:33:53 3024  	     OR SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_IN_GRACE_PERIOD);
14:33:53 3025  
14:33:53 3026  EXCEPTION
14:33:53 3027  WHEN BAD_GROUP_ID THEN
14:33:53 3028  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 3029  	   SPROC_NAME, 'No such transaction id');
14:33:53 3030  WHEN BAD_OFFER_CHAIN_ID THEN
14:33:53 3031  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 3032  	   SPROC_NAME, 'No such offer chain id');
14:33:53 3033  WHEN OTHERS THEN
14:33:53 3034  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 3035  	   sproc_name, 'Unknown error', sqlerrm);
14:33:53 3036  END GET_EXISTING_SUBSCR_IDS;
14:33:53 3037  
14:33:53 3038  PROCEDURE ADD_META_DATA (
14:33:53 3039  /*
14:33:53 3040  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:53 3041  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 3042  */
14:33:53 3043  	 in_subscription_id IN NUMBER,
14:33:53 3044  	 in_name	    IN VARCHAR2,
14:33:53 3045  	 in_value	    IN VARCHAR2,
14:33:53 3046  	 in_created_by	    IN VARCHAR2
14:33:53 3047  ) AS
14:33:53 3048  SPROC_NAME CONSTANT VARCHAR2(13) := 'ADD_META_DATA';
14:33:53 3049  BEGIN
14:33:53 3050  
14:33:53 3051  	 INSERT INTO SUBSCRIPTION_META_DATA (
14:33:53 3052  	   ID,
14:33:53 3053  	   SUBSCRIPTION_ID,
14:33:53 3054  	   NAME,
14:33:53 3055  	   VALUE,
14:33:53 3056  	   CREATE_DATE,
14:33:53 3057  	   CREATED_BY
14:33:53 3058  	 ) VALUES (
14:33:53 3059  	   SUBMD_ID_SEQ.nextVal,
14:33:53 3060  	   in_subscription_id,
14:33:53 3061  	   in_name,
14:33:53 3062  	   in_value,
14:33:53 3063  	   sysdate,
14:33:53 3064  	   in_created_by
14:33:53 3065  	 );
14:33:53 3066  
14:33:53 3067  EXCEPTION
14:33:53 3068  WHEN OTHERS THEN
14:33:53 3069  	 IF SQLCODE = -2291 THEN
14:33:53 3070  	   PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:53 3071  	     SPROC_NAME, 'No such subscription');
14:33:53 3072  	 ELSE
14:33:53 3073  	   PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 3074  	     SPROC_NAME, 'Unknown error', sqlerrm);
14:33:53 3075  	 END IF;
14:33:53 3076  END ADD_META_DATA;
14:33:53 3077  
14:33:53 3078  /******************************************************************************/
14:33:53 3079  
14:33:53 3080  PROCEDURE GET_SUBSCRIPTIONS_META_DATA (
14:33:53 3081  /*
14:33:53 3082  APP_EXCEPTION_CODES_V22.INVALID_PARAMETER
14:33:53 3083  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 3084  */
14:33:53 3085  	 in_subscriptions_ids IN core_owner.NUMBER_TABLE,
14:33:53 3086  	 out_result_set       OUT SYS_REFCURSOR
14:33:53 3087  ) AS
14:33:53 3088  SPROC_NAME CONSTANT VARCHAR2(27) := 'GET_SUBSCRIPTIONS_META_DATA';
14:33:53 3089  -- Exceptions
14:33:53 3090  SUBSCRIPTION_IDS_IS_NULL EXCEPTION;
14:33:53 3091  BEGIN
14:33:53 3092  
14:33:53 3093  	 IF in_subscriptions_ids IS NULL THEN
14:33:53 3094  	   RAISE SUBSCRIPTION_IDS_IS_NULL;
14:33:53 3095  	 END IF;
14:33:53 3096  
14:33:53 3097  	 OPEN out_result_set FOR
14:33:53 3098  	 SELECT
14:33:53 3099  	   SMD.SUBSCRIPTION_ID,
14:33:53 3100  	   SMD.NAME,
14:33:53 3101  	   SMD.VALUE
14:33:53 3102  	 FROM
14:33:53 3103  	   SUBSCRIPTION_META_DATA SMD
14:33:53 3104  	 WHERE
14:33:53 3105  	   SMD.SUBSCRIPTION_ID IN (SELECT * FROM TABLE(in_subscriptions_ids));
14:33:53 3106  
14:33:53 3107  EXCEPTION
14:33:53 3108  WHEN SUBSCRIPTION_IDS_IS_NULL THEN
14:33:53 3109  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:53 3110  	   SPROC_NAME, 'Bad subscription ids parameter');
14:33:53 3111  WHEN OTHERS THEN
14:33:53 3112  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 3113  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:53 3114  END GET_SUBSCRIPTIONS_META_DATA;
14:33:53 3115  
14:33:53 3116  PROCEDURE GET_SUBS_BY_TRNS_ORDER_ID (
14:33:53 3117  /*
14:33:53 3118  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 3119  */
14:33:53 3120  	 in_order_id	    IN TRANSACTION.ORDER_ID%TYPE,
14:33:53 3121  	 out_result_set     OUT SYS_REFCURSOR
14:33:53 3122  ) AS
14:33:53 3123  SPROC_NAME CONSTANT VARCHAR2(25) := 'GET_SUBS_BY_TRNS_ORDER_ID';
14:33:53 3124  BEGIN
14:33:53 3125  	 OPEN out_result_set FOR
14:33:53 3126  	 SELECT subscription.id FROM
14:33:53 3127  	   subscription
14:33:53 3128  	 INNER JOIN license ON license.subscription_id = subscription.id
14:33:53 3129  	 INNER JOIN invoice ON invoice.id = license.invoice_id
14:33:53 3130  	 INNER JOIN charge ON invoice.id = charge.invoice_id
14:33:53 3131  	 INNER JOIN transaction ON charge.transaction_id = transaction.id
14:33:53 3132  	 WHERE transaction.order_id = in_order_id;
14:33:53 3133  EXCEPTION
14:33:53 3134  WHEN OTHERS THEN
14:33:53 3135  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 3136  	   SPROC_NAME, 'Unknown error', sqlerrm);
14:33:53 3137  END GET_SUBS_BY_TRNS_ORDER_ID;
14:33:53 3138  
14:33:53 3139  PROCEDURE GET_OPEN_CHARGES_BY_SUBID
14:33:53 3140  	(
14:33:53 3141  /*
14:33:53 3142  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:53 3143  */
14:33:53 3144  	 in_subscription_id  IN SUBSCRIPTION.ID%TYPE,
14:33:53 3145  	 out_result_set      OUT SYS_REFCURSOR
14:33:53 3146  )
14:33:53 3147  AS
14:33:53 3148  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_OPEN_CHARGES_BY_SUBID';
14:33:53 3149  BEGIN
14:33:53 3150  	 OPEN out_result_set FOR
14:33:53 3151  	 SELECT
14:33:53 3152  	   c.ID,
14:33:53 3153  	   c.TRANSACTION_ID,
14:33:53 3154  	   c.INSTRUMENT_ID,
14:33:53 3155  	   c.INSTRUMENT_TYPE_ID,
14:33:53 3156  	   c.CHARGE_AMOUNT,
14:33:53 3157  	   c.CREATE_DATE,
14:33:53 3158  	   c.CREATED_BY,
14:33:53 3159  	   c.INVOICE_ID
14:33:53 3160  	  FROM
14:33:53 3161  	   subscription s,
14:33:53 3162  	   license l,
14:33:53 3163  	   charge c
14:33:53 3164  	 WHERE
14:33:53 3165  	   s.id = l.subscription_id and
14:33:53 3166  	   l.invoice_id = c.invoice_id and
14:33:53 3167  	   c.charge_status_id = GLOBAL_STATUSES_V22.CHARGE_OPENED and
14:33:53 3168  	   exists (
14:33:53 3169  	     select null
14:33:53 3170  	     from transaction t
14:33:53 3171  	     where
14:33:53 3172  	       t.id = c.transaction_id
14:33:53 3173  	   ) and
14:33:53 3174  	   s.id = in_subscription_id;
14:33:53 3175  EXCEPTION
14:33:53 3176  WHEN OTHERS THEN
14:33:53 3177  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:53 3178  	   SPROC_NAME, 'Unknown error', sqlerrm);
14:33:53 3179  END GET_OPEN_CHARGES_BY_SUBID;
14:33:53 3180  
14:33:53 3181  FUNCTION GET_GIFT_CERT_ID_BY_SUB_ID (
14:33:53 3182  	 in_subscription_id IN SUBSCRIPTION.ID%TYPE
14:33:53 3183  ) RETURN NUMBER
14:33:53 3184  AS
14:33:53 3185  var_gift_certificate_id NUMBER;
14:33:53 3186  BEGIN
14:33:53 3187  	     SELECT id INTO var_gift_certificate_id
14:33:53 3188  	     FROM
14:33:53 3189  	       gift_certificate gc
14:33:53 3190  	     WHERE
14:33:53 3191  	       gc.finalized_invoice_id in (
14:33:53 3192  		 SELECT invoice_id
14:33:53 3193  		 FROM (
14:33:53 3194  		   SELECT l.invoice_id
14:33:53 3195  		   FROM
14:33:53 3196  		     license l
14:33:53 3197  		   WHERE
14:33:53 3198  		     l.subscription_id = in_subscription_id
14:33:53 3199  		   ORDER BY l.create_date asc
14:33:53 3200  		 )
14:33:53 3201  	       )
14:33:53 3202  	       and rownum <= 1;
14:33:53 3203  	     return var_gift_certificate_id;
14:33:53 3204  END GET_GIFT_CERT_ID_BY_SUB_ID;
14:33:53 3205  
14:33:53 3206  FUNCTION GET_GIFT_CERT_CODE_BY_SUB_ID (
14:33:53 3207  	 in_subscription_id IN SUBSCRIPTION.ID%TYPE
14:33:53 3208  ) RETURN VARCHAR2
14:33:53 3209  AS
14:33:53 3210  var_gift_certificate_code VARCHAR2(255 BYTE);
14:33:53 3211  BEGIN
14:33:53 3212  	     SELECT code INTO var_gift_certificate_code
14:33:53 3213  	     FROM
14:33:53 3214  	       gift_certificate gc
14:33:53 3215  	     WHERE
14:33:53 3216  	       gc.finalized_invoice_id in (
14:33:53 3217  		 SELECT invoice_id
14:33:53 3218  		 FROM (
14:33:53 3219  		   SELECT l.invoice_id
14:33:53 3220  		   FROM
14:33:53 3221  		     license l
14:33:53 3222  		   WHERE
14:33:53 3223  		     l.subscription_id = in_subscription_id
14:33:53 3224  		 )
14:33:53 3225  	       )
14:33:53 3226  	       and rownum <= 1;
14:33:53 3227  	     return var_gift_certificate_code;
14:33:53 3228  END GET_GIFT_CERT_CODE_BY_SUB_ID;
14:33:53 3229  
14:33:53 3230  PROCEDURE GET_ACTIVE_MEU_SUBS (
14:33:53 3231  	 out_result_set      OUT SYS_REFCURSOR
14:33:53 3232  )
14:33:53 3233  AS
14:33:53 3234  SPROC_NAME     CONSTANT VARCHAR2(19) := 'GET_ACTIVE_MEU_SUBS';
14:33:53 3235  BEGIN
14:33:53 3236  	 OPEN out_result_set FOR
14:33:53 3237  	       SELECT
14:33:53 3238  		   s.id,
14:33:53 3239  		   s.instrument_type_id,
14:33:53 3240  		   s.instrument_id,
14:33:53 3241  		   a.group_id,
14:33:53 3242  		   s.offer_chain_id
14:33:53 3243  	       FROM
14:33:53 3244  		   core_owner.subscription s,
14:33:53 3245  		   core_owner.account a
14:33:53 3246  	       WHERE
14:33:53 3247  		   a.id = s.account_id AND(
14:33:53 3248  		       s.offer_chain_id = 1745992781 OR
14:33:53 3249  		       s.offer_chain_id = 3902149773 OR
14:33:53 3250  		       s.offer_chain_id = 2240201337) AND
14:33:53 3251  		   NOT EXISTS
14:33:53 3252  		   (
14:33:53 3253  		       SELECT
14:33:53 3254  			   1
14:33:53 3255  		       FROM
14:33:53 3256  			   core_owner.subscription ss
14:33:53 3257  		       WHERE
14:33:53 3258  			   ss.account_id = a.id AND(
14:33:53 3259  			       ss.offer_chain_id = 2794122734 OR
14:33:53 3260  			       ss.offer_chain_id = 3564368005 OR
14:33:53 3261  			       ss.offer_chain_id = 757934392)) AND
14:33:53 3262  		   rownum < 5000;
14:33:53 3263  END GET_ACTIVE_MEU_SUBS;
14:33:53 3264  
14:33:53 3265  PROCEDURE GET_EARLIEST_ACTIVE_OFFER_ID (
14:33:53 3266  	 in_subscription_id  IN SUBSCRIPTION.ID%TYPE,
14:33:53 3267  	 out_offer_id	     OUT LICENSE.ID%TYPE
14:33:53 3268  )
14:33:53 3269  AS
14:33:53 3270  SPROC_NAME     CONSTANT VARCHAR2(28) := 'GET_EARLIEST_ACTIVE_OFFER_ID';
14:33:53 3271  BEGIN
14:33:53 3272  	 SELECT OFFER_ID INTO out_offer_id
14:33:53 3273  	 FROM LICENSE L,
14:33:53 3274  	 (
14:33:53 3275  	   SELECT MIN(ID) ID FROM LICENSE
14:33:53 3276  	   WHERE SUBSCRIPTION_ID = in_subscription_id
14:33:53 3277  	   AND LICENSE_STATUS_ID = 2
14:33:53 3278  	   AND SYSDATE BETWEEN START_DATE AND END_DATE
14:33:53 3279  	 ) EARLIEST_ACTIVE_LICENSE
14:33:53 3280  	 WHERE L.ID = EARLIEST_ACTIVE_LICENSE.ID;
14:33:53 3281  END GET_EARLIEST_ACTIVE_OFFER_ID;
14:33:53 3282  
14:33:53 3283  PROCEDURE GET_EARLIEST_ACTIVE_LICENSE_ID (
14:33:53 3284  	 in_subscription_id  IN SUBSCRIPTION.ID%TYPE,
14:33:53 3285  	 out_license_id      OUT LICENSE.ID%TYPE
14:33:53 3286  )
14:33:53 3287  AS
14:33:53 3288  SPROC_NAME     CONSTANT VARCHAR2(30) := 'GET_EARLIEST_ACTIVE_LICENSE_ID';
14:33:53 3289  BEGIN
14:33:53 3290  	 SELECT MIN(ID) into out_license_id
14:33:53 3291  	 FROM LICENSE
14:33:53 3292  	 WHERE SUBSCRIPTION_ID = in_subscription_id
14:33:53 3293  	   AND LICENSE_STATUS_ID = 2
14:33:53 3294  	 AND SYSDATE BETWEEN START_DATE AND END_DATE;
14:33:53 3295  END GET_EARLIEST_ACTIVE_LICENSE_ID;
14:33:53 3296  
14:33:53 3297  PROCEDURE GET_ACT_SUBS_W_CPT_CHARGEBACKS (
14:33:53 3298  	 out_result_set      OUT SYS_REFCURSOR
14:33:53 3299  )
14:33:53 3300  AS
14:33:53 3301  SPROC_NAME     CONSTANT VARCHAR2(30) := 'GET_ACT_SUBS_W_CPT_CHARGEBACKS';
14:33:53 3302  BEGIN
14:33:53 3303  	 OPEN out_result_set FOR
14:33:53 3304  	   SELECT
14:33:53 3305  	     s.id
14:33:53 3306  	   FROM
14:33:53 3307  	     core_owner.transaction t
14:33:53 3308  	   INNER JOIN
14:33:53 3309  	     core_owner.charge c
14:33:53 3310  	   ON
14:33:53 3311  	     c.transaction_id = t.id
14:33:53 3312  	   INNER JOIN
14:33:53 3313  	     core_owner.invoice i
14:33:53 3314  	   ON
14:33:53 3315  	     i.id = c.invoice_id
14:33:53 3316  	   INNER JOIN
14:33:53 3317  	     core_owner.license l
14:33:53 3318  	   ON
14:33:53 3319  	     i.id = l.invoice_id
14:33:53 3320  	   INNER JOIN
14:33:53 3321  	     core_owner.subscription s
14:33:53 3322  	   ON
14:33:53 3323  	     l.subscription_id = s.id
14:33:53 3324  	   INNER JOIN
14:33:53 3325  	     core_owner.account a
14:33:53 3326  	   ON
14:33:53 3327  	     s.account_id = a.id
14:33:53 3328  	   JOIN
14:33:53 3329  	     core_owner.rcn_cpt_chargeback_act_detail ccad
14:33:53 3330  	   ON
14:33:53 3331  	     t.order_id = ccad.merchant_order_number
14:33:53 3332  	   WHERE
14:33:53 3333  	     ccad.chargeback_category = 'RECD'
14:33:53 3334  	   AND s.subscription_status_id in (GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE, GLOBAL_STATUSES_V22.SUBSCRIPTION_IN_GRACE_PERIOD);
14:33:53 3335  END GET_ACT_SUBS_W_CPT_CHARGEBACKS;
14:33:53 3336  
14:33:53 3337  PROCEDURE GET_ACT_SUBS_W_PP_CHARGEBACKS (
14:33:53 3338  	 out_result_set      OUT SYS_REFCURSOR
14:33:53 3339  )
14:33:53 3340  AS
14:33:53 3341  SPROC_NAME     CONSTANT VARCHAR2(29) := 'GET_ACT_SUBS_W_PP_CHARGEBACKS';
14:33:53 3342  BEGIN
14:33:53 3343  	 OPEN out_result_set FOR
14:33:53 3344  	   SELECT
14:33:53 3345  	     s.id
14:33:53 3346  	   FROM
14:33:53 3347  	     core_owner.transaction t
14:33:53 3348  	   INNER JOIN
14:33:53 3349  	     core_owner.charge c
14:33:53 3350  	   ON
14:33:53 3351  	     c.transaction_id = t.id
14:33:53 3352  	   INNER JOIN
14:33:53 3353  	     core_owner.invoice i
14:33:53 3354  	   ON
14:33:53 3355  	     i.id = c.invoice_id
14:33:53 3356  	   INNER JOIN
14:33:53 3357  	     core_owner.license l
14:33:53 3358  	   ON
14:33:53 3359  	     i.id = l.invoice_id
14:33:53 3360  	   INNER JOIN
14:33:53 3361  	     core_owner.subscription s
14:33:53 3362  	   ON
14:33:53 3363  	     l.subscription_id = s.id
14:33:53 3364  	   INNER JOIN
14:33:53 3365  	     core_owner.account a
14:33:53 3366  	   ON
14:33:53 3367  	     s.account_id = a.id
14:33:53 3368  	   INNER JOIN
14:33:53 3369  	     core_owner.rcn_pp_trans_detail ptd
14:33:53 3370  	   ON
14:33:53 3371  	     t.order_id = ptd.invoice_id
14:33:53 3372  	   WHERE
14:33:53 3373  	     ptd.trans_status = 'D'
14:33:53 3374  	   AND s.subscription_status_id in (GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE, GLOBAL_STATUSES_V22.SUBSCRIPTION_IN_GRACE_PERIOD);
14:33:53 3375  END GET_ACT_SUBS_W_PP_CHARGEBACKS;
14:33:53 3376  
14:33:53 3377  PROCEDURE GET_GRACE_PERIOD_SUB_REGIS (
14:33:53 3378  	 in_max_days_until_close IN NUMBER,
14:33:53 3379  	 in_num_subs_to_fetch	 IN NUMBER,
14:33:53 3380  	 out_result_set 	 OUT SYS_REFCURSOR
14:33:53 3381  )
14:33:53 3382  AS
14:33:53 3383  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_GRACE_PERIOD_SUB_REGIS';
14:33:53 3384  BEGIN
14:33:53 3385  	 OPEN out_result_set FOR
14:33:53 3386  	 SELECT
14:33:53 3387  	     *
14:33:53 3388  	 FROM
14:33:53 3389  	     (
14:33:53 3390  		 SELECT
14:33:53 3391  		     a.group_id group_id,
14:33:53 3392  		     l.grace_end_date grace_end_date
14:33:53 3393  		 FROM
14:33:53 3394  		     license l
14:33:53 3395  		 JOIN
14:33:53 3396  		     subscription s
14:33:53 3397  		 ON
14:33:53 3398  		     s.id = l.subscription_id
14:33:53 3399  		 JOIN
14:33:53 3400  		     account a
14:33:53 3401  		 ON
14:33:53 3402  		     a.id = s.account_id
14:33:53 3403  		 WHERE
14:33:53 3404  		     l.license_status_id = GLOBAL_STATUSES_V22.LICENSE_IN_GRACE_PERIOD
14:33:53 3405  		 AND l.grace_end_date - SYSDATE <= in_max_days_until_close
14:33:53 3406  		 AND NOT EXISTS
14:33:53 3407  		     (
14:33:53 3408  			 SELECT
14:33:53 3409  			     NULL
14:33:53 3410  			 FROM
14:33:53 3411  			     process_retry_throttle
14:33:53 3412  			 WHERE
14:33:53 3413  			     process_name = sproc_name
14:33:53 3414  			 AND generic_id = a.group_id)
14:33:53 3415  		 AND rownum <= in_num_subs_to_fetch * 10
14:33:53 3416  		 ORDER BY
14:33:53 3417  		     dbms_random.value)
14:33:53 3418  	 WHERE
14:33:53 3419  	     rownum <= in_num_subs_to_fetch;
14:33:53 3420  END GET_GRACE_PERIOD_SUB_REGIS;
14:33:53 3421  
14:33:53 3422  PROCEDURE GET_ACT_SUBS_W_AMEX_CB (
14:33:53 3423  	 out_result_set      OUT SYS_REFCURSOR
14:33:53 3424  )
14:33:53 3425  AS
14:33:53 3426  SPROC_NAME     CONSTANT VARCHAR2(29) := 'GET_ACT_SUBS_W_AMEX_CB';
14:33:53 3427  BEGIN
14:33:53 3428  	 OPEN out_result_set FOR
14:33:53 3429  	   SELECT
14:33:53 3430  	     s.id
14:33:53 3431  	   FROM
14:33:53 3432  	     core_owner.transaction t
14:33:53 3433  	   INNER JOIN
14:33:53 3434  	     core_owner.charge c
14:33:53 3435  	   ON
14:33:53 3436  	     c.transaction_id = t.id
14:33:53 3437  	   INNER JOIN
14:33:53 3438  	     core_owner.invoice i
14:33:53 3439  	   ON
14:33:53 3440  	     i.id = c.invoice_id
14:33:53 3441  	   INNER JOIN
14:33:53 3442  	     core_owner.license l
14:33:53 3443  	   ON
14:33:53 3444  	     i.id = l.invoice_id
14:33:53 3445  	   INNER JOIN
14:33:53 3446  	     core_owner.subscription s
14:33:53 3447  	   ON
14:33:53 3448  	     l.subscription_id = s.id
14:33:53 3449  	   INNER JOIN
14:33:53 3450  	     core_owner.account a
14:33:53 3451  	   ON
14:33:53 3452  	     s.account_id = a.id
14:33:53 3453  	   INNER JOIN
14:33:53 3454  	     core_owner.rcn_amex_chargeback ac
14:33:53 3455  	   ON
14:33:53 3456  	     t.order_id = lower(ac.ind_ref_number)
14:33:53 3457  	   WHERE
14:33:53 3458  	     s.subscription_status_id in (GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE, GLOBAL_STATUSES_V22.SUBSCRIPTION_IN_GRACE_PERIOD);
14:33:53 3459  END GET_ACT_SUBS_W_AMEX_CB;
14:33:53 3460  
14:33:53 3461  END PROCS_SUBSCRIPTION_V22;
14:33:53 3462  .
14:33:53 SQL> /

Package body created.

Elapsed: 00:00:00.24
14:33:54 SQL> 
14:33:54 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_INVOICE_V22" AS
14:33:54   2  
14:33:54   3  PROCEDURE GET_INVOICE_IDS(
14:33:54   4  	in_group_id    IN ACCOUNT.GROUP_ID%TYPE,
14:33:54   5  	in_fin_id      IN SUBSCRIPTION.INSTRUMENT_ID%TYPE,
14:33:54   6  	out_result_set OUT SYS_REFCURSOR
14:33:54   7  ) AS
14:33:54   8  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_INVOICE_IDS';
14:33:54   9  BEGIN
14:33:54  10  	OPEN out_result_set FOR
14:33:54  11  	  SELECT
14:33:54  12  	    Invoice.ID
14:33:54  13  	  FROM
14:33:54  14  	      Invoice
14:33:54  15  	      INNER JOIN License
14:33:54  16  		ON
14:33:54  17  		  License.Invoice_Id = Invoice.Id
14:33:54  18  	      INNER JOIN Subscription
14:33:54  19  		ON
14:33:54  20  		  License.Subscription_Id = Subscription.Id
14:33:54  21  	      INNER JOIN account
14:33:54  22  		ON
14:33:54  23  		  Subscription.Account_Id = account.id
14:33:54  24  	  WHERE
14:33:54  25  	    Account.Group_Id = in_group_id
14:33:54  26  	    AND SUBSCRIPTION.INSTRUMENT_ID = in_fin_id
14:33:54  27  	    AND Invoice.Invoice_Status_Id = GLOBAL_STATUSES_V22.INVOICE_OPEN;
14:33:54  28  END GET_INVOICE_IDS;
14:33:54  29  
14:33:54  30  
14:33:54  31  PROCEDURE IS_INVOICE_FOR_GC (
14:33:54  32  	in_invoice_id IN NUMBER,
14:33:54  33  	out_result    OUT NUMBER
14:33:54  34  ) AS
14:33:54  35  SPROC_NAME CONSTANT VARCHAR2(32) := 'IS_INVOICE_FOR_GC';
14:33:54  36  var_is_for_gc NUMBER;
14:33:54  37  BEGIN
14:33:54  38  	SELECT
14:33:54  39  	  count(1) into var_is_for_gc
14:33:54  40  	FROM GIFT_CERTIFICATE GC
14:33:54  41  	WHERE GC.PURCHASE_INVOICE_ID = in_invoice_id;
14:33:54  42  
14:33:54  43  	IF var_is_for_gc > 0 THEN
14:33:54  44  	  out_result := 1;
14:33:54  45  	ELSE
14:33:54  46  	  out_result := 0;
14:33:54  47  	END IF;
14:33:54  48  END IS_INVOICE_FOR_GC;
14:33:54  49  
14:33:54  50  PROCEDURE CREATE_INVOICE(
14:33:54  51  /*
14:33:54  52  Throws exceptions:
14:33:54  53  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54  54  */
14:33:54  55  	  in_invoice_status IN NUMBER,
14:33:54  56  	  in_created_by     IN VARCHAR2,
14:33:54  57  	  in_tax_exempt_id  IN VARCHAR2,
14:33:54  58  	  out_invoice_id    OUT NUMBER
14:33:54  59  ) AS
14:33:54  60  -- VARIABLES
14:33:54  61  SPROC_NAME	 CONSTANT VARCHAR2(14) := 'CREATE_INVOICE';
14:33:54  62  var_new_invoice_id NUMBER;
14:33:54  63  -- EXCEPTIONS
14:33:54  64  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:54  65  BEGIN
14:33:54  66  
14:33:54  67  	PROCS_INVOICE_CRU_V22.CREATE_INVOICE(
14:33:54  68  	  out_invoice_id		 => var_new_invoice_id,
14:33:54  69  	  in_created_by 		 => in_created_by,
14:33:54  70  	  in_invoice_status_id		 => in_invoice_status,
14:33:54  71  	  in_tax_exempt_id		 => in_tax_exempt_id
14:33:54  72  	);
14:33:54  73  
14:33:54  74  	out_invoice_id := var_new_invoice_id;
14:33:54  75  
14:33:54  76  EXCEPTION
14:33:54  77  WHEN OTHERS THEN
14:33:54  78  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54  79  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54  80  END CREATE_INVOICE;
14:33:54  81  
14:33:54  82  /************************************************************/
14:33:54  83  
14:33:54  84  PROCEDURE GET_PENDING_INVOICES (
14:33:54  85  /*
14:33:54  86  Throws exceptions:
14:33:54  87  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54  88  */
14:33:54  89  	out_result_set	     OUT SYS_REFCURSOR,
14:33:54  90  	in_row_number	     IN NUMBER DEFAULT NULL
14:33:54  91  ) AS
14:33:54  92  SPROC_NAME CONSTANT VARCHAR2(20) := 'GET_PENDING_INVOICES';
14:33:54  93  -- COMSTANTS
14:33:54  94  DEFAULT_ROW_NUMBER CONSTANT NUMBER := 1;
14:33:54  95  -- VARIABLES
14:33:54  96  var_row_number NUMBER;
14:33:54  97  BEGIN
14:33:54  98  
14:33:54  99  	IF in_row_number IS NULL THEN
14:33:54 100  	  var_row_number := DEFAULT_ROW_NUMBER;
14:33:54 101  	ELSE
14:33:54 102  	  var_row_number := in_row_number;
14:33:54 103  	END IF;
14:33:54 104  
14:33:54 105  	-- Invoices with one or more payments(charges) with transaction status PENDING
14:33:54 106  	OPEN out_result_set FOR
14:33:54 107  SELECT * FROM
14:33:54 108  (
14:33:54 109  	SELECT
14:33:54 110  	  INVOICE.ID
14:33:54 111  	FROM
14:33:54 112  	  CHARGE
14:33:54 113  	  INNER JOIN INVOICE ON CHARGE.INVOICE_ID = INVOICE.ID
14:33:54 114  	WHERE
14:33:54 115  	  EXISTS(
14:33:54 116  	    SELECT NULL
14:33:54 117  	    FROM TRANSACTION
14:33:54 118  	    WHERE
14:33:54 119  	      TRANSACTION.TRANSACTION_STATUS_ID = GLOBAL_STATUSES_V22.TRANSACTION_PENDING
14:33:54 120  	      AND TRANSACTION.ID = CHARGE.TRANSACTION_ID
14:33:54 121  	      AND TRANSACTION.IS_REFUND != GLOBAL_CONSTANTS_V22.TRUE
14:33:54 122  	      AND TRANSACTION.TRANSACTION_AMOUNT >= 0
14:33:54 123  	  )
14:33:54 124  	  AND
14:33:54 125  	  NOT EXISTS(
14:33:54 126  	    SELECT NULL
14:33:54 127  	    FROM PROCESS_RETRY_THROTTLE
14:33:54 128  	    WHERE PROCESS_NAME = SPROC_NAME
14:33:54 129  	      AND GENERIC_ID = INVOICE.ID
14:33:54 130  	  )
14:33:54 131  	  AND ROWNUM <= var_row_number*10
14:33:54 132  	  ORDER BY dbms_random.value
14:33:54 133  ) WHERE
14:33:54 134  	  ROWNUM <= var_row_number;
14:33:54 135  
14:33:54 136  EXCEPTION
14:33:54 137  WHEN OTHERS THEN
14:33:54 138  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 139  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 140  END GET_PENDING_INVOICES;
14:33:54 141  
14:33:54 142  /************************************************************/
14:33:54 143  
14:33:54 144  FUNCTION F_CALCULATE_INVOICE_AMOUNT(
14:33:54 145  	in_invoice_id IN  NUMBER
14:33:54 146  ) RETURN NUMBER AS
14:33:54 147  var_amount NUMBER;
14:33:54 148  BEGIN
14:33:54 149  
14:33:54 150  	CALCULATE_INVOICE_AMOUNT(in_invoice_id, var_amount);
14:33:54 151  	RETURN var_amount;
14:33:54 152  
14:33:54 153  END;
14:33:54 154  
14:33:54 155  PROCEDURE CALCULATE_INVOICE_AMOUNT (
14:33:54 156  /*
14:33:54 157  Throws exceptions:
14:33:54 158  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 159  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 160  */
14:33:54 161  	in_invoice_id IN  NUMBER,
14:33:54 162  	out_amount    OUT NUMBER
14:33:54 163  ) AS
14:33:54 164  -- VARIABLES
14:33:54 165  SPROC_NAME	     CONSTANT VARCHAR2(24) := 'CALCULATE_INVOICE_AMOUNT';
14:33:54 166  temp_invoice_id	     NUMBER;
14:33:54 167  var_total_amount	     NUMBER(10,6);
14:33:54 168  var_final_amount	     NUMBER(10,2);
14:33:54 169  var_line_item_amount   NUMBER(10,6);
14:33:54 170  
14:33:54 171  var_line_items_set     SYS_REFCURSOR;
14:33:54 172  var_line_item_id	     NUMBER;
14:33:54 173  var_line_item_quantity NUMBER;
14:33:54 174  var_line_item_price    NUMBER (10,2);
14:33:54 175  
14:33:54 176  var_discount_fixed_amount NUMBER (10,2);
14:33:54 177  var_discount_percent_amount NUMBER (10,2);
14:33:54 178  
14:33:54 179  -- EXCEPTIONS
14:33:54 180  BAD_INVOICE_ID		    EXCEPTION;
14:33:54 181  CAN_NOT_CALC_LINE_ITEM_AMOUNT EXCEPTION;
14:33:54 182  EXCEPTION_MESSAGE VARCHAR2(1024);
14:33:54 183  BEGIN
14:33:54 184  
14:33:54 185  	var_total_amount := 0;
14:33:54 186  
14:33:54 187  	-- Check that given invoice exists
14:33:54 188  	BEGIN
14:33:54 189  	  SELECT
14:33:54 190  	    INVOICE.ID into temp_invoice_id
14:33:54 191  	  FROM
14:33:54 192  	    INVOICE
14:33:54 193  	  WHERE
14:33:54 194  	    INVOICE.ID = in_invoice_id
14:33:54 195  	    AND ROWNUM <= 1;
14:33:54 196  	  EXCEPTION
14:33:54 197  	    WHEN NO_DATA_FOUND THEN
14:33:54 198  	      RAISE BAD_INVOICE_ID;
14:33:54 199  	END;
14:33:54 200  
14:33:54 201  	-- Calculate amount for each line item in invoice
14:33:54 202  	FOR f_line_item IN (
14:33:54 203  	  SELECT
14:33:54 204  	    LINE_ITEM.ID
14:33:54 205  	  FROM
14:33:54 206  	    LINE_ITEM
14:33:54 207  	  WHERE
14:33:54 208  	    LINE_ITEM.INVOICE_ID = in_invoice_id
14:33:54 209  	)
14:33:54 210  	LOOP
14:33:54 211  	  BEGIN
14:33:54 212  	    PROCS_LINE_ITEMS_V22.CALCULATE_LINE_ITEM_AMOUNT(
14:33:54 213  	      in_line_item_id => f_line_item.ID,
14:33:54 214  	      out_amount      => var_line_item_amount
14:33:54 215  	    );
14:33:54 216  	    var_total_amount := var_total_amount + var_line_item_amount;
14:33:54 217  	    EXCEPTION
14:33:54 218  	      WHEN OTHERS THEN
14:33:54 219  		EXCEPTION_MESSAGE := SQLERRM;
14:33:54 220  		RAISE CAN_NOT_CALC_LINE_ITEM_AMOUNT;
14:33:54 221  	  END;
14:33:54 222  	END LOOP;
14:33:54 223  	var_final_amount := var_total_amount;
14:33:54 224  	out_amount := var_final_amount;
14:33:54 225  
14:33:54 226  EXCEPTION
14:33:54 227  WHEN BAD_INVOICE_ID THEN
14:33:54 228  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 229  	  SPROC_NAME, 'No such invoice');
14:33:54 230  WHEN CAN_NOT_CALC_LINE_ITEM_AMOUNT THEN
14:33:54 231  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 232  	  SPROC_NAME, 'Could not calculate line item amount', EXCEPTION_MESSAGE);
14:33:54 233  WHEN OTHERS THEN
14:33:54 234  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 235  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 236  END;
14:33:54 237  
14:33:54 238  PROCEDURE GET_ACCOUNT_BY_INVOICE_ID (
14:33:54 239  /*
14:33:54 240  Throws exceptions:
14:33:54 241  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 242  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 243  */
14:33:54 244  	in_invoice_id  IN  NUMBER,
14:33:54 245  	out_account_id OUT NUMBER
14:33:54 246  ) AS
14:33:54 247  -- VARIABLES
14:33:54 248  SPROC_NAME	 CONSTANT VARCHAR2(25) := 'GET_ACCOUNT_BY_INVOICE_ID';
14:33:54 249  temp_gc_account_id NUMBER;
14:33:54 250  temp_ss_account_id NUMBER;
14:33:54 251  temp_invoice_id	 NUMBER;
14:33:54 252  -- EXCEPTIONS
14:33:54 253  BAD_INVOICE_ID	   EXCEPTION;
14:33:54 254  CAN_NOT_FIND_ACCOUNT EXCEPTION;
14:33:54 255  BEGIN
14:33:54 256  
14:33:54 257  	-- Check that given invoice exists
14:33:54 258  	BEGIN
14:33:54 259  	  SELECT
14:33:54 260  	    INVOICE.ID into temp_invoice_id
14:33:54 261  	  FROM
14:33:54 262  	    INVOICE
14:33:54 263  	  WHERE
14:33:54 264  	    INVOICE.ID = in_invoice_id;
14:33:54 265  	  EXCEPTION
14:33:54 266  	    WHEN NO_DATA_FOUND THEN
14:33:54 267  	      RAISE BAD_INVOICE_ID;
14:33:54 268  	END;
14:33:54 269  
14:33:54 270  	-- Try to find gift certificate with given invoice
14:33:54 271  	BEGIN
14:33:54 272  	  SELECT
14:33:54 273  	    ACCOUNT.GROUP_ID into temp_gc_account_id
14:33:54 274  	  FROM
14:33:54 275  	    GIFT_CERTIFICATE
14:33:54 276  	    INNER JOIN ACCOUNT ON GIFT_CERTIFICATE.PURCHASER_GROUP_ID = ACCOUNT.GROUP_ID
14:33:54 277  	  WHERE
14:33:54 278  	    GIFT_CERTIFICATE.PURCHASE_INVOICE_ID = in_invoice_id
14:33:54 279  	    AND ROWNUM <= 1;
14:33:54 280  	  EXCEPTION
14:33:54 281  	    WHEN NO_DATA_FOUND THEN
14:33:54 282  	      temp_gc_account_id := NULL;
14:33:54 283  	END;
14:33:54 284  
14:33:54 285  	-- check subscriptions for given invoice
14:33:54 286  	IF temp_gc_account_id IS NOT NULL THEN
14:33:54 287  	  out_account_id := temp_gc_account_id;
14:33:54 288  	ELSE
14:33:54 289  	  BEGIN
14:33:54 290  	    SELECT
14:33:54 291  	      ACCOUNT.GROUP_ID into temp_ss_account_id
14:33:54 292  	    FROM
14:33:54 293  	      LICENSE
14:33:54 294  	      INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
14:33:54 295  	      INNER JOIN ACCOUNT ON SUBSCRIPTION.ACCOUNT_ID = ACCOUNT.ID
14:33:54 296  	    WHERE
14:33:54 297  	      LICENSE.INVOICE_ID = in_invoice_id
14:33:54 298  	      AND ROWNUM <= 1;
14:33:54 299  	    EXCEPTION
14:33:54 300  	      WHEN NO_DATA_FOUND THEN
14:33:54 301  		temp_ss_account_id := NULL;
14:33:54 302  	  END;
14:33:54 303  	  IF temp_ss_account_id IS NULL THEN
14:33:54 304  	    RAISE CAN_NOT_FIND_ACCOUNT;
14:33:54 305  	  ELSE
14:33:54 306  	    out_account_id := temp_ss_account_id;
14:33:54 307  	  END IF;
14:33:54 308  	END IF;
14:33:54 309  
14:33:54 310  EXCEPTION
14:33:54 311  WHEN BAD_INVOICE_ID THEN
14:33:54 312  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 313  	  SPROC_NAME, 'No such invoice');
14:33:54 314  WHEN CAN_NOT_FIND_ACCOUNT THEN
14:33:54 315  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 316  	  SPROC_NAME, 'Could not find account by given invoice id');
14:33:54 317  WHEN OTHERS THEN
14:33:54 318  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 319  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 320  END GET_ACCOUNT_BY_INVOICE_ID;
14:33:54 321  
14:33:54 322  /*****************************************************************/
14:33:54 323  
14:33:54 324  PROCEDURE GET_INVOICE_DETAILS (
14:33:54 325  /*
14:33:54 326  Throws exceptions:
14:33:54 327  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 328  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 329  */
14:33:54 330  	in_invoice_id	   IN  NUMBER,
14:33:54 331  	out_group_id	   OUT NUMBER,
14:33:54 332  	out_status_id	   OUT NUMBER,
14:33:54 333  	out_line_items_set OUT SYS_REFCURSOR,
14:33:54 334  	out_pp_charges_set OUT SYS_REFCURSOR,
14:33:54 335  	out_cc_charges_set OUT SYS_REFCURSOR,
14:33:54 336  	out_gc_charges_set OUT SYS_REFCURSOR
14:33:54 337  ) AS
14:33:54 338  -- VARIABLES
14:33:54 339  SPROC_NAME CONSTANT VARCHAR2(19) := 'GET_INVOICE_DETAILS';
14:33:54 340  
14:33:54 341  -- EXCEPTIONS
14:33:54 342  BAD_INVOICE_ID	     EXCEPTION;
14:33:54 343  CAN_NOT_FIND_ACCOUNT   EXCEPTION;
14:33:54 344  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:54 345  BEGIN
14:33:54 346  
14:33:54 347  	-- get invoice status
14:33:54 348  	BEGIN
14:33:54 349  	  SELECT
14:33:54 350  	    INVOICE.INVOICE_STATUS_ID into out_status_id
14:33:54 351  	  FROM
14:33:54 352  	    INVOICE
14:33:54 353  	  WHERE
14:33:54 354  	    INVOICE.ID = in_invoice_id;
14:33:54 355  	  EXCEPTION
14:33:54 356  	    WHEN NO_DATA_FOUND THEN
14:33:54 357  	      RAISE BAD_INVOICE_ID;
14:33:54 358  	END;
14:33:54 359  
14:33:54 360  	-- get group id
14:33:54 361  	BEGIN
14:33:54 362  	  PROCS_INVOICE_V22.GET_ACCOUNT_BY_INVOICE_ID(in_invoice_id, out_group_id);
14:33:54 363  	  EXCEPTION
14:33:54 364  	    WHEN OTHERS THEN
14:33:54 365  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:54 366  	      RAISE CAN_NOT_FIND_ACCOUNT;
14:33:54 367  	END;
14:33:54 368  
14:33:54 369  	-- get all line items for given invoice
14:33:54 370  	OPEN out_line_items_set FOR
14:33:54 371  	SELECT
14:33:54 372  	  LINE_ITEM.AMOUNT,
14:33:54 373  	  LINE_ITEM.ID,
14:33:54 374  	  LINE_ITEM.CREATED_BY,
14:33:54 375  	  LINE_ITEM.CREATE_DATE,
14:33:54 376  	  LINE_ITEM.DISCOUNT_AMOUNT,
14:33:54 377  	  LINE_ITEM.TAXES_AMOUNT,
14:33:54 378  	  LINE_ITEM.PRODUCT_OFFER_ID,
14:33:54 379  	  LINE_ITEM.INVOICE_ID
14:33:54 380  	FROM
14:33:54 381  	  LINE_ITEM
14:33:54 382  	WHERE
14:33:54 383  	  LINE_ITEM.INVOICE_ID = in_invoice_id;
14:33:54 384  
14:33:54 385  	-- get all pp charges for given invoice
14:33:54 386  	OPEN out_pp_charges_set FOR
14:33:54 387  	SELECT
14:33:54 388  	  CHARGE.ID as "CHARGE_ID",
14:33:54 389  	  CHARGE_AMOUNT,
14:33:54 390  	  CHARGE.INSTRUMENT_ID,
14:33:54 391  	  CHARGE.CHARGE_STATUS_ID
14:33:54 392  	FROM
14:33:54 393  	  CHARGE
14:33:54 394  	WHERE
14:33:54 395  	  CHARGE.INVOICE_ID = in_invoice_id
14:33:54 396  	  AND CHARGE.INSTRUMENT_TYPE_ID = GLOBAL_ENUMS_V22.INSTRUMENT_PAYPAL;
14:33:54 397  
14:33:54 398  	-- get all credir cards for given invoice
14:33:54 399  	OPEN out_cc_charges_set FOR
14:33:54 400  	SELECT
14:33:54 401  	  CHARGE.ID as "CHARGE_ID",
14:33:54 402  	  CHARGE.CHARGE_AMOUNT,
14:33:54 403  	  CHARGE.INSTRUMENT_ID,
14:33:54 404  	  CHARGE.CHARGE_STATUS_ID
14:33:54 405  	FROM
14:33:54 406  	  CHARGE
14:33:54 407  	WHERE
14:33:54 408  	  CHARGE.INVOICE_ID = in_invoice_id
14:33:54 409  	  AND CHARGE.INSTRUMENT_TYPE_ID = GLOBAL_ENUMS_V22.INSTRUMENT_CREDIT_CARD;
14:33:54 410  
14:33:54 411  	OPEN out_gc_charges_set FOR
14:33:54 412  	SELECT
14:33:54 413  	  CHARGE.ID as "CHARGE_ID",
14:33:54 414  	  CHARGE.CHARGE_AMOUNT,
14:33:54 415  	  CHARGE.INSTRUMENT_ID,
14:33:54 416  	  CHARGE.CHARGE_STATUS_ID
14:33:54 417  	FROM
14:33:54 418  	  CHARGE
14:33:54 419  	WHERE
14:33:54 420  	  CHARGE.INVOICE_ID = in_invoice_id
14:33:54 421  	  AND CHARGE.INSTRUMENT_TYPE_ID = GLOBAL_ENUMS_V22.INSTRUMENT_GIFT_CERTIFICATE;
14:33:54 422  
14:33:54 423  EXCEPTION
14:33:54 424  WHEN BAD_INVOICE_ID THEN
14:33:54 425  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 426  	  SPROC_NAME, 'No such invoice');
14:33:54 427  WHEN CAN_NOT_FIND_ACCOUNT THEN
14:33:54 428  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 429  	  SPROC_NAME, 'Could not find account for given invoice id', EXCEPTION_MESSAGE);
14:33:54 430  WHEN OTHERS THEN
14:33:54 431  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 432  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 433  END GET_INVOICE_DETAILS;
14:33:54 434  
14:33:54 435  /******************************************************/
14:33:54 436  -- norlov: #38796
14:33:54 437  PROCEDURE GET_TRANSACTION_INVOICE (
14:33:54 438  /*
14:33:54 439  Throws exceptions:
14:33:54 440  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 441  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 442  */
14:33:54 443  	in_transaction_id  IN  NUMBER,
14:33:54 444  	out_result_set	      OUT SYS_REFCURSOR
14:33:54 445  ) AS
14:33:54 446  SPROC_NAME CONSTANT  VARCHAR2(23) := 'GET_TRANSACTION_INVOICE';
14:33:54 447  -- VARIABLES
14:33:54 448  temp_transaction_id  NUMBER;
14:33:54 449  var_invoice_id	   NUMBER;
14:33:54 450  var_subscription_id  NUMBER;
14:33:54 451  var_offer_chain_id   NUMBER;
14:33:54 452  var_offer_chain_name VARCHAR2(255);
14:33:54 453  -- EXCEPTIONS
14:33:54 454  BAD_TRANSACTION_ID     EXCEPTION;
14:33:54 455  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:54 456  BEGIN
14:33:54 457   -- check if there is the transaction
14:33:54 458  	BEGIN
14:33:54 459  	  SELECT
14:33:54 460  	    TRANSACTION.ID into temp_transaction_id
14:33:54 461  	  FROM
14:33:54 462  	    TRANSACTION
14:33:54 463  	  WHERE
14:33:54 464  	    TRANSACTION.ID = in_transaction_id;
14:33:54 465  	  EXCEPTION
14:33:54 466  	    WHEN NO_DATA_FOUND THEN
14:33:54 467  	      RAISE BAD_TRANSACTION_ID;
14:33:54 468  	END;
14:33:54 469  
14:33:54 470  	-- Get invoice id
14:33:54 471  	SELECT DISTINCT
14:33:54 472  	  CHARGE.INVOICE_ID into var_invoice_id
14:33:54 473  	FROM
14:33:54 474  	  CHARGE
14:33:54 475  	WHERE
14:33:54 476  	  CHARGE.TRANSACTION_ID = in_transaction_id;
14:33:54 477  
14:33:54 478  	-- Get subscription id if exists
14:33:54 479  	BEGIN
14:33:54 480  	  SELECT DISTINCT
14:33:54 481  	    LICENSE.SUBSCRIPTION_ID into var_subscription_id
14:33:54 482  	  FROM
14:33:54 483  	    LICENSE
14:33:54 484  	  WHERE
14:33:54 485  	    LICENSE.INVOICE_ID = var_invoice_id;
14:33:54 486  	  EXCEPTION
14:33:54 487  	    WHEN NO_DATA_FOUND THEN
14:33:54 488  	      var_subscription_id := NULL;
14:33:54 489  	END;
14:33:54 490  
14:33:54 491  	IF var_subscription_id IS NOT NULL THEN
14:33:54 492  	  -- Fetch offer chain from subscription
14:33:54 493  	  SELECT
14:33:54 494  	    OFFER_CHAIN.ID,
14:33:54 495  	    OFFER_CHAIN.NAME
14:33:54 496  	    into
14:33:54 497  	    var_offer_chain_id,
14:33:54 498  	    var_offer_chain_name
14:33:54 499  	  FROM
14:33:54 500  	    OFFER_CHAIN
14:33:54 501  	    INNER JOIN SUBSCRIPTION ON SUBSCRIPTION.OFFER_CHAIN_ID = OFFER_CHAIN.ID
14:33:54 502  	  WHERE
14:33:54 503  	    SUBSCRIPTION.ID = var_subscription_id;
14:33:54 504  	ELSE
14:33:54 505  	  -- Fetch offer chain from GC
14:33:54 506  	  SELECT
14:33:54 507  	    OFFER_CHAIN.ID,
14:33:54 508  	    OFFER_CHAIN.NAME
14:33:54 509  	    into
14:33:54 510  	    var_offer_chain_id,
14:33:54 511  	    var_offer_chain_name
14:33:54 512  	  FROM
14:33:54 513  	    OFFER_CHAIN
14:33:54 514  	    INNER JOIN GIFT_CERTIFICATE ON GIFT_CERTIFICATE.OFFER_CHAIN_ID = OFFER_CHAIN.ID
14:33:54 515  	  WHERE
14:33:54 516  	    GIFT_CERTIFICATE.PURCHASE_INVOICE_ID = var_invoice_id;
14:33:54 517  	END IF;
14:33:54 518  
14:33:54 519  	OPEN out_result_set FOR
14:33:54 520  	SELECT DISTINCT
14:33:54 521  	  var_invoice_id       AS "INVOICE_ID",
14:33:54 522  	  var_subscription_id  AS "SUBSCRIPTION_ID",
14:33:54 523  	  var_offer_chain_id   AS "OFFER_CHAIN_ID",
14:33:54 524  	  var_offer_chain_name AS "OFFER_CHAIN_NAME"
14:33:54 525  	FROM
14:33:54 526  	  DUAL;
14:33:54 527  
14:33:54 528  EXCEPTION
14:33:54 529  WHEN BAD_TRANSACTION_ID THEN
14:33:54 530  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 531  	  SPROC_NAME, 'No such transaction');
14:33:54 532  WHEN OTHERS THEN
14:33:54 533  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 534  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 535  END GET_TRANSACTION_INVOICE;
14:33:54 536  
14:33:54 537  /******************************************************/
14:33:54 538  
14:33:54 539  PROCEDURE UPDATE_INVOICE_STATUS (
14:33:54 540  /*
14:33:54 541  Throws exceptions:
14:33:54 542  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 543  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 544  */
14:33:54 545  	in_invoice_id		       IN NUMBER,
14:33:54 546  	in_invoice_status_id	       IN NUMBER,
14:33:54 547  	in_updated_by		       IN VARCHAR2
14:33:54 548  ) AS
14:33:54 549  SPROC_NAME CONSTANT VARCHAR2(21) := 'UPDATE_INVOICE_STATUS';
14:33:54 550  -- VARIABLES
14:33:54 551  temp_invoice_id NUMBER;
14:33:54 552  -- EXCEPTIONS
14:33:54 553  BAD_INVOICE_ID		      EXCEPTION;
14:33:54 554  BAD_INVOICE_STATUS_ID	      EXCEPTION;
14:33:54 555  EXCEPTION_MESSAGE 	      VARCHAR2(1024);
14:33:54 556  BEGIN
14:33:54 557  
14:33:54 558  	-- Check if invoice exists
14:33:54 559  	BEGIN
14:33:54 560  	  SELECT
14:33:54 561  	    INVOICE.ID into temp_invoice_id
14:33:54 562  	  FROM
14:33:54 563  	    INVOICE
14:33:54 564  	  WHERE
14:33:54 565  	    INVOICE.ID = in_invoice_id;
14:33:54 566  	  EXCEPTION
14:33:54 567  	    WHEN NO_DATA_FOUND THEN
14:33:54 568  	      RAISE BAD_INVOICE_ID;
14:33:54 569  	END;
14:33:54 570  
14:33:54 571  	IF in_invoice_status_id != GLOBAL_STATUSES_V22.INVOICE_OPEN
14:33:54 572  	  AND in_invoice_status_id != GLOBAL_STATUSES_V22.INVOICE_CLOSED THEN
14:33:54 573  	  RAISE BAD_INVOICE_STATUS_ID;
14:33:54 574  	END IF;
14:33:54 575  
14:33:54 576  	PROCS_INVOICE_CRU_V22.UPDATE_INVOICE(
14:33:54 577  	  in_invoice_id 		 => in_invoice_id,
14:33:54 578  	  in_invoice_status_id		 => in_invoice_status_id,
14:33:54 579  	  in_updated_by 		 => in_updated_by
14:33:54 580  	);
14:33:54 581  
14:33:54 582  EXCEPTION
14:33:54 583  WHEN BAD_INVOICE_STATUS_ID THEN
14:33:54 584  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:54 585  	  SPROC_NAME, 'Bad invoice status id');
14:33:54 586  WHEN BAD_INVOICE_ID THEN
14:33:54 587  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 588  	  SPROC_NAME, 'No such invoice');
14:33:54 589  WHEN OTHERS THEN
14:33:54 590  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 591  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 592  END UPDATE_INVOICE_STATUS;
14:33:54 593  
14:33:54 594  /****************************************************************/
14:33:54 595  
14:33:54 596  FUNCTION IS_INVOICE_PAYING_STARTED (
14:33:54 597  /*
14:33:54 598  Throws exceptions:
14:33:54 599  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 600  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 601  */
14:33:54 602  	in_invoice_id IN NUMBER
14:33:54 603  ) RETURN NUMBER AS
14:33:54 604  -- VARIABLES
14:33:54 605  SPROC_NAME		 CONSTANT VARCHAR2(30) := 'IS_INVOICE_PAYING_STARTED';
14:33:54 606  temp_invoice_id		 NUMBER;
14:33:54 607  var_processed_charges_num  NUMBER;
14:33:54 608  var_processed_transac_num  NUMBER;
14:33:54 609  var_success_attempts_num	 NUMBER;
14:33:54 610  var_is_gc 		 NUMBER;
14:33:54 611  -- EXCEPTIONS
14:33:54 612  BAD_INVOICE_ID EXCEPTION;
14:33:54 613  BEGIN
14:33:54 614  
14:33:54 615  	-- Check that invoice exists
14:33:54 616  	BEGIN
14:33:54 617  	  SELECT
14:33:54 618  	    INVOICE.ID into temp_invoice_id
14:33:54 619  	  FROM
14:33:54 620  	    INVOICE
14:33:54 621  	  WHERE
14:33:54 622  	    INVOICE.ID = in_invoice_id;
14:33:54 623  	  EXCEPTION
14:33:54 624  	   WHEN NO_DATA_FOUND THEN
14:33:54 625  	     RAISE BAD_INVOICE_ID;
14:33:54 626  	END;
14:33:54 627  
14:33:54 628  	-- Check that there are tansaction attempts with status success
14:33:54 629  	SELECT
14:33:54 630  	  COUNT(1) into var_success_attempts_num
14:33:54 631  	FROM
14:33:54 632  	  TRANSACTION_ATTEMPT ta,
14:33:54 633  	  TRANSACTION t,
14:33:54 634  	  CHARGE c
14:33:54 635  	WHERE
14:33:54 636  	  ta.TRANSACTION_ATTEMPT_STATUS_ID = GLOBAL_STATUSES_V22.TRANS_ATTEMPT_SUCCESS and
14:33:54 637  	  ta.transaction_id = t.id and
14:33:54 638  	  c.transaction_id = t.id and
14:33:54 639  	  t.is_refund = GLOBAL_CONSTANTS_V22.FALSE and
14:33:54 640  	  c.invoice_id = in_invoice_id
14:33:54 641  	;
14:33:54 642  
14:33:54 643  	IF var_success_attempts_num > 0 THEN
14:33:54 644  	  RETURN GLOBAL_CONSTANTS_V22.TRUE;
14:33:54 645  	END IF;
14:33:54 646  
14:33:54 647  	SELECT
14:33:54 648  	  COUNT(1) into var_success_attempts_num
14:33:54 649  	FROM
14:33:54 650  	  TRANSACTION t,
14:33:54 651  	  CHARGE c
14:33:54 652  	WHERE
14:33:54 653  	  c.transaction_id = t.id and
14:33:54 654  	  t.is_refund = GLOBAL_CONSTANTS_V22.FALSE and
14:33:54 655  	  t.is_settled = GLOBAL_CONSTANTS_V22.TRUE and
14:33:54 656  	  c.invoice_id = in_invoice_id
14:33:54 657  	;
14:33:54 658  
14:33:54 659  	IF var_success_attempts_num > 0 THEN
14:33:54 660  	  RETURN GLOBAL_CONSTANTS_V22.TRUE;
14:33:54 661  	END IF;
14:33:54 662  
14:33:54 663  	SELECT
14:33:54 664  	  COUNT(1) into var_is_gc
14:33:54 665  	FROM
14:33:54 666  	  gift_certificate gc
14:33:54 667  	WHERE
14:33:54 668  	  gc.finalized_invoice_id = in_invoice_id
14:33:54 669  	;
14:33:54 670  
14:33:54 671  	IF var_is_gc > 0 THEN
14:33:54 672  	  RETURN GLOBAL_CONSTANTS_V22.TRUE;
14:33:54 673  	END IF;
14:33:54 674  
14:33:54 675  	RETURN GLOBAL_CONSTANTS_V22.FALSE;
14:33:54 676  
14:33:54 677  EXCEPTION
14:33:54 678  WHEN BAD_INVOICE_ID THEN
14:33:54 679  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 680  	  SPROC_NAME, 'No such invoice');
14:33:54 681  WHEN OTHERS THEN
14:33:54 682  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 683  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 684  END IS_INVOICE_PAYING_STARTED;
14:33:54 685  
14:33:54 686  /******************************************************************************/
14:33:54 687  
14:33:54 688  PROCEDURE P_IS_INVOICE_PAYING_STARTED (
14:33:54 689  	in_invoice_id  IN NUMBER,
14:33:54 690  	out_is_started OUT NUMBER
14:33:54 691  ) AS
14:33:54 692  BEGIN
14:33:54 693  	-- Just a wrapper
14:33:54 694  	out_is_started := PROCS_INVOICE_V22.IS_INVOICE_PAYING_STARTED(in_invoice_id);
14:33:54 695  END P_IS_INVOICE_PAYING_STARTED;
14:33:54 696  
14:33:54 697  /******************************************************************************/
14:33:54 698  
14:33:54 699  PROCEDURE CALCULATE_INVOICE_CHARGEBACK (
14:33:54 700  	in_invoice_id	      IN NUMBER,
14:33:54 701  	in_chargeback_date    IN DATE,
14:33:54 702  	out_chargeback_amount OUT NUMBER
14:33:54 703  ) AS
14:33:54 704  -- VARIABLES
14:33:54 705  SPROC_NAME	     CONSTANT VARCHAR2(28) := 'CALCULATE_INVOICE_CHARGEBACK';
14:33:54 706  var_chargeback_date    DATE;
14:33:54 707  temp_invoice_id	     NUMBER;
14:33:54 708  var_licenses_number    NUMBER;
14:33:54 709  var_invoice_start_date DATE;
14:33:54 710  var_invoice_end_date   DATE;
14:33:54 711  var_offer_id	     NUMBER;
14:33:54 712  var_offer_days_interval NUMBER;
14:33:54 713  var_license_days_used  NUMBER;
14:33:54 714  var_invoice_amount     NUMBER(10,2);
14:33:54 715  var_offer_chain_id     NUMBER;
14:33:54 716  var_offer_chain_meta_data_val VARCHAR2(1024);
14:33:54 717  var_offer_chain_full_refund   NUMBER;
14:33:54 718  var_offer_chain_prorated_ref  NUMBER;
14:33:54 719  var_chargeback_calculated NUMBER;
14:33:54 720  var_max_invoice_refund	NUMBER;
14:33:54 721  -- EXCEPTIONS
14:33:54 722  BAD_INVOICE_ID		  EXCEPTION;
14:33:54 723  NO_LICENSES_FOUND_EXCEPTION EXCEPTION;
14:33:54 724  OFFER_LENGTH_IS_ZERO	  EXCEPTION;
14:33:54 725  BEGIN
14:33:54 726  
14:33:54 727  	IF in_chargeback_date IS NULL THEN
14:33:54 728  	  var_chargeback_date := PROCS_COMMON_V22.NORMALIZE_DATE(current_date);
14:33:54 729  	ELSE
14:33:54 730  	  var_chargeback_date := PROCS_COMMON_V22.NORMALIZE_DATE(in_chargeback_date);
14:33:54 731  	END IF;
14:33:54 732  
14:33:54 733  	-- Check that invoice exists
14:33:54 734  	BEGIN
14:33:54 735  	  SELECT
14:33:54 736  	    INVOICE.ID into temp_invoice_id
14:33:54 737  	  FROM
14:33:54 738  	    INVOICE
14:33:54 739  	  WHERE
14:33:54 740  	    INVOICE.ID = in_invoice_id;
14:33:54 741  	  EXCEPTION
14:33:54 742  	    WHEN NO_DATA_FOUND THEN
14:33:54 743  	      RAISE BAD_INVOICE_ID;
14:33:54 744  	END;
14:33:54 745  
14:33:54 746  	-- Check that invoice has at least one license
14:33:54 747  	SELECT
14:33:54 748  	  COUNT(*) into var_licenses_number
14:33:54 749  	FROM
14:33:54 750  	  LICENSE
14:33:54 751  	WHERE
14:33:54 752  	  LICENSE.INVOICE_ID = in_invoice_id;
14:33:54 753  
14:33:54 754  	IF var_licenses_number = 0 THEN
14:33:54 755  	  RAISE NO_LICENSES_FOUND_EXCEPTION;
14:33:54 756  	END IF;
14:33:54 757  
14:33:54 758  	SELECT
14:33:54 759  	  MIN(LICENSE.START_DATE) into var_invoice_start_date
14:33:54 760  	FROM
14:33:54 761  	  LICENSE
14:33:54 762  	WHERE
14:33:54 763  	  LICENSE.INVOICE_ID = in_invoice_id;
14:33:54 764  
14:33:54 765  	var_invoice_start_date := PROCS_COMMON_V22.NORMALIZE_DATE(var_invoice_start_date);
14:33:54 766  
14:33:54 767  	SELECT DISTINCT
14:33:54 768  	  LICENSE.OFFER_ID into var_offer_id
14:33:54 769  	FROM
14:33:54 770  	  LICENSE
14:33:54 771  	WHERE
14:33:54 772  	  LICENSE.INVOICE_ID = in_invoice_id;
14:33:54 773  
14:33:54 774  	SELECT
14:33:54 775  	  MAX (LICENSE.END_DATE) into var_invoice_end_date
14:33:54 776  	FROM
14:33:54 777  	  LICENSE
14:33:54 778  	WHERE
14:33:54 779  	  LICENSE.INVOICE_ID = in_invoice_id;
14:33:54 780  
14:33:54 781  	-- All licenses for given invoice should point into the same offer
14:33:54 782  
14:33:54 783  	PROCS_OFFER_CHAIN_V22.GET_OFFER_LENGTH_IN_DAYS(
14:33:54 784  	  in_offer_id	=> var_offer_id,
14:33:54 785  	  in_start_date => var_invoice_start_date,
14:33:54 786  	  out_days	=> var_offer_days_interval
14:33:54 787  	);
14:33:54 788  
14:33:54 789  	IF var_offer_days_interval = 0 THEN
14:33:54 790  	  RAISE OFFER_LENGTH_IS_ZERO;
14:33:54 791  	END IF;
14:33:54 792  
14:33:54 793  	PROCS_INVOICE_V22.GET_INVOICE_DAYS_USED_NUMBER(
14:33:54 794  	  in_invoice_id      => in_invoice_id,
14:33:54 795  	  in_chargeback_date => var_chargeback_date,
14:33:54 796  	  out_days_num	     => var_license_days_used
14:33:54 797  	);
14:33:54 798  
14:33:54 799  	PROCS_INVOICE_V22.CALCULATE_INVOICE_AMOUNT(
14:33:54 800  	  in_invoice_id => in_invoice_id,
14:33:54 801  	  out_amount	=> var_invoice_amount
14:33:54 802  	);
14:33:54 803  
14:33:54 804  	-- 39437
14:33:54 805  	-- Get offer chain id by invoice id
14:33:54 806  	SELECT DISTINCT
14:33:54 807  	  SUBSCRIPTION.OFFER_CHAIN_ID into var_offer_chain_id
14:33:54 808  	FROM
14:33:54 809  	  SUBSCRIPTION
14:33:54 810  	  INNER JOIN LICENSE ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
14:33:54 811  	WHERE
14:33:54 812  	  LICENSE.INVOICE_ID = in_invoice_id;
14:33:54 813  
14:33:54 814  	-- Get offer chain's meta data full amount value
14:33:54 815  	PROCS_OFFER_CHAIN_V22.GET_OFFER_CHAIN_MD_VALUE(
14:33:54 816  	  in_offer_chain_id => var_offer_chain_id,
14:33:54 817  	  in_meta_data_name => GLOBAL_CONSTANTS_V22.OFFER_CHAIN_FULL_REFUND,
14:33:54 818  	  out_value	    => var_offer_chain_meta_data_val
14:33:54 819  	);
14:33:54 820  	IF var_offer_chain_meta_data_val IS NULL THEN
14:33:54 821  	  var_offer_chain_full_refund := NULL;
14:33:54 822  	ELSE
14:33:54 823  	  var_offer_chain_full_refund := TO_NUMBER(var_offer_chain_meta_data_val);
14:33:54 824  	END IF;
14:33:54 825  
14:33:54 826  	-- Get offer chain's meta data prorated amount value
14:33:54 827  	PROCS_OFFER_CHAIN_V22.GET_OFFER_CHAIN_MD_VALUE(
14:33:54 828  	  in_offer_chain_id => var_offer_chain_id,
14:33:54 829  	  in_meta_data_name => GLOBAL_CONSTANTS_V22.OFFER_CHAIN_PRORATED_REFUND,
14:33:54 830  	  out_value	    => var_offer_chain_meta_data_val
14:33:54 831  	);
14:33:54 832  	IF var_offer_chain_meta_data_val IS NULL THEN
14:33:54 833  	  var_offer_chain_prorated_ref := NULL;
14:33:54 834  	ELSE
14:33:54 835  	  var_offer_chain_prorated_ref := TO_NUMBER(var_offer_chain_meta_data_val);
14:33:54 836  	END IF;
14:33:54 837  
14:33:54 838  	var_chargeback_calculated := GLOBAL_CONSTANTS_V22.FALSE;
14:33:54 839  
14:33:54 840  	IF var_offer_chain_full_refund IS NOT NULL
14:33:54 841  	   AND var_chargeback_calculated = GLOBAL_CONSTANTS_V22.FALSE THEN
14:33:54 842  	  IF var_license_days_used < var_offer_chain_full_refund THEN
14:33:54 843  	    out_chargeback_amount := var_invoice_amount;
14:33:54 844  	    var_chargeback_calculated := GLOBAL_CONSTANTS_V22.TRUE;
14:33:54 845  	  END IF;
14:33:54 846  	END IF;
14:33:54 847  
14:33:54 848  	IF var_offer_chain_prorated_ref IS NOT NULL
14:33:54 849  	   AND var_chargeback_calculated = GLOBAL_CONSTANTS_V22.FALSE THEN
14:33:54 850  	  IF var_license_days_used < var_offer_chain_prorated_ref THEN
14:33:54 851  	    out_chargeback_amount := ( var_invoice_amount * (var_offer_days_interval - var_license_days_used) ) / var_offer_days_interval;
14:33:54 852  	    var_chargeback_calculated := GLOBAL_CONSTANTS_V22.TRUE;
14:33:54 853  	  END IF;
14:33:54 854  	END IF;
14:33:54 855  
14:33:54 856  	IF var_chargeback_calculated = GLOBAL_CONSTANTS_V22.TRUE THEN
14:33:54 857  	  PROCS_INVOICE_V22.GET_MAX_REFUND(
14:33:54 858  	    in_invoice_id => in_invoice_id,
14:33:54 859  	    out_amount	  => var_max_invoice_refund
14:33:54 860  	  );
14:33:54 861  	  IF var_max_invoice_refund < out_chargeback_amount THEN
14:33:54 862  	    out_chargeback_amount := var_max_invoice_refund;
14:33:54 863  	  END IF;
14:33:54 864  	END IF;
14:33:54 865  
14:33:54 866  	IF var_chargeback_calculated = GLOBAL_CONSTANTS_V22.FALSE THEN
14:33:54 867  	  out_chargeback_amount := 0;
14:33:54 868  	END IF;
14:33:54 869  
14:33:54 870  EXCEPTION
14:33:54 871  WHEN BAD_INVOICE_ID THEN
14:33:54 872  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 873  	  SPROC_NAME, 'No such invoice');
14:33:54 874  WHEN NO_LICENSES_FOUND_EXCEPTION THEN
14:33:54 875  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 876  	  SPROC_NAME, 'No licenses found');
14:33:54 877  WHEN OFFER_LENGTH_IS_ZERO THEN
14:33:54 878  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 879  	  SPROC_NAME, 'Offer length is zero');
14:33:54 880  WHEN OTHERS THEN
14:33:54 881  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 882  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 883  END CALCULATE_INVOICE_CHARGEBACK;
14:33:54 884  
14:33:54 885  /********************************************************************/
14:33:54 886  
14:33:54 887  PROCEDURE APPLY_REFUND (
14:33:54 888  	in_invoice_id	     IN NUMBER,
14:33:54 889  	in_chargeback_amount IN NUMBER,
14:33:54 890  	in_created_by	     IN VARCHAR2,
14:33:54 891  	out_charge_id	     OUT NUMBER
14:33:54 892  ) AS
14:33:54 893  -- VARIABLES
14:33:54 894  SPROC_NAME		 CONSTANT VARCHAR2(16) := 'APPLY_CHARGEBACK';
14:33:54 895  temp_invoice_id		 NUMBER;
14:33:54 896  var_total_charges_amount	 NUMBER(10,2);
14:33:54 897  var_charge_amount_to_apply NUMBER(10,2);
14:33:54 898  var_transaction_id	 NUMBER;
14:33:54 899  var_instrument_type_id	 NUMBER;
14:33:54 900  var_instrument_id 	 NUMBER;
14:33:54 901  var_charge_id		 NUMBER;
14:33:54 902  -- EXCEPTIONS
14:33:54 903  BAD_INVOICE_ID		 EXCEPTION;
14:33:54 904  CAN_NOT_CREATE_TRANSACTION EXCEPTION;
14:33:54 905  CAN_NOT_FIND_INSTRUMENT	 EXCEPTION;
14:33:54 906  CAN_NOT_CREATE_CHARGE	 EXCEPTION;
14:33:54 907  EXCEPTION_MESSAGE 	 VARCHAR2(1024);
14:33:54 908  BEGIN
14:33:54 909  
14:33:54 910  	BEGIN
14:33:54 911  	  SELECT
14:33:54 912  	    INVOICE.ID into temp_invoice_id
14:33:54 913  	  FROM
14:33:54 914  	    INVOICE
14:33:54 915  	  WHERE
14:33:54 916  	    INVOICE.ID = in_invoice_id;
14:33:54 917  	  EXCEPTION
14:33:54 918  	    WHEN NO_DATA_FOUND THEN
14:33:54 919  	      RAISE BAD_INVOICE_ID;
14:33:54 920  	END;
14:33:54 921  
14:33:54 922  	SELECT
14:33:54 923  	  SUM (CHARGE.CHARGE_AMOUNT) into var_total_charges_amount
14:33:54 924  	FROM
14:33:54 925  	  CHARGE
14:33:54 926  	WHERE
14:33:54 927  	  CHARGE.INVOICE_ID = in_invoice_id
14:33:54 928  	  AND CHARGE.CHARGE_STATUS_ID = GLOBAL_STATUSES_V22.CHARGE_PROCESSED
14:33:54 929  	  AND CHARGE.INSTRUMENT_TYPE_ID != GLOBAL_ENUMS_V22.INSTRUMENT_GIFT_CERTIFICATE;
14:33:54 930  
14:33:54 931  	-- FIXME: Maybe whe should throw exception here?
14:33:54 932  	IF var_total_charges_amount < in_chargeback_amount THEN
14:33:54 933  	  var_charge_amount_to_apply := var_total_charges_amount;
14:33:54 934  	ELSE
14:33:54 935  	  var_charge_amount_to_apply := in_chargeback_amount;
14:33:54 936  	END IF;
14:33:54 937  
14:33:54 938  	BEGIN
14:33:54 939  	  PROCS_TRANSACTION_V22.CREATE_TRANSACTION(
14:33:54 940  	    in_transaction_id	      => NULL,
14:33:54 941  	    in_status_id	      => GLOBAL_STATUSES_V22.TRANSACTION_PREPARE,
14:33:54 942  	    in_amount		      => -var_charge_amount_to_apply,
14:33:54 943  	    in_created_by	      => in_created_by,
14:33:54 944  	    in_order_id 	      => NULL,
14:33:54 945  	    in_is_refund	      => GLOBAL_CONSTANTS_V22.TRUE,
14:33:54 946  	    in_transaction_type_code  => 'REFUND',
14:33:54 947  	    out_transaction_id	      => var_transaction_id
14:33:54 948  	  );
14:33:54 949  	  EXCEPTION
14:33:54 950  	    WHEN OTHERS THEN
14:33:54 951  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:54 952  	      RAISE CAN_NOT_CREATE_TRANSACTION;
14:33:54 953  	END;
14:33:54 954  
14:33:54 955  	BEGIN
14:33:54 956  	  SELECT
14:33:54 957  	    C.INSTRUMENT_TYPE_ID,
14:33:54 958  	    C.INSTRUMENT_ID
14:33:54 959  	    into
14:33:54 960  	    var_instrument_type_id,
14:33:54 961  	    var_instrument_id
14:33:54 962  	  FROM
14:33:54 963  	    CHARGE C,
14:33:54 964  	    TRANSACTION_ATTEMPT TA,
14:33:54 965  	    TRANSACTION T
14:33:54 966  	  WHERE
14:33:54 967  	    C.INVOICE_ID = in_invoice_id and
14:33:54 968  	    C.TRANSACTION_ID = T.ID and
14:33:54 969  	    TA.TRANSACTION_ID = T.ID and
14:33:54 970  	    TA.TRANSACTION_ATTEMPT_STATUS_ID = GLOBAL_STATUSES_V22.TRANS_ATTEMPT_SUCCESS and
14:33:54 971  	    T.IS_REFUND = GLOBAL_CONSTANTS_V22.FALSE and
14:33:54 972  	    T.TRANSACTION_AMOUNT >= 0 and
14:33:54 973  	    rownum < 2;
14:33:54 974  	EXCEPTION
14:33:54 975  	    WHEN NO_DATA_FOUND THEN
14:33:54 976  	      RAISE CAN_NOT_FIND_INSTRUMENT;
14:33:54 977  	END;
14:33:54 978  	BEGIN
14:33:54 979  	  PROCS_CHARGE_V22.CREATE_CHARGE(
14:33:54 980  	    in_invoice_id	  => in_invoice_id,
14:33:54 981  	    in_transaction_id	  => var_transaction_id,
14:33:54 982  	    in_instrument_type_id => var_instrument_type_id,
14:33:54 983  	    in_instrument_id	  => var_instrument_id,
14:33:54 984  	    in_charge_amount	  => -var_charge_amount_to_apply,
14:33:54 985  	    in_created_by	  => in_created_by,
14:33:54 986  	    in_charge_status_id   => GLOBAL_STATUSES_V22.CHARGE_OPENED,
14:33:54 987  	    out_charge_id	  => var_charge_id
14:33:54 988  	  );
14:33:54 989  	  EXCEPTION
14:33:54 990  	    WHEN OTHERS THEN
14:33:54 991  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:54 992  	      RAISE CAN_NOT_CREATE_CHARGE;
14:33:54 993  	END;
14:33:54 994  
14:33:54 995  	out_charge_id := var_charge_id;
14:33:54 996  
14:33:54 997  EXCEPTION
14:33:54 998  WHEN BAD_INVOICE_ID THEN
14:33:54 999  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1000  	   SPROC_NAME, 'No such invoice');
14:33:54 1001  WHEN CAN_NOT_CREATE_TRANSACTION THEN
14:33:54 1002  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 1003  	   SPROC_NAME, 'Could not create transaction', EXCEPTION_MESSAGE);
14:33:54 1004  WHEN CAN_NOT_FIND_INSTRUMENT THEN
14:33:54 1005  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1006  	   SPROC_NAME, 'Could not find financial instrument');
14:33:54 1007  WHEN CAN_NOT_CREATE_CHARGE THEN
14:33:54 1008  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 1009  	   SPROC_NAME, 'Could not create charge', EXCEPTION_MESSAGE);
14:33:54 1010  WHEN OTHERS THEN
14:33:54 1011  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1012  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1013  END APPLY_REFUND;
14:33:54 1014  
14:33:54 1015  /******************************************************************************/
14:33:54 1016  
14:33:54 1017  PROCEDURE GET_MAX_REFUND (
14:33:54 1018  	 in_invoice_id IN NUMBER,
14:33:54 1019  	 out_amount    OUT NUMBER
14:33:54 1020  ) AS
14:33:54 1021  SPROC_NAME CONSTANT VARCHAR2(14) := 'GET_MAX_REFUND';
14:33:54 1022  -- VARIABLES
14:33:54 1023  temp_invoice_id	       NUMBER;
14:33:54 1024  var_invoice_refunds_sum NUMBER(10,2);
14:33:54 1025  var_invoice_charges_sum NUMBER(10,2);
14:33:54 1026  -- EXCEPTIONS
14:33:54 1027  BAD_INVOICE_ID EXCEPTION;
14:33:54 1028  BEGIN
14:33:54 1029  
14:33:54 1030  	 BEGIN
14:33:54 1031  	   SELECT
14:33:54 1032  	     INVOICE.ID into temp_invoice_id
14:33:54 1033  	   FROM
14:33:54 1034  	     INVOICE
14:33:54 1035  	   WHERE
14:33:54 1036  	     INVOICE.ID = in_invoice_id;
14:33:54 1037  	   EXCEPTION
14:33:54 1038  	     WHEN NO_DATA_FOUND THEN
14:33:54 1039  	       RAISE BAD_INVOICE_ID;
14:33:54 1040  	 END;
14:33:54 1041  
14:33:54 1042  	 var_invoice_refunds_sum := 0;
14:33:54 1043  	 var_invoice_charges_sum := 0;
14:33:54 1044  
14:33:54 1045  	 FOR f_charge IN (
14:33:54 1046  	   SELECT
14:33:54 1047  	     CHARGE.ID,
14:33:54 1048  	     CHARGE.CHARGE_STATUS_ID,
14:33:54 1049  	     CHARGE.CHARGE_AMOUNT,
14:33:54 1050  	     CHARGE.TRANSACTION_ID
14:33:54 1051  	   FROM
14:33:54 1052  	     CHARGE
14:33:54 1053  	   WHERE
14:33:54 1054  	     CHARGE.INVOICE_ID = in_invoice_id
14:33:54 1055  	 )
14:33:54 1056  	 LOOP
14:33:54 1057  	   -- If charge.status = canceled then continue
14:33:54 1058  	   IF f_charge.CHARGE_STATUS_ID != GLOBAL_STATUSES_V22.CHARGE_CANCELED THEN
14:33:54 1059  
14:33:54 1060  	     IF f_charge.CHARGE_AMOUNT > 0 THEN
14:33:54 1061  	       IF f_charge.CHARGE_STATUS_ID = GLOBAL_STATUSES_V22.CHARGE_PROCESSED
14:33:54 1062  		  AND PROCS_TRANSACTION_V22.IS_TRANSACTION_COLLECTED(f_charge.TRANSACTION_ID) = GLOBAL_CONSTANTS_V22.TRUE THEN
14:33:54 1063  		 -- Transaction collected
14:33:54 1064  		 var_invoice_charges_sum := var_invoice_charges_sum + f_charge.CHARGE_AMOUNT;
14:33:54 1065  	       ELSE
14:33:54 1066  		 -- Transaction is not collected. Do nothing
14:33:54 1067  		 NULL;
14:33:54 1068  	       END IF;
14:33:54 1069  	     ELSE
14:33:54 1070  	       IF f_charge.CHARGE_STATUS_ID = GLOBAL_STATUSES_V22.CHARGE_PROCESSED
14:33:54 1071  		  AND PROCS_TRANSACTION_V22.IS_TRANSACTION_COLLECTED(f_charge.TRANSACTION_ID) = GLOBAL_CONSTANTS_V22.FALSE THEN
14:33:54 1072  		 -- If charge is processed transaction is not collected then do nothing
14:33:54 1073  		 NULL;
14:33:54 1074  	       ELSE
14:33:54 1075  		 var_invoice_refunds_sum := var_invoice_refunds_sum + f_charge.CHARGE_AMOUNT;
14:33:54 1076  	       END IF;
14:33:54 1077  	     END IF;
14:33:54 1078  
14:33:54 1079  	   END IF;
14:33:54 1080  	 END LOOP;
14:33:54 1081  
14:33:54 1082  	 -- Refunds are negative
14:33:54 1083  	 var_invoice_refunds_sum := 0 - var_invoice_refunds_sum;
14:33:54 1084  
14:33:54 1085  	 out_amount := var_invoice_charges_sum - var_invoice_refunds_sum;
14:33:54 1086  
14:33:54 1087  EXCEPTION
14:33:54 1088  WHEN BAD_INVOICE_ID THEN
14:33:54 1089  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1090  	   SPROC_NAME, 'No such invoice');
14:33:54 1091  WHEN OTHERS THEN
14:33:54 1092  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1093  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1094  END GET_MAX_REFUND;
14:33:54 1095  
14:33:54 1096  /******************************************************************************/
14:33:54 1097  
14:33:54 1098  PROCEDURE GET_INVOICE_DAYS_USED_NUMBER (
14:33:54 1099  	 in_invoice_id	     IN NUMBER,
14:33:54 1100  	 in_chargeback_date  IN DATE DEFAULT SYSDATE,
14:33:54 1101  	 out_days_num	     OUT NUMBER
14:33:54 1102  ) AS
14:33:54 1103  SPROC_NAME CONSTANT VARCHAR2(28) := 'GET_INVOICE_DAYS_USED_NUMBER';
14:33:54 1104  -- VARIABLES
14:33:54 1105  temp_invoice_id	      NUMBER;
14:33:54 1106  var_license_start_date DATE;
14:33:54 1107  var_license_end_date   DATE;
14:33:54 1108  var_chargeback_date    DATE;
14:33:54 1109  var_invoice_days_used  NUMBER;
14:33:54 1110  -- EXCEPTIONS
14:33:54 1111  BAD_INVOICE_ID EXCEPTION;
14:33:54 1112  BEGIN
14:33:54 1113  
14:33:54 1114  	 var_chargeback_date := NVL(in_chargeback_date, SYSDATE);
14:33:54 1115  
14:33:54 1116  	 BEGIN
14:33:54 1117  	   SELECT
14:33:54 1118  	     INVOICE.ID into temp_invoice_id
14:33:54 1119  	   FROM
14:33:54 1120  	     INVOICE
14:33:54 1121  	   WHERE
14:33:54 1122  	     INVOICE.ID = in_invoice_id;
14:33:54 1123  	   EXCEPTION
14:33:54 1124  	     WHEN NO_DATA_FOUND THEN
14:33:54 1125  	       RAISE BAD_INVOICE_ID;
14:33:54 1126  	 END;
14:33:54 1127  
14:33:54 1128  	 var_invoice_days_used := 0;
14:33:54 1129  
14:33:54 1130  	 FOR f_license IN (
14:33:54 1131  	   SELECT
14:33:54 1132  	     LICENSE.START_DATE,
14:33:54 1133  	     LICENSE.END_DATE
14:33:54 1134  	   FROM
14:33:54 1135  	     LICENSE
14:33:54 1136  	   WHERE
14:33:54 1137  	     LICENSE.INVOICE_ID = in_invoice_id
14:33:54 1138  	     AND LICENSE.IS_EXTENSION = GLOBAL_CONSTANTS_V22.FALSE
14:33:54 1139  	 )
14:33:54 1140  	 LOOP
14:33:54 1141  	   var_license_start_date := PROCS_COMMON_V22.NORMALIZE_DATE(f_license.START_DATE);
14:33:54 1142  	   var_license_end_date := PROCS_COMMON_V22.NORMALIZE_DATE(f_license.END_DATE);
14:33:54 1143  
14:33:54 1144  	   IF var_license_start_date <= var_chargeback_date THEN
14:33:54 1145  	     IF var_license_end_date <= var_chargeback_date THEN
14:33:54 1146  	       -- License is passed
14:33:54 1147  	       var_invoice_days_used := var_invoice_days_used + (var_license_end_date - var_license_start_date);
14:33:54 1148  	     ELSE
14:33:54 1149  	       -- This is current license
14:33:54 1150  	       var_invoice_days_used := var_invoice_days_used + (var_chargeback_date - var_license_start_date);
14:33:54 1151  	     END IF;
14:33:54 1152  	   ELSE
14:33:54 1153  	     -- if var_license_start_date > in_chargeback_date then do nothing
14:33:54 1154  	     NULL;
14:33:54 1155  	   END IF;
14:33:54 1156  	 END LOOP;
14:33:54 1157  
14:33:54 1158  	 out_days_num := var_invoice_days_used;
14:33:54 1159  
14:33:54 1160  EXCEPTION
14:33:54 1161  WHEN BAD_INVOICE_ID THEN
14:33:54 1162  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1163  	   SPROC_NAME, 'No such invoice');
14:33:54 1164  WHEN OTHERS THEN
14:33:54 1165  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1166  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1167  END GET_INVOICE_DAYS_USED_NUMBER;
14:33:54 1168  
14:33:54 1169  /******************************************************************************/
14:33:54 1170  
14:33:54 1171  PROCEDURE GET_INVOICE_LINE_ITEMS (
14:33:54 1172  	 in_invoice_id	IN NUMBER,
14:33:54 1173  	 out_result_set OUT SYS_REFCURSOR
14:33:54 1174  ) AS
14:33:54 1175  SPROC_NAME CONSTANT VARCHAR2(22) := 'GET_INVOICE_LINE_ITEMS';
14:33:54 1176  -- VARIABLES
14:33:54 1177  temp_invoice_id NUMBER;
14:33:54 1178  -- EXCEPTIONS
14:33:54 1179  BAD_INVOICE_ID EXCEPTION;
14:33:54 1180  BEGIN
14:33:54 1181  
14:33:54 1182  	 BEGIN
14:33:54 1183  	   SELECT
14:33:54 1184  	     INVOICE.ID into temp_invoice_id
14:33:54 1185  	   FROM
14:33:54 1186  	     INVOICE
14:33:54 1187  	   WHERE
14:33:54 1188  	     INVOICE.ID = in_invoice_id;
14:33:54 1189  	   EXCEPTION
14:33:54 1190  	     WHEN NO_DATA_FOUND THEN
14:33:54 1191  	       RAISE BAD_INVOICE_ID;
14:33:54 1192  	 END;
14:33:54 1193  
14:33:54 1194  	 OPEN out_result_set FOR
14:33:54 1195  	 SELECT
14:33:54 1196  	   LINE_ITEM.ID,
14:33:54 1197  	   LINE_ITEM.PRODUCT_OFFER_ID,
14:33:54 1198  	   LINE_ITEM.INVOICE_ID,
14:33:54 1199  	   LINE_ITEM.AMOUNT,
14:33:54 1200  	   LINE_ITEM.DISCOUNT_AMOUNT,
14:33:54 1201  	   LINE_ITEM.TAXES_AMOUNT,
14:33:54 1202  	   LINE_ITEM.CREATE_DATE,
14:33:54 1203  	   LINE_ITEM.CREATED_BY
14:33:54 1204  	 FROM
14:33:54 1205  	   LINE_ITEM
14:33:54 1206  	 WHERE
14:33:54 1207  	   LINE_ITEM.INVOICE_ID = in_invoice_id;
14:33:54 1208  
14:33:54 1209  EXCEPTION
14:33:54 1210  WHEN BAD_INVOICE_ID THEN
14:33:54 1211  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1212  	   SPROC_NAME, 'No such invoice');
14:33:54 1213  WHEN OTHERS THEN
14:33:54 1214  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1215  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1216  END GET_INVOICE_LINE_ITEMS;
14:33:54 1217  
14:33:54 1218  /******************************************************************************/
14:33:54 1219  
14:33:54 1220  PROCEDURE GET_INVOICE_LICENSES (
14:33:54 1221  	 in_invoice_id	IN NUMBER,
14:33:54 1222  	 out_result_set OUT SYS_REFCURSOR
14:33:54 1223  ) AS
14:33:54 1224  SPROC_NAME CONSTANT VARCHAR2(20) := 'GET_INVOICE_LICENSES';
14:33:54 1225  -- VARIABLES
14:33:54 1226  temp_invoice_id NUMBER;
14:33:54 1227  -- EXCEPTIONS
14:33:54 1228  BAD_INVOICE_ID EXCEPTION;
14:33:54 1229  BEGIN
14:33:54 1230  
14:33:54 1231  	 BEGIN
14:33:54 1232  	   SELECT
14:33:54 1233  	     INVOICE.ID into temp_invoice_id
14:33:54 1234  	   FROM
14:33:54 1235  	     INVOICE
14:33:54 1236  	   WHERE
14:33:54 1237  	     INVOICE.ID = in_invoice_id;
14:33:54 1238  	   EXCEPTION
14:33:54 1239  	     WHEN NO_DATA_FOUND THEN
14:33:54 1240  	       RAISE BAD_INVOICE_ID;
14:33:54 1241  	 END;
14:33:54 1242  
14:33:54 1243  	 OPEN out_result_set FOR
14:33:54 1244  	 SELECT
14:33:54 1245  	   LICENSE.ID,
14:33:54 1246  	   LICENSE.INVOICE_ID,
14:33:54 1247  	   LICENSE.CREATE_DATE,
14:33:54 1248  	   LICENSE.CREATED_BY,
14:33:54 1249  	   LICENSE.CURRENT_OFFER_INDEX,
14:33:54 1250  	   LICENSE.CURRENT_OFFER_RECURR_NUM,
14:33:54 1251  	   LICENSE.END_DATE,
14:33:54 1252  	   LICENSE.ENTITLEMENT_END_DATE,
14:33:54 1253  	   LICENSE.IS_EXTENSION,
14:33:54 1254  	   LICENSE.LICENSE_STATUS_ID,
14:33:54 1255  	   LICENSE.NEEDS_ENTITLEMENTS,
14:33:54 1256  	   LICENSE.OFFER_ID,
14:33:54 1257  	   LICENSE.START_DATE,
14:33:54 1258  	   LICENSE.SUBSCRIPTION_ID,
14:33:54 1259  	   LICENSE.UPDATE_DATE,
14:33:54 1260  	   LICENSE.UPDATED_BY
14:33:54 1261  	 FROM
14:33:54 1262  	   LICENSE
14:33:54 1263  	 WHERE
14:33:54 1264  	   LICENSE.INVOICE_ID = in_invoice_id;
14:33:54 1265  
14:33:54 1266  EXCEPTION
14:33:54 1267  WHEN BAD_INVOICE_ID THEN
14:33:54 1268  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1269  	   SPROC_NAME, 'No such invoice');
14:33:54 1270  WHEN OTHERS THEN
14:33:54 1271  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1272  	   SPROC_NAME, 'Unknown error');
14:33:54 1273  END GET_INVOICE_LICENSES;
14:33:54 1274  
14:33:54 1275  /******************************************************************************/
14:33:54 1276  
14:33:54 1277  PROCEDURE GET_OFFER_CH_ID_BY_INVOICE_ID (
14:33:54 1278  	 in_invoice_id	    IN NUMBER,
14:33:54 1279  	 out_offer_chain_id OUT NUMBER
14:33:54 1280  ) AS
14:33:54 1281  SPROC_NAME CONSTANT VARCHAR2(29) := 'GET_OFFER_CH_ID_BY_INVOICE_ID';
14:33:54 1282  -- VARIABLES
14:33:54 1283  temp_invoice_id NUMBER;
14:33:54 1284  -- EXCEPTIONS
14:33:54 1285  BAD_INVOICE_ID EXCEPTION;
14:33:54 1286  BEGIN
14:33:54 1287  
14:33:54 1288  	 BEGIN
14:33:54 1289  	   SELECT
14:33:54 1290  	     INVOICE.ID into temp_invoice_id
14:33:54 1291  	   FROM
14:33:54 1292  	     INVOICE
14:33:54 1293  	   WHERE
14:33:54 1294  	     INVOICE.ID = in_invoice_id;
14:33:54 1295  	   EXCEPTION
14:33:54 1296  	     WHEN NO_DATA_FOUND THEN
14:33:54 1297  	       RAISE BAD_INVOICE_ID;
14:33:54 1298  	 END;
14:33:54 1299  
14:33:54 1300  	 BEGIN
14:33:54 1301  	   SELECT DISTINCT
14:33:54 1302  	     SUBSCRIPTION.OFFER_CHAIN_ID into out_offer_chain_id
14:33:54 1303  	   FROM
14:33:54 1304  	     LICENSE
14:33:54 1305  	     INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
14:33:54 1306  	   WHERE
14:33:54 1307  	     LICENSE.INVOICE_ID = in_invoice_id;
14:33:54 1308  	   EXCEPTION
14:33:54 1309  	     WHEN NO_DATA_FOUND THEN
14:33:54 1310  	       out_offer_chain_id := NULL;
14:33:54 1311  	 END;
14:33:54 1312  
14:33:54 1313  EXCEPTION
14:33:54 1314  WHEN BAD_INVOICE_ID THEN
14:33:54 1315  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1316  	   SPROC_NAME, 'No such invoice');
14:33:54 1317  WHEN OTHERS THEN
14:33:54 1318  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1319  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1320  END GET_OFFER_CH_ID_BY_INVOICE_ID;
14:33:54 1321  
14:33:54 1322  /******************************************************************************/
14:33:54 1323  
14:33:54 1324  PROCEDURE CLOSE_INVOICE_AS_NOT_COLLECTED (
14:33:54 1325  -- Closing invoice without refund
14:33:54 1326  	 in_invoice_id IN NUMBER,
14:33:54 1327  	 in_updated_by IN VARCHAR2
14:33:54 1328  ) AS
14:33:54 1329  SPROC_NAME CONSTANT VARCHAR2(30) := 'CLOSE_INVOICE_AS_NOT_COLLECTED';
14:33:54 1330  -- VARIABLES
14:33:54 1331  temp_invoice_id NUMBER;
14:33:54 1332  -- EXCEPTIONS
14:33:54 1333  BAD_INVOICE_ID EXCEPTION;
14:33:54 1334  BEGIN
14:33:54 1335  
14:33:54 1336  	 BEGIN
14:33:54 1337  	   SELECT
14:33:54 1338  	     INVOICE.ID into temp_invoice_id
14:33:54 1339  	   FROM
14:33:54 1340  	     INVOICE
14:33:54 1341  	   WHERE
14:33:54 1342  	     INVOICE.ID = in_invoice_id;
14:33:54 1343  	   EXCEPTION
14:33:54 1344  	     WHEN NO_DATA_FOUND THEN
14:33:54 1345  	       RAISE BAD_INVOICE_ID;
14:33:54 1346  	 END;
14:33:54 1347  
14:33:54 1348  	 -- Needs to close charges. No refund.
14:33:54 1349  	 FOR f_charge_to_close IN (
14:33:54 1350  	   SELECT CHARGE.ID FROM CHARGE WHERE CHARGE.INVOICE_ID = in_invoice_id
14:33:54 1351  	 )
14:33:54 1352  	 LOOP
14:33:54 1353  	   PROCS_CHARGE_V22.UPDATE_CHARGE_STATUS(
14:33:54 1354  	     in_charge_id	 => f_charge_to_close.ID,
14:33:54 1355  	     in_updated_by	 => in_updated_by,
14:33:54 1356  	     in_charge_status_id => GLOBAL_STATUSES_V22.CHARGE_CANCELED
14:33:54 1357  	   );
14:33:54 1358  	 END LOOP;
14:33:54 1359  
14:33:54 1360  	 --FOR f_license_to_cancel IN (
14:33:54 1361  	 --  SELECT LICENSE.ID FROM LICENSE WHERE LICENSE.INVOICE_ID = in_invoice_id AND LICENSE.LICENSE_STATUS_ID = GLOBAL_STATUSES_V22.LICENSE_ACTIVE
14:33:54 1362  	 --)
14:33:54 1363  	 --LOOP
14:33:54 1364  	 --  PROCS_LICENSE_CRU_V22.UPDATE_LICENSE(
14:33:54 1365  	 --    in_license_id	     => f_license_to_cancel.ID,
14:33:54 1366  	 --    in_license_status_id  => GLOBAL_STATUSES_V22.LICENSE_CLOSED,
14:33:54 1367  	 --    in_needs_entitlements => GLOBAL_CONSTANTS_V22.FALSE,
14:33:54 1368  	 --    in_updated_by	     => in_updated_by
14:33:54 1369  	 --  );
14:33:54 1370  	 --END LOOP;
14:33:54 1371  
14:33:54 1372  	 PROCS_INVOICE_V22.UPDATE_INVOICE_STATUS(
14:33:54 1373  	   in_invoice_id		  => in_invoice_id,
14:33:54 1374  	   in_updated_by		  => in_updated_by,
14:33:54 1375  	   in_invoice_status_id 	  => GLOBAL_STATUSES_V22.INVOICE_CLOSED
14:33:54 1376  	 );
14:33:54 1377  
14:33:54 1378  	 FOR f_transaction_to_close IN (
14:33:54 1379  	   SELECT DISTINCT CHARGE.TRANSACTION_ID AS "ID" FROM CHARGE WHERE CHARGE.INVOICE_ID = in_invoice_id
14:33:54 1380  	 )
14:33:54 1381  	 LOOP
14:33:54 1382  	   PROCS_TRANSACTION_V22.UPDATE_TRANSACTION_STATUS(
14:33:54 1383  	     in_transaction_id	      => f_transaction_to_close.ID,
14:33:54 1384  	     in_updated_by	      => in_updated_by,
14:33:54 1385  	     in_transaction_status_id => GLOBAL_STATUSES_V22.TRANSACTION_CLOSED
14:33:54 1386  	   );
14:33:54 1387  	 END LOOP;
14:33:54 1388  
14:33:54 1389  EXCEPTION
14:33:54 1390  WHEN BAD_INVOICE_ID THEN
14:33:54 1391  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1392  	   SPROC_NAME, 'No such invoice');
14:33:54 1393  WHEN OTHERS THEN
14:33:54 1394  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1395  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1396  END CLOSE_INVOICE_AS_NOT_COLLECTED;
14:33:54 1397  
14:33:54 1398  /******************************************************************************/
14:33:54 1399  
14:33:54 1400  PROCEDURE GET_SUBSCR_ID_BY_INVOICE_ID (
14:33:54 1401  	 in_invoice_id	     IN NUMBER,
14:33:54 1402  	 out_subscription_id OUT NUMBER
14:33:54 1403  ) AS
14:33:54 1404  SPROC_NAME CONSTANT VARCHAR2(27) := 'GET_SUBSCR_ID_BY_INVOICE_ID';
14:33:54 1405  -- VARIABLES
14:33:54 1406  temp_invoice_id NUMBER;
14:33:54 1407  -- EXCEPTIONS
14:33:54 1408  BAD_INVOICE_ID		 EXCEPTION;
14:33:54 1409  CAN_NOT_FIND_SUBSCRIPTION EXCEPTION;
14:33:54 1410  BEGIN
14:33:54 1411  
14:33:54 1412  	 BEGIN
14:33:54 1413  	   SELECT
14:33:54 1414  	     INVOICE.ID into temp_invoice_id
14:33:54 1415  	   FROM
14:33:54 1416  	     INVOICE
14:33:54 1417  	   WHERE
14:33:54 1418  	     INVOICE.ID = in_invoice_id;
14:33:54 1419  	   EXCEPTION
14:33:54 1420  	     WHEN NO_DATA_FOUND THEN
14:33:54 1421  	       RAISE BAD_INVOICE_ID;
14:33:54 1422  	 END;
14:33:54 1423  
14:33:54 1424  	 BEGIN
14:33:54 1425  	   SELECT DISTINCT
14:33:54 1426  	     LICENSE.SUBSCRIPTION_ID into out_subscription_id
14:33:54 1427  	   FROM
14:33:54 1428  	     LICENSE
14:33:54 1429  	   WHERE
14:33:54 1430  	     LICENSE.INVOICE_ID = in_invoice_id;
14:33:54 1431  	   EXCEPTION
14:33:54 1432  	     WHEN NO_DATA_FOUND THEN
14:33:54 1433  	       RAISE CAN_NOT_FIND_SUBSCRIPTION;
14:33:54 1434  	 END;
14:33:54 1435  
14:33:54 1436  EXCEPTION
14:33:54 1437  WHEN BAD_INVOICE_ID THEN
14:33:54 1438  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1439  	   SPROC_NAME, 'No such invoice');
14:33:54 1440  WHEN CAN_NOT_FIND_SUBSCRIPTION THEN
14:33:54 1441  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1442  	   SPROC_NAME, 'Could not find subscription for given invoice');
14:33:54 1443  WHEN OTHERS THEN
14:33:54 1444  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1445  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1446  END GET_SUBSCR_ID_BY_INVOICE_ID;
14:33:54 1447  
14:33:54 1448  /******************************************************************************/
14:33:54 1449  
14:33:54 1450  PROCEDURE IS_INVOICE_TAX_EXEMPT (
14:33:54 1451  /*
14:33:54 1452  Throws exceptions:
14:33:54 1453  APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1454  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 1455  Return:
14:33:54 1456  	 GLOBAL_CONSTANTS_V22.TRUE if ACCOUNT.EXEMPT_ID is not null
14:33:54 1457  	 GLOBAL_CONSTANTS_V22.FALSE else
14:33:54 1458  */
14:33:54 1459  	 in_invoice_id	   IN NUMBER,
14:33:54 1460  	 out_is_tax_exempt OUT NUMBER
14:33:54 1461  ) AS
14:33:54 1462  SPROC_NAME CONSTANT VARCHAR2(21) := 'IS_INVOICE_TAX_EXEMPT';
14:33:54 1463  -- VARIABLES
14:33:54 1464  var_is_tax_exempt INVOICE.TAX_EXEMPT_ID%TYPE;
14:33:54 1465  -- EXCEPTIONS
14:33:54 1466  BAD_INVOICE_ID EXCEPTION;
14:33:54 1467  BEGIN
14:33:54 1468  
14:33:54 1469  	 BEGIN
14:33:54 1470  	   SELECT
14:33:54 1471  	     INVOICE.TAX_EXEMPT_ID into var_is_tax_exempt
14:33:54 1472  	   FROM
14:33:54 1473  	     INVOICE
14:33:54 1474  	   WHERE
14:33:54 1475  	     INVOICE.ID = in_invoice_id;
14:33:54 1476  	   EXCEPTION
14:33:54 1477  	     WHEN NO_DATA_FOUND THEN
14:33:54 1478  	       RAISE BAD_INVOICE_ID;
14:33:54 1479  	 END;
14:33:54 1480  
14:33:54 1481  	 IF var_is_tax_exempt IS NULL THEN
14:33:54 1482  	   out_is_tax_exempt := GLOBAL_CONSTANTS_V22.FALSE;
14:33:54 1483  	 ELSE
14:33:54 1484  	   out_is_tax_exempt := GLOBAL_CONSTANTS_V22.TRUE;
14:33:54 1485  	 END IF;
14:33:54 1486  
14:33:54 1487  EXCEPTION
14:33:54 1488  WHEN BAD_INVOICE_ID THEN
14:33:54 1489  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1490  	   SPROC_NAME, 'No such invoice');
14:33:54 1491  WHEN OTHERS THEN
14:33:54 1492  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1493  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1494  END IS_INVOICE_TAX_EXEMPT;
14:33:54 1495  
14:33:54 1496  /******************************************************************************/
14:33:54 1497  
14:33:54 1498  PROCEDURE GET_INVOICE_BY_TRNS_ORDER_ID (
14:33:54 1499  	 in_order_id  IN TRANSACTION.ORDER_ID%TYPE,
14:33:54 1500  	 out_result_set OUT SYS_REFCURSOR
14:33:54 1501  ) AS
14:33:54 1502  SPROC_NAME CONSTANT VARCHAR2(28) := 'GET_INVOICE_BY_TRNS_ORDER_ID';
14:33:54 1503  -- VARIABLE
14:33:54 1504  temp_order_id TRANSACTION.ORDER_ID%TYPE;
14:33:54 1505  -- EXCEPTIONS
14:33:54 1506  BAD_ORDER_ID EXCEPTION;
14:33:54 1507  CAN_NOT_FIND_INVOICE EXCEPTION;
14:33:54 1508  BEGIN
14:33:54 1509  
14:33:54 1510  	 OPEN out_result_set FOR
14:33:54 1511  	   SELECT DISTINCT
14:33:54 1512  	     CHARGE.INVOICE_ID
14:33:54 1513  	   FROM
14:33:54 1514  	     CHARGE
14:33:54 1515  	   INNER JOIN
14:33:54 1516  	     TRANSACTION ON TRANSACTION.ID = CHARGE.TRANSACTION_ID
14:33:54 1517  	   WHERE
14:33:54 1518  	     TRANSACTION.ORDER_ID = in_order_id;
14:33:54 1519  
14:33:54 1520  EXCEPTION
14:33:54 1521  WHEN BAD_ORDER_ID THEN
14:33:54 1522  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1523  	   SPROC_NAME, 'No such transaction');
14:33:54 1524  WHEN CAN_NOT_FIND_INVOICE THEN
14:33:54 1525  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1526  	   SPROC_NAME, 'Could not find invoice for given order id');
14:33:54 1527  WHEN OTHERS THEN
14:33:54 1528  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1529  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1530  END GET_INVOICE_BY_TRNS_ORDER_ID;
14:33:54 1531  
14:33:54 1532  /******************************************************************************/
14:33:54 1533  
14:33:54 1534  PROCEDURE GET_INVOICE_BY_ID (
14:33:54 1535  	 in_invoice_id	IN NUMBER,
14:33:54 1536  	 out_result_set OUT SYS_REFCURSOR
14:33:54 1537  ) AS
14:33:54 1538  SPROC_NAME CONSTANT VARCHAR2(17) := 'GET_INVOICE_BY_ID';
14:33:54 1539  -- VARIABLE
14:33:54 1540  temp_invoice_id NUMBER;
14:33:54 1541  -- EXCEPTIONS
14:33:54 1542  BAD_INVOCIE_ID EXCEPTION;
14:33:54 1543  BEGIN
14:33:54 1544  
14:33:54 1545  	 BEGIN
14:33:54 1546  	   SELECT
14:33:54 1547  	     INVOICE.ID into temp_invoice_id
14:33:54 1548  	   FROM
14:33:54 1549  	     INVOICE
14:33:54 1550  	   WHERE
14:33:54 1551  	     INVOICE.ID = in_invoice_id;
14:33:54 1552  	   EXCEPTION
14:33:54 1553  	     WHEN NO_DATA_FOUND THEN
14:33:54 1554  	       RAISE BAD_INVOCIE_ID;
14:33:54 1555  	 END;
14:33:54 1556  
14:33:54 1557  	 OPEN out_result_set FOR
14:33:54 1558  	 SELECT
14:33:54 1559  	   INVOICE.ID,
14:33:54 1560  	   INVOICE.INVOICE_STATUS_ID,
14:33:54 1561  	   INVOICE.TAX_EXEMPT_ID,
14:33:54 1562  	   INVOICE.UPDATE_DATE,
14:33:54 1563  	   INVOICE.UPDATED_BY,
14:33:54 1564  	   INVOICE.CREATE_DATE,
14:33:54 1565  	   INVOICE.CREATED_BY
14:33:54 1566  	 FROM
14:33:54 1567  	   INVOICE
14:33:54 1568  	 WHERE
14:33:54 1569  	   INVOICE.ID = in_invoice_id;
14:33:54 1570  
14:33:54 1571  EXCEPTION
14:33:54 1572  WHEN BAD_INVOCIE_ID THEN
14:33:54 1573  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1574  	   SPROC_NAME, 'No such invoice');
14:33:54 1575  WHEN OTHERS THEN
14:33:54 1576  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1577  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1578  END GET_INVOICE_BY_ID;
14:33:54 1579  
14:33:54 1580  /******************************************************************************/
14:33:54 1581  
14:33:54 1582  PROCEDURE GET_IS_TAX_CALCULATION_NEEDED (
14:33:54 1583  	 in_invoice_id		       IN NUMBER,
14:33:54 1584  	 out_is_tax_calculation_needed OUT NUMBER
14:33:54 1585  ) AS
14:33:54 1586  SPROC_NAME CONSTANT VARCHAR2(29) := 'GET_IS_TAX_CALCULATION_NEEDED';
14:33:54 1587  BEGIN
14:33:54 1588  
14:33:54 1589  	 SELECT
14:33:54 1590  	   I.IS_TAX_CALCULATION_NEEDED into out_is_tax_calculation_needed
14:33:54 1591  	 FROM
14:33:54 1592  	   INVOICE I
14:33:54 1593  	 WHERE
14:33:54 1594  	   I.ID = in_invoice_id;
14:33:54 1595  
14:33:54 1596  EXCEPTION
14:33:54 1597  WHEN NO_DATA_FOUND THEN
14:33:54 1598  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1599  	   SPROC_NAME, 'No such invoice');
14:33:54 1600  WHEN OTHERS THEN
14:33:54 1601  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1602  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1603  END GET_IS_TAX_CALCULATION_NEEDED;
14:33:54 1604  
14:33:54 1605  /******************************************************************************/
14:33:54 1606  
14:33:54 1607  PROCEDURE SET_IS_TAX_CALCULATION_NEEDED (
14:33:54 1608  	 in_invoice_id		      IN NUMBER,
14:33:54 1609  	 in_updated_by		      IN VARCHAR2,
14:33:54 1610  	 in_is_tax_calculation_needed IN NUMBER
14:33:54 1611  ) AS
14:33:54 1612  SPROC_NAME CONSTANT VARCHAR2(29) := 'SET_IS_TAX_CALCULATION_NEEDED';
14:33:54 1613  -- VARIABLES
14:33:54 1614  temp_invoice_id	      NUMBER;
14:33:54 1615  -- EXCEPTIONS
14:33:54 1616  BAD_INVOICE_ID	      EXCEPTION;
14:33:54 1617  CAN_NOT_UPDATE_INVOCIE EXCEPTION;
14:33:54 1618  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:54 1619  BEGIN
14:33:54 1620  
14:33:54 1621  	 BEGIN
14:33:54 1622  	   SELECT
14:33:54 1623  	     i.id into temp_invoice_id
14:33:54 1624  	   FROM
14:33:54 1625  	     invoice i
14:33:54 1626  	   WHERE
14:33:54 1627  	     i.id = in_invoice_id;
14:33:54 1628  	   EXCEPTION
14:33:54 1629  	     WHEN NO_DATA_FOUND THEN
14:33:54 1630  	       RAISE BAD_INVOICE_ID;
14:33:54 1631  	 END;
14:33:54 1632  
14:33:54 1633  	 BEGIN
14:33:54 1634  	   PROCS_INVOICE_CRU_V22.UPDATE_INVOICE(
14:33:54 1635  	     in_invoice_id => in_invoice_id,
14:33:54 1636  	     in_updated_by => in_updated_by,
14:33:54 1637  	     in_is_tax_calculation_needed => in_is_tax_calculation_needed
14:33:54 1638  	   );
14:33:54 1639  	   EXCEPTION
14:33:54 1640  	     WHEN OTHERS THEN
14:33:54 1641  	       EXCEPTION_MESSAGE := SQLERRM;
14:33:54 1642  	       RAISE CAN_NOT_UPDATE_INVOCIE;
14:33:54 1643  	 END;
14:33:54 1644  
14:33:54 1645  EXCEPTION
14:33:54 1646  WHEN BAD_INVOICE_ID THEN
14:33:54 1647  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1648  	   SPROC_NAME, 'No such invoice');
14:33:54 1649  WHEN CAN_NOT_UPDATE_INVOCIE THEN
14:33:54 1650  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 1651  	   SPROC_NAME, 'Could not update invoice', EXCEPTION_MESSAGE);
14:33:54 1652  WHEN OTHERS THEN
14:33:54 1653  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1654  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1655  END SET_IS_TAX_CALCULATION_NEEDED;
14:33:54 1656  
14:33:54 1657  /******************************************************************************/
14:33:54 1658  
14:33:54 1659  PROCEDURE REFUND_INVOICE (
14:33:54 1660  	 in_invoice_id	    IN NUMBER,
14:33:54 1661  	 in_refund_amount   IN NUMBER,
14:33:54 1662  	 in_note	    IN VARCHAR2,
14:33:54 1663  	 in_created_by	    IN VARCHAR2,
14:33:54 1664  	 out_charge_id	    OUT NUMBER
14:33:54 1665  ) AS
14:33:54 1666  SPROC_NAME CONSTANT VARCHAR2(14) := 'REFUND_INVOICE';
14:33:54 1667  -- VARIABLES
14:33:54 1668  var_invoice_status_id  NUMBER;
14:33:54 1669  var_subscription_id    NUMBER;
14:33:54 1670  var_account_id	      NUMBER;
14:33:54 1671  var_group_id	      NUMBER;
14:33:54 1672  var_account_status_id  NUMBER;
14:33:54 1673  var_new_transaction_id NUMBER;
14:33:54 1674  var_instrument_type_id NUMBER;
14:33:54 1675  var_instrument_id      NUMBER;
14:33:54 1676  var_new_charge_id      NUMBER;
14:33:54 1677  var_invoice_amount     NUMBER(10,2);
14:33:54 1678  var_refunds_before     NUMBER(10,2);
14:33:54 1679  var_charges_amount     NUMBER(10,2);
14:33:54 1680  -- EXCEPTIONS
14:33:54 1681  CAN_NOT_FIND_SUBSCR_OR_GC     EXCEPTION;
14:33:54 1682  ACCOUNT_IS_FROZEN	     EXCEPTION;
14:33:54 1683  BAD_INVOICE_ID		     EXCEPTION;
14:33:54 1684  CAN_NOT_CREATE_TRANSACTION    EXCEPTION;
14:33:54 1685  CAN_NOT_CREATE_CHARGE	     EXCEPTION;
14:33:54 1686  CAN_NOT_CALC_INVOICE_AMOUNT   EXCEPTION;
14:33:54 1687  REFUND_IS_GREATER_THAN_ANOUNT EXCEPTION;
14:33:54 1688  CAN_NOT_ANNOTATE_SUBSCRIPTION EXCEPTION;
14:33:54 1689  TOT_REF_IS_GREATER_THAN_ANOUNT EXCEPTION;
14:33:54 1690  INVOICE_IS_NOT_CLOSED	     EXCEPTION;
14:33:54 1691  TOT_REF_IS_GRATER_THAN_CHARGES EXCEPTION;
14:33:54 1692  EXCEPTION_MESSAGE	      VARCHAR2(1024);
14:33:54 1693  BEGIN
14:33:54 1694  
14:33:54 1695  	 BEGIN
14:33:54 1696  	   SELECT
14:33:54 1697  	     INVOICE.INVOICE_STATUS_ID into var_invoice_status_id
14:33:54 1698  	   FROM
14:33:54 1699  	     INVOICE
14:33:54 1700  	   WHERE
14:33:54 1701  	     INVOICE.ID = in_invoice_id;
14:33:54 1702  	   EXCEPTION
14:33:54 1703  	     WHEN NO_DATA_FOUND THEN
14:33:54 1704  	       RAISE BAD_INVOICE_ID;
14:33:54 1705  	 END;
14:33:54 1706  
14:33:54 1707  	 -- Get instrument and subscription id if exists
14:33:54 1708  	 BEGIN
14:33:54 1709  	   SELECT
14:33:54 1710  	     SUBSCRIPTION.INSTRUMENT_ID,
14:33:54 1711  	     SUBSCRIPTION.INSTRUMENT_TYPE_ID,
14:33:54 1712  	     SUBSCRIPTION.ACCOUNT_ID,
14:33:54 1713  	     SUBSCRIPTION.ID
14:33:54 1714  	     into
14:33:54 1715  	     var_instrument_id,
14:33:54 1716  	     var_instrument_type_id,
14:33:54 1717  	     var_account_id,
14:33:54 1718  	     var_subscription_id
14:33:54 1719  	   FROM
14:33:54 1720  	     SUBSCRIPTION
14:33:54 1721  	     INNER JOIN LICENSE ON SUBSCRIPTION.ID = LICENSE.SUBSCRIPTION_ID
14:33:54 1722  	   WHERE
14:33:54 1723  	     LICENSE.INVOICE_ID = in_invoice_id
14:33:54 1724  	     AND ROWNUM <= 1;
14:33:54 1725  	   EXCEPTION
14:33:54 1726  	     WHEN NO_DATA_FOUND THEN
14:33:54 1727  	       BEGIN
14:33:54 1728  
14:33:54 1729  		 var_subscription_id := NULL;
14:33:54 1730  
14:33:54 1731  		 SELECT
14:33:54 1732  		   CHARGE.INSTRUMENT_ID,
14:33:54 1733  		   CHARGE.INSTRUMENT_TYPE_ID,
14:33:54 1734  		   GIFT_CERTIFICATE.PURCHASER_GROUP_ID
14:33:54 1735  		   into
14:33:54 1736  		   var_instrument_id,
14:33:54 1737  		   var_instrument_type_id,
14:33:54 1738  		   var_group_id
14:33:54 1739  		 FROM
14:33:54 1740  		   INVOICE
14:33:54 1741  		   INNER JOIN CHARGE ON INVOICE.ID = CHARGE.INVOICE_ID
14:33:54 1742  		   INNER JOIN GIFT_CERTIFICATE ON GIFT_CERTIFICATE.PURCHASE_INVOICE_ID = INVOICE.ID
14:33:54 1743  		 WHERE
14:33:54 1744  		   INVOICE.ID = in_invoice_id
14:33:54 1745  		   AND ROWNUM <= 1;
14:33:54 1746  
14:33:54 1747  		 SELECT
14:33:54 1748  		   ACCOUNT.ID into var_account_id
14:33:54 1749  		 FROM
14:33:54 1750  		   ACCOUNT
14:33:54 1751  		 WHERE
14:33:54 1752  		   ACCOUNT.GROUP_ID = var_group_id;
14:33:54 1753  
14:33:54 1754  		 EXCEPTION
14:33:54 1755  		   WHEN NO_DATA_FOUND THEN
14:33:54 1756  		     RAISE CAN_NOT_FIND_SUBSCR_OR_GC;
14:33:54 1757  	       END;
14:33:54 1758  	 END;
14:33:54 1759  
14:33:54 1760  	 -- Check account status. It should not to be frozen
14:33:54 1761  	 SELECT
14:33:54 1762  	   ACCOUNT.ACCOUNT_STATUS_ID into var_account_status_id
14:33:54 1763  	 FROM
14:33:54 1764  	   ACCOUNT
14:33:54 1765  	 WHERE
14:33:54 1766  	   ACCOUNT.ID = var_account_id;
14:33:54 1767  
14:33:54 1768  	 IF var_account_status_id = GLOBAL_STATUSES_V22.ACCOUNT_FROZEN THEN
14:33:54 1769  	   RAISE ACCOUNT_IS_FROZEN;
14:33:54 1770  	 END IF;
14:33:54 1771  
14:33:54 1772  	 IF var_invoice_status_id != GLOBAL_STATUSES_V22.INVOICE_CLOSED THEN
14:33:54 1773  	   RAISE INVOICE_IS_NOT_CLOSED;
14:33:54 1774  	 END IF;
14:33:54 1775  
14:33:54 1776  	 BEGIN
14:33:54 1777  	   PROCS_INVOICE_V22.CALCULATE_INVOICE_AMOUNT (
14:33:54 1778  	     in_invoice_id => in_invoice_id,
14:33:54 1779  	     out_amount    => var_invoice_amount
14:33:54 1780  	   );
14:33:54 1781  	   EXCEPTION
14:33:54 1782  	     WHEN OTHERS THEN
14:33:54 1783  	       EXCEPTION_MESSAGE := SQLERRM;
14:33:54 1784  	       RAISE CAN_NOT_CALC_INVOICE_AMOUNT;
14:33:54 1785  	 END;
14:33:54 1786  
14:33:54 1787  	 IF ( in_refund_amount > var_invoice_amount ) THEN
14:33:54 1788  	   RAISE REFUND_IS_GREATER_THAN_ANOUNT;
14:33:54 1789  	 END IF;
14:33:54 1790  
14:33:54 1791  	 SELECT /*+ STAR_TRANSFORMATION */
14:33:54 1792  	   SUM(CHARGE.CHARGE_AMOUNT) into var_refunds_before
14:33:54 1793  	 FROM
14:33:54 1794  	   CHARGE
14:33:54 1795  	 WHERE
14:33:54 1796  	   CHARGE.INVOICE_ID = in_invoice_id
14:33:54 1797  	   AND (
14:33:54 1798  	     CHARGE.CHARGE_STATUS_ID = GLOBAL_STATUSES_V22.CHARGE_OPENED
14:33:54 1799  	     OR (
14:33:54 1800  	       CHARGE.CHARGE_STATUS_ID = GLOBAL_STATUSES_V22.CHARGE_PROCESSED
14:33:54 1801  	       AND EXISTS (
14:33:54 1802  		 SELECT 1 FROM TRANSACTION_ATTEMPT ta where ta.transaction_id = CHARGE.TRANSACTION_ID and ta.transaction_attempt_status_id = GLOBAL_STATUSES_V22.TRANS_ATTEMPT_SUCCESS
14:33:54 1803  	       )
14:33:54 1804  	     )
14:33:54 1805  	   )
14:33:54 1806  	   AND CHARGE.CHARGE_AMOUNT < 0;
14:33:54 1807  
14:33:54 1808  	 -- Refunds are negative
14:33:54 1809  	 IF var_refunds_before IS NULL THEN var_refunds_before := 0; END IF;
14:33:54 1810  	 var_refunds_before := 0 - var_refunds_before;
14:33:54 1811  
14:33:54 1812  	 var_charges_amount := 0;
14:33:54 1813  
14:33:54 1814  	 FOR f_processed_charges IN (
14:33:54 1815  	   SELECT
14:33:54 1816  	     CHARGE.CHARGE_AMOUNT
14:33:54 1817  	   FROM
14:33:54 1818  	     CHARGE
14:33:54 1819  	   WHERE
14:33:54 1820  	     CHARGE.INVOICE_ID = in_invoice_id
14:33:54 1821  	     AND CHARGE.CHARGE_AMOUNT > 0
14:33:54 1822  	     AND CHARGE.CHARGE_STATUS_ID IN (SELECT GLOBAL_STATUSES_V22.CHARGE_PROCESSED FROM DUAL)
14:33:54 1823  	     AND EXISTS (SELECT 1 FROM TRANSACTION_ATTEMPT ta where ta.transaction_id = CHARGE.TRANSACTION_ID and ta.transaction_attempt_status_id = GLOBAL_STATUSES_V22.TRANS_ATTEMPT_SUCCESS)
14:33:54 1824  	 )
14:33:54 1825  	 LOOP
14:33:54 1826  	   var_charges_amount := var_charges_amount + f_processed_charges.CHARGE_AMOUNT;
14:33:54 1827  	 END LOOP;
14:33:54 1828  
14:33:54 1829  	 IF (in_refund_amount + var_refunds_before > var_invoice_amount) THEN
14:33:54 1830  	   RAISE TOT_REF_IS_GREATER_THAN_ANOUNT;
14:33:54 1831  	 END IF;
14:33:54 1832  
14:33:54 1833  	 IF (in_refund_amount + var_refunds_before > var_charges_amount) THEN
14:33:54 1834  	   RAISE TOT_REF_IS_GRATER_THAN_CHARGES;
14:33:54 1835  	 END IF;
14:33:54 1836  
14:33:54 1837  	 BEGIN
14:33:54 1838  	   PROCS_TRANSACTION_V22.CREATE_TRANSACTION(
14:33:54 1839  	     in_transaction_id	       => NULL,
14:33:54 1840  	     in_status_id	       => GLOBAL_STATUSES_V22.TRANSACTION_PREPARE,
14:33:54 1841  	     in_amount		       => -in_refund_amount,
14:33:54 1842  	     in_created_by	       => in_created_by,
14:33:54 1843  	     in_order_id	       => NULL,
14:33:54 1844  	     in_is_refund	       => GLOBAL_CONSTANTS_V22.TRUE,
14:33:54 1845  	     in_transaction_type_code  => 'REFUND',
14:33:54 1846  	     out_transaction_id        => var_new_transaction_id
14:33:54 1847  	   );
14:33:54 1848  	   EXCEPTION
14:33:54 1849  	     WHEN OTHERS THEN
14:33:54 1850  	       EXCEPTION_MESSAGE := SQLERRM;
14:33:54 1851  	       RAISE CAN_NOT_CREATE_TRANSACTION;
14:33:54 1852  	 END;
14:33:54 1853  
14:33:54 1854  	 BEGIN
14:33:54 1855  	   PROCS_CHARGE_V22.CREATE_CHARGE(
14:33:54 1856  	     in_invoice_id	   => in_invoice_id,
14:33:54 1857  	     in_transaction_id	   => var_new_transaction_id,
14:33:54 1858  	     in_instrument_type_id => var_instrument_type_id,
14:33:54 1859  	     in_instrument_id	   => var_instrument_id,
14:33:54 1860  	     in_charge_amount	   => -in_refund_amount,
14:33:54 1861  	     in_created_by	   => in_created_by,
14:33:54 1862  	     in_charge_status_id   => GLOBAL_STATUSES_V22.CHARGE_OPENED,
14:33:54 1863  	     out_charge_id	   => var_new_charge_id
14:33:54 1864  	   );
14:33:54 1865  	   EXCEPTION
14:33:54 1866  	     WHEN OTHERS THEN
14:33:54 1867  	       EXCEPTION_MESSAGE := SQLERRM;
14:33:54 1868  	       RAISE CAN_NOT_CREATE_CHARGE;
14:33:54 1869  	 END;
14:33:54 1870  
14:33:54 1871  	 out_charge_id := var_new_charge_id;
14:33:54 1872  
14:33:54 1873  	 IF in_note IS NOT NULL AND var_subscription_id IS NOT NULL THEN
14:33:54 1874  	   BEGIN
14:33:54 1875  	     PROCS_SUBSCRIPTION_V22.ANNOTATE_SUBSCRIPTION(
14:33:54 1876  	       in_subscription_id => var_subscription_id,
14:33:54 1877  	       in_agent_id	  => 0, -- AGENT_ID??
14:33:54 1878  	       in_note		  => in_note,
14:33:54 1879  	       in_created_by	  => in_created_by
14:33:54 1880  	     );
14:33:54 1881  	     EXCEPTION
14:33:54 1882  	       WHEN OTHERS THEN
14:33:54 1883  		 EXCEPTION_MESSAGE := SQLERRM;
14:33:54 1884  		 RAISE CAN_NOT_ANNOTATE_SUBSCRIPTION;
14:33:54 1885  	   END;
14:33:54 1886  	 END IF;
14:33:54 1887  
14:33:54 1888  EXCEPTION
14:33:54 1889  WHEN CAN_NOT_FIND_SUBSCR_OR_GC THEN
14:33:54 1890  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1891  	   SPROC_NAME, 'Could not find subscription or GC for the inovice');
14:33:54 1892  WHEN INVOICE_IS_NOT_CLOSED THEN
14:33:54 1893  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:54 1894  	   SPROC_NAME, 'Invoice is not closed');
14:33:54 1895  WHEN ACCOUNT_IS_FROZEN THEN
14:33:54 1896  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:54 1897  	   SPROC_NAME, 'Could not refund subscription for frozen account');
14:33:54 1898  WHEN BAD_INVOICE_ID THEN
14:33:54 1899  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1900  	   SPROC_NAME, 'No such invoice');
14:33:54 1901  WHEN CAN_NOT_CALC_INVOICE_AMOUNT THEN
14:33:54 1902  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 1903  	   SPROC_NAME, 'Could not calculate invoice amount', EXCEPTION_MESSAGE);
14:33:54 1904  WHEN REFUND_IS_GREATER_THAN_ANOUNT THEN
14:33:54 1905  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:54 1906  	   SPROC_NAME, 'Refund is greater than amount');
14:33:54 1907  WHEN TOT_REF_IS_GREATER_THAN_ANOUNT THEN
14:33:54 1908  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:54 1909  	   SPROC_NAME, 'There were refunds before and sum of all refunds and new refund more than invoice amount');
14:33:54 1910  WHEN TOT_REF_IS_GRATER_THAN_CHARGES THEN
14:33:54 1911  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:54 1912  	   SPROC_NAME, 'Total refund amount is greater than sum of processed charges');
14:33:54 1913  WHEN CAN_NOT_CREATE_TRANSACTION THEN
14:33:54 1914  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 1915  	   SPROC_NAME, 'Could not create transaction', EXCEPTION_MESSAGE);
14:33:54 1916  WHEN CAN_NOT_CREATE_CHARGE THEN
14:33:54 1917  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 1918  	   SPROC_NAME, 'Could not create charge', EXCEPTION_MESSAGE);
14:33:54 1919  WHEN CAN_NOT_ANNOTATE_SUBSCRIPTION THEN
14:33:54 1920  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 1921  	   SPROC_NAME, 'Could not annotate subscription', EXCEPTION_MESSAGE);
14:33:54 1922  WHEN OTHERS THEN
14:33:54 1923  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1924  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1925  END REFUND_INVOICE;
14:33:54 1926  
14:33:54 1927  /******************************************************************************/
14:33:54 1928  
14:33:54 1929  PROCEDURE GET_PAYMENT_INFO_BY_INVOICE_ID (
14:33:54 1930  	 in_invoice_id		     IN NUMBER,
14:33:54 1931  	 out_order_id		     OUT VARCHAR2,
14:33:54 1932  	 out_external_transaction_id OUT VARCHAR2
14:33:54 1933  ) AS
14:33:54 1934  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_PEYMENT_INFO_BY_INVOICE_ID';
14:33:54 1935  -- VARIABLES
14:33:54 1936  temp_invoice_id number;
14:33:54 1937  cnt_matched_instr number := 0;
14:33:54 1938  -- EXCEPTIONS
14:33:54 1939  BAD_INVOICE_ID EXCEPTION;
14:33:54 1940  BEGIN
14:33:54 1941  
14:33:54 1942  	 BEGIN
14:33:54 1943  	   SELECT
14:33:54 1944  	     i.id into temp_invoice_id
14:33:54 1945  	   from
14:33:54 1946  	     invoice i
14:33:54 1947  	   where
14:33:54 1948  	     i.id = in_invoice_id;
14:33:54 1949  	   EXCEPTION
14:33:54 1950  	     WHEN NO_DATA_FOUND THEN
14:33:54 1951  	       RAISE BAD_INVOICE_ID;
14:33:54 1952  	 END;
14:33:54 1953  
14:33:54 1954  	 select
14:33:54 1955  	   count(1) into cnt_matched_instr
14:33:54 1956  	 from
14:33:54 1957  	   charge ch
14:33:54 1958  	 inner join
14:33:54 1959  	   subscription s
14:33:54 1960  	 on
14:33:54 1961  	   s.instrument_id = ch.instrument_id
14:33:54 1962  	 where
14:33:54 1963  	   ch.invoice_id = in_invoice_id;
14:33:54 1964  
14:33:54 1965  	 if cnt_matched_instr = 0 then
14:33:54 1966  	   out_external_transaction_id := null;
14:33:54 1967  	   out_order_id := null;
14:33:54 1968  	   return;
14:33:54 1969  	 end if;
14:33:54 1970  
14:33:54 1971  	 SELECT
14:33:54 1972  	   t.order_id,
14:33:54 1973  	   ta.external_transaction_id
14:33:54 1974  	   into
14:33:54 1975  	   out_order_id,
14:33:54 1976  	   out_external_transaction_id
14:33:54 1977  	 from
14:33:54 1978  	   charge ch
14:33:54 1979  	   inner join transaction t on ch.transaction_id = t.id
14:33:54 1980  	   inner join transaction_attempt ta on ta.transaction_id = t.id
14:33:54 1981  	 where
14:33:54 1982  	   ch.invoice_id = in_invoice_id
14:33:54 1983  	   and ta.transaction_attempt_status_id = GLOBAL_STATUSES_V22.TRANS_ATTEMPT_SUCCESS
14:33:54 1984  	   and ch.charge_amount > 0; -- We are not creating charges for the 0-amount invoices
14:33:54 1985  
14:33:54 1986  EXCEPTION
14:33:54 1987  WHEN BAD_INVOICE_ID THEN
14:33:54 1988  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1989  	   SPROC_NAME, 'No such invoice');
14:33:54 1990  WHEN NO_DATA_FOUND THEN
14:33:54 1991  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1992  	   SPROC_NAME, 'No payment data found');
14:33:54 1993  WHEN OTHERS THEN
14:33:54 1994  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1995  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1996  END GET_PAYMENT_INFO_BY_INVOICE_ID;
14:33:54 1997  
14:33:54 1998  PROCEDURE IS_REVOKE_ENTITLEMENTS(
14:33:54 1999  	 in_invoice_id IN NUMBER,
14:33:54 2000  	 out_is_revoke OUT NUMBER
14:33:54 2001  ) AS
14:33:54 2002  BEGIN
14:33:54 2003  	 SELECT DECODE(COUNT(1), 0, GLOBAL_CONSTANTS_V22.FALSE, GLOBAL_CONSTANTS_V22.TRUE)
14:33:54 2004  	   into out_is_revoke
14:33:54 2005  	 FROM
14:33:54 2006  	   offer_chain oc,
14:33:54 2007  	   subscription s,
14:33:54 2008  	   license l,
14:33:54 2009  	   invoice i
14:33:54 2010  	 where
14:33:54 2011  	   oc.id = s.offer_chain_id and
14:33:54 2012  	   s.id = l.subscription_id and
14:33:54 2013  	   l.invoice_id = i.id and
14:33:54 2014  	   oc.revoke_entitlements = GLOBAL_CONSTANTS_V22.TRUE and
14:33:54 2015  	   i.id = in_invoice_id and
14:33:54 2016  	   rownum < 2
14:33:54 2017  	 ;
14:33:54 2018  END IS_REVOKE_ENTITLEMENTS;
14:33:54 2019  
14:33:54 2020  END PROCS_INVOICE_V22;
14:33:54 2021  .
14:33:54 SQL> /

Package body created.

Elapsed: 00:00:00.14
14:33:54 SQL> 
14:33:54 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_FIN_INSTRUMENTS_V22" AS
14:33:54   2  
14:33:54   3  PROCEDURE UPDATE_GC_STATUS_BY_INVOICE(
14:33:54   4  	  in_invoice_id IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
14:33:54   5  	  in_status_id	IN GIFT_CERTIFICATE_STATUS.ID%TYPE,
14:33:54   6  	  in_updater	IN GIFT_CERTIFICATE.UPDATED_BY%TYPE)
14:33:54   7  AS
14:33:54   8  SPROC_NAME CONSTANT VARCHAR2(32) := 'UPDATE_GC_STATUS_BY_INVOICE';
14:33:54   9  BEGIN
14:33:54  10  	FOR rec IN (SELECT id FROM Gift_Certificate WHERE Purchase_Invoice_Id = in_invoice_id) LOOP
14:33:54  11  	  PROCS_FIN_INSTRUMENTS_CRU_V22.UPDATE_GIFT_CERTIFICATE (
14:33:54  12  	    in_gift_certificate_id	  => rec.Id,
14:33:54  13  	    in_gift_certificate_status_id => in_status_id,
14:33:54  14  	    in_updated_by		  => in_updater
14:33:54  15  	  );
14:33:54  16  	END LOOP;
14:33:54  17  END UPDATE_GC_STATUS_BY_INVOICE;
14:33:54  18  
14:33:54  19  PROCEDURE IS_INVOICE_FOR_REDEEMED_GC (
14:33:54  20  	in_invoice_id		     IN NUMBER,
14:33:54  21  	out_is_invoice_for_redeem_gc OUT NUMBER
14:33:54  22  ) AS
14:33:54  23  SPROC_NAME CONSTANT VARCHAR2(32) := 'IS_INVOICE_FOR_REDEEMED_GC';
14:33:54  24  var_is_for_gc NUMBER;
14:33:54  25  BEGIN
14:33:54  26  	SELECT
14:33:54  27  	  count(1) into var_is_for_gc
14:33:54  28  	FROM GIFT_CERTIFICATE GC
14:33:54  29  	WHERE GC.PURCHASE_INVOICE_ID = in_invoice_id AND
14:33:54  30  	      GC.GIFT_CERTIFICATE_STATUS_ID = 2;
14:33:54  31  
14:33:54  32  	IF var_is_for_gc > 0 THEN
14:33:54  33  	  out_is_invoice_for_redeem_gc := 1;
14:33:54  34  	ELSE
14:33:54  35  	  out_is_invoice_for_redeem_gc := 0;
14:33:54  36  	END IF;
14:33:54  37  END IS_INVOICE_FOR_REDEEMED_GC;
14:33:54  38  
14:33:54  39  PROCEDURE GET_UNREDEEMED_GCS (
14:33:54  40  	out_result_set		OUT SYS_REFCURSOR,
14:33:54  41  	in_hours_number 	IN NUMBER DEFAULT 14*24,
14:33:54  42  	in_num_rows		IN NUMBER DEFAULT 10000,
14:33:54  43  	in_process_name IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE
14:33:54  44  ) AS
14:33:54  45  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_UNREDEEMED_GCS';
14:33:54  46  BEGIN
14:33:54  47  	OPEN out_result_set FOR
14:33:54  48  SELECT * FROM
14:33:54  49  (
14:33:54  50  	SELECT
14:33:54  51  	  gc.EXPIRATION_DATE,
14:33:54  52  	  ch.name,
14:33:54  53  	  ch.id offer_chain_id,
14:33:54  54  	  gc.sender_email,
14:33:54  55  	  gc.sender_name,
14:33:54  56  	  gc.recipient_email,
14:33:54  57  	  gc.recipient_name,
14:33:54  58  	  gc.purchase_date,
14:33:54  59  	  gc.redemption_date,
14:33:54  60  	  gc.purchaser_group_id,
14:33:54  61  	  gc.redeemer_group_id,
14:33:54  62  	  gc.code,
14:33:54  63  	  gc.gift_message,
14:33:54  64  	  gc.recipient_notify_date,
14:33:54  65  	  gc.id
14:33:54  66  	FROM
14:33:54  67  	  GIFT_CERTIFICATE gc,
14:33:54  68  	  OFFER_CHAIN ch
14:33:54  69  	WHERE
14:33:54  70  	  ch.id = gc.offer_chain_id
14:33:54  71  	  AND gc.RECIPIENT_NOTIFY_DATE is not null
14:33:54  72  	  AND gc.RECIPIENT_NOTIFY_DATE >= (sysdate - in_hours_number/24)
14:33:54  73  	  AND gc.RECIPIENT_NOTIFY_DATE < (sysdate - (in_hours_number-72)/24)
14:33:54  74  	  AND gc.redeemer_group_id is null
14:33:54  75  	  AND NOT EXISTS(
14:33:54  76  	    SELECT NULL
14:33:54  77  	    FROM PROCESS_RETRY_THROTTLE
14:33:54  78  	    WHERE PROCESS_NAME = in_process_name
14:33:54  79  	      AND GENERIC_ID = gc.id
14:33:54  80  	  ) AND EXISTS(
14:33:54  81  	    SELECT NULL
14:33:54  82  	    FROM
14:33:54  83  	      charge c,
14:33:54  84  	      transaction_attempt ta,
14:33:54  85  	      transaction t
14:33:54  86  	    WHERE
14:33:54  87  	      c.invoice_id = gc.purchase_invoice_id and
14:33:54  88  	      c.transaction_id = t.id and
14:33:54  89  	      t.id = ta.transaction_id and
14:33:54  90  	      ta.transaction_attempt_status_id = GLOBAL_STATUSES_V22.TRANS_ATTEMPT_SUCCESS
14:33:54  91  	  ) AND NOT EXISTS (
14:33:54  92  	    SELECT NULL
14:33:54  93  	    FROM
14:33:54  94  	      charge c,
14:33:54  95  	      transaction t
14:33:54  96  	    WHERE
14:33:54  97  	      c.invoice_id = gc.purchase_invoice_id and
14:33:54  98  	      c.transaction_id = t.id and
14:33:54  99  	      t.is_refund = GLOBAL_CONSTANTS_V22.TRUE
14:33:54 100  	  )
14:33:54 101  	  AND ROWNUM <= in_num_rows*10
14:33:54 102  	  ORDER BY dbms_random.value
14:33:54 103  ) WHERE
14:33:54 104  	  ROWNUM <= in_num_rows;
14:33:54 105  EXCEPTION
14:33:54 106  WHEN OTHERS THEN
14:33:54 107  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 108  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 109  END GET_UNREDEEMED_GCS;
14:33:54 110  
14:33:54 111  PROCEDURE ADD_CREDIT_CARD (
14:33:54 112  /*
14:33:54 113  Throws exceptions:
14:33:54 114  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 115  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 116  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:54 117  */
14:33:54 118  	in_group_id		  IN NUMBER,
14:33:54 119  	in_updated_by		  IN VARCHAR2,
14:33:54 120  	in_instrument_name	  IN VARCHAR2,
14:33:54 121  	in_card_holder_name	  IN VARCHAR2,
14:33:54 122  	in_street_address	  IN VARCHAR2,
14:33:54 123  	in_street_address2	  IN VARCHAR2,
14:33:54 124  	in_state		  IN VARCHAR2,
14:33:54 125  	in_city 		  IN VARCHAR2,
14:33:54 126  	in_postal_code		  IN VARCHAR2,
14:33:54 127  	in_country		  IN CHAR,
14:33:54 128  	in_last_four_cc 	  IN VARCHAR2,
14:33:54 129  	in_expiration_date	  IN DATE,
14:33:54 130  	in_credit_card_type_id	  IN NUMBER,
14:33:54 131  	in_token		  IN VARCHAR2,
14:33:54 132  	in_chase_profile_id	  IN VARCHAR2,
14:33:54 133  	in_credit_card_status_id  IN NUMBER,
14:33:54 134  	in_private_first_name	  IN VARCHAR2,
14:33:54 135  	in_private_last_name	  IN VARCHAR2,
14:33:54 136  	out_credit_card_id	  OUT NUMBER
14:33:54 137  ) AS
14:33:54 138  SPROC_NAME	     CONSTANT VARCHAR2(15) := 'ADD_CREDIT_CARD';
14:33:54 139  -- VARIABLES
14:33:54 140  var_account_id	      NUMBER;
14:33:54 141  var_account_status      NUMBER;
14:33:54 142  var_credit_card_id      NUMBER;
14:33:54 143  temp_old_credit_card_id NUMBER;
14:33:54 144  -- EXCEPTIONS
14:33:54 145  BAD_ACCOUNT_STATUS	 EXCEPTION;
14:33:54 146  CAN_NOT_SET_DEF_FINANCIAL  EXCEPTION;
14:33:54 147  BAD_IS_DEFAULT_VALUE	 EXCEPTION;
14:33:54 148  BAD_OLD_CREDIT_CARD	 EXCEPTION;
14:33:54 149  EXCEPTION_MESSAGE 	 VARCHAR2(1024);
14:33:54 150  ----- DELETE NEXT LINES WHEN UI WILL SUPPORT MANY CC PER ACCOUNT
14:33:54 151  var_charges_set		SYS_REFCURSOR;
14:33:54 152  var_charge_id		NUMBER;
14:33:54 153  var_charge_invoice_id	NUMBER;
14:33:54 154  var_charge_transaction_id NUMBER;
14:33:54 155  var_charge_amount 	NUMBER(10,2);
14:33:54 156  temp_out_charge_id	NUMBER;
14:33:54 157  temp_out_transaction_id	NUMBER;
14:33:54 158  var_order_id			VARCHAR2(1024);
14:33:54 159  BEGIN
14:33:54 160  
14:33:54 161  	-- Get account id
14:33:54 162  	-- Get account status
14:33:54 163  	SELECT
14:33:54 164  	  ACCOUNT.ID,
14:33:54 165  	  ACCOUNT.ACCOUNT_STATUS_ID
14:33:54 166  	  into
14:33:54 167  	  var_account_id,
14:33:54 168  	  var_account_status
14:33:54 169  	FROM
14:33:54 170  	  ACCOUNT
14:33:54 171  	WHERE
14:33:54 172  	  ACCOUNT.GROUP_ID = in_group_id;
14:33:54 173  
14:33:54 174  	SELECT
14:33:54 175  	  CC_ID_SEQ.nextVal into var_credit_card_id
14:33:54 176  	FROM DUAL;
14:33:54 177  
14:33:54 178  	-- Insert new row in CREDIT_CARD table
14:33:54 179  	PROCS_FIN_INSTRUMENTS_CRU_V22.CREATE_CREDIT_CARD(
14:33:54 180  	  out_credit_card_id	      => var_credit_card_id,
14:33:54 181  	  in_account_id 	      => var_account_id,
14:33:54 182  	  in_instrument_name	      => in_instrument_name,
14:33:54 183  	  in_private_card_holder_name => in_card_holder_name,
14:33:54 184  	  in_private_street_address   => in_street_address,
14:33:54 185  	  in_private_street_address2  => in_street_address2,
14:33:54 186  	  in_state		      => in_state,
14:33:54 187  	  in_city		      => in_city,
14:33:54 188  	  in_postal_code	      => in_postal_code,
14:33:54 189  	  in_country		      => in_country,
14:33:54 190  	  in_last_four_cc	      => in_last_four_cc,
14:33:54 191  	  in_expiration_date	      => in_expiration_date,
14:33:54 192  	  in_credit_card_type_id      => in_credit_card_type_id,
14:33:54 193  	  in_secret_token	      => in_token,
14:33:54 194  	  in_chase_profile_id	      => in_chase_profile_id,
14:33:54 195  	  in_created_by 	      => in_updated_by,
14:33:54 196  	  in_credit_card_status_id    => in_credit_card_status_id,
14:33:54 197  	  in_private_first_name       => in_private_first_name,
14:33:54 198  	  in_private_last_name	      => in_private_last_name
14:33:54 199  	);
14:33:54 200  
14:33:54 201  	out_credit_card_id := var_credit_card_id;
14:33:54 202  
14:33:54 203  EXCEPTION
14:33:54 204  WHEN NO_DATA_FOUND THEN
14:33:54 205  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 206  	  SPROC_NAME, 'No such account');
14:33:54 207  WHEN BAD_OLD_CREDIT_CARD THEN
14:33:54 208  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 209  	  SPROC_NAME, 'Bad old credit card id');
14:33:54 210  WHEN BAD_IS_DEFAULT_VALUE THEN
14:33:54 211  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:54 212  	  SPROC_NAME, 'Bad is_default value');
14:33:54 213  WHEN CAN_NOT_SET_DEF_FINANCIAL THEN
14:33:54 214  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 215  	  SPROC_NAME, 'Can not set default finansial instrument', EXCEPTION_MESSAGE);
14:33:54 216  WHEN BAD_ACCOUNT_STATUS THEN
14:33:54 217  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:54 218  	  SPROC_NAME, 'Account is not active');
14:33:54 219  WHEN OTHERS THEN
14:33:54 220  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 221  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 222  END ADD_CREDIT_CARD;
14:33:54 223  
14:33:54 224  /******************************************************************************/
14:33:54 225  
14:33:54 226  PROCEDURE ADD_PAYPAL (
14:33:54 227  /*
14:33:54 228  Throws exceptions:
14:33:54 229  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 230  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 231  */
14:33:54 232  	in_group_id			IN NUMBER,
14:33:54 233  	in_instrument_name		IN VARCHAR2,
14:33:54 234  	in_private_email_address	IN VARCHAR2,
14:33:54 235  	in_created_by			IN VARCHAR2,
14:33:54 236  	in_paypal_status_id		IN NUMBER,
14:33:54 237  	in_paypal_prvt_street_address	IN VARCHAR2,
14:33:54 238  	in_paypal_prvt_street_address2	IN VARCHAR2,
14:33:54 239  	in_state			IN VARCHAR2,
14:33:54 240  	in_city 			IN VARCHAR2,
14:33:54 241  	in_postal_code			IN VARCHAR2,
14:33:54 242  	in_country			IN CHAR,
14:33:54 243  	in_expiration_date		IN DATE,
14:33:54 244  	in_secret_token 		IN VARCHAR2,
14:33:54 245  	out_paypal_id			OUT NUMBER
14:33:54 246  ) AS
14:33:54 247  SPROC_NAME CONSTANT VARCHAR2(10) := 'ADD_PAYPAL';
14:33:54 248  var_paypal_id NUMBER;
14:33:54 249  var_account_id  NUMBER;
14:33:54 250  -- EXCEPTIONS
14:33:54 251  BAD_GROUP_ID	    EXCEPTION;
14:33:54 252  CAN_NOT_CREATE_PAYPAL EXCEPTION;
14:33:54 253  BAD_PAYPAL_STATUS     EXCEPTION;
14:33:54 254  EXCEPTION_MESSAGE VARCHAR2(1024);
14:33:54 255  BEGIN
14:33:54 256  
14:33:54 257  	IF in_paypal_status_id != GLOBAL_STATUSES_V22.PAYPAL_ACTIVE
14:33:54 258  	  AND in_paypal_status_id != GLOBAL_STATUSES_V22.PAYPAL_INACTIVE
14:33:54 259  	  AND in_paypal_status_id != GLOBAL_STATUSES_V22.PAYPAL_FROZEN THEN
14:33:54 260  	  RAISE BAD_PAYPAL_STATUS;
14:33:54 261  	END IF;
14:33:54 262  
14:33:54 263  	BEGIN
14:33:54 264  	  SELECT
14:33:54 265  	    a.id into var_account_id
14:33:54 266  	  from
14:33:54 267  	    account a
14:33:54 268  	  where
14:33:54 269  	    a.group_id = in_group_id;
14:33:54 270  	  EXCEPTION
14:33:54 271  	    WHEN NO_DATA_FOUND THEN
14:33:54 272  	      RAISE BAD_GROUP_ID;
14:33:54 273  	END;
14:33:54 274  
14:33:54 275  	BEGIN
14:33:54 276  	  PROCS_FIN_INSTRUMENTS_CRU_V22.CREATE_PAYPAL(
14:33:54 277  	    out_paypal_id		   => var_paypal_id,
14:33:54 278  	    in_paypal_id		   => NULL,
14:33:54 279  	    in_account_id		   => var_account_id,
14:33:54 280  	    in_instrument_name		   => in_instrument_name,
14:33:54 281  	    in_private_email_address	   => in_private_email_address,
14:33:54 282  	    in_created_by		   => in_created_by,
14:33:54 283  	    in_paypal_status_id 	   => in_paypal_status_id,
14:33:54 284  	    in_paypal_prvt_street_address  => in_paypal_prvt_street_address,
14:33:54 285  	    in_paypal_prvt_street_address2 => in_paypal_prvt_street_address2,
14:33:54 286  	    in_state			   => in_state,
14:33:54 287  	    in_city			   => in_city,
14:33:54 288  	    in_postal_code		   => in_postal_code,
14:33:54 289  	    in_country			   => in_country,
14:33:54 290  	    in_expiration_date		   => in_expiration_date,
14:33:54 291  	    in_secret_token		   => in_secret_token
14:33:54 292  	  );
14:33:54 293  	  EXCEPTION
14:33:54 294  	    WHEN OTHERS THEN
14:33:54 295  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:54 296  	      RAISE CAN_NOT_CREATE_PAYPAL;
14:33:54 297  	END;
14:33:54 298  
14:33:54 299  	out_paypal_id := var_paypal_id;
14:33:54 300  
14:33:54 301  EXCEPTION
14:33:54 302  WHEN BAD_GROUP_ID THEN
14:33:54 303  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 304  	  SPROC_NAME, 'No such group id');
14:33:54 305  WHEN BAD_PAYPAL_STATUS THEN
14:33:54 306  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 307  	  SPROC_NAME, 'Bad paypal status');
14:33:54 308  WHEN CAN_NOT_CREATE_PAYPAL THEN
14:33:54 309  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 310  	  SPROC_NAME, 'Could not create paypal', EXCEPTION_MESSAGE);
14:33:54 311  WHEN OTHERS THEN
14:33:54 312  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 313  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 314  END ADD_PAYPAL;
14:33:54 315  
14:33:54 316  /******************************************************************************/
14:33:54 317  
14:33:54 318  PROCEDURE DISABLE_CREDIT_CARD (
14:33:54 319  /*
14:33:54 320  Throws exceptions:
14:33:54 321  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 322  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 323  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:54 324  */
14:33:54 325  	in_credit_card_id IN NUMBER,
14:33:54 326  	in_updated_by	  IN VARCHAR2
14:33:54 327  ) AS
14:33:54 328  SPROC_NAME		   CONSTANT VARCHAR2(19) := 'DISABLE_CREDIT_CARD';
14:33:54 329  -- VARIBLES
14:33:54 330  var_account_id		     NUMBER;
14:33:54 331  var_group_id		     NUMBER;
14:33:54 332  var_credit_card_status	     NUMBER;
14:33:54 333  var_pending_transactions_num   NUMBER;
14:33:54 334  var_pending_invoices_num	     NUMBER;
14:33:54 335  current_def_instrument_type_id NUMBER;
14:33:54 336  current_def_instrument_id      NUMBER;
14:33:54 337  -- EXCEPTIONS
14:33:54 338  BAD_CC_STATUS		   EXCEPTION;
14:33:54 339  PENDING_TRANSACTIONS_FOUNDED EXCEPTION;
14:33:54 340  CAN_NOT_GET_DEF_FINANCIAL    EXCEPTION;
14:33:54 341  CAN_NOT_DEL_DEF_FINANCIAL    EXCEPTION;
14:33:54 342  CAN_NOT_DISABLE_CREDIT_CARD  EXCEPTION;
14:33:54 343  EXCEPTION_MESSAGE 	   VARCHAR2(1024);
14:33:54 344  BEGIN
14:33:54 345  
14:33:54 346  	-- Get credit card status
14:33:54 347  	-- Get account id
14:33:54 348  	SELECT
14:33:54 349  	  CREDIT_CARD.CREDIT_CARD_STATUS_ID,
14:33:54 350  	  CREDIT_CARD.ACCOUNT_ID
14:33:54 351  	  into
14:33:54 352  	  var_credit_card_status,
14:33:54 353  	  var_account_id
14:33:54 354  	FROM
14:33:54 355  	  CREDIT_CARD
14:33:54 356  	WHERE
14:33:54 357  	  CREDIT_CARD.ID = in_credit_card_id;
14:33:54 358  
14:33:54 359  	-- Check that we can disable this credit card (STUB)
14:33:54 360  	IF F_CAN_DISABLE_CREDIT_CARD(in_credit_card_id) = GLOBAL_CONSTANTS_V22.FALSE THEN
14:33:54 361  	  RAISE CAN_NOT_DISABLE_CREDIT_CARD;
14:33:54 362  	END IF;
14:33:54 363  
14:33:54 364  	-- Get account id
14:33:54 365  	SELECT
14:33:54 366  	  ACCOUNT.GROUP_ID into var_group_id
14:33:54 367  	FROM
14:33:54 368  	  ACCOUNT
14:33:54 369  	WHERE
14:33:54 370  	  ACCOUNT.ID = var_account_id;
14:33:54 371  
14:33:54 372  	-- Card should to be active
14:33:54 373  	IF var_credit_card_status != GLOBAL_STATUSES_V22.CREDIT_CARD_ACTIVE THEN
14:33:54 374  	  RAISE BAD_CC_STATUS;
14:33:54 375  	END IF;
14:33:54 376  
14:33:54 377  	-- Looking for pending transactions associated with given credit card
14:33:54 378  	SELECT
14:33:54 379  	  COUNT(*) into var_pending_invoices_num
14:33:54 380  	FROM
14:33:54 381  	  CHARGE
14:33:54 382  	  INNER JOIN TRANSACTION ON CHARGE.TRANSACTION_ID = TRANSACTION.ID
14:33:54 383  	WHERE
14:33:54 384  	  CHARGE.INSTRUMENT_TYPE_ID = GLOBAL_ENUMS_V22.INSTRUMENT_CREDIT_CARD
14:33:54 385  	  AND CHARGE.INSTRUMENT_ID = in_credit_card_id
14:33:54 386  	  AND TRANSACTION.TRANSACTION_STATUS_ID = GLOBAL_STATUSES_V22.TRANSACTION_PENDING;
14:33:54 387  
14:33:54 388  	IF var_pending_invoices_num > 0 THEN
14:33:54 389  	  RAISE PENDING_TRANSACTIONS_FOUNDED;
14:33:54 390  	END IF;
14:33:54 391  
14:33:54 392  	-- Getting current default financial instrument
14:33:54 393  	BEGIN
14:33:54 394  	  GET_DEF_FINANCIAL_INSTRUMENT(
14:33:54 395  	    in_group_id 	   => var_group_id,
14:33:54 396  	    out_instrument_type_id => current_def_instrument_type_id,
14:33:54 397  	    out_instrument_id	   => current_def_instrument_id
14:33:54 398  	  );
14:33:54 399  	  EXCEPTION
14:33:54 400  	    WHEN OTHERS THEN
14:33:54 401  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:54 402  	      RAISE CAN_NOT_GET_DEF_FINANCIAL;
14:33:54 403  	END;
14:33:54 404  
14:33:54 405  	-- Checking that credit card is not default
14:33:54 406  	IF current_def_instrument_type_id = GLOBAL_ENUMS_V22.INSTRUMENT_CREDIT_CARD
14:33:54 407  	  AND current_def_instrument_id = in_credit_card_id THEN
14:33:54 408  	  BEGIN
14:33:54 409  	    DEL_DEF_FINANCIAL_INSTRUMENT(
14:33:54 410  	      in_group_id => var_group_id
14:33:54 411  	    );
14:33:54 412  	  EXCEPTION
14:33:54 413  	    WHEN OTHERS THEN
14:33:54 414  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:54 415  	      RAISE CAN_NOT_DEL_DEF_FINANCIAL;
14:33:54 416  	  END;
14:33:54 417  	END IF;
14:33:54 418  
14:33:54 419  	-- Update credit card status
14:33:54 420  	PROCS_FIN_INSTRUMENTS_V22.UPDATE_CREDIT_CARD_STATUS(
14:33:54 421  	  in_credit_card_id	   => in_credit_card_id,
14:33:54 422  	  in_updated_by 	   => in_updated_by,
14:33:54 423  	  in_credit_card_status_id => GLOBAL_STATUSES_V22.CREDIT_CARD_DISABLED
14:33:54 424  	);
14:33:54 425  
14:33:54 426  EXCEPTION
14:33:54 427  WHEN NO_DATA_FOUND THEN
14:33:54 428  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 429  	  SPROC_NAME, 'No such credit card');
14:33:54 430  WHEN CAN_NOT_GET_DEF_FINANCIAL THEN
14:33:54 431  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 432  	  SPROC_NAME, 'Could not get current default financial instrument', EXCEPTION_MESSAGE);
14:33:54 433  WHEN CAN_NOT_DEL_DEF_FINANCIAL THEN
14:33:54 434  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 435  	  SPROC_NAME, 'Could not delete information about default financial instrument from account', EXCEPTION_MESSAGE);
14:33:54 436  WHEN BAD_CC_STATUS THEN
14:33:54 437  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:54 438  	  SPROC_NAME, 'Credit card is not active');
14:33:54 439  WHEN PENDING_TRANSACTIONS_FOUNDED THEN
14:33:54 440  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:54 441  	  SPROC_NAME, 'Account has pending charge which is using this card');
14:33:54 442  WHEN CAN_NOT_DISABLE_CREDIT_CARD THEN
14:33:54 443  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 444  	  SPROC_NAME, 'Could not disable this credit card', EXCEPTION_MESSAGE);
14:33:54 445  WHEN OTHERS THEN
14:33:54 446  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 447  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 448  END DISABLE_CREDIT_CARD;
14:33:54 449  
14:33:54 450  /******************************************************************************/
14:33:54 451  
14:33:54 452  PROCEDURE DISABLE_PAYPAL (
14:33:54 453  /*
14:33:54 454  Throws exceptions:
14:33:54 455  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 456  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 457  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:54 458  */
14:33:54 459  	in_paypal_id  IN NUMBER,
14:33:54 460  	in_updated_by IN VARCHAR2
14:33:54 461  ) AS
14:33:54 462  SPROC_NAME CONSTANT VARCHAR2(14) := 'DISABLE_PAYPAL';
14:33:54 463  -- VARIABLES
14:33:54 464  var_paypal_status_id NUMBER;
14:33:54 465  var_account_id	   NUMBER;
14:33:54 466  var_group_id	   NUMBER;
14:33:54 467  var_pending_invoices_num NUMBER;
14:33:54 468  current_def_instrument_type_id NUMBER;
14:33:54 469  current_def_instrument_id NUMBER;
14:33:54 470  -- EXCEPTIONS
14:33:54 471  BAD_PAYPAL_ID EXCEPTION;
14:33:54 472  PAYPAL_ALREADY_INACTIVE EXCEPTION;
14:33:54 473  PENDING_TRANSACTIONS_FOUND EXCEPTION;
14:33:54 474  CAN_NOT_GET_DEF_FINANCIAL EXCEPTION;
14:33:54 475  CAN_NOT_DEL_DEF_FINANCIAL EXCEPTION;
14:33:54 476  EXCEPTION_MESSAGE VARCHAR2(1024);
14:33:54 477  BEGIN
14:33:54 478  
14:33:54 479  	-- Get Paypal status
14:33:54 480  	-- Get account
14:33:54 481  	BEGIN
14:33:54 482  	  SELECT
14:33:54 483  	    PAYPAL.PAYPAL_STATUS_ID,
14:33:54 484  	    PAYPAL.ACCOUNT_ID
14:33:54 485  	    into
14:33:54 486  	    var_paypal_status_id,
14:33:54 487  	    var_account_id
14:33:54 488  	  FROM
14:33:54 489  	    PAYPAL
14:33:54 490  	  WHERE
14:33:54 491  	    PAYPAL.ID = in_paypal_id;
14:33:54 492  	  EXCEPTION
14:33:54 493  	    WHEN NO_DATA_FOUND THEN
14:33:54 494  	      RAISE BAD_PAYPAL_ID;
14:33:54 495  	END;
14:33:54 496  
14:33:54 497  	-- Get group id
14:33:54 498  	SELECT
14:33:54 499  	  ACCOUNT.GROUP_ID into var_group_id
14:33:54 500  	FROM
14:33:54 501  	  ACCOUNT
14:33:54 502  	WHERE
14:33:54 503  	  ACCOUNT.ID = var_account_id;
14:33:54 504  
14:33:54 505  	-- Card should not be disabled
14:33:54 506  	IF var_paypal_status_id = GLOBAL_STATUSES_V22.PAYPAL_INACTIVE THEN
14:33:54 507  	  RAISE PAYPAL_ALREADY_INACTIVE;
14:33:54 508  	END IF;
14:33:54 509  
14:33:54 510  	-- Looking for pending transactions associated with given credit card
14:33:54 511  	SELECT
14:33:54 512  	  COUNT(*) into var_pending_invoices_num
14:33:54 513  	FROM
14:33:54 514  	  CHARGE
14:33:54 515  	  INNER JOIN TRANSACTION ON CHARGE.TRANSACTION_ID = TRANSACTION.ID
14:33:54 516  	WHERE
14:33:54 517  	  CHARGE.INSTRUMENT_TYPE_ID = GLOBAL_ENUMS_V22.INSTRUMENT_PAYPAL
14:33:54 518  	  AND CHARGE.INSTRUMENT_ID = in_paypal_id
14:33:54 519  	  AND TRANSACTION.TRANSACTION_STATUS_ID = GLOBAL_STATUSES_V22.TRANSACTION_PENDING;
14:33:54 520  
14:33:54 521  	IF var_pending_invoices_num > 0 THEN
14:33:54 522  	  RAISE PENDING_TRANSACTIONS_FOUND;
14:33:54 523  	END IF;
14:33:54 524  
14:33:54 525  	-- Getting current default financial instrument
14:33:54 526  	BEGIN
14:33:54 527  	  GET_DEF_FINANCIAL_INSTRUMENT(
14:33:54 528  	    in_group_id 	   => var_group_id,
14:33:54 529  	    out_instrument_type_id => current_def_instrument_type_id,
14:33:54 530  	    out_instrument_id	   => current_def_instrument_id
14:33:54 531  	  );
14:33:54 532  	  EXCEPTION
14:33:54 533  	    WHEN OTHERS THEN
14:33:54 534  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:54 535  	      RAISE CAN_NOT_GET_DEF_FINANCIAL;
14:33:54 536  	END;
14:33:54 537  
14:33:54 538  	-- Checking that credit card is not default
14:33:54 539  	IF current_def_instrument_type_id = GLOBAL_ENUMS_V22.INSTRUMENT_PAYPAL
14:33:54 540  	  AND current_def_instrument_id = in_paypal_id THEN
14:33:54 541  	  BEGIN
14:33:54 542  	    DEL_DEF_FINANCIAL_INSTRUMENT(
14:33:54 543  	      in_group_id => var_group_id
14:33:54 544  	    );
14:33:54 545  	  EXCEPTION
14:33:54 546  	    WHEN OTHERS THEN
14:33:54 547  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:54 548  	      RAISE CAN_NOT_DEL_DEF_FINANCIAL;
14:33:54 549  	  END;
14:33:54 550  	END IF;
14:33:54 551  
14:33:54 552  	PROCS_FIN_INSTRUMENTS_V22.UPDATE_PAYPAL_STATUS(
14:33:54 553  	  in_paypal_id	      => in_paypal_id,
14:33:54 554  	  in_updated_by       => in_updated_by,
14:33:54 555  	  in_paypal_status_id => GLOBAL_STATUSES_V22.PAYPAL_INACTIVE
14:33:54 556  	);
14:33:54 557  
14:33:54 558  EXCEPTION
14:33:54 559  WHEN BAD_PAYPAL_ID THEN
14:33:54 560  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 561  	  SPROC_NAME, 'No such paypal');
14:33:54 562  WHEN PAYPAL_ALREADY_INACTIVE THEN
14:33:54 563  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:54 564  	  SPROC_NAME, 'Paypal already inactive');
14:33:54 565  WHEN PENDING_TRANSACTIONS_FOUND THEN
14:33:54 566  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:54 567  	  SPROC_NAME, 'Account has pending charge which are using this paypal');
14:33:54 568  WHEN CAN_NOT_GET_DEF_FINANCIAL THEN
14:33:54 569  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 570  	  SPROC_NAME, 'Could not get current default financial instrument', EXCEPTION_MESSAGE);
14:33:54 571  WHEN CAN_NOT_DEL_DEF_FINANCIAL THEN
14:33:54 572  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 573  	  SPROC_NAME, 'Could not delete information about default financial instrument from account', EXCEPTION_MESSAGE);
14:33:54 574  WHEN OTHERS THEN
14:33:54 575  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 576  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 577  END DISABLE_PAYPAL;
14:33:54 578  
14:33:54 579  /******************************************************************************/
14:33:54 580  
14:33:54 581  PROCEDURE UPDATE_CREDIT_CARD (
14:33:54 582  /*
14:33:54 583  Throws exceptions:
14:33:54 584  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 585  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 586  */
14:33:54 587  	in_credit_card_id	  IN NUMBER,
14:33:54 588  	in_updated_by		  IN VARCHAR2,
14:33:54 589  	in_instrument_name	  IN VARCHAR2,
14:33:54 590  	in_is_default		  IN NUMBER
14:33:54 591  ) AS
14:33:54 592  SPROC_NAME CONSTANT VARCHAR2(18) := 'UPDATE_CREDIT_CARD';
14:33:54 593  -- VARIABLES
14:33:54 594  var_account_id NUMBER;
14:33:54 595  var_group_id   NUMBER;
14:33:54 596  temp_cc_rownum NUMBER;
14:33:54 597  current_def_instrument_type_id NUMBER;
14:33:54 598  current_def_instrument_id      NUMBER;
14:33:54 599  -- EXCEPTION
14:33:54 600  CAN_NOT_SET_DEF_FINANCIAL  EXCEPTION;
14:33:54 601  BAD_IS_DEFAULT_VALUE	 EXCEPTION;
14:33:54 602  CAN_NOT_GET_DEF_FINANCIAL  EXCEPTION;
14:33:54 603  CAN_NOT_DEL_DEF_FINANCIAL  EXCEPTION;
14:33:54 604  EXCEPTION_MESSAGE 	 VARCHAR2(1024);
14:33:54 605  BEGIN
14:33:54 606  
14:33:54 607  	-- Get account id
14:33:54 608  	SELECT
14:33:54 609  	  CREDIT_CARD.ACCOUNT_ID
14:33:54 610  	  into
14:33:54 611  	  var_account_id
14:33:54 612  	FROM
14:33:54 613  	  CREDIT_CARD
14:33:54 614  	WHERE
14:33:54 615  	  CREDIT_CARD.ID = in_credit_card_id;
14:33:54 616  
14:33:54 617  	-- Get group id
14:33:54 618  	SELECT
14:33:54 619  	  ACCOUNT.GROUP_ID into var_group_id
14:33:54 620  	FROM
14:33:54 621  	  ACCOUNT
14:33:54 622  	WHERE
14:33:54 623  	  ACCOUNT.ID = var_account_id;
14:33:54 624  
14:33:54 625  	-- Check that passed data is correct
14:33:54 626  	IF in_is_default != GLOBAL_CONSTANTS_V22.TRUE
14:33:54 627  	  AND in_is_default != GLOBAL_CONSTANTS_V22.FALSE
14:33:54 628  	  AND in_is_default IS NOT NULL THEN
14:33:54 629  	  RAISE BAD_IS_DEFAULT_VALUE;
14:33:54 630  	END IF;
14:33:54 631  
14:33:54 632  	-- Update credit card
14:33:54 633  	IF in_instrument_name IS NOT NULL THEN
14:33:54 634  	  PROCS_FIN_INSTRUMENTS_CRU_V22.UPDATE_CREDIT_CARD(
14:33:54 635  	    in_credit_card_id  => in_credit_card_id,
14:33:54 636  	    in_updated_by      => in_updated_by,
14:33:54 637  	    in_instrument_name => in_instrument_name
14:33:54 638  	  );
14:33:54 639  	END IF;
14:33:54 640  
14:33:54 641  	-- Set default financial instrument
14:33:54 642  	IF in_is_default = GLOBAL_CONSTANTS_V22.TRUE THEN
14:33:54 643  	  BEGIN
14:33:54 644  	    PROCS_FIN_INSTRUMENTS_V22.SET_DEF_FINANCIAL_INSTRUMENT(
14:33:54 645  	      in_group_id	    => var_group_id,
14:33:54 646  	      in_instrument_type_id => GLOBAL_ENUMS_V22.INSTRUMENT_CREDIT_CARD,
14:33:54 647  	      in_instrument_id	    => in_credit_card_id,
14:33:54 648  	      in_updated_by	    => in_updated_by
14:33:54 649  	    );
14:33:54 650  	    EXCEPTION
14:33:54 651  	      WHEN OTHERS THEN
14:33:54 652  		EXCEPTION_MESSAGE := SQLERRM;
14:33:54 653  		RAISE CAN_NOT_SET_DEF_FINANCIAL;
14:33:54 654  	  END;
14:33:54 655  	END IF;
14:33:54 656  
14:33:54 657  	-- Set default financial instrument
14:33:54 658  	IF in_is_default = GLOBAL_CONSTANTS_V22.FALSE THEN
14:33:54 659  	  BEGIN
14:33:54 660  	    GET_DEF_FINANCIAL_INSTRUMENT(
14:33:54 661  	      in_group_id	     => var_group_id,
14:33:54 662  	      out_instrument_type_id => current_def_instrument_type_id,
14:33:54 663  	      out_instrument_id      => current_def_instrument_id
14:33:54 664  	    );
14:33:54 665  	  EXCEPTION
14:33:54 666  	    WHEN OTHERS THEN
14:33:54 667  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:54 668  	      RAISE CAN_NOT_GET_DEF_FINANCIAL;
14:33:54 669  	  END;
14:33:54 670  	  IF current_def_instrument_type_id = GLOBAL_ENUMS_V22.INSTRUMENT_CREDIT_CARD
14:33:54 671  	    AND current_def_instrument_id = in_credit_card_id THEN
14:33:54 672  	    BEGIN
14:33:54 673  	      DEL_DEF_FINANCIAL_INSTRUMENT(
14:33:54 674  		in_group_id => var_group_id
14:33:54 675  	      );
14:33:54 676  	      EXCEPTION
14:33:54 677  		WHEN OTHERS THEN
14:33:54 678  		  EXCEPTION_MESSAGE := SQLERRM;
14:33:54 679  		  RAISE CAN_NOT_DEL_DEF_FINANCIAL;
14:33:54 680  	    END;
14:33:54 681  	  END IF;
14:33:54 682  	END IF;
14:33:54 683  
14:33:54 684  EXCEPTION
14:33:54 685  WHEN NO_DATA_FOUND THEN
14:33:54 686  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 687  	  SPROC_NAME, 'No such credit card');
14:33:54 688  WHEN CAN_NOT_SET_DEF_FINANCIAL THEN
14:33:54 689  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 690  	  SPROC_NAME, 'Could not set default financial instrument for account', EXCEPTION_MESSAGE);
14:33:54 691  WHEN CAN_NOT_GET_DEF_FINANCIAL THEN
14:33:54 692  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 693  	  SPROC_NAME, 'Could not get default financial instrument for account', EXCEPTION_MESSAGE);
14:33:54 694  WHEN CAN_NOT_DEL_DEF_FINANCIAL THEN
14:33:54 695  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 696  	  SPROC_NAME, 'Could not delete information about default financial instrument', EXCEPTION_MESSAGE);
14:33:54 697  WHEN OTHERS THEN
14:33:54 698  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 699  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 700  END UPDATE_CREDIT_CARD;
14:33:54 701  
14:33:54 702  /******************************************************************************/
14:33:54 703  
14:33:54 704  	PROCEDURE START_GC_PURCHASING (
14:33:54 705  	  in_group_id		    IN NUMBER,
14:33:54 706  	  in_offer_chain_id	    IN VARCHAR2,
14:33:54 707  	  in_gift_certificate_code  IN	VARCHAR2,
14:33:54 708  	  in_created_by 	    IN	VARCHAR2,
14:33:54 709  	  in_recipient_name	    IN	VARCHAR2,
14:33:54 710  	  in_recipient_email	    IN	VARCHAR2,
14:33:54 711  	  in_recipient_address_id   IN NUMBER,
14:33:54 712  	  in_recipient_notify_date  IN DATE,
14:33:54 713  	  in_sender_name	    IN VARCHAR2,
14:33:54 714  	  in_sender_email	    IN VARCHAR2,
14:33:54 715  	  in_gift_message	    IN	VARCHAR2,
14:33:54 716  	  in_expiration_date	    IN DATE,
14:33:54 717  	  in_campaign		    IN VARCHAR2,
14:33:54 718  	  in_reference_code	    IN VARCHAR2,
14:33:54 719  	  out_gift_certificate_id   OUT NUMBER,
14:33:54 720  	  out_invoice_id	    OUT NUMBER
14:33:54 721  	) AS
14:33:54 722  	  SPROC_NAME CONSTANT VARCHAR2(19) := 'START_GC_PURCHASING';
14:33:54 723  -- VARIABLES
14:33:54 724  	  var_account_id	    NUMBER;
14:33:54 725  	  temp_gc_code		    GIFT_CERTIFICATE.CODE%TYPE;
14:33:54 726  	  var_och_is_gc 	    NUMBER;
14:33:54 727  	  var_offer_chain_status_id NUMBER;
14:33:54 728  	  var_is_for_redemption     NUMBER;
14:33:54 729  	  var_new_invoice_id	    NUMBER;
14:33:54 730  	  var_gift_cert_id	    NUMBER;
14:33:54 731  	  var_account_tax_exempt_id VARCHAR2(255);
14:33:54 732  -- EXCEPTIONS
14:33:54 733  	    BAD_GROUP_ID		  EXCEPTION;
14:33:54 734  	    GC_CODE_ALREADY_EXISTS	  EXCEPTION;
14:33:54 735  	    BAD_OFFER_CHAIN_ID		  EXCEPTION;
14:33:54 736  	    OCH_IS_NOT_GIFT_CERTIFICATE   EXCEPTION;
14:33:54 737  	    BAD_OFFER_CHAIN_STATUS	  EXCEPTION;
14:33:54 738  	    CAN_NOT_PURCHASE_GC_FOR_RDMPN EXCEPTION;
14:33:54 739  	    CAN_NOT_CREATE_INVOICE	  EXCEPTION;
14:33:54 740  	    OFFER_REC_NUM_LESS_THAN_ONE   EXCEPTION;
14:33:54 741  	    CAN_NOT_CREATE_LINE_ITEMS	  EXCEPTION;
14:33:54 742  	    REF_CODE_ALREADY_EXISTS	  EXCEPTION;
14:33:54 743  
14:33:54 744  	  EXCEPTION_MESSAGE VARCHAR2(1024);
14:33:54 745  	  BEGIN
14:33:54 746  -- Get account id
14:33:54 747  	    BEGIN
14:33:54 748  	      SELECT
14:33:54 749  		ACCOUNT.ID,
14:33:54 750  		ACCOUNT.TAX_EXEMPT_ID
14:33:54 751  	      into
14:33:54 752  		var_account_id,
14:33:54 753  		var_account_tax_exempt_id
14:33:54 754  	      FROM
14:33:54 755  		ACCOUNT
14:33:54 756  	      WHERE
14:33:54 757  		ACCOUNT.GROUP_ID = in_group_id;
14:33:54 758  	      EXCEPTION
14:33:54 759  	      WHEN NO_DATA_FOUND THEN
14:33:54 760  	      RAISE BAD_GROUP_ID;
14:33:54 761  	    END;
14:33:54 762  
14:33:54 763  -- Check for the same code
14:33:54 764  	    BEGIN
14:33:54 765  	      SELECT
14:33:54 766  		GIFT_CERTIFICATE.CODE into temp_gc_code
14:33:54 767  	      FROM
14:33:54 768  		GIFT_CERTIFICATE
14:33:54 769  	      WHERE
14:33:54 770  		GIFT_CERTIFICATE.CODE = in_gift_certificate_code;
14:33:54 771  
14:33:54 772  	      RAISE GC_CODE_ALREADY_EXISTS;
14:33:54 773  
14:33:54 774  	      EXCEPTION
14:33:54 775  	      WHEN NO_DATA_FOUND THEN
14:33:54 776  	      NULL;
14:33:54 777  	    END;
14:33:54 778  
14:33:54 779  -- Get offer chain flag "is_gift_certificate"
14:33:54 780  	    BEGIN
14:33:54 781  	      SELECT
14:33:54 782  		OFFER_CHAIN.IS_GIFT_CERTIFICATE,
14:33:54 783  		OFFER_CHAIN.OFFER_CHAIN_STATUS_ID
14:33:54 784  	      into
14:33:54 785  		var_och_is_gc,
14:33:54 786  		var_offer_chain_status_id
14:33:54 787  	      FROM
14:33:54 788  		OFFER_CHAIN
14:33:54 789  	      WHERE
14:33:54 790  		OFFER_CHAIN.ID = in_offer_chain_id;
14:33:54 791  	      EXCEPTION
14:33:54 792  	      WHEN NO_DATA_FOUND THEN
14:33:54 793  	      RAISE BAD_OFFER_CHAIN_ID;
14:33:54 794  	    END;
14:33:54 795  
14:33:54 796  	    IF var_och_is_gc != GLOBAL_CONSTANTS_V22.TRUE
14:33:54 797  	       OR var_och_is_gc IS NULL THEN
14:33:54 798  	      RAISE OCH_IS_NOT_GIFT_CERTIFICATE;
14:33:54 799  	    END IF;
14:33:54 800  
14:33:54 801  	    IF var_offer_chain_status_id != GLOBAL_STATUSES_V22.OFFER_CHAIN_ACTIVE THEN
14:33:54 802  	      RAISE BAD_OFFER_CHAIN_STATUS;
14:33:54 803  	    END IF;
14:33:54 804  
14:33:54 805  -- norlov: #38151 check if the OC is for Redemption:
14:33:54 806  	    SELECT
14:33:54 807  	      COUNT(*) into var_is_for_redemption
14:33:54 808  	    FROM
14:33:54 809  	      OFFER_CHAIN_ELIGIBILITY
14:33:54 810  	    WHERE
14:33:54 811  	      OFFER_CHAIN_ELIGIBILITY.OFFER_CHAIN_ID = in_offer_chain_id
14:33:54 812  	      AND OFFER_CHAIN_ELIGIBILITY.NAME = GLOBAL_CONSTANTS_V22.GIFT_CERTIFICATE_REQUIRED
14:33:54 813  	      AND OFFER_CHAIN_ELIGIBILITY.VALUE = GLOBAL_CONSTANTS_V22.ELIGIBILITY_FLAG_SET;
14:33:54 814  
14:33:54 815  	    IF var_is_for_redemption > 0 THEN
14:33:54 816  	      RAISE CAN_NOT_PURCHASE_GC_FOR_RDMPN;
14:33:54 817  	    END IF;
14:33:54 818  
14:33:54 819  -- Create new invoice
14:33:54 820  	    BEGIN
14:33:54 821  	      PROCS_INVOICE_V22.CREATE_INVOICE(
14:33:54 822  		  in_invoice_status => GLOBAL_STATUSES_V22.INVOICE_OPEN,
14:33:54 823  		  in_created_by     => in_created_by,
14:33:54 824  		  in_tax_exempt_id  => var_account_tax_exempt_id,
14:33:54 825  		  out_invoice_id    => var_new_invoice_id
14:33:54 826  	      );
14:33:54 827  	      EXCEPTION
14:33:54 828  	      WHEN OTHERS THEN
14:33:54 829  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:54 830  	      RAISE CAN_NOT_CREATE_INVOICE;
14:33:54 831  	    END;
14:33:54 832  
14:33:54 833  -- Add line items for new invoice
14:33:54 834  	    BEGIN
14:33:54 835  	      FOR f_offer_data IN (
14:33:54 836  	      SELECT
14:33:54 837  		OFFER_ID,
14:33:54 838  		NUM_RECURRENCES
14:33:54 839  	      FROM
14:33:54 840  		OFFER_OFFER_CHAIN
14:33:54 841  	      WHERE
14:33:54 842  		OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_id
14:33:54 843  	      )
14:33:54 844  	      LOOP
14:33:54 845  	      IF f_offer_data.NUM_RECURRENCES < 1 THEN
14:33:54 846  		RAISE OFFER_REC_NUM_LESS_THAN_ONE;
14:33:54 847  	      END IF;
14:33:54 848  	      FOR i_offer_recurrences_iterator IN 1..f_offer_data.NUM_RECURRENCES
14:33:54 849  	      LOOP
14:33:54 850  		PROCS_LINE_ITEMS_V22.ADD_LINE_ITEMS(
14:33:54 851  		    in_invoice_id => var_new_invoice_id,
14:33:54 852  		    in_offer_id   => f_offer_data.OFFER_ID,
14:33:54 853  		    in_created_by => in_created_by
14:33:54 854  		);
14:33:54 855  	      END LOOP;
14:33:54 856  	      END LOOP;
14:33:54 857  
14:33:54 858  	      EXCEPTION
14:33:54 859  	      WHEN OTHERS THEN
14:33:54 860  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:54 861  	      RAISE CAN_NOT_CREATE_LINE_ITEMS;
14:33:54 862  	    END;
14:33:54 863  
14:33:54 864  	    BEGIN
14:33:54 865  	      PROCS_FIN_INSTRUMENTS_CRU_V22.CREATE_GIFT_CERTIFICATE(
14:33:54 866  		  out_gift_certificate_id	=> var_gift_cert_id,
14:33:54 867  		  in_purchaser_group_id 	=> in_group_id,
14:33:54 868  		  in_purchaser_invoice_id	=> var_new_invoice_id,
14:33:54 869  		  in_offer_chain_id		=> in_offer_chain_id,
14:33:54 870  		  in_expiration_date		=> in_expiration_date,
14:33:54 871  		  in_purchase_date		=> SYSDATE,
14:33:54 872  		  in_gift_certificate_status_id => GLOBAL_STATUSES_V22.GIFT_CERTIFICATE_ACTIVE,
14:33:54 873  		  in_code			=> in_gift_certificate_code,
14:33:54 874  		  in_created_by 		=> in_created_by,
14:33:54 875  		  in_recipient_name		=> in_recipient_name,
14:33:54 876  		  in_gift_message		=> in_gift_message,
14:33:54 877  		  in_recipient_email		=> in_recipient_email,
14:33:54 878  		  in_sender_email		=> in_sender_email,
14:33:54 879  		  in_sender_name		=> in_sender_name,
14:33:54 880  		  in_recipient_address_id	=> in_recipient_address_id,
14:33:54 881  		  in_recipient_notify_date	=> in_recipient_notify_date,
14:33:54 882  		  in_campaign			=> in_campaign,
14:33:54 883  		  in_reference_code		=> in_reference_code
14:33:54 884  	      );
14:33:54 885  	      EXCEPTION WHEN DUP_VAL_ON_INDEX THEN RAISE REF_CODE_ALREADY_EXISTS;
14:33:54 886  	    END;
14:33:54 887  
14:33:54 888  	    out_gift_certificate_id := var_gift_cert_id;
14:33:54 889  	    out_invoice_id := var_new_invoice_id;
14:33:54 890  
14:33:54 891  	    EXCEPTION
14:33:54 892  	    WHEN BAD_OFFER_CHAIN_STATUS THEN
14:33:54 893  	    PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:54 894  					     SPROC_NAME, 'Offer chain is not active');
14:33:54 895  	    WHEN GC_CODE_ALREADY_EXISTS THEN
14:33:54 896  	    PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.DUPLICATE_ERROR,
14:33:54 897  					     SPROC_NAME, 'Gift certificate with same code already exists');
14:33:54 898  	    WHEN OCH_IS_NOT_GIFT_CERTIFICATE THEN
14:33:54 899  	    PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:54 900  					     SPROC_NAME, 'This offer chain can not be used for gift certificate');
14:33:54 901  	    WHEN CAN_NOT_PURCHASE_GC_FOR_RDMPN THEN
14:33:54 902  	    PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:54 903  					     SPROC_NAME, 'This offer chain can not be purchased for gift certificate since it is for redemption');
14:33:54 904  	    WHEN CAN_NOT_CREATE_INVOICE THEN
14:33:54 905  	    PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 906  					     SPROC_NAME, 'Could not create new invoice', EXCEPTION_MESSAGE);
14:33:54 907  	    WHEN CAN_NOT_CREATE_LINE_ITEMS THEN
14:33:54 908  	    PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 909  					     SPROC_NAME, 'Could not create line items', EXCEPTION_MESSAGE);
14:33:54 910  	    WHEN BAD_GROUP_ID THEN
14:33:54 911  	    PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 912  					     SPROC_NAME, 'No such group id');
14:33:54 913  	    WHEN BAD_OFFER_CHAIN_ID THEN
14:33:54 914  	    PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 915  					     SPROC_NAME, 'No such offer chain');
14:33:54 916  	    WHEN OFFER_REC_NUM_LESS_THAN_ONE THEN
14:33:54 917  	    PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 918  					     SPROC_NAME, 'Some offer has recurrences number less than 1');
14:33:54 919  	    WHEN REF_CODE_ALREADY_EXISTS THEN
14:33:54 920  	    PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 921  					     SPROC_NAME, 'reference_code already used');
14:33:54 922  	    WHEN OTHERS THEN
14:33:54 923  	    PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 924  					     SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 925  	  END START_GC_PURCHASING;
14:33:54 926  /******************************************************************************/
14:33:54 927  
14:33:54 928  	PROCEDURE FINALIZE_GC_PURCHASING (
14:33:54 929  	  in_invoice_id 	IN NUMBER,
14:33:54 930  	  in_created_by 	IN VARCHAR2,
14:33:54 931  	  in_instrument_id	IN NUMBER,
14:33:54 932  	  in_instrument_type_id IN NUMBER,
14:33:54 933  	  in_order_id		IN VARCHAR2,
14:33:54 934  	  in_transaction_id	IN NUMBER,
14:33:54 935  	  out_charge_amount	OUT NUMBER
14:33:54 936  	) AS
14:33:54 937  	  SPROC_NAME CONSTANT VARCHAR2(22) := 'FINALIZE_GC_PURCHASING';
14:33:54 938  -- VARIABLES
14:33:54 939  	  temp_transaction_id_count NUMBER;
14:33:54 940  	  var_invoice_amount	    NUMBER(10,2);
14:33:54 941  	  var_transaction_id	    NUMBER;
14:33:54 942  	  var_new_charge_id	    NUMBER;
14:33:54 943  -- EXCEPTIONS
14:33:54 944  	    BAD_CREDIT_CARD_ID		EXCEPTION;
14:33:54 945  	    BAD_PAYPAL_ID		EXCEPTION;
14:33:54 946  	    BAD_INSTRUMENT_TYPE 	EXCEPTION;
14:33:54 947  	    TRANSACTION_EXISTS		EXCEPTION;
14:33:54 948  	    CAN_NOT_CALC_INVOICE_AMOUNT EXCEPTION;
14:33:54 949  	    CAN_NOT_USE_FCINSTR 	EXCEPTION;
14:33:54 950  	    CAN_NOT_CREATE_TRANSACTION	EXCEPTION;
14:33:54 951  	    CAN_NOT_CREATE_CHARGE	EXCEPTION;
14:33:54 952  	  EXCEPTION_MESSAGE   VARCHAR2(1024);
14:33:54 953  	  BEGIN
14:33:54 954  
14:33:54 955  -- Check that instrument exists
14:33:54 956  	    IF in_instrument_type_id = GLOBAL_ENUMS_V22.INSTRUMENT_CREDIT_CARD THEN
14:33:54 957  	      IF IS_CREDIT_CARD_EXISTS(in_instrument_id) = GLOBAL_CONSTANTS_V22.FALSE THEN
14:33:54 958  		RAISE BAD_CREDIT_CARD_ID;
14:33:54 959  	      END IF;
14:33:54 960  	    ELSIF in_instrument_type_id = GLOBAL_ENUMS_V22.INSTRUMENT_PAYPAL THEN
14:33:54 961  	      IF IS_PAYPAL_EXISTS(in_instrument_id) = GLOBAL_CONSTANTS_V22.FALSE THEN
14:33:54 962  		RAISE BAD_PAYPAL_ID;
14:33:54 963  	      END IF;
14:33:54 964  	    ELSIF in_instrument_type_id = GLOBAL_ENUMS_V22.INSTRUMENT_ZCI_INSTRUMENT THEN
14:33:54 965  	      NULL;
14:33:54 966  	    ELSE
14:33:54 967  	      RAISE BAD_INSTRUMENT_TYPE;
14:33:54 968  	    END IF;
14:33:54 969  
14:33:54 970  -- Check that transaction with given id do not exists
14:33:54 971  	    SELECT
14:33:54 972  	      COUNT(*) into temp_transaction_id_count
14:33:54 973  	    FROM
14:33:54 974  	      TRANSACTION
14:33:54 975  	    WHERE
14:33:54 976  	      TRANSACTION.ID = in_transaction_id;
14:33:54 977  
14:33:54 978  	    IF temp_transaction_id_count > 0 THEN
14:33:54 979  	      RAISE TRANSACTION_EXISTS;
14:33:54 980  	    END IF;
14:33:54 981  
14:33:54 982  -- Calculate new invoice amount
14:33:54 983  	    BEGIN
14:33:54 984  	      PROCS_INVOICE_V22.CALCULATE_INVOICE_AMOUNT(in_invoice_id, var_invoice_amount);
14:33:54 985  	      EXCEPTION
14:33:54 986  	      WHEN OTHERS THEN
14:33:54 987  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:54 988  	      RAISE CAN_NOT_CALC_INVOICE_AMOUNT;
14:33:54 989  	    END;
14:33:54 990  
14:33:54 991  	    IF var_invoice_amount > 0
14:33:54 992  	       AND in_instrument_type_id = GLOBAL_ENUMS_V22.INSTRUMENT_ZCI_INSTRUMENT THEN
14:33:54 993  	      RAISE CAN_NOT_USE_FCINSTR;
14:33:54 994  	    END IF;
14:33:54 995  
14:33:54 996  -- If invoice amount iz 0 then we need to set status for this invoice to PROCCESSED
14:33:54 997  	    IF var_invoice_amount = 0 THEN
14:33:54 998  	      PROCS_INVOICE_CRU_V22.UPDATE_INVOICE(
14:33:54 999  		  in_invoice_id 		 => in_invoice_id,
14:33:54 1000  		   in_updated_by		  => in_created_by,
14:33:54 1001  		   in_invoice_status_id 	  => GLOBAL_STATUSES_V22.INVOICE_CLOSED
14:33:54 1002  	       );
14:33:54 1003  	     END IF;
14:33:54 1004  
14:33:54 1005  	     IF var_invoice_amount > 0 THEN
14:33:54 1006  -- Create transaction
14:33:54 1007  	       BEGIN
14:33:54 1008  		 PROCS_TRANSACTION_V22.CREATE_TRANSACTION(
14:33:54 1009  		     in_transaction_id	      => in_transaction_id,
14:33:54 1010  		     in_status_id	      => GLOBAL_STATUSES_V22.TRANSACTION_PENDING,
14:33:54 1011  		     in_amount		      => var_invoice_amount,
14:33:54 1012  		     in_created_by	      => in_created_by,
14:33:54 1013  		     in_order_id	      => in_order_id,
14:33:54 1014  		     in_transaction_type_code => 'GIFT_CERTIFICATE_PURCHASE',
14:33:54 1015  		     out_transaction_id       => var_transaction_id
14:33:54 1016  		 );
14:33:54 1017  		 EXCEPTION
14:33:54 1018  		 WHEN OTHERS THEN
14:33:54 1019  		 EXCEPTION_MESSAGE := SQLERRM;
14:33:54 1020  		 RAISE CAN_NOT_CREATE_TRANSACTION;
14:33:54 1021  	       END;
14:33:54 1022  
14:33:54 1023  -- Create charge
14:33:54 1024  	       BEGIN
14:33:54 1025  		 PROCS_CHARGE_V22.CREATE_CHARGE(
14:33:54 1026  		     in_invoice_id	   => in_invoice_id,
14:33:54 1027  		     in_transaction_id	   => var_transaction_id,
14:33:54 1028  		     in_instrument_type_id => in_instrument_type_id,
14:33:54 1029  		     in_instrument_id	   => in_instrument_id,
14:33:54 1030  		     in_charge_amount	   => var_invoice_amount,
14:33:54 1031  		     in_created_by	   => in_created_by,
14:33:54 1032  		     in_charge_status_id   => GLOBAL_STATUSES_V22.CHARGE_OPENED,
14:33:54 1033  		     out_charge_id	   => var_new_charge_id
14:33:54 1034  		 );
14:33:54 1035  		 out_charge_amount := var_invoice_amount;
14:33:54 1036  		 EXCEPTION
14:33:54 1037  		 WHEN OTHERS THEN
14:33:54 1038  		 EXCEPTION_MESSAGE := SQLERRM;
14:33:54 1039  		 RAISE CAN_NOT_CREATE_CHARGE;
14:33:54 1040  	       END;
14:33:54 1041  	     ELSE
14:33:54 1042  	       out_charge_amount := 0;
14:33:54 1043  	     END IF;
14:33:54 1044  
14:33:54 1045  	     EXCEPTION
14:33:54 1046  	     WHEN CAN_NOT_USE_FCINSTR THEN
14:33:54 1047  	     PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:54 1048  					      SPROC_NAME, 'Could not use "free charge instrument" for non-zero invoice');
14:33:54 1049  	     WHEN BAD_CREDIT_CARD_ID THEN
14:33:54 1050  	     PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1051  					      SPROC_NAME, 'Bad credit card id');
14:33:54 1052  	     WHEN BAD_PAYPAL_ID THEN
14:33:54 1053  	     PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1054  					      SPROC_NAME, 'Bad paypal id');
14:33:54 1055  	     WHEN BAD_INSTRUMENT_TYPE THEN
14:33:54 1056  	     PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:54 1057  					      SPROC_NAME, 'Bad instrument type');
14:33:54 1058  	     WHEN TRANSACTION_EXISTS THEN
14:33:54 1059  	     PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.DUPLICATE_ERROR,
14:33:54 1060  					      SPROC_NAME, 'Transaction with given id already exists');
14:33:54 1061  	     WHEN CAN_NOT_CREATE_TRANSACTION THEN
14:33:54 1062  	     PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 1063  					      SPROC_NAME, 'Could not create transaction', EXCEPTION_MESSAGE);
14:33:54 1064  	     WHEN CAN_NOT_CREATE_CHARGE THEN
14:33:54 1065  	     PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 1066  					      SPROC_NAME, 'Could not create charge', EXCEPTION_MESSAGE);
14:33:54 1067  	     WHEN CAN_NOT_CALC_INVOICE_AMOUNT THEN
14:33:54 1068  	     PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 1069  					      SPROC_NAME, 'Could not calculate amount for new invoice', EXCEPTION_MESSAGE);
14:33:54 1070  	     WHEN OTHERS THEN
14:33:54 1071  	     PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1072  					      SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1073  	   END FINALIZE_GC_PURCHASING;
14:33:54 1074  
14:33:54 1075  /******************************************************************************/
14:33:54 1076  
14:33:54 1077  PROCEDURE PURCHASE_GIFT_CERTIFICATE (
14:33:54 1078  	 in_group_id		   IN NUMBER,
14:33:54 1079  	 in_offer_chain_id	   IN VARCHAR2,
14:33:54 1080  	 in_gift_certificate_code  IN VARCHAR2,
14:33:54 1081  	 in_created_by		   IN VARCHAR2,
14:33:54 1082  	 in_recipient_name	   IN VARCHAR2,
14:33:54 1083  	 in_recipient_email	   IN VARCHAR2,
14:33:54 1084  	 in_sender_name 	   IN VARCHAR2,
14:33:54 1085  	 in_sender_email	   IN VARCHAR2,
14:33:54 1086  	 in_gift_message	   IN VARCHAR2,
14:33:54 1087  	 in_instrument_id	   IN NUMBER,
14:33:54 1088  	 in_instrument_type_id	   IN NUMBER,
14:33:54 1089  	 in_expiration_date	   IN DATE,
14:33:54 1090  	 in_order_id		   IN VARCHAR2,
14:33:54 1091  	 in_transaction_id	   IN NUMBER
14:33:54 1092  ) AS
14:33:54 1093  SPROC_NAME	  CONSTANT VARCHAR2(25) := 'PURCHASE_GIFT_CERTIFICATE';
14:33:54 1094  -- VARIABLES
14:33:54 1095  var_gift_cert_id   NUMBER;
14:33:54 1096  var_account_id	  NUMBER;
14:33:54 1097  var_invoice_amount NUMBER (10,2);
14:33:54 1098  var_new_invoice_id NUMBER;
14:33:54 1099  var_new_charge_id  NUMBER;
14:33:54 1100  var_och_is_gc	  NUMBER;
14:33:54 1101  var_offer_chain_status_id NUMBER;
14:33:54 1102  var_is_for_redemption	 NUMBER;
14:33:54 1103  var_account_tax_exempt_id VARCHAR2(255);
14:33:54 1104  
14:33:54 1105  temp_transaction_id_count NUMBER;
14:33:54 1106  var_transaction_id	 NUMBER;
14:33:54 1107  temp_gc_code VARCHAR2(255);
14:33:54 1108  
14:33:54 1109  var_invoice_status_id NUMBER;
14:33:54 1110  -- EXCEPTIONS
14:33:54 1111  CAN_NOT_CREATE_INVOICE		   EXCEPTION;
14:33:54 1112  CAN_NOT_CREATE_TRANSACTION	   EXCEPTION;
14:33:54 1113  CAN_NOT_CREATE_CHARGE		   EXCEPTION;
14:33:54 1114  CAN_NOT_CREATE_LINE_ITEMS	   EXCEPTION;
14:33:54 1115  BAD_GROUP_ID			   EXCEPTION;
14:33:54 1116  BAD_OFFER_CHAIN_ID		   EXCEPTION;
14:33:54 1117  OCH_IS_NOT_GIFT_CERTIFICATE	   EXCEPTION;
14:33:54 1118  TRANSACTION_EXISTS		   EXCEPTION;
14:33:54 1119  GC_CODE_ALREADY_EXISTS		   EXCEPTION;
14:33:54 1120  BAD_INSTRUMENT_TYPE		   EXCEPTION;
14:33:54 1121  BAD_CREDIT_CARD_ID		   EXCEPTION;
14:33:54 1122  BAD_PAYPAL_ID			   EXCEPTION;
14:33:54 1123  CAN_NOT_CALCULATE_OCH_AMOUNT	   EXCEPTION;
14:33:54 1124  BAD_OFFER_CHAIN_STATUS		   EXCEPTION;
14:33:54 1125  OFFER_REC_NUM_LESS_THAN_ONE	   EXCEPTION;
14:33:54 1126  CAN_NOT_CALC_INVOICE_AMOUNT	   EXCEPTION;
14:33:54 1127  CAN_NOT_USE_FCINSTR		   EXCEPTION;
14:33:54 1128  CAN_NOT_PURCHASE_GC_FOR_RDMPN	   EXCEPTION;
14:33:54 1129  EXCEPTION_MESSAGE		   VARCHAR2(1024);
14:33:54 1130  BEGIN
14:33:54 1131  
14:33:54 1132  	 -- Get account id
14:33:54 1133  	 BEGIN
14:33:54 1134  	   SELECT
14:33:54 1135  	     ACCOUNT.ID,
14:33:54 1136  	     ACCOUNT.TAX_EXEMPT_ID
14:33:54 1137  	     into
14:33:54 1138  	     var_account_id,
14:33:54 1139  	     var_account_tax_exempt_id
14:33:54 1140  	   FROM
14:33:54 1141  	     ACCOUNT
14:33:54 1142  	   WHERE
14:33:54 1143  	     ACCOUNT.GROUP_ID = in_group_id;
14:33:54 1144  	   EXCEPTION
14:33:54 1145  	   WHEN NO_DATA_FOUND THEN
14:33:54 1146  	     RAISE BAD_GROUP_ID;
14:33:54 1147  	 END;
14:33:54 1148  
14:33:54 1149  	 -- Check that instrument exists
14:33:54 1150  	 IF in_instrument_type_id = GLOBAL_ENUMS_V22.INSTRUMENT_CREDIT_CARD THEN
14:33:54 1151  	   IF IS_CREDIT_CARD_EXISTS(in_instrument_id) = GLOBAL_CONSTANTS_V22.FALSE THEN
14:33:54 1152  	     RAISE BAD_CREDIT_CARD_ID;
14:33:54 1153  	   END IF;
14:33:54 1154  	 ELSIF in_instrument_type_id = GLOBAL_ENUMS_V22.INSTRUMENT_PAYPAL THEN
14:33:54 1155  	   IF IS_PAYPAL_EXISTS(in_instrument_id) = GLOBAL_CONSTANTS_V22.FALSE THEN
14:33:54 1156  	     RAISE BAD_PAYPAL_ID;
14:33:54 1157  	   END IF;
14:33:54 1158  	 ELSIF in_instrument_type_id = GLOBAL_ENUMS_V22.INSTRUMENT_ZCI_INSTRUMENT THEN
14:33:54 1159  	   NULL;
14:33:54 1160  	 ELSE
14:33:54 1161  	   RAISE BAD_INSTRUMENT_TYPE;
14:33:54 1162  	 END IF;
14:33:54 1163  
14:33:54 1164  	 -- Check for the same code
14:33:54 1165  	 BEGIN
14:33:54 1166  	   SELECT
14:33:54 1167  	     GIFT_CERTIFICATE.CODE into temp_gc_code
14:33:54 1168  	   FROM
14:33:54 1169  	     GIFT_CERTIFICATE
14:33:54 1170  	   WHERE
14:33:54 1171  	     GIFT_CERTIFICATE.CODE = in_gift_certificate_code;
14:33:54 1172  
14:33:54 1173  	   RAISE GC_CODE_ALREADY_EXISTS;
14:33:54 1174  
14:33:54 1175  	   EXCEPTION
14:33:54 1176  	     WHEN NO_DATA_FOUND THEN
14:33:54 1177  	       NULL;
14:33:54 1178  	 END;
14:33:54 1179  
14:33:54 1180  	 -- Get offer chain flag "is_gift_certificate"
14:33:54 1181  	 BEGIN
14:33:54 1182  	   SELECT
14:33:54 1183  	     OFFER_CHAIN.IS_GIFT_CERTIFICATE,
14:33:54 1184  	     OFFER_CHAIN.OFFER_CHAIN_STATUS_ID
14:33:54 1185  	     into
14:33:54 1186  	     var_och_is_gc,
14:33:54 1187  	     var_offer_chain_status_id
14:33:54 1188  	   FROM
14:33:54 1189  	     OFFER_CHAIN
14:33:54 1190  	   WHERE
14:33:54 1191  	     OFFER_CHAIN.ID = in_offer_chain_id;
14:33:54 1192  	   EXCEPTION
14:33:54 1193  	   WHEN NO_DATA_FOUND THEN
14:33:54 1194  	     RAISE BAD_OFFER_CHAIN_ID;
14:33:54 1195  	 END;
14:33:54 1196  
14:33:54 1197  	 IF var_och_is_gc != GLOBAL_CONSTANTS_V22.TRUE
14:33:54 1198  	   OR var_och_is_gc IS NULL THEN
14:33:54 1199  	   RAISE OCH_IS_NOT_GIFT_CERTIFICATE;
14:33:54 1200  	 END IF;
14:33:54 1201  
14:33:54 1202  	 IF var_offer_chain_status_id != GLOBAL_STATUSES_V22.OFFER_CHAIN_ACTIVE THEN
14:33:54 1203  	   RAISE BAD_OFFER_CHAIN_STATUS;
14:33:54 1204  	 END IF;
14:33:54 1205  
14:33:54 1206  	 -- norlov: #38151 check if the OC is for Redemption:
14:33:54 1207  	 SELECT
14:33:54 1208  	   COUNT(*) into var_is_for_redemption
14:33:54 1209  	 FROM
14:33:54 1210  	   OFFER_CHAIN_ELIGIBILITY
14:33:54 1211  	 WHERE
14:33:54 1212  	   OFFER_CHAIN_ELIGIBILITY.OFFER_CHAIN_ID = in_offer_chain_id
14:33:54 1213  	   AND OFFER_CHAIN_ELIGIBILITY.NAME = GLOBAL_CONSTANTS_V22.GIFT_CERTIFICATE_REQUIRED
14:33:54 1214  	   AND OFFER_CHAIN_ELIGIBILITY.VALUE = GLOBAL_CONSTANTS_V22.ELIGIBILITY_FLAG_SET;
14:33:54 1215  
14:33:54 1216  	 IF var_is_for_redemption > 0 THEN
14:33:54 1217  	   RAISE CAN_NOT_PURCHASE_GC_FOR_RDMPN;
14:33:54 1218  	 END IF;
14:33:54 1219  
14:33:54 1220  	 -- Check that transaction with given id do not exists
14:33:54 1221  	 SELECT
14:33:54 1222  	   COUNT(*) into temp_transaction_id_count
14:33:54 1223  	 FROM
14:33:54 1224  	   TRANSACTION
14:33:54 1225  	 WHERE
14:33:54 1226  	   TRANSACTION.ID = in_transaction_id;
14:33:54 1227  
14:33:54 1228  	 IF temp_transaction_id_count > 0 THEN
14:33:54 1229  	   RAISE TRANSACTION_EXISTS;
14:33:54 1230  	 END IF;
14:33:54 1231  
14:33:54 1232  	 -- Create new invoice
14:33:54 1233  	 BEGIN
14:33:54 1234  	   PROCS_INVOICE_V22.CREATE_INVOICE(
14:33:54 1235  	     in_invoice_status => GLOBAL_STATUSES_V22.INVOICE_OPEN,
14:33:54 1236  	     in_created_by     => in_created_by,
14:33:54 1237  	     in_tax_exempt_id  => var_account_tax_exempt_id,
14:33:54 1238  	     out_invoice_id    => var_new_invoice_id
14:33:54 1239  	   );
14:33:54 1240  	   EXCEPTION
14:33:54 1241  	     WHEN OTHERS THEN
14:33:54 1242  	       EXCEPTION_MESSAGE := SQLERRM;
14:33:54 1243  	       RAISE CAN_NOT_CREATE_INVOICE;
14:33:54 1244  	 END;
14:33:54 1245  
14:33:54 1246  	 -- Add line items for new invoice
14:33:54 1247  	 BEGIN
14:33:54 1248  	   FOR f_offer_data IN (
14:33:54 1249  	     SELECT
14:33:54 1250  	       OFFER_ID,
14:33:54 1251  	       NUM_RECURRENCES
14:33:54 1252  	     FROM
14:33:54 1253  	       OFFER_OFFER_CHAIN
14:33:54 1254  	     WHERE
14:33:54 1255  	       OFFER_OFFER_CHAIN.OFFER_CHAIN_ID = in_offer_chain_id
14:33:54 1256  	   )
14:33:54 1257  	   LOOP
14:33:54 1258  	     IF f_offer_data.NUM_RECURRENCES < 1 THEN
14:33:54 1259  	       RAISE OFFER_REC_NUM_LESS_THAN_ONE;
14:33:54 1260  	     END IF;
14:33:54 1261  	     FOR i_offer_recurrences_iterator IN 1..f_offer_data.NUM_RECURRENCES
14:33:54 1262  	     LOOP
14:33:54 1263  	       PROCS_LINE_ITEMS_V22.ADD_LINE_ITEMS(
14:33:54 1264  		 in_invoice_id => var_new_invoice_id,
14:33:54 1265  		 in_offer_id   => f_offer_data.OFFER_ID,
14:33:54 1266  		 in_created_by => in_created_by
14:33:54 1267  	       );
14:33:54 1268  	     END LOOP;
14:33:54 1269  	   END LOOP;
14:33:54 1270  
14:33:54 1271  	   EXCEPTION
14:33:54 1272  	     WHEN OTHERS THEN
14:33:54 1273  	       EXCEPTION_MESSAGE := SQLERRM;
14:33:54 1274  	       RAISE CAN_NOT_CREATE_LINE_ITEMS;
14:33:54 1275  	 END;
14:33:54 1276  
14:33:54 1277  	 -- Calculate new invoice amount
14:33:54 1278  	 BEGIN
14:33:54 1279  	   PROCS_INVOICE_V22.CALCULATE_INVOICE_AMOUNT(var_new_invoice_id, var_invoice_amount);
14:33:54 1280  	   EXCEPTION
14:33:54 1281  	     WHEN OTHERS THEN
14:33:54 1282  	       EXCEPTION_MESSAGE := SQLERRM;
14:33:54 1283  	       RAISE CAN_NOT_CALC_INVOICE_AMOUNT;
14:33:54 1284  	 END;
14:33:54 1285  
14:33:54 1286  	 IF var_invoice_amount > 0
14:33:54 1287  	   AND in_instrument_type_id = GLOBAL_ENUMS_V22.INSTRUMENT_ZCI_INSTRUMENT THEN
14:33:54 1288  	   RAISE CAN_NOT_USE_FCINSTR;
14:33:54 1289  	 END IF;
14:33:54 1290  
14:33:54 1291  	 -- If invoice amount iz 0 then we need to set status for this invoice to PROCCESSED
14:33:54 1292  	 IF var_invoice_amount = 0 THEN
14:33:54 1293  	   PROCS_INVOICE_CRU_V22.UPDATE_INVOICE(
14:33:54 1294  	     in_invoice_id		    => var_new_invoice_id,
14:33:54 1295  	     in_updated_by		    => in_created_by,
14:33:54 1296  	     in_invoice_status_id	    => GLOBAL_STATUSES_V22.INVOICE_CLOSED
14:33:54 1297  	   );
14:33:54 1298  	 END IF;
14:33:54 1299  
14:33:54 1300  	 IF var_invoice_amount > 0 THEN
14:33:54 1301  	   -- Create transaction
14:33:54 1302  	   BEGIN
14:33:54 1303  	     PROCS_TRANSACTION_V22.CREATE_TRANSACTION(
14:33:54 1304  	       in_transaction_id  => in_transaction_id,
14:33:54 1305  	       in_status_id	  => GLOBAL_STATUSES_V22.TRANSACTION_PENDING,
14:33:54 1306  	       in_amount	  => var_invoice_amount,
14:33:54 1307  	       in_created_by	  => in_created_by,
14:33:54 1308  	       in_order_id	  => in_order_id,
14:33:54 1309  	       out_transaction_id => var_transaction_id
14:33:54 1310  	     );
14:33:54 1311  	     EXCEPTION
14:33:54 1312  	       WHEN OTHERS THEN
14:33:54 1313  		 EXCEPTION_MESSAGE := SQLERRM;
14:33:54 1314  		 RAISE CAN_NOT_CREATE_TRANSACTION;
14:33:54 1315  	   END;
14:33:54 1316  
14:33:54 1317  	   -- Create charge
14:33:54 1318  	   BEGIN
14:33:54 1319  	     PROCS_CHARGE_V22.CREATE_CHARGE(
14:33:54 1320  	       in_invoice_id	     => var_new_invoice_id,
14:33:54 1321  	       in_transaction_id     => var_transaction_id,
14:33:54 1322  	       in_instrument_type_id => in_instrument_type_id,
14:33:54 1323  	       in_instrument_id      => in_instrument_id,
14:33:54 1324  	       in_charge_amount      => var_invoice_amount,
14:33:54 1325  	       in_created_by	     => in_created_by,
14:33:54 1326  	       in_charge_status_id   => GLOBAL_STATUSES_V22.CHARGE_OPENED,
14:33:54 1327  	       out_charge_id	     => var_new_charge_id
14:33:54 1328  	     );
14:33:54 1329  	     EXCEPTION
14:33:54 1330  	       WHEN OTHERS THEN
14:33:54 1331  		 EXCEPTION_MESSAGE := SQLERRM;
14:33:54 1332  		 RAISE CAN_NOT_CREATE_CHARGE;
14:33:54 1333  	   END;
14:33:54 1334  	 END IF;
14:33:54 1335  
14:33:54 1336  	 -- Create new row in GIFT_CERTIFICATE table
14:33:54 1337  	 PROCS_FIN_INSTRUMENTS_CRU_V22.CREATE_GIFT_CERTIFICATE(
14:33:54 1338  	   out_gift_certificate_id	 => var_gift_cert_id,
14:33:54 1339  	   in_purchaser_group_id	 => in_group_id,
14:33:54 1340  	   in_purchaser_invoice_id	 => var_new_invoice_id,
14:33:54 1341  	   in_offer_chain_id		 => in_offer_chain_id,
14:33:54 1342  	   in_expiration_date		 => in_expiration_date,
14:33:54 1343  	   in_purchase_date		 => SYSDATE,
14:33:54 1344  	   in_gift_certificate_status_id => GLOBAL_STATUSES_V22.GIFT_CERTIFICATE_ACTIVE,
14:33:54 1345  	   in_code			 => in_gift_certificate_code,
14:33:54 1346  	   in_created_by		 => in_created_by,
14:33:54 1347  	   in_recipient_name		 => in_recipient_name,
14:33:54 1348  	   in_gift_message		 => in_gift_message,
14:33:54 1349  	   in_recipient_email		 => in_recipient_email,
14:33:54 1350  	   in_sender_email		 => in_sender_email,
14:33:54 1351  	   in_sender_name		 => in_sender_name
14:33:54 1352  	 );
14:33:54 1353  
14:33:54 1354  EXCEPTION
14:33:54 1355  WHEN CAN_NOT_USE_FCINSTR THEN
14:33:54 1356  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:54 1357  	   SPROC_NAME, 'Could not use "free charge instrument" for non-zero invoice');
14:33:54 1358  WHEN BAD_OFFER_CHAIN_STATUS THEN
14:33:54 1359  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:54 1360  	   SPROC_NAME, 'Offer chain is not active');
14:33:54 1361  WHEN CAN_NOT_CALCULATE_OCH_AMOUNT THEN
14:33:54 1362  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 1363  	   SPROC_NAME, 'Could not calculate offer chain amount', EXCEPTION_MESSAGE);
14:33:54 1364  WHEN BAD_CREDIT_CARD_ID THEN
14:33:54 1365  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1366  	   SPROC_NAME, 'Bad credit card id');
14:33:54 1367  WHEN BAD_PAYPAL_ID THEN
14:33:54 1368  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1369  	   SPROC_NAME, 'Bad paypal id');
14:33:54 1370  WHEN BAD_INSTRUMENT_TYPE THEN
14:33:54 1371  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:54 1372  	   SPROC_NAME, 'Bad instrument type');
14:33:54 1373  WHEN GC_CODE_ALREADY_EXISTS THEN
14:33:54 1374  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.DUPLICATE_ERROR,
14:33:54 1375  	   SPROC_NAME, 'Gift certificate with same code already exists');
14:33:54 1376  WHEN OCH_IS_NOT_GIFT_CERTIFICATE THEN
14:33:54 1377  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:54 1378  	   SPROC_NAME, 'This offer chain can not be used for gift certificate');
14:33:54 1379  WHEN CAN_NOT_PURCHASE_GC_FOR_RDMPN THEN
14:33:54 1380  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:54 1381  	   SPROC_NAME, 'This offer chain can not be purchased for gift certificate since it is for redemption');
14:33:54 1382  WHEN TRANSACTION_EXISTS THEN
14:33:54 1383  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.DUPLICATE_ERROR,
14:33:54 1384  	   SPROC_NAME, 'Transaction with given id already exists');
14:33:54 1385  WHEN CAN_NOT_CREATE_INVOICE THEN
14:33:54 1386  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 1387  	   SPROC_NAME, 'Could not create new invoice', EXCEPTION_MESSAGE);
14:33:54 1388  WHEN CAN_NOT_CREATE_TRANSACTION THEN
14:33:54 1389  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 1390  	   SPROC_NAME, 'Could not create transaction', EXCEPTION_MESSAGE);
14:33:54 1391  WHEN CAN_NOT_CREATE_CHARGE THEN
14:33:54 1392  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 1393  	   SPROC_NAME, 'Could not create charge', EXCEPTION_MESSAGE);
14:33:54 1394  WHEN CAN_NOT_CREATE_LINE_ITEMS THEN
14:33:54 1395  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 1396  	   SPROC_NAME, 'Could not create line items', EXCEPTION_MESSAGE);
14:33:54 1397  WHEN BAD_GROUP_ID THEN
14:33:54 1398  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1399  	   SPROC_NAME, 'No such group id');
14:33:54 1400  WHEN BAD_OFFER_CHAIN_ID THEN
14:33:54 1401  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1402  	   SPROC_NAME, 'No such offer chain');
14:33:54 1403  WHEN OFFER_REC_NUM_LESS_THAN_ONE THEN
14:33:54 1404  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 1405  	   SPROC_NAME, 'Some offer has recurrences number less than 1');
14:33:54 1406  WHEN CAN_NOT_CALC_INVOICE_AMOUNT THEN
14:33:54 1407  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 1408  	   SPROC_NAME, 'COuold not calculate amount for new invoice', EXCEPTION_MESSAGE);
14:33:54 1409  WHEN OTHERS THEN
14:33:54 1410  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1411  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1412  END PURCHASE_GIFT_CERTIFICATE;
14:33:54 1413  
14:33:54 1414  /******************************************************************************/
14:33:54 1415  
14:33:54 1416  PROCEDURE REDEEM_GIFT_CERTIFICATE (
14:33:54 1417  	 in_group_id			 IN NUMBER,
14:33:54 1418  	 in_gift_certificate_code	 IN VARCHAR2,
14:33:54 1419  	 in_created_by			 IN VARCHAR2,
14:33:54 1420  	 in_redeemer_address_id 	 IN NUMBER,
14:33:54 1421  	 in_fin_instrument_id		 IN NUMBER,
14:33:54 1422  	 in_fin_instrument_type_id	 IN NUMBER,
14:33:54 1423  	 in_redemption_offer_chain_id	 IN NUMBER,
14:33:54 1424  	 out_subscription_id		 OUT NUMBER,
14:33:54 1425  	 out_license_id 		 OUT NUMBER
14:33:54 1426  ) AS
14:33:54 1427  SPROC_NAME	       CONSTANT VARCHAR2(23) := 'REDEEM_GIFT_CERTIFICATE';
14:33:54 1428  -- VARIABLES
14:33:54 1429  var_gift_certificate_id NUMBER;
14:33:54 1430  -- norlov: #38151 var_offer_chain_id replaced by var_purchased_oc_id and var_oc_id_to_redeem
14:33:54 1431  var_purchased_oc_id     NUMBER;
14:33:54 1432  var_oc_id_to_redeem     NUMBER := in_redemption_offer_chain_id;
14:33:54 1433  var_offer_duration      VARCHAR2(30);
14:33:54 1434  var_invoice_id	       NUMBER;
14:33:54 1435  var_succ_purch_attempts_num NUMBER;
14:33:54 1436  var_subscription_id     NUMBER;
14:33:54 1437  var_license_id	       NUMBER;
14:33:54 1438  var_account_id	       NUMBER;
14:33:54 1439  var_gc_status_id        NUMBER;
14:33:54 1440  var_gc_charges_amount   NUMBER;
14:33:54 1441  var_gc_expiration_date  DATE;
14:33:54 1442  var_gc_redeemer_group_id NUMBER;
14:33:54 1443  var_gc_purchase_invoice_id NUMBER;
14:33:54 1444  var_gc_purchase_inv_status_id NUMBER;
14:33:54 1445  var_offer_index		     NUMBER;
14:33:54 1446  var_purchaser_group_id	     NUMBER;
14:33:54 1447  temp_license_id		     NUMBER;
14:33:54 1448  var_same_offer_chains_num     NUMBER;
14:33:54 1449  var_max_concurrent_subscrs    NUMBER;
14:33:54 1450  var_account_tax_exempt_id     VARCHAR2(255);
14:33:54 1451  var_fin_instrument_type_id    NUMBER := in_fin_instrument_type_id;
14:33:54 1452  var_fin_instrument_id	     NUMBER := in_fin_instrument_id;
14:33:54 1453  var_first_offer_id	  NUMBER;
14:33:54 1454  var_date 	     DATE := SYSDATE;
14:33:54 1455  
14:33:54 1456  var_offers SYS_REFCURSOR;
14:33:54 1457  
14:33:54 1458  -- EXCEPTIONS
14:33:54 1459  BAD_GIFT_CERTIFICATE_CODE      EXCEPTION;
14:33:54 1460  BAD_GROUP_ID		      EXCEPTION;
14:33:54 1461  CAN_NOT_CREATE_LICENSE	      EXCEPTION;
14:33:54 1462  GIFT_CERT_IS_FINALIZED	      EXCEPTION;
14:33:54 1463  GIFT_CERT_IS_REFUNDED	      EXCEPTION;
14:33:54 1464  CAN_NOT_UPDATE_CERTIFICATE     EXCEPTION;
14:33:54 1465  GIFT_CERTIFICATE_EXPIRED       EXCEPTION;
14:33:54 1466  GIFT_CERTIFICATE_REDEEMED      EXCEPTION;
14:33:54 1467  USER_ALREADY_SUBSCRIBED_TO_PRD EXCEPTION;
14:33:54 1468  LIMIT_REACHED		      EXCEPTION;
14:33:54 1469  GC_PURCHASE_INVOICE_NOT_CLOSED EXCEPTION;
14:33:54 1470  PURCHASE_INVOICES_NOT_PAID     EXCEPTION;
14:33:54 1471  OC_TO_REDEEM_NOT_FOUND	      EXCEPTION;
14:33:54 1472  CAN_NOT_GET_FIRST_OFFER_CHAIN  EXCEPTION;
14:33:54 1473  EXCEPTION_MESSAGE	      VARCHAR2(1024);
14:33:54 1474  BEGIN
14:33:54 1475  
14:33:54 1476  	 -- Get account id
14:33:54 1477  	 BEGIN
14:33:54 1478  	   SELECT
14:33:54 1479  	     ACCOUNT.ID,
14:33:54 1480  	     ACCOUNT.TAX_EXEMPT_ID
14:33:54 1481  	     into
14:33:54 1482  	     var_account_id,
14:33:54 1483  	     var_account_tax_exempt_id
14:33:54 1484  	   FROM
14:33:54 1485  	     ACCOUNT
14:33:54 1486  	   WHERE
14:33:54 1487  	     ACCOUNT.GROUP_ID = in_group_id
14:33:54 1488  	     AND ROWNUM <= 1;
14:33:54 1489  
14:33:54 1490  	   EXCEPTION
14:33:54 1491  	   WHEN NO_DATA_FOUND THEN
14:33:54 1492  	     RAISE BAD_GROUP_ID;
14:33:54 1493  	 END;
14:33:54 1494  
14:33:54 1495  	 -- Get gift certificate data
14:33:54 1496  	 BEGIN
14:33:54 1497  	   SELECT
14:33:54 1498  	     GIFT_CERTIFICATE.ID,
14:33:54 1499  	     GIFT_CERTIFICATE.OFFER_CHAIN_ID,
14:33:54 1500  	     GIFT_CERTIFICATE.GIFT_CERTIFICATE_STATUS_ID,
14:33:54 1501  	     GIFT_CERTIFICATE.PURCHASER_GROUP_ID,
14:33:54 1502  	     GIFT_CERTIFICATE.EXPIRATION_DATE,
14:33:54 1503  	     GIFT_CERTIFICATE.REDEEMER_GROUP_ID,
14:33:54 1504  	     GIFT_CERTIFICATE.PURCHASE_INVOICE_ID
14:33:54 1505  	     into
14:33:54 1506  	     var_gift_certificate_id,
14:33:54 1507  	     var_purchased_oc_id,
14:33:54 1508  	     var_gc_status_id,
14:33:54 1509  	     var_purchaser_group_id,
14:33:54 1510  	     var_gc_expiration_date,
14:33:54 1511  	     var_gc_redeemer_group_id,
14:33:54 1512  	     var_gc_purchase_invoice_id
14:33:54 1513  	   FROM
14:33:54 1514  	     GIFT_CERTIFICATE
14:33:54 1515  	   WHERE
14:33:54 1516  	     GIFT_CERTIFICATE.CODE = in_gift_certificate_code
14:33:54 1517  	     AND ROWNUM <= 1;
14:33:54 1518  
14:33:54 1519  	   EXCEPTION
14:33:54 1520  	   WHEN NO_DATA_FOUND THEN
14:33:54 1521  	     RAISE BAD_GIFT_CERTIFICATE_CODE;
14:33:54 1522  	 END;
14:33:54 1523  
14:33:54 1524  	 -- get redemption oc id from meta data if it wasn't passed in, parsing will fail for gcs with multiple redemption offer chains,
14:33:54 1525  	 -- but in that case a redemption offer chain id should always be passed in
14:33:54 1526  	 IF var_oc_id_to_redeem IS NULL THEN
14:33:54 1527  	   BEGIN
14:33:54 1528  	     SELECT
14:33:54 1529  	       to_number(OFFER_CHAIN_META_DATA.VALUE)
14:33:54 1530  	       into
14:33:54 1531  	       var_oc_id_to_redeem
14:33:54 1532  	     FROM
14:33:54 1533  	       OFFER_CHAIN_META_DATA
14:33:54 1534  	     WHERE
14:33:54 1535  	       OFFER_CHAIN_META_DATA.OFFER_CHAIN_ID = var_purchased_oc_id
14:33:54 1536  	       AND OFFER_CHAIN_META_DATA.NAME = GLOBAL_CONSTANTS_V22.REDEMPTION_OC_ID
14:33:54 1537  	       AND ROWNUM = 1;
14:33:54 1538  -- requested by ticket so (but above is correct for the actual migrated data):
14:33:54 1539  --  SELECT
14:33:54 1540  --      OFFER_CHAIN.ID
14:33:54 1541  --      into
14:33:54 1542  --      var_oc_id_to_redeem
14:33:54 1543  --    FROM
14:33:54 1544  --      OFFER_CHAIN
14:33:54 1545  --	 INNER JOIN ELIGIBILITY ON OFFER_CHAIN.ID = ELIGIBILITY.OFFER_CHAIN_ID
14:33:54 1546  --	 INNER JOIN OFFER_CHAIN_META_DATA ON OFFER_CHAIN.ID = OFFER_CHAIN_META_DATA.OFFER_CHAIN_ID
14:33:54 1547  --    WHERE
14:33:54 1548  --      ELIGIBILITY.OFFER_CHAIN_ID = OFFER_CHAIN.ID
14:33:54 1549  --      AND ELIGIBILITY.NAME = GLOBAL_CONSTANTS_V22.GIFT_CERTIFICATE_REQUIRED
14:33:54 1550  --      AND ELIGIBILITY.VALUE = GLOBAL_CONSTANTS_V22.ELIGIBILITY_FLAG_SET
14:33:54 1551  --      AND OFFER_CHAIN_META_DATA.OFFER_CHAIN_ID = OFFER_CHAIN.ID
14:33:54 1552  --      AND OFFER_CHAIN_META_DATA.NAME = GLOBAL_CONSTANTS_V22.REDEMPTION_OC_ID
14:33:54 1553  --      AND to_number(OFFER_CHAIN_META_DATA.VALUE) = var_purchased_oc_id
14:33:54 1554  --      AND ROWNUM = 1;
14:33:54 1555  
14:33:54 1556  	     EXCEPTION
14:33:54 1557  	     WHEN NO_DATA_FOUND THEN
14:33:54 1558  	       RAISE OC_TO_REDEEM_NOT_FOUND;
14:33:54 1559  	   END;
14:33:54 1560  	 END IF;
14:33:54 1561  
14:33:54 1562  	 -- Check that purchase invoice for this GC was closed
14:33:54 1563  	 SELECT
14:33:54 1564  	   INVOICE.INVOICE_STATUS_ID into var_gc_purchase_inv_status_id
14:33:54 1565  	 FROM
14:33:54 1566  	   INVOICE
14:33:54 1567  	 WHERE
14:33:54 1568  	   INVOICE.ID = var_gc_purchase_invoice_id;
14:33:54 1569  
14:33:54 1570  	 IF var_gc_purchase_inv_status_id != GLOBAL_STATUSES_V22.INVOICE_CLOSED THEN
14:33:54 1571  	   RAISE GC_PURCHASE_INVOICE_NOT_CLOSED;
14:33:54 1572  	 END IF;
14:33:54 1573  
14:33:54 1574  	 -- Check that this invoice was successfully processed by billing
14:33:54 1575  	 SELECT
14:33:54 1576  	   COUNT(1) into var_succ_purch_attempts_num
14:33:54 1577  	 FROM
14:33:54 1578  	   TRANSACTION_ATTEMPT TA
14:33:54 1579  	   INNER JOIN TRANSACTION T ON T.ID = TA.TRANSACTION_ID
14:33:54 1580  	   INNER JOIN CHARGE CH ON CH.TRANSACTION_ID = T.ID
14:33:54 1581  	 WHERE
14:33:54 1582  	   CH.INVOICE_ID = var_gc_purchase_invoice_id
14:33:54 1583  	   AND TA.TRANSACTION_ATTEMPT_STATUS_ID = GLOBAL_STATUSES_V22.TRANS_ATTEMPT_SUCCESS;
14:33:54 1584  
14:33:54 1585  	 IF var_succ_purch_attempts_num = 0 THEN
14:33:54 1586  	   SELECT
14:33:54 1587  	     COUNT(1) into var_succ_purch_attempts_num
14:33:54 1588  	   FROM
14:33:54 1589  	     DUAL
14:33:54 1590  	   WHERE
14:33:54 1591  	     PROCS_INVOICE_V22.F_CALCULATE_INVOICE_AMOUNT(var_gc_purchase_invoice_id) = 0;
14:33:54 1592  	 END IF;
14:33:54 1593  
14:33:54 1594  	 IF var_succ_purch_attempts_num = 0 THEN
14:33:54 1595  	   RAISE PURCHASE_INVOICES_NOT_PAID;
14:33:54 1596  	 END IF;
14:33:54 1597  
14:33:54 1598  	 -- Check limit for gc's offer chain
14:33:54 1599  	 SELECT
14:33:54 1600  	   COUNT(*) into var_same_offer_chains_num
14:33:54 1601  	 FROM
14:33:54 1602  	   SUBSCRIPTION
14:33:54 1603  	 WHERE
14:33:54 1604  	   SUBSCRIPTION.ACCOUNT_ID = var_account_id
14:33:54 1605  	   AND SUBSCRIPTION.OFFER_CHAIN_ID = var_oc_id_to_redeem
14:33:54 1606  	   AND (
14:33:54 1607  	     SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE
14:33:54 1608  	     OR SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_IN_GRACE_PERIOD);
14:33:54 1609  IF var_same_offer_chains_num = 0 THEN
14:33:54 1610  	   -- if user does not have any active existing subscriptions to the offer chain
14:33:54 1611  	   -- and if product from the offer chain is already owned from another offer chain
14:33:54 1612  	   -- then deny purchase
14:33:54 1613  	   FOR f_account_offer_chains IN (
14:33:54 1614  	     SELECT DISTINCT
14:33:54 1615  	       OFFER_CHAIN_ID
14:33:54 1616  	     FROM
14:33:54 1617  	       SUBSCRIPTION
14:33:54 1618  	     WHERE
14:33:54 1619  	       ACCOUNT_ID = var_account_id
14:33:54 1620  	       AND (
14:33:54 1621  		 SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE
14:33:54 1622  		 OR SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_SUSPENDED
14:33:54 1623  		 OR SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_IN_GRACE_PERIOD)
14:33:54 1624  	   )
14:33:54 1625  	   LOOP
14:33:54 1626  	     IF PROCS_OFFER_CHAIN_V22.CHECK_FOR_SAME_PRODUCTS(var_oc_id_to_redeem, f_account_offer_chains.OFFER_CHAIN_ID) = GLOBAL_CONSTANTS_V22.TRUE THEN
14:33:54 1627  	       RAISE USER_ALREADY_SUBSCRIBED_TO_PRD;
14:33:54 1628  	     END IF;
14:33:54 1629  	   END LOOP;
14:33:54 1630  	 ELSE
14:33:54 1631  
14:33:54 1632  	   -- if user have any active existing subscriptions to the offer chain
14:33:54 1633  	   -- and if MAX_CONCURRENT_SUBS <= [user's subscription count for the offer chain]
14:33:54 1634  	   -- then deny purchase
14:33:54 1635  	   var_max_concurrent_subscrs := PROCS_OFFER_CHAIN_V22.GET_OFFER_CHAIN_MAX_CONC_SUBSC(var_oc_id_to_redeem);
14:33:54 1636  	   IF var_max_concurrent_subscrs != GLOBAL_CONSTANTS_V22.INFINITY
14:33:54 1637  	     AND var_max_concurrent_subscrs <= var_same_offer_chains_num THEN
14:33:54 1638  	     RAISE LIMIT_REACHED;
14:33:54 1639  	   END IF;
14:33:54 1640  	 END IF;
14:33:54 1641  -- norlov: END OF TODO
14:33:54 1642  
14:33:54 1643  
14:33:54 1644  	 IF var_gc_redeemer_group_id IS NOT NULL THEN
14:33:54 1645  	   RAISE GIFT_CERTIFICATE_REDEEMED;
14:33:54 1646  	 END IF;
14:33:54 1647  
14:33:54 1648  	 IF var_gc_expiration_date < sysdate THEN
14:33:54 1649  	   RAISE GIFT_CERTIFICATE_EXPIRED;
14:33:54 1650  	 END IF;
14:33:54 1651  
14:33:54 1652  	  IF var_gc_status_id = GLOBAL_STATUSES_V22.GIFT_CERTIFICATE_REFUNDED THEN
14:33:54 1653  	   RAISE GIFT_CERT_IS_REFUNDED;
14:33:54 1654  	 END IF;
14:33:54 1655  
14:33:54 1656  	 IF var_gc_status_id = GLOBAL_STATUSES_V22.GIFT_CERTIFICATE_FINALIZED THEN
14:33:54 1657  	   RAISE GIFT_CERT_IS_FINALIZED;
14:33:54 1658  	 END IF;
14:33:54 1659  
14:33:54 1660  	 -- Check that user did not subscribed to same product already
14:33:54 1661  	 -- norlov: get rid of this since there is already the check?
14:33:54 1662  	 FOR f_user_offer_chain IN (
14:33:54 1663  	   SELECT DISTINCT
14:33:54 1664  	     OFFER_CHAIN_ID
14:33:54 1665  	   FROM
14:33:54 1666  	     SUBSCRIPTION
14:33:54 1667  	   WHERE
14:33:54 1668  	     ACCOUNT_ID=var_account_id
14:33:54 1669  	     AND (
14:33:54 1670  	       SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE
14:33:54 1671  	       OR SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_SUSPENDED
14:33:54 1672  	       OR SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_IN_GRACE_PERIOD)
14:33:54 1673  	 )
14:33:54 1674  	 LOOP
14:33:54 1675  	   IF PROCS_OFFER_CHAIN_V22.CHECK_FOR_SAME_PRODUCTS(var_oc_id_to_redeem, f_user_offer_chain.OFFER_CHAIN_ID)=GLOBAL_CONSTANTS_V22.TRUE THEN
14:33:54 1676  	     RAISE USER_ALREADY_SUBSCRIBED_TO_PRD;
14:33:54 1677  	   END IF;
14:33:54 1678  	 END LOOP;
14:33:54 1679  
14:33:54 1680  	 -- Check for gift certificate amount
14:33:54 1681  	 SELECT
14:33:54 1682  	   SUM(CHARGE.CHARGE_AMOUNT) into var_gc_charges_amount
14:33:54 1683  	 FROM
14:33:54 1684  	   CHARGE
14:33:54 1685  	 WHERE
14:33:54 1686  	   CHARGE.INSTRUMENT_ID = var_gift_certificate_id
14:33:54 1687  	   AND CHARGE.INSTRUMENT_TYPE_ID = GLOBAL_ENUMS_V22.INSTRUMENT_GIFT_CERTIFICATE;
14:33:54 1688  
14:33:54 1689  	 -- Create new invoice
14:33:54 1690  	 PROCS_INVOICE_V22.CREATE_INVOICE(
14:33:54 1691  	   out_invoice_id    => var_invoice_id,
14:33:54 1692  	   in_invoice_status => GLOBAL_STATUSES_V22.INVOICE_CLOSED,
14:33:54 1693  	   in_tax_exempt_id  => var_account_tax_exempt_id,
14:33:54 1694  	   in_created_by     => in_created_by
14:33:54 1695  	 );
14:33:54 1696  
14:33:54 1697  	 -- If a financial instrument wasn't passed in, use the gift certificate id
14:33:54 1698  	 -- Real financial instrument is required for upsell/till forbid gift subscriptions
14:33:54 1699  	 IF var_fin_instrument_id is null THEN
14:33:54 1700  	   var_fin_instrument_id := var_gift_certificate_id;
14:33:54 1701  	   var_fin_instrument_type_id := GLOBAL_ENUMS_V22.INSTRUMENT_GIFT_CERTIFICATE;
14:33:54 1702  	 END IF;
14:33:54 1703  
14:33:54 1704  	 -- Insert new row into subscription table
14:33:54 1705  	 PROCS_SUBSCRIPTION_CRU_V22.CREATE_SUBSCRIPTION(
14:33:54 1706  	   out_subscription_id	     => var_subscription_id,
14:33:54 1707  	   in_account_id	     => var_account_id,
14:33:54 1708  	   in_purchase_date	     => var_date,
14:33:54 1709  	   in_offer_chain_id	     => var_oc_id_to_redeem,
14:33:54 1710  	   in_created_by	     => in_created_by,
14:33:54 1711  	   in_instrument_type_id     => var_fin_instrument_type_id,
14:33:54 1712  	   in_instrument_id	     => var_fin_instrument_id,
14:33:54 1713  	   in_subscription_status_id => GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE
14:33:54 1714  	 );
14:33:54 1715  
14:33:54 1716  	 out_subscription_id := var_subscription_id;
14:33:54 1717  
14:33:54 1718  	 BEGIN
14:33:54 1719  	   PROCS_OFFER_CHAIN_V22.GET_FIRST_OFFER(var_oc_id_to_redeem, var_first_offer_id);
14:33:54 1720  	   EXCEPTION
14:33:54 1721  	     WHEN OTHERS THEN
14:33:54 1722  	       EXCEPTION_MESSAGE := SQLERRM;
14:33:54 1723  	       RAISE CAN_NOT_GET_FIRST_OFFER_CHAIN;
14:33:54 1724  	 END;
14:33:54 1725  
14:33:54 1726  	 BEGIN
14:33:54 1727  	   PROCS_LICENSE_V22.CREATE_LICENSE (
14:33:54 1728  	     out_license_id		 => out_license_id,
14:33:54 1729  	     in_status_id		 => GLOBAL_STATUSES_V22.LICENSE_ACTIVE,
14:33:54 1730  	     in_needs_entitlements	 => GLOBAL_CONSTANTS_V22.TRUE,
14:33:54 1731  	     in_start_date		 => var_date,
14:33:54 1732  	     in_offer_id		 => var_first_offer_id,
14:33:54 1733  	     in_subscription_id 	 => var_subscription_id,
14:33:54 1734  	     in_invoice_id		 => var_invoice_id,
14:33:54 1735  	     in_created_by		 => in_created_by,
14:33:54 1736  	     in_end_date		 => NULL, -- Will be calculated automatically
14:33:54 1737  	     in_is_extension		 => GLOBAL_CONSTANTS_V22.FALSE,
14:33:54 1738  	     in_current_offer_index	 => PROCS_OFFER_CHAIN_V22.GET_FIRST_OFFER_INDEX(var_oc_id_to_redeem),
14:33:54 1739  	     in_current_offer_recurr_num => 1
14:33:54 1740  	   );
14:33:54 1741  
14:33:54 1742  	   EXCEPTION
14:33:54 1743  	     WHEN OTHERS THEN
14:33:54 1744  	       EXCEPTION_MESSAGE := SQLERRM;
14:33:54 1745  	       RAISE CAN_NOT_CREATE_LICENSE;
14:33:54 1746  	 END;
14:33:54 1747  
14:33:54 1748  	 -- Update original gift certificate
14:33:54 1749  	 BEGIN
14:33:54 1750  	   PROCS_FIN_INSTRUMENTS_CRU_V22.UPDATE_GIFT_CERTIFICATE(
14:33:54 1751  	     in_gift_certificate_id	   => var_gift_certificate_id,
14:33:54 1752  	     in_updated_by		   => in_created_by,
14:33:54 1753  	     in_redeemer_group_id	   => in_group_id,
14:33:54 1754  	     in_finalized_invoice_id	   => var_invoice_id,
14:33:54 1755  	     in_redemption_date 	   => var_date,
14:33:54 1756  	     in_redeemer_address_id	   => in_redeemer_address_id,
14:33:54 1757  	     in_gift_certificate_status_id => GLOBAL_STATUSES_V22.GIFT_CERTIFICATE_FINALIZED
14:33:54 1758  	   );
14:33:54 1759  	   EXCEPTION
14:33:54 1760  	     WHEN OTHERS THEN
14:33:54 1761  	       EXCEPTION_MESSAGE := SQLERRM;
14:33:54 1762  	       RAISE CAN_NOT_UPDATE_CERTIFICATE;
14:33:54 1763  	 END;
14:33:54 1764  
14:33:54 1765  EXCEPTION
14:33:54 1766  WHEN LIMIT_REACHED THEN
14:33:54 1767  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.CONFLICT_ERROR,
14:33:54 1768  	   SPROC_NAME, 'Limit reached for given offer chain');
14:33:54 1769  WHEN USER_ALREADY_SUBSCRIBED_TO_PRD THEN
14:33:54 1770  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.CONFLICT_ERROR,
14:33:54 1771  	   SPROC_NAME, 'User already subscribed to some product in given gift certificate');
14:33:54 1772  WHEN GIFT_CERTIFICATE_REDEEMED THEN
14:33:54 1773  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:54 1774  	   SPROC_NAME, 'Gift certificate already redeemed');
14:33:54 1775  WHEN GIFT_CERTIFICATE_EXPIRED THEN
14:33:54 1776  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:54 1777  	   SPROC_NAME, 'Gift certificate expired');
14:33:54 1778  WHEN GIFT_CERT_IS_FINALIZED THEN
14:33:54 1779  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:54 1780  	   SPROC_NAME, 'Gift certificate is finalized');
14:33:54 1781  WHEN GIFT_CERT_IS_REFUNDED THEN
14:33:54 1782  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:54 1783  	   SPROC_NAME, 'Gift certificate has been refunded');
14:33:54 1784  WHEN BAD_GROUP_ID THEN
14:33:54 1785  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1786  	   SPROC_NAME, 'No such account with given group id');
14:33:54 1787  WHEN OC_TO_REDEEM_NOT_FOUND THEN
14:33:54 1788  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1789  	   SPROC_NAME, 'Offer chain to redeem not found');
14:33:54 1790  WHEN BAD_GIFT_CERTIFICATE_CODE THEN
14:33:54 1791  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1792  	   SPROC_NAME, 'No such gift certificate code');
14:33:54 1793  WHEN CAN_NOT_CREATE_LICENSE THEN
14:33:54 1794  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 1795  	   SPROC_NAME, 'Could not create new license', EXCEPTION_MESSAGE);
14:33:54 1796  WHEN CAN_NOT_UPDATE_CERTIFICATE THEN
14:33:54 1797  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 1798  	   SPROC_NAME, 'Could not update gift certificate', EXCEPTION_MESSAGE);
14:33:54 1799  WHEN GC_PURCHASE_INVOICE_NOT_CLOSED THEN
14:33:54 1800  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:54 1801  	   SPROC_NAME, 'Purchase invoice is not closed');
14:33:54 1802  WHEN PURCHASE_INVOICES_NOT_PAID THEN
14:33:54 1803  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:54 1804  	   SPROC_NAME, 'Purchase invoice is not successfully processed by billing');
14:33:54 1805  WHEN OTHERS THEN
14:33:54 1806  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1807  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1808  END;
14:33:54 1809  
14:33:54 1810  /******************************************************************************/
14:33:54 1811  
14:33:54 1812  PROCEDURE GET_GIFT_CERTIFICATE_BY_CODE (
14:33:54 1813  /*
14:33:54 1814  Throws exceptions:
14:33:54 1815  APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1816  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 1817  */
14:33:54 1818  	 in_code	IN VARCHAR,
14:33:54 1819  	 out_result_set OUT SYS_REFCURSOR
14:33:54 1820  ) AS
14:33:54 1821  -- VARIABLES
14:33:54 1822  SPROC_NAME		CONSTANT VARCHAR2(28) := 'GET_GIFT_CERTIFICATE_BY_CODE';
14:33:54 1823  temp_gift_certificate_id NUMBER;
14:33:54 1824  -- EXCEPTIONS
14:33:54 1825  BAD_GIFT_CERTIFICATE_CODE EXCEPTION;
14:33:54 1826  BEGIN
14:33:54 1827  
14:33:54 1828  	 BEGIN
14:33:54 1829  	   SELECT
14:33:54 1830  	     GIFT_CERTIFICATE.ID into temp_gift_certificate_id
14:33:54 1831  	   FROM
14:33:54 1832  	     GIFT_CERTIFICATE
14:33:54 1833  	   WHERE
14:33:54 1834  	     GIFT_CERTIFICATE.CODE = in_code;
14:33:54 1835  	   EXCEPTION
14:33:54 1836  	     WHEN NO_DATA_FOUND THEN
14:33:54 1837  	       RAISE BAD_GIFT_CERTIFICATE_CODE;
14:33:54 1838  	 END;
14:33:54 1839  
14:33:54 1840  	 -- Select all gift certificates with given code
14:33:54 1841  	 OPEN out_result_set FOR
14:33:54 1842  	 SELECT
14:33:54 1843  	   gc.EXPIRATION_DATE,
14:33:54 1844  	   ch.name,
14:33:54 1845  	   ch.id,
14:33:54 1846  	   gc.sender_email,
14:33:54 1847  	   gc.sender_name,
14:33:54 1848  	   gc.recipient_email,
14:33:54 1849  	   gc.recipient_name,
14:33:54 1850  	   gc.purchase_date,
14:33:54 1851  	   gc.redemption_date,
14:33:54 1852  	   gc.purchaser_group_id,
14:33:54 1853  	   gc.redeemer_group_id,
14:33:54 1854  	   gc.gift_message,
14:33:54 1855  	   ocmd.value redemption_offer_chain_ids,
14:33:54 1856  	   s.offer_chain_id redeemed_offer_chain_id,
14:33:54 1857  	   gc.recipient_notify_date,
14:33:54 1858  	   gc.gift_certificate_status_id,
14:33:54 1859  	   gc.purchase_invoice_id,
14:33:54 1860  	   gc.finalized_invoice_id,
14:33:54 1861  	   gccr.reference_code
14:33:54 1862  	 FROM
14:33:54 1863  	   GIFT_CERTIFICATE gc
14:33:54 1864  	 INNER JOIN OFFER_CHAIN ch ON ch.id = gc.offer_chain_id
14:33:54 1865  	 INNER JOIN OFFER_CHAIN_META_DATA ocmd ON gc.offer_chain_id = ocmd.offer_chain_id AND ocmd.name = 'redemption offer chain id'
14:33:54 1866  	 LEFT JOIN LICENSE l ON l.invoice_id = gc.finalized_invoice_id
14:33:54 1867  	 LEFT JOIN SUBSCRIPTION s ON l.subscription_id = s.id
14:33:54 1868  	 LEFT JOIN GC_CAMPAIGN_AND_REF gccr ON gc.id = gccr.GC_ID
14:33:54 1869  	 WHERE
14:33:54 1870  	   gc.code = in_code;
14:33:54 1871  
14:33:54 1872  EXCEPTION
14:33:54 1873  WHEN BAD_GIFT_CERTIFICATE_CODE THEN
14:33:54 1874  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1875  	   SPROC_NAME, 'No such gift certificate');
14:33:54 1876  
14:33:54 1877  WHEN OTHERS THEN
14:33:54 1878  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1879  	   SPROC_NAME, 'Unknown Error', SQLERRM);
14:33:54 1880  END;
14:33:54 1881  
14:33:54 1882  /******************************************************************************/
14:33:54 1883  
14:33:54 1884  PROCEDURE GET_GIFT_CERTIFICATE_BY_ID (
14:33:54 1885  /*
14:33:54 1886  Throws exceptions:
14:33:54 1887  APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1888  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 1889  */
14:33:54 1890  	 in_gift_certificate_id IN NUMBER,
14:33:54 1891  	 out_result_set 	OUT SYS_REFCURSOR
14:33:54 1892  ) AS
14:33:54 1893  -- VARIABLES
14:33:54 1894  SPROC_NAME		CONSTANT VARCHAR2(26) := 'GET_GIFT_CERTIFICATE_BY_ID';
14:33:54 1895  temp_gift_certificate_id NUMBER;
14:33:54 1896  -- EXCEPTIONS
14:33:54 1897  BAD_GIFT_CERTIFICATE_ID EXCEPTION;
14:33:54 1898  BEGIN
14:33:54 1899  
14:33:54 1900  	 BEGIN
14:33:54 1901  	   SELECT
14:33:54 1902  	     GIFT_CERTIFICATE.ID into temp_gift_certificate_id
14:33:54 1903  	   FROM
14:33:54 1904  	     GIFT_CERTIFICATE
14:33:54 1905  	   WHERE
14:33:54 1906  	     GIFT_CERTIFICATE.ID = in_gift_certificate_id;
14:33:54 1907  	   EXCEPTION
14:33:54 1908  	     WHEN NO_DATA_FOUND THEN
14:33:54 1909  	       RAISE BAD_GIFT_CERTIFICATE_ID;
14:33:54 1910  	 END;
14:33:54 1911  
14:33:54 1912  	 -- Select all gift certificates with given code
14:33:54 1913  	 OPEN out_result_set FOR
14:33:54 1914  	 SELECT
14:33:54 1915  	   gc.EXPIRATION_DATE,
14:33:54 1916  	   ch.name,
14:33:54 1917  	   ch.id,
14:33:54 1918  	   gc.sender_email,
14:33:54 1919  	   gc.sender_name,
14:33:54 1920  	   gc.recipient_email,
14:33:54 1921  	   gc.recipient_name,
14:33:54 1922  	   gc.purchase_date,
14:33:54 1923  	   gc.redemption_date,
14:33:54 1924  	   gc.purchaser_group_id,
14:33:54 1925  	   gc.redeemer_group_id,
14:33:54 1926  	   gc.code,
14:33:54 1927  	   gc.gift_message,
14:33:54 1928  	   gc.recipient_notify_date
14:33:54 1929  	 FROM
14:33:54 1930  	   GIFT_CERTIFICATE gc
14:33:54 1931  	 INNER JOIN OFFER_CHAIN ch ON ch.id = gc.offer_chain_id
14:33:54 1932  	 WHERE
14:33:54 1933  	   gc.id = in_gift_certificate_id;
14:33:54 1934  
14:33:54 1935  EXCEPTION
14:33:54 1936  WHEN BAD_GIFT_CERTIFICATE_ID THEN
14:33:54 1937  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1938  	   SPROC_NAME, 'No such gift certificate');
14:33:54 1939  WHEN OTHERS THEN
14:33:54 1940  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1941  	   SPROC_NAME, 'Unknown Error', SQLERRM);
14:33:54 1942  END GET_GIFT_CERTIFICATE_BY_ID;
14:33:54 1943  
14:33:54 1944  /******************************************************************************/
14:33:54 1945  
14:33:54 1946  PROCEDURE GET_DEF_FINANCIAL_INSTRUMENT (
14:33:54 1947  	 in_group_id		IN  NUMBER,
14:33:54 1948  	 out_instrument_type_id OUT NUMBER,
14:33:54 1949  	 out_instrument_id	OUT NUMBER
14:33:54 1950  ) AS
14:33:54 1951  SPROC_NAME CONSTANT VARCHAR2(28) := 'GET_DEF_FINANCIAL_INSTRUMENT';
14:33:54 1952  BEGIN
14:33:54 1953  
14:33:54 1954  	 SELECT
14:33:54 1955  	   ACCOUNT.INSTRUMENT_TYPE_ID,
14:33:54 1956  	   ACCOUNT.INSTRUMENT_ID
14:33:54 1957  	   into
14:33:54 1958  	   out_instrument_type_id,
14:33:54 1959  	   out_instrument_id
14:33:54 1960  	 FROM
14:33:54 1961  	   ACCOUNT
14:33:54 1962  	 WHERE
14:33:54 1963  	   ACCOUNT.GROUP_ID = in_group_id;
14:33:54 1964  
14:33:54 1965  EXCEPTION
14:33:54 1966  WHEN NO_DATA_FOUND THEN
14:33:54 1967  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1968  	   SPROC_NAME, 'Bad group id');
14:33:54 1969  WHEN OTHERS THEN
14:33:54 1970  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1971  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1972  END GET_DEF_FINANCIAL_INSTRUMENT;
14:33:54 1973  
14:33:54 1974  /******************************************************************************/
14:33:54 1975  
14:33:54 1976  PROCEDURE SET_DEF_FINANCIAL_INSTRUMENT (
14:33:54 1977  	 in_group_id	       IN NUMBER,
14:33:54 1978  	 in_instrument_type_id IN NUMBER,
14:33:54 1979  	 in_instrument_id      IN NUMBER,
14:33:54 1980  	 in_updated_by	       IN VARCHAR2
14:33:54 1981  ) AS
14:33:54 1982  -- VARIABLES
14:33:54 1983  SPROC_NAME	      CONSTANT VARCHAR2(28) := 'SET_DEF_FINANCIAL_INSTRUMENT';
14:33:54 1984  var_account_id	      NUMBER;
14:33:54 1985  -- EXCEPTIONS
14:33:54 1986  BAD_GROUP_ID	      EXCEPTION;
14:33:54 1987  BAD_CREDIT_CARD	      EXCEPTION;
14:33:54 1988  BAD_PAYPAL	      EXCEPTION;
14:33:54 1989  BAD_INSTRUMENT_TYPE    EXCEPTION;
14:33:54 1990  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:54 1991  BEGIN
14:33:54 1992  
14:33:54 1993  	 -- get account id
14:33:54 1994  	 BEGIN
14:33:54 1995  	   SELECT
14:33:54 1996  	     ACCOUNT.ID into var_account_id
14:33:54 1997  	   FROM
14:33:54 1998  	     ACCOUNT
14:33:54 1999  	   WHERE
14:33:54 2000  	     ACCOUNT.GROUP_ID = in_group_id;
14:33:54 2001  	   EXCEPTION
14:33:54 2002  	     WHEN NO_DATA_FOUND THEN
14:33:54 2003  	       RAISE BAD_GROUP_ID;
14:33:54 2004  	 END;
14:33:54 2005  
14:33:54 2006  	 -- Chech that given instrument exists
14:33:54 2007  	 IF in_instrument_type_id = GLOBAL_ENUMS_V22.INSTRUMENT_CREDIT_CARD THEN
14:33:54 2008  	   IF IS_CREDIT_CARD_EXISTS(in_instrument_id) = GLOBAL_CONSTANTS_V22.FALSE THEN
14:33:54 2009  	     RAISE BAD_CREDIT_CARD;
14:33:54 2010  	   END IF;
14:33:54 2011  	 ELSIF in_instrument_type_id = GLOBAL_ENUMS_V22.INSTRUMENT_PAYPAL THEN
14:33:54 2012  	   IF IS_PAYPAL_EXISTS(in_instrument_id) = GLOBAL_CONSTANTS_V22.FALSE THEN
14:33:54 2013  	     RAISE BAD_PAYPAL;
14:33:54 2014  	   END IF;
14:33:54 2015  	 ELSE
14:33:54 2016  	   RAISE BAD_INSTRUMENT_TYPE;
14:33:54 2017  	 END IF;
14:33:54 2018  
14:33:54 2019  	 -- update account information
14:33:54 2020  	 PROCS_ACCOUNT_CRU_V22.UPDATE_ACCOUNT(
14:33:54 2021  	   in_account_id	 => var_account_id,
14:33:54 2022  	   in_updated_by	 => in_updated_by,
14:33:54 2023  	   in_instrument_type_id => in_instrument_type_id,
14:33:54 2024  	   in_instrument_id	 => in_instrument_id
14:33:54 2025  	 );
14:33:54 2026  
14:33:54 2027  EXCEPTION
14:33:54 2028  WHEN BAD_GROUP_ID THEN
14:33:54 2029  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 2030  	   SPROC_NAME, 'No such account');
14:33:54 2031  WHEN BAD_CREDIT_CARD THEN
14:33:54 2032  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 2033  	   SPROC_NAME, 'Could not find credit card with given ID');
14:33:54 2034  WHEN BAD_PAYPAL THEN
14:33:54 2035  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 2036  	   SPROC_NAME, 'Could not find paypal with given ID');
14:33:54 2037  WHEN BAD_INSTRUMENT_TYPE THEN
14:33:54 2038  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:54 2039  	   SPROC_NAME, 'Bad instrument type id');
14:33:54 2040  WHEN OTHERS THEN
14:33:54 2041  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 2042  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 2043  END SET_DEF_FINANCIAL_INSTRUMENT;
14:33:54 2044  
14:33:54 2045  /******************************************************************************/
14:33:54 2046  
14:33:54 2047  PROCEDURE DEL_DEF_FINANCIAL_INSTRUMENT (
14:33:54 2048  	 in_group_id IN NUMBER
14:33:54 2049  ) AS
14:33:54 2050  SPROC_NAME CONSTANT VARCHAR2(28) := 'DEL_DEF_FINANCIAL_INSTRUMENT';
14:33:54 2051  -- VARIABLES
14:33:54 2052  var_account_id NUMBER;
14:33:54 2053  -- EXCEPTIONS
14:33:54 2054  BAD_GROUP_ID	 EXCEPTION;
14:33:54 2055  EXCEPTION_MESSAGE VARCHAR2(1024);
14:33:54 2056  BEGIN
14:33:54 2057  
14:33:54 2058  	 BEGIN
14:33:54 2059  	   SELECT
14:33:54 2060  	     ACCOUNT.ID into var_account_id
14:33:54 2061  	   FROM
14:33:54 2062  	     ACCOUNT
14:33:54 2063  	   WHERE
14:33:54 2064  	     ACCOUNT.GROUP_ID = in_group_id;
14:33:54 2065  	   EXCEPTION
14:33:54 2066  	     WHEN NO_DATA_FOUND THEN
14:33:54 2067  	       RAISE BAD_GROUP_ID;
14:33:54 2068  	 END;
14:33:54 2069  
14:33:54 2070  	 PROCS_ACCOUNT_CRU_V22.UPDATE_DEF_FIN_INSTRUMENT(
14:33:54 2071  	   in_account_id => var_account_id,
14:33:54 2072  	   in_instrument_type_id => NULL,
14:33:54 2073  	   in_instrument_id => NULL,
14:33:54 2074  	   in_updated_by => 'in_updated_by' -- TODO: add in_updated_by field
14:33:54 2075  	 );
14:33:54 2076  
14:33:54 2077  EXCEPTION
14:33:54 2078  WHEN BAD_GROUP_ID THEN
14:33:54 2079  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 2080  	   SPROC_NAME, 'No such group id');
14:33:54 2081  WHEN OTHERS THEN
14:33:54 2082  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 2083  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 2084  END DEL_DEF_FINANCIAL_INSTRUMENT;
14:33:54 2085  
14:33:54 2086  /******************************************************************************/
14:33:54 2087  
14:33:54 2088  PROCEDURE GET_CREDIT_CARD_BY_ID (
14:33:54 2089  	 in_credit_card_id IN  NUMBER,
14:33:54 2090  	 out_result_set    OUT SYS_REFCURSOR
14:33:54 2091  ) AS
14:33:54 2092  -- VARIABLES
14:33:54 2093  SPROC_NAME    CONSTANT VARCHAR2(21) := 'GET_CREDIT_CARD_BY_ID';
14:33:54 2094  temp_cc_count NUMBER;
14:33:54 2095  
14:33:54 2096  -- EXCEPTIONS
14:33:54 2097  BAD_CREDIT_CARD_ID EXCEPTION;
14:33:54 2098  BEGIN
14:33:54 2099  
14:33:54 2100  	 -- Check that credit card exists
14:33:54 2101  	 SELECT
14:33:54 2102  	   COUNT(*) into temp_cc_count
14:33:54 2103  	 FROM
14:33:54 2104  	   CREDIT_CARD
14:33:54 2105  	 WHERE
14:33:54 2106  	   CREDIT_CARD.ID = in_credit_card_id;
14:33:54 2107  	 IF temp_cc_count = 0 THEN
14:33:54 2108  	   RAISE BAD_CREDIT_CARD_ID;
14:33:54 2109  	 END IF;
14:33:54 2110  
14:33:54 2111  	 -- Get data
14:33:54 2112  	 OPEN out_result_set FOR
14:33:54 2113  	 SELECT
14:33:54 2114  	   CREDIT_CARD.ID,
14:33:54 2115  	   CREDIT_CARD.ACCOUNT_ID,
14:33:54 2116  	   CREDIT_CARD.INSTRUMENT_NAME,
14:33:54 2117  	   CREDIT_CARD.PRIVATE_CARD_HOLDER_NAME,
14:33:54 2118  	   CREDIT_CARD.PRIVATE_STREET_ADDRESS,
14:33:54 2119  	   CREDIT_CARD.PRIVATE_STREET_ADDRESS2,
14:33:54 2120  	   CREDIT_CARD.STATE,
14:33:54 2121  	   CREDIT_CARD.CITY,
14:33:54 2122  	   CREDIT_CARD.POSTAL_CODE,
14:33:54 2123  	   CREDIT_CARD.COUNTRY,
14:33:54 2124  	   CREDIT_CARD.LAST_FOUR_CC,
14:33:54 2125  	   CREDIT_CARD.EXPIRATION_DATE,
14:33:54 2126  	   CREDIT_CARD.CREDIT_CARD_TYPE_ID,
14:33:54 2127  	   CREDIT_CARD.SECRET_TOKEN,
14:33:54 2128  	   CREDIT_CARD.CREATE_DATE,
14:33:54 2129  	   CREDIT_CARD.CREATED_BY,
14:33:54 2130  	   CREDIT_CARD.UPDATE_DATE,
14:33:54 2131  	   CREDIT_CARD.UPDATED_BY,
14:33:54 2132  	   CREDIT_CARD.CREDIT_CARD_STATUS_ID,
14:33:54 2133  	   CREDIT_CARD.PRIVATE_FIRST_NAME,
14:33:54 2134  	   CREDIT_CARD.PRIVATE_LAST_NAME,
14:33:54 2135  	       CREDIT_CARD.CHASE_PROFILE_ID
14:33:54 2136  	 FROM
14:33:54 2137  	   CREDIT_CARD
14:33:54 2138  	 WHERE
14:33:54 2139  	   CREDIT_CARD.ID = in_credit_card_id;
14:33:54 2140  
14:33:54 2141  EXCEPTION
14:33:54 2142  WHEN BAD_CREDIT_CARD_ID THEN
14:33:54 2143  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 2144  	   SPROC_NAME, 'No such credit card');
14:33:54 2145  WHEN OTHERS THEN
14:33:54 2146  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 2147  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 2148  END GET_CREDIT_CARD_BY_ID;
14:33:54 2149  
14:33:54 2150  /******************************************************************************/
14:33:54 2151  
14:33:54 2152  PROCEDURE GET_PAYPAL_BY_ID (
14:33:54 2153  	 in_paypal_id	IN  NUMBER,
14:33:54 2154  	 out_result_set OUT SYS_REFCURSOR
14:33:54 2155  ) AS
14:33:54 2156  SPROC_NAME CONSTANT VARCHAR2(16) := 'GET_PAYPAL_BY_ID';
14:33:54 2157  -- VARIABLES
14:33:54 2158  temp_pp_count NUMBER;
14:33:54 2159  -- EXCEPTIONS
14:33:54 2160  BAD_PAYPAL_ID EXCEPTION;
14:33:54 2161  BEGIN
14:33:54 2162  
14:33:54 2163  	 -- Check that credit card exists
14:33:54 2164  	 SELECT
14:33:54 2165  	   COUNT(*) into temp_pp_count
14:33:54 2166  	 FROM
14:33:54 2167  	   PAYPAL
14:33:54 2168  	 WHERE
14:33:54 2169  	   PAYPAL.ID = in_paypal_id;
14:33:54 2170  	 IF temp_pp_count = 0 THEN
14:33:54 2171  	   RAISE BAD_PAYPAL_ID;
14:33:54 2172  	 END IF;
14:33:54 2173  
14:33:54 2174  	 OPEN out_result_set FOR
14:33:54 2175  	 SELECT
14:33:54 2176  	   ID,
14:33:54 2177  	   ACCOUNT_ID,
14:33:54 2178  	   INSTRUMENT_NAME,
14:33:54 2179  	   PRIVATE_EMAIL_ADDRESS,
14:33:54 2180  	   CREATE_DATE,
14:33:54 2181  	   CREATED_BY,
14:33:54 2182  	   UPDATE_DATE,
14:33:54 2183  	   UPDATED_BY,
14:33:54 2184  	   PAYPAL_STATUS_ID,
14:33:54 2185  	   PRIVATE_STREET_ADDRESS,
14:33:54 2186  	   PRIVATE_STREET_ADDRESS2,
14:33:54 2187  	   STATE,
14:33:54 2188  	   CITY,
14:33:54 2189  	   POSTAL_CODE,
14:33:54 2190  	   COUNTRY,
14:33:54 2191  	   EXPIRATION_DATE,
14:33:54 2192  	   SECRET_TOKEN
14:33:54 2193  	 FROM
14:33:54 2194  	   PAYPAL
14:33:54 2195  	 WHERE
14:33:54 2196  	   ID = in_paypal_id;
14:33:54 2197  
14:33:54 2198  EXCEPTION
14:33:54 2199  WHEN BAD_PAYPAL_ID THEN
14:33:54 2200  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 2201  	   SPROC_NAME, 'No such paypal');
14:33:54 2202  WHEN OTHERS THEN
14:33:54 2203  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 2204  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 2205  END GET_PAYPAL_BY_ID;
14:33:54 2206  
14:33:54 2207  /******************************************************************************/
14:33:54 2208  
14:33:54 2209  FUNCTION F_CAN_DISABLE_CREDIT_CARD (
14:33:54 2210  /*
14:33:54 2211  	 Returns GLOBAL_CONSTANTS_V22.TRUE if system can disable credit card
14:33:54 2212  	 GLOBAL_CONSTANTS_V22.FALSE else
14:33:54 2213  */
14:33:54 2214  	 in_credit_card_id NUMBER
14:33:54 2215  ) RETURN NUMBER AS
14:33:54 2216  BEGIN
14:33:54 2217  	 -- STUB
14:33:54 2218  	 RETURN GLOBAL_CONSTANTS_V22.TRUE;
14:33:54 2219  END F_CAN_DISABLE_CREDIT_CARD;
14:33:54 2220  
14:33:54 2221  /******************************************************************************/
14:33:54 2222  
14:33:54 2223  PROCEDURE GET_PURCHASED_GCERTIFICATES (
14:33:54 2224  	 in_group_id	IN NUMBER,
14:33:54 2225  	 out_result_set OUT SYS_REFCURSOR
14:33:54 2226  ) AS
14:33:54 2227  -- VARIABLES
14:33:54 2228  SPROC_NAME     CONSTANT VARCHAR2(27) := 'GET_PURCHASED_GCERTIFICATES';
14:33:54 2229  var_account_id NUMBER;
14:33:54 2230  -- EXCEPTIONS
14:33:54 2231  BAD_GROUP_ID EXCEPTION;
14:33:54 2232  BEGIN
14:33:54 2233  
14:33:54 2234  	 BEGIN
14:33:54 2235  	   SELECT
14:33:54 2236  	     ACCOUNT.ID into var_account_id
14:33:54 2237  	   FROM
14:33:54 2238  	     ACCOUNT
14:33:54 2239  	   WHERE
14:33:54 2240  	     ACCOUNT.GROUP_ID = in_group_id;
14:33:54 2241  	   EXCEPTION
14:33:54 2242  	     WHEN NO_DATA_FOUND THEN
14:33:54 2243  	       RAISE BAD_GROUP_ID;
14:33:54 2244  	 END;
14:33:54 2245  
14:33:54 2246  	 OPEN out_result_set FOR
14:33:54 2247  	 SELECT
14:33:54 2248  	   GIFT_CERTIFICATE.CODE,
14:33:54 2249  	   GIFT_CERTIFICATE.EXPIRATION_DATE,
14:33:54 2250  	   OFFER_CHAIN.NAME AS "OFFER_CHAIN_NAME",
14:33:54 2251  	   OFFER_CHAIN.ID AS "OFFER_CHAIN_ID",
14:33:54 2252  	   GIFT_CERTIFICATE.SENDER_EMAIL,
14:33:54 2253  	   GIFT_CERTIFICATE.SENDER_NAME,
14:33:54 2254  	   GIFT_CERTIFICATE.RECIPIENT_EMAIL,
14:33:54 2255  	   GIFT_CERTIFICATE.RECIPIENT_NAME,
14:33:54 2256  	   GIFT_CERTIFICATE.PURCHASE_DATE,
14:33:54 2257  	   GIFT_CERTIFICATE.REDEMPTION_DATE,
14:33:54 2258  	   GIFT_CERTIFICATE.REDEEMER_GROUP_ID
14:33:54 2259  	 FROM
14:33:54 2260  	   GIFT_CERTIFICATE
14:33:54 2261  	   INNER JOIN OFFER_CHAIN ON GIFT_CERTIFICATE.OFFER_CHAIN_ID = OFFER_CHAIN.ID
14:33:54 2262  	 WHERE
14:33:54 2263  	   ROWNUM <= 100 AND
14:33:54 2264  	   GIFT_CERTIFICATE.PURCHASER_GROUP_ID = in_group_id;
14:33:54 2265  
14:33:54 2266  EXCEPTION
14:33:54 2267  WHEN BAD_GROUP_ID THEN
14:33:54 2268  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 2269  	   SPROC_NAME, 'No such group id');
14:33:54 2270  WHEN OTHERS THEN
14:33:54 2271  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 2272  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 2273  END GET_PURCHASED_GCERTIFICATES;
14:33:54 2274  
14:33:54 2275  /******************************************************************************/
14:33:54 2276  
14:33:54 2277  PROCEDURE IS_GCERT_FOR_PROPER_OFFER (
14:33:54 2278  	 in_gift_certificate_id IN NUMBER,
14:33:54 2279  	 in_charge_id		IN NUMBER,
14:33:54 2280  	 out_result		OUT NUMBER
14:33:54 2281  ) AS
14:33:54 2282  -- VARIABLES
14:33:54 2283  SPROC_NAME	    CONSTANT VARCHAR2(25) := 'IS_GCERT_FOR_PROPER_OFFER';
14:33:54 2284  var_invoice_id	    NUMBER;
14:33:54 2285  var_offer_chain_id   NUMBER;
14:33:54 2286  var_offer_chain_s_id NUMBER;
14:33:54 2287  -- EXCEPTIONS
14:33:54 2288  BAD_CHARGE_ID		 EXCEPTION;
14:33:54 2289  BAD_GIFT_CERTIFICATE_ID	 EXCEPTION;
14:33:54 2290  CAN_NOT_FIND_SUBSCRIPTION EXCEPTION;
14:33:54 2291  BEGIN
14:33:54 2292  
14:33:54 2293  	 BEGIN
14:33:54 2294  	   SELECT
14:33:54 2295  	     CHARGE.INVOICE_ID into var_invoice_id
14:33:54 2296  	   FROM
14:33:54 2297  	     CHARGE
14:33:54 2298  	   WHERE
14:33:54 2299  	     CHARGE.ID = in_charge_id;
14:33:54 2300  	   EXCEPTION
14:33:54 2301  	     WHEN NO_DATA_FOUND THEN
14:33:54 2302  	       RAISE BAD_CHARGE_ID;
14:33:54 2303  	 END;
14:33:54 2304  
14:33:54 2305  	 BEGIN
14:33:54 2306  	   SELECT
14:33:54 2307  	     GIFT_CERTIFICATE.OFFER_CHAIN_ID into var_offer_chain_id
14:33:54 2308  	   FROM
14:33:54 2309  	     GIFT_CERTIFICATE
14:33:54 2310  	   WHERE
14:33:54 2311  	     GIFT_CERTIFICATE.ID = in_gift_certificate_id;
14:33:54 2312  	   EXCEPTION
14:33:54 2313  	     WHEN NO_DATA_FOUND THEN
14:33:54 2314  	       RAISE BAD_GIFT_CERTIFICATE_ID;
14:33:54 2315  	 END;
14:33:54 2316  
14:33:54 2317  	 BEGIN
14:33:54 2318  	   SELECT
14:33:54 2319  	     SUBSCRIPTION.OFFER_CHAIN_ID into var_offer_chain_s_id
14:33:54 2320  	   FROM
14:33:54 2321  	     SUBSCRIPTION
14:33:54 2322  	   WHERE
14:33:54 2323  	     SUBSCRIPTION.ID IN (
14:33:54 2324  	       SELECT DISTINCT
14:33:54 2325  		 LICENSE.SUBSCRIPTION_ID
14:33:54 2326  	       FROM
14:33:54 2327  		 LICENSE
14:33:54 2328  	       WHERE
14:33:54 2329  		 LICENSE.INVOICE_ID = var_invoice_id
14:33:54 2330  	     );
14:33:54 2331  	   EXCEPTION
14:33:54 2332  	     WHEN NO_DATA_FOUND THEN
14:33:54 2333  	       RAISE CAN_NOT_FIND_SUBSCRIPTION;
14:33:54 2334  	 END;
14:33:54 2335  
14:33:54 2336  	 IF var_offer_chain_s_id = var_offer_chain_id THEN
14:33:54 2337  	   out_result := GLOBAL_CONSTANTS_V22.TRUE;
14:33:54 2338  	 ELSE
14:33:54 2339  	   out_result := GLOBAL_CONSTANTS_V22.FALSE;
14:33:54 2340  	 END IF;
14:33:54 2341  
14:33:54 2342  EXCEPTION
14:33:54 2343  WHEN BAD_CHARGE_ID THEN
14:33:54 2344  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 2345  	   SPROC_NAME, 'No such charge');
14:33:54 2346  WHEN BAD_GIFT_CERTIFICATE_ID THEN
14:33:54 2347  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 2348  	   SPROC_NAME, 'No such gift certificate');
14:33:54 2349  WHEN CAN_NOT_FIND_SUBSCRIPTION THEN
14:33:54 2350  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 2351  	   SPROC_NAME, 'Could not find subscription for given charge');
14:33:54 2352  WHEN OTHERS THEN
14:33:54 2353  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 2354  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 2355  END IS_GCERT_FOR_PROPER_OFFER;
14:33:54 2356  
14:33:54 2357  /******************************************************************************/
14:33:54 2358  
14:33:54 2359  FUNCTION IS_CREDIT_CARD_EXISTS (
14:33:54 2360  /*
14:33:54 2361  GLOBAL_CONSTANTS_V22.TRUE - if instrument exists
14:33:54 2362  GLOBAL_CONSTANTS_V22.FALSE - else
14:33:54 2363  */
14:33:54 2364  	 in_credit_card_id IN NUMBER
14:33:54 2365  ) RETURN NUMBER AS
14:33:54 2366  -- VARIABLES
14:33:54 2367  var_cc_count NUMBER;
14:33:54 2368  BEGIN
14:33:54 2369  	 SELECT
14:33:54 2370  	   COUNT(*) into var_cc_count
14:33:54 2371  	 FROM
14:33:54 2372  	   CREDIT_CARD
14:33:54 2373  	 WHERE
14:33:54 2374  	   CREDIT_CARD.ID = in_credit_card_id;
14:33:54 2375  
14:33:54 2376  	 IF var_cc_count = 0 THEN
14:33:54 2377  	   RETURN GLOBAL_CONSTANTS_V22.FALSE;
14:33:54 2378  	 ELSE
14:33:54 2379  	   RETURN GLOBAL_CONSTANTS_V22.TRUE;
14:33:54 2380  	 END IF;
14:33:54 2381  
14:33:54 2382  END IS_CREDIT_CARD_EXISTS;
14:33:54 2383  
14:33:54 2384  /******************************************************************************/
14:33:54 2385  
14:33:54 2386  FUNCTION IS_PAYPAL_EXISTS (
14:33:54 2387  /*
14:33:54 2388  GLOBAL_CONSTANTS_V22.TRUE - if instrument exists
14:33:54 2389  GLOBAL_CONSTANTS_V22.FALSE - else
14:33:54 2390  */
14:33:54 2391  	 in_paypal_id IN NUMBER
14:33:54 2392  ) RETURN NUMBER AS
14:33:54 2393  -- VARIABLES
14:33:54 2394  var_pp_count NUMBER;
14:33:54 2395  BEGIN
14:33:54 2396  	 SELECT
14:33:54 2397  	   COUNT(*) into var_pp_count
14:33:54 2398  	 FROM
14:33:54 2399  	   PAYPAL
14:33:54 2400  	 WHERE
14:33:54 2401  	   PAYPAL.ID = in_paypal_id;
14:33:54 2402  
14:33:54 2403  	 IF var_pp_count = 0 THEN
14:33:54 2404  	   RETURN GLOBAL_CONSTANTS_V22.FALSE;
14:33:54 2405  	 ELSE
14:33:54 2406  	   RETURN GLOBAL_CONSTANTS_V22.TRUE;
14:33:54 2407  	 END IF;
14:33:54 2408  
14:33:54 2409  END IS_PAYPAL_EXISTS;
14:33:54 2410  
14:33:54 2411  /******************************************************************************/
14:33:54 2412  
14:33:54 2413  FUNCTION IS_GIFT_CERTIFICATE_EXISTS (
14:33:54 2414  /*
14:33:54 2415  GLOBAL_CONSTANTS_V22.TRUE - if instrument exists
14:33:54 2416  GLOBAL_CONSTANTS_V22.FALSE - else
14:33:54 2417  */
14:33:54 2418  	 in_gift_certificate_id IN NUMBER
14:33:54 2419  ) RETURN NUMBER AS
14:33:54 2420  -- VARIABLES
14:33:54 2421  var_gc_count NUMBER;
14:33:54 2422  BEGIN
14:33:54 2423  	 SELECT
14:33:54 2424  	   COUNT(*) into var_gc_count
14:33:54 2425  	 FROM
14:33:54 2426  	   GIFT_CERTIFICATE
14:33:54 2427  	 WHERE
14:33:54 2428  	   GIFT_CERTIFICATE.ID = in_gift_certificate_id;
14:33:54 2429  
14:33:54 2430  	 IF var_gc_count = 0 THEN
14:33:54 2431  	   RETURN GLOBAL_CONSTANTS_V22.FALSE;
14:33:54 2432  	 ELSE
14:33:54 2433  	   RETURN GLOBAL_CONSTANTS_V22.TRUE;
14:33:54 2434  	 END IF;
14:33:54 2435  
14:33:54 2436  END IS_GIFT_CERTIFICATE_EXISTS;
14:33:54 2437  
14:33:54 2438  /******************************************************************************/
14:33:54 2439  
14:33:54 2440  PROCEDURE GET_GROUP_ID_BY_CREDIT_CARD_ID (
14:33:54 2441  	 in_credit_card_id IN NUMBER,
14:33:54 2442  	 out_group_id	   OUT NUMBER
14:33:54 2443  ) AS
14:33:54 2444  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_GROUP_ID_BY_CREDIT_CARD_ID';
14:33:54 2445  BEGIN
14:33:54 2446  	 SELECT
14:33:54 2447  	   ACCOUNT.GROUP_ID into out_group_id
14:33:54 2448  	 FROM
14:33:54 2449  	   CREDIT_CARD
14:33:54 2450  	   INNER JOIN ACCOUNT ON CREDIT_CARD.ACCOUNT_ID = ACCOUNT.ID
14:33:54 2451  	 WHERE
14:33:54 2452  	   CREDIT_CARD.ID = in_credit_card_id;
14:33:54 2453  EXCEPTION
14:33:54 2454  WHEN NO_DATA_FOUND THEN
14:33:54 2455  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 2456  	   SPROC_NAME, 'No such credit card');
14:33:54 2457  WHEN OTHERS THEN
14:33:54 2458  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 2459  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 2460  END GET_GROUP_ID_BY_CREDIT_CARD_ID;
14:33:54 2461  
14:33:54 2462  /******************************************************************************/
14:33:54 2463  
14:33:54 2464  PROCEDURE GET_GROUP_ID_BY_PAYPAL_ID (
14:33:54 2465  	 in_paypal_id IN NUMBER,
14:33:54 2466  	 out_group_id OUT NUMBER
14:33:54 2467  ) AS
14:33:54 2468  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GROUP_ID_BY_PAYPAL_ID';
14:33:54 2469  BEGIN
14:33:54 2470  	 SELECT
14:33:54 2471  	   ACCOUNT.GROUP_ID into out_group_id
14:33:54 2472  	 FROM
14:33:54 2473  	   PAYPAL
14:33:54 2474  	   INNER JOIN ACCOUNT ON PAYPAL.ACCOUNT_ID = ACCOUNT.ID
14:33:54 2475  	 WHERE
14:33:54 2476  	   PAYPAL.ID = in_paypal_id;
14:33:54 2477  EXCEPTION
14:33:54 2478  WHEN NO_DATA_FOUND THEN
14:33:54 2479  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 2480  	   SPROC_NAME, 'No such paypal');
14:33:54 2481  WHEN OTHERS THEN
14:33:54 2482  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 2483  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 2484  END GET_GROUP_ID_BY_PAYPAL_ID;
14:33:54 2485  
14:33:54 2486  /******************************************************************************/
14:33:54 2487  
14:33:54 2488  PROCEDURE UPDATE_CREDIT_CARD_STATUS (
14:33:54 2489  	 in_credit_card_id	  IN CREDIT_CARD.ID%TYPE,
14:33:54 2490  	 in_credit_card_status_id IN CREDIT_CARD.CREDIT_CARD_STATUS_ID%TYPE,
14:33:54 2491  	 in_updated_by		  IN CREDIT_CARD.UPDATED_BY%TYPE
14:33:54 2492  ) AS
14:33:54 2493  SPROC_NAME CONSTANT VARCHAR2(25) := 'UPDATE_CREDIT_CARD_STATUS';
14:33:54 2494  -- EXCEPTIONS
14:33:54 2495  BAD_CREDIT_CARD_ID     EXCEPTION;
14:33:54 2496  BAD_STATUS_ID	      EXCEPTION;
14:33:54 2497  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:54 2498  BEGIN
14:33:54 2499  
14:33:54 2500  	 IF in_credit_card_status_id != GLOBAL_STATUSES_V22.CREDIT_CARD_ACTIVE
14:33:54 2501  	   AND in_credit_card_status_id != GLOBAL_STATUSES_V22.CREDIT_CARD_INVALID
14:33:54 2502  	   AND in_credit_card_status_id != GLOBAL_STATUSES_V22.CREDIT_CARD_DISABLED
14:33:54 2503  	   AND in_credit_card_status_id != GLOBAL_STATUSES_V22.CREDIT_CARD_EXPIRED THEN
14:33:54 2504  	   RAISE BAD_STATUS_ID;
14:33:54 2505  	 END IF;
14:33:54 2506  
14:33:54 2507  	 PROCS_FIN_INSTRUMENTS_CRU_V22.UPDATE_CREDIT_CARD(
14:33:54 2508  	   in_credit_card_id	    => in_credit_card_id,
14:33:54 2509  	   in_updated_by	    => in_updated_by,
14:33:54 2510  	   in_credit_card_status_id => in_credit_card_status_id
14:33:54 2511  	 );
14:33:54 2512  
14:33:54 2513  	 IF SQL%ROWCOUNT = 0 THEN
14:33:54 2514  	   RAISE BAD_CREDIT_CARD_ID;
14:33:54 2515  	 END IF;
14:33:54 2516  
14:33:54 2517  EXCEPTION
14:33:54 2518  WHEN BAD_CREDIT_CARD_ID THEN
14:33:54 2519  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 2520  	   SPROC_NAME, 'No such credit card');
14:33:54 2521  WHEN BAD_STATUS_ID THEN
14:33:54 2522  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:54 2523  	   SPROC_NAME, 'Bad credit card status id');
14:33:54 2524  WHEN OTHERS THEN
14:33:54 2525  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 2526  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 2527  END UPDATE_CREDIT_CARD_STATUS;
14:33:54 2528  
14:33:54 2529  /******************************************************************************/
14:33:54 2530  
14:33:54 2531  PROCEDURE UPDATE_PAYPAL_STATUS (
14:33:54 2532  	 in_paypal_id	     IN PAYPAL.ID%TYPE,
14:33:54 2533  	 in_paypal_status_id IN PAYPAL.PAYPAL_STATUS_ID%TYPE,
14:33:54 2534  	 in_updated_by	     IN PAYPAL.UPDATED_BY%TYPE
14:33:54 2535  ) AS
14:33:54 2536  SPROC_NAME CONSTANT VARCHAR2(20) := 'UPDATE_PAYPAL_STATUS';
14:33:54 2537  -- EXCEPTIONS
14:33:54 2538  BAD_PAYPAL_ID	      EXCEPTION;
14:33:54 2539  BAD_STATUS_ID	      EXCEPTION;
14:33:54 2540  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:54 2541  BEGIN
14:33:54 2542  
14:33:54 2543  	 IF in_paypal_status_id != GLOBAL_STATUSES_V22.PAYPAL_ACTIVE
14:33:54 2544  	   AND in_paypal_status_id != GLOBAL_STATUSES_V22.PAYPAL_INACTIVE
14:33:54 2545  	   AND in_paypal_status_id != GLOBAL_STATUSES_V22.PAYPAL_FROZEN THEN
14:33:54 2546  	   RAISE BAD_STATUS_ID;
14:33:54 2547  	 END IF;
14:33:54 2548  
14:33:54 2549  	 PROCS_FIN_INSTRUMENTS_CRU_V22.UPDATE_PAYPAL(
14:33:54 2550  	   in_paypal_id        => in_paypal_id,
14:33:54 2551  	   in_paypal_status_id => in_paypal_status_id,
14:33:54 2552  	   in_updated_by       => in_updated_by
14:33:54 2553  	 );
14:33:54 2554  
14:33:54 2555  	 IF SQL%ROWCOUNT = 0 THEN
14:33:54 2556  	   RAISE BAD_PAYPAL_ID;
14:33:54 2557  	 END IF;
14:33:54 2558  
14:33:54 2559  EXCEPTION
14:33:54 2560  WHEN BAD_PAYPAL_ID THEN
14:33:54 2561  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 2562  	   SPROC_NAME, 'No such paypal');
14:33:54 2563  WHEN BAD_STATUS_ID THEN
14:33:54 2564  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:54 2565  	   SPROC_NAME, 'Bad paypal status id');
14:33:54 2566  WHEN OTHERS THEN
14:33:54 2567  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 2568  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 2569  END UPDATE_PAYPAL_STATUS;
14:33:54 2570  
14:33:54 2571  /******************************************************************************/
14:33:54 2572  
14:33:54 2573  PROCEDURE UPDATE_GIFT_CERTIFICATE_STATUS (
14:33:54 2574  	 in_gift_certificate_id        IN GIFT_CERTIFICATE.ID%TYPE,
14:33:54 2575  	 in_gift_certificate_status_id IN GIFT_CERTIFICATE.GIFT_CERTIFICATE_STATUS_ID%TYPE,
14:33:54 2576  	 in_updated_by		       IN GIFT_CERTIFICATE.UPDATED_BY%TYPE
14:33:54 2577  ) AS
14:33:54 2578  SPROC_NAME CONSTANT VARCHAR2(30) := 'UPDATE_GIFT_CERTIFICATE_STATUS';
14:33:54 2579  -- EXCEPTIONS
14:33:54 2580  BAD_GIFT_CERTIFICATE_ID EXCEPTION;
14:33:54 2581  BAD_STATUS_ID	       EXCEPTION;
14:33:54 2582  EXCEPTION_MESSAGE       VARCHAR2(1024);
14:33:54 2583  BEGIN
14:33:54 2584  
14:33:54 2585  	 IF in_gift_certificate_status_id != GLOBAL_STATUSES_V22.GIFT_CERTIFICATE_ACTIVE
14:33:54 2586  	   AND in_gift_certificate_status_id != GLOBAL_STATUSES_V22.GIFT_CERTIFICATE_FINALIZED THEN
14:33:54 2587  	   RAISE BAD_STATUS_ID;
14:33:54 2588  	 END IF;
14:33:54 2589  
14:33:54 2590  	 PROCS_FIN_INSTRUMENTS_CRU_V22.UPDATE_GIFT_CERTIFICATE(
14:33:54 2591  	   in_gift_certificate_id	 => in_gift_certificate_id,
14:33:54 2592  	   in_gift_certificate_status_id => in_gift_certificate_status_id,
14:33:54 2593  	   in_updated_by		 => in_updated_by
14:33:54 2594  	 );
14:33:54 2595  
14:33:54 2596  	 IF SQL%ROWCOUNT = 0 THEN
14:33:54 2597  	   RAISE BAD_GIFT_CERTIFICATE_ID;
14:33:54 2598  	 END IF;
14:33:54 2599  
14:33:54 2600  EXCEPTION
14:33:54 2601  WHEN BAD_GIFT_CERTIFICATE_ID THEN
14:33:54 2602  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 2603  	   SPROC_NAME, 'No such gift certificate');
14:33:54 2604  WHEN BAD_STATUS_ID THEN
14:33:54 2605  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:54 2606  	   SPROC_NAME, 'Bad paypal status id');
14:33:54 2607  WHEN OTHERS THEN
14:33:54 2608  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 2609  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 2610  END UPDATE_GIFT_CERTIFICATE_STATUS;
14:33:54 2611  
14:33:54 2612  /******************************************************************************/
14:33:54 2613  
14:33:54 2614  PROCEDURE GET_GC_BY_PURCH_INVOICE_ID (
14:33:54 2615  	 in_invoice_id		 IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
14:33:54 2616  	 out_result_set OUT SYS_REFCURSOR
14:33:54 2617  ) AS
14:33:54 2618  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GC_BY_PURCHASE_INVOICE_ID';
14:33:54 2619  -- VARIABLES
14:33:54 2620  temp_invoice_id NUMBER;
14:33:54 2621  -- EXCEPTIONS
14:33:54 2622  BAD_INVOICE_ID EXCEPTION;
14:33:54 2623  BEGIN
14:33:54 2624  
14:33:54 2625  	 BEGIN
14:33:54 2626  	   SELECT
14:33:54 2627  	     I.ID into temp_invoice_id
14:33:54 2628  	   FROM
14:33:54 2629  	     INVOICE I
14:33:54 2630  	   WHERE
14:33:54 2631  	     I.ID = in_invoice_id;
14:33:54 2632  	   EXCEPTION
14:33:54 2633  	     WHEN NO_DATA_FOUND THEN
14:33:54 2634  	       RAISE BAD_INVOICE_ID;
14:33:54 2635  	 END;
14:33:54 2636  
14:33:54 2637  	 OPEN out_result_set FOR
14:33:54 2638  	   SELECT
14:33:54 2639  	     gc.EXPIRATION_DATE,
14:33:54 2640  	     ch.name,
14:33:54 2641  	     ch.id offer_chain_id,
14:33:54 2642  	     gc.sender_email,
14:33:54 2643  	     gc.sender_name,
14:33:54 2644  	     gc.recipient_email,
14:33:54 2645  	     gc.recipient_name,
14:33:54 2646  	     gc.purchase_date,
14:33:54 2647  	     gc.redemption_date,
14:33:54 2648  	     gc.purchaser_group_id,
14:33:54 2649  	     gc.redeemer_group_id,
14:33:54 2650  	     gc.code,
14:33:54 2651  	     gc.gift_message,
14:33:54 2652  	     gc.recipient_notify_date,
14:33:54 2653  	     gc.id
14:33:54 2654  	   FROM
14:33:54 2655  	     GIFT_CERTIFICATE gc
14:33:54 2656  	     INNER JOIN OFFER_CHAIN ch ON ch.id = gc.offer_chain_id
14:33:54 2657  	   WHERE
14:33:54 2658  	     gc.PURCHASE_INVOICE_ID = in_invoice_id;
14:33:54 2659  
14:33:54 2660  EXCEPTION
14:33:54 2661  WHEN BAD_INVOICE_ID THEN
14:33:54 2662  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 2663  	   SPROC_NAME, 'No such invoice');
14:33:54 2664  WHEN OTHERS THEN
14:33:54 2665  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 2666  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 2667  END GET_GC_BY_PURCH_INVOICE_ID;
14:33:54 2668  
14:33:54 2669  
14:33:54 2670  PROCEDURE GET_GC_ID_BY_PURCH_INVOICE_ID (
14:33:54 2671  	 in_invoice_id		 IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
14:33:54 2672  	 out_gift_certificate_id OUT GIFT_CERTIFICATE.ID%TYPE
14:33:54 2673  ) AS
14:33:54 2674  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GC_ID_BY_PURCHASE_INVOICE_ID';
14:33:54 2675  -- VARIABLES
14:33:54 2676  temp_invoice_id NUMBER;
14:33:54 2677  -- EXCEPTIONS
14:33:54 2678  BAD_INVOICE_ID EXCEPTION;
14:33:54 2679  BEGIN
14:33:54 2680  
14:33:54 2681  	 BEGIN
14:33:54 2682  	   SELECT
14:33:54 2683  	     I.ID into temp_invoice_id
14:33:54 2684  	   FROM
14:33:54 2685  	     INVOICE I
14:33:54 2686  	   WHERE
14:33:54 2687  	     I.ID = in_invoice_id;
14:33:54 2688  	   EXCEPTION
14:33:54 2689  	     WHEN NO_DATA_FOUND THEN
14:33:54 2690  	       RAISE BAD_INVOICE_ID;
14:33:54 2691  	 END;
14:33:54 2692  
14:33:54 2693  	 BEGIN
14:33:54 2694  	   SELECT
14:33:54 2695  	     GIFT_CERTIFICATE.ID into out_gift_certificate_id
14:33:54 2696  	   FROM
14:33:54 2697  	     GIFT_CERTIFICATE
14:33:54 2698  	   WHERE
14:33:54 2699  	     GIFT_CERTIFICATE.PURCHASE_INVOICE_ID = in_invoice_id;
14:33:54 2700  	   EXCEPTION
14:33:54 2701  	     WHEN NO_DATA_FOUND THEN
14:33:54 2702  	       out_gift_certificate_id := NULL;
14:33:54 2703  	 END;
14:33:54 2704  
14:33:54 2705  EXCEPTION
14:33:54 2706  WHEN BAD_INVOICE_ID THEN
14:33:54 2707  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 2708  	   SPROC_NAME, 'No such invoice');
14:33:54 2709  WHEN OTHERS THEN
14:33:54 2710  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 2711  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 2712  END GET_GC_ID_BY_PURCH_INVOICE_ID;
14:33:54 2713  
14:33:54 2714  /******************************************************************************/
14:33:54 2715  
14:33:54 2716  PROCEDURE SWITCH_FINANCIAL_INSTRUMENT (
14:33:54 2717  	 in_old_fin_instrument_id   IN NUMBER,
14:33:54 2718  	 in_old_fin_instrument_type IN NUMBER,
14:33:54 2719  	 in_new_fin_instrument_id   IN NUMBER,
14:33:54 2720  	 in_new_fin_instrument_type IN NUMBER,
14:33:54 2721  	 in_updated_by		    IN VARCHAR2
14:33:54 2722  ) AS
14:33:54 2723  SPROC_NAME CONSTANT VARCHAR2(27) := 'SWITCH_FINANCIAL_INSTRUMENT';
14:33:54 2724  -- variables
14:33:54 2725  temp_out_transaction_id NUMBER;
14:33:54 2726  temp_out_charge_id      NUMBER;
14:33:54 2727  var_accounts_count      NUMBER;
14:33:54 2728  var_transaction_type_old  "TRANSACTION".TRANSACTION_TYPE_CODE%TYPE;
14:33:54 2729  var_transaction_type	 "TRANSACTION".TRANSACTION_TYPE_CODE%TYPE;
14:33:54 2730  -- EXCEPTIONS
14:33:54 2731  BAD_OLD_CC   EXCEPTION;
14:33:54 2732  BAD_OLD_PP   EXCEPTION;
14:33:54 2733  BAD_OLD_TYPE EXCEPTION;
14:33:54 2734  BAD_NEW_CC   EXCEPTION;
14:33:54 2735  BAD_NEW_PP   EXCEPTION;
14:33:54 2736  BAD_NEW_TYPE EXCEPTION;
14:33:54 2737  DIFFERENT_OWNERS EXCEPTION;
14:33:54 2738  BEGIN
14:33:54 2739  
14:33:54 2740  	 IF in_old_fin_instrument_type = GLOBAL_ENUMS_V22.INSTRUMENT_CREDIT_CARD THEN
14:33:54 2741  	   IF PROCS_FIN_INSTRUMENTS_V22.IS_CREDIT_CARD_EXISTS(in_old_fin_instrument_id) = GLOBAL_CONSTANTS_V22.FALSE THEN
14:33:54 2742  	     -- throw exception: bad old credit card
14:33:54 2743  	     RAISE BAD_OLD_CC;
14:33:54 2744  	   END IF;
14:33:54 2745  	 ELSIF in_old_fin_instrument_type = GLOBAL_ENUMS_V22.INSTRUMENT_PAYPAL THEN
14:33:54 2746  	   IF PROCS_FIN_INSTRUMENTS_V22.IS_PAYPAL_EXISTS(in_old_fin_instrument_id) = GLOBAL_CONSTANTS_V22.FALSE THEN
14:33:54 2747  	     -- throw exception: bad old paypal
14:33:54 2748  	     RAISE BAD_OLD_PP;
14:33:54 2749  	   END IF;
14:33:54 2750  	 ELSE
14:33:54 2751  	   -- throw exception: bad instrument type
14:33:54 2752  	   RAISE BAD_OLD_TYPE;
14:33:54 2753  	 END IF;
14:33:54 2754  
14:33:54 2755  	 IF in_new_fin_instrument_type = GLOBAL_ENUMS_V22.INSTRUMENT_CREDIT_CARD THEN
14:33:54 2756  	   IF PROCS_FIN_INSTRUMENTS_V22.IS_CREDIT_CARD_EXISTS(in_new_fin_instrument_id) = GLOBAL_CONSTANTS_V22.FALSE THEN
14:33:54 2757  	     -- throw exception: bad new credit card
14:33:54 2758  	     RAISE BAD_NEW_CC;
14:33:54 2759  	   END IF;
14:33:54 2760  	 ELSIF in_new_fin_instrument_type = GLOBAL_ENUMS_V22.INSTRUMENT_PAYPAL THEN
14:33:54 2761  	   IF PROCS_FIN_INSTRUMENTS_V22.IS_PAYPAL_EXISTS(in_new_fin_instrument_id) = GLOBAL_CONSTANTS_V22.FALSE THEN
14:33:54 2762  	     -- throw exception: bad new paypal
14:33:54 2763  	     RAISE BAD_NEW_PP;
14:33:54 2764  	   END IF;
14:33:54 2765  	 ELSE
14:33:54 2766  	   -- throw exception: bad new instrument type
14:33:54 2767  	   RAISE BAD_NEW_TYPE;
14:33:54 2768  	 END IF;
14:33:54 2769  
14:33:54 2770  	 -- Check that owner of both instruments - same man
14:33:54 2771  
14:33:54 2772  	 SELECT count(1) into var_accounts_count FROM (
14:33:54 2773  	   SELECT
14:33:54 2774  	     CC.ACCOUNT_ID
14:33:54 2775  	   FROM
14:33:54 2776  	     CREDIT_CARD CC
14:33:54 2777  	   WHERE
14:33:54 2778  	     (
14:33:54 2779  	       CC.ID = in_old_fin_instrument_id
14:33:54 2780  	       AND in_old_fin_instrument_type = GLOBAL_ENUMS_V22.INSTRUMENT_CREDIT_CARD
14:33:54 2781  	     )
14:33:54 2782  	     OR
14:33:54 2783  	     (
14:33:54 2784  	       CC.ID = in_new_fin_instrument_id
14:33:54 2785  	       AND in_new_fin_instrument_type = GLOBAL_ENUMS_V22.INSTRUMENT_CREDIT_CARD
14:33:54 2786  	     )
14:33:54 2787  	   UNION
14:33:54 2788  	   SELECT
14:33:54 2789  	     PP.ACCOUNT_ID
14:33:54 2790  	   FROM
14:33:54 2791  	     PAYPAL PP
14:33:54 2792  	   WHERE
14:33:54 2793  	     (
14:33:54 2794  	       PP.ID = in_old_fin_instrument_id
14:33:54 2795  	       AND in_old_fin_instrument_type = GLOBAL_ENUMS_V22.INSTRUMENT_PAYPAL
14:33:54 2796  	     )
14:33:54 2797  	     OR
14:33:54 2798  	     (
14:33:54 2799  	       PP.ID = in_new_fin_instrument_id
14:33:54 2800  	       AND in_new_fin_instrument_type = GLOBAL_ENUMS_V22.INSTRUMENT_PAYPAL
14:33:54 2801  	     )
14:33:54 2802  	 )
14:33:54 2803  	 WHERE
14:33:54 2804  	   account_id IS NOT NULL;
14:33:54 2805  
14:33:54 2806  	 IF (var_accounts_count > 1) THEN
14:33:54 2807  	   -- Throw exception: different owners of instruments
14:33:54 2808  	   RAISE DIFFERENT_OWNERS;
14:33:54 2809  	 END IF;
14:33:54 2810  
14:33:54 2811  	 FOR f_sub IN (
14:33:54 2812  	   select
14:33:54 2813  	     s.id
14:33:54 2814  	   FROM
14:33:54 2815  	     subscription s
14:33:54 2816  	   WHERE
14:33:54 2817  	     (
14:33:54 2818  	       s.subscription_status_id = GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE OR
14:33:54 2819  	       s.subscription_status_id = GLOBAL_STATUSES_V22.SUBSCRIPTION_SUSPENDED OR
14:33:54 2820  	       s.subscription_status_id = GLOBAL_STATUSES_V22.SUBSCRIPTION_IN_GRACE_PERIOD
14:33:54 2821  	     )
14:33:54 2822  	     AND
14:33:54 2823  	     s.instrument_type_id = in_old_fin_instrument_type AND
14:33:54 2824  	     s.instrument_id = in_old_fin_instrument_id
14:33:54 2825  	 ) LOOP
14:33:54 2826  	   PROCS_SUBSCRIPTION_CRU_V22.UPDATE_SUBSCRIPTION(
14:33:54 2827  	     in_subscription_id => f_sub.id,
14:33:54 2828  	     in_instrument_type_id => in_new_fin_instrument_type,
14:33:54 2829  	     in_instrument_id => in_new_fin_instrument_id,
14:33:54 2830  	     in_updated_by => in_updated_by
14:33:54 2831  	   );
14:33:54 2832  	 END LOOP;
14:33:54 2833  
14:33:54 2834  	 FOR f_open_charge IN (
14:33:54 2835  	   select
14:33:54 2836  	     ch.id,
14:33:54 2837  	     ch.invoice_id,
14:33:54 2838  	     ch.transaction_id,
14:33:54 2839  	     ch.charge_amount
14:33:54 2840  	   FROM
14:33:54 2841  	     charge ch
14:33:54 2842  	   WHERE
14:33:54 2843  	     ch.instrument_type_id = in_old_fin_instrument_type
14:33:54 2844  	     AND ch.instrument_id = in_old_fin_instrument_id
14:33:54 2845  	     AND ch.charge_status_id = GLOBAL_STATUSES_V22.CHARGE_OPENED
14:33:54 2846  	 ) LOOP
14:33:54 2847  
14:33:54 2848  	   FOR f_pending_transaction IN (
14:33:54 2849  	     select
14:33:54 2850  	       id, transaction_amount, order_id, is_refund
14:33:54 2851  	     from
14:33:54 2852  	       transaction
14:33:54 2853  	     where
14:33:54 2854  	       id = f_open_charge.transaction_id
14:33:54 2855  	       and transaction_status_id = GLOBAL_STATUSES_V22.TRANSACTION_PENDING
14:33:54 2856  	   ) LOOP
14:33:54 2857  
14:33:54 2858  	     SELECT
14:33:54 2859  	       DECODE(TRANSACTION_TYPE_CODE, 'RECURRING_BILLING', 'RECURRING_BILLING_USER_UPDATE',
14:33:54 2860  					     'GRACE_PERIOD_FINAL', 'GRACE_PERIOD_USER_UPDATE',
14:33:54 2861  					     TRANSACTION_TYPE_CODE)
14:33:54 2862  	     INTO var_transaction_type
14:33:54 2863  	     FROM
14:33:54 2864  	       Transaction
14:33:54 2865  	     WHERE
14:33:54 2866  	       id = f_pending_transaction.id
14:33:54 2867  	       AND ROWNUM <= 1;
14:33:54 2868  
14:33:54 2869  	     PROCS_TRANSACTION_V22.CREATE_TRANSACTION (
14:33:54 2870  	       in_transaction_id => NULL,
14:33:54 2871  	       in_status_id  => GLOBAL_STATUSES_V22.TRANSACTION_PENDING,
14:33:54 2872  	       in_amount     => f_pending_transaction.transaction_amount,
14:33:54 2873  	       in_created_by => in_updated_by,
14:33:54 2874  	       in_order_id   => null,
14:33:54 2875  	       in_is_refund  => f_pending_transaction.is_refund,
14:33:54 2876  	       in_transaction_type_code => var_transaction_type,
14:33:54 2877  	       out_transaction_id => temp_out_transaction_id
14:33:54 2878  	     );
14:33:54 2879  
14:33:54 2880  	     PROCS_TRANSACTION_V22.UPDATE_TRANSACTION_STATUS(
14:33:54 2881  	       in_transaction_id => f_pending_transaction.id,
14:33:54 2882  	       in_updated_by	 => in_updated_by,
14:33:54 2883  	       in_transaction_status_id  => GLOBAL_STATUSES_V22.TRANSACTION_CLOSED
14:33:54 2884  	     );
14:33:54 2885  
14:33:54 2886  	     -- Create new charge
14:33:54 2887  	     PROCS_CHARGE_V22.CREATE_CHARGE (
14:33:54 2888  	       in_invoice_id	     => f_open_charge.invoice_id,
14:33:54 2889  	       in_transaction_id     => temp_out_transaction_id,
14:33:54 2890  	       in_instrument_type_id => in_new_fin_instrument_type,
14:33:54 2891  	       in_instrument_id      => in_new_fin_instrument_id,
14:33:54 2892  	       in_charge_amount      => f_open_charge.charge_amount,
14:33:54 2893  	       in_created_by	     => in_updated_by,
14:33:54 2894  	       in_charge_status_id   => GLOBAL_STATUSES_V22.CHARGE_OPENED,
14:33:54 2895  	       out_charge_id	     => temp_out_charge_id
14:33:54 2896  	     );
14:33:54 2897  	     -- Cancel old charge
14:33:54 2898  	     PROCS_CHARGE_V22.UPDATE_CHARGE_STATUS(
14:33:54 2899  	       in_charge_id	   => f_open_charge.id,
14:33:54 2900  	       in_updated_by	   => in_updated_by,
14:33:54 2901  	       in_charge_status_id => GLOBAL_STATUSES_V22.CHARGE_CANCELED
14:33:54 2902  	     );
14:33:54 2903  
14:33:54 2904  	     PROCS_ADJUSTMENTS_V22.UPDATE_INVOICE_ADJUSTMENT(
14:33:54 2905  	       IN_INVOICE_ID => f_open_charge.invoice_id,
14:33:54 2906  	       IN_ORIGINAL_CHARGE_ID => f_open_charge.id,
14:33:54 2907  	       IN_CHARGE_ID => temp_out_charge_id,
14:33:54 2908  	       IN_UPDATED_BY => in_updated_by
14:33:54 2909  	     );
14:33:54 2910  
14:33:54 2911  	   END LOOP;
14:33:54 2912  	 END LOOP;
14:33:54 2913  
14:33:54 2914  EXCEPTION
14:33:54 2915  WHEN BAD_OLD_CC THEN
14:33:54 2916  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 2917  	   SPROC_NAME, 'Trying to switch from non existing credit card');
14:33:54 2918  WHEN BAD_OLD_PP THEN
14:33:54 2919  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 2920  	   SPROC_NAME, 'Trying to switch from non existing paypal');
14:33:54 2921  WHEN BAD_OLD_TYPE THEN
14:33:54 2922  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 2923  	   SPROC_NAME, 'Trying to switch from unknown/unsupported financial instrument');
14:33:54 2924  WHEN BAD_NEW_CC THEN
14:33:54 2925  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 2926  	   SPROC_NAME, 'Trying to switch to non existing credit card');
14:33:54 2927  WHEN BAD_NEW_PP THEN
14:33:54 2928  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 2929  	   SPROC_NAME, 'Trying to switch to non existing paypal');
14:33:54 2930  WHEN BAD_NEW_TYPE THEN
14:33:54 2931  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 2932  	   SPROC_NAME, 'Trying to switch to unknown/unsupported financial instrument');
14:33:54 2933  WHEN DIFFERENT_OWNERS THEN
14:33:54 2934  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:54 2935  	   SPROC_NAME, 'Could not switch instrument, because owners are different');
14:33:54 2936  WHEN OTHERS THEN
14:33:54 2937  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 2938  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 2939  END SWITCH_FINANCIAL_INSTRUMENT;
14:33:54 2940  
14:33:54 2941  /******************************************************************************/
14:33:54 2942  
14:33:54 2943  /*
14:33:54 2944  	   Note, this returns paypal records which are in the given window of time
14:33:54 2945  	   based on their creation date, not their expiration date, because we've seen
14:33:54 2946  	   suspicious values in the data for expiration dates. The java layer should
14:33:54 2947  	   inspect the expiration dates and decide whether or not to act on the data.
14:33:54 2948  */
14:33:54 2949  
14:33:54 2950  PROCEDURE GET_EXPIRING_PAYPAL (
14:33:54 2951  	 in_expire_window_days	 IN NUMBER,
14:33:54 2952  	 in_creation_limit_days  IN NUMBER,
14:33:54 2953  	 in_retry_throttle_name  IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE,
14:33:54 2954  	 out_result_set 	 OUT SYS_REFCURSOR
14:33:54 2955  ) AS
14:33:54 2956  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_EXPIRING_PAYPAL';
14:33:54 2957  -- If creation date is later than this, return the record
14:33:54 2958  var_end_creation DATE := SYSDATE - in_creation_limit_days + in_expire_window_days;
14:33:54 2959  var_rows_to_return CONSTANT NUMBER := 300;
14:33:54 2960  BEGIN
14:33:54 2961  	 OPEN out_result_set FOR
14:33:54 2962  	 SELECT * FROM (
14:33:54 2963  	   SELECT
14:33:54 2964  	       ac.group_id	   AS group_id,
14:33:54 2965  	       pp.id		   AS paypal_id,
14:33:54 2966  	       sb.id		   AS subscription_id,
14:33:54 2967  	       pp.create_date	   AS creation_date,
14:33:54 2968  	       pp.expiration_date  AS expiration_date
14:33:54 2969  	   FROM paypal pp
14:33:54 2970  	   INNER JOIN subscription sb
14:33:54 2971  	   ON pp.account_id = sb.account_id
14:33:54 2972  	   INNER JOIN account ac
14:33:54 2973  	   ON pp.account_id = ac.id
14:33:54 2974  	   WHERE pp.paypal_status_id = GLOBAL_STATUSES_V22.PAYPAL_ACTIVE
14:33:54 2975  	     AND sb.instrument_type_id = GLOBAL_ENUMS_V22.INSTRUMENT_PAYPAL
14:33:54 2976  	     AND sb.subscription_status_id IN (GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE,
14:33:54 2977  					       GLOBAL_STATUSES_V22.SUBSCRIPTION_IN_GRACE_PERIOD)
14:33:54 2978  	     AND sb.instrument_id = pp.id
14:33:54 2979  	     AND pp.create_date <= var_end_creation
14:33:54 2980  	     AND NOT EXISTS(
14:33:54 2981  	       SELECT NULL
14:33:54 2982  	       FROM process_retry_throttle rt
14:33:54 2983  	       WHERE rt.process_name = in_retry_throttle_name
14:33:54 2984  		 AND rt.generic_id = pp.id
14:33:54 2985  	     )
14:33:54 2986  	     AND ROWNUM <= 10 * var_rows_to_return
14:33:54 2987  	   ORDER BY dbms_random.value
14:33:54 2988  	 )
14:33:54 2989  	 WHERE ROWNUM <= var_rows_to_return;
14:33:54 2990  END GET_EXPIRING_PAYPAL;
14:33:54 2991  
14:33:54 2992  /******************************************************************************/
14:33:54 2993  
14:33:54 2994  END PROCS_FIN_INSTRUMENTS_V22;
14:33:54 2995  .
14:33:54 SQL> /

Package body created.

Elapsed: 00:00:00.24
14:33:54 SQL> 
14:33:54 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_GROUP_ACCOUNT_V22" AS
14:33:54   2  
14:33:54   3  PROCEDURE UPDATE_SS_NEED_ENTITLEMENTS (
14:33:54   4  	in_sub_share_id      IN SUBSCRIPTION_SHARE.ID%TYPE,
14:33:54   5  	in_need_entitlements IN SUBSCRIPTION_SHARE.NEEDS_ENTITLEMENTS%TYPE,
14:33:54   6  	in_updater	     IN SUBSCRIPTION_SHARE.UPDATED_BY%TYPE
14:33:54   7  ) AS
14:33:54   8  SPROC_NAME CONSTANT VARCHAR2(32) := 'UPDATE_SS_NEED_ENTITLEMENTS';
14:33:54   9  BEGIN
14:33:54  10  	CORE_OWNER.PROCS_GROUP_ACCOUNT_CRU_V22.UPDATE_SUBSCRIPTION_SHARE (
14:33:54  11  	  in_id 		=> in_sub_share_id,
14:33:54  12  	  in_needs_entitlements => in_need_entitlements,
14:33:54  13  	  in_updated_by 	=> in_updater
14:33:54  14  	);
14:33:54  15  END UPDATE_SS_NEED_ENTITLEMENTS;
14:33:54  16  
14:33:54  17  PROCEDURE SUB_EXPIRES_NEED_ENTITLEMENTS (
14:33:54  18  	out_result_set OUT SYS_REFCURSOR
14:33:54  19  ) AS
14:33:54  20  SPROC_NAME CONSTANT VARCHAR2(32) := 'SUB_EXPIRES_NEED_ENTITLEMENTS';
14:33:54  21  BEGIN
14:33:54  22  	OPEN out_result_set FOR
14:33:54  23  	SELECT * FROM (
14:33:54  24  	  SELECT DISTINCT
14:33:54  25  	    ga.Subscription_Id,
14:33:54  26  	    A.Group_Id Borrower_Group_Id,
14:33:54  27  	    L.Offer_Id,
14:33:54  28  	    ss.id Subscription_Share_id
14:33:54  29  	  FROM
14:33:54  30  	    Subscription_Share Ss,
14:33:54  31  	    Group_Account Ga,
14:33:54  32  	    Account A,
14:33:54  33  	    License l
14:33:54  34  	  WHERE
14:33:54  35  	    Ss.Group_Account_Id        = ga.id
14:33:54  36  	    AND Ss.Needs_Entitlements  = GLOBAL_CONSTANTS_V22.TRUE
14:33:54  37  	    AND Ss.Borrower_Account_Id = A.Id
14:33:54  38  	    AND L.Subscription_Id      = Ga.Subscription_Id
14:33:54  39  	    AND ROWNUM <= 5000
14:33:54  40  	  ORDER BY dbms_random.value
14:33:54  41  ) WHERE
14:33:54  42  	ROWNUM <= 1000;
14:33:54  43  END SUB_EXPIRES_NEED_ENTITLEMENTS;
14:33:54  44  
14:33:54  45  PROCEDURE EXPIRE_SUB_SHARE(
14:33:54  46  	in_sub_share_id IN SUBSCRIPTION_SHARE.ID%TYPE,
14:33:54  47  	in_updater	IN SUBSCRIPTION_SHARE.UPDATED_BY%TYPE
14:33:54  48  ) AS
14:33:54  49  SPROC_NAME CONSTANT VARCHAR2(32) := 'EXPIRE_SUB_SHARE';
14:33:54  50  BEGIN
14:33:54  51  	CORE_OWNER.PROCS_GROUP_ACCOUNT_CRU_V22.UPDATE_SUBSCRIPTION_SHARE (
14:33:54  52  	  in_id 	=> in_sub_share_id,
14:33:54  53  	  in_end_date	=> SYSDATE,
14:33:54  54  	  in_updated_by => in_updater,
14:33:54  55  	  in_needs_entitlements => 1
14:33:54  56  	);
14:33:54  57  END EXPIRE_SUB_SHARE;
14:33:54  58  
14:33:54  59  PROCEDURE EXPIRE_ALL_SHARES (
14:33:54  60  	in_group_account_id IN SUBSCRIPTION_SHARE.GROUP_ACCOUNT_ID%TYPE,
14:33:54  61  	in_updated_by	    IN SUBSCRIPTION_SHARE.UPDATED_BY%TYPE
14:33:54  62  ) AS
14:33:54  63  SPROC_NAME CONSTANT VARCHAR2(28) := 'EXPIRE_ALL_SHARES';
14:33:54  64  BEGIN
14:33:54  65  	UPDATE SUBSCRIPTION_SHARE SET
14:33:54  66  	  END_DATE = SYSDATE,
14:33:54  67  	  UPDATED_BY = in_updated_by,
14:33:54  68  	  UPDATE_DATE = SYSDATE
14:33:54  69  	WHERE
14:33:54  70  	  GROUP_ACCOUNT_ID = in_group_account_id
14:33:54  71  	AND
14:33:54  72  	  SYSDATE < END_DATE;
14:33:54  73  EXCEPTION
14:33:54  74  	WHEN OTHERS THEN
14:33:54  75  	  PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54  76  	      SPROC_NAME, 'Unknown error while expiring subscription shares', SQLERRM);
14:33:54  77  END EXPIRE_ALL_SHARES;
14:33:54  78  
14:33:54  79  PROCEDURE SUB_SHARE_BY_GROUP_ID (
14:33:54  80  	in_group_id	 IN  ACCOUNT.GROUP_ID%TYPE,
14:33:54  81  	in_start	 IN  NUMBER,
14:33:54  82  	in_end		 IN  NUMBER,
14:33:54  83  	in_expired	 IN  NUMBER,
14:33:54  84  	out_result_set	 OUT SYS_REFCURSOR,
14:33:54  85  	out_shares_count OUT NUMBER
14:33:54  86  ) AS
14:33:54  87  SPROC_NAME CONSTANT VARCHAR2(32) := 'SUB_SHARE_BY_GROUP_ID';
14:33:54  88  range_diff NUMBER := 0;
14:33:54  89  upper_bond_diff NUMBER := 0;
14:33:54  90  l_start NUMBER := 0;
14:33:54  91  l_end   NUMBER := 0;
14:33:54  92  BEGIN
14:33:54  93  	--Normalize the end points [START]
14:33:54  94  	IF (in_start IS NULL OR in_start < 0) Then
14:33:54  95  	  l_start := 0;
14:33:54  96  	ELSE
14:33:54  97  	  l_start := in_start;
14:33:54  98  	END IF;
14:33:54  99  
14:33:54 100  	IF (in_end IS NULL) Then
14:33:54 101  	  l_end := 11;
14:33:54 102  	ELSE
14:33:54 103  	  l_end := in_end;
14:33:54 104  	END IF;
14:33:54 105  
14:33:54 106  	l_start := l_start + 1;
14:33:54 107  	l_end	:= l_end   + 1;
14:33:54 108  
14:33:54 109  	range_diff := l_end - l_start;
14:33:54 110  	upper_bond_diff :=  range_diff - GLOBAL_CONSTANTS_V22.MAX_RETURN_COUNT;
14:33:54 111  
14:33:54 112  	IF (upper_bond_diff > 0) Then
14:33:54 113  	  l_end := l_end - upper_bond_diff;
14:33:54 114  	END IF;
14:33:54 115  	--Normalize the end points [END]
14:33:54 116  
14:33:54 117  	BEGIN
14:33:54 118  	  SELECT
14:33:54 119  	    COUNT(1) INTO out_shares_count
14:33:54 120  	  FROM
14:33:54 121  	    GROUP_ACCOUNT ga,
14:33:54 122  	    SUBSCRIPTION_SHARE ss,
14:33:54 123  	    ACCOUNT a
14:33:54 124  	  WHERE
14:33:54 125  	    a.GROUP_ID		= in_group_id AND
14:33:54 126  	    a.Id		= ss.borrower_account_id And
14:33:54 127  	    ss.GROUP_ACCOUNT_ID = ga.ID;
14:33:54 128  	END;
14:33:54 129  
14:33:54 130  	IF in_expired > 0 THEN
14:33:54 131  	BEGIN
14:33:54 132  	    OPEN out_result_set FOR
14:33:54 133  	    SELECT
14:33:54 134  	      *
14:33:54 135  	    FROM
14:33:54 136  	      (SELECT rownum rnum, q.*
14:33:54 137  	       FROM
14:33:54 138  		(SELECT
14:33:54 139  		   ga.SUBSCRIPTION_ID,
14:33:54 140  		   ss.START_DATE,
14:33:54 141  		   ss.END_DATE,
14:33:54 142  		   a2.GROUP_ID AS PARENT_GROUP_ID
14:33:54 143  		 FROM
14:33:54 144  		   GROUP_ACCOUNT ga,
14:33:54 145  		   SUBSCRIPTION_SHARE ss,
14:33:54 146  		   ACCOUNT a,
14:33:54 147  		   SUBSCRIPTION s,
14:33:54 148  		   ACCOUNT a2
14:33:54 149  		 WHERE
14:33:54 150  		   a.GROUP_ID	       = in_group_id AND
14:33:54 151  		   a.ID 	       = ss.BORROWER_ACCOUNT_ID AND
14:33:54 152  		   ss.GROUP_ACCOUNT_ID = ga.ID	AND
14:33:54 153  		   ga.SUBSCRIPTION_ID  = s.ID AND
14:33:54 154  		   s.ACCOUNT_ID        = a2.ID
14:33:54 155  		) Q
14:33:54 156  	      WHERE rownum <= l_end)
14:33:54 157  	    WHERE rnum >= l_Start;
14:33:54 158  	END;
14:33:54 159  	ELSE
14:33:54 160  	BEGIN
14:33:54 161  	    OPEN out_result_set FOR
14:33:54 162  	    SELECT
14:33:54 163  	      *
14:33:54 164  	    FROM
14:33:54 165  	      (SELECT rownum rnum, q.*
14:33:54 166  	       FROM
14:33:54 167  		(SELECT
14:33:54 168  		   ga.SUBSCRIPTION_ID,
14:33:54 169  		   ss.START_DATE,
14:33:54 170  		   ss.END_DATE,
14:33:54 171  		   a2.GROUP_ID AS PARENT_GROUP_ID
14:33:54 172  		 FROM
14:33:54 173  		   GROUP_ACCOUNT ga,
14:33:54 174  		   SUBSCRIPTION_SHARE ss,
14:33:54 175  		   ACCOUNT a,
14:33:54 176  		   SUBSCRIPTION s,
14:33:54 177  		   ACCOUNT a2
14:33:54 178  		 WHERE
14:33:54 179  		   a.GROUP_ID	       = in_group_id AND
14:33:54 180  		   a.ID 	       = ss.BORROWER_ACCOUNT_ID AND
14:33:54 181  		   SYSDATE BETWEEN START_DATE AND END_DATE AND
14:33:54 182  		   ss.GROUP_ACCOUNT_ID = ga.ID AND
14:33:54 183  		   ga.SUBSCRIPTION_ID  = s.ID  AND
14:33:54 184  		   s.ACCOUNT_ID        = a2.ID
14:33:54 185  		) Q
14:33:54 186  	      WHERE rownum <= l_end)
14:33:54 187  	    WHERE rnum >= l_start;
14:33:54 188  	  END;
14:33:54 189  	END IF;
14:33:54 190  EXCEPTION
14:33:54 191  WHEN NO_DATA_FOUND THEN
14:33:54 192  	NULL;
14:33:54 193  WHEN OTHERS THEN
14:33:54 194  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 195  	  SPROC_NAME, 'Unknow error while retrieving subscription share info by group id', SQLERRM);
14:33:54 196  END SUB_SHARE_BY_GROUP_ID;
14:33:54 197  
14:33:54 198  PROCEDURE IS_VALID_IP_ADDRESS (
14:33:54 199  	in_group_account_id IN GROUP_ACCOUNT_IP_RANGE.GROUP_ACCOUNT_ID%TYPE,
14:33:54 200  	in_ip_low IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_LOW%TYPE,
14:33:54 201  	in_ip_high IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_HIGH%TYPE,
14:33:54 202  	out_is_valid	    OUT NUMBER
14:33:54 203  ) AS
14:33:54 204  SPROC_NAME CONSTANT VARCHAR2(32) := 'IS_VALID_IP_ADDRESS';
14:33:54 205  BEGIN
14:33:54 206  	SELECT
14:33:54 207  	  COUNT(1) INTO out_is_valid
14:33:54 208  	FROM
14:33:54 209  	  GROUP_ACCOUNT_IP_RANGE,
14:33:54 210  	  GROUP_ACCOUNT,
14:33:54 211  	  SUBSCRIPTION,
14:33:54 212  	  OFFER_CHAIN
14:33:54 213  	WHERE
14:33:54 214  	  GROUP_ACCOUNT.ID = GROUP_ACCOUNT_ID AND
14:33:54 215  	  GROUP_ACCOUNT.SUBSCRIPTION_ID = SUBSCRIPTION.ID AND
14:33:54 216  	  SUBSCRIPTION.OFFER_CHAIN_ID = OFFER_CHAIN.ID AND
14:33:54 217  	  OFFER_CHAIN.GROUP_ACCOUNT_TYPE_ID = 'GL' AND
14:33:54 218  	 GROUP_ACCOUNT_ID = in_group_account_id AND
14:33:54 219  	 (
14:33:54 220  	  (in_ip_high > minimum_ip_high and in_ip_high < maximum_ip_high) or
14:33:54 221  	  (in_ip_high = minimum_ip_high and (in_ip_low >= minimum_ip_low and in_ip_low <= maximum_ip_low)) or
14:33:54 222  	  (in_ip_high = maximum_ip_high and (in_ip_low >= minimum_ip_low and in_ip_low <= maximum_ip_low))
14:33:54 223  	 ) AND
14:33:54 224  	 GROUP_ACC_IP_RNG_STATUS_ID = GLOBAL_STATUSES_V22.GROUP_ACC_IP_RNG_ACTIVE;
14:33:54 225  EXCEPTION
14:33:54 226  WHEN OTHERS THEN
14:33:54 227  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 228  	  SPROC_NAME, 'Error while checking IP', SQLERRM);
14:33:54 229  END IS_VALID_IP_ADDRESS;
14:33:54 230  
14:33:54 231  PROCEDURE IS_VALID_EMAIL_DOMAIN (
14:33:54 232  	in_group_account_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
14:33:54 233  	in_email_domain     IN GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE,
14:33:54 234  	out_is_valid	    OUT NUMBER
14:33:54 235  ) AS
14:33:54 236  SPROC_NAME CONSTANT VARCHAR2(32) := 'IS_VALID_EMAIL_DOMAIN';
14:33:54 237  var_second_level_domain GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE;
14:33:54 238  var_third_level_domain GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE;
14:33:54 239  BEGIN
14:33:54 240  	var_second_level_domain := REGEXP_REPLACE(in_email_domain, '.*?([^\.]+\.[^\.]+)$', '\1');
14:33:54 241  	var_third_level_domain := REGEXP_REPLACE(in_email_domain, '.*?(([^\.]+\.){2}[^\.]+)$', '\1');
14:33:54 242  
14:33:54 243  	SELECT
14:33:54 244  	  COUNT(1) INTO out_is_valid
14:33:54 245  	FROM
14:33:54 246  	  GROUP_ACCOUNT_EMAIL_DOMAIN gaed,
14:33:54 247  	  GROUP_ACCOUNT ga,
14:33:54 248  	  SUBSCRIPTION s,
14:33:54 249  	  OFFER_CHAIN oc
14:33:54 250  	WHERE
14:33:54 251  	  ga.ID = gaed.GROUP_ACCOUNT_ID AND
14:33:54 252  	  ga.SUBSCRIPTION_ID = s.ID AND
14:33:54 253  	  s.OFFER_CHAIN_ID = oc.ID AND
14:33:54 254  	  oc.GROUP_ACCOUNT_TYPE_ID IN ('GL', 'KL') AND
14:33:54 255  	  gaed.GROUP_ACCOUNT_ID = in_group_account_id AND
14:33:54 256  	  (gaed.EMAIL_DOMAIN = var_third_level_domain OR gaed.EMAIL_DOMAIN = var_second_level_domain) AND
14:33:54 257  	  gaed.IS_ACTIVE = 1;
14:33:54 258  EXCEPTION
14:33:54 259  WHEN OTHERS THEN
14:33:54 260  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 261  	  SPROC_NAME, 'Error while checking email domain', SQLERRM);
14:33:54 262  END IS_VALID_EMAIL_DOMAIN;
14:33:54 263  
14:33:54 264  PROCEDURE GET_SUBSCRIPTION_SHARE (
14:33:54 265  	in_group_account_id    IN SUBSCRIPTION_SHARE.GROUP_ACCOUNT_ID%TYPE,
14:33:54 266  	In_Borrower_Account_Id In SUBSCRIPTION_SHARE.BORROWER_ACCOUNT_ID%Type,
14:33:54 267  	out_Result_Set	       OUT Sys_Refcursor
14:33:54 268  ) AS
14:33:54 269  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_SUBSCRIPTION_SHARE';
14:33:54 270  BEGIN
14:33:54 271  	BEGIN
14:33:54 272  	   OPEN out_result_set FOR
14:33:54 273  	   SELECT
14:33:54 274  	      ss.ID,
14:33:54 275  	      ss.GROUP_ACCOUNT_ID,
14:33:54 276  	      ss.BORROWER_ACCOUNT_ID,
14:33:54 277  	      ss.IP_ADDRESS,
14:33:54 278  	      ss.START_DATE,
14:33:54 279  	      ss.END_DATE,
14:33:54 280  	      ss.CREATED_BY,
14:33:54 281  	      ss.CREATE_DATE,
14:33:54 282  	      ss.UPDATED_BY,
14:33:54 283  	      ss.UPDATE_DATE,
14:33:54 284  	      a.GROUP_ID AS BORROWER_GROUP_ID
14:33:54 285  	   FROM
14:33:54 286  	     SUBSCRIPTION_SHARE ss,
14:33:54 287  	     ACCOUNT a
14:33:54 288  	   WHERE
14:33:54 289  	     ss.GROUP_ACCOUNT_ID    = in_group_account_id AND
14:33:54 290  	     ss.BORROWER_ACCOUNT_ID = in_borrower_account_id AND
14:33:54 291  	     SYSDATE BETWEEN ss.START_DATE AND END_DATE AND
14:33:54 292  	     ss.BORROWER_ACCOUNT_ID  = a.ID;
14:33:54 293  	END;
14:33:54 294  EXCEPTION
14:33:54 295  WHEN OTHERS THEN
14:33:54 296  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 297  	  Sproc_Name, 'Error while getting subscription share', Sqlerrm);
14:33:54 298  END GET_SUBSCRIPTION_SHARE;
14:33:54 299  
14:33:54 300  PROCEDURE GET_GROUP_ACCOUNT_BY_SUB_ID (
14:33:54 301  	in_subscription_id IN Group_Account.SUBSCRIPTION_ID%TYPE,
14:33:54 302  	out_result_set	   OUT SYS_REFCURSOR
14:33:54 303  ) As
14:33:54 304  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GROUP_ACCOUNT_BY_SUB_ID';
14:33:54 305  BEGIN
14:33:54 306  OPEN out_result_set FOR
14:33:54 307  	SELECT
14:33:54 308  	  ID,
14:33:54 309  	  SUBSCRIPTION_ID,
14:33:54 310  	  GROUP_NAME,
14:33:54 311  	  FIRST_NAME,
14:33:54 312  	  LAST_NAME,
14:33:54 313  	  EMAIL,
14:33:54 314  	  PHONE,
14:33:54 315  	  ORGANIZATION_TYPE,
14:33:54 316  	  SEATS,
14:33:54 317  	  SEAT_TTL_IN_HOURS,
14:33:54 318  	  CREATE_DATE,
14:33:54 319  	  CREATED_BY,
14:33:54 320  	  UPDATE_DATE,
14:33:54 321  	  UPDATED_BY
14:33:54 322  	FROM
14:33:54 323  	  GROUP_ACCOUNT
14:33:54 324  	Where
14:33:54 325  	  Subscription_Id = in_subscription_id;
14:33:54 326  EXCEPTION
14:33:54 327  WHEN OTHERS THEN
14:33:54 328  	Procs_Common_V22.Throw_Exception(APP_EXCEPTION_CODES_V22.Unknown_Error,
14:33:54 329  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 330  
14:33:54 331  END GET_GROUP_ACCOUNT_BY_SUB_ID;
14:33:54 332  
14:33:54 333  PROCEDURE CREATE_GROUP_ACCOUNT (
14:33:54 334  	in_subscription_id	 IN NUMBER,
14:33:54 335  	in_group_name		 IN VARCHAR2,
14:33:54 336  	in_first_name		 IN VARCHAR2,
14:33:54 337  	in_last_name		 IN VARCHAR2,
14:33:54 338  	in_email		 IN VARCHAR2,
14:33:54 339  	in_phone		 IN VARCHAR2,
14:33:54 340  	in_organization_type	 IN VARCHAR2,
14:33:54 341  	in_seats		 IN NUMBER,
14:33:54 342  	in_seat_ttl_in_hours	 IN NUMBER,
14:33:54 343  	in_ip			 IN NUMBER,
14:33:54 344  	in_created_by		 IN VARCHAR2
14:33:54 345  ) AS
14:33:54 346  SPROC_NAME CONSTANT VARCHAR2(32) := 'CREATE_GROUP_ACCOUNT';
14:33:54 347  BEGIN
14:33:54 348  
14:33:54 349  	CORE_OWNER.PROCS_GROUP_ACCOUNT_CRU_V22.CREATE_GROUP_ACCOUNT(
14:33:54 350  	  in_subscription_id => in_subscription_id,
14:33:54 351  	  in_group_name => in_group_name,
14:33:54 352  	  in_first_name => in_first_name,
14:33:54 353  	  in_last_name => in_last_name,
14:33:54 354  	  in_email => in_email,
14:33:54 355  	  in_phone => in_phone,
14:33:54 356  	  in_organization_type => in_organization_type,
14:33:54 357  	  in_seats => in_seats,
14:33:54 358  	  in_seat_ttl_in_hours => in_seat_ttl_in_hours,
14:33:54 359  	  in_ip => in_ip,
14:33:54 360  	  in_created_by => in_created_by
14:33:54 361  	);
14:33:54 362  
14:33:54 363  END CREATE_GROUP_ACCOUNT;
14:33:54 364  
14:33:54 365  PROCEDURE GET_SUBSCRIPTION_SHARES (
14:33:54 366  	in_group_account_id IN NUMBER,
14:33:54 367  	in_start	    IN NUMBER,
14:33:54 368  	in_end		    IN NUMBER,
14:33:54 369  	out_Result_Set	    OUT Sys_Refcursor
14:33:54 370  ) AS
14:33:54 371  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_SUBSCRIPTION_SHARES';
14:33:54 372  range_diff NUMBER := 0;
14:33:54 373  upper_bond_diff NUMBER := 0;
14:33:54 374  l_start NUMBER := 0;
14:33:54 375  l_end   NUMBER := 0;
14:33:54 376  BEGIN
14:33:54 377  	-- Normalize the end points [START]
14:33:54 378  	IF (in_start IS NULL OR in_start < 0) Then
14:33:54 379  	  l_start := 0;
14:33:54 380  	ELSE
14:33:54 381  	  l_start := in_start;
14:33:54 382  	END IF;
14:33:54 383  
14:33:54 384  	IF (in_end IS NULL) Then
14:33:54 385  	  l_end := 11;
14:33:54 386  	ELSE
14:33:54 387  	  l_end := in_end;
14:33:54 388  	END IF;
14:33:54 389  
14:33:54 390  	l_start := l_start + 1;
14:33:54 391  	l_end	:= l_end   + 1;
14:33:54 392  
14:33:54 393  	range_diff := l_end - l_start;
14:33:54 394  	upper_bond_diff :=  range_diff - GLOBAL_CONSTANTS_V22.MAX_RETURN_COUNT;
14:33:54 395  
14:33:54 396  	IF (upper_bond_diff > 0) Then
14:33:54 397  	  l_end := l_end - upper_bond_diff;
14:33:54 398  	END IF;
14:33:54 399  	-- Normalize the end points [END]
14:33:54 400  
14:33:54 401  	BEGIN
14:33:54 402  	   OPEN out_result_set FOR
14:33:54 403  	   SELECT *
14:33:54 404  	   FROM
14:33:54 405  	     (SELECT rownum rnum, Q.*
14:33:54 406  	      FROM
14:33:54 407  	       (SELECT
14:33:54 408  		  ss.ID,
14:33:54 409  		  ss.GROUP_ACCOUNT_ID,
14:33:54 410  		  ss.BORROWER_ACCOUNT_ID,
14:33:54 411  		  ss.IP_ADDRESS,
14:33:54 412  		  ss.START_DATE,
14:33:54 413  		  ss.END_DATE,
14:33:54 414  		  ss.CREATED_BY,
14:33:54 415  		  ss.CREATE_DATE,
14:33:54 416  		  ss.UPDATED_BY,
14:33:54 417  		  ss.UPDATE_DATE,
14:33:54 418  		  a.GROUP_ID AS BORROWER_GROUP_ID
14:33:54 419  		FROM
14:33:54 420  		  SUBSCRIPTION_SHARE ss,
14:33:54 421  		  ACCOUNT a,
14:33:54 422  		  LICENSE l,
14:33:54 423  		  GROUP_ACCOUNT ga
14:33:54 424  		WHERE
14:33:54 425  		  ss.GROUP_ACCOUNT_ID = in_group_account_id AND
14:33:54 426  		  ss.GROUP_ACCOUNT_ID = ga.ID AND
14:33:54 427  		  GA.SUBSCRIPTION_ID = l.SUBSCRIPTION_ID AND
14:33:54 428  		  SYSDATE BETWEEN l.START_DATE AND l.ENTITLEMENT_END_DATE AND
14:33:54 429  		  SYSDATE BETWEEN ss.START_DATE AND ss.END_DATE AND
14:33:54 430  		  ss.BORROWER_ACCOUNT_ID  = a.ID
14:33:54 431  	      ) Q
14:33:54 432  	    WHERE rownum <= l_end)
14:33:54 433  	  WHERE rnum >= l_start;
14:33:54 434  	END;
14:33:54 435  EXCEPTION
14:33:54 436  WHEN OTHERS THEN
14:33:54 437  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 438  	  SPROC_NAME, 'Unknown error while retrieving subscription shares', SQLERRM);
14:33:54 439  END GET_SUBSCRIPTION_SHARES;
14:33:54 440  
14:33:54 441  PROCEDURE GET_GROUP_ACCOUNT_BY_IP (
14:33:54 442  	in_ip_low	    IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_LOW%TYPE,
14:33:54 443  	in_ip_high	    IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_HIGH%TYPE,
14:33:54 444  	out_result_set	      OUT SYS_REFCURSOR
14:33:54 445  ) AS
14:33:54 446  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GROUP_ACCOUNT_BY_IP';
14:33:54 447  BEGIN
14:33:54 448  	BEGIN
14:33:54 449  	  OPEN out_result_set FOR
14:33:54 450  	  SELECT
14:33:54 451  	    ID,
14:33:54 452  	    SUBSCRIPTION_ID,
14:33:54 453  	    GROUP_NAME,
14:33:54 454  	    FIRST_NAME,
14:33:54 455  	    LAST_NAME,
14:33:54 456  	    EMAIL,
14:33:54 457  	    PHONE,
14:33:54 458  	    ORGANIZATION_TYPE,
14:33:54 459  	    SEATS,
14:33:54 460  	    SEAT_TTL_IN_HOURS,
14:33:54 461  	    CREATE_DATE,
14:33:54 462  	    CREATED_BY,
14:33:54 463  	    UPDATE_DATE,
14:33:54 464  	    UPDATED_BY
14:33:54 465  	  FROM
14:33:54 466  	    GROUP_ACCOUNT
14:33:54 467  	  WHERE
14:33:54 468  	    ID IN (
14:33:54 469  	      SELECT
14:33:54 470  		GROUP_ACCOUNT_ID
14:33:54 471  	      FROM
14:33:54 472  		GROUP_ACCOUNT_IP_RANGE,
14:33:54 473  		GROUP_ACCOUNT,
14:33:54 474  		SUBSCRIPTION,
14:33:54 475  		OFFER_CHAIN
14:33:54 476  	      WHERE
14:33:54 477  		GROUP_ACCOUNT.ID = GROUP_ACCOUNT_ID
14:33:54 478  	      AND
14:33:54 479  		GROUP_ACCOUNT.SUBSCRIPTION_ID = SUBSCRIPTION.ID AND
14:33:54 480  		SUBSCRIPTION.OFFER_CHAIN_ID = OFFER_CHAIN.ID AND
14:33:54 481  		OFFER_CHAIN.GROUP_ACCOUNT_TYPE_ID = 'GL'
14:33:54 482  	      AND
14:33:54 483  		(
14:33:54 484  		  (in_ip_high > minimum_ip_high and in_ip_high < maximum_ip_high) or
14:33:54 485  		  (in_ip_high = minimum_ip_high and (in_ip_low >= minimum_ip_low and in_ip_low <= maximum_ip_low)) or
14:33:54 486  		  (in_ip_high = maximum_ip_high and (in_ip_low >= minimum_ip_low and in_ip_low <= maximum_ip_low))
14:33:54 487  		)
14:33:54 488  	      AND
14:33:54 489  		GROUP_ACC_IP_RNG_STATUS_ID = GLOBAL_STATUSES_V22.GROUP_ACC_IP_RNG_ACTIVE
14:33:54 490  	    );
14:33:54 491  	  END;
14:33:54 492  EXCEPTION
14:33:54 493  WHEN OTHERS THEN
14:33:54 494  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 495  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 496  END GET_GROUP_ACCOUNT_BY_IP;
14:33:54 497  
14:33:54 498  PROCEDURE GET_GROUP_ACCOUNT_BY_EMAIL (
14:33:54 499  	in_email_domain     IN GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE,
14:33:54 500  	out_result_set	    OUT SYS_REFCURSOR
14:33:54 501  ) AS
14:33:54 502  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GROUP_ACCOUNT_BY_EMAIL';
14:33:54 503  var_second_level_domain GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE;
14:33:54 504  var_third_level_domain GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE;
14:33:54 505  BEGIN
14:33:54 506  	var_second_level_domain := REGEXP_REPLACE(in_email_domain, '.*?([^\.]+\.[^\.]+)$', '\1');
14:33:54 507  	var_third_level_domain := REGEXP_REPLACE(in_email_domain, '.*?(([^\.]+\.){2}[^\.]+)$', '\1');
14:33:54 508  	BEGIN
14:33:54 509  	  OPEN out_result_set FOR
14:33:54 510  	  SELECT
14:33:54 511  	    ID,
14:33:54 512  	    SUBSCRIPTION_ID,
14:33:54 513  	    GROUP_NAME,
14:33:54 514  	    FIRST_NAME,
14:33:54 515  	    LAST_NAME,
14:33:54 516  	    EMAIL,
14:33:54 517  	    PHONE,
14:33:54 518  	    ORGANIZATION_TYPE,
14:33:54 519  	    SEATS,
14:33:54 520  	    SEAT_TTL_IN_HOURS,
14:33:54 521  	    CREATE_DATE,
14:33:54 522  	    CREATED_BY,
14:33:54 523  	    UPDATE_DATE,
14:33:54 524  	    UPDATED_BY
14:33:54 525  	  FROM
14:33:54 526  	    GROUP_ACCOUNT
14:33:54 527  	  WHERE
14:33:54 528  	    ID IN (
14:33:54 529  	      SELECT
14:33:54 530  		GROUP_ACCOUNT_ID
14:33:54 531  	      FROM
14:33:54 532  		GROUP_ACCOUNT_EMAIL_DOMAIN gaed,
14:33:54 533  		GROUP_ACCOUNT ga,
14:33:54 534  		SUBSCRIPTION s,
14:33:54 535  		OFFER_CHAIN oc
14:33:54 536  	      WHERE
14:33:54 537  		ga.ID = gaed.GROUP_ACCOUNT_ID AND
14:33:54 538  		ga.SUBSCRIPTION_ID = s.ID AND
14:33:54 539  		s.OFFER_CHAIN_ID = oc.ID AND
14:33:54 540  		oc.GROUP_ACCOUNT_TYPE_ID in ('GL', 'KL') AND
14:33:54 541  		(gaed.EMAIL_DOMAIN = var_third_level_domain OR gaed.EMAIL_DOMAIN = var_second_level_domain) AND
14:33:54 542  		gaed.IS_ACTIVE = 1
14:33:54 543  	    );
14:33:54 544  	  END;
14:33:54 545  EXCEPTION
14:33:54 546  WHEN OTHERS THEN
14:33:54 547  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 548  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 549  END GET_GROUP_ACCOUNT_BY_EMAIL;
14:33:54 550  
14:33:54 551  PROCEDURE GET_GROUP_ACCOUNT_IP_RANGES (
14:33:54 552  	in_group_account_id   IN NUMBER,
14:33:54 553  	in_start	      IN NUMBER,
14:33:54 554  	in_end		      IN NUMBER,
14:33:54 555  	in_status	      IN NUMBER,
14:33:54 556  	out_record_count      OUT NUMBER,
14:33:54 557  	out_result_set	      OUT SYS_REFCURSOR
14:33:54 558  ) AS
14:33:54 559  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GROUP_ACCOUNT_IP_RANGES';
14:33:54 560  range_diff NUMBER := 0;
14:33:54 561  upper_bond_diff NUMBER := 0;
14:33:54 562  l_start NUMBER := 0;
14:33:54 563  l_end   NUMBER := 0;
14:33:54 564  BEGIN
14:33:54 565  	--Normalize the end points [START]
14:33:54 566  	IF (in_start IS NULL OR in_start < 0) Then
14:33:54 567  	  l_start := 0;
14:33:54 568  	ELSE
14:33:54 569  	  l_start := in_start;
14:33:54 570  	END IF;
14:33:54 571  
14:33:54 572  	IF (in_end IS NULL) Then
14:33:54 573  	  l_end := 11;
14:33:54 574  	ELSE
14:33:54 575  	  l_end := in_end;
14:33:54 576  	END IF;
14:33:54 577  
14:33:54 578  	l_start := l_start + 1;
14:33:54 579  	l_end	:= l_end   + 1;
14:33:54 580  
14:33:54 581  	range_diff := l_end - l_start;
14:33:54 582  	upper_bond_diff :=  range_diff - GLOBAL_CONSTANTS_V22.MAX_RETURN_COUNT;
14:33:54 583  
14:33:54 584  	IF (upper_bond_diff > 0) Then
14:33:54 585  	  l_end := l_end - upper_bond_diff;
14:33:54 586  	END IF;
14:33:54 587  	--Normalize the end points [END]
14:33:54 588  
14:33:54 589  	--Total count of records [START]
14:33:54 590  	SELECT
14:33:54 591  	  COUNT(1) INTO out_record_count
14:33:54 592  	FROM
14:33:54 593  	  GROUP_ACCOUNT_IP_RANGE
14:33:54 594  	WHERE
14:33:54 595  	  GROUP_ACCOUNT_ID = in_group_account_id AND
14:33:54 596  	  (in_status IS NULL OR GROUP_ACC_IP_RNG_STATUS_ID = in_status);
14:33:54 597  	--Total count of records [END]
14:33:54 598  
14:33:54 599  	OPEN out_result_set FOR
14:33:54 600  	SELECT
14:33:54 601  	  *
14:33:54 602  	FROM
14:33:54 603  	  (SELECT rownum rnum, q.*
14:33:54 604  	   FROM
14:33:54 605  	    (SELECT
14:33:54 606  	       ID,
14:33:54 607  	       GROUP_ACCOUNT_ID,
14:33:54 608  	       MINIMUM_IP_STRING,
14:33:54 609  	       MAXIMUM_IP_STRING,
14:33:54 610  	       GROUP_ACC_IP_RNG_STATUS_ID
14:33:54 611  	     FROM
14:33:54 612  	       GROUP_ACCOUNT_IP_RANGE
14:33:54 613  	     WHERE
14:33:54 614  	       GROUP_ACCOUNT_ID = in_group_account_id AND
14:33:54 615  	       (in_status IS NULL OR
14:33:54 616  		GROUP_ACC_IP_RNG_STATUS_ID = in_status)
14:33:54 617  	    ) Q
14:33:54 618  	  WHERE rownum <= l_end)
14:33:54 619  	WHERE rnum >= l_Start;
14:33:54 620  EXCEPTION
14:33:54 621  WHEN OTHERS THEN
14:33:54 622  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 623  	  SPROC_NAME, 'Unknown error while retrieving IP ranges ', SQLERRM);
14:33:54 624  END GET_GROUP_ACCOUNT_IP_RANGES;
14:33:54 625  
14:33:54 626  PROCEDURE GET_GRP_ACCNT_EMAIL_DOMAINS (
14:33:54 627  	in_group_account_id   IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
14:33:54 628  	in_start	      IN NUMBER,
14:33:54 629  	in_end		      IN NUMBER,
14:33:54 630  	in_status	      IN GROUP_ACCOUNT_EMAIL_DOMAIN.IS_ACTIVE%TYPE,
14:33:54 631  	out_record_count      OUT NUMBER,
14:33:54 632  	out_result_set	      OUT SYS_REFCURSOR
14:33:54 633  ) AS
14:33:54 634  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GRP_ACCNT_EMAIL_DOMAINS';
14:33:54 635  range_diff NUMBER := 0;
14:33:54 636  upper_bond_diff NUMBER := 0;
14:33:54 637  l_start NUMBER := 0;
14:33:54 638  l_end   NUMBER := 0;
14:33:54 639  BEGIN
14:33:54 640  	--Normalize the end points [START]
14:33:54 641  	IF (in_start IS NULL OR in_start < 0) Then
14:33:54 642  	  l_start := 0;
14:33:54 643  	ELSE
14:33:54 644  	  l_start := in_start;
14:33:54 645  	END IF;
14:33:54 646  
14:33:54 647  	IF (in_end IS NULL) Then
14:33:54 648  	  l_end := 11;
14:33:54 649  	ELSE
14:33:54 650  	  l_end := in_end;
14:33:54 651  	END IF;
14:33:54 652  
14:33:54 653  	l_start := l_start + 1;
14:33:54 654  	l_end	:= l_end   + 1;
14:33:54 655  
14:33:54 656  	range_diff := l_end - l_start;
14:33:54 657  	upper_bond_diff :=  range_diff - GLOBAL_CONSTANTS_V22.MAX_RETURN_COUNT;
14:33:54 658  
14:33:54 659  	IF (upper_bond_diff > 0) Then
14:33:54 660  	  l_end := l_end - upper_bond_diff;
14:33:54 661  	END IF;
14:33:54 662  	--Normalize the end points [END]
14:33:54 663  
14:33:54 664  	--Total count of records [START]
14:33:54 665  	SELECT
14:33:54 666  	  COUNT(1) INTO out_record_count
14:33:54 667  	FROM
14:33:54 668  	  GROUP_ACCOUNT_EMAIL_DOMAIN
14:33:54 669  	WHERE
14:33:54 670  	  GROUP_ACCOUNT_ID = in_group_account_id AND
14:33:54 671  	  (IS_ACTIVE IS NULL OR IS_ACTIVE = in_status);
14:33:54 672  	--Total count of records [END]
14:33:54 673  
14:33:54 674  	OPEN out_result_set FOR
14:33:54 675  	SELECT
14:33:54 676  	  *
14:33:54 677  	FROM
14:33:54 678  	  (SELECT rownum rnum, q.*
14:33:54 679  	   FROM
14:33:54 680  	    (SELECT
14:33:54 681  	      ID,
14:33:54 682  	      GROUP_ACCOUNT_ID,
14:33:54 683  	      EMAIL_DOMAIN,
14:33:54 684  	      IS_ACTIVE
14:33:54 685  	     FROM
14:33:54 686  	       GROUP_ACCOUNT_EMAIL_DOMAIN
14:33:54 687  	     WHERE
14:33:54 688  	       GROUP_ACCOUNT_ID = in_group_account_id AND
14:33:54 689  	       (in_status IS NULL OR
14:33:54 690  		IS_ACTIVE = in_status)
14:33:54 691  	    ) Q
14:33:54 692  	  WHERE rownum <= l_end)
14:33:54 693  	WHERE rnum >= l_Start;
14:33:54 694  
14:33:54 695  EXCEPTION
14:33:54 696  WHEN OTHERS THEN
14:33:54 697  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 698  	  SPROC_NAME, 'Unknown error while retrieving Email Domains ', SQLERRM);
14:33:54 699  END GET_GRP_ACCNT_EMAIL_DOMAINS;
14:33:54 700  
14:33:54 701  PROCEDURE DISABLE_EMAIL_DOMAIN_BY_GA_ID (
14:33:54 702  	in_group_account_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
14:33:54 703  	in_updated_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.UPDATED_BY%TYPE
14:33:54 704  ) AS
14:33:54 705  SPROC_NAME CONSTANT VARCHAR2(32) := 'DISABLE_EMAIL_DOMAIN_BY_GA_ID';
14:33:54 706  BEGIN
14:33:54 707  	  PROCS_GROUP_ACCOUNT_CRU_V22.DISABLE_EMAIL_DOMAIN_BY_GA_ID(
14:33:54 708  	    in_group_account_id => in_group_account_id,
14:33:54 709  	    in_updated_by => in_updated_by
14:33:54 710  	  );
14:33:54 711  EXCEPTION
14:33:54 712  WHEN OTHERS THEN
14:33:54 713  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 714  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 715  END DISABLE_EMAIL_DOMAIN_BY_GA_ID;
14:33:54 716  
14:33:54 717  PROCEDURE DISABLE_EMAIL_DOMAIN_BY_ID (
14:33:54 718  	in_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.ID%TYPE,
14:33:54 719  	in_updated_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.UPDATED_BY%TYPE
14:33:54 720  ) AS
14:33:54 721  SPROC_NAME CONSTANT VARCHAR2(32) := 'DISABLE_EMAIL_DOMAIN_BY_ID';
14:33:54 722  BEGIN
14:33:54 723  	  PROCS_GROUP_ACCOUNT_CRU_V22.DISABLE_EMAIL_DOMAIN_BY_ID(
14:33:54 724  	    in_id => in_id,
14:33:54 725  	    in_updated_by => in_updated_by
14:33:54 726  	  );
14:33:54 727  EXCEPTION
14:33:54 728  WHEN OTHERS THEN
14:33:54 729  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 730  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 731  END DISABLE_EMAIL_DOMAIN_BY_ID;
14:33:54 732  
14:33:54 733  PROCEDURE ADD_EMAIL_DOMAIN (
14:33:54 734  	in_group_account_id IN GROUP_ACCOUNT_EMAIL_DOMAIN.GROUP_ACCOUNT_ID%TYPE,
14:33:54 735  	in_email_domain IN GROUP_ACCOUNT_EMAIL_DOMAIN.EMAIL_DOMAIN%TYPE,
14:33:54 736  	in_created_by IN GROUP_ACCOUNT_EMAIL_DOMAIN.CREATED_BY%TYPE
14:33:54 737  ) AS
14:33:54 738  SPROC_NAME CONSTANT VARCHAR2(32) := 'ADD_EMAIL_DOMAIN';
14:33:54 739  var_ga_type OFFER_CHAIN.GROUP_ACCOUNT_TYPE_ID%TYPE;
14:33:54 740  var_is_dupe NUMBER(1);
14:33:54 741  var_group_account_count NUMBER := 0;
14:33:54 742  var_id  GROUP_ACCOUNT_EMAIL_DOMAIN.ID%TYPE;
14:33:54 743  NOT_GL EXCEPTION;
14:33:54 744  BEGIN
14:33:54 745  
14:33:54 746  	  SELECT OFFER_CHAIN.GROUP_ACCOUNT_TYPE_ID into var_ga_type
14:33:54 747  	  FROM
14:33:54 748  	    GROUP_ACCOUNT,
14:33:54 749  	    SUBSCRIPTION,
14:33:54 750  	    OFFER_CHAIN
14:33:54 751  	  WHERE
14:33:54 752  	    GROUP_ACCOUNT.ID = in_group_account_id AND
14:33:54 753  	    GROUP_ACCOUNT.SUBSCRIPTION_ID = SUBSCRIPTION.ID AND
14:33:54 754  	    SUBSCRIPTION.OFFER_CHAIN_ID = OFFER_CHAIN.ID
14:33:54 755  	  ;
14:33:54 756  	  IF(var_ga_type != 'GL' and var_ga_type != 'KL' ) THEN
14:33:54 757  	    RAISE NOT_GL;
14:33:54 758  	  END IF;
14:33:54 759  <<<<<<< HEAD
14:33:54 760  
14:33:54 761  	  --check if email domain already exists
14:33:54 762  	  SELECT count(1) into var_group_account_count
14:33:54 763  	  FROM
14:33:54 764  	      GROUP_ACCOUNT_EMAIL_DOMAIN
14:33:54 765  	  WHERE
14:33:54 766  	      GROUP_ACCOUNT_ID= in_group_account_id AND
14:33:54 767  	      EMAIL_DOMAIN = in_email_domain
14:33:54 768  	  ;
14:33:54 769  
14:33:54 770  	  IF(var_group_account_count > 0) THEN
14:33:54 771  	      SELECT ID into var_id
14:33:54 772  	      FROM
14:33:54 773  		  GROUP_ACCOUNT_EMAIL_DOMAIN
14:33:54 774  	      WHERE
14:33:54 775  		  GROUP_ACCOUNT_ID= in_group_account_id AND
14:33:54 776  		  EMAIL_DOMAIN = in_email_domain AND
14:33:54 777  		  rownum <= 1;
14:33:54 778  	      PROCS_GROUP_ACCOUNT_CRU_V22.ENABLE_EMAIL_DOMAIN_BY_ID(
14:33:54 779  		  in_id => var_id,
14:33:54 780  		  in_updated_by => in_created_by
14:33:54 781  		  );
14:33:54 782  	  ELSE
14:33:54 783  	      PROCS_GROUP_ACCOUNT_CRU_V22.ADD_EMAIL_DOMAIN(
14:33:54 784  		  in_group_account_id => in_group_account_id,
14:33:54 785  		  in_email_domain => in_email_domain,
14:33:54 786  		      in_is_active => GLOBAL_STATUSES_V22.GROUP_ACC_EMAIL_DOMAIN_ACT,
14:33:54 787  		  in_created_by => in_created_by
14:33:54 788  	      );
14:33:54 789  	  END IF;
14:33:54 790  =======
14:33:54 791  
14:33:54 792  	  PROCS_GROUP_ACCOUNT_CRU_V19.ADD_EMAIL_DOMAIN(
14:33:54 793  	     in_group_account_id => in_group_account_id,
14:33:54 794  	     in_email_domain => in_email_domain,
14:33:54 795  	     in_is_active => GLOBAL_STATUSES_V19.GROUP_ACC_EMAIL_DOMAIN_ACT,
14:33:54 796  	     in_created_by => in_created_by
14:33:54 797  	  );
14:33:54 798  >>>>>>> feature/unique_group_email
14:33:54 799  
14:33:54 800  EXCEPTION
14:33:54 801  WHEN NOT_GL THEN
14:33:54 802  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:54 803  	  SPROC_NAME, 'Group account type does not support Email Domains', SQLERRM);
14:33:54 804  WHEN OTHERS THEN
14:33:54 805  <<<<<<< HEAD
14:33:54 806  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 807  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 808  =======
14:33:54 809  	IF (sqlcode=APP_EXCEPTION_CODES_V19.DUPLICATE_ERROR) THEN
14:33:54 810  	   RAISE;
14:33:54 811  	ELSE
14:33:54 812  	  PROCS_COMMON_V19.THROW_EXCEPTION(APP_EXCEPTION_CODES_V19.UNKNOWN_ERROR,
14:33:54 813  	    SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 814  	END IF;
14:33:54 815  >>>>>>> feature/unique_group_email
14:33:54 816  END ADD_EMAIL_DOMAIN;
14:33:54 817  
14:33:54 818  PROCEDURE CREATE_SUBSCRIPTION_SHARE (
14:33:54 819  	in_group_account_id    IN NUMBER,
14:33:54 820  	in_borrower_account_id IN NUMBER,
14:33:54 821  	in_ip_address	       IN VARCHAR2,
14:33:54 822  	in_email_domain        IN VARCHAR2,
14:33:54 823  	in_created_by	       IN VARCHAR2
14:33:54 824  ) AS
14:33:54 825  SPROC_NAME CONSTANT VARCHAR2(32) := 'CREATE_SUBSCRIPTION_SHARE';
14:33:54 826  ga_ttl_in_hours NUMBER := NULL;
14:33:54 827  start_date DATE := NULL;
14:33:54 828  end_date DATE := NULL;
14:33:54 829  BEGIN
14:33:54 830  	start_date := sysdate;
14:33:54 831  	end_date   := GLOBAL_CONSTANTS_V22.MAX_DATE;
14:33:54 832  
14:33:54 833  	BEGIN
14:33:54 834  	  SELECT SEAT_TTL_IN_HOURS into ga_ttl_in_hours
14:33:54 835  	  FROM GROUP_ACCOUNT, SUBSCRIPTION, OFFER_CHAIN
14:33:54 836  	  WHERE GROUP_ACCOUNT.ID = in_group_account_id AND
14:33:54 837  		GROUP_ACCOUNT.SUBSCRIPTION_ID = SUBSCRIPTION.ID AND
14:33:54 838  		SUBSCRIPTION.OFFER_CHAIN_ID = OFFER_CHAIN.ID AND
14:33:54 839  		OFFER_CHAIN.GROUP_ACCOUNT_TYPE_ID in ('GL', 'KL');
14:33:54 840  	EXCEPTION
14:33:54 841  	  WHEN no_data_found THEN
14:33:54 842  	    ga_ttl_in_hours := NULL;
14:33:54 843  	END;
14:33:54 844  
14:33:54 845  	IF (ga_ttl_in_hours IS NOT NULL) THEN
14:33:54 846  	  end_date := (start_date + (1/24 * ga_ttl_in_hours));
14:33:54 847  	END IF;
14:33:54 848  
14:33:54 849  	CORE_OWNER.PROCS_GROUP_ACCOUNT_CRU_V22.CREATE_SUBSCRIPTION_SHARE(
14:33:54 850  	  in_group_account_id => in_group_account_id,
14:33:54 851  	  in_borrower_account_id => in_borrower_account_id,
14:33:54 852  	  in_ip_address => in_ip_address,
14:33:54 853  	  in_email_domain => in_email_domain,
14:33:54 854  	  in_start_date => start_date,
14:33:54 855  	  in_end_date => end_date,
14:33:54 856  	  in_created_by => in_created_by
14:33:54 857  	);
14:33:54 858  END CREATE_SUBSCRIPTION_SHARE;
14:33:54 859  
14:33:54 860  
14:33:54 861  PROCEDURE GET_NUM_OCCUPIED_GROUP_SEATS (
14:33:54 862  	in_group_account_id   IN NUMBER,
14:33:54 863  	out_occupied_seats   OUT NUMBER
14:33:54 864  ) AS
14:33:54 865  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_NUM_OCCUPIED_GROUP_SEATS';
14:33:54 866  BEGIN
14:33:54 867  	SELECT
14:33:54 868  	  PROCS_GROUP_ACCOUNT_V22.F_GET_NUM_OCCUPIED_GROUP_SEATS(in_group_account_id) INTO out_occupied_seats
14:33:54 869  	FROM dual;
14:33:54 870  EXCEPTION
14:33:54 871  WHEN OTHERS THEN
14:33:54 872  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 873  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 874  END GET_NUM_OCCUPIED_GROUP_SEATS;
14:33:54 875  
14:33:54 876  
14:33:54 877  FUNCTION F_GET_NUM_OCCUPIED_GROUP_SEATS (
14:33:54 878  	in_group_account_id   IN NUMBER
14:33:54 879  ) RETURN NUMBER IS
14:33:54 880  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_NUM_OCCUPIED_GROUP_SEATS';
14:33:54 881  num_seats NUMBER;
14:33:54 882  BEGIN
14:33:54 883  	SELECT
14:33:54 884  	  COUNT(1) INTO num_seats
14:33:54 885  	FROM
14:33:54 886  	  SUBSCRIPTION_SHARE
14:33:54 887  	WHERE
14:33:54 888  	  GROUP_ACCOUNT_ID = in_group_account_id AND
14:33:54 889  	  SYSDATE BETWEEN START_DATE AND END_DATE;
14:33:54 890  	RETURN num_seats;
14:33:54 891  EXCEPTION
14:33:54 892  WHEN OTHERS THEN
14:33:54 893  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 894  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 895  END F_GET_NUM_OCCUPIED_GROUP_SEATS;
14:33:54 896  
14:33:54 897  -- *********************************************************************
14:33:54 898  -- *************** GROUP ACCOUNT IP RANGE JUNK *************************
14:33:54 899  -- *********************************************************************
14:33:54 900  -- I'm debating if this should be in a different package, but right now
14:33:54 901  -- I'm too lazy to move this else where.
14:33:54 902  -- *********************************************************************
14:33:54 903  
14:33:54 904  PROCEDURE DISABLE_IP_RANGES_BY_GA_ID (
14:33:54 905  	in_group_account_id IN GROUP_ACCOUNT_IP_RANGE.GROUP_ACCOUNT_ID%TYPE,
14:33:54 906  	in_updated_by IN GROUP_ACCOUNT_IP_RANGE.UPDATED_BY%TYPE
14:33:54 907  ) AS
14:33:54 908  SPROC_NAME CONSTANT VARCHAR2(32) := 'DISABLE_IP_RANGES_BY_GA_ID';
14:33:54 909  BEGIN
14:33:54 910  	  PROCS_GROUP_ACCOUNT_CRU_V22.DISABLE_IP_RANGES_BY_GA_ID(
14:33:54 911  	    in_group_account_id => in_group_account_id,
14:33:54 912  	    in_updated_by => in_updated_by
14:33:54 913  	  );
14:33:54 914  EXCEPTION
14:33:54 915  WHEN OTHERS THEN
14:33:54 916  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 917  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 918  END DISABLE_IP_RANGES_BY_GA_ID;
14:33:54 919  
14:33:54 920  PROCEDURE DISABLE_IP_RANGE_BY_ID (
14:33:54 921  	in_id IN GROUP_ACCOUNT_IP_RANGE.ID%TYPE,
14:33:54 922  	in_updated_by IN GROUP_ACCOUNT_IP_RANGE.UPDATED_BY%TYPE
14:33:54 923  ) AS
14:33:54 924  SPROC_NAME CONSTANT VARCHAR2(32) := 'DISABLE_IP_RANGE_BY_ID';
14:33:54 925  BEGIN
14:33:54 926  	  PROCS_GROUP_ACCOUNT_CRU_V22.DISABLE_IP_RANGE_BY_ID(
14:33:54 927  	    in_id => in_id,
14:33:54 928  	    in_updated_by => in_updated_by
14:33:54 929  	  );
14:33:54 930  EXCEPTION
14:33:54 931  WHEN OTHERS THEN
14:33:54 932  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 933  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 934  END DISABLE_IP_RANGE_BY_ID;
14:33:54 935  
14:33:54 936  PROCEDURE ADD_IP_RANGE (
14:33:54 937  	in_group_account_id IN GROUP_ACCOUNT_IP_RANGE.GROUP_ACCOUNT_ID%TYPE,
14:33:54 938  	in_minimum_ip_string IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_STRING%TYPE,
14:33:54 939  	in_minimum_ip_low IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_LOW%TYPE,
14:33:54 940  	in_minimum_ip_high IN GROUP_ACCOUNT_IP_RANGE.MINIMUM_IP_HIGH%TYPE,
14:33:54 941  	in_maximum_ip_string IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_STRING%TYPE,
14:33:54 942  	in_maximum_ip_low IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_LOW%TYPE,
14:33:54 943  	in_maximum_ip_high IN GROUP_ACCOUNT_IP_RANGE.MAXIMUM_IP_HIGH%TYPE,
14:33:54 944  	in_created_by IN GROUP_ACCOUNT_IP_RANGE.CREATED_BY%TYPE
14:33:54 945  ) AS
14:33:54 946  SPROC_NAME CONSTANT VARCHAR2(32) := 'ADD_IP_RANGE';
14:33:54 947  var_ga_type OFFER_CHAIN.GROUP_ACCOUNT_TYPE_ID%TYPE;
14:33:54 948  var_is_dupe NUMBER(1);
14:33:54 949  NOT_GL EXCEPTION;
14:33:54 950  DUPE EXCEPTION;
14:33:54 951  BEGIN
14:33:54 952  	  SELECT OFFER_CHAIN.GROUP_ACCOUNT_TYPE_ID into var_ga_type
14:33:54 953  	  FROM
14:33:54 954  	    GROUP_ACCOUNT,
14:33:54 955  	    SUBSCRIPTION,
14:33:54 956  	    OFFER_CHAIN
14:33:54 957  	  WHERE
14:33:54 958  	    GROUP_ACCOUNT.ID = in_group_account_id AND
14:33:54 959  	    GROUP_ACCOUNT.SUBSCRIPTION_ID = SUBSCRIPTION.ID AND
14:33:54 960  	    SUBSCRIPTION.OFFER_CHAIN_ID = OFFER_CHAIN.ID
14:33:54 961  	  ;
14:33:54 962  	  IF(var_ga_type != 'GL') THEN
14:33:54 963  	    RAISE NOT_GL;
14:33:54 964  	  END IF;
14:33:54 965  
14:33:54 966  	  PROCS_GROUP_ACCOUNT_CRU_V22.ADD_IP_RANGE(
14:33:54 967  	    in_group_account_id => in_group_account_id,
14:33:54 968  	    in_minimum_ip_string => in_minimum_ip_string,
14:33:54 969  	    in_minimum_ip_low => in_minimum_ip_low,
14:33:54 970  	    in_minimum_ip_high => in_minimum_ip_high,
14:33:54 971  	    in_maximum_ip_string => in_maximum_ip_string,
14:33:54 972  	    in_maximum_ip_low => in_maximum_ip_low,
14:33:54 973  	    in_maximum_ip_high => in_maximum_ip_high,
14:33:54 974  	    in_created_by => in_created_by
14:33:54 975  	  );
14:33:54 976  
14:33:54 977  	  -- Check for overlapping ip address range after insert.  Note that if another
14:33:54 978  	  -- call to add_ip_range has not completed, overlapping ip entries can occur.
14:33:54 979  	  SELECT count(1) into var_is_dupe
14:33:54 980  	  FROM
14:33:54 981  	    GROUP_ACCOUNT_IP_RANGE
14:33:54 982  	  WHERE
14:33:54 983  	    GROUP_ACC_IP_RNG_STATUS_ID = GLOBAL_STATUSES_V22.GROUP_ACC_IP_RNG_ACTIVE AND
14:33:54 984  		((
14:33:54 985  		  (in_minimum_ip_high > minimum_ip_high and in_minimum_ip_high < maximum_ip_high) or
14:33:54 986  		  (in_minimum_ip_high = minimum_ip_high and (in_minimum_ip_low >= minimum_ip_low and in_minimum_ip_low <= maximum_ip_low)) or
14:33:54 987  		  (in_minimum_ip_high = maximum_ip_high and (in_minimum_ip_low >= minimum_ip_low and in_minimum_ip_low <= maximum_ip_low))
14:33:54 988  		) OR
14:33:54 989  
14:33:54 990  		(
14:33:54 991  		  (in_maximum_ip_high > minimum_ip_high and in_maximum_ip_high < maximum_ip_high) or
14:33:54 992  		  (in_maximum_ip_high = minimum_ip_high and (in_maximum_ip_low >= minimum_ip_low and in_maximum_ip_low <= maximum_ip_low)) or
14:33:54 993  		  (in_maximum_ip_high = maximum_ip_high and (in_maximum_ip_low >= minimum_ip_low and in_maximum_ip_low <= maximum_ip_low))
14:33:54 994  		)) AND
14:33:54 995  	    ROWNUM < 3;
14:33:54 996  
14:33:54 997  	  If(var_is_dupe > 1) THEN
14:33:54 998  	    RAISE DUPE;
14:33:54 999  	  END IF;
14:33:54 1000  EXCEPTION
14:33:54 1001  WHEN NOT_GL THEN
14:33:54 1002  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:54 1003  	   SPROC_NAME, 'Group account type does not support IPs', SQLERRM);
14:33:54 1004  WHEN DUPE THEN
14:33:54 1005  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:54 1006  	   SPROC_NAME, 'The IP address range is already in use', SQLERRM);
14:33:54 1007  WHEN OTHERS THEN
14:33:54 1008  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1009  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1010  END ADD_IP_RANGE;
14:33:54 1011  
14:33:54 1012  PROCEDURE GET_GRP_ID_BY_GRP_ACCOUNT_ID (
14:33:54 1013  	 in_group_account_id IN NUMBER,
14:33:54 1014  	 out_group_id OUT NUMBER
14:33:54 1015  ) AS
14:33:54 1016  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GRP_ID_BY_GRP_ACCOUNT_ID';
14:33:54 1017  BEGIN
14:33:54 1018  	 SELECT
14:33:54 1019  	   a.group_id into out_group_id
14:33:54 1020  	 FROM
14:33:54 1021  	   account a,
14:33:54 1022  	   subscription s,
14:33:54 1023  	   group_account ga
14:33:54 1024  	 WHERE
14:33:54 1025  	   a.id = s.account_id and
14:33:54 1026  	   s.id = ga.subscription_id and
14:33:54 1027  	   ga.id = in_group_account_id and
14:33:54 1028  	   rownum < 2
14:33:54 1029  	 ;
14:33:54 1030  EXCEPTION
14:33:54 1031  WHEN NO_DATA_FOUND THEN
14:33:54 1032  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1033  	   SPROC_NAME, 'Bad group_account_id');
14:33:54 1034  WHEN OTHERS THEN
14:33:54 1035  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1036  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1037  END GET_GRP_ID_BY_GRP_ACCOUNT_ID;
14:33:54 1038  
14:33:54 1039  PROCEDURE GET_GRP_ID_BY_GRPACCIPRNG_ID (
14:33:54 1040  	 in_group_account_ip_range_id IN NUMBER,
14:33:54 1041  	 out_group_id OUT NUMBER
14:33:54 1042  ) AS
14:33:54 1043  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GRP_ID_BY_GRPACCIPRNG_ID';
14:33:54 1044  BEGIN
14:33:54 1045  	 SELECT
14:33:54 1046  	   a.group_id into out_group_id
14:33:54 1047  	 FROM
14:33:54 1048  	   account a,
14:33:54 1049  	   subscription s,
14:33:54 1050  	   group_account ga,
14:33:54 1051  	   group_account_ip_range ir
14:33:54 1052  	 WHERE
14:33:54 1053  	   a.id = s.account_id and
14:33:54 1054  	   s.id = ga.subscription_id and
14:33:54 1055  	   ga.id = ir.group_account_id and
14:33:54 1056  	   ir.id = in_group_account_ip_range_id and
14:33:54 1057  	   rownum < 2
14:33:54 1058  	 ;
14:33:54 1059  EXCEPTION
14:33:54 1060  WHEN NO_DATA_FOUND THEN
14:33:54 1061  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1062  	   SPROC_NAME, 'Bad group_account_ip_range_id');
14:33:54 1063  WHEN OTHERS THEN
14:33:54 1064  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1065  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1066  END GET_GRP_ID_BY_GRPACCIPRNG_ID;
14:33:54 1067  
14:33:54 1068  PROCEDURE GET_GRP_ID_BY_EMAIL_DOM_ID (
14:33:54 1069  	 in_group_account_email_dom_id IN NUMBER,
14:33:54 1070  	 out_group_id OUT NUMBER
14:33:54 1071  ) AS
14:33:54 1072  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GRP_ID_BY_EMAIL_DOM_ID';
14:33:54 1073  BEGIN
14:33:54 1074  	 SELECT
14:33:54 1075  	   a.group_id into out_group_id
14:33:54 1076  	 FROM
14:33:54 1077  	   account a,
14:33:54 1078  	   subscription s,
14:33:54 1079  	   group_account ga,
14:33:54 1080  	   group_account_email_domain ir
14:33:54 1081  	 WHERE
14:33:54 1082  	   a.id = s.account_id and
14:33:54 1083  	   s.id = ga.subscription_id and
14:33:54 1084  	   ga.id = ir.group_account_id and
14:33:54 1085  	   ir.id = in_group_account_email_dom_id and
14:33:54 1086  	   rownum < 2
14:33:54 1087  	 ;
14:33:54 1088  EXCEPTION
14:33:54 1089  WHEN NO_DATA_FOUND THEN
14:33:54 1090  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1091  	   SPROC_NAME, 'Bad group_account_ip_range_id');
14:33:54 1092  WHEN OTHERS THEN
14:33:54 1093  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1094  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1095  END GET_GRP_ID_BY_EMAIL_DOM_ID;
14:33:54 1096  
14:33:54 1097  PROCEDURE UPDATE_GROUP_ACCOUNT (
14:33:54 1098  	 in_group_account_id	  IN GROUP_ACCOUNT.ID%TYPE,
14:33:54 1099  	 in_group_name		  IN GROUP_ACCOUNT.GROUP_NAME%TYPE,
14:33:54 1100  	 in_first_name		  IN GROUP_ACCOUNT.FIRST_NAME%TYPE,
14:33:54 1101  	 in_last_name		  IN GROUP_ACCOUNT.LAST_NAME%TYPE,
14:33:54 1102  	 in_email		  IN GROUP_ACCOUNT.EMAIL%TYPE,
14:33:54 1103  	 in_phone		  IN GROUP_ACCOUNT.PHONE%TYPE,
14:33:54 1104  	 in_updated_by		  IN GROUP_ACCOUNT.UPDATED_BY%TYPE
14:33:54 1105  ) AS
14:33:54 1106  BEGIN
14:33:54 1107  	 PROCS_GROUP_ACCOUNT_CRU_V22.UPDATE_GROUP_ACCOUNT(
14:33:54 1108  	   in_group_account_id => in_group_account_id,
14:33:54 1109  	   in_group_name => in_group_name,
14:33:54 1110  	   in_first_name => in_first_name,
14:33:54 1111  	   in_last_name => in_last_name,
14:33:54 1112  	   in_email => in_email,
14:33:54 1113  	   in_phone => in_phone,
14:33:54 1114  	   in_updated_by => in_updated_by
14:33:54 1115  	 );
14:33:54 1116  END UPDATE_GROUP_ACCOUNT;
14:33:54 1117  
14:33:54 1118  PROCEDURE UPDATE_GROUP_ACCOUNT_SEATS (
14:33:54 1119  	 in_group_account_id	  IN GROUP_ACCOUNT.ID%TYPE,
14:33:54 1120  	 in_seats		  IN GROUP_ACCOUNT.SEATS%TYPE,
14:33:54 1121  	 in_updated_by		  IN GROUP_ACCOUNT.UPDATED_BY%TYPE
14:33:54 1122  ) AS
14:33:54 1123  BEGIN
14:33:54 1124  	 PROCS_GROUP_ACCOUNT_CRU_V22.UPDATE_GROUP_ACCOUNT_SEATS(
14:33:54 1125  	   in_group_account_id => in_group_account_id,
14:33:54 1126  	   in_seats => in_seats,
14:33:54 1127  	   in_updated_by => in_updated_by
14:33:54 1128  	 );
14:33:54 1129  END UPDATE_GROUP_ACCOUNT_SEATS;
14:33:54 1130  
14:33:54 1131  END PROCS_GROUP_ACCOUNT_V22;
14:33:54 1132  .
14:33:54 SQL> /

Warning: Package Body created with compilation errors.

Elapsed: 00:00:00.02
14:33:54 SQL> 
14:33:54 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_TEST_V22" AS
14:33:54   2  
14:33:54   3  PROCEDURE TEST_CLEAR_ALL IS
14:33:54   4  BEGIN
14:33:54   5  	DELETE FROM TAX_ADJUSTMENT;
14:33:54   6  	DELETE FROM LINE_ITEM_ADJUSTMENT;
14:33:54   7  	DELETE FROM INVOICE_ADJUSTMENT;
14:33:54   8  	DELETE FROM LICENSE;
14:33:54   9  	DELETE FROM OFFER_OFFER_CHAIN;
14:33:54  10  	delete from offer_product_offering;
14:33:54  11  	delete from tax;
14:33:54  12  	delete from discount_lineitem_adjustment; -- ? JUnitTests don't clear db in the moment of clear sproc corrections
14:33:54  13  	delete from discount_line_item; -- ?
14:33:54  14  	delete from discount; -- ?
14:33:54  15  	DELETE FROM LINE_ITEM;
14:33:54  16  	DELETE FROM PRODUCT_OFFERING_META_DATA;
14:33:54  17  	DELETE FROM PRODUCT_OFFERING;
14:33:54  18  	DELETE FROM PRODUCT;
14:33:54  19  	DELETE FROM INVOICE_NOTE;
14:33:54  20  	DELETE FROM GIFT_CERTIFICATE;
14:33:54  21  	DELETE FROM OFFER;
14:33:54  22  	DELETE FROM OFFER_CHAIN_META_DATA;
14:33:54  23  	DELETE FROM SUBSCRIPTION_NOTE;
14:33:54  24  	DELETE FROM SUBSCRIPTION_META_DATA;
14:33:54  25  	DELETE FROM SUBSCRIPTION;
14:33:54  26  	DELETE FROM CREDIT_CARD;
14:33:54  27  	DELETE FROM FLAGGED_ACCOUNTS;
14:33:54  28  	DELETE FROM ACCOUNT_NOTE;
14:33:54  29  	DELETE FROM ACCOUNT_LOCK;
14:33:54  30  	DELETE FROM ACCOUNT;
14:33:54  31  	DELETE FROM CHARGE;
14:33:54  32  	DELETE FROM TRANSACTION_ATTEMPT;
14:33:54  33  	DELETE FROM CHARGEBACK;
14:33:54  34  	DELETE FROM TRANSACTION;
14:33:54  35  	DELETE FROM INVOICE_NOTE;
14:33:54  36  	DELETE FROM INVOICE;
14:33:54  37  	DELETE FROM OFFER_CHAIN_ELIGIBILITY;
14:33:54  38  	DELETE FROM OFFER_CHAIN;
14:33:54  39  END TEST_CLEAR_ALL;
14:33:54  40  
14:33:54  41  PROCEDURE TEST_CLEAR_PRODUCTS AS
14:33:54  42  BEGIN
14:33:54  43  	DELETE FROM OFFER_OFFER_CHAIN;
14:33:54  44  	DELETE FROM OFFER_PRODUCT_OFFERING;
14:33:54  45  	DELETE FROM TAX;
14:33:54  46  	DELETE FROM PRODUCT_OFFERING;
14:33:54  47  	DELETE FROM PRODUCT;
14:33:54  48  	DELETE FROM OFFER;
14:33:54  49  	DELETE FROM OFFER_CHAIN_META_DATA;
14:33:54  50  	DELETE FROM OFFER_CHAIN;
14:33:54  51  	DELETE FROM OFFER_CHAIN_ELIGIBILITY;
14:33:54  52  END;
14:33:54  53  
14:33:54  54  /******************************************/
14:33:54  55  
14:33:54  56  PROCEDURE TEST_GET_ACCOUNT (
14:33:54  57  	in_group_id	IN NUMBER,
14:33:54  58  	out_result_set	OUT SYS_REFCURSOR
14:33:54  59  ) AS
14:33:54  60  BEGIN
14:33:54  61  
14:33:54  62  	OPEN out_result_set FOR
14:33:54  63  	SELECT *
14:33:54  64  	FROM
14:33:54  65  	  ACCOUNT
14:33:54  66  	WHERE
14:33:54  67  	  ACCOUNT.GROUP_ID = in_group_id;
14:33:54  68  
14:33:54  69  END TEST_GET_ACCOUNT;
14:33:54  70  
14:33:54  71  /*******************************************/
14:33:54  72  
14:33:54  73  PROCEDURE TEST_GET_SUBSCRIPTION (
14:33:54  74  	in_subscription_id IN NUMBER,
14:33:54  75  	out_result_set	   OUT SYS_REFCURSOR
14:33:54  76  ) AS
14:33:54  77  BEGIN
14:33:54  78  	OPEN out_result_set FOR
14:33:54  79  	SELECT *
14:33:54  80  	FROM
14:33:54  81  	  SUBSCRIPTION
14:33:54  82  	WHERE
14:33:54  83  	  SUBSCRIPTION.ID = in_subscription_id;
14:33:54  84  
14:33:54  85  END TEST_GET_SUBSCRIPTION;
14:33:54  86  
14:33:54  87  /***************************************************/
14:33:54  88  
14:33:54  89  PROCEDURE TEST_DELETE_INVOICE (
14:33:54  90  	in_invoice_id IN NUMBER
14:33:54  91  ) AS
14:33:54  92  var_line_item_id_set SYS_REFCURSOR;
14:33:54  93  var_line_item_id	   NUMBER;
14:33:54  94  
14:33:54  95  var_charge_id_set  SYS_REFCURSOR;
14:33:54  96  var_charge_id	 NUMBER;
14:33:54  97  var_transaction_id NUMBER;
14:33:54  98  BEGIN
14:33:54  99  	-- GET ACCOUNT'S LINE_ITEMS
14:33:54 100  	OPEN var_line_item_id_set FOR
14:33:54 101  	SELECT LINE_ITEM.ID FROM LINE_ITEM WHERE LINE_ITEM.INVOICE_ID = in_invoice_id;
14:33:54 102  	LOOP
14:33:54 103  	  FETCH var_line_item_id_set into var_line_item_id;
14:33:54 104  	  EXIT WHEN var_line_item_id_set%NOTFOUND;
14:33:54 105  
14:33:54 106  	  -- DELETE ADJUSTMENTS
14:33:54 107  	  FOR f_line_item_adjustments IN (SELECT * FROM LINE_ITEM_ADJUSTMENT WHERE LINE_ITEM_ID = var_line_item_id)
14:33:54 108  	  LOOP
14:33:54 109  
14:33:54 110  	    -- DELETE DISCOUNT ADJUSTMENTS
14:33:54 111  	    DELETE FROM DISCOUNT_LINEITEM_ADJUSTMENT WHERE LINE_ITEM_ADJUSTMENT_ID = f_line_item_adjustments.ID;
14:33:54 112  
14:33:54 113  	    -- DELETE TAX ADJUSTMENTS
14:33:54 114  	    DELETE FROM TAX_ADJUSTMENT WHERE LINE_ITEM_ADJUSTMENT_ID = f_line_item_adjustments.ID;
14:33:54 115  	  END LOOP;
14:33:54 116  
14:33:54 117  	  -- DELETE LINE ITEM ADJUSTMENTS
14:33:54 118  	  DELETE FROM LINE_ITEM_ADJUSTMENT WHERE LINE_ITEM_ID = var_line_item_id;
14:33:54 119  
14:33:54 120  	  -- DELETE DISCOUNT_LINE_ITEM
14:33:54 121  	  DELETE FROM DISCOUNT_LINE_ITEM WHERE DISCOUNT_LINE_ITEM.LINE_ITEM_ID = var_line_item_id;
14:33:54 122  
14:33:54 123  	  DELETE FROM TAX WHERE LINE_ITEM_ID = var_line_item_id;
14:33:54 124  
14:33:54 125  	  -- DELETE LINE ITEM
14:33:54 126  	  DELETE FROM LINE_ITEM WHERE LINE_ITEM.ID = var_line_item_id;
14:33:54 127  
14:33:54 128  	END LOOP;
14:33:54 129  
14:33:54 130  	-- DELETE INVOICE ADJUSTMENTS
14:33:54 131  	DELETE FROM INVOICE_ADJUSTMENT WHERE INVOICE_ID = in_invoice_id;
14:33:54 132  
14:33:54 133  	-- GET ACCOUNT'S CHARGES AND TRANSACTIONS
14:33:54 134  	OPEN var_charge_id_set FOR
14:33:54 135  	SELECT CHARGE.ID, CHARGE.TRANSACTION_ID FROM CHARGE WHERE CHARGE.INVOICE_ID = in_invoice_id;
14:33:54 136  	LOOP
14:33:54 137  	  FETCH var_charge_id_set into var_charge_id, var_transaction_id;
14:33:54 138  	  EXIT WHEN var_charge_id_set%NOTFOUND;
14:33:54 139  	  -- DELETE CHARGEBACK
14:33:54 140  	  DELETE FROM CHARGEBACK WHERE CHARGEBACK.TRANSACTION_ID = var_transaction_id;
14:33:54 141  
14:33:54 142  	  -- DELETE TRANSACTION ATTEMP
14:33:54 143  	  DELETE FROM TRANSACTION_ATTEMPT WHERE TRANSACTION_ATTEMPT.TRANSACTION_ID = var_transaction_id;
14:33:54 144  
14:33:54 145  	  -- DELETE CHARGE
14:33:54 146  	  DELETE FROM CHARGE WHERE CHARGE.ID = var_charge_id;
14:33:54 147  
14:33:54 148  	  -- DELETE TRANSACTION
14:33:54 149  	  DELETE FROM TRANSACTION WHERE TRANSACTION.ID = var_transaction_id;
14:33:54 150  	END LOOP;
14:33:54 151  
14:33:54 152  	-- DELETE INVOICE NOTES
14:33:54 153  	DELETE FROM INVOICE_NOTE WHERE INVOICE_NOTE.INVOICE_ID = in_invoice_id;
14:33:54 154  
14:33:54 155  	-- DELETE INVOICE
14:33:54 156  	DELETE FROM INVOICE WHERE INVOICE.ID = in_invoice_id;
14:33:54 157  END;
14:33:54 158  
14:33:54 159  PROCEDURE TEST_DELETE_USER_ACCOUNT (
14:33:54 160  	in_group_id IN NUMBER
14:33:54 161  ) AS
14:33:54 162  -- VARIABLES
14:33:54 163  var_account_id NUMBER;
14:33:54 164  
14:33:54 165  -- CURSORS
14:33:54 166  var_subscription_id_set SYS_REFCURSOR;
14:33:54 167  var_subscription_id     NUMBER;
14:33:54 168  
14:33:54 169  var_license_id_set SYS_REFCURSOR;
14:33:54 170  var_license_id	 NUMBER;
14:33:54 171  var_invoice_id	 NUMBER;
14:33:54 172  
14:33:54 173  var_gift_certificate_id_set SYS_REFCURSOR;
14:33:54 174  var_gift_certificate_id	  NUMBER;
14:33:54 175  var_gc_purchase_invoice_id  NUMBER;
14:33:54 176  BEGIN
14:33:54 177  
14:33:54 178   /*FOR f_account in (
14:33:54 179  	  select id from account where group_id = in_group_id
14:33:54 180  	)
14:33:54 181  	loop
14:33:54 182  
14:33:54 183  	  -- delete account
14:33:54 184  	  delete from account where id = f_account.id;
14:33:54 185  
14:33:54 186  	end loop;*/
14:33:54 187  
14:33:54 188  	BEGIN
14:33:54 189  	  SELECT
14:33:54 190  	    ACCOUNT.ID into var_account_id
14:33:54 191  	  FROM
14:33:54 192  	    ACCOUNT
14:33:54 193  	  WHERE
14:33:54 194  	    ACCOUNT.GROUP_ID = in_group_id;
14:33:54 195  	  EXCEPTION
14:33:54 196  	    WHEN NO_DATA_FOUND THEN
14:33:54 197  	      -- Nothing to do
14:33:54 198  	      RETURN;
14:33:54 199  	END;
14:33:54 200  
14:33:54 201  	-- GET ACCOUNT'S SUBSCRIPTIONS
14:33:54 202  	OPEN var_subscription_id_set FOR
14:33:54 203  	SELECT SUBSCRIPTION.ID FROM SUBSCRIPTION WHERE SUBSCRIPTION.ACCOUNT_ID = var_account_id;
14:33:54 204  	LOOP
14:33:54 205  	  FETCH var_subscription_id_set into var_subscription_id;
14:33:54 206  	  EXIT WHEN var_subscription_id_set%NOTFOUND;
14:33:54 207  
14:33:54 208  	  -- GET ACCOUNT'S LICENSES AND INVOICES
14:33:54 209  	  OPEN var_license_id_set FOR
14:33:54 210  	  SELECT LICENSE.ID, LICENSE.INVOICE_ID FROM LICENSE WHERE LICENSE.SUBSCRIPTION_ID = var_subscription_id;
14:33:54 211  	  LOOP
14:33:54 212  	    FETCH var_license_id_set into var_license_id, var_invoice_id;
14:33:54 213  	    EXIT WHEN var_license_id_set%NOTFOUND;
14:33:54 214  
14:33:54 215  
14:33:54 216  	    -- GET GC WHERE PURCHASE_INVOICE_ID = invoice
14:33:54 217  	    OPEN var_gift_certificate_id_set FOR
14:33:54 218  	    SELECT GIFT_CERTIFICATE.ID, GIFT_CERTIFICATE.PURCHASE_INVOICE_ID FROM GIFT_CERTIFICATE WHERE GIFT_CERTIFICATE.FINALIZED_INVOICE_ID = var_invoice_id;
14:33:54 219  	    LOOP
14:33:54 220  	      FETCH var_gift_certificate_id_set into var_gift_certificate_id, var_gc_purchase_invoice_id;
14:33:54 221  	      EXIT WHEN var_gift_certificate_id_set%NOTFOUND;
14:33:54 222  
14:33:54 223  	      -- DELETE GIFT_CERTIFICATE
14:33:54 224  	      DELETE FROM GIFT_CERTIFICATE WHERE GIFT_CERTIFICATE.ID = var_gift_certificate_id;
14:33:54 225  
14:33:54 226  	      -- DELETE LICENSE
14:33:54 227  	      IF TEST_IS_INVOICE_EXISTS(var_gc_purchase_invoice_id) = 1 THEN
14:33:54 228  		TEST_DELETE_INVOICE(var_gc_purchase_invoice_id);
14:33:54 229  	      END IF;
14:33:54 230  
14:33:54 231  	    END LOOP;
14:33:54 232  
14:33:54 233  	    -- DELETE GIFT_CERTIFICATE WHERE GC.REDEEMER_GROUP_ID = out group_id
14:33:54 234  	    DELETE FROM GIFT_CERTIFICATE WHERE GIFT_CERTIFICATE.REDEEMER_GROUP_ID = in_group_id;
14:33:54 235  
14:33:54 236  	    -- DELETE LICENSE
14:33:54 237  	    DELETE FROM LICENSE WHERE LICENSE.ID = var_license_id;
14:33:54 238  
14:33:54 239  	    -- DELETE INVOICE
14:33:54 240  	    IF TEST_IS_INVOICE_EXISTS(var_invoice_id) = 1 THEN
14:33:54 241  	      TEST_DELETE_INVOICE(var_invoice_id);
14:33:54 242  	    END IF;
14:33:54 243  	  END LOOP;
14:33:54 244  
14:33:54 245  	  -- DELETE SUBSCRIPTION_NOTE
14:33:54 246  	  DELETE FROM SUBSCRIPTION_NOTE WHERE SUBSCRIPTION_NOTE.SUBSCRIPTION_ID = var_subscription_id;
14:33:54 247  
14:33:54 248  	  -- DELETE SUBSCRIPTION META_DATA
14:33:54 249  	  DELETE FROM SUBSCRIPTION_META_DATA WHERE SUBSCRIPTION_META_DATA.SUBSCRIPTION_ID = var_subscription_id;
14:33:54 250  
14:33:54 251  	  -- DELETE SUBSCRIPTION
14:33:54 252  	  DELETE FROM SUBSCRIPTION WHERE SUBSCRIPTION.ID = var_subscription_id;
14:33:54 253  	END LOOP;
14:33:54 254  
14:33:54 255  	-- DELETE CREDIT_CARDS
14:33:54 256  	DELETE FROM CREDIT_CARD WHERE CREDIT_CARD.ACCOUNT_ID = var_account_id;
14:33:54 257  
14:33:54 258  	-- DELETE PAYPAL
14:33:54 259  	DELETE FROM PAYPAL WHERE PAYPAL.ACCOUNT_ID = var_account_id;
14:33:54 260  
14:33:54 261  	-- DELETE FLAGS
14:33:54 262  	DELETE FROM FLAGGED_ACCOUNTS WHERE FLAGGED_ACCOUNTS.ACCOUNT_ID = var_account_id;
14:33:54 263  
14:33:54 264  	-- DELETE ACCOUNT NOTES
14:33:54 265  	DELETE FROM ACCOUNT_NOTE WHERE ACCOUNT_NOTE.ACCOUNT_ID = var_account_id;
14:33:54 266  
14:33:54 267  	-- DELETE INVOICES AND GC'S WHERE USER IS PURCHASER
14:33:54 268  	OPEN var_gift_certificate_id_set FOR
14:33:54 269  	SELECT GIFT_CERTIFICATE.ID, GIFT_CERTIFICATE.PURCHASE_INVOICE_ID FROM GIFT_CERTIFICATE WHERE GIFT_CERTIFICATE.PURCHASER_GROUP_ID = in_group_id;
14:33:54 270  	LOOP
14:33:54 271  	  FETCH var_gift_certificate_id_set into var_gift_certificate_id, var_gc_purchase_invoice_id;
14:33:54 272  	  EXIT WHEN var_gift_certificate_id_set%NOTFOUND;
14:33:54 273  
14:33:54 274  	  -- DELETE GIFT CERTIFICATE
14:33:54 275  	  DELETE FROM GIFT_CERTIFICATE WHERE GIFT_CERTIFICATE.ID = var_gift_certificate_id;
14:33:54 276  
14:33:54 277  	  -- DELETE INVOICE
14:33:54 278  	  IF TEST_IS_INVOICE_EXISTS(var_gc_purchase_invoice_id) = 1 THEN
14:33:54 279  	    TEST_DELETE_INVOICE(var_gc_purchase_invoice_id);
14:33:54 280  	  END IF;
14:33:54 281  	END LOOP;
14:33:54 282  
14:33:54 283  	-- DELETE LOCKS
14:33:54 284  	DELETE FROM ACCOUNT_LOCK WHERE ACCOUNT_ID = var_account_id;
14:33:54 285  
14:33:54 286  	-- DELETE ACCOUNT
14:33:54 287  	DELETE FROM ACCOUNT WHERE ACCOUNT.ID = var_account_id;
14:33:54 288  
14:33:54 289  END TEST_DELETE_USER_ACCOUNT;
14:33:54 290  
14:33:54 291  PROCEDURE TEST_DELETE_USER_ACCOUNTS  (
14:33:54 292  	in_start_group_id IN NUMBER,
14:33:54 293  	in_end_group_id   IN NUMBER
14:33:54 294  ) IS
14:33:54 295   gid ACCOUNT.GROUP_ID%TYPE;
14:33:54 296   CURSOR c (v_from NUMBER, v_to NUMBER) IS SELECT ACCOUNT.GROUP_ID FROM ACCOUNT WHERE GROUP_ID BETWEEN v_from AND v_to;
14:33:54 297  BEGIN
14:33:54 298  -- arosolovskiy refactoring: call delete_user_account only "COUNT(group_id) WHERE ...." times instead of "in_end_group_id - in_start_group_id" times;
14:33:54 299  	/*
14:33:54 300  	FOR var_group_id IN in_start_group_id..in_end_group_id
14:33:54 301  	LOOP
14:33:54 302  	  TEST_DELETE_USER_ACCOUNT(var_group_id);
14:33:54 303  	END LOOP;*/
14:33:54 304  	OPEN c(in_start_group_id, in_end_group_id);
14:33:54 305  	WHILE c%ISOPEN LOOP
14:33:54 306  	  FETCH c INTO gid;
14:33:54 307  	  IF c%NOTFOUND THEN
14:33:54 308  	   CLOSE c;
14:33:54 309  	  END IF;
14:33:54 310  	  TEST_DELETE_USER_ACCOUNT(gid);
14:33:54 311  	END LOOP;
14:33:54 312  END;
14:33:54 313  
14:33:54 314  /**********************************************************/
14:33:54 315  
14:33:54 316  FUNCTION TEST_IS_INVOICE_EXISTS(
14:33:54 317  /*
14:33:54 318  1 - exists
14:33:54 319  0 - not exists
14:33:54 320  */
14:33:54 321  	in_invoice_id IN NUMBER
14:33:54 322  ) RETURN NUMBER AS
14:33:54 323  var_invoice_count NUMBER;
14:33:54 324  BEGIN
14:33:54 325  	SELECT
14:33:54 326  	  COUNT(*) into var_invoice_count
14:33:54 327  	FROM
14:33:54 328  	  INVOICE
14:33:54 329  	WHERE
14:33:54 330  	  INVOICE.ID = in_invoice_id;
14:33:54 331  	IF var_invoice_count = 0 THEN
14:33:54 332  	  RETURN 0;
14:33:54 333  	ELSE
14:33:54 334  	  RETURN 1;
14:33:54 335  	END IF;
14:33:54 336  END;
14:33:54 337  
14:33:54 338  PROCEDURE TEST_GET_INVOICE_INFO (
14:33:54 339  	in_invoice_id  IN NUMBER,
14:33:54 340  	out_result_set OUT SYS_REFCURSOR
14:33:54 341  ) AS
14:33:54 342  SPROC_NAME      CONSTANT VARCHAR2(21) := 'TEST_GET_INVOICE_INFO';
14:33:54 343  BEGIN
14:33:54 344  
14:33:54 345  	 OPEN out_result_set FOR SELECT
14:33:54 346  	    in_invoice_id AS "INVOICE_ID",
14:33:54 347  	    INVOICE.INVOICE_STATUS_ID,
14:33:54 348  	    PROCS_INVOICE_V22.F_CALCULATE_INVOICE_AMOUNT(in_invoice_id) AS "INVOICE_AMOUNT",
14:33:54 349  	    CHARGE.ID AS "CHARGE_ID",
14:33:54 350  	    CHARGE.CHARGE_AMOUNT,
14:33:54 351  	    CHARGE.TRANSACTION_ID,
14:33:54 352  	    TRANSACTION.TRANSACTION_STATUS_ID
14:33:54 353  	  FROM CHARGE INNER JOIN INVOICE ON INVOICE.ID = CHARGE.INVOICE_ID INNER JOIN TRANSACTION ON TRANSACTION.ID = CHARGE.TRANSACTION_ID WHERE CHARGE.INVOICE_ID = in_invoice_id ORDER BY INVOICE.ID, CHARGE.ID, TRANSACTION.ID;
14:33:54 354  
14:33:54 355  END TEST_GET_INVOICE_INFO;
14:33:54 356  
14:33:54 357  /******************************************************************************/
14:33:54 358  
14:33:54 359  PROCEDURE TEST_DELETE_OFFER_CHAIN(
14:33:54 360  	in_offer_chain_id in number
14:33:54 361  ) as
14:33:54 362  begin
14:33:54 363  
14:33:54 364  	for v_offer_chain in (
14:33:54 365  	  select och.id from offer_chain och where och.id = in_offer_chain_id
14:33:54 366  	)
14:33:54 367  	loop
14:33:54 368  
14:33:54 369  	  for v_offer in (
14:33:54 370  	    select offer_id as id from offer_offer_chain where offer_chain_id = v_offer_chain.id
14:33:54 371  	  )
14:33:54 372  	  loop
14:33:54 373  
14:33:54 374  	    for v_product_offering in (
14:33:54 375  	      select
14:33:54 376  		product_offering.id,
14:33:54 377  		product_offering.product_id
14:33:54 378  	      from
14:33:54 379  		offer_product_offering
14:33:54 380  		inner join product_offering on offer_product_offering.product_offering_id = product_offering.id
14:33:54 381  	      where offer_product_offering.offer_id = v_offer.id
14:33:54 382  	    )
14:33:54 383  	    loop
14:33:54 384  
14:33:54 385  	      -- delete product eligibility
14:33:54 386  	      delete from product_eligibility where product_id = v_product_offering.product_id;
14:33:54 387  
14:33:54 388  	      -- delete meta data
14:33:54 389  	      delete from product_offering_meta_data where product_offering_id = v_product_offering.id;
14:33:54 390  
14:33:54 391  	      -- delete product
14:33:54 392  	      delete from product where id = v_product_offering.product_id;
14:33:54 393  
14:33:54 394  	      -- delete product_offering
14:33:54 395  	      delete from product_offering where id = v_product_offering.id;
14:33:54 396  
14:33:54 397  	    end loop;
14:33:54 398  
14:33:54 399  	    -- delete data from offer_product_offering table
14:33:54 400  	    delete from offer_product_offering where offer_id = v_offer.id;
14:33:54 401  
14:33:54 402  	    -- delete data from offer_offer_chain table
14:33:54 403  	    delete from offer_offer_chain where offer_chain_id = v_offer_chain.id;
14:33:54 404  
14:33:54 405  	    -- delete offer
14:33:54 406  	    delete from offer where id = v_offer.id;
14:33:54 407  
14:33:54 408  	  end loop;
14:33:54 409  
14:33:54 410  	  -- delete offer_chain_eligibility
14:33:54 411  	  delete from offer_chain_eligibility where offer_chain_id = v_offer_chain.id;
14:33:54 412  
14:33:54 413  	  -- delete metadata
14:33:54 414  	  delete from offer_chain_meta_data where offer_chain_id = v_offer_chain.id;
14:33:54 415  
14:33:54 416  	  -- delete offer chain
14:33:54 417  	  delete from offer_chain where id = v_offer_chain.id;
14:33:54 418  
14:33:54 419  	end loop;
14:33:54 420  
14:33:54 421  end;
14:33:54 422  
14:33:54 423  END PROCS_TEST_V22;
14:33:54 424  .
14:33:54 SQL> /

Package body created.

Elapsed: 00:00:00.06
14:33:54 SQL> 
14:33:54 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_ACCOUNT_V22" AS
14:33:54   2  
14:33:54   3  PROCEDURE INVOICE_IDS_BY_GROUP_ID (
14:33:54   4  	in_group_id    IN  NUMBER,
14:33:54   5  	out_result_set OUT SYS_REFCURSOR
14:33:54   6  ) AS
14:33:54   7  SPROC_NAME CONSTANT VARCHAR2(32) := 'INVOICE_IDS_BY_GROUP_ID';
14:33:54   8  BEGIN
14:33:54   9  	OPEN out_result_set FOR
14:33:54  10  	SELECT
14:33:54  11  	  Invoice.Id
14:33:54  12  	FROM
14:33:54  13  	  LICENSE
14:33:54  14  	  INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
14:33:54  15  	  INNER JOIN INVOICE ON LICENSE.INVOICE_ID = INVOICE.ID
14:33:54  16  	  INNER JOIN OFFER_CHAIN ON SUBSCRIPTION.OFFER_CHAIN_ID = OFFER_CHAIN.ID
14:33:54  17  	  INNER JOIN INVOICE_STATUS ON INVOICE.INVOICE_STATUS_ID = INVOICE_STATUS.ID
14:33:54  18  	Where
14:33:54  19  	  SUBSCRIPTION.ACCOUNT_ID IN (SELECT ID FROM ACCOUNT WHERE GROUP_ID = in_group_id) AND
14:33:54  20  	  INVOICE.INVOICE_STATUS_ID = GLOBAL_STATUSES_V22.INVOICE_OPEN;
14:33:54  21  END INVOICE_IDS_BY_GROUP_ID;
14:33:54  22  
14:33:54  23  FUNCTION GET_GRACE_START_DATE(
14:33:54  24  	in_subscription_id IN NUMBER
14:33:54  25  ) RETURN DATE AS
14:33:54  26  SPROC_NAME	   CONSTANT VARCHAR2(32) := 'GET_GRACE_START_DATE';
14:33:54  27  grace_start_date_var DATE;
14:33:54  28  BEGIN
14:33:54  29  	SELECT GRACE_START_DATE into grace_start_date_var
14:33:54  30  	FROM
14:33:54  31  	  (
14:33:54  32  	    SELECT
14:33:54  33  	      GRACE_START_DATE
14:33:54  34  	    FROM
14:33:54  35  	      LICENSE
14:33:54  36  	    WHERE
14:33:54  37  	      LICENSE.SUBSCRIPTION_ID = in_subscription_id
14:33:54  38  	    ORDER BY
14:33:54  39  	      LICENSE.END_DATE DESC
14:33:54  40  	  )
14:33:54  41  	WHERE
14:33:54  42  	  ROWNUM <= 1;
14:33:54  43  
14:33:54  44  	RETURN grace_start_date_var;
14:33:54  45  END GET_GRACE_START_DATE;
14:33:54  46  
14:33:54  47  FUNCTION GET_GRACE_END_DATE(
14:33:54  48  	in_subscription_id IN NUMBER
14:33:54  49  ) RETURN DATE AS
14:33:54  50  SPROC_NAME	 CONSTANT VARCHAR2(32) := 'GET_GRACE_END_DATE';
14:33:54  51  grace_end_date_var DATE;
14:33:54  52  BEGIN
14:33:54  53  	SELECT GRACE_END_DATE into grace_end_date_var
14:33:54  54  	FROM
14:33:54  55  	  (
14:33:54  56  	    SELECT
14:33:54  57  	      GRACE_END_DATE
14:33:54  58  	    FROM
14:33:54  59  	      LICENSE
14:33:54  60  	    WHERE
14:33:54  61  	      LICENSE.SUBSCRIPTION_ID = in_subscription_id
14:33:54  62  	    ORDER BY
14:33:54  63  	      LICENSE.END_DATE DESC
14:33:54  64  	  )
14:33:54  65  	WHERE ROWNUM <= 1;
14:33:54  66  
14:33:54  67  	RETURN grace_end_date_var;
14:33:54  68  END GET_GRACE_END_DATE;
14:33:54  69  
14:33:54  70  
14:33:54  71  
14:33:54  72  PROCEDURE ANNOTATE_ACCOUNT (
14:33:54  73  	in_group_id   IN  NUMBER,
14:33:54  74  	in_agent_id   IN  NUMBER,
14:33:54  75  	in_note       IN  VARCHAR2,
14:33:54  76  	in_created_by IN  VARCHAR2
14:33:54  77  ) AS
14:33:54  78  SPROC_NAME  CONSTANT VARCHAR2(16) := 'ANNOTATE_ACCOUNT';
14:33:54  79  -- VARIABLES
14:33:54  80  var_account_id	  NUMBER;
14:33:54  81  var_account_note_id NUMBER;
14:33:54  82  -- EXCEPTIONS
14:33:54  83  BAD_ACCOUNT_ID EXCEPTION;
14:33:54  84  BEGIN
14:33:54  85  
14:33:54  86  	-- Get account id
14:33:54  87  	BEGIN
14:33:54  88  	  SELECT
14:33:54  89  	    ACCOUNT.ID into var_account_id
14:33:54  90  	  FROM
14:33:54  91  	    ACCOUNT
14:33:54  92  	  WHERE
14:33:54  93  	    ACCOUNT.GROUP_ID = in_group_id;
14:33:54  94  	  EXCEPTION
14:33:54  95  	    WHEN NO_DATA_FOUND THEN
14:33:54  96  	      RAISE BAD_ACCOUNT_ID;
14:33:54  97  	END;
14:33:54  98  
14:33:54  99  	-- Insert new row into ACCOUNT_NOTE table
14:33:54 100  	PROCS_ACCOUNT_CRU_V22.CREATE_ACCOUNT_NOTE(
14:33:54 101  	  inout_account_note_id => var_account_note_id,
14:33:54 102  	  in_agent_id		=> in_agent_id,
14:33:54 103  	  in_account_id 	=> var_account_id,
14:33:54 104  	  in_note		=> in_note,
14:33:54 105  	  in_created_by 	=> in_created_by
14:33:54 106  	);
14:33:54 107  
14:33:54 108  EXCEPTION
14:33:54 109  WHEN BAD_ACCOUNT_ID THEN
14:33:54 110  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 111  	  SPROC_NAME, 'No such group id');
14:33:54 112  WHEN OTHERS THEN
14:33:54 113  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 114  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 115  END ANNOTATE_ACCOUNT;
14:33:54 116  
14:33:54 117  PROCEDURE ASSERT_ACCOUNT_EXISTS (
14:33:54 118  	in_group_id IN	NUMBER,
14:33:54 119  	out_exists  OUT NUMBER
14:33:54 120  ) AS
14:33:54 121  -- VARIABLES
14:33:54 122  var_found_id  NUMBER;
14:33:54 123  SPROC_NAME    CONSTANT VARCHAR2(21) := 'ASSERT_ACCOUNT_EXISTS';
14:33:54 124  BEGIN
14:33:54 125  	SELECT ACCOUNT.ID INTO var_found_id FROM ACCOUNT WHERE ACCOUNT.GROUP_ID = in_group_id;
14:33:54 126  	out_exists := GLOBAL_CONSTANTS_V22.TRUE;
14:33:54 127  EXCEPTION
14:33:54 128  WHEN NO_DATA_FOUND THEN
14:33:54 129  	out_exists := GLOBAL_CONSTANTS_V22.FALSE;
14:33:54 130  WHEN OTHERS THEN
14:33:54 131  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 132  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 133  END ASSERT_ACCOUNT_EXISTS;
14:33:54 134  
14:33:54 135  PROCEDURE DISABLE_ACCOUNT (
14:33:54 136  	in_group_id   IN NUMBER,
14:33:54 137  	in_updated_by IN VARCHAR2,
14:33:54 138  	in_note       IN VARCHAR2,
14:33:54 139  	in_agent_id   IN NUMBER
14:33:54 140  ) AS
14:33:54 141  SPROC_NAME	      CONSTANT VARCHAR2(15) := 'DISABLE_ACCOUNT';
14:33:54 142  var_account_id	      NUMBER;
14:33:54 143  current_account_status  NUMBER;
14:33:54 144  
14:33:54 145  var_active_subscriptions_num NUMBER;
14:33:54 146  var_pending_invoices_num	   NUMBER;
14:33:54 147  
14:33:54 148  -- EXCEPTIONS
14:33:54 149  BAD_ACOUNT_ID		EXCEPTION;
14:33:54 150  BAD_CURRENT_ACC_STATUS	EXCEPTION;
14:33:54 151  PENDING_INVOICES_FOUND	EXCEPTION;
14:33:54 152  ACCOUNT_HAS_ACIVE_SUBSCRS EXCEPTION;
14:33:54 153  CAN_NOT_ANNOTATE_ACCOUNT	EXCEPTION;
14:33:54 154  EXCEPTION_MESSAGE 	VARCHAR2(1024);
14:33:54 155  BEGIN
14:33:54 156  
14:33:54 157  	-- Get account's status and id
14:33:54 158  	BEGIN
14:33:54 159  	  SELECT
14:33:54 160  	    ACCOUNT.ACCOUNT_STATUS_ID,
14:33:54 161  	    ACCOUNT.ID
14:33:54 162  	  INTO
14:33:54 163  	    current_account_status,
14:33:54 164  	    var_account_id
14:33:54 165  	  FROM ACCOUNT
14:33:54 166  	  WHERE
14:33:54 167  	    ACCOUNT.GROUP_ID = in_group_id;
14:33:54 168  	  EXCEPTION
14:33:54 169  	    WHEN NO_DATA_FOUND THEN
14:33:54 170  	      RAISE BAD_ACOUNT_ID;
14:33:54 171  	END;
14:33:54 172  
14:33:54 173  	-- For now, we can disable account whenever
14:33:54 174  	IF current_account_status = GLOBAL_STATUSES_V22.ACCOUNT_DISABLED THEN
14:33:54 175  	  RAISE BAD_CURRENT_ACC_STATUS;
14:33:54 176  	END IF;
14:33:54 177  
14:33:54 178  	-- Checks for out outstanding balances
14:33:54 179  	-- CHECK: No outstanding balances. If monies are due, then we can not cancel account. Return ERROR.
14:33:54 180  	SELECT
14:33:54 181  	  COUNT(*) into var_pending_invoices_num
14:33:54 182  	FROM
14:33:54 183  	  LICENSE
14:33:54 184  	    INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
14:33:54 185  	    INNER JOIN INVOICE ON LICENSE.INVOICE_ID = INVOICE.ID
14:33:54 186  	WHERE
14:33:54 187  	  SUBSCRIPTION.ACCOUNT_ID = var_account_id
14:33:54 188  	  AND INVOICE.INVOICE_STATUS_ID IN ( SELECT GLOBAL_STATUSES_V22.INVOICE_OPEN FROM DUAL );
14:33:54 189  
14:33:54 190  	IF var_pending_invoices_num > 0 THEN
14:33:54 191  	  RAISE PENDING_INVOICES_FOUND;
14:33:54 192  	END IF;
14:33:54 193  
14:33:54 194  	SELECT
14:33:54 195  	  COUNT(*) into var_active_subscriptions_num
14:33:54 196  	FROM
14:33:54 197  	  SUBSCRIPTION
14:33:54 198  	WHERE
14:33:54 199  	  SUBSCRIPTION.ACCOUNT_ID = var_account_id
14:33:54 200  	  AND (
14:33:54 201  	    SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE
14:33:54 202  	    OR SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_SUSPENDED
14:33:54 203  	    OR SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_IN_GRACE_PERIOD);
14:33:54 204  
14:33:54 205  	IF var_active_subscriptions_num > 0 THEN
14:33:54 206  	  RAISE ACCOUNT_HAS_ACIVE_SUBSCRS;
14:33:54 207  	END IF;
14:33:54 208  
14:33:54 209  	PROCS_ACCOUNT_V22.UPDATE_ACCOUNT_STATUS(
14:33:54 210  	  in_account_id        => var_account_id,
14:33:54 211  	  in_account_status_id => GLOBAL_STATUSES_V22.ACCOUNT_DISABLED,
14:33:54 212  	  in_updated_by        => in_updated_by
14:33:54 213  	);
14:33:54 214  
14:33:54 215  	-- Annotate account
14:33:54 216  	IF in_note IS NOT NULL THEN
14:33:54 217  	  BEGIN
14:33:54 218  	    PROCS_ACCOUNT_V22.ANNOTATE_ACCOUNT(
14:33:54 219  	      in_group_id   => in_group_id,
14:33:54 220  	      in_agent_id   => in_agent_id,
14:33:54 221  	      in_note	    => in_note,
14:33:54 222  	      in_created_by => in_updated_by
14:33:54 223  	    );
14:33:54 224  	    EXCEPTION
14:33:54 225  	      WHEN OTHERS THEN
14:33:54 226  		EXCEPTION_MESSAGE := SQLERRM;
14:33:54 227  		RAISE CAN_NOT_ANNOTATE_ACCOUNT;
14:33:54 228  	  END;
14:33:54 229  	END IF;
14:33:54 230  
14:33:54 231  EXCEPTION
14:33:54 232  WHEN ACCOUNT_HAS_ACIVE_SUBSCRS THEN
14:33:54 233  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 234  	  SPROC_NAME, 'Account has active or suspended subsciptions');
14:33:54 235  WHEN BAD_CURRENT_ACC_STATUS THEN
14:33:54 236  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:54 237  	  SPROC_NAME, 'Current account status is "disabled". Can not disable it one more time.');
14:33:54 238  WHEN PENDING_INVOICES_FOUND THEN
14:33:54 239  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 240  	  SPROC_NAME, 'Opened/Pending invoices founded');
14:33:54 241  WHEN BAD_ACOUNT_ID THEN
14:33:54 242  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 243  	  SPROC_NAME, 'No such account');
14:33:54 244  WHEN CAN_NOT_ANNOTATE_ACCOUNT THEN
14:33:54 245  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 246  	  SPROC_NAME, 'Could not annotate account', EXCEPTION_MESSAGE);
14:33:54 247  WHEN OTHERS THEN
14:33:54 248  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 249  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 250  END DISABLE_ACCOUNT;
14:33:54 251  
14:33:54 252  PROCEDURE CREATE_ACTIVE_ACCOUNT(
14:33:54 253  	in_group_id	   IN  ACCOUNT.GROUP_ID%TYPE,
14:33:54 254  	in_created_by	   IN  ACCOUNT.CREATED_BY%TYPE,
14:33:54 255  	out_new_account_id OUT ACCOUNT.ID%TYPE
14:33:54 256  ) AS
14:33:54 257  SPROC_NAME CONSTANT VARCHAR2(32) := 'CREATE_ACTIVE_ACCOUNT';
14:33:54 258  var_count  NUMBER  := 0;
14:33:54 259  BEGIN
14:33:54 260  	SELECT COUNT(1) INTO var_count FROM ACCOUNT WHERE GROUP_ID = in_group_id;
14:33:54 261  
14:33:54 262  	IF (var_count = 0) THEN
14:33:54 263  	  PROCS_ACCOUNT_CRU_V22.CREATE_ACCOUNT(
14:33:54 264  	      out_account_id	    => out_new_account_id,
14:33:54 265  	      in_account_status_id  => GLOBAL_STATUSES_V22.ACCOUNT_ACTIVE,
14:33:54 266  	      in_group_id	    => in_group_id,
14:33:54 267  	      in_created_by	    => in_created_by,
14:33:54 268  	      in_system_category_id => GLOBAL_ENUMS_V22.SYSTEM_CATEGORY_LIVE
14:33:54 269  	  );
14:33:54 270  	ELSE
14:33:54 271  	  out_new_account_id := NULL;
14:33:54 272  	END IF;
14:33:54 273  END CREATE_ACTIVE_ACCOUNT;
14:33:54 274  
14:33:54 275  PROCEDURE REACTIVATE_ACCOUNT (
14:33:54 276  	in_group_id   IN NUMBER,
14:33:54 277  	in_updated_by IN VARCHAR2,
14:33:54 278  	in_note       IN VARCHAR2,
14:33:54 279  	in_agent_id   IN NUMBER
14:33:54 280  ) AS
14:33:54 281  -- VARIABLES
14:33:54 282  SPROC_NAME	      CONSTANT VARCHAR2(18) := 'REACTIVATE_ACCOUNT';
14:33:54 283  var_account_id	      NUMBER;
14:33:54 284  current_account_status  NUMBER;
14:33:54 285  
14:33:54 286  -- EXCEPTIONS
14:33:54 287  BAD_CURRENT_ACC_STATUS EXCEPTION;
14:33:54 288  CAN_NOT_CREATE_NOTE    EXCEPTION;
14:33:54 289  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:54 290  BEGIN
14:33:54 291  	-- Get account id, status
14:33:54 292  	SELECT
14:33:54 293  	  ACCOUNT.ACCOUNT_STATUS_ID,
14:33:54 294  	  ACCOUNT.ID
14:33:54 295  	INTO
14:33:54 296  	  current_account_status,
14:33:54 297  	  var_account_id
14:33:54 298  	FROM ACCOUNT
14:33:54 299  	WHERE
14:33:54 300  	  ACCOUNT.GROUP_ID = in_group_id;
14:33:54 301  
14:33:54 302  	IF current_account_status != GLOBAL_STATUSES_V22.ACCOUNT_FROZEN THEN
14:33:54 303  	  RAISE BAD_CURRENT_ACC_STATUS;
14:33:54 304  	END IF;
14:33:54 305  
14:33:54 306  	-- Change account status
14:33:54 307  	PROCS_ACCOUNT_V22.UPDATE_ACCOUNT_STATUS(
14:33:54 308  	  in_account_id        => var_account_id,
14:33:54 309  	  in_updated_by        => in_updated_by,
14:33:54 310  	  in_account_status_id => GLOBAL_STATUSES_V22.ACCOUNT_ACTIVE
14:33:54 311  	);
14:33:54 312  
14:33:54 313  	-- Add note
14:33:54 314  	BEGIN
14:33:54 315  	  PROCS_ACCOUNT_V22.ANNOTATE_ACCOUNT(
14:33:54 316  	    in_group_id   => in_group_id,
14:33:54 317  	    in_agent_id   => in_agent_id,
14:33:54 318  	    in_note	  => in_note,
14:33:54 319  	    in_created_by => in_updated_by
14:33:54 320  	  );
14:33:54 321  	  EXCEPTION
14:33:54 322  	    WHEN OTHERS THEN
14:33:54 323  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:54 324  	      RAISE CAN_NOT_CREATE_NOTE;
14:33:54 325  	END;
14:33:54 326  
14:33:54 327  EXCEPTION
14:33:54 328  WHEN BAD_CURRENT_ACC_STATUS THEN
14:33:54 329  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:54 330  	  SPROC_NAME, 'Current account status is not "frozen"');
14:33:54 331  WHEN NO_DATA_FOUND THEN
14:33:54 332  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 333  	  SPROC_NAME, 'Could not find account with given group ID');
14:33:54 334  WHEN CAN_NOT_CREATE_NOTE THEN
14:33:54 335  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 336  	  SPROC_NAME, 'Could not annotate account');
14:33:54 337  WHEN OTHERS THEN
14:33:54 338  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 339  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 340  END REACTIVATE_ACCOUNT;
14:33:54 341  
14:33:54 342  PROCEDURE GET_ACCOUNT_CREDIT_CARDS (
14:33:54 343  	in_group_id    IN ACCOUNT.GROUP_ID%TYPE,
14:33:54 344  	in_status_id   IN CREDIT_CARD.CREDIT_CARD_STATUS_ID%TYPE DEFAULT GLOBAL_STATUSES_V22.CREDIT_CARD_ACTIVE,
14:33:54 345  	out_result_set OUT SYS_REFCURSOR
14:33:54 346  ) AS
14:33:54 347  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_ACCOUNT_CREDIT_CARDS';
14:33:54 348  BEGIN
14:33:54 349  	OPEN out_result_set FOR
14:33:54 350  	  SELECT
14:33:54 351  	    CREDIT_CARD.ID,
14:33:54 352  	    CREDIT_CARD.ACCOUNT_ID,
14:33:54 353  	    CREDIT_CARD.INSTRUMENT_NAME,
14:33:54 354  	    CREDIT_CARD.PRIVATE_CARD_HOLDER_NAME,
14:33:54 355  	    CREDIT_CARD.PRIVATE_STREET_ADDRESS,
14:33:54 356  	    CREDIT_CARD.PRIVATE_STREET_ADDRESS2,
14:33:54 357  	    CREDIT_CARD.STATE,
14:33:54 358  	    CREDIT_CARD.CITY,
14:33:54 359  	    CREDIT_CARD.POSTAL_CODE,
14:33:54 360  	    CREDIT_CARD.COUNTRY,
14:33:54 361  	    CREDIT_CARD.LAST_FOUR_CC,
14:33:54 362  	    CREDIT_CARD.EXPIRATION_DATE,
14:33:54 363  	    CREDIT_CARD.CREDIT_CARD_TYPE_ID,
14:33:54 364  	    CREDIT_CARD.SECRET_TOKEN,
14:33:54 365  	    CREDIT_CARD.CREATE_DATE,
14:33:54 366  	    CREDIT_CARD.CREATED_BY,
14:33:54 367  	    CREDIT_CARD.UPDATE_DATE,
14:33:54 368  	    CREDIT_CARD.UPDATED_BY,
14:33:54 369  	    CREDIT_CARD.CREDIT_CARD_STATUS_ID,
14:33:54 370  	    CREDIT_CARD.PRIVATE_FIRST_NAME,
14:33:54 371  	    Credit_Card.Private_Last_Name,
14:33:54 372  	    decode((SELECT Instrument_Id FROM ACCOUNT WHERE group_id = in_group_id and Instrument_Id = CREDIT_CARD.ID),null,'false', 'true') is_default
14:33:54 373  	  From
14:33:54 374  	      CREDIT_CARD left join account on account.id = CREDIT_CARD.Account_Id
14:33:54 375  	  Where
14:33:54 376  	    Account.Group_Id = in_group_id
14:33:54 377  	    AND CREDIT_CARD.CREDIT_CARD_STATUS_ID = in_status_id;
14:33:54 378  END GET_ACCOUNT_CREDIT_CARDS;
14:33:54 379  
14:33:54 380  PROCEDURE GET_ACCOUNT_GIFT_CERTIFICATES (
14:33:54 381  	in_group_id	  IN NUMBER,
14:33:54 382  	out_result_gc_set OUT SYS_REFCURSOR,
14:33:54 383  	in_instr_status   IN NUMBER DEFAULT GLOBAL_CONSTANTS_V22.TRUE
14:33:54 384  ) AS
14:33:54 385  SPROC_NAME     CONSTANT VARCHAR2(29) := 'GET_ACCOUNT_GIFT_CERTIFICATES';
14:33:54 386  var_account_id NUMBER;
14:33:54 387  
14:33:54 388  -- Exceptions
14:33:54 389  WRONG_INSTR_EXCEPTION	 EXCEPTION;
14:33:54 390  BEGIN
14:33:54 391  
14:33:54 392  	-- Get account id
14:33:54 393  	SELECT
14:33:54 394  	  ACCOUNT.ID INTO var_account_id
14:33:54 395  	FROM
14:33:54 396  	  ACCOUNT
14:33:54 397  	WHERE
14:33:54 398  	  ACCOUNT.GROUP_ID = in_group_id;
14:33:54 399  
14:33:54 400  	-- Check that incoming data is correct
14:33:54 401  	IF in_instr_status != GLOBAL_CONSTANTS_V22.TRUE AND in_instr_status != GLOBAL_CONSTANTS_V22.FALSE THEN
14:33:54 402  	  RAISE WRONG_INSTR_EXCEPTION;
14:33:54 403  	END IF;
14:33:54 404  
14:33:54 405  	OPEN out_result_gc_set FOR
14:33:54 406  	SELECT
14:33:54 407  	  GIFT_CERTIFICATE.ID,
14:33:54 408  	  GIFT_CERTIFICATE.PURCHASER_GROUP_ID,
14:33:54 409  	  GIFT_CERTIFICATE.PURCHASE_INVOICE_ID,
14:33:54 410  	  GIFT_CERTIFICATE.PURCHASE_DATE,
14:33:54 411  	  GIFT_CERTIFICATE.OFFER_CHAIN_ID,
14:33:54 412  	  GIFT_CERTIFICATE.EXPIRATION_DATE,
14:33:54 413  	  GIFT_CERTIFICATE.GIFT_CERTIFICATE_STATUS_ID,
14:33:54 414  	  GIFT_CERTIFICATE.CODE,
14:33:54 415  	  GIFT_CERTIFICATE.CREATE_DATE,
14:33:54 416  	  GIFT_CERTIFICATE.CREATED_BY,
14:33:54 417  	  GIFT_CERTIFICATE.UPDATE_DATE,
14:33:54 418  	  GIFT_CERTIFICATE.UPDATED_BY,
14:33:54 419  	  GIFT_CERTIFICATE.RECIPIENT_NAME,
14:33:54 420  	  GIFT_CERTIFICATE.RECIPIENT_EMAIL,
14:33:54 421  	  GIFT_CERTIFICATE.SENDER_NAME,
14:33:54 422  	  GIFT_CERTIFICATE.SENDER_EMAIL,
14:33:54 423  	  GIFT_CERTIFICATE.REDEEMER_GROUP_ID,
14:33:54 424  	  GIFT_CERTIFICATE.REDEMPTION_DATE,
14:33:54 425  	  GIFT_CERTIFICATE.FINALIZED_INVOICE_ID,
14:33:54 426  	  GIFT_CERTIFICATE.GIFT_MESSAGE
14:33:54 427  	FROM
14:33:54 428  	  GIFT_CERTIFICATE
14:33:54 429  	WHERE
14:33:54 430  	  GIFT_CERTIFICATE.PURCHASER_GROUP_ID = in_group_id
14:33:54 431  	  AND (
14:33:54 432  		( in_instr_status = GLOBAL_CONSTANTS_V22.TRUE AND
14:33:54 433  		  (
14:33:54 434  		    GIFT_CERTIFICATE.EXPIRATION_DATE >= current_date
14:33:54 435  		    AND GIFT_CERTIFICATE.GIFT_CERTIFICATE_STATUS_ID = GLOBAL_STATUSES_V22.GIFT_CERTIFICATE_ACTIVE
14:33:54 436  		  )
14:33:54 437  		)
14:33:54 438  		OR
14:33:54 439  		(
14:33:54 440  		  in_instr_status = GLOBAL_CONSTANTS_V22.FALSE AND
14:33:54 441  		  (
14:33:54 442  		    GIFT_CERTIFICATE.EXPIRATION_DATE < current_date
14:33:54 443  		    OR GIFT_CERTIFICATE.GIFT_CERTIFICATE_STATUS_ID != GLOBAL_STATUSES_V22.GIFT_CERTIFICATE_ACTIVE
14:33:54 444  		  )
14:33:54 445  		)
14:33:54 446  	      );
14:33:54 447  
14:33:54 448  EXCEPTION
14:33:54 449  WHEN NO_DATA_FOUND THEN
14:33:54 450  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 451  	  SPROC_NAME, 'Can not find account with given group id');
14:33:54 452  WHEN WRONG_INSTR_EXCEPTION THEN
14:33:54 453  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:54 454  	  SPROC_NAME, 'Wrong gift certificate type');
14:33:54 455  WHEN OTHERS THEN
14:33:54 456  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 457  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 458  END GET_ACCOUNT_GIFT_CERTIFICATES;
14:33:54 459  
14:33:54 460  PROCEDURE GET_ACCOUNT_INFO  (
14:33:54 461  	  in_group_id	    IN	NUMBER,
14:33:54 462  	  out_account_info  OUT SYS_REFCURSOR
14:33:54 463  ) AS
14:33:54 464  SPROC_NAME      CONSTANT VARCHAR2(16) := 'GET_ACCOUNT_INFO';
14:33:54 465  var_account_id  NUMBER;
14:33:54 466  BEGIN
14:33:54 467  
14:33:54 468  	-- Get account id
14:33:54 469  	SELECT
14:33:54 470  	  ACCOUNT.ID INTO var_account_id
14:33:54 471  	FROM
14:33:54 472  	  ACCOUNT
14:33:54 473  	WHERE
14:33:54 474  	  ACCOUNT.GROUP_ID = in_group_id;
14:33:54 475  
14:33:54 476  	-- Get account info
14:33:54 477  	OPEN out_account_info FOR
14:33:54 478  	  SELECT
14:33:54 479  	    ACCOUNT.ACCOUNT_STATUS_ID
14:33:54 480  	  FROM ACCOUNT
14:33:54 481  	  WHERE
14:33:54 482  	    ACCOUNT.GROUP_ID = in_group_id;
14:33:54 483  
14:33:54 484  EXCEPTION
14:33:54 485  WHEN NO_DATA_FOUND THEN
14:33:54 486  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 487  	  SPROC_NAME, 'No such account');
14:33:54 488  WHEN OTHERS THEN
14:33:54 489  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 490  	  SPROC_NAME, 'Unknown Error', SQLERRM);
14:33:54 491  END GET_ACCOUNT_INFO;
14:33:54 492  
14:33:54 493  PROCEDURE GET_ACCOUNT_NOTES (
14:33:54 494  	  in_group_id	 IN  NUMBER,
14:33:54 495  	  out_result_set OUT SYS_REFCURSOR
14:33:54 496  ) AS
14:33:54 497  -- VARIABLES
14:33:54 498  SPROC_NAME      CONSTANT VARCHAR2(17) := 'GET_ACCOUNT_NOTES';
14:33:54 499  var_account_id NUMBER;
14:33:54 500  -- EXCEPTIONS
14:33:54 501  BAD_ACCOUNT_ID EXCEPTION;
14:33:54 502  BEGIN
14:33:54 503  
14:33:54 504  	-- Check that account is exists
14:33:54 505  	BEGIN
14:33:54 506  	  SELECT
14:33:54 507  	    ACCOUNT.ID into var_account_id
14:33:54 508  	  FROM
14:33:54 509  	    ACCOUNT
14:33:54 510  	  WHERE
14:33:54 511  	    ACCOUNT.GROUP_ID = in_group_id;
14:33:54 512  	  EXCEPTION
14:33:54 513  	    WHEN NO_DATA_FOUND THEN
14:33:54 514  	      RAISE BAD_ACCOUNT_ID;
14:33:54 515  	END;
14:33:54 516  
14:33:54 517  	-- Get account notes
14:33:54 518  	OPEN out_result_set FOR
14:33:54 519  	SELECT
14:33:54 520  	  ACCOUNT_NOTE.ACCOUNT_ID,
14:33:54 521  	  ACCOUNT_NOTE.AGENT_ID,
14:33:54 522  	  ACCOUNT_NOTE.CREATE_DATE,
14:33:54 523  	  ACCOUNT_NOTE.CREATED_BY,
14:33:54 524  	  ACCOUNT_NOTE.ID,
14:33:54 525  	  ACCOUNT_NOTE.NOTE
14:33:54 526  	FROM
14:33:54 527  	  ACCOUNT_NOTE
14:33:54 528  	WHERE
14:33:54 529  	  ACCOUNT_NOTE.ACCOUNT_ID = var_account_id
14:33:54 530  	ORDER BY
14:33:54 531  	  ACCOUNT_NOTE.CREATE_DATE ASC;
14:33:54 532  
14:33:54 533  EXCEPTION
14:33:54 534  WHEN BAD_ACCOUNT_ID THEN
14:33:54 535  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 536  	  SPROC_NAME, 'No such account');
14:33:54 537  WHEN OTHERS THEN
14:33:54 538  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 539  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 540  END GET_ACCOUNT_NOTES;
14:33:54 541  
14:33:54 542  PROCEDURE GET_ACCOUNT_PAYPALS(
14:33:54 543  	in_group_id    IN  ACCOUNT.GROUP_ID%TYPE,
14:33:54 544  	in_status_id   IN  PAYPAL.PAYPAL_STATUS_ID%TYPE DEFAULT GLOBAL_STATUSES_V22.PAYPAL_ACTIVE,
14:33:54 545  	out_result_set OUT SYS_REFCURSOR
14:33:54 546  ) AS
14:33:54 547  SPROC_NAME     CONSTANT VARCHAR2(32) := 'GET_ACCOUNT_PAYPALS';
14:33:54 548  BEGIN
14:33:54 549  	OPEN out_result_set FOR
14:33:54 550  	  SELECT
14:33:54 551  	    DISTINCT
14:33:54 552  	    PAYPAL.ID,
14:33:54 553  	    PAYPAL.ACCOUNT_ID,
14:33:54 554  	    PAYPAL.INSTRUMENT_NAME,
14:33:54 555  	    PAYPAL.PRIVATE_EMAIL_ADDRESS,
14:33:54 556  	    PAYPAL.CREATE_DATE,
14:33:54 557  	    PAYPAL.CREATED_BY,
14:33:54 558  	    PAYPAL.UPDATE_DATE,
14:33:54 559  	    PAYPAL.UPDATED_BY,
14:33:54 560  	    PAYPAL.PAYPAL_STATUS_ID,
14:33:54 561  	    PAYPAL.PRIVATE_STREET_ADDRESS,
14:33:54 562  	    PAYPAL.PRIVATE_STREET_ADDRESS2,
14:33:54 563  	    PAYPAL.STATE,
14:33:54 564  	    PAYPAL.CITY,
14:33:54 565  	    PAYPAL.POSTAL_CODE,
14:33:54 566  	    PAYPAL.COUNTRY,
14:33:54 567  	    Paypal.Expiration_Date,
14:33:54 568  	    Paypal.Secret_Token,
14:33:54 569  	    decode((SELECT
14:33:54 570  	    Instrument_Id
14:33:54 571  		    FROM ACCOUNT
14:33:54 572  		    WHERE group_id = in_group_id AND Instrument_Id = PAYPAL.ID), null, 'false', 'true') is_default
14:33:54 573  	  FROM
14:33:54 574  	      PAYPAL
14:33:54 575  	      LEFT JOIN ACCOUNT ON ACCOUNT.id = PAYPAL.ACCOUNT_ID
14:33:54 576  	  WHERE
14:33:54 577  	    ACCOUNT.GROUP_ID = in_group_id
14:33:54 578  	    AND PAYPAL.PAYPAL_STATUS_ID = in_status_id;
14:33:54 579  END GET_ACCOUNT_PAYPALS;
14:33:54 580  
14:33:54 581  PROCEDURE GET_ACCOUNT_SUBSCRIPTIONS (
14:33:54 582  	  in_group_id	 IN  NUMBER,
14:33:54 583  	  in_start_date  IN DATE,
14:33:54 584  	  in_end_date	 IN DATE,
14:33:54 585  	  in_status	 IN NUMBER,
14:33:54 586  	  in_group_account_type IN VARCHAR2,
14:33:54 587  	  out_result_set OUT SYS_REFCURSOR
14:33:54 588  ) AS
14:33:54 589  -- VARIABLES
14:33:54 590  SPROC_NAME     CONSTANT VARCHAR2(25) := 'GET_ACCOUNT_SUBSCRIPTIONS';
14:33:54 591  var_account_id NUMBER;
14:33:54 592  -- EXCEPTIONS
14:33:54 593  BAD_GROUP_ID	      EXCEPTION;
14:33:54 594  BEGIN
14:33:54 595  	-- Get account id
14:33:54 596  	BEGIN
14:33:54 597  	  SELECT
14:33:54 598  	    ACCOUNT.ID INTO var_account_id
14:33:54 599  	  FROM
14:33:54 600  	    ACCOUNT
14:33:54 601  	  WHERE
14:33:54 602  	    ACCOUNT.GROUP_ID = in_group_id;
14:33:54 603  	  EXCEPTION
14:33:54 604  	    WHEN NO_DATA_FOUND THEN
14:33:54 605  	      RAISE BAD_GROUP_ID;
14:33:54 606  	END;
14:33:54 607  
14:33:54 608  	-- Get information about account subscriptions
14:33:54 609  	OPEN out_result_set FOR
14:33:54 610  	SELECT
14:33:54 611  	  in_group_id AS "GROUP_ID",
14:33:54 612  	  SUBSCRIPTION.ID AS "SUBSCRIPTION_ID",
14:33:54 613  	  SUBSCRIPTION.SUBSCRIPTION_STATUS_ID,
14:33:54 614  	  SUBSCRIPTION.PURCHASE_DATE,
14:33:54 615  	  SUBSCRIPTION.SUSPEND_DATE,
14:33:54 616  	  SUBSCRIPTION.REACTIVATION_DATE,
14:33:54 617  	  SUBSCRIPTION.CANCELLATION_DATE,
14:33:54 618  	  SUBSCRIPTION_CANCEL_REASON.VALUE as "CANCEL_TYPE",
14:33:54 619  	  SUBSCRIPTION.INSTRUMENT_ID,
14:33:54 620  	  SUBSCRIPTION.INSTRUMENT_TYPE_ID,
14:33:54 621  	  OFFER_CHAIN.ID AS "OFFER_CHAIN_ID",
14:33:54 622  	  OFFER_CHAIN.NAME,
14:33:54 623  	  OFFER_CHAIN.DESCRIPTION,
14:33:54 624  	  OFFER_CHAIN.PRODUCT_URI,
14:33:54 625  	  PROCS_SUBSCRIPTION_V22.CALC_SUBSCRIPTION_END_DATE(SUBSCRIPTION.ID) as "END_DATE",
14:33:54 626  	  PROCS_SUBSCRIPTION_V22.GET_RECENT_CHARGE(SUBSCRIPTION.ID) AS "RECENT_CHARGE",
14:33:54 627  	  PROCS_SUBSCRIPTION_V22.GET_RENEWAL_DATE(SUBSCRIPTION.ID) AS "RENEWAL_DATE",
14:33:54 628  	  PROCS_SUBSCRIPTION_V22.GET_BILLING_CYCLE(SUBSCRIPTION.ID) AS "BILLING_CYCLE",
14:33:54 629  	  PROCS_SUBSCRIPTION_V22.IS_SUBSCRIPTION_CANCELABLE(SUBSCRIPTION.ID) AS "IS_CANCELABLE",
14:33:54 630  	  ITUNES_RECEIPT.ID AS "ITUNES_RECEIPT_ID",
14:33:54 631  	  (
14:33:54 632  	    SELECT
14:33:54 633  	      MAX(ENTITLEMENT_END_DATE)
14:33:54 634  	      FROM LICENSE
14:33:54 635  	      WHERE LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
14:33:54 636  	  )
14:33:54 637  	  as "ENT_END_DATE",
14:33:54 638  	  (
14:33:54 639  	    SELECT
14:33:54 640  	      MIN(START_DATE)
14:33:54 641  	      FROM LICENSE
14:33:54 642  	      WHERE LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
14:33:54 643  	  )
14:33:54 644  	  as "ENT_START_DATE",
14:33:54 645  	  GROUP_ACCOUNT.SUBSCRIPTION_ID GA_SUBSCRIPTION_ID,
14:33:54 646  	  GROUP_ACCOUNT.ID GA_ID,
14:33:54 647  	  GROUP_ACCOUNT.GROUP_NAME GA_GROUP_NAME,
14:33:54 648  	  GROUP_ACCOUNT.FIRST_NAME GA_FIRST_NAME,
14:33:54 649  	  GROUP_ACCOUNT.LAST_NAME GA_LAST_NAME,
14:33:54 650  	  GROUP_ACCOUNT.EMAIL GA_EMAIL,
14:33:54 651  	  GROUP_ACCOUNT.PHONE GA_PHONE,
14:33:54 652  	  GROUP_ACCOUNT.ORGANIZATION_TYPE GA_ORGANIZATION_TYPE,
14:33:54 653  	  GROUP_ACCOUNT.SEATS GA_SEATS,
14:33:54 654  	  PROCS_GROUP_ACCOUNT_V22.F_GET_NUM_OCCUPIED_GROUP_SEATS(GROUP_ACCOUNT.ID) GA_SEATS_USED,
14:33:54 655  	  GROUP_ACCOUNT.IP GA_IP,
14:33:54 656  	  PROCS_SUBSCRIPTION_V22.GET_GIFT_CERT_CODE_BY_SUB_ID(SUBSCRIPTION.ID) GIFT_CERTIFICATE_CODE,
14:33:54 657  	  PROCS_ACCOUNT_V22.GET_GRACE_START_DATE(SUBSCRIPTION.ID) GRACE_START_DATE,
14:33:54 658  	  PROCS_ACCOUNT_V22.GET_GRACE_END_DATE(SUBSCRIPTION.ID) GRACE_END_DATE
14:33:54 659  	FROM
14:33:54 660  	  SUBSCRIPTION
14:33:54 661  	  INNER JOIN OFFER_CHAIN ON SUBSCRIPTION.OFFER_CHAIN_ID = OFFER_CHAIN.ID
14:33:54 662  	  LEFT JOIN SUBSCRIPTION_CANCEL_REASON ON SUBSCRIPTION.SCT_ID = SUBSCRIPTION_CANCEL_REASON.ID
14:33:54 663  	  LEFT JOIN ITUNES_RECEIPT ON SUBSCRIPTION.ID = ITUNES_RECEIPT.SUBSCRIPTION_ID
14:33:54 664  	  LEFT JOIN GROUP_ACCOUNT ON SUBSCRIPTION.ID = GROUP_ACCOUNT.SUBSCRIPTION_ID
14:33:54 665  	WHERE
14:33:54 666  	  SUBSCRIPTION.ACCOUNT_ID = var_account_id
14:33:54 667  	  AND (SUBSCRIPTION.SCT_ID IS NULL OR SUBSCRIPTION.SCT_ID != GLOBAL_STATUSES_V22.REAL_TIME_CANCEL_REASON)
14:33:54 668  	  AND SUBSCRIPTION.SUBSCRIPTION_STATUS_ID = NVL(in_status, SUBSCRIPTION.SUBSCRIPTION_STATUS_ID)
14:33:54 669  	  AND PROCS_COMMON_V22.NORMALIZE_DATE(SUBSCRIPTION.PURCHASE_DATE) >= NVL(in_start_date, PROCS_COMMON_V22.NORMALIZE_DATE(SUBSCRIPTION.PURCHASE_DATE))
14:33:54 670  	  AND PROCS_COMMON_V22.NORMALIZE_DATE(SUBSCRIPTION.PURCHASE_DATE) <= NVL(in_end_date, PROCS_COMMON_V22.NORMALIZE_DATE(SUBSCRIPTION.PURCHASE_DATE))
14:33:54 671  	  AND (in_group_account_type IS NULL OR OFFER_CHAIN.GROUP_ACCOUNT_TYPE_ID = in_group_account_type);
14:33:54 672  
14:33:54 673  EXCEPTION
14:33:54 674  WHEN BAD_GROUP_ID THEN
14:33:54 675  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 676  	  SPROC_NAME, 'Can not find account with given group id');
14:33:54 677  WHEN OTHERS THEN
14:33:54 678  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 679  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 680  END GET_ACCOUNT_SUBSCRIPTIONS;
14:33:54 681  
14:33:54 682  PROCEDURE FREEZE_ACCOUNT (
14:33:54 683  	in_group_id   IN NUMBER,
14:33:54 684  	in_updated_by IN VARCHAR2,
14:33:54 685  	in_note       IN VARCHAR2,
14:33:54 686  	in_agent_id   IN NUMBER
14:33:54 687  ) AS
14:33:54 688  SPROC_NAME	    CONSTANT VARCHAR2(14) := 'FREEZE_ACCOUNT';
14:33:54 689  -- VARIABLES
14:33:54 690  var_account_id	    NUMBER;
14:33:54 691  var_account_status_id NUMBER;
14:33:54 692  -- EXCEPTIONS
14:33:54 693  BAD_GROUP_ID	    EXCEPTION;
14:33:54 694  BAD_ACCOUNT_STATUS_ID EXCEPTION;
14:33:54 695  CAN_NOT_CREATE_NOTE   EXCEPTION;
14:33:54 696  EXCEPTION_MESSAGE     VARCHAR2(1024);
14:33:54 697  BEGIN
14:33:54 698  
14:33:54 699  	-- Get account status, account id
14:33:54 700  	BEGIN
14:33:54 701  	  SELECT
14:33:54 702  	    ACCOUNT.ID,
14:33:54 703  	    ACCOUNT.ACCOUNT_STATUS_ID
14:33:54 704  	    into
14:33:54 705  	    var_account_id,
14:33:54 706  	    var_account_status_id
14:33:54 707  	  FROM
14:33:54 708  	    ACCOUNT
14:33:54 709  	  WHERE
14:33:54 710  	    ACCOUNT.GROUP_ID = in_group_id;
14:33:54 711  	  EXCEPTION
14:33:54 712  	    WHEN NO_DATA_FOUND THEN
14:33:54 713  	      RAISE BAD_GROUP_ID;
14:33:54 714  	END;
14:33:54 715  
14:33:54 716  	-- We can freeze only ACTIVE accounts
14:33:54 717  	IF var_account_status_id != GLOBAL_STATUSES_V22.ACCOUNT_ACTIVE
14:33:54 718  	  AND var_account_status_id != GLOBAL_STATUSES_V22.ACCOUNT_FROZEN THEN
14:33:54 719  	  RAISE BAD_ACCOUNT_STATUS_ID;
14:33:54 720  	END IF;
14:33:54 721  
14:33:54 722  	-- Set account status
14:33:54 723  	PROCS_ACCOUNT_V22.UPDATE_ACCOUNT_STATUS(
14:33:54 724  	  in_account_id        => var_account_id,
14:33:54 725  	  in_updated_by        => in_updated_by,
14:33:54 726  	  in_account_status_id => GLOBAL_STATUSES_V22.ACCOUNT_FROZEN
14:33:54 727  	);
14:33:54 728  
14:33:54 729  	-- Annotate account
14:33:54 730  	BEGIN
14:33:54 731  	  PROCS_ACCOUNT_V22.ANNOTATE_ACCOUNT(
14:33:54 732  	    in_group_id   => in_group_id,
14:33:54 733  	    in_agent_id   => in_agent_id,
14:33:54 734  	    in_note	  => in_note,
14:33:54 735  	    in_created_by => in_updated_by
14:33:54 736  	  );
14:33:54 737  	  EXCEPTION
14:33:54 738  	    WHEN OTHERS THEN
14:33:54 739  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:54 740  	      RAISE CAN_NOT_CREATE_NOTE;
14:33:54 741  	END;
14:33:54 742  
14:33:54 743  EXCEPTION
14:33:54 744  WHEN BAD_GROUP_ID THEN
14:33:54 745  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 746  	  SPROC_NAME, 'No such group id');
14:33:54 747  WHEN BAD_ACCOUNT_STATUS_ID THEN
14:33:54 748  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.STATE_ERROR,
14:33:54 749  	  SPROC_NAME, 'Could not update this account. Status should to be active or frozen');
14:33:54 750  WHEN CAN_NOT_CREATE_NOTE THEN
14:33:54 751  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 752  	  SPROC_NAME, 'Could not annotate account', EXCEPTION_MESSAGE);
14:33:54 753  WHEN OTHERS THEN
14:33:54 754  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 755  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 756  END FREEZE_ACCOUNT;
14:33:54 757  
14:33:54 758  PROCEDURE GET_ACCOUNT_SUBSCR_INVOICES (
14:33:54 759  	in_group_id	   IN  NUMBER,
14:33:54 760  	in_subscription_id IN NUMBER,
14:33:54 761  	out_result_set	   OUT SYS_REFCURSOR
14:33:54 762  ) AS
14:33:54 763  SPROC_NAME	   CONSTANT VARCHAR2(27) := 'GET_ACCOUNT_SUBSCR_INVOICES';
14:33:54 764  -- VARIABLES
14:33:54 765  var_account_id	   NUMBER;
14:33:54 766  temp_subscription_id NUMBER;
14:33:54 767  -- EXCEPTIONS
14:33:54 768  BAD_GROUP_ID	  EXCEPTION;
14:33:54 769  BAD_SUBSCRIPTION_ID EXCEPTION;
14:33:54 770  BEGIN
14:33:54 771  	-- Get account id
14:33:54 772  	BEGIN
14:33:54 773  	  SELECT
14:33:54 774  	    ACCOUNT.ID into var_account_id
14:33:54 775  	  FROM
14:33:54 776  	    ACCOUNT
14:33:54 777  	  WHERE
14:33:54 778  	    ACCOUNT.GROUP_ID = in_group_id;
14:33:54 779  	  EXCEPTION
14:33:54 780  	    WHEN NO_DATA_FOUND THEN
14:33:54 781  	      RAISE BAD_GROUP_ID;
14:33:54 782  	END;
14:33:54 783  
14:33:54 784  	-- Check that subscription exists
14:33:54 785  	BEGIN
14:33:54 786  	  IF in_subscription_id IS NOT NULL THEN
14:33:54 787  	    SELECT
14:33:54 788  	      SUBSCRIPTION.ID into temp_subscription_id
14:33:54 789  	    FROM
14:33:54 790  	      SUBSCRIPTION
14:33:54 791  	    WHERE
14:33:54 792  	      SUBSCRIPTION.ID = in_subscription_id;
14:33:54 793  	  END IF;
14:33:54 794  	  EXCEPTION
14:33:54 795  	    WHEN NO_DATA_FOUND THEN
14:33:54 796  	      RAISE BAD_SUBSCRIPTION_ID;
14:33:54 797  	END;
14:33:54 798  
14:33:54 799  	OPEN out_result_set FOR
14:33:54 800  	SELECT DISTINCT
14:33:54 801  	  INVOICE.ID as "INVOICE_ID",
14:33:54 802  	  INVOICE.CREATE_DATE,
14:33:54 803  	  INVOICE.INVOICE_STATUS_ID,
14:33:54 804  	  PROCS_INVOICE_V22.F_CALCULATE_INVOICE_AMOUNT(INVOICE.ID) as "AMOUNT",
14:33:54 805  	  OFFER_CHAIN.ID as "OFFER_CHAIN_ID",
14:33:54 806  	  OFFER_CHAIN.NAME as "OFFER_CHAIN_NAME",
14:33:54 807  	  SUBSCRIPTION.ID as "SUBSCRIPTION_ID",
14:33:54 808  	  NULL as "GC_CODE",
14:33:54 809  	  NULL as "GC_ID"
14:33:54 810  	FROM
14:33:54 811  	  LICENSE
14:33:54 812  	  INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
14:33:54 813  	  INNER JOIN INVOICE ON LICENSE.INVOICE_ID = INVOICE.ID
14:33:54 814  	  INNER JOIN OFFER_CHAIN ON SUBSCRIPTION.OFFER_CHAIN_ID = OFFER_CHAIN.ID
14:33:54 815  	WHERE
14:33:54 816  	  SUBSCRIPTION.ACCOUNT_ID = var_account_id
14:33:54 817  	  AND (SUBSCRIPTION.SCT_ID IS NULL OR SUBSCRIPTION.SCT_ID != GLOBAL_STATUSES_V22.REAL_TIME_CANCEL_REASON)
14:33:54 818  	  AND SUBSCRIPTION.ID = NVL(in_subscription_id, SUBSCRIPTION.ID);
14:33:54 819  
14:33:54 820  EXCEPTION
14:33:54 821  WHEN BAD_GROUP_ID THEN
14:33:54 822  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 823  	  SPROC_NAME, 'No such account');
14:33:54 824  WHEN BAD_SUBSCRIPTION_ID THEN
14:33:54 825  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 826  	  SPROC_NAME, 'No such subscription');
14:33:54 827  WHEN OTHERS THEN
14:33:54 828  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 829  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 830  END GET_ACCOUNT_SUBSCR_INVOICES;
14:33:54 831  
14:33:54 832  PROCEDURE GET_ACCOUNT_GC_INVOICES (
14:33:54 833  	in_group_id    IN  NUMBER,
14:33:54 834  	out_result_set OUT SYS_REFCURSOR
14:33:54 835  ) AS
14:33:54 836  SPROC_NAME     CONSTANT VARCHAR2(23) := 'GET_ACCOUNT_GC_INVOICES';
14:33:54 837  -- VARIABLES
14:33:54 838  var_account_id NUMBER;
14:33:54 839  -- EXCEPTIONS
14:33:54 840  BAD_GROUP_ID EXCEPTION;
14:33:54 841  BEGIN
14:33:54 842  	-- Get account id
14:33:54 843  	BEGIN
14:33:54 844  	  SELECT
14:33:54 845  	    ACCOUNT.ID into var_account_id
14:33:54 846  	  FROM
14:33:54 847  	    ACCOUNT
14:33:54 848  	  WHERE
14:33:54 849  	    ACCOUNT.GROUP_ID = in_group_id;
14:33:54 850  	  EXCEPTION
14:33:54 851  	    WHEN NO_DATA_FOUND THEN
14:33:54 852  	      RAISE BAD_GROUP_ID;
14:33:54 853  	END;
14:33:54 854  
14:33:54 855  	-- Get invoices
14:33:54 856  	OPEN out_result_set FOR
14:33:54 857  	SELECT DISTINCT
14:33:54 858  	  INVOICE.ID as "INVOICE_ID",
14:33:54 859  	  INVOICE.CREATE_DATE,
14:33:54 860  	  INVOICE.INVOICE_STATUS_ID,
14:33:54 861  	  PROCS_INVOICE_V22.F_CALCULATE_INVOICE_AMOUNT(INVOICE.ID) as "AMOUNT",
14:33:54 862  	  OFFER_CHAIN.ID as "OFFER_CHAIN_ID",
14:33:54 863  	  OFFER_CHAIN.NAME as "OFFER_CHAIN_NAME",
14:33:54 864  	  NULL as "SUBSCRIPTION_ID",
14:33:54 865  	  GIFT_CERTIFICATE.CODE as "GC_CODE",
14:33:54 866  	  GIFT_CERTIFICATE.ID as "GC_ID"
14:33:54 867  	FROM
14:33:54 868  	  GIFT_CERTIFICATE
14:33:54 869  	  INNER JOIN INVOICE ON GIFT_CERTIFICATE.PURCHASE_INVOICE_ID = INVOICE.ID
14:33:54 870  	  INNER JOIN OFFER_CHAIN ON GIFT_CERTIFICATE.OFFER_CHAIN_ID = OFFER_CHAIN.ID
14:33:54 871  	WHERE
14:33:54 872  	  ROWNUM <= 100 AND
14:33:54 873  	  GIFT_CERTIFICATE.PURCHASER_GROUP_ID = in_group_id;
14:33:54 874  
14:33:54 875  EXCEPTION
14:33:54 876  WHEN BAD_GROUP_ID THEN
14:33:54 877  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 878  	  SPROC_NAME, 'No such account');
14:33:54 879  WHEN OTHERS THEN
14:33:54 880  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 881  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 882  END GET_ACCOUNT_GC_INVOICES;
14:33:54 883  
14:33:54 884  -- norlov: #38580
14:33:54 885  PROCEDURE GET_GC_INVOICE (
14:33:54 886  	in_group_id    IN  NUMBER,
14:33:54 887  	in_gc_code     IN  VARCHAR2,
14:33:54 888  	out_result_set OUT SYS_REFCURSOR
14:33:54 889  ) AS
14:33:54 890  SPROC_NAME     CONSTANT VARCHAR2(14) := 'GET_GC_INVOICE';
14:33:54 891  -- VARIABLES
14:33:54 892  var_account_id NUMBER;
14:33:54 893  -- EXCEPTIONS
14:33:54 894  BAD_GROUP_ID EXCEPTION;
14:33:54 895  BEGIN
14:33:54 896  	-- Get account id
14:33:54 897  	BEGIN
14:33:54 898  	  SELECT
14:33:54 899  	    ACCOUNT.ID into var_account_id
14:33:54 900  	  FROM
14:33:54 901  	    ACCOUNT
14:33:54 902  	  WHERE
14:33:54 903  	    ACCOUNT.GROUP_ID = in_group_id;
14:33:54 904  	  EXCEPTION
14:33:54 905  	    WHEN NO_DATA_FOUND THEN
14:33:54 906  	      RAISE BAD_GROUP_ID;
14:33:54 907  	END;
14:33:54 908  
14:33:54 909  	-- Get invoice for the GC
14:33:54 910  	OPEN out_result_set FOR
14:33:54 911  	SELECT DISTINCT
14:33:54 912  	  INVOICE.ID as "INVOICE_ID",
14:33:54 913  	  INVOICE.CREATE_DATE,
14:33:54 914  	  INVOICE.INVOICE_STATUS_ID,
14:33:54 915  	  PROCS_INVOICE_V22.F_CALCULATE_INVOICE_AMOUNT(INVOICE.ID) as "AMOUNT",
14:33:54 916  	  OFFER_CHAIN.ID as "OFFER_CHAIN_ID",
14:33:54 917  	  OFFER_CHAIN.NAME as "OFFER_CHAIN_NAME",
14:33:54 918  	  NULL as "SUBSCRIPTION_ID",
14:33:54 919  	  GIFT_CERTIFICATE.CODE as "GC_CODE"
14:33:54 920  	FROM
14:33:54 921  	  GIFT_CERTIFICATE
14:33:54 922  	  INNER JOIN INVOICE ON GIFT_CERTIFICATE.PURCHASE_INVOICE_ID = INVOICE.ID
14:33:54 923  	  INNER JOIN OFFER_CHAIN ON GIFT_CERTIFICATE.OFFER_CHAIN_ID = OFFER_CHAIN.ID
14:33:54 924  	WHERE
14:33:54 925  	  GIFT_CERTIFICATE.PURCHASER_GROUP_ID = in_group_id
14:33:54 926  	  AND GIFT_CERTIFICATE.CODE = in_gc_code;
14:33:54 927  
14:33:54 928  EXCEPTION
14:33:54 929  WHEN BAD_GROUP_ID THEN
14:33:54 930  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 931  	  SPROC_NAME, 'No such account');
14:33:54 932  WHEN OTHERS THEN
14:33:54 933  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 934  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 935  END GET_GC_INVOICE;
14:33:54 936  
14:33:54 937  PROCEDURE GET_ACCOUNT_PRODUCTS (
14:33:54 938  	in_group_id    IN  NUMBER,
14:33:54 939  	out_result_set OUT SYS_REFCURSOR
14:33:54 940  ) AS
14:33:54 941  SPROC_NAME     CONSTANT VARCHAR2(20) := 'GET_ACCOUNT_PRODUCTS';
14:33:54 942  -- VARIABLES
14:33:54 943  var_account_id NUMBER;
14:33:54 944  -- EXCEPTIONS
14:33:54 945  BAD_GROUP_ID EXCEPTION;
14:33:54 946  BEGIN
14:33:54 947  	-- Get account id
14:33:54 948  	BEGIN
14:33:54 949  	  SELECT
14:33:54 950  	    ACCOUNT.ID into var_account_id
14:33:54 951  	  FROM
14:33:54 952  	    ACCOUNT
14:33:54 953  	  WHERE
14:33:54 954  	    ACCOUNT.GROUP_ID = in_group_id;
14:33:54 955  	  EXCEPTION
14:33:54 956  	    WHEN NO_DATA_FOUND THEN
14:33:54 957  	      RAISE BAD_GROUP_ID;
14:33:54 958  	END;
14:33:54 959  
14:33:54 960  	OPEN out_result_set FOR
14:33:54 961  	SELECT DISTINCT
14:33:54 962  	  PRODUCT.ID,
14:33:54 963  	  PRODUCT.NAME
14:33:54 964  	FROM
14:33:54 965  	  PRODUCT
14:33:54 966  	WHERE
14:33:54 967  	  PRODUCT.ID IN (
14:33:54 968  	    SELECT DISTINCT
14:33:54 969  	      PRODUCT_OFFERING.PRODUCT_ID
14:33:54 970  	    FROM
14:33:54 971  	      PRODUCT_OFFERING
14:33:54 972  	    WHERE
14:33:54 973  	      PRODUCT_OFFERING.ID IN (
14:33:54 974  		SELECT DISTINCT
14:33:54 975  		  OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID
14:33:54 976  		FROM
14:33:54 977  		  OFFER_PRODUCT_OFFERING
14:33:54 978  		WHERE
14:33:54 979  		  OFFER_PRODUCT_OFFERING.OFFER_ID IN (
14:33:54 980  		    SELECT DISTINCT
14:33:54 981  		      OFFER_OFFER_CHAIN.OFFER_ID
14:33:54 982  		    FROM
14:33:54 983  		      OFFER_OFFER_CHAIN
14:33:54 984  		    WHERE
14:33:54 985  		      OFFER_OFFER_CHAIN.OFFER_CHAIN_ID IN (
14:33:54 986  			SELECT DISTINCT
14:33:54 987  			  SUBSCRIPTION.OFFER_CHAIN_ID
14:33:54 988  			FROM
14:33:54 989  			  SUBSCRIPTION
14:33:54 990  			WHERE
14:33:54 991  			  SUBSCRIPTION.ACCOUNT_ID = var_account_id
14:33:54 992  		      )
14:33:54 993  		  )
14:33:54 994  	      )
14:33:54 995  	  );
14:33:54 996  
14:33:54 997  EXCEPTION
14:33:54 998  WHEN BAD_GROUP_ID THEN
14:33:54 999  	PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1000  	   SPROC_NAME, 'No such account');
14:33:54 1001  WHEN OTHERS THEN
14:33:54 1002  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1003  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1004  END GET_ACCOUNT_PRODUCTS;
14:33:54 1005  
14:33:54 1006  PROCEDURE GET_ACCOUNT_PROD_OFFERRINGS (
14:33:54 1007  	 in_group_id IN NUMBER,
14:33:54 1008  	 out_result_set     OUT SYS_REFCURSOR
14:33:54 1009  ) AS
14:33:54 1010  SPROC_NAME CONSTANT VARCHAR2(27) := 'GET_ACCOUNT_PROD_OFFERRINGS';
14:33:54 1011  -- VARIABLES
14:33:54 1012  var_account_id NUMBER;
14:33:54 1013  -- EXCEPTIONS
14:33:54 1014  BAD_GROUP_ID EXCEPTION;
14:33:54 1015  BEGIN
14:33:54 1016  	  -- Get account id
14:33:54 1017  	 BEGIN
14:33:54 1018  	   SELECT
14:33:54 1019  	     ACCOUNT.ID into var_account_id
14:33:54 1020  	   FROM
14:33:54 1021  	     ACCOUNT
14:33:54 1022  	   WHERE
14:33:54 1023  	     ACCOUNT.GROUP_ID = in_group_id;
14:33:54 1024  	   EXCEPTION
14:33:54 1025  	     WHEN NO_DATA_FOUND THEN
14:33:54 1026  	       RAISE BAD_GROUP_ID;
14:33:54 1027  	 END;
14:33:54 1028  
14:33:54 1029  	 OPEN out_result_set FOR
14:33:54 1030  	 SELECT DISTINCT
14:33:54 1031  	   PRODUCT_OFFERING.ID,
14:33:54 1032  	   PRODUCT_OFFERING.PRODUCT_ID,
14:33:54 1033  	   PRODUCT_OFFERING.TAX_CATEGORY_ID,
14:33:54 1034  	   PRODUCT_OFFERING.UNIT_PRICE,
14:33:54 1035  	   PRODUCT_OFFERING.QUANTITY,
14:33:54 1036  	   PRODUCT_OFFERING.CREATE_DATE,
14:33:54 1037  	   PRODUCT_OFFERING.CREATED_BY,
14:33:54 1038  	   CAPABILITY.ID CAP_ID,
14:33:54 1039  	   CAPABILITY.CODE CAP_CODE,
14:33:54 1040  	   CAPABILITY.DESCRIPTION CAP_DESCRIPTION,
14:33:54 1041  	   CAPABILITY.SHAREABLE CAP_SHAREABLE
14:33:54 1042  	 FROM
14:33:54 1043  	   OFFER_PRODUCT_OFFERING
14:33:54 1044  	   INNER JOIN PRODUCT_OFFERING ON PRODUCT_OFFERING.ID = OFFER_PRODUCT_OFFERING.PRODUCT_OFFERING_ID
14:33:54 1045  	   INNER JOIN CAPABILITY ON PRODUCT_OFFERING.CAPABILITY_ID = CAPABILITY.ID
14:33:54 1046  	 WHERE
14:33:54 1047  	   OFFER_PRODUCT_OFFERING.OFFER_ID IN (
14:33:54 1048  	     SELECT DISTINCT
14:33:54 1049  	       OFFER_OFFER_CHAIN.OFFER_ID
14:33:54 1050  	     FROM
14:33:54 1051  	       OFFER_OFFER_CHAIN
14:33:54 1052  	     WHERE
14:33:54 1053  	       OFFER_OFFER_CHAIN.OFFER_CHAIN_ID IN (
14:33:54 1054  		 SELECT DISTINCT
14:33:54 1055  		   SUBSCRIPTION.OFFER_CHAIN_ID
14:33:54 1056  		 FROM
14:33:54 1057  		   SUBSCRIPTION
14:33:54 1058  		 WHERE
14:33:54 1059  		   SUBSCRIPTION.ACCOUNT_ID = var_account_id
14:33:54 1060  	       )
14:33:54 1061  	   );
14:33:54 1062  
14:33:54 1063  EXCEPTION
14:33:54 1064  WHEN BAD_GROUP_ID THEN
14:33:54 1065  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1066  	   SPROC_NAME, 'No such account');
14:33:54 1067  WHEN OTHERS THEN
14:33:54 1068  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1069  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1070  END GET_ACCOUNT_PROD_OFFERRINGS;
14:33:54 1071  
14:33:54 1072  PROCEDURE UPDATE_ACCOUNT_STATUS (
14:33:54 1073  	 in_account_id	      IN ACCOUNT.ID%TYPE,
14:33:54 1074  	 in_account_status_id IN ACCOUNT.ACCOUNT_STATUS_ID%TYPE,
14:33:54 1075  	 in_updated_by	      IN ACCOUNT.UPDATED_BY%TYPE
14:33:54 1076  ) AS
14:33:54 1077  SPROC_NAME CONSTANT VARCHAR2(21) := 'UPDATE_ACCOUNT_STATUS';
14:33:54 1078  -- EXCEPTIONS
14:33:54 1079  BAD_ACCOUNT_ID	      EXCEPTION;
14:33:54 1080  BAD_STATUS_ID	      EXCEPTION;
14:33:54 1081  EXCEPTION_MESSAGE      VARCHAR2(1024);
14:33:54 1082  BEGIN
14:33:54 1083  
14:33:54 1084  	 IF in_account_status_id != GLOBAL_STATUSES_V22.ACCOUNT_ACTIVE
14:33:54 1085  	   AND in_account_status_id != GLOBAL_STATUSES_V22.ACCOUNT_FROZEN
14:33:54 1086  	   AND in_account_status_id != GLOBAL_STATUSES_V22.ACCOUNT_DISABLED THEN
14:33:54 1087  	   RAISE BAD_STATUS_ID;
14:33:54 1088  	 END IF;
14:33:54 1089  
14:33:54 1090  	 PROCS_ACCOUNT_CRU_V22.UPDATE_ACCOUNT(
14:33:54 1091  	   in_account_id	=> in_account_id,
14:33:54 1092  	   in_account_status_id => in_account_status_id,
14:33:54 1093  	   in_updated_by	=> in_updated_by
14:33:54 1094  	 );
14:33:54 1095  
14:33:54 1096  	 IF SQL%ROWCOUNT = 0 THEN
14:33:54 1097  	   RAISE BAD_ACCOUNT_ID;
14:33:54 1098  	 END IF;
14:33:54 1099  
14:33:54 1100  EXCEPTION
14:33:54 1101  WHEN BAD_ACCOUNT_ID THEN
14:33:54 1102  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1103  	   SPROC_NAME, 'No such account');
14:33:54 1104  WHEN BAD_STATUS_ID THEN
14:33:54 1105  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:54 1106  	   SPROC_NAME, 'Bad status id');
14:33:54 1107  WHEN OTHERS THEN
14:33:54 1108  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1109  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1110  END UPDATE_ACCOUNT_STATUS;
14:33:54 1111  
14:33:54 1112  PROCEDURE GET_NEEDS_ENTTL_LICENSES_NUM (
14:33:54 1113  	 in_group_id	  IN ACCOUNT.GROUP_ID%TYPE,
14:33:54 1114  	 out_licenses_num OUT NUMBER
14:33:54 1115  ) AS
14:33:54 1116  SPROC_NAME CONSTANT VARCHAR2(28) := 'GET_NEEDS_ENTTL_LICENSES_NUM';
14:33:54 1117  -- VARIABLES
14:33:54 1118  var_account_id	  ACCOUNT.GROUP_ID%TYPE;
14:33:54 1119  -- EXCEPTIONS
14:33:54 1120  BAD_ACCOUNT_ID EXCEPTION;
14:33:54 1121  BEGIN
14:33:54 1122  
14:33:54 1123  	 BEGIN
14:33:54 1124  	   SELECT
14:33:54 1125  	     ACCOUNT.ID into var_account_id
14:33:54 1126  	   FROM
14:33:54 1127  	     ACCOUNT
14:33:54 1128  	   WHERE
14:33:54 1129  	     ACCOUNT.GROUP_ID = in_group_id;
14:33:54 1130  	   EXCEPTION
14:33:54 1131  	     WHEN NO_DATA_FOUND THEN
14:33:54 1132  	       RAISE BAD_ACCOUNT_ID;
14:33:54 1133  	 END;
14:33:54 1134  
14:33:54 1135  	 SELECT
14:33:54 1136  	   COUNT(LICENSE.ID) into out_licenses_num
14:33:54 1137  	 FROM
14:33:54 1138  	   LICENSE
14:33:54 1139  	   INNER JOIN SUBSCRIPTION ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
14:33:54 1140  	 WHERE
14:33:54 1141  	   SUBSCRIPTION.ACCOUNT_ID = var_account_id
14:33:54 1142  	   AND LICENSE.NEEDS_ENTITLEMENTS = GLOBAL_CONSTANTS_V22.TRUE;
14:33:54 1143  
14:33:54 1144  EXCEPTION
14:33:54 1145  WHEN BAD_ACCOUNT_ID THEN
14:33:54 1146  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1147  	   SPROC_NAME, 'No such group id');
14:33:54 1148  WHEN OTHERS THEN
14:33:54 1149  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1150  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1151  END GET_NEEDS_ENTTL_LICENSES_NUM;
14:33:54 1152  
14:33:54 1153  PROCEDURE SET_TAX_EXEMPT (
14:33:54 1154  	 in_group_id  IN NUMBER,
14:33:54 1155  	 in_exempt_id IN VARCHAR2
14:33:54 1156  ) AS
14:33:54 1157  SPROC_NAME CONSTANT VARCHAR2(14) := 'SET_TAX_EXEMPT';
14:33:54 1158  -- VARIABLES
14:33:54 1159  var_account_id NUMBER;
14:33:54 1160  -- EXCEPTIONS
14:33:54 1161  BAD_GROUP_ID EXCEPTION;
14:33:54 1162  BEGIN
14:33:54 1163  
14:33:54 1164  	 BEGIN
14:33:54 1165  	   SELECT
14:33:54 1166  	     ACCOUNT.ID into var_account_id
14:33:54 1167  	   FROM
14:33:54 1168  	     ACCOUNT
14:33:54 1169  	   WHERE
14:33:54 1170  	     ACCOUNT.GROUP_ID = in_group_id;
14:33:54 1171  	   EXCEPTION
14:33:54 1172  	     WHEN NO_DATA_FOUND THEN
14:33:54 1173  	       RAISE BAD_GROUP_ID;
14:33:54 1174  	 END;
14:33:54 1175  
14:33:54 1176  	 UPDATE
14:33:54 1177  	   ACCOUNT
14:33:54 1178  	 SET
14:33:54 1179  	   ACCOUNT.TAX_EXEMPT_ID = in_exempt_id
14:33:54 1180  	 WHERE
14:33:54 1181  	   ACCOUNT.ID = var_account_id;
14:33:54 1182  
14:33:54 1183  EXCEPTION
14:33:54 1184  WHEN BAD_GROUP_ID THEN
14:33:54 1185  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1186  	   SPROC_NAME, 'No such group id');
14:33:54 1187  WHEN OTHERS THEN
14:33:54 1188  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1189  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1190  END SET_TAX_EXEMPT;
14:33:54 1191  
14:33:54 1192  PROCEDURE IS_TAX_EXEMPT (
14:33:54 1193  	 in_group_id	   IN NUMBER,
14:33:54 1194  	 out_is_tax_exempt OUT NUMBER
14:33:54 1195  ) AS
14:33:54 1196  SPROC_NAME CONSTANT VARCHAR2(13) := 'IS_TAX_EXEMPT';
14:33:54 1197  -- VARIABLES
14:33:54 1198  var_is_tax_exempt ACCOUNT.TAX_EXEMPT_ID%TYPE;
14:33:54 1199  -- EXCEPTIONS
14:33:54 1200  BAD_GROUP_ID EXCEPTION;
14:33:54 1201  BEGIN
14:33:54 1202  
14:33:54 1203  	 BEGIN
14:33:54 1204  	   SELECT
14:33:54 1205  	     ACCOUNT.TAX_EXEMPT_ID into var_is_tax_exempt
14:33:54 1206  	   FROM
14:33:54 1207  	     ACCOUNT
14:33:54 1208  	   WHERE
14:33:54 1209  	     ACCOUNT.GROUP_ID = in_group_id;
14:33:54 1210  	   EXCEPTION
14:33:54 1211  	     WHEN NO_DATA_FOUND THEN
14:33:54 1212  	       RAISE BAD_GROUP_ID;
14:33:54 1213  	 END;
14:33:54 1214  
14:33:54 1215  	 IF var_is_tax_exempt IS NULL THEN
14:33:54 1216  	   out_is_tax_exempt := GLOBAL_CONSTANTS_V22.FALSE;
14:33:54 1217  	 ELSE
14:33:54 1218  	   out_is_tax_exempt := GLOBAL_CONSTANTS_V22.TRUE;
14:33:54 1219  	 END IF;
14:33:54 1220  
14:33:54 1221  EXCEPTION
14:33:54 1222  WHEN BAD_GROUP_ID THEN
14:33:54 1223  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1224  	   SPROC_NAME, 'No such group id');
14:33:54 1225  WHEN OTHERS THEN
14:33:54 1226  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1227  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1228  END IS_TAX_EXEMPT;
14:33:54 1229  
14:33:54 1230  PROCEDURE GET_GROUP_ID_BY_ACCOUNT_ID (
14:33:54 1231  	 in_account_id IN NUMBER,
14:33:54 1232  	 out_group_id  OUT NUMBER
14:33:54 1233  ) AS
14:33:54 1234  SPROC_NAME CONSTANT VARCHAR2(26) := 'GET_GROUP_ID_BY_ACCOUNT_ID';
14:33:54 1235  BEGIN
14:33:54 1236  
14:33:54 1237  	 SELECT
14:33:54 1238  	   ACCOUNT.GROUP_ID into out_group_id
14:33:54 1239  	 FROM
14:33:54 1240  	   ACCOUNT
14:33:54 1241  	 WHERE
14:33:54 1242  	   ACCOUNT.ID = in_account_id;
14:33:54 1243  
14:33:54 1244  EXCEPTION
14:33:54 1245  WHEN NO_DATA_FOUND THEN
14:33:54 1246  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1247  	   SPROC_NAME, 'No such account');
14:33:54 1248  WHEN OTHERS THEN
14:33:54 1249  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1250  	   SPROC_NAME, 'Unknown error');
14:33:54 1251  END GET_GROUP_ID_BY_ACCOUNT_ID;
14:33:54 1252  
14:33:54 1253  PROCEDURE GET_ACCOUNT_ID_BY_GROUP_ID (
14:33:54 1254  	 in_group_id IN NUMBER,
14:33:54 1255  	 out_account_id  OUT NUMBER
14:33:54 1256  ) AS
14:33:54 1257  SPROC_NAME CONSTANT VARCHAR2(26) := 'GET_ACCOUNT_ID_BY_GROUP_ID';
14:33:54 1258  BEGIN
14:33:54 1259  
14:33:54 1260  	 SELECT
14:33:54 1261  	   ACCOUNT.ID into out_account_id
14:33:54 1262  	 FROM
14:33:54 1263  	   ACCOUNT
14:33:54 1264  	 WHERE
14:33:54 1265  	   ACCOUNT.GROUP_ID = in_group_id;
14:33:54 1266  
14:33:54 1267  EXCEPTION
14:33:54 1268  WHEN NO_DATA_FOUND THEN
14:33:54 1269  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1270  	   SPROC_NAME, 'No such account');
14:33:54 1271  WHEN OTHERS THEN
14:33:54 1272  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1273  	   SPROC_NAME, 'Unknown error');
14:33:54 1274  END GET_ACCOUNT_ID_BY_GROUP_ID;
14:33:54 1275  
14:33:54 1276  PROCEDURE GET_GROUPS_ID_BY_INVOICE_ID (
14:33:54 1277  	 in_invoice_id IN NUMBER,
14:33:54 1278  	 out_group_ids OUT SYS_REFCURSOR
14:33:54 1279  ) AS
14:33:54 1280  SPROC_NAME CONSTANT VARCHAR2(27) := 'GET_GROUPS_ID_BY_INVOICE_ID';
14:33:54 1281  -- VARIABLES
14:33:54 1282  temp_invoice_id		 NUMBER;
14:33:54 1283  var_subscrib_group_id	 NUMBER;
14:33:54 1284  var_gc_purchaser_group_id NUMBER;
14:33:54 1285  var_gc_redeemer_group_id  NUMBER;
14:33:54 1286  -- EXCEPTIONS
14:33:54 1287  BAD_INVOICE_ID	    EXCEPTION;
14:33:54 1288  CAN_NOT_FIND_ACCOUNT EXCEPTION;
14:33:54 1289  BEGIN
14:33:54 1290  
14:33:54 1291  	 BEGIN
14:33:54 1292  	   SELECT
14:33:54 1293  	     INVOICE.ID into temp_invoice_id
14:33:54 1294  	   FROM
14:33:54 1295  	     INVOICE
14:33:54 1296  	   WHERE
14:33:54 1297  	     INVOICE.ID = in_invoice_id;
14:33:54 1298  	   EXCEPTION
14:33:54 1299  	     WHEN NO_DATA_FOUND THEN
14:33:54 1300  	       RAISE BAD_INVOICE_ID;
14:33:54 1301  	 END;
14:33:54 1302  
14:33:54 1303  	 BEGIN
14:33:54 1304  	   SELECT DISTINCT
14:33:54 1305  	     ACCOUNT.GROUP_ID into var_subscrib_group_id
14:33:54 1306  	   FROM
14:33:54 1307  	     ACCOUNT
14:33:54 1308  	     INNER JOIN SUBSCRIPTION ON SUBSCRIPTION.ACCOUNT_ID = ACCOUNT.ID
14:33:54 1309  	     INNER JOIN LICENSE ON LICENSE.SUBSCRIPTION_ID = SUBSCRIPTION.ID
14:33:54 1310  	   WHERE
14:33:54 1311  	     LICENSE.INVOICE_ID = in_invoice_id;
14:33:54 1312  	   EXCEPTION
14:33:54 1313  	     WHEN NO_DATA_FOUND THEN
14:33:54 1314  	       var_subscrib_group_id := NULL;
14:33:54 1315  	 END;
14:33:54 1316  
14:33:54 1317  	 IF var_subscrib_group_id IS NULL THEN
14:33:54 1318  	   BEGIN
14:33:54 1319  	     SELECT
14:33:54 1320  	       GIFT_CERTIFICATE.PURCHASER_GROUP_ID,
14:33:54 1321  	       GIFT_CERTIFICATE.REDEEMER_GROUP_ID
14:33:54 1322  	       into
14:33:54 1323  	       var_gc_purchaser_group_id,
14:33:54 1324  	       var_gc_redeemer_group_id
14:33:54 1325  	     FROM
14:33:54 1326  	       GIFT_CERTIFICATE
14:33:54 1327  	     WHERE
14:33:54 1328  	       GIFT_CERTIFICATE.PURCHASE_INVOICE_ID = in_invoice_id
14:33:54 1329  	       OR GIFT_CERTIFICATE.FINALIZED_INVOICE_ID = in_invoice_id;
14:33:54 1330  	     EXCEPTION
14:33:54 1331  	       WHEN NO_DATA_FOUND THEN
14:33:54 1332  		 var_gc_purchaser_group_id := NULL;
14:33:54 1333  		 var_gc_redeemer_group_id  := NULL;
14:33:54 1334  	   END;
14:33:54 1335  	 END IF;
14:33:54 1336  
14:33:54 1337  	 IF var_subscrib_group_id IS NULL
14:33:54 1338  	   AND var_gc_purchaser_group_id IS NULL
14:33:54 1339  	   AND var_gc_redeemer_group_id IS NULL THEN
14:33:54 1340  	     RAISE CAN_NOT_FIND_ACCOUNT;
14:33:54 1341  	 END IF;
14:33:54 1342  
14:33:54 1343  	 OPEN out_group_ids FOR
14:33:54 1344  	 SELECT GROUP_ID FROM (
14:33:54 1345  	   SELECT
14:33:54 1346  	     var_subscrib_group_id as "GROUP_ID"
14:33:54 1347  	   FROM
14:33:54 1348  	     DUAL
14:33:54 1349  	   UNION
14:33:54 1350  	   SELECT
14:33:54 1351  	     var_gc_purchaser_group_id as "GROUP_ID"
14:33:54 1352  	   FROM
14:33:54 1353  	     DUAL
14:33:54 1354  	   UNION
14:33:54 1355  	   SELECT
14:33:54 1356  	     var_gc_redeemer_group_id as "GROUP_ID"
14:33:54 1357  	   FROM
14:33:54 1358  	     DUAL
14:33:54 1359  	 )
14:33:54 1360  	 WHERE
14:33:54 1361  	   GROUP_ID IS NOT NULL;
14:33:54 1362  
14:33:54 1363  EXCEPTION
14:33:54 1364  WHEN BAD_INVOICE_ID THEN
14:33:54 1365  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1366  	   SPROC_NAME, 'No such invoice');
14:33:54 1367  WHEN CAN_NOT_FIND_ACCOUNT THEN
14:33:54 1368  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1369  	   SPROC_NAME, 'Could not find account for given invoice');
14:33:54 1370  WHEN OTHERS THEN
14:33:54 1371  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1372  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1373  END GET_GROUPS_ID_BY_INVOICE_ID;
14:33:54 1374  
14:33:54 1375  PROCEDURE GET_ACCOUNT_TAX_EXEMPT_ID (
14:33:54 1376  	 in_group_id	   IN NUMBER,
14:33:54 1377  	 out_tax_exempt_id OUT VARCHAR2
14:33:54 1378  ) AS
14:33:54 1379  SPROC_NAME CONSTANT VARCHAR2(25) := 'GET_ACCOUNT_TAX_EXEMPT_ID';
14:33:54 1380  -- VARIABLES
14:33:54 1381  -- EXCEPTIONS
14:33:54 1382  BEGIN
14:33:54 1383  
14:33:54 1384  	 SELECT
14:33:54 1385  	   ACCOUNT.TAX_EXEMPT_ID into out_tax_exempt_id
14:33:54 1386  	 FROM
14:33:54 1387  	   ACCOUNT
14:33:54 1388  	 WHERE
14:33:54 1389  	   ACCOUNT.GROUP_ID = in_group_id;
14:33:54 1390  
14:33:54 1391  EXCEPTION
14:33:54 1392  WHEN NO_DATA_FOUND THEN
14:33:54 1393  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1394  	   SPROC_NAME, 'No such account');
14:33:54 1395  WHEN OTHERS THEN
14:33:54 1396  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1397  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1398  END GET_ACCOUNT_TAX_EXEMPT_ID;
14:33:54 1399  
14:33:54 1400  PROCEDURE GET_UPGRADABLE_SUBSCRIPTIONS (
14:33:54 1401  	 in_group_id	IN NUMBER,
14:33:54 1402  	 out_result_set OUT SYS_REFCURSOR
14:33:54 1403  ) AS
14:33:54 1404  SPROC_NAME CONSTANT VARCHAR2(28) := 'GET_UPGRADABLE_SUBSCRIPTIONS';
14:33:54 1405  -- Variables
14:33:54 1406  var_account_id NUMBER;
14:33:54 1407  -- Exceptions
14:33:54 1408  BAD_GROUP_ID   EXCEPTION;
14:33:54 1409  BEGIN
14:33:54 1410  
14:33:54 1411  	 BEGIN
14:33:54 1412  	   SELECT
14:33:54 1413  	     ID into var_account_id
14:33:54 1414  	   FROM
14:33:54 1415  	     ACCOUNT
14:33:54 1416  	   WHERE
14:33:54 1417  	     GROUP_ID = in_group_id;
14:33:54 1418  	   EXCEPTION
14:33:54 1419  	     WHEN NO_DATA_FOUND THEN
14:33:54 1420  	       RAISE BAD_GROUP_ID;
14:33:54 1421  	 END;
14:33:54 1422  
14:33:54 1423  	 OPEN out_result_set FOR
14:33:54 1424  	 SELECT
14:33:54 1425  	   S.ID as SUBSCRIPTION_ID,
14:33:54 1426  	   OCHMD.OFFER_CHAIN_ID
14:33:54 1427  	 FROM
14:33:54 1428  	   SUBSCRIPTION S
14:33:54 1429  	   INNER JOIN OFFER_CHAIN OCH ON OCH.ID = S.OFFER_CHAIN_ID
14:33:54 1430  	   INNER JOIN OFFER_CHAIN_META_DATA OCHMD ON (OCHMD.NAME = GLOBAL_CONSTANTS_V22.OCMD_UPGRADABLE_OFFER_CHAIN_ID AND TO_NUMBER(OCHMD.VALUE) = OCH.ID)
14:33:54 1431  	 WHERE
14:33:54 1432  	   S.ACCOUNT_ID = var_account_id;
14:33:54 1433  
14:33:54 1434  EXCEPTION
14:33:54 1435  WHEN BAD_GROUP_ID THEN
14:33:54 1436  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1437  	   SPROC_NAME, 'No such account');
14:33:54 1438  WHEN OTHERS THEN
14:33:54 1439  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1440  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1441  END GET_UPGRADABLE_SUBSCRIPTIONS;
14:33:54 1442  
14:33:54 1443  PROCEDURE GET_USR_ALL_SBSCR_IDS (
14:33:54 1444  	 in_group_id	    IN NUMBER,
14:33:54 1445  	 out_result_set     OUT SYS_REFCURSOR
14:33:54 1446  ) AS
14:33:54 1447  SPROC_NAME CONSTANT VARCHAR2(21) := 'GET_USR_ALL_SBSCR_IDS';
14:33:54 1448  -- VARIABLES
14:33:54 1449  var_account_id NUMBER;
14:33:54 1450  -- EXCEPTIONS
14:33:54 1451  BAD_GROUP_ID EXCEPTION;
14:33:54 1452  BEGIN
14:33:54 1453  
14:33:54 1454  	 BEGIN
14:33:54 1455  	   SELECT
14:33:54 1456  	     A.ID INTO var_account_id
14:33:54 1457  	   FROM
14:33:54 1458  	     ACCOUNT A
14:33:54 1459  	   WHERE
14:33:54 1460  	     A.GROUP_ID = in_group_id;
14:33:54 1461  	   EXCEPTION
14:33:54 1462  	     WHEN NO_DATA_FOUND THEN
14:33:54 1463  	       RAISE BAD_GROUP_ID;
14:33:54 1464  	 END;
14:33:54 1465  
14:33:54 1466  	 OPEN out_result_set FOR
14:33:54 1467  	 SELECT
14:33:54 1468  	   S.ID
14:33:54 1469  	 FROM
14:33:54 1470  	   SUBSCRIPTION S
14:33:54 1471  	 WHERE
14:33:54 1472  	   S.ACCOUNT_ID = var_account_id
14:33:54 1473  	   AND S.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE;
14:33:54 1474  
14:33:54 1475  EXCEPTION
14:33:54 1476  WHEN BAD_GROUP_ID THEN
14:33:54 1477  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1478  	   SPROC_NAME, 'No such account');
14:33:54 1479  WHEN OTHERS THEN
14:33:54 1480  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1481  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1482  END GET_USR_ALL_SBSCR_IDS;
14:33:54 1483  
14:33:54 1484  PROCEDURE GET_USR_SBSCR_IDS_BY_OFFCH_IDS (
14:33:54 1485  	 in_group_id	    IN NUMBER,
14:33:54 1486  	 in_offer_chain_ids IN core_owner.NUMBER_TABLE,
14:33:54 1487  	 out_result_set     OUT SYS_REFCURSOR
14:33:54 1488  ) AS
14:33:54 1489  SPROC_NAME CONSTANT VARCHAR2(30) := 'GET_USR_SBSCR_IDS_BY_OFFCH_IDS';
14:33:54 1490  -- VARIABLES
14:33:54 1491  var_account_id NUMBER;
14:33:54 1492  -- EXCEPTIONS
14:33:54 1493  BAD_GROUP_ID	   EXCEPTION;
14:33:54 1494  BAD_OFFER_CHAIN_IDS EXCEPTION;
14:33:54 1495  BEGIN
14:33:54 1496  
14:33:54 1497  	 IF in_offer_chain_ids IS NULL THEN
14:33:54 1498  	   RAISE BAD_OFFER_CHAIN_IDS;
14:33:54 1499  	 END IF;
14:33:54 1500  
14:33:54 1501  	 BEGIN
14:33:54 1502  	   SELECT
14:33:54 1503  	     A.ID INTO var_account_id
14:33:54 1504  	   FROM
14:33:54 1505  	     ACCOUNT A
14:33:54 1506  	   WHERE
14:33:54 1507  	     A.GROUP_ID = in_group_id;
14:33:54 1508  	   EXCEPTION
14:33:54 1509  	     WHEN NO_DATA_FOUND THEN
14:33:54 1510  	       RAISE BAD_GROUP_ID;
14:33:54 1511  	 END;
14:33:54 1512  
14:33:54 1513  	 OPEN out_result_set FOR
14:33:54 1514  	 SELECT
14:33:54 1515  	   S.ID
14:33:54 1516  	 FROM
14:33:54 1517  	   SUBSCRIPTION S
14:33:54 1518  	 WHERE
14:33:54 1519  	   S.ACCOUNT_ID = var_account_id
14:33:54 1520  	   AND S.OFFER_CHAIN_ID IN (SELECT * FROM TABLE(in_offer_chain_ids))
14:33:54 1521  	   AND S.SUBSCRIPTION_STATUS_ID = GLOBAL_STATUSES_V22.SUBSCRIPTION_ACTIVE;
14:33:54 1522  
14:33:54 1523  EXCEPTION
14:33:54 1524  WHEN BAD_OFFER_CHAIN_IDS THEN
14:33:54 1525  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.INVALID_PARAMETER,
14:33:54 1526  	   SPROC_NAME, 'Offer chains ids parameter is null');
14:33:54 1527  WHEN BAD_GROUP_ID THEN
14:33:54 1528  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 1529  	   SPROC_NAME, 'No such account');
14:33:54 1530  WHEN OTHERS THEN
14:33:54 1531  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1532  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1533  END GET_USR_SBSCR_IDS_BY_OFFCH_IDS;
14:33:54 1534  
14:33:54 1535  PROCEDURE GET_GROUP_IDS_BY_CC_INFO (
14:33:54 1536  	 in_last_four_cc IN CREDIT_CARD.LAST_FOUR_CC%TYPE,
14:33:54 1537  	 in_expiration_date IN DATE,
14:33:54 1538  	 in_country IN CREDIT_CARD.COUNTRY%TYPE DEFAULT NULL,
14:33:54 1539  	 in_postal_code IN CREDIT_CARD.POSTAL_CODE%TYPE DEFAULT NULL,
14:33:54 1540  	 in_city IN CREDIT_CARD.CITY%TYPE DEFAULT NULL,
14:33:54 1541  	 in_state IN CREDIT_CARD.STATE%TYPE DEFAULT NULL,
14:33:54 1542  	 in_credit_card_type_id IN CREDIT_CARD.CREDIT_CARD_TYPE_ID%TYPE DEFAULT NULL,
14:33:54 1543  	 in_credit_card_status_id IN CREDIT_CARD.CREDIT_CARD_STATUS_ID%TYPE DEFAULT NULL,
14:33:54 1544  	 in_lower_bound IN NUMBER DEFAULT 1,
14:33:54 1545  	 in_upper_bound IN NUMBER DEFAULT 11,
14:33:54 1546  	 out_result_set OUT SYS_REFCURSOR
14:33:54 1547  ) AS
14:33:54 1548  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_GROUP_IDS_BY_CC_INFO';
14:33:54 1549  BEGIN
14:33:54 1550  
14:33:54 1551  	 OPEN out_result_set FOR
14:33:54 1552  	     SELECT
14:33:54 1553  	       distinct /*+ first_rows(in_upper_bound-in_lower_bound) */ a.GROUP_ID GROUP_ID
14:33:54 1554  	     FROM
14:33:54 1555  	       account a,
14:33:54 1556  	       credit_card cc
14:33:54 1557  	     WHERE
14:33:54 1558  	       cc.expiration_date = in_expiration_date and
14:33:54 1559  	       cc.last_four_cc = in_last_four_cc and
14:33:54 1560  	       upper(cc.postal_code) = upper(nvl(in_postal_code, cc.postal_code)) and
14:33:54 1561  	       upper(cc.city) = upper(nvl(in_city, cc.city)) and
14:33:54 1562  	       upper(cc.state) = upper(nvl(in_state, cc.state)) and
14:33:54 1563  	       upper(cc.country) = upper(nvl(in_country, cc.country)) and
14:33:54 1564  	       cc.credit_card_status_id = nvl(in_credit_card_status_id, cc.credit_card_status_id) and
14:33:54 1565  	       cc.credit_card_type_id = nvl(in_credit_card_type_id, cc.credit_card_type_id) and
14:33:54 1566  	       a.id = cc.account_id and
14:33:54 1567  	       rownum >= in_lower_bound and
14:33:54 1568  	       rownum <= in_upper_bound
14:33:54 1569  	   ;
14:33:54 1570  
14:33:54 1571  EXCEPTION
14:33:54 1572  WHEN OTHERS THEN
14:33:54 1573  	 PROCS_COMMON_V22.THROW_EXCEPTION(APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 1574  	   SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 1575  END GET_GROUP_IDS_BY_CC_INFO;
14:33:54 1576  
14:33:54 1577  END PROCS_ACCOUNT_V22;
14:33:54 1578  .
14:33:54 SQL> /

Package body created.

Elapsed: 00:00:00.12
14:33:54 SQL> 
14:33:54 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_PROCESS_RETRY_V22" AS
14:33:54   2  
14:33:54   3  PROCEDURE LOG_RETRY(
14:33:54   4  	  in_process_name IN VARCHAR2,
14:33:54   5  	  in_generic_id   IN NUMBER,
14:33:54   6  	  in_date	  IN VARCHAR2,
14:33:54   7  	  out_success	   OUT NUMBER
14:33:54   8  ) AS
14:33:54   9  SPROC_NAME CONSTANT VARCHAR2(32) := 'LOG_RETRY_V22';
14:33:54  10  BEGIN
14:33:54  11  
14:33:54  12  	out_success := 1;
14:33:54  13  	INSERT into PROCESS_RETRY_THROTTLE(process_name, generic_id, RETRY_count, create_date, update_date)
14:33:54  14  	VALUES (in_process_name, in_generic_id, 1, to_date(in_date, 'DD-Mon-YYYY HH24:MI:SS'), sysdate);
14:33:54  15  	commit;
14:33:54  16  EXCEPTION
14:33:54  17  WHEN DUP_VAL_ON_INDEX THEN
14:33:54  18  	rollback;
14:33:54  19  	out_success := 0;
14:33:54  20  WHEN OTHERS THEN
14:33:54  21  	rollback;
14:33:54  22  	PROCS_COMMON_V22.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54  23  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54  24  
14:33:54  25  END;
14:33:54  26  
14:33:54  27  PROCEDURE LOG_RETRY_DATE(
14:33:54  28  	  in_process_name IN VARCHAR2,
14:33:54  29  	  in_generic_id   IN NUMBER,
14:33:54  30  	  in_date	  IN DATE,
14:33:54  31  	  out_success	   OUT NUMBER
14:33:54  32  ) AS
14:33:54  33  SPROC_NAME CONSTANT VARCHAR2(32) := 'LOG_RETRY_DATE_V22';
14:33:54  34  BEGIN
14:33:54  35  
14:33:54  36  	out_success := 1;
14:33:54  37  	INSERT into PROCESS_RETRY_THROTTLE(process_name, generic_id, RETRY_count, create_date, update_date)
14:33:54  38  	VALUES (in_process_name, in_generic_id, 1, in_date, sysdate);
14:33:54  39  	commit;
14:33:54  40  EXCEPTION
14:33:54  41  WHEN DUP_VAL_ON_INDEX THEN
14:33:54  42  	rollback;
14:33:54  43  	out_success := 0;
14:33:54  44  WHEN OTHERS THEN
14:33:54  45  	rollback;
14:33:54  46  	PROCS_COMMON_V22.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54  47  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54  48  
14:33:54  49  END;
14:33:54  50  
14:33:54  51  PROCEDURE DELETE_RETRY(
14:33:54  52  	  in_process_name IN VARCHAR2,
14:33:54  53  	  in_remove_minutes  IN NUMBER
14:33:54  54  ) AS
14:33:54  55  BEGIN
14:33:54  56  
14:33:54  57  delete from PROCESS_RETRY_THROTTLE
14:33:54  58  where
14:33:54  59  	process_name = in_process_name and
14:33:54  60  	create_date <= sysdate - (in_remove_minutes / (60 * 24));
14:33:54  61  commit;
14:33:54  62  END;
14:33:54  63  
14:33:54  64  PROCEDURE GET_SYSDATE (
14:33:54  65  	out_date  OUT VARCHAR2
14:33:54  66  ) AS
14:33:54  67  BEGIN
14:33:54  68  	SELECT to_char(SYSDATE, 'DD-Mon-YYYY HH24:MI:SS') into out_date from dual;
14:33:54  69  END;
14:33:54  70  
14:33:54  71  END PROCS_PROCESS_RETRY_V22;
14:33:54  72  .
14:33:54 SQL> /

Package body created.

Elapsed: 00:00:00.02
14:33:54 SQL> 
14:33:54 SQL> CREATE OR REPLACE PACKAGE BODY "PROCS_NOTIFICATION_V22" AS
14:33:54   2  
14:33:54   3  PROCEDURE GET_NOTIFICATION_TYPE_BY_NAME (
14:33:54   4  /*
14:33:54   5  Throws exceptions:
14:33:54   6  CORE_OWNER.APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54   7  CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54   8  */
14:33:54   9  	in_notification_type_name IN VARCHAR2,
14:33:54  10  	out_notification_type_id  OUT NUMBER
14:33:54  11  ) AS
14:33:54  12  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_NOTIFICATION_TYPE_BY_NAME';
14:33:54  13  BEGIN
14:33:54  14  	SELECT
14:33:54  15  	  NOTIFICATION_TYPE.ID into out_notification_type_id
14:33:54  16  	FROM
14:33:54  17  	  NOTIFICATION_TYPE
14:33:54  18  	WHERE
14:33:54  19  	  NOTIFICATION_TYPE.VALUE = in_notification_type_name;
14:33:54  20  EXCEPTION
14:33:54  21  WHEN NO_DATA_FOUND THEN
14:33:54  22  	PROCS_COMMON_V22.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54  23  	  SPROC_NAME, 'No such type');
14:33:54  24  WHEN OTHERS THEN
14:33:54  25  	PROCS_COMMON_V22.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54  26  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54  27  END GET_NOTIFICATION_TYPE_BY_NAME;
14:33:54  28  
14:33:54  29  /******************************************************************/
14:33:54  30  
14:33:54  31  PROCEDURE ADD_NOTIFICATION (
14:33:54  32  /*
14:33:54  33  Throws exceptions:
14:33:54  34  CORE_OWNER.APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54  35  CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54  36  */
14:33:54  37  	in_sender_account_id	 IN NUMBER DEFAULT 0,
14:33:54  38  	in_recipient_group_id	 IN NUMBER,
14:33:54  39  	in_notification_type_id  IN NUMBER,
14:33:54  40  	in_date_to_notify	 IN DATE,
14:33:54  41  	in_email_template_params IN CLOB
14:33:54  42  ) AS
14:33:54  43  SPROC_NAME CONSTANT VARCHAR2(32) := 'ADD_NOTIFICATION';
14:33:54  44  -- VARIABLES
14:33:54  45  temp_type_count NUMBER;
14:33:54  46  var_create_date DATE := SYSDATE;
14:33:54  47  -- EXCEPTIONS
14:33:54  48  BAD_NOTIFICATION_TYPE_ID EXCEPTION;
14:33:54  49  CAN_NOT_CREATE_HISTORY   EXCEPTION;
14:33:54  50  EXCEPTION_MESSAGE        VARCHAR2(1024);
14:33:54  51  BEGIN
14:33:54  52  
14:33:54  53  	SELECT
14:33:54  54  	  COUNT(*) into temp_type_count
14:33:54  55  	FROM
14:33:54  56  	  NOTIFICATION_TYPE
14:33:54  57  	WHERE
14:33:54  58  	  NOTIFICATION_TYPE.ID = in_notification_type_id;
14:33:54  59  
14:33:54  60  	IF temp_type_count = 0 THEN
14:33:54  61  	  RAISE BAD_NOTIFICATION_TYPE_ID;
14:33:54  62  	END IF;
14:33:54  63  
14:33:54  64  	INSERT INTO NOTIFICATION (
14:33:54  65  	  ID,
14:33:54  66  	  ACCOUNT_ID,
14:33:54  67  	  GROUP_ID,
14:33:54  68  	  NOTIFICATION_TYPE_ID,
14:33:54  69  	  NOTIFICATION_STATUS_ID,
14:33:54  70  	  EMAIL_TEMPLATE_PARAMS,
14:33:54  71  	  UPDATE_DATE,
14:33:54  72  	  CREATE_DATE,
14:33:54  73  	  DATE_TO_NOTIFY
14:33:54  74  	) VALUES (
14:33:54  75  	  NOT_ID_SEQ.nextVal,
14:33:54  76  	  in_sender_account_id,
14:33:54  77  	  in_recipient_group_id,
14:33:54  78  	  in_notification_type_id,
14:33:54  79  	  NOTIFICATION_STATUSES_V22.NOTIFICATION_PENDING,
14:33:54  80  	  in_email_template_params,
14:33:54  81  	  var_create_date,
14:33:54  82  	  var_create_date,
14:33:54  83  	  in_date_to_notify
14:33:54  84  	);
14:33:54  85  
14:33:54  86  	--BEGIN
14:33:54  87  	--  OPS_HIST_OWNER.PUBLIC_PROCS_OPS_V22.CREATE_NOTIFICATION_HISTORY (
14:33:54  88  	--    in_account_id		  => 0, -- ACCOUNT_ID. Can we delete it?
14:33:54  89  	--    in_group_id		  => in_recipient_group_id,
14:33:54  90  	--    notification_reason_type_id => in_notification_type_id,
14:33:54  91  	--    notification_status_id	  => NOTIFICATION_STATUSES_V22.NOTIFICATION_PENDING,
14:33:54  92  	--    email_template_params	  => in_email_template_params,
14:33:54  93  	--    in_create_date		  => var_create_date
14:33:54  94  	--  );
14:33:54  95  	--  EXCEPTION
14:33:54  96  	--    WHEN OTHERS THEN
14:33:54  97  	--	EXCEPTION_MESSAGE := SQLERRM;
14:33:54  98  	--	RAISE CAN_NOT_CREATE_HISTORY;
14:33:54  99  	--END;
14:33:54 100  
14:33:54 101  EXCEPTION
14:33:54 102  WHEN BAD_NOTIFICATION_TYPE_ID THEN
14:33:54 103  	PROCS_COMMON_V22.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 104  	  SPROC_NAME, 'No such notification status');
14:33:54 105  WHEN CAN_NOT_CREATE_HISTORY THEN
14:33:54 106  	PROCS_COMMON_V22.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 107  	  SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
14:33:54 108  WHEN OTHERS THEN
14:33:54 109  	PROCS_COMMON_V22.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 110  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 111  END ADD_NOTIFICATION;
14:33:54 112  
14:33:54 113  /******************************************************************************/
14:33:54 114  
14:33:54 115  PROCEDURE GET_PENDING_NOTIFICATIONS (
14:33:54 116  /*
14:33:54 117  Throws exceptions:
14:33:54 118  CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 119  */
14:33:54 120  	out_result_set OUT SYS_REFCURSOR
14:33:54 121  ) AS
14:33:54 122  SPROC_NAME CONSTANT VARCHAR2(32) := 'GET_PENDING_NOTIFICATIONS';
14:33:54 123  -- CONSTANTS
14:33:54 124  C_NOTIFICATION_COUNT_LIMIT CONSTANT NUMBER := 500;
14:33:54 125  BEGIN
14:33:54 126  	OPEN out_result_set FOR
14:33:54 127  SELECT * FROM
14:33:54 128  (
14:33:54 129  	SELECT
14:33:54 130  	  NOTIFICATION.ID
14:33:54 131  	FROM
14:33:54 132  	  NOTIFICATION
14:33:54 133  	  INNER JOIN NOTIFICATION_TYPE ON NOTIFICATION.NOTIFICATION_TYPE_ID = NOTIFICATION_TYPE.ID
14:33:54 134  	WHERE
14:33:54 135  	  ROWNUM <= C_NOTIFICATION_COUNT_LIMIT*10
14:33:54 136  	  AND NOT EXISTS (
14:33:54 137  	    SELECT NULL
14:33:54 138  	    FROM PROCESS_RETRY_THROTTLE
14:33:54 139  	    WHERE GENERIC_ID = NOTIFICATION.ID AND PROCESS_NAME = SPROC_NAME
14:33:54 140  	  )
14:33:54 141  	  AND (
14:33:54 142  	    NOTIFICATION.NOTIFICATION_STATUS_ID = NOTIFICATION_STATUSES_V22.NOTIFICATION_PENDING
14:33:54 143  	    OR NOTIFICATION.NOTIFICATION_STATUS_ID = NOTIFICATION_STATUSES_V22.NOTIFICATION_FAILED
14:33:54 144  	  )
14:33:54 145  	  AND (
14:33:54 146  	    NOTIFICATION.DATE_TO_NOTIFY IS NULL OR SYSDATE > NOTIFICATION.DATE_TO_NOTIFY
14:33:54 147  	  )ORDER BY dbms_random.value
14:33:54 148  ) WHERE
14:33:54 149  	ROWNUM <= C_NOTIFICATION_COUNT_LIMIT;
14:33:54 150  
14:33:54 151  EXCEPTION
14:33:54 152  WHEN OTHERS THEN
14:33:54 153  	PROCS_COMMON_V22.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 154  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 155  END GET_PENDING_NOTIFICATIONS;
14:33:54 156  
14:33:54 157  /******************************************************************************/
14:33:54 158  
14:33:54 159  PROCEDURE UPDATE_NOTIFICATION_TIMESTAMP (
14:33:54 160  /*
14:33:54 161  Throws exceptions:
14:33:54 162  CORE_OWNER.APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 163  CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 164  */
14:33:54 165  	in_notification_id IN NUMBER
14:33:54 166  ) AS
14:33:54 167  SPROC_NAME CONSTANT VARCHAR2(32) := 'UPDATE_NOTIFICATION_TIMESTAMP';
14:33:54 168  -- VARIABLES
14:33:54 169  temp_notification_id NUMBER;
14:33:54 170  -- EXCEPTIONS
14:33:54 171  BAD_NOTIFICATION_ID EXCEPTION;
14:33:54 172  BEGIN
14:33:54 173  
14:33:54 174  	BEGIN
14:33:54 175  	  SELECT
14:33:54 176  	    NOTIFICATION.ID into temp_notification_id
14:33:54 177  	  FROM
14:33:54 178  	    NOTIFICATION
14:33:54 179  	  WHERE
14:33:54 180  	    NOTIFICATION.ID = in_notification_id;
14:33:54 181  	  EXCEPTION
14:33:54 182  	    WHEN NO_DATA_FOUND THEN
14:33:54 183  	      RAISE BAD_NOTIFICATION_ID;
14:33:54 184  	END;
14:33:54 185  
14:33:54 186  	UPDATE
14:33:54 187  	  NOTIFICATION
14:33:54 188  	SET
14:33:54 189  	  NOTIFICATION.UPDATE_DATE = sysdate
14:33:54 190  	WHERE
14:33:54 191  	  NOTIFICATION.ID = in_notification_id;
14:33:54 192  
14:33:54 193  EXCEPTION
14:33:54 194  WHEN BAD_NOTIFICATION_ID THEN
14:33:54 195  	PROCS_COMMON_V22.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 196  	  SPROC_NAME, 'No such notification');
14:33:54 197  WHEN OTHERS THEN
14:33:54 198  	PROCS_COMMON_V22.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 199  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 200  END UPDATE_NOTIFICATION_TIMESTAMP;
14:33:54 201  
14:33:54 202  /******************************************************************************/
14:33:54 203  
14:33:54 204  PROCEDURE SET_NOTIFICATION_STATUS (
14:33:54 205  /*
14:33:54 206  Throws exceptions:
14:33:54 207  CORE_OWNER.APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 208  CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 209  */
14:33:54 210  	in_notification_id	  IN NUMBER,
14:33:54 211  	in_notification_status_id IN NUMBER,
14:33:54 212  	in_error_message	  IN VARCHAR2
14:33:54 213  ) AS
14:33:54 214  SPROC_NAME CONSTANT VARCHAR2(32) := 'SET_NOTIFICATION_STATUS';
14:33:54 215  -- VARIABLES
14:33:54 216  var_group_id		NUMBER;
14:33:54 217  var_account_id		NUMBER;
14:33:54 218  var_notification_type_id	NUMBER;
14:33:54 219  var_email_template_params CLOB;
14:33:54 220  var_create_history_date	DATE := SYSDATE;
14:33:54 221  var_notification_status_id   NUMBER;
14:33:54 222  var_date_to_notify	DATE;
14:33:54 223  max_fails   NUMBER := 5;
14:33:54 224  num_fails   NUMBER;
14:33:54 225  -- EXCEPTIONS
14:33:54 226  BAD_NOTIFICATION_ID	 EXCEPTION;
14:33:54 227  BAD_NOTIFICATION_STATUS_ID EXCEPTION;
14:33:54 228  CAN_NOT_CREATE_HISTORY	 EXCEPTION;
14:33:54 229  EXCEPTION_MESSAGE 	 VARCHAR2(1024);
14:33:54 230  BEGIN
14:33:54 231  
14:33:54 232  	IF in_notification_status_id != NOTIFICATION_STATUSES_V22.NOTIFICATION_SENT
14:33:54 233  	  AND in_notification_status_id != NOTIFICATION_STATUSES_V22.NOTIFICATION_PENDING
14:33:54 234  	  AND in_notification_status_id != NOTIFICATION_STATUSES_V22.NOTIFICATION_FAILED THEN
14:33:54 235  	  RAISE BAD_NOTIFICATION_STATUS_ID;
14:33:54 236  	END IF;
14:33:54 237  
14:33:54 238  	BEGIN
14:33:54 239  	  SELECT
14:33:54 240  	    NOTIFICATION.GROUP_ID,
14:33:54 241  	    NOTIFICATION.ACCOUNT_ID,
14:33:54 242  	    NOTIFICATION.NOTIFICATION_TYPE_ID,
14:33:54 243  	    NOTIFICATION.NOTIFICATION_STATUS_ID,
14:33:54 244  	    NOTIFICATION.EMAIL_TEMPLATE_PARAMS,
14:33:54 245  	    NOTIFICATION.DATE_TO_NOTIFY
14:33:54 246  	    into
14:33:54 247  	    var_group_id,
14:33:54 248  	    var_account_id,
14:33:54 249  	    var_notification_type_id,
14:33:54 250  	    var_notification_status_id,
14:33:54 251  	    var_email_template_params,
14:33:54 252  	    var_date_to_notify
14:33:54 253  	  FROM
14:33:54 254  	    NOTIFICATION
14:33:54 255  	  WHERE
14:33:54 256  	    NOTIFICATION.ID = in_notification_id;
14:33:54 257  	  EXCEPTION
14:33:54 258  	    WHEN NO_DATA_FOUND THEN
14:33:54 259  	      RAISE BAD_NOTIFICATION_ID;
14:33:54 260  	END;
14:33:54 261  
14:33:54 262  	BEGIN
14:33:54 263  	  CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V22.CREATE_NOTIFICATION_HISTORY (
14:33:54 264  	    in_notification_id		=> in_notification_id,
14:33:54 265  	    in_account_id		=> var_account_id,
14:33:54 266  	    in_group_id 		=> var_group_id,
14:33:54 267  	    notification_reason_type_id => var_notification_type_id,
14:33:54 268  	    notification_status_id	=> var_notification_status_id,
14:33:54 269  	    email_template_params	=> var_email_template_params,
14:33:54 270  	    in_create_date		=> var_create_history_date,
14:33:54 271  	    in_date_to_notify		=> var_date_to_notify
14:33:54 272  	  );
14:33:54 273  	  EXCEPTION
14:33:54 274  	    WHEN OTHERS THEN
14:33:54 275  	      EXCEPTION_MESSAGE := SQLERRM;
14:33:54 276  	      RAISE CAN_NOT_CREATE_HISTORY;
14:33:54 277  	END;
14:33:54 278  
14:33:54 279  	UPDATE
14:33:54 280  	  NOTIFICATION
14:33:54 281  	SET
14:33:54 282  	  NOTIFICATION.NOTIFICATION_STATUS_ID = in_notification_status_id,
14:33:54 283  	  NOTIFICATION.UPDATE_DATE = sysdate
14:33:54 284  	WHERE
14:33:54 285  	  NOTIFICATION.ID = in_notification_id;
14:33:54 286  
14:33:54 287  	IF ( in_error_message IS NOT NULL ) THEN
14:33:54 288  	  ADD_NOTIFICATION_FAILURE(
14:33:54 289  	    in_notification_id => in_notification_id,
14:33:54 290  	    in_error_message => in_error_message
14:33:54 291  	  );
14:33:54 292  	END IF;
14:33:54 293  
14:33:54 294  	SELECT COUNT(1) INTO num_fails
14:33:54 295  	FROM NOTIFICATION_FAILURE
14:33:54 296  	WHERE NOTIFICATION_ID = in_notification_id;
14:33:54 297  
14:33:54 298  	IF (in_notification_status_id = NOTIFICATION_STATUSES_V22.NOTIFICATION_SENT OR num_fails >= max_fails) then
14:33:54 299  	  FOR REC IN (
14:33:54 300  	      SELECT ID, NOTIFICATION_ID, ERROR_MESSAGE, CREATE_DATE
14:33:54 301  	      FROM NOTIFICATION_FAILURE
14:33:54 302  	      WHERE NOTIFICATION_ID = in_notification_id
14:33:54 303  	      ) LOOP
14:33:54 304  	      BEGIN
14:33:54 305  		CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V22.CREATE_NOTIF_FAILURE_HISTORY(
14:33:54 306  		  in_error_message	   => REC.ERROR_MESSAGE,
14:33:54 307  		  in_notification_id	   => REC.NOTIFICATION_ID,
14:33:54 308  		  in_create_date	   => REC.CREATE_DATE
14:33:54 309  		);
14:33:54 310  		EXCEPTION
14:33:54 311  		  WHEN OTHERS THEN
14:33:54 312  		    EXCEPTION_MESSAGE := SQLERRM;
14:33:54 313  		    RAISE CAN_NOT_CREATE_HISTORY;
14:33:54 314  	      END;
14:33:54 315  	  END LOOP;
14:33:54 316  	  DELETE FROM NOTIFICATION_FAILURE WHERE NOTIFICATION_ID = in_notification_id;
14:33:54 317  
14:33:54 318  	  BEGIN
14:33:54 319  	    SELECT
14:33:54 320  	      NOTIFICATION.GROUP_ID,
14:33:54 321  	      NOTIFICATION.ACCOUNT_ID,
14:33:54 322  	      NOTIFICATION.NOTIFICATION_TYPE_ID,
14:33:54 323  	      NOTIFICATION.NOTIFICATION_STATUS_ID,
14:33:54 324  	      NOTIFICATION.EMAIL_TEMPLATE_PARAMS,
14:33:54 325  	      NOTIFICATION.DATE_TO_NOTIFY
14:33:54 326  	      into
14:33:54 327  	      var_group_id,
14:33:54 328  	      var_account_id,
14:33:54 329  	      var_notification_type_id,
14:33:54 330  	      var_notification_status_id,
14:33:54 331  	      var_email_template_params,
14:33:54 332  	      var_date_to_notify
14:33:54 333  	    FROM
14:33:54 334  	      NOTIFICATION
14:33:54 335  	    WHERE
14:33:54 336  	      NOTIFICATION.ID = in_notification_id;
14:33:54 337  	    EXCEPTION
14:33:54 338  	      WHEN NO_DATA_FOUND THEN
14:33:54 339  		RAISE BAD_NOTIFICATION_ID;
14:33:54 340  	  END;
14:33:54 341  
14:33:54 342  	  BEGIN
14:33:54 343  	    CORE_HIST_OWNER.PUBLIC_PROCS_CORE_V22.CREATE_NOTIFICATION_HISTORY (
14:33:54 344  	      in_notification_id	  => in_notification_id,
14:33:54 345  	      in_account_id		  => var_account_id,
14:33:54 346  	      in_group_id		  => var_group_id,
14:33:54 347  	      notification_reason_type_id => var_notification_type_id,
14:33:54 348  	      notification_status_id	  => var_notification_status_id,
14:33:54 349  	      email_template_params	  => var_email_template_params,
14:33:54 350  	      in_create_date		  => var_create_history_date,
14:33:54 351  	      in_date_to_notify 	  => var_date_to_notify
14:33:54 352  	    );
14:33:54 353  	    EXCEPTION
14:33:54 354  	      WHEN OTHERS THEN
14:33:54 355  		EXCEPTION_MESSAGE := SQLERRM;
14:33:54 356  		RAISE CAN_NOT_CREATE_HISTORY;
14:33:54 357  	  END;
14:33:54 358  
14:33:54 359  	  DELETE FROM NOTIFICATION WHERE ID = in_notification_id;
14:33:54 360  
14:33:54 361  	END IF;
14:33:54 362  	commit;
14:33:54 363  
14:33:54 364  EXCEPTION
14:33:54 365  WHEN BAD_NOTIFICATION_STATUS_ID THEN
14:33:54 366  	PROCS_COMMON_V22.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 367  	  SPROC_NAME, 'Bad notification status');
14:33:54 368  WHEN BAD_NOTIFICATION_ID THEN
14:33:54 369  	PROCS_COMMON_V22.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 370  	  SPROC_NAME, 'No such notification');
14:33:54 371  WHEN CAN_NOT_CREATE_HISTORY THEN
14:33:54 372  	PROCS_COMMON_V22.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 373  	  SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
14:33:54 374  WHEN OTHERS THEN
14:33:54 375  	PROCS_COMMON_V22.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 376  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 377  END SET_NOTIFICATION_STATUS;
14:33:54 378  
14:33:54 379  /******************************************************************************/
14:33:54 380  
14:33:54 381  PROCEDURE ADD_NOTIFICATION_FAILURE (
14:33:54 382  /*
14:33:54 383  Throws exceptions:
14:33:54 384  CORE_OWNER.APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 385  CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 386  */
14:33:54 387  	in_notification_id IN NUMBER,
14:33:54 388  	in_error_message   IN VARCHAR2
14:33:54 389  ) AS
14:33:54 390  SPROC_NAME CONSTANT VARCHAR2(32) := 'ADD_NOTIFICATION_FAILURE';
14:33:54 391  -- VARIABLES
14:33:54 392  temp_notification_id NUMBER;
14:33:54 393  var_create_date	   DATE := SYSDATE;
14:33:54 394  -- EXCEPTIONS
14:33:54 395  BAD_NOTIFICATION_ID	 EXCEPTION;
14:33:54 396  CAN_NOT_CREATE_HISTORY	 EXCEPTION;
14:33:54 397  EXCEPTION_MESSAGE 	 VARCHAR2(1024);
14:33:54 398  BEGIN
14:33:54 399  
14:33:54 400  	BEGIN
14:33:54 401  	  SELECT
14:33:54 402  	    NOTIFICATION.ID into temp_notification_id
14:33:54 403  	  FROM
14:33:54 404  	    NOTIFICATION
14:33:54 405  	  WHERE
14:33:54 406  	    NOTIFICATION.ID = in_notification_id;
14:33:54 407  	  EXCEPTION
14:33:54 408  	    WHEN NO_DATA_FOUND THEN
14:33:54 409  	      RAISE BAD_NOTIFICATION_ID;
14:33:54 410  	END;
14:33:54 411  
14:33:54 412  	INSERT INTO NOTIFICATION_FAILURE (
14:33:54 413  	  ID,
14:33:54 414  	  NOTIFICATION_ID,
14:33:54 415  	  ERROR_MESSAGE,
14:33:54 416  	  CREATE_DATE
14:33:54 417  	) VALUES (
14:33:54 418  	  NOTF_ID_SEQ.nextVal,
14:33:54 419  	  in_notification_id,
14:33:54 420  	  in_error_message,
14:33:54 421  	  sysdate
14:33:54 422  	);
14:33:54 423  
14:33:54 424  	--BEGIN
14:33:54 425  	--  OPS_HIST_OWNER.PUBLIC_PROCS_OPS_V22.CREATE_NOTIF_FAILURE_HISTORY(
14:33:54 426  	--    in_error_message	       => in_error_message,
14:33:54 427  	--    in_notification_queue_id => in_notification_id,
14:33:54 428  	--    in_create_date	       => var_create_date
14:33:54 429  	--  );
14:33:54 430  	--  EXCEPTION
14:33:54 431  	--    WHEN OTHERS THEN
14:33:54 432  	--	EXCEPTION_MESSAGE := SQLERRM;
14:33:54 433  	--	RAISE CAN_NOT_CREATE_HISTORY;
14:33:54 434  	--END;
14:33:54 435  
14:33:54 436  EXCEPTION
14:33:54 437  WHEN BAD_NOTIFICATION_ID THEN
14:33:54 438  	PROCS_COMMON_V22.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 439  	  SPROC_NAME, 'No such notification');
14:33:54 440  WHEN CAN_NOT_CREATE_HISTORY THEN
14:33:54 441  	PROCS_COMMON_V22.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V22.INTERNAL_ERROR,
14:33:54 442  	  SPROC_NAME, 'Could not create history', EXCEPTION_MESSAGE);
14:33:54 443  WHEN OTHERS THEN
14:33:54 444  	PROCS_COMMON_V22.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 445  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 446  END ADD_NOTIFICATION_FAILURE;
14:33:54 447  
14:33:54 448  /******************************************************************************/
14:33:54 449  
14:33:54 450  PROCEDURE LOCK_PENDING_NOTIFICATION (
14:33:54 451  /*
14:33:54 452  Result: GLOBAL_STATUSES.TRUE if notification locked
14:33:54 453  GLOBA_STATUSES.FALSE - else
14:33:54 454  */
14:33:54 455  	in_notification_id IN NUMBER,
14:33:54 456  	out_lock_status    OUT NUMBER
14:33:54 457  ) AS
14:33:54 458  SPROC_NAME CONSTANT VARCHAR2(25) := 'LOCK_PENDING_NOTIFICATION';
14:33:54 459  -- VARIABLE
14:33:54 460  temp_notification_id NUMBER;
14:33:54 461  BEGIN
14:33:54 462  	SELECT
14:33:54 463  	  NOTIFICATION.ID into temp_notification_id
14:33:54 464  	FROM
14:33:54 465  	  NOTIFICATION
14:33:54 466  	WHERE
14:33:54 467  	  NOTIFICATION.ID = in_notification_id
14:33:54 468  	  AND (
14:33:54 469  	    NOTIFICATION.NOTIFICATION_STATUS_ID = NOTIFICATION_STATUSES_V22.NOTIFICATION_PENDING
14:33:54 470  	    OR NOTIFICATION.NOTIFICATION_STATUS_ID = NOTIFICATION_STATUSES_V22.NOTIFICATION_FAILED
14:33:54 471  	  )
14:33:54 472  	FOR UPDATE;
14:33:54 473  
14:33:54 474  	out_lock_status := 1;
14:33:54 475  
14:33:54 476  EXCEPTION
14:33:54 477  WHEN NO_DATA_FOUND THEN
14:33:54 478  	out_lock_status := 0;
14:33:54 479  WHEN OTHERS THEN
14:33:54 480  	PROCS_COMMON_V22.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 481  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 482  END LOCK_PENDING_NOTIFICATION;
14:33:54 483  
14:33:54 484  /******************************************************************************/
14:33:54 485  
14:33:54 486  PROCEDURE GET_NOTIFICATION_DATA (
14:33:54 487  	in_notification_id IN NUMBER,
14:33:54 488  	out_result_set	   OUT SYS_REFCURSOR
14:33:54 489  ) AS
14:33:54 490  SPROC_NAME CONSTANT VARCHAR2(21) := 'GET_NOTIFICATION_DATA';
14:33:54 491  BEGIN
14:33:54 492  	OPEN out_result_set FOR
14:33:54 493  	SELECT
14:33:54 494  	  NOTIFICATION.ID,
14:33:54 495  	  NOTIFICATION.GROUP_ID,
14:33:54 496  	  NOTIFICATION.EMAIL_TEMPLATE_PARAMS,
14:33:54 497  	  NOTIFICATION.NOTIFICATION_STATUS_ID,
14:33:54 498  	  NOTIFICATION.CREATE_DATE,
14:33:54 499  	  NOTIFICATION.UPDATE_DATE,
14:33:54 500  	  NOTIFICATION.NOTIFICATION_TYPE_ID,
14:33:54 501  	  NOTIFICATION_TYPE.VALUE as "TYPE_VALUE",
14:33:54 502  	  NOTIFICATION_TYPE.TEMPLATE_URL
14:33:54 503  	FROM
14:33:54 504  	  NOTIFICATION
14:33:54 505  	  INNER JOIN NOTIFICATION_TYPE ON NOTIFICATION.NOTIFICATION_TYPE_ID = NOTIFICATION_TYPE.ID
14:33:54 506  	WHERE
14:33:54 507  	  NOTIFICATION.ID = in_notification_id;
14:33:54 508  
14:33:54 509  EXCEPTION
14:33:54 510  WHEN OTHERS THEN
14:33:54 511  	PROCS_COMMON_V22.THROW_EXCEPTION(CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR,
14:33:54 512  	  SPROC_NAME, 'Unknown error', SQLERRM);
14:33:54 513  END GET_NOTIFICATION_DATA;
14:33:54 514  
14:33:54 515  END PROCS_NOTIFICATION_V22;
14:33:54 516  .
14:33:54 SQL> /

Package body created.

Elapsed: 00:00:00.05
14:33:54 SQL> 
14:33:54 SQL> CREATE OR REPLACE PACKAGE BODY "PUBLIC_PROCS_BILLING_V22" AS
14:33:54   2  
14:33:54   3  PROCEDURE GET_OFFER_CHAIN_BY_ID (
14:33:54   4  /*
14:33:54   5  Throws exceptions:
14:33:54   6  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54   7  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54   8  */
14:33:54   9  	  in_offer_chain_id IN	 NUMBER,
14:33:54  10  	  out_result_set    OUT  SYS_REFCURSOR
14:33:54  11  ) AS
14:33:54  12  BEGIN
14:33:54  13  	PROCS_OFFER_CHAIN_V22.GET_OFFER_CHAIN_BY_ID (
14:33:54  14  	  in_offer_chain_id => in_offer_chain_id,
14:33:54  15  	  out_result_set => out_result_set
14:33:54  16  	);
14:33:54  17  END GET_OFFER_CHAIN_BY_ID;
14:33:54  18  
14:33:54  19  PROCEDURE GET_PENDING_INVOICES (
14:33:54  20  /*
14:33:54  21  Throws exceptions:
14:33:54  22  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54  23  */
14:33:54  24  	out_result_set	     OUT SYS_REFCURSOR,
14:33:54  25  	in_row_number	     IN NUMBER DEFAULT NULL
14:33:54  26  ) AS
14:33:54  27  BEGIN
14:33:54  28  	PROCS_INVOICE_V22.GET_PENDING_INVOICES(
14:33:54  29  	  out_result_set,
14:33:54  30  	  in_row_number
14:33:54  31  	);
14:33:54  32  END GET_PENDING_INVOICES;
14:33:54  33  
14:33:54  34  /********************************************************/
14:33:54  35  PROCEDURE GET_PENDING_REFUND_CHARGES (
14:33:54  36  /*
14:33:54  37  Throws exceptions:
14:33:54  38  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54  39  */
14:33:54  40  	out_result_set	    OUT SYS_REFCURSOR,
14:33:54  41  	in_row_number	    IN NUMBER DEFAULT NULL
14:33:54  42  ) AS
14:33:54  43  BEGIN
14:33:54  44  	PROCS_CHARGE_V22.GET_PENDING_REFUND_CHARGES(
14:33:54  45  	  out_result_set,
14:33:54  46  	  in_row_number
14:33:54  47  	);
14:33:54  48  END GET_PENDING_REFUND_CHARGES;
14:33:54  49  /********************************************************/
14:33:54  50  
14:33:54  51  PROCEDURE GET_UNPROCESSED_CHARGES (
14:33:54  52  /*
14:33:54  53  Throws exceptions:
14:33:54  54  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54  55  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54  56  */
14:33:54  57  	in_invoice_id  IN NUMBER,
14:33:54  58  	out_result_set OUT SYS_REFCURSOR
14:33:54  59  ) AS
14:33:54  60  BEGIN
14:33:54  61  	PROCS_CHARGE_V22.GET_UNPROCESSED_CHARGES(
14:33:54  62  	  in_invoice_id,
14:33:54  63  	  out_result_set
14:33:54  64  	);
14:33:54  65  END GET_UNPROCESSED_CHARGES;
14:33:54  66  
14:33:54  67  /********************************************************/
14:33:54  68  
14:33:54  69  PROCEDURE GET_PROCESSED_CHARGES (
14:33:54  70  /*
14:33:54  71  Throws exceptions:
14:33:54  72  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54  73  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54  74  */
14:33:54  75  	in_invoice_id  IN NUMBER,
14:33:54  76  	out_result_set OUT SYS_REFCURSOR
14:33:54  77  ) AS
14:33:54  78  BEGIN
14:33:54  79  	PROCS_CHARGE_V22.GET_PROCESSED_CHARGES(
14:33:54  80  	  in_invoice_id,
14:33:54  81  	  out_result_set
14:33:54  82  	);
14:33:54  83  END GET_PROCESSED_CHARGES;
14:33:54  84  
14:33:54  85  /********************************************************/
14:33:54  86  
14:33:54  87  PROCEDURE GET_TRNSCTN_ATTEMPTS_BY_STATUS (
14:33:54  88  /*
14:33:54  89  Throws exceptions:
14:33:54  90  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54  91  */
14:33:54  92  	in_transaction_id	      IN NUMBER,
14:33:54  93  	in_transaction_attempt_status IN NUMBER,
14:33:54  94  	out_result_set		      OUT SYS_REFCURSOR
14:33:54  95  ) AS
14:33:54  96  BEGIN
14:33:54  97  	PROCS_TRANSACTION_V22.GET_TRNSCTN_ATTEMPTS_BY_STATUS(
14:33:54  98  	  in_transaction_id,
14:33:54  99  	  in_transaction_attempt_status,
14:33:54 100  	  out_result_set
14:33:54 101  	);
14:33:54 102  END GET_TRNSCTN_ATTEMPTS_BY_STATUS;
14:33:54 103  
14:33:54 104  /********************************************************/
14:33:54 105  
14:33:54 106  PROCEDURE UPDATE_TRNSCTN_ATTEMPT_STATUS (
14:33:54 107  /*
14:33:54 108  Throws exceptions:
14:33:54 109  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 110  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 111  */
14:33:54 112  	in_transaction_attempt_id     IN NUMBER,
14:33:54 113  	in_transaction_attempt_status IN NUMBER
14:33:54 114  ) AS
14:33:54 115  BEGIN
14:33:54 116  	PROCS_TRANSACTION_V22.UPDATE_TRNSCTN_ATTEMPT_STATUS(
14:33:54 117  	   in_transaction_attempt_id,
14:33:54 118  	   in_transaction_attempt_status
14:33:54 119  	);
14:33:54 120  END UPDATE_TRNSCTN_ATTEMPT_STATUS;
14:33:54 121  
14:33:54 122  /********************************************************/
14:33:54 123  PROCEDURE GET_CLOSED_REFUNDS_BY_INVOICE (
14:33:54 124  /*
14:33:54 125  Throws exceptions:
14:33:54 126  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 127  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 128  */
14:33:54 129  	in_invoice_id	IN  NUMBER,
14:33:54 130  	out_result_set OUT SYS_REFCURSOR
14:33:54 131  ) AS
14:33:54 132  BEGIN
14:33:54 133  	PROCS_TRANSACTION_V22.GET_CLOSED_REFUNDS_BY_INVOICE(
14:33:54 134  	   in_invoice_id,
14:33:54 135  	   out_result_set
14:33:54 136  	);
14:33:54 137  END GET_CLOSED_REFUNDS_BY_INVOICE;
14:33:54 138  
14:33:54 139  /********************************************************/
14:33:54 140  
14:33:54 141  PROCEDURE UPDATE_TRNSCTN_ATTEMPT_TIME (
14:33:54 142  /*
14:33:54 143  Throws exceptions:
14:33:54 144  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 145  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 146  */
14:33:54 147  	in_transaction_attempt_id IN NUMBER,
14:33:54 148  	in_updated_by		  IN VARCHAR2
14:33:54 149  ) AS
14:33:54 150  BEGIN
14:33:54 151  	PROCS_TRANSACTION_V22.UPDATE_TRNSCTN_ATTEMPT_TIME(
14:33:54 152  	  in_transaction_attempt_id,
14:33:54 153  	  in_updated_by
14:33:54 154  	);
14:33:54 155  END UPDATE_TRNSCTN_ATTEMPT_TIME;
14:33:54 156  
14:33:54 157  /********************************************************/
14:33:54 158  
14:33:54 159  PROCEDURE CREATE_TRANSACTION_ATTEMPT (
14:33:54 160  /*
14:33:54 161  Throws exceptions:
14:33:54 162  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 163  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 164  */
14:33:54 165  	in_transaction_id	   IN NUMBER,
14:33:54 166  	in_trans_attempt_status    IN NUMBER,
14:33:54 167  	in_external_status_code    IN VARCHAR2,
14:33:54 168  	in_external_status_message IN VARCHAR2,
14:33:54 169  	in_created_by		   IN VARCHAR2,
14:33:54 170  	in_ext_transaction_id	   IN VARCHAR2,
14:33:54 171  	out_transaction_attempt_id OUT NUMBER
14:33:54 172  ) AS
14:33:54 173  BEGIN
14:33:54 174  	PROCS_TRANSACTION_V22.CREATE_TRANSACTION_ATTEMPT(
14:33:54 175  	  in_transaction_id,
14:33:54 176  	  in_trans_attempt_status,
14:33:54 177  	  in_external_status_code,
14:33:54 178  	  in_external_status_message,
14:33:54 179  	  in_created_by,
14:33:54 180  	  in_ext_transaction_id,
14:33:54 181  	  out_transaction_attempt_id
14:33:54 182  	);
14:33:54 183  END CREATE_TRANSACTION_ATTEMPT;
14:33:54 184  
14:33:54 185  /********************************************************/
14:33:54 186  
14:33:54 187  PROCEDURE UPDATE_TRANSACTION_ATTEMPT_INF (
14:33:54 188  /*
14:33:54 189  Throws exceptions:
14:33:54 190  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 191  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 192  */
14:33:54 193  	in_transaction_attempt_id IN NUMBER,
14:33:54 194  	in_ext_status_code	  IN VARCHAR2,
14:33:54 195  	in_ext_status_message	  IN VARCHAR2,
14:33:54 196  	in_ext_transaction_id	  IN VARCHAR2
14:33:54 197  ) AS
14:33:54 198  BEGIN
14:33:54 199  	PROCS_TRANSACTION_V22.UPDATE_TRANSACTION_ATTEMPT_INF(
14:33:54 200  	  in_transaction_attempt_id,
14:33:54 201  	  in_ext_status_code,
14:33:54 202  	  in_ext_status_message,
14:33:54 203  	  in_ext_transaction_id
14:33:54 204  	);
14:33:54 205  END UPDATE_TRANSACTION_ATTEMPT_INF;
14:33:54 206  
14:33:54 207  /********************************************************/
14:33:54 208  
14:33:54 209  PROCEDURE UPDATE_TRANSACTION_STATUS (
14:33:54 210  /*
14:33:54 211  Throws exceptions:
14:33:54 212  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 213  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 214  */
14:33:54 215  	in_transaction_id	 IN NUMBER,
14:33:54 216  	in_updated_by		 IN VARCHAR2,
14:33:54 217  	in_transaction_status_id IN NUMBER
14:33:54 218  ) AS
14:33:54 219  BEGIN
14:33:54 220  	PROCS_TRANSACTION_V22.UPDATE_TRANSACTION_STATUS(
14:33:54 221  	  in_transaction_id,
14:33:54 222  	  in_updated_by,
14:33:54 223  	  in_transaction_status_id
14:33:54 224  	);
14:33:54 225  END UPDATE_TRANSACTION_STATUS;
14:33:54 226  
14:33:54 227  /********************************************************/
14:33:54 228  
14:33:54 229  PROCEDURE GET_FAILED_ATTEMPTS_NUMBER (
14:33:54 230  /*
14:33:54 231  Throws exceptions:
14:33:54 232  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 233  */
14:33:54 234  	in_transaction_id IN  NUMBER,
14:33:54 235  	out_attempts_num  OUT NUMBER
14:33:54 236  ) AS
14:33:54 237  BEGIN
14:33:54 238  	PROCS_TRANSACTION_V22.GET_FAILED_ATTEMPTS_NUMBER(
14:33:54 239  	  in_transaction_id,
14:33:54 240  	  out_attempts_num
14:33:54 241  	);
14:33:54 242  END GET_FAILED_ATTEMPTS_NUMBER;
14:33:54 243  
14:33:54 244  /********************************************************/
14:33:54 245  
14:33:54 246  PROCEDURE IS_TRANSACTION_SUCCESSFULL (
14:33:54 247  /*
14:33:54 248  Throws exceptions:
14:33:54 249  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 250  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 251  */
14:33:54 252  	in_transaction_id IN  NUMBER,
14:33:54 253  	out_is_successfull  OUT NUMBER
14:33:54 254  ) AS
14:33:54 255  BEGIN
14:33:54 256  	PROCS_TRANSACTION_V22.IS_TRANSACTION_SUCCESSFULL(
14:33:54 257  	  in_transaction_id,
14:33:54 258  	  out_is_successfull
14:33:54 259  	);
14:33:54 260  END IS_TRANSACTION_SUCCESSFULL;
14:33:54 261  /********************************************************/
14:33:54 262  
14:33:54 263  PROCEDURE UPDATE_INVOICE_STATUS (
14:33:54 264  /*
14:33:54 265  Throws exceptions:
14:33:54 266  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 267  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 268  */
14:33:54 269  	in_invoice_id		       IN NUMBER,
14:33:54 270  	in_invoice_status_id	       IN NUMBER,
14:33:54 271  	in_updated_by		       IN VARCHAR2
14:33:54 272  ) AS
14:33:54 273  BEGIN
14:33:54 274  	PROCS_INVOICE_V22.UPDATE_INVOICE_STATUS(
14:33:54 275  	  in_invoice_id,
14:33:54 276  	  in_invoice_status_id,
14:33:54 277  	  in_updated_by
14:33:54 278  	);
14:33:54 279  END UPDATE_INVOICE_STATUS;
14:33:54 280  
14:33:54 281  /********************************************************/
14:33:54 282  
14:33:54 283  PROCEDURE SUSPEND_SUBSCRIPTION(
14:33:54 284  /*
14:33:54 285  Throws exceptions:
14:33:54 286  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 287  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:54 288  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 289  */
14:33:54 290  	  in_subs_id	IN NUMBER ,
14:33:54 291  	  in_updated_by IN VARCHAR2
14:33:54 292  ) AS
14:33:54 293  BEGIN
14:33:54 294  	PROCS_SUBSCRIPTION_V22.SUSPEND_SUBSCRIPTION(
14:33:54 295  	  in_subs_id,
14:33:54 296  	  in_updated_by
14:33:54 297  	);
14:33:54 298  END SUSPEND_SUBSCRIPTION;
14:33:54 299  
14:33:54 300  /********************************************************/
14:33:54 301  
14:33:54 302  PROCEDURE GET_CREDIT_CARD_BY_ID (
14:33:54 303  /*
14:33:54 304  Throws exceptions:
14:33:54 305  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 306  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 307  */
14:33:54 308  	in_credit_card_id IN  NUMBER,
14:33:54 309  	out_result_set	  OUT SYS_REFCURSOR
14:33:54 310  ) AS
14:33:54 311  BEGIN
14:33:54 312  	PROCS_FIN_INSTRUMENTS_V22.GET_CREDIT_CARD_BY_ID(
14:33:54 313  	  in_credit_card_id,
14:33:54 314  	  out_result_set
14:33:54 315  	);
14:33:54 316  END GET_CREDIT_CARD_BY_ID;
14:33:54 317  
14:33:54 318  /*********************************************************/
14:33:54 319  
14:33:54 320  PROCEDURE GET_TRANSACTION_AMOUNT (
14:33:54 321  /*
14:33:54 322  Throws exceptions:
14:33:54 323  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 324  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 325  */
14:33:54 326  	in_transaction_id      IN  NUMBER,
14:33:54 327  	out_transaction_amount OUT NUMBER
14:33:54 328  ) AS
14:33:54 329  BEGIN
14:33:54 330  	PROCS_TRANSACTION_V22.GET_TRANSACTION_AMOUNT(
14:33:54 331  	  in_transaction_id,
14:33:54 332  	  out_transaction_amount
14:33:54 333  	);
14:33:54 334  END GET_TRANSACTION_AMOUNT;
14:33:54 335  
14:33:54 336  /***********************************************************/
14:33:54 337  
14:33:54 338  PROCEDURE GET_ACCOUNT_BY_INVOICE_ID (
14:33:54 339  /*
14:33:54 340  Throws exceptions:
14:33:54 341  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 342  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 343  */
14:33:54 344  	in_invoice_id  IN  NUMBER,
14:33:54 345  	out_account_id OUT NUMBER
14:33:54 346  ) AS
14:33:54 347  BEGIN
14:33:54 348  	PROCS_INVOICE_V22.GET_ACCOUNT_BY_INVOICE_ID(
14:33:54 349  	  in_invoice_id,
14:33:54 350  	  out_account_id
14:33:54 351  	);
14:33:54 352  END GET_ACCOUNT_BY_INVOICE_ID;
14:33:54 353  
14:33:54 354  /************************************************************/
14:33:54 355  
14:33:54 356  PROCEDURE GET_GIFT_CERTIFICATE_BY_ID (
14:33:54 357  /*
14:33:54 358  Throws exceptions:
14:33:54 359  APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 360  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 361  */
14:33:54 362  	in_gift_certificate_id IN NUMBER,
14:33:54 363  	out_result_set	       OUT SYS_REFCURSOR
14:33:54 364  ) AS
14:33:54 365  BEGIN
14:33:54 366  	PROCS_FIN_INSTRUMENTS_V22.GET_GIFT_CERTIFICATE_BY_ID (
14:33:54 367  	  in_gift_certificate_id,
14:33:54 368  	  out_result_set
14:33:54 369  	);
14:33:54 370  END GET_GIFT_CERTIFICATE_BY_ID;
14:33:54 371  
14:33:54 372  /**************************************************************/
14:33:54 373  
14:33:54 374  PROCEDURE GET_SUBSCR_ID_BY_CHARGE_ID (
14:33:54 375  /*
14:33:54 376  Throws exceptions:
14:33:54 377  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 378  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 379  */
14:33:54 380  	in_charge_id	    IN NUMBER,
14:33:54 381  	out_subscription_id OUT NUMBER
14:33:54 382  ) AS
14:33:54 383  BEGIN
14:33:54 384  	PROCS_CHARGE_V22.GET_SUBSCR_ID_BY_CHARGE_ID(
14:33:54 385  	  in_charge_id,
14:33:54 386  	  out_subscription_id
14:33:54 387  	);
14:33:54 388  END GET_SUBSCR_ID_BY_CHARGE_ID;
14:33:54 389  
14:33:54 390  /**************************************************************/
14:33:54 391  
14:33:54 392  PROCEDURE IS_GCERT_FOR_PROPER_OFFER (
14:33:54 393  /*
14:33:54 394  Throws exceptions:
14:33:54 395  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 396  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 397  */
14:33:54 398  	in_gift_certificate_id IN NUMBER,
14:33:54 399  	in_charge_id	       IN NUMBER,
14:33:54 400  	out_result	       OUT NUMBER
14:33:54 401  ) AS
14:33:54 402  BEGIN
14:33:54 403  	PROCS_FIN_INSTRUMENTS_V22.IS_GCERT_FOR_PROPER_OFFER (
14:33:54 404  	  in_gift_certificate_id,
14:33:54 405  	  in_charge_id,
14:33:54 406  	  out_result
14:33:54 407  	);
14:33:54 408  END IS_GCERT_FOR_PROPER_OFFER;
14:33:54 409  
14:33:54 410  /**************************************************************/
14:33:54 411  
14:33:54 412  PROCEDURE GET_SUBSCRIPTION_INFO (
14:33:54 413  /*
14:33:54 414  Throws exceptions:
14:33:54 415  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 416  */
14:33:54 417  	  in_subscription_id IN  NUMBER,
14:33:54 418  	  out_result_set      OUT SYS_REFCURSOR
14:33:54 419  ) AS
14:33:54 420  BEGIN
14:33:54 421  	PROCS_SUBSCRIPTION_V22.GET_SUBSCRIPTION_INFO (
14:33:54 422  	  in_subscription_id,
14:33:54 423  	  out_result_set
14:33:54 424  	);
14:33:54 425  END GET_SUBSCRIPTION_INFO;
14:33:54 426  
14:33:54 427  /****************************************************************/
14:33:54 428  
14:33:54 429  PROCEDURE CALCULATE_INVOICE_AMOUNT (
14:33:54 430  /*
14:33:54 431  Throws exceptions:
14:33:54 432  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 433  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 434  */
14:33:54 435  	in_invoice_id IN  NUMBER,
14:33:54 436  	out_amount    OUT NUMBER
14:33:54 437  ) AS
14:33:54 438  BEGIN
14:33:54 439  	PROCS_INVOICE_V22.CALCULATE_INVOICE_AMOUNT (
14:33:54 440  	  in_invoice_id,
14:33:54 441  	  out_amount
14:33:54 442  	);
14:33:54 443  END CALCULATE_INVOICE_AMOUNT;
14:33:54 444  
14:33:54 445  /****************************************************************/
14:33:54 446  
14:33:54 447  PROCEDURE GET_TRANSACTION_BY_ID (
14:33:54 448  /*
14:33:54 449  Throws exceptions:
14:33:54 450  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 451  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 452  */
14:33:54 453  	in_transaction_id IN NUMBER,
14:33:54 454  	out_result_set	  OUT SYS_REFCURSOR
14:33:54 455  ) AS
14:33:54 456  BEGIN
14:33:54 457  	PROCS_TRANSACTION_V22.GET_TRANSACTION_BY_ID(
14:33:54 458  	  in_transaction_id,
14:33:54 459  	  out_result_set
14:33:54 460  	);
14:33:54 461  END GET_TRANSACTION_BY_ID;
14:33:54 462  
14:33:54 463  /****************************************************************/
14:33:54 464  
14:33:54 465  PROCEDURE UPDATE_CHARGE_STATUS (
14:33:54 466  /*
14:33:54 467  Throws exceptions:
14:33:54 468  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 469  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 470  */
14:33:54 471  	in_charge_id	    IN CHARGE.ID%TYPE,
14:33:54 472  	in_charge_status_id IN CHARGE.CHARGE_STATUS_ID%TYPE,
14:33:54 473  	in_updated_by	    IN CHARGE.UPDATED_BY%TYPE
14:33:54 474  ) AS
14:33:54 475  BEGIN
14:33:54 476  	PROCS_CHARGE_V22.UPDATE_CHARGE_STATUS(
14:33:54 477  	  in_charge_id,
14:33:54 478  	  in_charge_status_id,
14:33:54 479  	  in_updated_by
14:33:54 480  	);
14:33:54 481  END UPDATE_CHARGE_STATUS;
14:33:54 482  
14:33:54 483  /****************************************************************/
14:33:54 484  
14:33:54 485  PROCEDURE GET_GC_BY_PURCH_INVOICE_ID (
14:33:54 486  	in_invoice_id		IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
14:33:54 487  	out_result_set OUT SYS_REFCURSOR
14:33:54 488  ) AS
14:33:54 489  BEGIN
14:33:54 490  	PROCS_FIN_INSTRUMENTS_V22.GET_GC_BY_PURCH_INVOICE_ID(
14:33:54 491  	  in_invoice_id,
14:33:54 492  	  out_result_set
14:33:54 493  	);
14:33:54 494  END GET_GC_BY_PURCH_INVOICE_ID;
14:33:54 495  
14:33:54 496  /****************************************************************/
14:33:54 497  
14:33:54 498  PROCEDURE UPDATE_TRANSACTION_ORDER_ID (
14:33:54 499  /*
14:33:54 500  Throws exceptions:
14:33:54 501  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 502  APP_EXCEPTION_CODES_V22.INTRNAL_ERROR
14:33:54 503  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 504  */
14:33:54 505  	in_transaction_id IN TRANSACTION.ID%TYPE,
14:33:54 506  	in_order_id	  IN TRANSACTION.ORDER_ID%TYPE,
14:33:54 507  	in_updated_by	  IN TRANSACTION.UPDATED_BY%TYPE
14:33:54 508  ) AS
14:33:54 509  BEGIN
14:33:54 510  	PROCS_TRANSACTION_V22.UPDATE_TRANSACTION_ORDER_ID(
14:33:54 511  	  in_transaction_id,
14:33:54 512  	  in_order_id,
14:33:54 513  	  in_updated_by
14:33:54 514  	);
14:33:54 515  END UPDATE_TRANSACTION_ORDER_ID;
14:33:54 516  
14:33:54 517  /****************************************************************/
14:33:54 518  
14:33:54 519  PROCEDURE GET_ACTIVE_INVOICES_IDS (
14:33:54 520  /*
14:33:54 521  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 522  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 523  */
14:33:54 524  --  in_subscription_id IN SUBSCRIPTION.ID%TYPE,
14:33:54 525  	in_subscription_id IN NUMBER,
14:33:54 526  	out_result_set	   OUT SYS_REFCURSOR
14:33:54 527  ) AS
14:33:54 528  BEGIN
14:33:54 529  	PROCS_SUBSCRIPTION_V22.GET_ACTIVE_INVOICES_IDS(
14:33:54 530  	  in_subscription_id,
14:33:54 531  	  out_result_set
14:33:54 532  	);
14:33:54 533  END GET_ACTIVE_INVOICES_IDS;
14:33:54 534  
14:33:54 535  /****************************************************************/
14:33:54 536  
14:33:54 537  PROCEDURE CANCEL_SUBSCRIPTION_INVOICE (
14:33:54 538  /*
14:33:54 539  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 540  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 541  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:54 542  */
14:33:54 543  --  in_invoice_id        IN INVOICE.ID%TYPE,
14:33:54 544  --  in_updated_by        IN INVOICE.UPDATED_BY%TYPE,
14:33:54 545  -- norlov: in_refundable	      IN refund enabled
14:33:54 546  	in_invoice_id	     IN NUMBER,
14:33:54 547  	in_updated_by	     IN VARCHAR2,
14:33:54 548  	in_refundable	     IN NUMBER DEFAULT GLOBAL_CONSTANTS_V22.FALSE
14:33:54 549  --  in_cancellation_date IN DATE DEFAULT current_timestamp
14:33:54 550  ) AS
14:33:54 551  BEGIN
14:33:54 552  	PROCS_SUBSCRIPTION_V22.CANCEL_SUBSCRIPTION_INVOICE(
14:33:54 553  	  in_invoice_id,
14:33:54 554  	  in_updated_by,
14:33:54 555  	  in_refundable
14:33:54 556  	);
14:33:54 557  END CANCEL_SUBSCRIPTION_INVOICE;
14:33:54 558  
14:33:54 559  /****************************************************************/
14:33:54 560  
14:33:54 561  PROCEDURE FINALIZE_CANCELATION (
14:33:54 562  /*
14:33:54 563  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 564  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 565  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:54 566  */
14:33:54 567  --  in_subscription_id	IN SUBSCRIPTION.ID%TYPE,
14:33:54 568  --  in_cancelation_reason IN SUBSCRIPTION_CANCEL_REASON.VALUE%TYPE,
14:33:54 569  --  in_cancelation_date	IN SUBSCRIPTION.CANCELLATION_DATE%TYPE,
14:33:54 570  --  in_note		IN SUBSCRIPTION_NOTE.NOTE%TYPE,
14:33:54 571  --  in_agent_id		IN SUBSCRIPTION_NOTE.AGENT_ID%TYPE,
14:33:54 572  --  in_updated_by 	IN SUBSCRIPTION.UPDATED_BY%TYPE
14:33:54 573  	in_subscription_id    IN NUMBER,
14:33:54 574  	in_cancelation_reason IN VARCHAR2,
14:33:54 575  	in_cancelation_date   IN DATE,
14:33:54 576  	in_note 	      IN VARCHAR2,
14:33:54 577  	in_agent_id	      IN NUMBER,
14:33:54 578  	in_updated_by	      IN VARCHAR2
14:33:54 579  ) AS
14:33:54 580  BEGIN
14:33:54 581  	PROCS_SUBSCRIPTION_V22.FINALIZE_CANCELATION(
14:33:54 582  	  in_subscription_id,
14:33:54 583  	  in_cancelation_reason,
14:33:54 584  	  in_cancelation_date,
14:33:54 585  	  in_note,
14:33:54 586  	  in_agent_id,
14:33:54 587  	  in_updated_by
14:33:54 588  	);
14:33:54 589  END FINALIZE_CANCELATION;
14:33:54 590  
14:33:54 591  /****************************************************************/
14:33:54 592  
14:33:54 593  PROCEDURE GET_SUBSCR_PROD_OFFERRINGS (
14:33:54 594  /*
14:33:54 595  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 596  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 597  */
14:33:54 598  	in_subscription_id IN NUMBER,
14:33:54 599  	out_result_set	   OUT SYS_REFCURSOR
14:33:54 600  ) AS
14:33:54 601  BEGIN
14:33:54 602  	PROCS_SUBSCRIPTION_V22.GET_SUBSCR_PROD_OFFERRINGS(
14:33:54 603  	  in_subscription_id,
14:33:54 604  	  out_result_set
14:33:54 605  	);
14:33:54 606  END GET_SUBSCR_PROD_OFFERRINGS;
14:33:54 607  
14:33:54 608  /****************************************************************/
14:33:54 609  
14:33:54 610  PROCEDURE GET_OFFER_CHAIN_META_DATA (
14:33:54 611  /*
14:33:54 612  Throws exceptions (codes):
14:33:54 613  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 614  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 615  */
14:33:54 616  	in_offer_chain_id IN NUMBER,
14:33:54 617  	in_meta_data_name IN VARCHAR2,
14:33:54 618  	out_result_set	  OUT SYS_REFCURSOR
14:33:54 619  )AS
14:33:54 620  BEGIN
14:33:54 621  	PROCS_OFFER_CHAIN_V22.GET_OFFER_CHAIN_META_DATA(
14:33:54 622  	  in_offer_chain_id,
14:33:54 623  	  in_meta_data_name,
14:33:54 624  	  out_result_set
14:33:54 625  	);
14:33:54 626  END GET_OFFER_CHAIN_META_DATA;
14:33:54 627  
14:33:54 628  /****************************************************************/
14:33:54 629  
14:33:54 630  PROCEDURE GET_PRODUCT_OFFERING_META_DATA (
14:33:54 631  /*
14:33:54 632  Throws exceptions (codes):
14:33:54 633  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 634  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 635  */
14:33:54 636  	in_product_offering_id IN NUMBER,
14:33:54 637  	in_meta_data_name      IN VARCHAR2 DEFAULT NULL,
14:33:54 638  	out_result_set	       OUT SYS_REFCURSOR
14:33:54 639  )AS
14:33:54 640  BEGIN
14:33:54 641  	PROCS_OFFER_CHAIN_V22.GET_PRODUCT_OFFERING_META_DATA(
14:33:54 642  	  in_product_offering_id,
14:33:54 643  	  in_meta_data_name,
14:33:54 644  	  out_result_set
14:33:54 645  	);
14:33:54 646  END GET_PRODUCT_OFFERING_META_DATA;
14:33:54 647  
14:33:54 648  /****************************************************************/
14:33:54 649  
14:33:54 650  PROCEDURE READ_ACCOUNT (
14:33:54 651  	in_account_id  IN ACCOUNT.ID%TYPE,
14:33:54 652  	out_result_set OUT SYS_REFCURSOR
14:33:54 653  )AS
14:33:54 654  BEGIN
14:33:54 655  	PROCS_ACCOUNT_CRU_V22.READ_ACCOUNT(
14:33:54 656  	  in_account_id,
14:33:54 657  	  out_result_set
14:33:54 658  	);
14:33:54 659  END READ_ACCOUNT;
14:33:54 660  
14:33:54 661  /****************************************************************/
14:33:54 662  
14:33:54 663  PROCEDURE GET_COLLECTED_CHARGES (
14:33:54 664  /*
14:33:54 665  Throws exceptions:
14:33:54 666  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 667  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 668  */
14:33:54 669  	in_invoice_id  IN NUMBER,
14:33:54 670  	out_result_set OUT SYS_REFCURSOR
14:33:54 671  ) AS
14:33:54 672  BEGIN
14:33:54 673  	PROCS_CHARGE_V22.GET_COLLECTED_CHARGES(
14:33:54 674  	  in_invoice_id,
14:33:54 675  	  out_result_set
14:33:54 676  	);
14:33:54 677  END GET_COLLECTED_CHARGES;
14:33:54 678  
14:33:54 679  /****************************************************************/
14:33:54 680  
14:33:54 681  PROCEDURE GET_GROUPS_ID_BY_INVOICE_ID (
14:33:54 682  /*
14:33:54 683  Throws exceptions:
14:33:54 684  APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 685  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 686  */
14:33:54 687  	in_invoice_id IN NUMBER,
14:33:54 688  	out_group_ids OUT SYS_REFCURSOR
14:33:54 689  ) AS
14:33:54 690  BEGIN
14:33:54 691  
14:33:54 692  	PROCS_ACCOUNT_V22.GET_GROUPS_ID_BY_INVOICE_ID(
14:33:54 693  	  in_invoice_id,
14:33:54 694  	  out_group_ids
14:33:54 695  	);
14:33:54 696  
14:33:54 697  END GET_GROUPS_ID_BY_INVOICE_ID;
14:33:54 698  
14:33:54 699  /****************************************************************/
14:33:54 700  
14:33:54 701  PROCEDURE GET_ACCOUNT_ID_BY_GROUP_ID (
14:33:54 702  /*
14:33:54 703  Throws exceptions:
14:33:54 704  APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 705  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 706  */
14:33:54 707  	in_group_id IN NUMBER,
14:33:54 708  	out_account_id	OUT NUMBER
14:33:54 709  ) AS
14:33:54 710  BEGIN
14:33:54 711  
14:33:54 712  	PROCS_ACCOUNT_V22.GET_ACCOUNT_ID_BY_GROUP_ID(
14:33:54 713  	  in_group_id,
14:33:54 714  	  out_account_id
14:33:54 715  	);
14:33:54 716  
14:33:54 717  END GET_ACCOUNT_ID_BY_GROUP_ID;
14:33:54 718  
14:33:54 719  /****************************************************************/
14:33:54 720  
14:33:54 721  PROCEDURE LOCK_ACCOUNT (
14:33:54 722  	in_group_id    IN NUMBER,
14:33:54 723  	in_lock_key    IN VARCHAR2,
14:33:54 724  	in_seconds_num IN NUMBER,
14:33:54 725  	in_created_by  IN VARCHAR2,
14:33:54 726  	in_reason      IN VARCHAR2
14:33:54 727  ) AS
14:33:54 728  BEGIN
14:33:54 729  	PROCS_LOCKING_V22.LOCK_ACCOUNT(
14:33:54 730  	  in_group_id,
14:33:54 731  	  in_lock_key,
14:33:54 732  	  in_seconds_num,
14:33:54 733  	  in_created_by,
14:33:54 734  	  in_reason
14:33:54 735  	);
14:33:54 736  END LOCK_ACCOUNT;
14:33:54 737  
14:33:54 738  /****************************************************************/
14:33:54 739  
14:33:54 740  PROCEDURE RELEASE_LOCK (
14:33:54 741  	in_group_id IN NUMBER,
14:33:54 742  	in_lock_key IN VARCHAR2
14:33:54 743  ) AS
14:33:54 744  BEGIN
14:33:54 745  	PROCS_LOCKING_V22.RELEASE_LOCK(
14:33:54 746  	  in_group_id,
14:33:54 747  	  in_lock_key
14:33:54 748  	);
14:33:54 749  END RELEASE_LOCK;
14:33:54 750  
14:33:54 751  PROCEDURE GET_PAYMENT_INFO_BY_INVOICE_ID (
14:33:54 752  	in_invoice_id		    IN NUMBER,
14:33:54 753  	out_order_id		    OUT VARCHAR2,
14:33:54 754  	out_external_transaction_id OUT VARCHAR2
14:33:54 755  ) AS
14:33:54 756  BEGIN
14:33:54 757  	PROCS_INVOICE_V22.GET_PAYMENT_INFO_BY_INVOICE_ID(
14:33:54 758  	  in_invoice_id,
14:33:54 759  	  out_order_id,
14:33:54 760  	  out_external_transaction_id
14:33:54 761  	);
14:33:54 762  END GET_PAYMENT_INFO_BY_INVOICE_ID;
14:33:54 763  
14:33:54 764  /******************************************************************************/
14:33:54 765  
14:33:54 766  PROCEDURE GET_PAYPAL_BY_ID (
14:33:54 767  	in_paypal_id   IN  NUMBER,
14:33:54 768  	out_result_set OUT SYS_REFCURSOR
14:33:54 769  ) AS
14:33:54 770  BEGIN
14:33:54 771  	PROCS_FIN_INSTRUMENTS_V22.GET_PAYPAL_BY_ID(
14:33:54 772  	  in_paypal_id,
14:33:54 773  	  out_result_set
14:33:54 774  	);
14:33:54 775  END GET_PAYPAL_BY_ID;
14:33:54 776  
14:33:54 777  PROCEDURE GET_NEXT_ATTEMPT_NUMBER (
14:33:54 778  /*
14:33:54 779  Throws exceptions:
14:33:54 780  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 781  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 782  */
14:33:54 783  	in_charge_id   in  number,
14:33:54 784  	out_attempt_count out number
14:33:54 785  ) as
14:33:54 786  begin
14:33:54 787  	PROCS_TRANSACTION_V22.GET_NEXT_ATTEMPT_NUMBER(
14:33:54 788  	  in_charge_id,
14:33:54 789  	  out_attempt_count
14:33:54 790  	);
14:33:54 791  end GET_NEXT_ATTEMPT_NUMBER;
14:33:54 792  
14:33:54 793  PROCEDURE GET_NOTIFICATION_TYPE_ID (
14:33:54 794  	in_offer_chain_id	 IN NUMBER,
14:33:54 795  	in_action_name		 IN VARCHAR2,
14:33:54 796  	out_notification_type_id out number
14:33:54 797  ) as
14:33:54 798  begin
14:33:54 799  	PROCS_OFFER_CHAIN_V22.GET_NOTIFICATION_TYPE_ID(
14:33:54 800  	  in_offer_chain_id,
14:33:54 801  	  in_action_name,
14:33:54 802  	  out_notification_type_id
14:33:54 803  	);
14:33:54 804  end GET_NOTIFICATION_TYPE_ID;
14:33:54 805  
14:33:54 806  PROCEDURE GET_GC_ID_BY_PURCH_INVOICE_ID (
14:33:54 807  /*
14:33:54 808  Throws exceptions:
14:33:54 809  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 810  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 811  */
14:33:54 812  in_invoice_id IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
14:33:54 813  out_gift_certificate_id OUT GIFT_CERTIFICATE.ID%TYPE
14:33:54 814  ) AS
14:33:54 815  BEGIN
14:33:54 816  PROCS_FIN_INSTRUMENTS_V22.GET_GC_ID_BY_PURCH_INVOICE_ID(
14:33:54 817  in_invoice_id,
14:33:54 818  out_gift_certificate_id
14:33:54 819  );
14:33:54 820  END GET_GC_ID_BY_PURCH_INVOICE_ID;
14:33:54 821  
14:33:54 822  /****************************************************************************/
14:33:54 823  
14:33:54 824  PROCEDURE SHOULD_MOVE_TO_GRACE(
14:33:54 825  	in_invoice_id  IN INVOICE.ID%TYPE,
14:33:54 826  	out_result     OUT NUMBER
14:33:54 827  ) AS
14:33:54 828  BEGIN
14:33:54 829  	-- if the invoice preceding the given invoice has no transaction attempts, then
14:33:54 830  	-- it is not billed out of Sartre. if so, then the associated subscription
14:33:54 831  	-- should be canceled after a final failed billing attempt--not moved to grace.
14:33:54 832  	SELECT DECODE(COUNT(1), 0, 0, 1) INTO out_result
14:33:54 833  	FROM CHARGE c
14:33:54 834  	INNER JOIN TRANSACTION t ON c.TRANSACTION_ID = t.ID
14:33:54 835  	INNER JOIN TRANSACTION_ATTEMPT ta ON ta.TRANSACTION_ID = t.ID
14:33:54 836  	WHERE c.INVOICE_ID = (
14:33:54 837  	  -- select previous invoice_id, or -1 if there is none
14:33:54 838  	  SELECT PREV_INVOICE_ID FROM (
14:33:54 839  	    SELECT i.ID, LAG(i.ID, 1, -1) OVER (ORDER BY i.CREATE_DATE) AS PREV_INVOICE_ID
14:33:54 840  	    FROM INVOICE i
14:33:54 841  	    INNER JOIN LICENSE l ON i.ID = l.INVOICE_ID
14:33:54 842  	    WHERE l.SUBSCRIPTION_ID = (
14:33:54 843  	      SELECT SUBSCRIPTION_ID FROM LICENSE WHERE INVOICE_ID = in_invoice_id
14:33:54 844  	    )
14:33:54 845  	  ) WHERE ID = in_invoice_id
14:33:54 846  	);
14:33:54 847  END SHOULD_MOVE_TO_GRACE;
14:33:54 848  
14:33:54 849  /****************************************************************************/
14:33:54 850  
14:33:54 851  PROCEDURE MOVE_TO_GRACE(
14:33:54 852  	in_invoice_id		      IN INVOICE.ID%TYPE,
14:33:54 853  	in_updated_by		      IN LICENSE.UPDATED_BY%TYPE,
14:33:54 854  	in_grace_period_length_hours  IN NUMBER
14:33:54 855  ) AS
14:33:54 856  BEGIN
14:33:54 857  	PROCS_SUBSCRIPTION_V22.START_GRACE_BY_INVOICE_ID(
14:33:54 858  	  in_invoice_id        => in_invoice_id,
14:33:54 859  	  in_updater	       => in_updated_by,
14:33:54 860  	  in_duration_in_hours => in_grace_period_length_hours
14:33:54 861  	);
14:33:54 862  END MOVE_TO_GRACE;
14:33:54 863  
14:33:54 864  /****************************************************************************/
14:33:54 865  
14:33:54 866  PROCEDURE MOVE_OUT_OF_GRACE(
14:33:54 867  	in_invoice_id	IN INVOICE.ID%TYPE,
14:33:54 868  	in_updated_by	IN LICENSE.UPDATED_BY%TYPE
14:33:54 869  ) AS
14:33:54 870  BEGIN
14:33:54 871  	PROCS_SUBSCRIPTION_V22.STOP_GRACE_BY_INVOICE_ID(
14:33:54 872  	  in_invoice_id => in_invoice_id,
14:33:54 873  	  in_updater	=> in_updated_by
14:33:54 874  	);
14:33:54 875  END MOVE_OUT_OF_GRACE;
14:33:54 876  
14:33:54 877  END PUBLIC_PROCS_BILLING_V22;
14:33:54 878  .
14:33:54 SQL> /

Package body created.

Elapsed: 00:00:00.06
14:33:54 SQL> 
14:33:54 SQL> CREATE OR REPLACE PACKAGE BODY "PUBLIC_PROCS_NOTIFICATION_V22" AS
14:33:54   2  
14:33:54   3  PROCEDURE LOCK_ACCOUNT (
14:33:54   4  	in_group_id    IN NUMBER,
14:33:54   5  	in_lock_key    IN VARCHAR2,
14:33:54   6  	in_seconds_num IN NUMBER,
14:33:54   7  	in_created_by  IN VARCHAR2,
14:33:54   8  	in_reason      IN VARCHAR2
14:33:54   9  ) AS
14:33:54  10  BEGIN
14:33:54  11  	PROCS_LOCKING_V22.LOCK_ACCOUNT(
14:33:54  12  	  in_group_id,
14:33:54  13  	  in_lock_key,
14:33:54  14  	  in_seconds_num,
14:33:54  15  	  in_created_by,
14:33:54  16  	  in_reason
14:33:54  17  	);
14:33:54  18  END LOCK_ACCOUNT;
14:33:54  19  
14:33:54  20  /******************************************************************************/
14:33:54  21  
14:33:54  22  PROCEDURE RELEASE_LOCK (
14:33:54  23  	in_group_id IN NUMBER,
14:33:54  24  	in_lock_key IN VARCHAR2
14:33:54  25  ) AS
14:33:54  26  BEGIN
14:33:54  27  	PROCS_LOCKING_V22.RELEASE_LOCK(
14:33:54  28  	  in_group_id,
14:33:54  29  	  in_lock_key
14:33:54  30  	);
14:33:54  31  END RELEASE_LOCK;
14:33:54  32  
14:33:54  33  END PUBLIC_PROCS_NOTIFICATION_V22;
14:33:54  34  .
14:33:54 SQL> /

Package body created.

Elapsed: 00:00:00.02
14:33:54 SQL> 
14:33:54 SQL> CREATE OR REPLACE PACKAGE BODY "PUBLIC_PROCS_RENEWAL_V22" AS
14:33:54   2  
14:33:54   3  PROCEDURE SUB_EXPIRES_NEED_ENTITLEMENTS (
14:33:54   4  	out_result_set OUT SYS_REFCURSOR
14:33:54   5  ) AS
14:33:54   6  BEGIN
14:33:54   7  	PROCS_GROUP_ACCOUNT_V22.SUB_EXPIRES_NEED_ENTITLEMENTS(out_result_set => out_result_set);
14:33:54   8  END SUB_EXPIRES_NEED_ENTITLEMENTS;
14:33:54   9  
14:33:54  10  PROCEDURE UPDATE_SS_NEED_ENTITLEMENTS (
14:33:54  11  	in_sub_share_id      IN SUBSCRIPTION_SHARE.ID%TYPE,
14:33:54  12  	in_need_entitlements IN SUBSCRIPTION_SHARE.NEEDS_ENTITLEMENTS%TYPE,
14:33:54  13  	in_updater	     IN SUBSCRIPTION_SHARE.UPDATED_BY%TYPE
14:33:54  14  ) AS
14:33:54  15  BEGIN
14:33:54  16  	PROCS_GROUP_ACCOUNT_V22.UPDATE_SS_NEED_ENTITLEMENTS(
14:33:54  17  	  in_sub_share_id => in_sub_share_id,
14:33:54  18  	  in_need_entitlements => in_need_entitlements,
14:33:54  19  	  in_updater => in_updater
14:33:54  20  	);
14:33:54  21  END UPDATE_SS_NEED_ENTITLEMENTS;
14:33:54  22  
14:33:54  23  PROCEDURE GET_OFFER_CHAIN_BY_ID (
14:33:54  24  /*
14:33:54  25  Throws exceptions:
14:33:54  26  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54  27  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54  28  */
14:33:54  29  	  in_offer_chain_id IN	 NUMBER,
14:33:54  30  	  out_result_set    OUT  SYS_REFCURSOR
14:33:54  31  ) AS
14:33:54  32  BEGIN
14:33:54  33  	PROCS_OFFER_CHAIN_V22.GET_OFFER_CHAIN_BY_ID (
14:33:54  34  	  in_offer_chain_id => in_offer_chain_id,
14:33:54  35  	  out_result_set => out_result_set
14:33:54  36  	);
14:33:54  37  END GET_OFFER_CHAIN_BY_ID;
14:33:54  38  
14:33:54  39  PROCEDURE GET_OFFER_CHAIN_META_DATA (
14:33:54  40  /*
14:33:54  41  Throws exceptions (codes):
14:33:54  42  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54  43  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54  44  */
14:33:54  45  	in_offer_chain_id IN NUMBER,
14:33:54  46  	in_meta_data_name IN VARCHAR2,
14:33:54  47  	out_result_set	  OUT SYS_REFCURSOR
14:33:54  48  )AS
14:33:54  49  BEGIN
14:33:54  50  	PROCS_OFFER_CHAIN_V22.GET_OFFER_CHAIN_META_DATA(
14:33:54  51  	  in_offer_chain_id,
14:33:54  52  	  in_meta_data_name,
14:33:54  53  	  out_result_set
14:33:54  54  	);
14:33:54  55  END GET_OFFER_CHAIN_META_DATA;
14:33:54  56  
14:33:54  57  PROCEDURE GET_ENDING_LICENSES (
14:33:54  58  /*
14:33:54  59  Throws exceptions:
14:33:54  60  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54  61  */
14:33:54  62  	in_hours_number IN NUMBER,
14:33:54  63  	out_result_set OUT SYS_REFCURSOR
14:33:54  64  ) AS
14:33:54  65  BEGIN
14:33:54  66  	PROCS_LICENSE_V22.GET_ENDING_LICENSES(in_hours_number,out_result_set);
14:33:54  67  END GET_ENDING_LICENSES;
14:33:54  68  
14:33:54  69  PROCEDURE GET_ENDING_LICENSES_CC (
14:33:54  70  /*
14:33:54  71  Throws exceptions:
14:33:54  72  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54  73  */
14:33:54  74  	in_hours_number IN NUMBER,
14:33:54  75  	out_result_set OUT SYS_REFCURSOR,
14:33:54  76  	in_process_name 	IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE
14:33:54  77  ) AS
14:33:54  78  BEGIN
14:33:54  79  	PROCS_LICENSE_V22.GET_ENDING_LICENSES_CC(in_hours_number,out_result_set, in_process_name);
14:33:54  80  END GET_ENDING_LICENSES_CC;
14:33:54  81  
14:33:54  82  /*******************************************************/
14:33:54  83  
14:33:54  84  PROCEDURE GET_RECURRING_OFFER (
14:33:54  85  /*
14:33:54  86  Throws exceptions:
14:33:54  87  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54  88  */
14:33:54  89  	in_license_id  IN NUMBER,
14:33:54  90  	out_result_set OUT SYS_REFCURSOR
14:33:54  91  ) AS
14:33:54  92  BEGIN
14:33:54  93  	PROCS_LICENSE_V22.GET_RECURRING_OFFER (
14:33:54  94  	  in_license_id,
14:33:54  95  	  out_result_set
14:33:54  96  	);
14:33:54  97  END GET_RECURRING_OFFER;
14:33:54  98  
14:33:54  99  /********************************************************/
14:33:54 100  
14:33:54 101  PROCEDURE GET_NEXT_OFFER (
14:33:54 102  /*
14:33:54 103  Throws exceptions:
14:33:54 104  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 105  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:54 106  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 107  */
14:33:54 108  	in_license_id  IN NUMBER,
14:33:54 109  	out_result_set OUT SYS_REFCURSOR
14:33:54 110  ) AS
14:33:54 111  BEGIN
14:33:54 112  	PROCS_LICENSE_V22.GET_NEXT_OFFER (
14:33:54 113  	  in_license_id,
14:33:54 114  	  out_result_set
14:33:54 115  	);
14:33:54 116  END GET_NEXT_OFFER;
14:33:54 117  
14:33:54 118  /*********************************************************/
14:33:54 119  
14:33:54 120  PROCEDURE UPDATE_LICENSE_STATUS(
14:33:54 121  /*
14:33:54 122  Throws exceptions:
14:33:54 123  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 124  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 125  */
14:33:54 126  	  in_license_id     IN NUMBER,
14:33:54 127  	  in_license_status IN NUMBER,
14:33:54 128  	  in_updated_by     IN VARCHAR2
14:33:54 129  ) AS
14:33:54 130  BEGIN
14:33:54 131  	PROCS_LICENSE_V22.UPDATE_LICENSE_STATUS (
14:33:54 132  	  in_license_id,
14:33:54 133  	  in_license_status,
14:33:54 134  	  in_updated_by
14:33:54 135  	);
14:33:54 136  END UPDATE_LICENSE_STATUS;
14:33:54 137  
14:33:54 138  /**********************************************************/
14:33:54 139  
14:33:54 140  PROCEDURE UPDATE_INVOICE_STATUS (
14:33:54 141  /*
14:33:54 142  Throws exceptions:
14:33:54 143  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 144  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 145  */
14:33:54 146  	in_invoice_id		       IN NUMBER,
14:33:54 147  	in_invoice_status_id	       IN NUMBER,
14:33:54 148  	in_updated_by		       IN VARCHAR2
14:33:54 149  ) AS
14:33:54 150  BEGIN
14:33:54 151  	PROCS_INVOICE_V22.UPDATE_INVOICE_STATUS(
14:33:54 152  	  in_invoice_id,
14:33:54 153  	  in_invoice_status_id,
14:33:54 154  	  in_updated_by
14:33:54 155  	);
14:33:54 156  END UPDATE_INVOICE_STATUS;
14:33:54 157  
14:33:54 158  /***********************************************************/
14:33:54 159  
14:33:54 160  PROCEDURE CREATE_LICENSE(
14:33:54 161  /*
14:33:54 162  Throws exceptions:
14:33:54 163  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 164  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 165  APP_EXCEPTION_CODES_V22.INTERNAL_ERROR
14:33:54 166  */
14:33:54 167  	in_status_id		    IN NUMBER,
14:33:54 168  	in_needs_entitlements	    IN NUMBER,
14:33:54 169  	in_start_date		    IN DATE,
14:33:54 170  	in_end_date		    IN DATE,
14:33:54 171  	in_offer_id		    IN NUMBER,
14:33:54 172  	in_subscription_id	    IN NUMBER,
14:33:54 173  	in_invoice_id		    IN NUMBER,
14:33:54 174  	in_created_by		    IN VARCHAR2,
14:33:54 175  	in_is_extension 	    IN NUMBER,
14:33:54 176  	in_current_offer_index	    IN NUMBER,
14:33:54 177  	in_current_offer_recurr_num IN NUMBER,
14:33:54 178  	out_license_id		    OUT NUMBER
14:33:54 179  ) AS
14:33:54 180  BEGIN
14:33:54 181  	PROCS_LICENSE_V22.CREATE_LICENSE (
14:33:54 182  	  in_status_id,
14:33:54 183  	  in_needs_entitlements,
14:33:54 184  	  in_start_date,
14:33:54 185  	  in_end_date,
14:33:54 186  	  in_offer_id,
14:33:54 187  	  in_subscription_id,
14:33:54 188  	  in_invoice_id,
14:33:54 189  	  in_created_by,
14:33:54 190  	  in_is_extension,
14:33:54 191  	  in_current_offer_index,
14:33:54 192  	  in_current_offer_recurr_num,
14:33:54 193  	  out_license_id
14:33:54 194  	);
14:33:54 195  END CREATE_LICENSE;
14:33:54 196  
14:33:54 197  /******************************************************/
14:33:54 198  
14:33:54 199  PROCEDURE CREATE_INVOICE(
14:33:54 200  /*
14:33:54 201  Throws exceptions:
14:33:54 202  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 203  */
14:33:54 204  	  in_invoice_status IN NUMBER,
14:33:54 205  	  in_created_by     IN VARCHAR2,
14:33:54 206  	  in_tax_exempt_id  IN VARCHAR2,
14:33:54 207  	  out_invoice_id    OUT NUMBER
14:33:54 208  ) AS
14:33:54 209  BEGIN
14:33:54 210  	PROCS_INVOICE_V22.CREATE_INVOICE (
14:33:54 211  	  in_invoice_status,
14:33:54 212  	  in_created_by,
14:33:54 213  	  in_tax_exempt_id,
14:33:54 214  	  out_invoice_id
14:33:54 215  	);
14:33:54 216  END CREATE_INVOICE;
14:33:54 217  
14:33:54 218  /*******************************************************/
14:33:54 219  
14:33:54 220  PROCEDURE CREATE_CHARGE(
14:33:54 221  /*
14:33:54 222  Throws exceptions:
14:33:54 223  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 224  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 225  */
14:33:54 226  	in_invoice_id	      IN NUMBER,
14:33:54 227  	in_transaction_id     IN NUMBER,
14:33:54 228  	in_instrument_type_id IN NUMBER,
14:33:54 229  	in_instrument_id      IN NUMBER,
14:33:54 230  	in_charge_amount      IN NUMBER,
14:33:54 231  	in_created_by	      IN VARCHAR2,
14:33:54 232  	in_charge_status_id   IN NUMBER,
14:33:54 233  	out_charge_id	      OUT NUMBER
14:33:54 234  ) AS
14:33:54 235  BEGIN
14:33:54 236  	PROCS_CHARGE_V22.CREATE_CHARGE (
14:33:54 237  	  in_invoice_id,
14:33:54 238  	  in_transaction_id,
14:33:54 239  	  in_instrument_type_id,
14:33:54 240  	  in_instrument_id,
14:33:54 241  	  in_charge_amount,
14:33:54 242  	  in_created_by,
14:33:54 243  	  in_charge_status_id,
14:33:54 244  	  out_charge_id
14:33:54 245  	);
14:33:54 246  END CREATE_CHARGE;
14:33:54 247  
14:33:54 248  /**********************************************************/
14:33:54 249  
14:33:54 250  PROCEDURE HAS_FUTURE_LICENSE (
14:33:54 251  /*
14:33:54 252  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 253  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 254  --
14:33:54 255  RETURNS:
14:33:54 256  1 - if has,
14:33:54 257  0 - else
14:33:54 258  */
14:33:54 259  	in_license_id IN NUMBER,
14:33:54 260  	out_result	   OUT NUMBER
14:33:54 261  ) AS
14:33:54 262  BEGIN
14:33:54 263  	PROCS_SUBSCRIPTION_V22.HAS_FUTURE_LICENSE (
14:33:54 264  	  in_license_id,
14:33:54 265  	  out_result
14:33:54 266  	);
14:33:54 267  END HAS_FUTURE_LICENSE;
14:33:54 268  
14:33:54 269  /***********************************************************/
14:33:54 270  
14:33:54 271  PROCEDURE GET_GROUP_ID_BY_LICENSE_ID (
14:33:54 272  /*
14:33:54 273  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 274  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 275  */
14:33:54 276  	in_license_id IN NUMBER,
14:33:54 277  	out_group_id  OUT NUMBER
14:33:54 278  ) AS
14:33:54 279  BEGIN
14:33:54 280  	PROCS_LICENSE_V22.GET_GROUP_ID_BY_LICENSE_ID (
14:33:54 281  	  in_license_id,
14:33:54 282  	  out_group_id
14:33:54 283  	);
14:33:54 284  END GET_GROUP_ID_BY_LICENSE_ID;
14:33:54 285  
14:33:54 286  /**********************************************************/
14:33:54 287  
14:33:54 288  PROCEDURE GET_OFFER_PRODUCTS (
14:33:54 289  /*
14:33:54 290  Throws exceptions (codes):
14:33:54 291  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 292  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 293  */
14:33:54 294  	in_offer_id    IN NUMBER,
14:33:54 295  	out_result_set OUT SYS_REFCURSOR
14:33:54 296  ) AS
14:33:54 297  BEGIN
14:33:54 298  	PROCS_OFFER_CHAIN_V22.GET_OFFER_PRODUCTS (
14:33:54 299  	  in_offer_id,
14:33:54 300  	  out_result_set
14:33:54 301  	);
14:33:54 302  END GET_OFFER_PRODUCTS;
14:33:54 303  
14:33:54 304  /***********************************************************/
14:33:54 305  
14:33:54 306  PROCEDURE CREATE_TRANSACTION (
14:33:54 307  /*
14:33:54 308  Throws exceptions:
14:33:54 309  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 310  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 311  */
14:33:54 312  	in_transaction_id	  IN NUMBER,
14:33:54 313  	in_status_id		  IN NUMBER,
14:33:54 314  	in_amount		  IN NUMBER,
14:33:54 315  	in_created_by		  IN VARCHAR2,
14:33:54 316  	in_order_id		  IN VARCHAR2,
14:33:54 317  	in_transaction_type_code  IN VARCHAR2 DEFAULT NULL,
14:33:54 318  	out_transaction_id	  OUT NUMBER
14:33:54 319  ) AS
14:33:54 320  BEGIN
14:33:54 321  	PROCS_TRANSACTION_V22.CREATE_TRANSACTION(
14:33:54 322  	  in_transaction_id,
14:33:54 323  	  in_status_id,
14:33:54 324  	  in_amount,
14:33:54 325  	  in_created_by,
14:33:54 326  	  in_order_id,
14:33:54 327  	  GLOBAL_CONSTANTS_V22.FALSE, -- is_refund should be false in renewal
14:33:54 328  	  in_transaction_type_code,
14:33:54 329  	  out_transaction_id
14:33:54 330  	);
14:33:54 331  END CREATE_TRANSACTION;
14:33:54 332  
14:33:54 333  /************************************************************/
14:33:54 334  
14:33:54 335  PROCEDURE ADD_LINE_ITEMS(
14:33:54 336  /*
14:33:54 337  Throws exceptions:
14:33:54 338  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 339  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 340  */
14:33:54 341  	in_invoice_id IN NUMBER,
14:33:54 342  	in_offer_id   IN NUMBER,
14:33:54 343  	in_created_by IN VARCHAR2
14:33:54 344  ) AS
14:33:54 345  BEGIN
14:33:54 346  	PROCS_LINE_ITEMS_V22.ADD_LINE_ITEMS(
14:33:54 347  	  in_invoice_id,
14:33:54 348  	  in_offer_id,
14:33:54 349  	  in_created_by
14:33:54 350  	);
14:33:54 351  END ADD_LINE_ITEMS;
14:33:54 352  
14:33:54 353  /************************************************************/
14:33:54 354  
14:33:54 355  PROCEDURE CALCULATE_INVOICE_AMOUNT (
14:33:54 356  /*
14:33:54 357  Throws exceptions:
14:33:54 358  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 359  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 360  */
14:33:54 361  	in_invoice_id IN  NUMBER,
14:33:54 362  	out_amount    OUT NUMBER
14:33:54 363  ) AS
14:33:54 364  BEGIN
14:33:54 365  	PROCS_INVOICE_V22.CALCULATE_INVOICE_AMOUNT (
14:33:54 366  	  in_invoice_id,
14:33:54 367  	  out_amount
14:33:54 368  	);
14:33:54 369  END CALCULATE_INVOICE_AMOUNT;
14:33:54 370  
14:33:54 371  /*************************************************************/
14:33:54 372  
14:33:54 373  PROCEDURE RESERVE_TRANSACTION_ID (
14:33:54 374  /*
14:33:54 375  Throws exceptions:
14:33:54 376  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 377  */
14:33:54 378  	out_transaction_id OUT NUMBER
14:33:54 379  ) AS
14:33:54 380  BEGIN
14:33:54 381  	PROCS_TRANSACTION_V22.RESERVE_TRANSACTION_ID (
14:33:54 382  	  out_transaction_id
14:33:54 383  	);
14:33:54 384  END RESERVE_TRANSACTION_ID;
14:33:54 385  
14:33:54 386  /***************************************************************/
14:33:54 387  
14:33:54 388  PROCEDURE P_GET_NEXT_OFFER_INDEX (
14:33:54 389  	in_offer_chain_id	     IN NUMBER,
14:33:54 390  	in_offer_chain_current_index IN NUMBER,
14:33:54 391  	out_next_offer_index	     OUT NUMBER
14:33:54 392  ) AS
14:33:54 393  BEGIN
14:33:54 394  	PROCS_OFFER_CHAIN_V22.P_GET_NEXT_OFFER_INDEX(
14:33:54 395  	  in_offer_chain_id,
14:33:54 396  	  in_offer_chain_current_index,
14:33:54 397  	  out_next_offer_index
14:33:54 398  	);
14:33:54 399  END P_GET_NEXT_OFFER_INDEX;
14:33:54 400  
14:33:54 401  /***************************************************************/
14:33:54 402  
14:33:54 403  PROCEDURE GET_NEXT_OFFER_INDEX_BY_LCNS (
14:33:54 404  	in_license_id		     IN NUMBER,
14:33:54 405  	in_offer_chain_current_index IN NUMBER,
14:33:54 406  	out_next_offer_index	     OUT NUMBER
14:33:54 407  ) AS
14:33:54 408  BEGIN
14:33:54 409  	PROCS_OFFER_CHAIN_V22.GET_NEXT_OFFER_INDEX_BY_LCNS(
14:33:54 410  	  in_license_id,
14:33:54 411  	  in_offer_chain_current_index,
14:33:54 412  	  out_next_offer_index
14:33:54 413  	);
14:33:54 414  END GET_NEXT_OFFER_INDEX_BY_LCNS;
14:33:54 415  
14:33:54 416  /******************************************************************/
14:33:54 417  
14:33:54 418  PROCEDURE GET_SUBSCRIPTION_INFO (
14:33:54 419  /*
14:33:54 420  Throws exceptions:
14:33:54 421  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 422  */
14:33:54 423  	  in_subscription_id IN  NUMBER,
14:33:54 424  	  out_result_set      OUT SYS_REFCURSOR
14:33:54 425  ) AS
14:33:54 426  BEGIN
14:33:54 427  	PROCS_SUBSCRIPTION_V22.GET_SUBSCRIPTION_INFO(
14:33:54 428  	  in_subscription_id,
14:33:54 429  	  out_result_set
14:33:54 430  	);
14:33:54 431  END GET_SUBSCRIPTION_INFO;
14:33:54 432  
14:33:54 433  /*******************************************************************/
14:33:54 434  
14:33:54 435  PROCEDURE CLOSE_SUBSCRIPTION (
14:33:54 436  	in_subscription_id IN NUMBER,
14:33:54 437  	in_updated_by	   IN VARCHAR2
14:33:54 438  ) AS
14:33:54 439  BEGIN
14:33:54 440  	PROCS_SUBSCRIPTION_V22.CLOSE_SUBSCRIPTION(
14:33:54 441  	  in_subscription_id,
14:33:54 442  	  in_updated_by
14:33:54 443  	);
14:33:54 444  END CLOSE_SUBSCRIPTION;
14:33:54 445  
14:33:54 446  /*******************************************************************/
14:33:54 447  
14:33:54 448  PROCEDURE GET_NEED_ENTITLEMENTS_LICENSES (
14:33:54 449  	out_result_set OUT SYS_REFCURSOR
14:33:54 450  ) AS
14:33:54 451  BEGIN
14:33:54 452  	PROCS_LICENSE_V22.GET_NEED_ENTITLEMENTS_LICENSES(
14:33:54 453  	  out_result_set
14:33:54 454  	);
14:33:54 455  END GET_NEED_ENTITLEMENTS_LICENSES;
14:33:54 456  
14:33:54 457  /*******************************************************************/
14:33:54 458  
14:33:54 459  PROCEDURE UPDATE_NEED_ENTITLEMENTS_FLAG (
14:33:54 460  	in_license_id	      IN NUMBER,
14:33:54 461  	in_needs_entitlements IN NUMBER,
14:33:54 462  	in_updated_by	      IN VARCHAR2
14:33:54 463  ) AS
14:33:54 464  BEGIN
14:33:54 465  	PROCS_LICENSE_V22.UPDATE_NEED_ENTITLEMENTS_FLAG(
14:33:54 466  	  in_license_id,
14:33:54 467  	  in_needs_entitlements,
14:33:54 468  	  in_updated_by
14:33:54 469  	);
14:33:54 470  END UPDATE_NEED_ENTITLEMENTS_FLAG;
14:33:54 471  
14:33:54 472  /*******************************************************/
14:33:54 473  
14:33:54 474  PROCEDURE GET_PROD_OFFERINGS_BY_OFFER_ID (
14:33:54 475  /*
14:33:54 476  Throws exceptions (codes):
14:33:54 477  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 478  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 479  */
14:33:54 480  	in_offer_id    IN NUMBER,
14:33:54 481  	out_result_set OUT SYS_REFCURSOR
14:33:54 482  ) AS
14:33:54 483  BEGIN
14:33:54 484  	PROCS_OFFER_CHAIN_V22.GET_PROD_OFFERINGS_BY_OFFER_ID(in_offer_id,out_result_set);
14:33:54 485  END GET_PROD_OFFERINGS_BY_OFFER_ID;
14:33:54 486  
14:33:54 487  /*******************************************************/
14:33:54 488  PROCEDURE GET_PRODUCT_OFFERING_META_DATA (
14:33:54 489  /*
14:33:54 490  Throws exceptions (codes):
14:33:54 491  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 492  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 493  */
14:33:54 494  	in_product_offering_id IN NUMBER,
14:33:54 495  	in_meta_data_name      IN VARCHAR2 DEFAULT NULL,
14:33:54 496  	out_result_set	       OUT SYS_REFCURSOR
14:33:54 497  ) AS
14:33:54 498  BEGIN
14:33:54 499  	PROCS_OFFER_CHAIN_V22.GET_PRODUCT_OFFERING_META_DATA(in_product_offering_id,in_meta_data_name,out_result_set);
14:33:54 500  END GET_PRODUCT_OFFERING_META_DATA;
14:33:54 501  
14:33:54 502  /*******************************************************/
14:33:54 503  
14:33:54 504  PROCEDURE LOCK_ACCOUNT (
14:33:54 505  	in_group_id    IN NUMBER,
14:33:54 506  	in_lock_key    IN VARCHAR2,
14:33:54 507  	in_seconds_num IN NUMBER,
14:33:54 508  	in_created_by  IN VARCHAR2,
14:33:54 509  	in_reason      IN VARCHAR2
14:33:54 510  ) AS
14:33:54 511  BEGIN
14:33:54 512  	PROCS_LOCKING_V22.LOCK_ACCOUNT(
14:33:54 513  	  in_group_id,
14:33:54 514  	  in_lock_key,
14:33:54 515  	  in_seconds_num,
14:33:54 516  	  in_created_by,
14:33:54 517  	  in_reason
14:33:54 518  	);
14:33:54 519  END LOCK_ACCOUNT;
14:33:54 520  
14:33:54 521  /****************************************************************/
14:33:54 522  
14:33:54 523  PROCEDURE RELEASE_LOCK (
14:33:54 524  	in_group_id IN NUMBER,
14:33:54 525  	in_lock_key IN VARCHAR2
14:33:54 526  ) AS
14:33:54 527  BEGIN
14:33:54 528  	PROCS_LOCKING_V22.RELEASE_LOCK(
14:33:54 529  	  in_group_id,
14:33:54 530  	  in_lock_key
14:33:54 531  	);
14:33:54 532  END RELEASE_LOCK;
14:33:54 533  
14:33:54 534  /******************************************************************************/
14:33:54 535  
14:33:54 536  PROCEDURE GET_INVOICE_LINE_ITEMS (
14:33:54 537  	in_invoice_id  IN NUMBER,
14:33:54 538  	out_result_set OUT SYS_REFCURSOR
14:33:54 539  ) AS
14:33:54 540  BEGIN
14:33:54 541  	PROCS_INVOICE_V22.GET_INVOICE_LINE_ITEMS(
14:33:54 542  	  in_invoice_id,
14:33:54 543  	  out_result_set
14:33:54 544  	);
14:33:54 545  END GET_INVOICE_LINE_ITEMS;
14:33:54 546  
14:33:54 547  /******************************************************************************/
14:33:54 548  
14:33:54 549  PROCEDURE ADD_TAX (
14:33:54 550  	in_tax_type_id		 IN NUMBER,
14:33:54 551  	in_calculated_amount	 IN NUMBER,
14:33:54 552  	in_created_by		 IN VARCHAR2,
14:33:54 553  	in_line_item_id 	 IN NUMBER,
14:33:54 554  	in_effective_rate	 IN VARCHAR2,
14:33:54 555  	in_taxable_amount	 IN NUMBER,
14:33:54 556  	in_tax_rule_id		 IN NUMBER,
14:33:54 557  	in_jurisdiction_level_id IN NUMBER,
14:33:54 558  	in_jurisdiction_name	 IN VARCHAR2,
14:33:54 559  	in_jurisdiction_id	 IN VARCHAR2,
14:33:54 560  	in_ext_tax_type 	 IN VARCHAR2,
14:33:54 561  	in_ext_result		 IN VARCHAR2,
14:33:54 562  	in_imposition_type	 IN VARCHAR2,
14:33:54 563  	in_imposition		 IN VARCHAR2
14:33:54 564  ) AS
14:33:54 565  BEGIN
14:33:54 566  	PROCS_TAXES_V22.ADD_TAX(
14:33:54 567  	  in_tax_type_id,
14:33:54 568  	  in_calculated_amount,
14:33:54 569  	  in_created_by,
14:33:54 570  	  in_line_item_id,
14:33:54 571  	  in_effective_rate,
14:33:54 572  	  in_taxable_amount,
14:33:54 573  	  in_tax_rule_id,
14:33:54 574  	  in_jurisdiction_level_id,
14:33:54 575  	  in_jurisdiction_name,
14:33:54 576  	  in_jurisdiction_id,
14:33:54 577  	  in_ext_tax_type,
14:33:54 578  	  in_ext_result,
14:33:54 579  	  in_imposition_type,
14:33:54 580  	  in_imposition
14:33:54 581  	);
14:33:54 582  END ADD_TAX;
14:33:54 583  
14:33:54 584  /******************************************************************************/
14:33:54 585  
14:33:54 586  PROCEDURE GET_CREDIT_CARD_BY_ID (
14:33:54 587  	in_credit_card_id IN  NUMBER,
14:33:54 588  	out_result_set	  OUT SYS_REFCURSOR
14:33:54 589  ) AS
14:33:54 590  BEGIN
14:33:54 591  	PROCS_FIN_INSTRUMENTS_V22.GET_CREDIT_CARD_BY_ID(
14:33:54 592  	  in_credit_card_id,
14:33:54 593  	  out_result_set
14:33:54 594  	);
14:33:54 595  END GET_CREDIT_CARD_BY_ID;
14:33:54 596  
14:33:54 597  /******************************************************************************/
14:33:54 598  
14:33:54 599  PROCEDURE GET_PRD_OFFERING_BY_LINE_IT_ID (
14:33:54 600  	in_line_item_id IN NUMBER,
14:33:54 601  	out_result_set	OUT SYS_REFCURSOR
14:33:54 602  ) AS
14:33:54 603  BEGIN
14:33:54 604  	PROCS_PRODUCT_V22.GET_PRD_OFFERING_BY_LINE_IT_ID(
14:33:54 605  	  in_line_item_id,
14:33:54 606  	  out_result_set
14:33:54 607  	);
14:33:54 608  END GET_PRD_OFFERING_BY_LINE_IT_ID;
14:33:54 609  
14:33:54 610  /******************************************************************************/
14:33:54 611  
14:33:54 612  PROCEDURE GET_ACCOUNT_ID_BY_GROUP_ID (
14:33:54 613  /*
14:33:54 614  Throws exceptions:
14:33:54 615  APP_EXCEPTION_CODES_V22.NOT_FOUND,
14:33:54 616  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 617  */
14:33:54 618  	in_group_id IN NUMBER,
14:33:54 619  	out_account_id	OUT NUMBER
14:33:54 620  ) AS
14:33:54 621  BEGIN
14:33:54 622  	PROCS_ACCOUNT_V22.GET_ACCOUNT_ID_BY_GROUP_ID(
14:33:54 623  	  in_group_id,
14:33:54 624  	  out_account_id
14:33:54 625  	);
14:33:54 626  END GET_ACCOUNT_ID_BY_GROUP_ID;
14:33:54 627  
14:33:54 628  /******************************************************************************/
14:33:54 629  
14:33:54 630  PROCEDURE GET_LINE_ITEM_DISCOUNTS (
14:33:54 631  /*
14:33:54 632  Throws exceptions:
14:33:54 633  APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54 634  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 635  */
14:33:54 636  	in_line_item_id IN  NUMBER,
14:33:54 637  	out_result_set	OUT SYS_REFCURSOR
14:33:54 638  ) AS
14:33:54 639  BEGIN
14:33:54 640  	PROCS_LINE_ITEMS_V22.GET_LINE_ITEM_DISCOUNTS(
14:33:54 641  	  in_line_item_id,
14:33:54 642  	  out_result_set
14:33:54 643  	);
14:33:54 644  END GET_LINE_ITEM_DISCOUNTS;
14:33:54 645  
14:33:54 646  /******************************************************************************/
14:33:54 647  
14:33:54 648  PROCEDURE UPDATE_LINE_ITEM_AMOUNT (
14:33:54 649  	in_line_item_id    IN NUMBER,
14:33:54 650  	in_amount	   IN NUMBER,
14:33:54 651  	in_discount_amount IN NUMBER,
14:33:54 652  	in_taxes_amount    IN NUMBER
14:33:54 653  ) AS
14:33:54 654  BEGIN
14:33:54 655  	PROCS_LINE_ITEMS_V22.UPDATE_LINE_ITEM_AMOUNT(
14:33:54 656  	  in_line_item_id,
14:33:54 657  	  in_amount,
14:33:54 658  	  in_discount_amount,
14:33:54 659  	  in_taxes_amount
14:33:54 660  	);
14:33:54 661  END UPDATE_LINE_ITEM_AMOUNT;
14:33:54 662  
14:33:54 663  /******************************************************************************/
14:33:54 664  
14:33:54 665  PROCEDURE GET_PAYPAL_BY_ID (
14:33:54 666  	in_paypal_id   IN  NUMBER,
14:33:54 667  	out_result_set OUT SYS_REFCURSOR
14:33:54 668  ) AS
14:33:54 669  BEGIN
14:33:54 670  	PROCS_FIN_INSTRUMENTS_V22.GET_PAYPAL_BY_ID(
14:33:54 671  	  in_paypal_id,
14:33:54 672  	  out_result_set
14:33:54 673  	);
14:33:54 674  END GET_PAYPAL_BY_ID;
14:33:54 675  
14:33:54 676  PROCEDURE GET_GC_BY_PURCH_INVOICE_ID (
14:33:54 677  	in_invoice_id		IN GIFT_CERTIFICATE.PURCHASE_INVOICE_ID%TYPE,
14:33:54 678  	out_result_set OUT SYS_REFCURSOR
14:33:54 679  ) AS
14:33:54 680  BEGIN
14:33:54 681  	PROCS_FIN_INSTRUMENTS_V22.GET_GC_BY_PURCH_INVOICE_ID (
14:33:54 682  	  in_invoice_id,
14:33:54 683  	  out_result_set
14:33:54 684  	);
14:33:54 685  END GET_GC_BY_PURCH_INVOICE_ID;
14:33:54 686  
14:33:54 687  PROCEDURE GET_LICENSE_BY_ID (
14:33:54 688  	in_license_id  IN NUMBER,
14:33:54 689  	out_result_set OUT SYS_REFCURSOR
14:33:54 690  ) AS
14:33:54 691  BEGIN
14:33:54 692  	PROCS_LICENSE_V22.GET_LICENSE_BY_ID (
14:33:54 693  	  in_license_id,
14:33:54 694  	  out_result_set
14:33:54 695  	);
14:33:54 696  END GET_LICENSE_BY_ID;
14:33:54 697  
14:33:54 698  /******************************************************************************/
14:33:54 699  
14:33:54 700  PROCEDURE GET_NOTIFICATION_TYPE_ID (
14:33:54 701  	in_offer_chain_id	 IN NUMBER,
14:33:54 702  	in_action_name		 IN VARCHAR2,
14:33:54 703  	out_notification_type_id OUT NUMBER
14:33:54 704  ) AS
14:33:54 705  BEGIN
14:33:54 706  	PROCS_OFFER_CHAIN_V22.GET_NOTIFICATION_TYPE_ID(
14:33:54 707  	  in_offer_chain_id,
14:33:54 708  	  in_action_name,
14:33:54 709  	  out_notification_type_id
14:33:54 710  	);
14:33:54 711  END GET_NOTIFICATION_TYPE_ID;
14:33:54 712  
14:33:54 713  /******************************************************************************/
14:33:54 714  
14:33:54 715  PROCEDURE GET_ALL_OCH_META_DATA (
14:33:54 716  	in_offer_chain_id IN NUMBER,
14:33:54 717  	out_result_set	  OUT SYS_REFCURSOR
14:33:54 718  ) AS
14:33:54 719  BEGIN
14:33:54 720  	PROCS_OFFER_CHAIN_V22.GET_ALL_META_DATA (
14:33:54 721  	  in_offer_chain_id,
14:33:54 722  	  out_result_set
14:33:54 723  	);
14:33:54 724  END GET_ALL_OCH_META_DATA;
14:33:54 725  
14:33:54 726  /******************************************************************************/
14:33:54 727  
14:33:54 728  PROCEDURE GET_SUBSCRIPTIONS_META_DATA (
14:33:54 729  /*
14:33:54 730  APP_EXCEPTION_CODES_V22.INVALID_PARAMETER
14:33:54 731  APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54 732  */
14:33:54 733  	in_subscriptions_ids IN core_owner.NUMBER_TABLE,
14:33:54 734  	out_result_set	     OUT SYS_REFCURSOR
14:33:54 735  ) AS
14:33:54 736  BEGIN
14:33:54 737  	PROCS_SUBSCRIPTION_V22.GET_SUBSCRIPTIONS_META_DATA(
14:33:54 738  	  in_subscriptions_ids,
14:33:54 739  	  out_result_set
14:33:54 740  	);
14:33:54 741  END GET_SUBSCRIPTIONS_META_DATA;
14:33:54 742  
14:33:54 743  PROCEDURE GET_UNREDEEMED_GCS (
14:33:54 744  	out_result_set		OUT SYS_REFCURSOR,
14:33:54 745  	in_hours_number 	IN NUMBER DEFAULT 14*24,
14:33:54 746  	in_num_rows		IN NUMBER DEFAULT 10000,
14:33:54 747  	in_process_name 	IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE
14:33:54 748  ) AS
14:33:54 749  BEGIN
14:33:54 750  	PROCS_FIN_INSTRUMENTS_V22.GET_UNREDEEMED_GCS(
14:33:54 751  	  out_result_set => out_result_set,
14:33:54 752  	  in_hours_number => in_hours_number,
14:33:54 753  	  in_num_rows => in_num_rows,
14:33:54 754  	  in_process_name => in_process_name
14:33:54 755  	);
14:33:54 756  END GET_UNREDEEMED_GCS;
14:33:54 757  
14:33:54 758  PROCEDURE GET_OFFER_CHAIN_MD_VALUE (
14:33:54 759  	in_offer_chain_id IN NUMBER,
14:33:54 760  	in_meta_data_name IN VARCHAR2,
14:33:54 761  	out_value	  OUT VARCHAR2
14:33:54 762  ) AS
14:33:54 763  BEGIN
14:33:54 764  	PROCS_OFFER_CHAIN_V22.GET_OFFER_CHAIN_MD_VALUE(
14:33:54 765  	  in_offer_chain_id => in_offer_chain_id,
14:33:54 766  	  in_meta_data_name => in_meta_data_name,
14:33:54 767  	  out_value => out_value
14:33:54 768  	);
14:33:54 769  END GET_OFFER_CHAIN_MD_VALUE;
14:33:54 770  
14:33:54 771  PROCEDURE GET_ACT_SUBS_W_CPT_CHARGEBACKS (
14:33:54 772  	out_result_set	    OUT SYS_REFCURSOR
14:33:54 773  )
14:33:54 774  AS
14:33:54 775  BEGIN
14:33:54 776  	PROCS_SUBSCRIPTION_V22.GET_ACT_SUBS_W_CPT_CHARGEBACKS(
14:33:54 777  	  out_result_set => out_result_set
14:33:54 778  	);
14:33:54 779  END GET_ACT_SUBS_W_CPT_CHARGEBACKS;
14:33:54 780  
14:33:54 781  PROCEDURE GET_ACT_SUBS_W_PP_CHARGEBACKS (
14:33:54 782  	out_result_set	    OUT SYS_REFCURSOR
14:33:54 783  )
14:33:54 784  AS
14:33:54 785  BEGIN
14:33:54 786  	PROCS_SUBSCRIPTION_V22.GET_ACT_SUBS_W_PP_CHARGEBACKS(
14:33:54 787  	  out_result_set => out_result_set
14:33:54 788  	);
14:33:54 789  END GET_ACT_SUBS_W_PP_CHARGEBACKS;
14:33:54 790  
14:33:54 791  PROCEDURE GET_GRACE_PERIOD_SUB_REGIS (
14:33:54 792  	in_max_days_until_close IN NUMBER,
14:33:54 793  	in_num_subs_to_fetch	IN NUMBER,
14:33:54 794  	out_result_set		OUT SYS_REFCURSOR
14:33:54 795  )
14:33:54 796  AS
14:33:54 797  BEGIN
14:33:54 798  	PROCS_SUBSCRIPTION_V22.GET_GRACE_PERIOD_SUB_REGIS(
14:33:54 799  	  in_max_days_until_close => in_max_days_until_close,
14:33:54 800  	  in_num_subs_to_fetch => in_num_subs_to_fetch,
14:33:54 801  	  out_result_set => out_result_set
14:33:54 802  	);
14:33:54 803  END GET_GRACE_PERIOD_SUB_REGIS;
14:33:54 804  
14:33:54 805  PROCEDURE GET_ACT_SUBS_W_AMEX_CB (
14:33:54 806  	out_result_set	    OUT SYS_REFCURSOR
14:33:54 807  )
14:33:54 808  AS
14:33:54 809  BEGIN
14:33:54 810  	PROCS_SUBSCRIPTION_V22.GET_ACT_SUBS_W_AMEX_CB(
14:33:54 811  	  out_result_set => out_result_set
14:33:54 812  	);
14:33:54 813  END GET_ACT_SUBS_W_AMEX_CB;
14:33:54 814  
14:33:54 815  PROCEDURE GET_GRACE_LICE_FOR_FINAL_TRANS (
14:33:54 816  	in_days_before_close	 IN NUMBER,
14:33:54 817  	in_num_licenses_to_fetch IN NUMBER,
14:33:54 818  	out_result_set		 OUT SYS_REFCURSOR
14:33:54 819  ) AS
14:33:54 820  BEGIN
14:33:54 821  	PROCS_LICENSE_V22.GET_GRACE_LICE_FOR_FINAL_TRANS(
14:33:54 822  	  in_days_before_close => in_days_before_close,
14:33:54 823  	  in_num_licenses_to_fetch => in_num_licenses_to_fetch,
14:33:54 824  	  out_result_set => out_result_set
14:33:54 825  	);
14:33:54 826  END GET_GRACE_LICE_FOR_FINAL_TRANS;
14:33:54 827  
14:33:54 828  PROCEDURE GET_EXPIRING_PAYPAL (
14:33:54 829  	in_expire_window_days	  IN NUMBER,
14:33:54 830  	in_creation_limit_days	  IN NUMBER,
14:33:54 831  	in_retry_throttle_name	  IN PROCESS_RETRY_THROTTLE.PROCESS_NAME%TYPE,
14:33:54 832  	out_result_set		  OUT SYS_REFCURSOR
14:33:54 833  ) AS
14:33:54 834  BEGIN
14:33:54 835  	PROCS_FIN_INSTRUMENTS_V22.GET_EXPIRING_PAYPAL(
14:33:54 836  	  in_expire_window_days   => in_expire_window_days,
14:33:54 837  	  in_creation_limit_days  => in_creation_limit_days,
14:33:54 838  	  in_retry_throttle_name  => in_retry_throttle_name,
14:33:54 839  	  out_result_set	  => out_result_set
14:33:54 840  	);
14:33:54 841  END GET_EXPIRING_PAYPAL;
14:33:54 842  
14:33:54 843  END PUBLIC_PROCS_RENEWAL_V22;
14:33:54 844  .
14:33:54 SQL> /

Package body created.

Elapsed: 00:00:00.05
14:33:54 SQL> 
14:33:54 SQL> CREATE OR REPLACE PACKAGE BODY "PUBLIC_PROCS_CLIENT_V22" AS
14:33:54   2  
14:33:54   3  PROCEDURE GET_NOTIFICATION_TYPE_BY_NAME (
14:33:54   4  /*
14:33:54   5  Throws exceptions:
14:33:54   6  CORE_OWNER.APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54   7  CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54   8  */
14:33:54   9  	in_notification_type_name IN VARCHAR2,
14:33:54  10  	out_notification_type_id  OUT NUMBER
14:33:54  11  ) AS
14:33:54  12  BEGIN
14:33:54  13  	PROCS_NOTIFICATION_V22.GET_NOTIFICATION_TYPE_BY_NAME (
14:33:54  14  	  in_notification_type_name,
14:33:54  15  	  out_notification_type_id
14:33:54  16  	);
14:33:54  17  END;
14:33:54  18  
14:33:54  19  /*****************************************************************/
14:33:54  20  
14:33:54  21  PROCEDURE ADD_NOTIFICATION (
14:33:54  22  /*
14:33:54  23  Throws exceptions:
14:33:54  24  CORE_OWNER.APP_EXCEPTION_CODES_V22.NOT_FOUND
14:33:54  25  CORE_OWNER.APP_EXCEPTION_CODES_V22.UNKNOWN_ERROR
14:33:54  26  */
14:33:54  27  	in_sender_account_id	 IN NUMBER DEFAULT 0,
14:33:54  28  	in_recipient_group_id	 IN NUMBER,
14:33:54  29  	in_notification_type_id  IN NUMBER,
14:33:54  30  	in_date_to_notify	 IN DATE,
14:33:54  31  	in_email_template_params IN CLOB
14:33:54  32  ) AS
14:33:54  33  BEGIN
14:33:54  34  	PROCS_NOTIFICATION_V22.ADD_NOTIFICATION (
14:33:54  35  	  in_sender_account_id,
14:33:54  36  	  in_recipient_group_id,
14:33:54  37  	  in_notification_type_id,
14:33:54  38  	  in_date_to_notify,
14:33:54  39  	  in_email_template_params
14:33:54  40  	);
14:33:54  41  END;
14:33:54  42  
14:33:54  43  END PUBLIC_PROCS_CLIENT_V22;
14:33:54  44  .
14:33:54 SQL> /

Package body created.

Elapsed: 00:00:00.03
14:33:54 SQL> 
14:33:54 SQL> grant execute on CORE_OWNER.PROCS_ACCOUNT_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:54 SQL> grant execute on CORE_OWNER.PROCS_ADX_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:54 SQL> grant execute on CORE_OWNER.PROCS_CHARGE_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:54 SQL> grant execute on CORE_OWNER.PROCS_COMMON_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:54 SQL> grant execute on CORE_OWNER.PROCS_FIN_INSTRUMENTS_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_INVOICE_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_LICENSE_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_LINE_ITEMS_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.02
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_OFFER_CHAIN_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_PRODUCT_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_SUBSCRIPTION_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_SYSTEM_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_TEST_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_TRANSACTION_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_TAXES_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_LOCKING_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_ADJUSTMENTS_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:55 SQL> grant execute on CORE_OWNER.PUBLIC_PROCS_BILLING_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_ADDRESS_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_GROUP_ACCOUNT_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> 
14:33:55 SQL> grant execute on CORE_OWNER.PUBLIC_PROCS_BILLING_V22 to core_billing_app;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:55 SQL> grant execute on CORE_OWNER.PUBLIC_PROCS_RENEWAL_V22 to core_licensing_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_GROUP_ACCOUNT_V22 to core_licensing_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PUBLIC_PROCS_NOTIFICATION_V22 to ops_notif_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> 
14:33:55 SQL> 
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_TAXES_V22 to core_tax_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_PRODUCT_V22 to core_tax_app;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_ACCOUNT_V22 to core_tax_app;

Grant succeeded.

Elapsed: 00:00:00.06
14:33:55 SQL> 
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_POLLING_SYNC to core_poller_app;

Grant succeeded.

Elapsed: 00:00:00.03
14:33:55 SQL> 
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_RECONCILIATION_CRU_V22 to etl_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_SUBSCRIPTION_V22 to etl_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_TRANSACTION_V22 to etl_app;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_REPORTING to etl_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_LOCKING_V22 to etl_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_ACCOUNT_V22 to etl_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_INVOICE_V22 to etl_app;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:55 SQL> 
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_ITUNES_RECEIPT_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_ITUNES_RECEIPT_V22 to core_subup_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_AMAZON_V22 to core_licensing_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_AMAZON_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_AMAZON_V22 to core_subup_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_LICENSE_V22 to core_subup_app;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_LOCKING_V22 to core_subup_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> 
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_SUBSCRIPTION_V22 to core_subup_app;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_GROUP_ACCOUNT_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_GROUP_ACCOUNT_CRU_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_ENTITLEMENT_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:55 SQL> 
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_CUPY to cupy_app;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_LOCKING_V22 to cupy_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> 
14:33:55 SQL> grant execute on CORE_OWNER.NOTIFICATION_STATUSES_V22 to ops_notif_app;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_NOTIFICATION_V22 to ops_notif_app;

Grant succeeded.

Elapsed: 00:00:00.03
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_SYSTEM_V22 to ops_notif_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> 
14:33:55 SQL> grant execute on CORE_OWNER.PUBLIC_PROCS_CLIENT_V22 to core_licensing_app;

Grant succeeded.

Elapsed: 00:00:00.02
14:33:55 SQL> grant execute on CORE_OWNER.PUBLIC_PROCS_CLIENT_V22 to core_billing_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PUBLIC_PROCS_CLIENT_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:55 SQL> grant execute on CORE_OWNER.PUBLIC_PROCS_CLIENT_V22 to cupy_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> 
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_PROCESS_RETRY_V22 to cupy_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_PROCESS_RETRY_V22 to core_owner;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_PROCESS_RETRY_V22 to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_PROCESS_RETRY_V22 to core_billing_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_PROCESS_RETRY_V22 to core_licensing_app;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_PROCESS_RETRY_V22 to ops_notif_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_PROCESS_RETRY_V22 to etl_app;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_PROCESS_RETRY_V22 to core_subup_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_PROCESS_RETRY_V22 to core_poller_app;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:55 SQL> grant execute on CORE_OWNER.PROCS_PROCESS_RETRY_V22 to core_subup_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> 
14:33:55 SQL> grant select on CORE_OWNER.PROCESS_RETRY_THROTTLE to cupy_app;

Grant succeeded.

Elapsed: 00:00:00.09
14:33:55 SQL> grant select on CORE_OWNER.PROCESS_RETRY_THROTTLE to core_owner;

Grant succeeded.

Elapsed: 00:00:00.02
14:33:55 SQL> grant select on CORE_OWNER.PROCESS_RETRY_THROTTLE to core_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant select on CORE_OWNER.PROCESS_RETRY_THROTTLE to core_billing_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant select on CORE_OWNER.PROCESS_RETRY_THROTTLE to core_licensing_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant select on CORE_OWNER.PROCESS_RETRY_THROTTLE to core_subup_app;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:55 SQL> 
14:33:55 SQL> grant select on CORE_OWNER.NOTIFICATION_TYPE to cupy_app;

Grant succeeded.

Elapsed: 00:00:00.02
14:33:55 SQL> grant select on CORE_OWNER.NOTIFICATION_TYPE to core_owner;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant select on CORE_OWNER.NOTIFICATION_TYPE to core_app;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:55 SQL> grant select on CORE_OWNER.NOTIFICATION_TYPE to core_billing_app;

Grant succeeded.

Elapsed: 00:00:00.02
14:33:55 SQL> grant select on CORE_OWNER.NOTIFICATION_TYPE to core_licensing_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> 
14:33:55 SQL> grant REFERENCES on CORE_OWNER.NOTIFICATION_TYPE to cupy_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant REFERENCES on CORE_OWNER.NOTIFICATION_TYPE to core_owner;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant REFERENCES on CORE_OWNER.NOTIFICATION_TYPE to core_app;

Grant succeeded.

Elapsed: 00:00:00.02
14:33:55 SQL> grant REFERENCES on CORE_OWNER.NOTIFICATION_TYPE to core_billing_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant REFERENCES on CORE_OWNER.NOTIFICATION_TYPE to core_licensing_app;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> 
14:33:55 SQL> grant select, insert, update, delete ON CORE_OWNER.NOTIFICATION_TYPE to core_owner;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> grant select ON CORE_OWNER.NOTTID_SEQ to core_owner;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> 
14:33:55 SQL> Grant Execute On Core_Owner.App_Exception_Codes_V22 To Core_Hist_Owner;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> 
14:33:55 SQL> Grant Execute On Core_Owner.GLOBAL_ENUMS_V22 To Core_Hist_Owner;

Grant succeeded.

Elapsed: 00:00:00.01
14:33:55 SQL> 
14:33:55 SQL> Grant Execute On Core_Owner.Global_Statuses_V22 To Core_Hist_Owner;

Grant succeeded.

Elapsed: 00:00:00.00
14:33:55 SQL> 
14:33:55 SQL> commit;

Commit complete.

Elapsed: 00:00:00.00
14:33:55 SQL> spool off;


Subject: Nomad upgrade completed successfully: ECPR@rac01.prd.ewr1.nytimes.com
From: Nomad for Oracle <nytd_oracledba@nytimes.com>
To: nytd_ecommerce@nytimes.com
Cc: nytd_oracledba@nytimes.com

Nomad upgrade operation completed successfully without errors. 
        
        Details
        -------
        DB Hostname: rac01.prd.ewr1.nytimes.com
        DB Role: PRIMARY
        SID: ECPR
        Schema: core_owner
        Migration: 58.4-release-1.16.0-3-CORE-all.sql
        SVN Revision: 12902
        Duration: 7 sec.
        DBA: sbao
        Service Request: https://jira.em.nytimes.com/browse/ORA-899